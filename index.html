<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grindia Idle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Exo+2:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0c10;--bg2:#0f1318;--bg3:#161c24;--bg4:#1e2530;
  --border:#252d3a;--border2:#2e3a4a;
  --text:#c8d4e0;--text2:#8fa3b8;--text3:#4a6070;
  --gold:#d4aa3a;--gold2:#f0cc5a;
  --blue:#3a8cd4;--blue2:#5aadff;
  --green:#2ea855;--green2:#4fd472;
  --red:#c03030;--red2:#e85050;
  --purple:#7a40d4;--purple2:#9a60f4;
  --xp:#1a6bc4;--mastery:#c4820a;
  --crit:#e0503a;--power:#d46a20;--haste:#2abacc;--armor:#5a8fd4;--hps:#3aaa5a;
}
body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(58,140,212,0.04) 0%,transparent 60%),radial-gradient(ellipse at 80% 80%,rgba(212,170,58,0.04) 0%,transparent 60%);pointer-events:none;z-index:0}

/* HEADER */
#header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;height:50px;display:flex;align-items:center;gap:12px;flex-shrink:0;position:relative;z-index:10}
#active-action-display{position:absolute;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--green);border-radius:6px;padding:4px 12px;display:none;align-items:center;gap:8px;font-size:11px;color:var(--green2);font-weight:500;letter-spacing:0.3px}
#active-action-display.visible{display:flex}
#active-action-display .aad-icon{font-size:14px}
#active-action-display .aad-dot{width:6px;height:6px;background:var(--green2);border-radius:50%;animation:pulse 1.5s infinite}
#header h1{font-family:'Cinzel',serif;font-size:20px;color:var(--gold);letter-spacing:2px;text-shadow:0 0 20px rgba(212,170,58,0.4);white-space:nowrap}
.h-divider{width:1px;height:28px;background:var(--border);flex-shrink:0}
.h-stat{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;white-space:nowrap}
.h-stat .hs-label{color:var(--text3);font-size:10px;font-weight:300;letter-spacing:.5px;text-transform:uppercase}
.h-stat .hs-val{color:var(--text);font-weight:600;font-family:'Share Tech Mono',monospace;font-size:13px}
.h-stat .hs-icon{font-size:14px}
#header .spacer{flex:1}
.hdr-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;letter-spacing:.5px}
.hdr-btn:hover{background:var(--bg4);border-color:var(--border2);color:var(--text)}

/* MAIN LAYOUT */
#main{display:flex;flex:1;overflow:hidden;position:relative;z-index:1}
#sidebar{width:168px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
.nav-section{padding:6px 0}
.nav-group-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);padding:6px 12px 3px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 12px;cursor:pointer;border-left:2px solid transparent;transition:all .12s}
.nav-item:hover{background:var(--bg3)}
.nav-item.active{background:var(--bg3);border-left-color:var(--gold)}
.nav-item .ni-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-item .ni-info{flex:1;min-width:0}
.nav-item .ni-name{font-size:12px;font-weight:500;color:var(--text)}
.nav-item .ni-level{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;display:flex;gap:4px;align-items:center;margin-top:1px}
.mini-bar{height:2px;background:var(--bg4);border-radius:1px;margin-top:2px;overflow:hidden}
.mini-bar-fill{height:100%;border-radius:1px;transition:width .4s}
.mini-bar-xp .mini-bar-fill{background:var(--xp)}
.nav-divider{height:1px;background:var(--border);margin:4px 0}

/* CONTENT */
#content{flex:1;overflow-y:auto;padding:16px}
.page{display:none}
.page.active{display:block}

/* Make current action containers sticky */
#cur-woodcutting,#cur-mining,#cur-fishing,#cur-firemaking,#cur-smithing,#cur-cooking{
  position:sticky;
  top:-16px;
  z-index:100;
  margin:-16px -16px 0 -16px;
  padding:16px 16px 0 16px;
  background:var(--bg1);
}

.pg-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.pg-icon{font-size:36px;line-height:1;margin-top:2px}
.pg-title h2{font-family:'Cinzel',serif;font-size:17px;color:var(--gold);font-weight:600}
.pg-xp-area{margin-top:6px;display:flex;flex-direction:column;gap:3px}
.xp-row{display:flex;align-items:center;gap:8px}
.xp-label{font-size:10px;color:var(--text3);width:50px;flex-shrink:0}
.xp-bar{flex:1;height:7px;background:var(--bg4);border-radius:4px;overflow:hidden;min-width:120px}
.xp-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.xp-fill-blue{background:linear-gradient(90deg,var(--xp),var(--blue2))}
.xp-fill-gold{background:linear-gradient(90deg,var(--mastery),var(--gold2))}
.xp-txt{font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap}

.action-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin-bottom:16px}
.action-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.action-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02) 0%,transparent 100%);pointer-events:none}
.action-card:hover:not(.locked){border-color:var(--border2);background:var(--bg3)}
.action-card.active-action{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.08) 0%,var(--bg2) 100%)}
.action-card.locked{opacity:.45;cursor:not-allowed}
.ac-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ac-icon{font-size:22px}
.ac-name{font-weight:600;font-size:13px;flex:1}
.ac-lock{font-size:10px;background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:1px 6px;color:var(--text3)}
.ac-stats{font-size:11px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr;gap:2px 8px}
.ac-stat span{color:var(--text)}
.ac-mastery{margin-top:8px;border-top:1px solid var(--border);padding-top:6px}
.ac-m-row{display:flex;justify-content:space-between;margin-bottom:2px;font-size:10px;color:var(--text3)}
.ac-m-row span{color:var(--mastery)}
.ac-m-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.ac-m-fill{height:100%;background:linear-gradient(90deg,var(--mastery),var(--gold2));border-radius:2px;transition:width .3s}
.active-dot{position:absolute;top:8px;right:8px;width:7px;height:7px;background:var(--green2);border-radius:50%;box-shadow:0 0 6px var(--green2);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.cur-action{background:var(--bg2);border:1px solid var(--green);border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px}
.ca-label{font-size:11px;color:var(--text2);white-space:nowrap}
.ca-name{font-weight:600;color:var(--green2);flex:1}
.ca-prog-wrap{flex:1;max-width:180px}
.ca-prog-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden}
.ca-prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--green2));border-radius:3px;transition:width .1s linear}
.ca-stop{background:transparent;border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;transition:all .15s;font-family:'Exo 2',sans-serif}
.ca-stop:hover{border-color:var(--red);color:var(--red2)}

/* BANK */
.bank-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.bank-gold{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600;color:var(--gold2);font-family:'Share Tech Mono',monospace}
.bank-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:8px}
.b-item{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;cursor:grab;transition:all .15s;position:relative}
.b-item:active{cursor:grabbing}
.b-item:hover{border-color:var(--gold);background:var(--bg3)}
.b-icon{font-size:26px;margin-bottom:4px;line-height:1.2}
.b-name{font-size:11px;color:var(--text2);margin-bottom:3px;line-height:1.3;font-weight:500}
.b-qty{font-size:13px;font-weight:600;color:var(--text);font-family:'Share Tech Mono',monospace}
.b-val{font-size:10px;color:var(--gold2);margin-top:2px;font-weight:500}
.b-sell-menu{position:absolute;top:4px;right:4px;display:none;flex-direction:column;gap:2px;z-index:10}
.b-item:hover .b-sell-menu{display:flex}
.b-sell-btn{background:var(--bg4);border:1px solid var(--border);color:var(--text3);border-radius:4px;padding:2px 6px;font-size:9px;cursor:pointer;font-family:'Exo 2',sans-serif;transition:all .15s;white-space:nowrap}
.b-sell-btn:hover{background:var(--gold);border-color:var(--gold2);color:var(--bg1);transform:translateX(-2px)}
.b-sell-all{background:rgba(192,48,48,.2);border-color:var(--red);color:var(--red2)}
.b-sell-all:hover{background:var(--red);border-color:var(--red2);color:#fff}
.bank-empty{color:var(--text2);text-align:center;padding:40px;font-style:italic;font-size:12px}
.bank-cats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.bcat-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s}
.bcat-btn.active{background:var(--bg4);border-color:var(--blue);color:var(--blue2)}

/* COMBAT */
.combat-layout{display:grid;grid-template-columns:1fr 220px;gap:14px}
.combat-arena{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px}
.combatants{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:12px}
.combatant{text-align:center}
.comb-name{font-weight:600;font-size:13px;margin-bottom:6px}
.comb-hp-label{font-size:10px;color:var(--text3);margin-bottom:3px;font-family:'Share Tech Mono',monospace}
.hp-bar-wrap{height:10px;background:var(--bg4);border-radius:5px;overflow:hidden;margin-bottom:4px}
.hp-fill{height:100%;border-radius:5px;transition:width .3s}
.hp-fill-player{background:linear-gradient(90deg,var(--green),var(--green2))}
.hp-fill-monster{background:linear-gradient(90deg,var(--red),var(--red2))}
.vs-badge{background:var(--bg3);border:1px solid var(--border);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:var(--text3);flex-shrink:0}
.combat-log{max-height:130px;overflow-y:auto;font-size:11px;background:var(--bg3);border-radius:6px;padding:8px;margin-bottom:10px;line-height:1.6}
.clog-p{color:var(--text3)}
.clog-hit{color:var(--red2)}
.clog-mhit{color:var(--blue2)}
.clog-kill{color:var(--gold2);font-weight:600}
.clog-loot{color:var(--green2)}
.clog-heal{color:#4ade80;font-weight:600}
.clog-eat{color:var(--purple2)}
.clog-die{color:var(--red);font-weight:600}
.combat-btns{display:flex;gap:8px}
.btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:all .15s;letter-spacing:.3px}
.btn:hover{background:var(--bg4);border-color:var(--border2)}
.btn-green{background:rgba(46,168,85,.15);border-color:var(--green);color:var(--green2)}
.btn-green:hover{background:rgba(46,168,85,.25)}
.btn-red{background:rgba(192,48,48,.15);border-color:var(--red);color:var(--red2)}
.btn-red:hover{background:rgba(192,48,48,.25)}
.btn-gold{background:rgba(212,170,58,.15);border-color:var(--gold);color:var(--gold2)}
.btn-gold:hover{background:rgba(212,170,58,.25)}
.food-btn{background:var(--bg3);border:1px solid var(--green);color:var(--text);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:all .15s;letter-spacing:.3px;margin-right:8px}
.food-btn:hover{background:rgba(46,168,85,.15);border-color:var(--green2);transform:translateY(-1px)}
.food-btn:active{transform:translateY(0px)}
.zone-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:10px;margin-bottom:12px}
.zone-card{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:12px;cursor:pointer;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.zone-card:hover:not(.z-locked){border-color:var(--gold);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.zone-card.z-selected{border-color:var(--gold);background:linear-gradient(135deg,rgba(212,170,58,0.1) 0%,var(--bg2) 100%);animation:zonePulse 0.6s ease-out}
.zone-card.z-locked{opacity:0.5;cursor:not-allowed}
.zc-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.zc-name{font-weight:600;font-size:13px;color:var(--gold);font-family:'Cinzel',serif;flex:1}
.zc-level{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;background:var(--bg3);padding:2px 6px;border-radius:4px}
.zc-desc{font-size:10px;color:var(--text3);line-height:1.4;margin-top:4px}
.zc-tier{font-size:9px;color:var(--gold2);text-transform:uppercase;letter-spacing:1px;margin-top:6px;font-weight:600}
.monster-select{display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 520px);overflow-y:auto;padding-right:4px}
.monster-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;transition:all .15s}
.monster-card:hover:not(.m-locked){border-color:var(--red)}
.monster-card.m-selected{border-color:var(--red);background:rgba(192,48,48,.08)}
.monster-card.m-locked{opacity:.4;cursor:not-allowed}
.mc-head{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.mc-icon{font-size:20px}
.mc-name{font-weight:600;font-size:12px}
.mc-level{font-size:10px;color:var(--text3);margin-left:auto;font-family:'Share Tech Mono',monospace}
.mc-stats{font-size:10px;color:var(--text2);display:flex;gap:8px;flex-wrap:wrap}
.mc-stat span{color:var(--red2)}
.mc-loot{font-size:9px;color:var(--text3);margin-top:3px}

/* EQUIPMENT */
.equip-layout{display:grid;grid-template-columns:260px 1fr;gap:20px}
.equip-slots{display:flex;flex-direction:column;gap:10px}
.equip-row{display:flex;gap:8px;justify-content:center}
.equip-slot{background:var(--bg2);border:2px dashed var(--border);border-radius:10px;padding:12px;min-width:100px;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;transition:all .2s;position:relative;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.equip-slot:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.equip-slot.filled{border-style:solid;border-color:var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.05) 0%,var(--bg2) 100%)}
.equip-slot.filled:hover{border-color:var(--gold)}
.es-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:600}
.es-icon{font-size:28px;line-height:1}
.es-name{font-size:11px;color:var(--text);margin-top:4px;font-weight:600}
.es-stat{font-size:10px;color:var(--green2);margin-top:2px;font-weight:600}
.es-empty{font-size:10px;color:var(--text3);font-style:italic}
.es-unequip{position:absolute;top:5px;right:5px;background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:2px 6px;font-size:9px;cursor:pointer;display:none;color:var(--red2);font-family:'Exo 2',sans-serif;font-weight:600;transition:all .15s}
.es-unequip:hover{background:var(--red2);color:white;border-color:var(--red2)}
.equip-slot.filled:hover .es-unequip{display:block}
.stats-display{background:var(--bg2);border:2px solid var(--border);border-radius:12px;padding:16px;box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.stats-display h3{font-family:'Cinzel',serif;font-size:15px;color:var(--gold);margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)}
.stat-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bg3)}
.stat-row:last-child{border:none}
.sr-label{color:var(--text2);display:flex;align-items:center;gap:6px;font-size:12px}
.sr-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--text);font-size:13px}
.sr-bonus{font-size:10px;color:var(--green2);margin-left:4px;font-weight:600}
.equip-available{margin-top:14px}
.equip-infusion{background:transparent;border:none;padding:0;margin-bottom:16px}
.infusion-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:14px}
.infusion-item{background:var(--bg2);border:2px solid var(--border);border-radius:12px;padding:16px;transition:all .2s;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}
.infusion-item:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);border-color:var(--gold)}
.infusion-item::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,215,0,0.03) 0%,transparent 100%);pointer-events:none}
.inf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.inf-slot-name{font-weight:600;font-size:14px;color:var(--text);font-family:'Cinzel',serif}
.inf-level{font-size:20px;color:var(--gold2);font-weight:700;font-family:'Share Tech Mono',monospace}
.inf-progress{display:flex;gap:3px;margin-bottom:12px;flex-wrap:wrap;justify-content:center}
.inf-rank{width:26px;height:26px;border-radius:6px;background:var(--bg4);border:2px solid var(--border);font-size:10px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-weight:600;transition:all .2s}
.inf-rank.filled{background:linear-gradient(135deg,var(--gold2) 0%,var(--gold) 100%);color:var(--bg1);border-color:var(--gold2);box-shadow:0 2px 4px rgba(255,215,0,0.3)}
.inf-cost{font-size:11px;color:var(--text2);margin-bottom:8px;padding:8px;background:var(--bg3);border-radius:6px;text-align:center}
.inf-bonus{font-size:12px;color:var(--green2);margin-bottom:12px;text-align:center;font-weight:600;padding:6px;background:rgba(46,168,85,0.1);border-radius:6px}
.inf-button{width:100%;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);color:var(--bg1);border:none;padding:10px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Exo 2',sans-serif;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 6px rgba(255,215,0,0.3);transition:all .2s}
.inf-button:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(255,215,0,0.4)}
.inf-button:active{transform:translateY(0)}
.inf-button:disabled{background:var(--bg4);color:var(--text3);cursor:not-allowed;opacity:0.5;box-shadow:none;transform:none}
.inf-max{font-size:13px;color:var(--gold2);text-align:center;padding:12px;font-weight:600;background:linear-gradient(135deg,rgba(255,215,0,0.1) 0%,transparent 100%);border-radius:8px;text-transform:uppercase;letter-spacing:1px}
.equip-avail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;margin-top:10px}
.ea-item{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:10px;cursor:pointer;text-align:center;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.ea-item:hover{border-color:var(--gold);background:var(--bg3);transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.1)}
.ea-icon{font-size:24px;margin-bottom:4px}
.ea-name{font-size:11px;font-weight:600;color:var(--text);margin-bottom:3px}
.ea-stat{font-size:10px;color:var(--green2);font-weight:600;margin-bottom:2px}
.ea-qty{font-size:9px;color:var(--text3);font-family:'Share Tech Mono',monospace;font-weight:600}
.ea-locked{opacity:0.5;cursor:not-allowed}
.ea-locked:hover{border-color:var(--border);background:var(--bg2);transform:none;box-shadow:0 2px 6px rgba(0,0,0,0.05)}

/* PRODUCTION SKILLS */
.production-info{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--text2);line-height:1.6}
.ingredient{display:inline-flex;align-items:center;gap:4px;margin:2px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:11px}
.ingredient.missing{border-color:var(--red);color:var(--red2)}
.ingredient.ok{border-color:var(--green);color:var(--green2)}

/* NOTIFICATIONS */
#notifs{position:fixed;top:58px;right:12px;z-index:200;display:flex;flex-direction:column;gap:6px;pointer-events:none;align-items:flex-end}
.notif{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:7px 12px;font-size:12px;animation:notifIn .2s ease,notifOut .3s ease 2.5s forwards;max-width:220px;font-weight:500}
.notif-lvl{border-color:var(--gold);color:var(--gold2)}
.notif-item{border-color:var(--green);color:var(--green2)}
.notif-combat{border-color:var(--red);color:var(--red2)}
.notif-info{border-color:var(--blue);color:var(--blue2)}
@keyframes notifIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes notifOut{to{transform:translateX(15px);opacity:0}}
@keyframes zonePulse{0%{box-shadow:0 2px 6px rgba(0,0,0,0.05)}50%{box-shadow:0 4px 12px rgba(212,170,58,0.3)}100%{box-shadow:0 2px 6px rgba(0,0,0,0.05)}}

/* OFFLINE BANNER */
.offline-banner{background:linear-gradient(135deg,rgba(46,168,85,.1),rgba(26,107,196,.1));border:2px solid var(--green);border-radius:10px;padding:14px 18px;margin-bottom:16px;display:flex;align-items:flex-start;gap:14px;box-shadow:0 2px 8px rgba(46,168,85,0.2)}
.ob-icon{font-size:28px;flex-shrink:0;margin-top:2px}
.ob-text{flex:1;font-size:12px;line-height:1.7}
.ob-text strong{color:var(--green2)}
.ob-close{background:none;border:1px solid var(--border);color:var(--text3);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;flex-shrink:0;align-self:flex-start}
.ob-close:hover{background:var(--bg3);border-color:var(--green)}

/* SECTION TITLES */
.sec-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border);scroll-margin-top:20px}

/* GENERAL STORE */
.store-categories{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:16px}
.store-cat-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;transition:all .15s;font-weight:500}
.store-cat-btn:hover{background:var(--bg4);border-color:var(--gold)}
.store-cat-btn.active{background:linear-gradient(135deg,rgba(212,170,58,.15),var(--bg3));border-color:var(--gold);color:var(--gold2)}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:12px}
.store-item{background:var(--bg2);border:2px solid var(--border);border-radius:10px;padding:14px;transition:all .2s;box-shadow:0 2px 6px rgba(0,0,0,0.05)}
.store-item:hover{transform:translateY(-2px);box-shadow:0 4px 10px rgba(0,0,0,0.1);border-color:var(--gold)}
.si-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.si-icon{font-size:32px}
.si-info{flex:1}
.si-name{font-weight:600;font-size:13px;color:var(--text);margin-bottom:2px}
.si-desc{font-size:10px;color:var(--text3);line-height:1.3}
.si-price{font-size:14px;color:var(--gold2);font-weight:600;margin-bottom:8px;font-family:'Share Tech Mono',monospace}
.si-stock{font-size:10px;color:var(--text3);margin-bottom:10px}
.si-buy-area{display:flex;gap:4px}
.si-buy-btn{flex:1;background:var(--bg3);border:1px solid var(--gold);color:var(--gold2);padding:8px 6px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;font-weight:600;transition:all .15s;letter-spacing:.3px}
.si-buy-btn:hover:not(:disabled){background:linear-gradient(135deg,rgba(212,170,58,.2),var(--bg3));transform:translateY(-1px)}
.si-buy-btn:disabled{opacity:.4;cursor:not-allowed;border-color:var(--border);color:var(--text3)}

/* TOOLTIPS */
.tooltip-wrap{position:relative;display:inline-block}
.tooltip-box{visibility:hidden;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;white-space:nowrap;font-size:11px;z-index:50;pointer-events:none}
.tooltip-wrap:hover .tooltip-box{visibility:visible}

/* CONTRACTS */
.contract-refresh{text-align:center;padding:10px;background:var(--bg2);border:2px solid var(--border);border-radius:10px;margin-bottom:16px;font-size:11px;color:var(--text2);box-shadow:0 2px 8px rgba(0,0,0,0.1)}
.contract-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px}
.contract-card{background:var(--bg2);border:2px solid var(--border);border-radius:12px;padding:16px;transition:all .2s;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}
.contract-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);border-color:var(--gold)}
.contract-card.completed{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.08) 0%,var(--bg2) 100%)}
.contract-card.completed::after{content:'‚úì';position:absolute;top:12px;right:12px;font-size:24px;color:var(--green);font-weight:bold}
.contract-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03) 0%,transparent 100%);pointer-events:none}
.ct-header{display:flex;align-items:center;gap:12px;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.ct-icon{font-size:32px;line-height:1;flex-shrink:0}
.ct-info{flex:1}
.ct-title{font-weight:600;font-size:15px;color:var(--gold);margin-bottom:3px;font-family:'Cinzel',serif}
.ct-tier{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-weight:600}
.ct-requirements{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:10px;margin-bottom:12px}
.ct-req-title{font-size:10px;color:var(--gold2);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;font-weight:600}
.ct-req-item{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px}
.ct-req-icon{font-size:18px;flex-shrink:0}
.ct-req-name{flex:1;color:var(--text);font-weight:500}
.ct-req-progress{font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:600}
.ct-req-progress.complete{color:var(--green2)}
.ct-req-progress.incomplete{color:var(--red2)}
.ct-rewards{display:flex;align-items:center;gap:14px;padding:10px;background:linear-gradient(135deg,var(--bg3) 0%,var(--bg2) 100%);border:1px solid var(--border);border-radius:8px;margin-bottom:12px}
.ct-reward{display:flex;align-items:center;gap:6px;font-size:12px}
.ct-reward-icon{font-size:18px}
.ct-reward-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--gold2)}
.ct-actions{display:flex;gap:8px}
.ct-btn{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px 14px;border-radius:8px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.ct-btn:hover{background:var(--bg4);border-color:var(--gold);color:var(--text)}
.ct-btn-complete{background:var(--green);border-color:var(--green);color:white}
.ct-btn-complete:hover{background:#2ba855;border-color:#2ba855}
.ct-btn:disabled{background:var(--bg4);border-color:var(--border);color:var(--text3);cursor:not-allowed;opacity:0.5}
.ct-btn-complete:hover{background:var(--green);color:var(--bg);border-color:var(--green2)}
.ct-btn-complete:disabled{opacity:0.5;cursor:not-allowed;background:var(--bg3);color:var(--text3)}
.ct-btn-complete:disabled:hover{background:var(--bg3);color:var(--text3);border-color:var(--border)}

/* MASTERY SHOP */
.mastery-total{text-align:center;background:var(--bg2);border:2px solid var(--gold);border-radius:12px;padding:16px;margin-bottom:20px;box-shadow:0 2px 8px rgba(196,130,10,0.2)}
.mt-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px;font-weight:600}
.mt-value{font-size:36px;font-weight:700;font-family:'Cinzel',serif;color:var(--mastery);text-shadow:0 0 20px rgba(196,130,10,0.5)}
.mt-sub{font-size:11px;color:var(--text3);margin-top:6px}
.mastery-tabs{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap;justify-content:center}
.ms-tab{background:var(--bg3);border:2px solid var(--border);color:var(--text2);padding:8px 16px;border-radius:8px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;transition:all .2s;display:flex;align-items:center;gap:8px;font-weight:600;text-transform:uppercase;letter-spacing:0.5px}
.ms-tab:hover{background:var(--bg4);border-color:var(--mastery);transform:translateY(-1px)}
.ms-tab.active{background:linear-gradient(135deg,rgba(196,130,10,0.15) 0%,var(--bg4) 100%);border-color:var(--mastery);color:var(--gold2);box-shadow:0 2px 6px rgba(196,130,10,0.2)}
.ms-tab-icon{font-size:16px}
.upgrade-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.upgrade-card{background:var(--bg2);border:2px solid var(--border);border-radius:12px;padding:16px;transition:all .2s;position:relative;box-shadow:0 2px 8px rgba(0,0,0,0.1);overflow:hidden}
.upgrade-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,0.15);border-color:var(--mastery)}
.upgrade-card.purchased{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.08) 0%,var(--bg2) 100%)}
.upgrade-card.purchased::after{content:'‚úì';position:absolute;top:12px;right:12px;font-size:24px;color:var(--green);font-weight:bold}
.upgrade-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03) 0%,transparent 100%);pointer-events:none}
.up-header{display:flex;align-items:flex-start;gap:12px;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.up-icon{font-size:32px;line-height:1;flex-shrink:0}
.up-info{flex:1}
.up-name{font-weight:600;font-size:15px;color:var(--gold);margin-bottom:4px;font-family:'Cinzel',serif}
.up-desc{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:8px}
.up-effect{font-size:12px;color:var(--green2);font-weight:600;background:linear-gradient(135deg,rgba(46,168,85,0.15) 0%,rgba(46,168,85,0.05) 100%);border-radius:6px;padding:6px 10px;display:inline-block;margin-bottom:10px;border:1px solid rgba(46,168,85,0.3)}
.up-footer{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-top:8px}
.up-cost{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;background:var(--bg3);padding:6px 10px;border-radius:6px;border:1px solid var(--border)}
.up-cost-icon{font-size:18px;color:var(--mastery)}
.up-cost-val{font-family:'Share Tech Mono',monospace;color:var(--mastery)}
.up-level{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3);font-weight:600}
.up-level.met{color:var(--green2)}
.up-btn{background:linear-gradient(135deg,var(--mastery) 0%,var(--gold) 100%);border:none;color:var(--bg1);padding:8px 18px;border-radius:8px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .2s;font-weight:600;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 6px rgba(196,130,10,0.3)}
.up-btn:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(196,130,10,0.4)}
.up-btn:active{transform:translateY(0)}
.up-btn:disabled{background:var(--bg4);color:var(--text3);cursor:not-allowed;opacity:0.5;box-shadow:none;transform:none}
.up-purchased{background:var(--green);color:var(--bg);border:1px solid var(--green2);padding:6px 16px;border-radius:6px;font-size:11px;font-weight:600;cursor:default}
.up-owned{font-size:10px;color:var(--green2);margin-top:4px;font-family:'Share Tech Mono',monospace}


/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

/* STATS PAGE */
.stats-page-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.stats-section{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px}
.stats-section h3{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px}
.skill-overview-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sog-item{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:7px 10px;cursor:pointer;transition:all .12s}
.sog-item:hover{border-color:var(--gold);background:var(--bg4)}
.sog-icon{font-size:18px;width:22px;text-align:center;flex-shrink:0}
.sog-info{flex:1;min-width:0}
.sog-name{font-size:11px;font-weight:500;color:var(--text2)}
.sog-level{font-size:16px;font-weight:700;font-family:'Share Tech Mono',monospace;color:var(--text);line-height:1}
.sog-xp-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:3px;overflow:hidden}
.sog-xp-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--xp),var(--blue2))}
.combat-stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;position:relative;overflow:hidden}
.combat-stat-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent);pointer-events:none}
.csc-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
.csc-icon{font-size:24px;margin-bottom:4px}
.csc-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:2px}
.csc-value{font-size:18px;font-weight:700;font-family:'Share Tech Mono',monospace;line-height:1}
.csc-sublabel{font-size:9px;color:var(--text3);margin-top:2px}
.csc-level{font-size:10px;color:var(--text3);margin-top:4px}
.csc-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:4px;overflow:hidden}
.csc-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.total-level-display{text-align:center;padding:12px;background:var(--bg3);border:1px solid var(--gold);border-radius:8px;margin-bottom:12px}
.tld-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.tld-value{font-size:36px;font-weight:700;font-family:'Cinzel',serif;color:var(--gold);text-shadow:0 0 20px rgba(212,170,58,0.4);line-height:1.2}
.tld-sub{font-size:11px;color:var(--text3);margin-top:2px}
.combat-nav-badge{font-size:9px;background:var(--bg4);border:1px solid var(--border);border-radius:3px;padding:1px 5px;color:var(--text3);font-family:'Share Tech Mono',monospace;margin-left:auto}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;min-width:300px;max-width:420px;max-height:80vh;display:flex;flex-direction:column;gap:12px}
.modal h3{font-family:'Cinzel',serif;color:var(--gold);font-size:15px}
.modal-body{overflow-y:auto;flex:1}
.modal-footer{display:flex;gap:8px;justify-content:flex-end}
.equip-list-item{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:all .15s;margin-bottom:6px}
.equip-list-item:hover{border-color:var(--gold)}
.eli-icon{font-size:20px}
.eli-info{flex:1}
.eli-name{font-size:12px;font-weight:600}
.eli-stat{font-size:10px;color:var(--green2)}
.eli-qty{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace}
.eli-locked{opacity:0.5;cursor:not-allowed}
.eli-locked:hover{border-color:var(--border)}
.sell-all-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
</style>
</head>
<body>

<div id="header">
  <h1>‚öî GRINDIA</h1>
  <div class="h-divider"></div>
  <div id="active-action-display">
    <span class="aad-dot"></span>
    <span class="aad-icon" id="aad-icon">‚öíÔ∏è</span>
    <span id="aad-text">Mining Copper</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">ü™ô</span>
    <span class="hs-label">Gold</span>
    <span class="hs-val" id="hdr-gold">0</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">‚ù§Ô∏è</span>
    <span class="hs-label">HP</span>
    <span class="hs-val" id="hdr-hp">10/10</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">‚öîÔ∏è</span>
    <span class="hs-label">Crit</span>
    <span class="hs-val" id="hdr-atk">5%</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">üõ°Ô∏è</span>
    <span class="hs-label">Armor</span>
    <span class="hs-val" id="hdr-def">0</span>
  </div>
  <div class="spacer"></div>
  <button class="hdr-btn" onclick="exportSave()" title="Download save file">üíæ Export</button>
  <button class="hdr-btn" onclick="importSave()" title="Load save file">üìÇ Import</button>
  <button class="hdr-btn" onclick="manualSave()">üíæ Save</button>
</div>

<div id="main">
  <div id="sidebar" id="sidebar">
    <div class="nav-section">
      <div class="nav-group-title">Gathering</div>
      <div class="nav-item" onclick="showPage('woodcutting')" id="nav-woodcutting">
        <span class="ni-icon">ü™ì</span>
        <div class="ni-info">
          <div class="ni-name">Woodcutting</div>
          <div class="ni-level"><span id="sl-woodcutting">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-woodcutting" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('mining')" id="nav-mining">
        <span class="ni-icon">‚õèÔ∏è</span>
        <div class="ni-info">
          <div class="ni-name">Mining</div>
          <div class="ni-level"><span id="sl-mining">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-mining" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('fishing')" id="nav-fishing">
        <span class="ni-icon">üé£</span>
        <div class="ni-info">
          <div class="ni-name">Fishing</div>
          <div class="ni-level"><span id="sl-fishing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-fishing" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Production</div>
      <div class="nav-item" onclick="showPage('firemaking')" id="nav-firemaking">
        <span class="ni-icon">üî•</span>
        <div class="ni-info">
          <div class="ni-name">Firemaking</div>
          <div class="ni-level"><span id="sl-firemaking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-firemaking" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('smithing')" id="nav-smithing">
        <span class="ni-icon">üî®</span>
        <div class="ni-info">
          <div class="ni-name">Smithing</div>
          <div class="ni-level"><span id="sl-smithing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-smithing" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('cooking')" id="nav-cooking">
        <span class="ni-icon">üç≥</span>
        <div class="ni-info">
          <div class="ni-name">Cooking</div>
          <div class="ni-level"><span id="sl-cooking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-cooking" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Combat Skills</div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-attack">
        <span class="ni-icon">üó°Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Attack</div>
          <div class="ni-level"><span id="sl-attack">Lv 1</span><span style="color:var(--crit);font-size:9px" id="sl-attack-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--crit)" id="mb-attack"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-strength">
        <span class="ni-icon">üí™</span>
        <div class="ni-info">
          <div class="ni-name">Strength</div>
          <div class="ni-level"><span id="sl-strength">Lv 1</span><span style="color:var(--power);font-size:9px" id="sl-strength-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--power)" id="mb-strength"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-haste">
        <span class="ni-icon">‚ö°</span>
        <div class="ni-info">
          <div class="ni-name">Haste</div>
          <div class="ni-level"><span id="sl-haste">Lv 1</span><span style="color:var(--haste);font-size:9px" id="sl-haste-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--haste)" id="mb-haste"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-defense">
        <span class="ni-icon">üõ°Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Defense</div>
          <div class="ni-level"><span id="sl-defense">Lv 1</span><span style="color:var(--armor);font-size:9px" id="sl-defense-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--armor)" id="mb-defense"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-hitpoints">
        <span class="ni-icon">‚ù§Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Hitpoints</div>
          <div class="ni-level"><span id="sl-hitpoints">Lv 10</span><span style="color:var(--hps);font-size:9px" id="sl-hitpoints-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--hps)" id="mb-hitpoints"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('combat')" id="nav-combat">
        <span class="ni-icon">‚öîÔ∏è</span>
        <div class="ni-info">
          <div class="ni-name">Combat</div>
          <div class="ni-level"><span id="sl-combat">Lv 3</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-combat" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-item" onclick="showPage('bank')" id="nav-bank">
        <span class="ni-icon">üè¶</span>
        <div class="ni-info"><div class="ni-name">Bank</div><div class="ni-level">Storage</div></div>
      </div>
      <div class="nav-item" onclick="showPage('equipment')" id="nav-equipment">
        <span class="ni-icon">üõ°Ô∏è</span>
        <div class="ni-info"><div class="ni-name">Equipment</div><div class="ni-level">Loadout</div></div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-stats">
        <span class="ni-icon">üìä</span>
        <div class="ni-info"><div class="ni-name">Stats</div><div class="ni-level">All Skills</div></div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-item" onclick="showPage('contracts')" id="nav-contracts">
        <span class="ni-icon">üìã</span>
        <div class="ni-info"><div class="ni-name">Contracts</div><div class="ni-level">Quests</div></div>
      </div>
      <div class="nav-item" onclick="showPage('mastery-shop')" id="nav-mastery-shop">
        <span class="ni-icon">‚≠ê</span>
        <div class="ni-info"><div class="ni-name">Mastery Shop</div><div class="ni-level">Upgrades</div></div>
      </div>
      <div class="nav-item" onclick="showPage('store')" id="nav-store">
        <span class="ni-icon">üè™</span>
        <div class="ni-info"><div class="ni-name">General Store</div><div class="ni-level">Buy Items</div></div>
      </div>
    </div>
  </div>

  <div id="content">
    <!-- WOODCUTTING -->
    <div class="page" id="page-woodcutting">
      <div id="cur-woodcutting"></div>
      <div class="pg-header">
        <div class="pg-icon">ü™ì</div>
        <div class="pg-title">
          <h2>Woodcutting</h2>
          <div class="pg-xp-area" id="pgxp-woodcutting"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-woodcutting"></div>
    </div>
    <!-- MINING -->
    <div class="page" id="page-mining">
      <div id="cur-mining"></div>
      <div class="pg-header">
        <div class="pg-icon">‚õèÔ∏è</div>
        <div class="pg-title">
          <h2>Mining</h2>
          <div class="pg-xp-area" id="pgxp-mining"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-mining"></div>
    </div>
    <!-- FISHING -->
    <div class="page" id="page-fishing">
      <div id="cur-fishing"></div>
      <div class="pg-header">
        <div class="pg-icon">üé£</div>
        <div class="pg-title">
          <h2>Fishing</h2>
          <div class="pg-xp-area" id="pgxp-fishing"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-fishing"></div>
    </div>
    <!-- FIREMAKING -->
    <div class="page" id="page-firemaking">
      <div id="cur-firemaking"></div>
      <div class="pg-header">
        <div class="pg-icon">üî•</div>
        <div class="pg-title">
          <h2>Firemaking</h2>
          <div class="pg-xp-area" id="pgxp-firemaking"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-firemaking"></div>
    </div>
    <!-- SMITHING -->
    <div class="page" id="page-smithing">
      <div id="cur-smithing"></div>
      <div class="pg-header">
        <div class="pg-icon">üî®</div>
        <div class="pg-title">
          <h2>Smithing</h2>
          <div class="pg-xp-area" id="pgxp-smithing"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-smithing"></div>
      <div class="sec-title">‚öíÔ∏è Craft Equipment</div>
      <div class="action-grid" id="grid-smithing-craft"></div>
    </div>
    <!-- COOKING -->
    <div class="page" id="page-cooking">
      <div id="cur-cooking"></div>
      <div class="pg-header">
        <div class="pg-icon">üç≥</div>
        <div class="pg-title">
          <h2>Cooking</h2>
          <div class="pg-xp-area" id="pgxp-cooking"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-cooking"></div>
    </div>
    <!-- COMBAT -->
    <div class="page" id="page-combat">
      <div class="pg-header">
        <div class="pg-icon">‚öîÔ∏è</div>
        <div class="pg-title">
          <h2>Combat</h2>
          <div class="pg-xp-area" id="pgxp-combat"></div>
        </div>
      </div>
      <div class="combat-layout">
        <div>
          <div class="combat-arena">
            <div class="combatants" id="combatants-display"></div>
            <div class="combat-log" id="combat-log"><p class="clog-p">Select a zone and monster to begin fighting...</p></div>
            <div class="combat-btns" id="combat-btns">
              <button class="btn btn-green" onclick="startCombat()" id="btn-fight">‚öîÔ∏è Fight</button>
              <button class="btn btn-red" onclick="stopCombat()">‚úã Stop</button>
            </div>
          </div>
          <div class="sec-title">üçñ Food in Bank</div>
          <div id="food-display" style="font-size:12px;color:var(--text2)">No food available. Cook some fish first!</div>
        </div>
        <div>
          <div class="sec-title">üó∫Ô∏è Combat Zones</div>
          <div class="zone-select" id="zone-select"></div>
          <div class="sec-title" id="monster-section-title" style="margin-top:16px;display:none">üëπ Monsters</div>
          <div class="monster-select" id="monster-select"></div>
        </div>
      </div>
    </div>
    <!-- STATS -->
    <div class="page" id="page-stats">
      <div class="pg-header">
        <div class="pg-icon">üìä</div>
        <div class="pg-title"><h2>Player Stats</h2></div>
      </div>
      <div class="stats-page-grid">
        <div>
          <!-- Total Level -->
          <div class="total-level-display">
            <div class="tld-label">Total Level</div>
            <div class="tld-value" id="stats-total-level">-</div>
            <div class="tld-sub">Sum of all skill levels</div>
          </div>
          <!-- All Skills Overview -->
          <div class="stats-section">
            <h3>‚öíÔ∏è Skills</h3>
            <div class="skill-overview-grid" id="stats-skill-grid"></div>
          </div>
          <!-- Mastery Shop Purchases -->
          <div class="stats-section" style="margin-top:12px">
            <h3>üõí Mastery Shop Purchases</h3>
            <div id="stats-mastery-track"></div>
          </div>
        </div>
        <div>
          <!-- Combat Stats -->
          <div class="stats-section">
            <h3>‚öîÔ∏è Combat Stats</h3>
            <div class="csc-grid" id="stats-combat-grid"></div>
          </div>
          <!-- Combat Sub-Skills XP -->
          <div class="stats-section" style="margin-top:12px">
            <h3>üß¨ Combat Skills XP</h3>
            <div id="stats-combat-xp"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- BANK -->
    <div class="page" id="page-bank">
      <div class="pg-header">
        <div class="pg-icon">üè¶</div>
        <div class="pg-title"><h2>Bank</h2></div>
      </div>
      <div class="bank-top">
        <div class="bank-gold">ü™ô <span id="bank-gold-disp">0</span> gp</div>
        <div class="sell-all-row">
          <button class="btn btn-gold" onclick="sellAllCategory('logs')">Sell All Logs</button>
          <button class="btn btn-gold" onclick="sellAllCategory('ore')">Sell All Ore</button>
          <button class="btn btn-gold" onclick="sellAllCategory('bar')">Sell All Bars</button>
          <button class="btn btn-gold" onclick="sellAllCategory('fish')">Sell All Fish</button>
        </div>
      </div>
      <div class="bank-cats" id="bank-cats"></div>
      <div style="font-size:10px;color:var(--text3);margin-bottom:8px;text-align:center">üí° Drag items to reorder in the "All" tab</div>
      <div class="bank-grid" id="bank-grid"></div>
    </div>
    <!-- EQUIPMENT -->
    <div class="page" id="page-equipment">
      <div class="pg-header">
        <div class="pg-icon">üõ°Ô∏è</div>
        <div class="pg-title"><h2>Equipment</h2></div>
      </div>
      <div class="equip-layout">
        <div>
          <div class="equip-slots" id="equip-slots"></div>
        </div>
        <div>
          <div class="stats-display" id="stats-display"></div>
          <!-- Available Equipment (moved here) -->
          <div class="equip-available" style="margin-top:14px">
            <div class="sec-title">üì¶ Available to Equip</div>
            <div class="equip-avail-grid" id="equip-avail-grid"></div>
          </div>
        </div>
      </div>
      <!-- Gear Infusion Section (full width) -->
      <div style="margin-top:20px">
        <div class="sec-title">‚ú® Gear Infusion</div>
        <div style="font-size:11px;color:var(--text3);margin-bottom:12px;text-align:center">Infuse gear with materials to permanently enhance stats (+1-10% per rank)</div>
        <div id="infusion-options"></div>
      </div>
    </div>
    <!-- CONTRACTS -->
    <div class="page" id="page-contracts">
      <div class="pg-header">
        <div class="pg-icon">üìã</div>
        <div class="pg-title"><h2>Requisition Board</h2></div>
      </div>
      <div class="contract-refresh" id="contract-refresh-timer"></div>
      <div class="contract-grid" id="contract-grid"></div>
    </div>
    <!-- MASTERY SHOP -->
    <div class="page" id="page-mastery-shop">
      <div class="pg-header">
        <div class="pg-icon">‚≠ê</div>
        <div class="pg-title"><h2>Mastery Exchange</h2></div>
      </div>
      <div class="mastery-total">
        <div class="mt-label">Available Mastery Points</div>
        <div class="mt-value" id="ms-total-points">0</div>
        <div class="mt-sub">Spend mastery to unlock permanent bonuses</div>
      </div>
      <div class="mastery-tabs" id="ms-tabs"></div>
      <div class="upgrade-grid" id="upgrade-grid"></div>
    </div>
    <!-- GENERAL STORE -->
    <div class="page" id="page-store">
      <div class="pg-header">
        <div class="pg-icon">üè™</div>
        <div class="pg-title">
          <h2>General Store</h2>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">üí∞ Your Gold: <span style="color:var(--gold2);font-weight:600" id="store-gold">0gp</span></div>
        </div>
      </div>
      <div class="store-categories" id="store-categories"></div>
      <div class="store-grid" id="store-grid"></div>
    </div>
  </div>
</div>

<div id="notifs"></div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Equip Item</h3>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA DEFINITIONS
// ============================================================

// XP table (RS-style): XP needed to reach each level
const XP_TABLE = (()=>{
  const t=[0];
  let pts=0;
  for(let i=1;i<=99;i++){
    pts += Math.floor(i + 300 * Math.pow(2, i/7));
    t.push(Math.floor(pts/4));
  }
  return t;
})();

function xpToLevel(xp){
  let lv=1;
  for(let i=1;i<99;i++){if(xp>=XP_TABLE[i])lv=i+1;else break;}
  return lv;
}
function xpForLevel(lv){return XP_TABLE[lv-1]||0;}
function xpToNextLevel(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 0;
  return XP_TABLE[lv]-xp;
}
function xpProgress(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 1;
  const base=XP_TABLE[lv-1];
  const next=XP_TABLE[lv];
  return (xp-base)/(next-base);
}

const fmt=(n)=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':String(Math.floor(n));

// ITEMS
const ITEMS = {
  normal_log:{name:'Kindlewood',icon:'ü™µ',value:5,cat:'logs'},
  oak_log:{name:'Brackenbark',icon:'ü™µ',value:15,cat:'logs'},
  willow_log:{name:'Ironroot',icon:'ü™µ',value:30,cat:'logs'},
  maple_log:{name:'Duskhollow',icon:'üçÅ',value:60,cat:'logs'},
  teak_log:{name:'Ambergrain',icon:'ü™µ',value:90,cat:'logs'},
  yew_log:{name:'Frostelm',icon:'üå≤',value:140,cat:'logs'},
  magic_log:{name:'Stormheart Timber',icon:'‚ú®',value:220,cat:'logs'},
  redwood_log:{name:'Mythoak',icon:'üå≥',value:350,cat:'logs'},
  copper_ore:{name:'Graveliron Ore',icon:'üü§',value:5,cat:'ore'},
  tin_ore:{name:'Graveliron Flux',icon:'üîµ',value:5,cat:'ore'},
  iron_ore:{name:'Redvein Copper',icon:'‚¨õ',value:15,cat:'ore'},
  silver_ore:{name:'Tinflare Ore',icon:'‚ö™',value:25,cat:'ore'},
  coal:{name:'Emberstone',icon:'üñ§',value:25,cat:'ore'},
  mithril_ore:{name:'Pale Silver',icon:'üí†',value:60,cat:'ore'},
  adamant_ore:{name:'Goldember Ore',icon:'üü¢',value:120,cat:'ore'},
  runite_ore:{name:'Cobalite Ore',icon:'üî∑',value:200,cat:'ore'},
  dragon_ore:{name:'Nightnickel Ore',icon:'üî∂',value:400,cat:'ore'},
  raw_shrimp:{name:'Ripplefin',icon:'ü¶ê',value:3,cat:'fish'},
  raw_trout:{name:'Stonebelly Carp',icon:'üêü',value:10,cat:'fish'},
  raw_salmon:{name:'Glintscale',icon:'üê†',value:20,cat:'fish'},
  raw_tuna:{name:'Longwhisk Pike',icon:'üêü',value:35,cat:'fish'},
  raw_lobster:{name:'Bluecurrent Salmon',icon:'ü¶û',value:50,cat:'fish'},
  raw_bass:{name:'Reefstrider',icon:'üêü',value:70,cat:'fish'},
  raw_swordfish:{name:'Mist Koi',icon:'üó°Ô∏è',value:100,cat:'fish'},
  raw_monkfish:{name:'Thunderhead Catfish',icon:'üêü',value:140,cat:'fish'},
  raw_shark:{name:'Crystal Perch',icon:'ü¶à',value:200,cat:'fish'},
  raw_manta:{name:'Abyss Lanternfish',icon:'üêü',value:280,cat:'fish'},
  raw_turtle:{name:'Crownray',icon:'üê¢',value:400,cat:'fish'},
  bronze_bar:{name:'Graveliron Ingot',icon:'üü´',value:40,cat:'bar'},
  iron_bar:{name:'Emberguard Ingot',icon:'üî©',value:80,cat:'bar'},
  silver_bar:{name:'Brightmail Ingot',icon:'‚öôÔ∏è',value:120,cat:'bar'},
  steel_bar:{name:'Grimforge Ingot',icon:'‚öôÔ∏è',value:150,cat:'bar'},
  mithril_bar:{name:'Moonweave Ingot',icon:'üíé',value:300,cat:'bar'},
  adamant_bar:{name:'Sungilt Ingot',icon:'üî∞',value:600,cat:'bar'},
  rune_bar:{name:'Stormcast Ingot',icon:'üî∑',value:1200,cat:'bar'},
  dragon_bar:{name:'Duskwarden Ingot',icon:'üî∂',value:2500,cat:'bar'},
  infusion_crystal:{name:'Infusion Crystal',icon:'üíé',value:100000,cat:'material'},
  cooked_shrimp:{name:'Grilled Ripplefin',icon:'üç§',value:20,cat:'food',heals:3},
  cooked_trout:{name:'Grilled Stonebelly',icon:'üç£',value:60,cat:'food',heals:7},
  cooked_salmon:{name:'Grilled Glintscale',icon:'ü•©',value:120,cat:'food',heals:12},
  cooked_tuna:{name:'Grilled Longwhisk',icon:'üç£',value:180,cat:'food',heals:16},
  cooked_lobster:{name:'Grilled Bluecurrent',icon:'ü¶û',value:250,cat:'food',heals:20},
  cooked_bass:{name:'Grilled Reefstrider',icon:'üç£',value:350,cat:'food',heals:24},
  cooked_swordfish:{name:'Grilled Mist Koi',icon:'üçñ',value:500,cat:'food',heals:28},
  cooked_monkfish:{name:'Grilled Thunderhead',icon:'üç£',value:700,cat:'food',heals:32},
  cooked_shark:{name:'Grilled Crystal Perch',icon:'üçñ',value:1000,cat:'food',heals:36},
  cooked_manta:{name:'Grilled Lanternfish',icon:'üç£',value:1400,cat:'food',heals:40},
  cooked_turtle:{name:'Grilled Crownray',icon:'üç≤',value:2000,cat:'food',heals:44},
  burnt_shrimp:{name:'Charred Ripplefin',icon:'üü´',value:0,cat:'junk'},
  burnt_trout:{name:'Charred Stonebelly',icon:'üü´',value:0,cat:'junk'},
  burnt_salmon:{name:'Charred Glintscale',icon:'üü´',value:0,cat:'junk'},
  burnt_tuna:{name:'Charred Longwhisk',icon:'üü´',value:0,cat:'junk'},
  burnt_lobster:{name:'Charred Bluecurrent',icon:'üü´',value:0,cat:'junk'},
  burnt_bass:{name:'Charred Reefstrider',icon:'üü´',value:0,cat:'junk'},
  burnt_swordfish:{name:'Charred Mist Koi',icon:'üü´',value:0,cat:'junk'},
  burnt_monkfish:{name:'Charred Thunderhead',icon:'üü´',value:0,cat:'junk'},
  burnt_shark:{name:'Charred Crystal Perch',icon:'üü´',value:0,cat:'junk'},
  burnt_manta:{name:'Charred Lanternfish',icon:'üü´',value:0,cat:'junk'},
  burnt_turtle:{name:'Charred Crownray',icon:'üü´',value:0,cat:'junk'},
  bones:{name:'Bones',icon:'ü¶¥',value:2,cat:'junk'},
  // Trinkets (Unique drops)
  woodcutters_trinket:{name:'Woodcutter\'s Trinket',icon:'ü™ì',value:5000,cat:'trinket',slot:'trinket',skill:'woodcutting',bonus:'10% XP + 2x logs'},
  miners_trinket:{name:'Miner\'s Trinket',icon:'‚õèÔ∏è',value:5000,cat:'trinket',slot:'trinket',skill:'mining',bonus:'10% XP + 2x ore'},
  fishermans_trinket:{name:'Fisherman\'s Trinket',icon:'üé£',value:5000,cat:'trinket',slot:'trinket',skill:'fishing',bonus:'10% XP + 2x fish'},
  firemakers_trinket:{name:'Firemaker\'s Trinket',icon:'üî•',value:5000,cat:'trinket',slot:'trinket',skill:'firemaking',bonus:'10% XP + 25% save logs'},
  smiths_trinket:{name:'Smith\'s Trinket',icon:'üî®',value:5000,cat:'trinket',slot:'trinket',skill:'smithing',bonus:'10% XP + 25% save materials'},
  chefs_trinket:{name:'Chef\'s Trinket',icon:'üç≥',value:5000,cat:'trinket',slot:'trinket',skill:'cooking',bonus:'10% XP + 25% save fish'},
  brawlers_trinket:{name:'Brawler\'s Trinket',icon:'‚öîÔ∏è',value:5000,cat:'trinket',slot:'trinket',skill:'combat',bonus:'10% all combat stats + 10% loot'},
  // Equipment
  // Equipment - Weapons
  bronze_sword:{name:'Roughplate Blade',icon:'üó°Ô∏è',value:200,cat:'weapon',slot:'weapon',atk:4,def:0,reqAtk:1,reqStr:1},
  iron_sword:{name:'Emberguard Blade',icon:'‚öîÔ∏è',value:500,cat:'weapon',slot:'weapon',atk:8,def:0,reqAtk:15,reqStr:15},
  silver_sword:{name:'Brightmail Blade',icon:'üó°Ô∏è',value:800,cat:'weapon',slot:'weapon',atk:12,def:0,reqAtk:20,reqStr:20},
  steel_sword:{name:'Grimforge Blade',icon:'üî±',value:1200,cat:'weapon',slot:'weapon',atk:14,def:0,reqAtk:30,reqStr:30},
  mithril_sword:{name:'Moonweave Blade',icon:'‚öîÔ∏è',value:2000,cat:'weapon',slot:'weapon',atk:20,def:0,reqAtk:40,reqStr:40},
  adamant_sword:{name:'Sungilt Blade',icon:'üó°Ô∏è',value:4000,cat:'weapon',slot:'weapon',atk:26,def:0,reqAtk:55,reqStr:55},
  rune_sword:{name:'Stormcast Blade',icon:'üî±',value:8000,cat:'weapon',slot:'weapon',atk:34,def:0,reqAtk:70,reqStr:70},
  dragon_sword:{name:'Duskwarden Blade',icon:'‚öîÔ∏è',value:16000,cat:'weapon',slot:'weapon',atk:44,def:0,reqAtk:85,reqStr:85},
  // Equipment - Shields
  bronze_shield:{name:'Roughplate Ward',icon:'üõ°Ô∏è',value:160,cat:'armor',slot:'shield',atk:0,def:3,reqDef:1},
  iron_shield:{name:'Emberguard Ward',icon:'üõ°Ô∏è',value:400,cat:'armor',slot:'shield',atk:0,def:7,reqDef:15},
  silver_shield:{name:'Brightmail Ward',icon:'üõ°Ô∏è',value:650,cat:'armor',slot:'shield',atk:0,def:10,reqDef:20},
  steel_shield:{name:'Grimforge Ward',icon:'üõ°Ô∏è',value:900,cat:'armor',slot:'shield',atk:0,def:12,reqDef:30},
  mithril_shield:{name:'Moonweave Ward',icon:'üõ°Ô∏è',value:1600,cat:'armor',slot:'shield',atk:0,def:18,reqDef:40},
  adamant_shield:{name:'Sungilt Ward',icon:'üõ°Ô∏è',value:3200,cat:'armor',slot:'shield',atk:0,def:24,reqDef:55},
  rune_shield:{name:'Stormcast Ward',icon:'üõ°Ô∏è',value:6400,cat:'armor',slot:'shield',atk:0,def:32,reqDef:70},
  dragon_shield:{name:'Duskwarden Ward',icon:'üõ°Ô∏è',value:12800,cat:'armor',slot:'shield',atk:0,def:42,reqDef:85},
  // Equipment - Body
  bronze_body:{name:'Roughplate Cuirass',icon:'ü¶∫',value:140,cat:'armor',slot:'body',atk:0,def:5,reqDef:1},
  leather_body:{name:'Hide Jerkin',icon:'ü¶∫',value:120,cat:'armor',slot:'body',atk:0,def:4,reqDef:1},
  iron_body:{name:'Emberguard Cuirass',icon:'üß•',value:600,cat:'armor',slot:'body',atk:0,def:10,reqDef:15},
  silver_body:{name:'Brightmail Cuirass',icon:'üß•',value:1000,cat:'armor',slot:'body',atk:0,def:14,reqDef:20},
  steel_body:{name:'Grimforge Cuirass',icon:'üß•',value:1400,cat:'armor',slot:'body',atk:0,def:16,reqDef:30},
  mithril_body:{name:'Moonweave Cuirass',icon:'üß•',value:2400,cat:'armor',slot:'body',atk:0,def:24,reqDef:40},
  adamant_body:{name:'Sungilt Cuirass',icon:'üß•',value:4800,cat:'armor',slot:'body',atk:0,def:32,reqDef:55},
  rune_body:{name:'Stormcast Cuirass',icon:'üß•',value:9600,cat:'armor',slot:'body',atk:0,def:42,reqDef:70},
  dragon_body:{name:'Duskwarden Cuirass',icon:'üß•',value:19200,cat:'armor',slot:'body',atk:0,def:54,reqDef:85},
  // Equipment - Helmets
  bronze_helmet:{name:'Roughplate Helm',icon:'‚õëÔ∏è',value:100,cat:'armor',slot:'helmet',atk:0,def:2,reqDef:1},
  iron_helmet:{name:'Emberguard Helm',icon:'‚õëÔ∏è',value:350,cat:'armor',slot:'helmet',atk:0,def:6,reqDef:15},
  silver_helmet:{name:'Brightmail Helm',icon:'‚õëÔ∏è',value:550,cat:'armor',slot:'helmet',atk:0,def:9,reqDef:20},
  steel_helmet:{name:'Grimforge Helm',icon:'‚õëÔ∏è',value:800,cat:'armor',slot:'helmet',atk:0,def:10,reqDef:30},
  mithril_helmet:{name:'Moonweave Helm',icon:'‚õëÔ∏è',value:1400,cat:'armor',slot:'helmet',atk:0,def:16,reqDef:40},
  adamant_helmet:{name:'Sungilt Helm',icon:'‚õëÔ∏è',value:2800,cat:'armor',slot:'helmet',atk:0,def:22,reqDef:55},
  rune_helmet:{name:'Stormcast Helm',icon:'‚õëÔ∏è',value:5600,cat:'armor',slot:'helmet',atk:0,def:30,reqDef:70},
  dragon_helmet:{name:'Duskwarden Helm',icon:'‚õëÔ∏è',value:11200,cat:'armor',slot:'helmet',atk:0,def:40,reqDef:85},
  // Equipment - Legs
  bronze_legs:{name:'Roughplate Greaves',icon:'üëñ',value:100,cat:'armor',slot:'legs',atk:0,def:3,reqDef:1},
  iron_legs:{name:'Emberguard Greaves',icon:'üëñ',value:350,cat:'armor',slot:'legs',atk:0,def:7,reqDef:15},
  silver_legs:{name:'Brightmail Greaves',icon:'üëñ',value:550,cat:'armor',slot:'legs',atk:0,def:10,reqDef:20},
  steel_legs:{name:'Grimforge Greaves',icon:'üëñ',value:800,cat:'armor',slot:'legs',atk:0,def:11,reqDef:30},
  mithril_legs:{name:'Moonweave Greaves',icon:'üëñ',value:1400,cat:'armor',slot:'legs',atk:0,def:18,reqDef:40},
  adamant_legs:{name:'Sungilt Greaves',icon:'üëñ',value:2800,cat:'armor',slot:'legs',atk:0,def:24,reqDef:55},
  rune_legs:{name:'Stormcast Greaves',icon:'üëñ',value:5600,cat:'armor',slot:'legs',atk:0,def:32,reqDef:70},
  dragon_legs:{name:'Duskwarden Greaves',icon:'üëñ',value:11200,cat:'armor',slot:'legs',atk:0,def:44,reqDef:85},
  // Equipment - Gloves
  bronze_gloves:{name:'Roughplate Gauntlets',icon:'üß§',value:100,cat:'armor',slot:'gloves',atk:0,def:2,reqDef:1},
  iron_gloves:{name:'Emberguard Gauntlets',icon:'üß§',value:350,cat:'armor',slot:'gloves',atk:0,def:6,reqDef:15},
  silver_gloves:{name:'Brightmail Gauntlets',icon:'üß§',value:550,cat:'armor',slot:'gloves',atk:0,def:9,reqDef:20},
  steel_gloves:{name:'Grimforge Gauntlets',icon:'üß§',value:800,cat:'armor',slot:'gloves',atk:0,def:10,reqDef:30},
  mithril_gloves:{name:'Moonweave Gauntlets',icon:'üß§',value:1400,cat:'armor',slot:'gloves',atk:0,def:16,reqDef:40},
  adamant_gloves:{name:'Sungilt Gauntlets',icon:'üß§',value:2800,cat:'armor',slot:'gloves',atk:0,def:22,reqDef:55},
  rune_gloves:{name:'Stormcast Gauntlets',icon:'üß§',value:5600,cat:'armor',slot:'gloves',atk:0,def:30,reqDef:70},
  dragon_gloves:{name:'Duskwarden Gauntlets',icon:'üß§',value:11200,cat:'armor',slot:'gloves',atk:0,def:40,reqDef:85},
  // Equipment - Boots
  bronze_boots:{name:'Roughplate Sabatons',icon:'ü•æ',value:100,cat:'armor',slot:'boots',atk:0,def:3,reqDef:1},
  iron_boots:{name:'Emberguard Sabatons',icon:'ü•æ',value:350,cat:'armor',slot:'boots',atk:0,def:7,reqDef:15},
  silver_boots:{name:'Brightmail Sabatons',icon:'ü•æ',value:550,cat:'armor',slot:'boots',atk:0,def:10,reqDef:20},
  steel_boots:{name:'Grimforge Sabatons',icon:'ü•æ',value:800,cat:'armor',slot:'boots',atk:0,def:11,reqDef:30},
  mithril_boots:{name:'Moonweave Sabatons',icon:'ü•æ',value:1400,cat:'armor',slot:'boots',atk:0,def:18,reqDef:40},
  adamant_boots:{name:'Sungilt Sabatons',icon:'ü•æ',value:2800,cat:'armor',slot:'boots',atk:0,def:24,reqDef:55},
  rune_boots:{name:'Stormcast Sabatons',icon:'ü•æ',value:5600,cat:'armor',slot:'boots',atk:0,def:32,reqDef:70},
  dragon_boots:{name:'Duskwarden Sabatons',icon:'ü•æ',value:11200,cat:'armor',slot:'boots',atk:0,def:44,reqDef:85},
};

// SKILL ACTIONS
const ACTIONS = {
  woodcutting:[
    {id:'normal_tree',name:'Kindlewood Tree',icon:'üå≥',levelReq:1,xp:25,masteryXp:8,ticks:5,produces:'normal_log',qty:1},
    {id:'oak_tree',name:'Brackenbark Tree',icon:'üå≤',levelReq:15,xp:37,masteryXp:12,ticks:7,produces:'oak_log',qty:1},
    {id:'willow_tree',name:'Ironroot Tree',icon:'üåø',levelReq:30,xp:67,masteryXp:20,ticks:10,produces:'willow_log',qty:1},
    {id:'maple_tree',name:'Duskhollow Tree',icon:'üçÅ',levelReq:45,xp:100,masteryXp:32,ticks:13,produces:'maple_log',qty:1},
    {id:'teak_tree',name:'Ambergrain Tree',icon:'ü™µ',levelReq:55,xp:135,masteryXp:42,ticks:16,produces:'teak_log',qty:1},
    {id:'yew_tree',name:'Frostelm Tree',icon:'üå≤',levelReq:65,xp:180,masteryXp:54,ticks:19,produces:'yew_log',qty:1},
    {id:'magic_tree',name:'Stormheart',icon:'‚ú®',levelReq:75,xp:240,masteryXp:68,ticks:22,produces:'magic_log',qty:1},
    {id:'redwood_tree',name:'Mythoak',icon:'üå≥',levelReq:85,xp:320,masteryXp:85,ticks:26,produces:'redwood_log',qty:1},
  ],
  mining:[
    {id:'copper_rock',name:'Graveliron Deposit',icon:'üü§',levelReq:1,xp:17,masteryXp:6,ticks:4,produces:'copper_ore',qty:1},
    {id:'tin_rock',name:'Graveliron Flux Vein',icon:'üîµ',levelReq:1,xp:17,masteryXp:6,ticks:4,produces:'tin_ore',qty:1},
    {id:'iron_rock',name:'Redvein Deposit',icon:'‚¨õ',levelReq:15,xp:35,masteryXp:12,ticks:7,produces:'iron_ore',qty:1},
    {id:'silver_rock',name:'Tinflare Vein',icon:'‚ö™',levelReq:20,xp:40,masteryXp:14,ticks:8,produces:'silver_ore',qty:1},
    {id:'coal_rock',name:'Emberstone Seam',icon:'üñ§',levelReq:30,xp:50,masteryXp:16,ticks:12,produces:'coal',qty:1},
    {id:'mithril_rock',name:'Pale Silver Node',icon:'üí†',levelReq:40,xp:80,masteryXp:24,ticks:14,produces:'mithril_ore',qty:1},
    {id:'adamant_rock',name:'Goldember Vein',icon:'üü¢',levelReq:55,xp:120,masteryXp:36,ticks:18,produces:'adamant_ore',qty:1},
    {id:'runite_rock',name:'Cobalite Deposit',icon:'üî∑',levelReq:70,xp:180,masteryXp:50,ticks:22,produces:'runite_ore',qty:1},
    {id:'dragon_rock',name:'Nightnickel Outcrop',icon:'üî∂',levelReq:85,xp:280,masteryXp:70,ticks:28,produces:'dragon_ore',qty:1},
  ],
  fishing:[
    {id:'shrimp_spot',name:'Ripplefin School',icon:'ü¶ê',levelReq:1,xp:10,masteryXp:4,ticks:4,produces:'raw_shrimp',qty:1},
    {id:'trout_spot',name:'Stonebelly Pool',icon:'üêü',levelReq:15,xp:40,masteryXp:14,ticks:6,produces:'raw_trout',qty:1},
    {id:'salmon_spot',name:'Glintscale Run',icon:'üê†',levelReq:25,xp:60,masteryXp:20,ticks:8,produces:'raw_salmon',qty:1},
    {id:'tuna_spot',name:'Longwhisk Waters',icon:'üêü',levelReq:35,xp:85,masteryXp:28,ticks:10,produces:'raw_tuna',qty:1},
    {id:'lobster_spot',name:'Bluecurrent Shallows',icon:'ü¶û',levelReq:40,xp:110,masteryXp:36,ticks:12,produces:'raw_lobster',qty:1},
    {id:'bass_spot',name:'Reefstrider Grounds',icon:'üêü',levelReq:50,xp:140,masteryXp:44,ticks:14,produces:'raw_bass',qty:1},
    {id:'swordfish_spot',name:'Mist Koi Depths',icon:'üó°Ô∏è',levelReq:55,xp:170,masteryXp:52,ticks:16,produces:'raw_swordfish',qty:1},
    {id:'monkfish_spot',name:'Thunderhead Basin',icon:'üêü',levelReq:65,xp:210,masteryXp:62,ticks:18,produces:'raw_monkfish',qty:1},
    {id:'shark_spot',name:'Crystal Perch Trench',icon:'ü¶à',levelReq:75,xp:260,masteryXp:74,ticks:20,produces:'raw_shark',qty:1},
    {id:'manta_spot',name:'Abyss Pool',icon:'üêü',levelReq:85,xp:320,masteryXp:88,ticks:23,produces:'raw_manta',qty:1},
    {id:'turtle_spot',name:'Crownray Sanctuary',icon:'üê¢',levelReq:95,xp:400,masteryXp:105,ticks:26,produces:'raw_turtle',qty:1},
  ],
  firemaking:[
    {id:'burn_log',name:'Kindlewood',icon:'üî•',levelReq:1,xp:40,masteryXp:14,ticks:3,consumes:{normal_log:1}},
    {id:'burn_oak',name:'Brackenbark',icon:'üî•',levelReq:15,xp:60,masteryXp:20,ticks:3,consumes:{oak_log:1}},
    {id:'burn_willow',name:'Ironroot',icon:'üî•',levelReq:30,xp:90,masteryXp:28,ticks:4,consumes:{willow_log:1}},
    {id:'burn_maple',name:'Duskhollow',icon:'üî•',levelReq:45,xp:135,masteryXp:40,ticks:4,consumes:{maple_log:1}},
    {id:'burn_teak',name:'Ambergrain',icon:'üî•',levelReq:55,xp:180,masteryXp:50,ticks:5,consumes:{teak_log:1}},
    {id:'burn_yew',name:'Frostelm',icon:'üî•',levelReq:65,xp:240,masteryXp:62,ticks:5,consumes:{yew_log:1}},
    {id:'burn_magic',name:'Stormheart Timber',icon:'üî•',levelReq:75,xp:320,masteryXp:76,ticks:6,consumes:{magic_log:1}},
    {id:'burn_redwood',name:'Mythoak',icon:'üî•',levelReq:85,xp:425,masteryXp:92,ticks:6,consumes:{redwood_log:1}},
  ],
  smithing:[
    {id:'bronze_bar',name:'Graveliron Ingot',icon:'üü´',levelReq:1,xp:12,masteryXp:5,ticks:4,consumes:{copper_ore:1,tin_ore:1},produces:'bronze_bar',qty:1},
    {id:'iron_bar',name:'Emberguard Ingot',icon:'üî©',levelReq:15,xp:25,masteryXp:10,ticks:6,consumes:{iron_ore:2},produces:'iron_bar',qty:1},
    {id:'silver_bar',name:'Brightmail Ingot',icon:'‚öôÔ∏è',levelReq:20,xp:30,masteryXp:12,ticks:7,consumes:{silver_ore:1},produces:'silver_bar',qty:1},
    {id:'steel_bar',name:'Grimforge Ingot',icon:'‚öôÔ∏è',levelReq:30,xp:37,masteryXp:14,ticks:9,consumes:{iron_ore:1,coal:2},produces:'steel_bar',qty:1},
    {id:'mithril_bar',name:'Moonweave Ingot',icon:'üíé',levelReq:40,xp:70,masteryXp:24,ticks:11,consumes:{mithril_ore:1,coal:2},produces:'mithril_bar',qty:1},
    {id:'adamant_bar',name:'Sungilt Ingot',icon:'üî∞',levelReq:55,xp:110,masteryXp:36,ticks:13,consumes:{adamant_ore:1,coal:3},produces:'adamant_bar',qty:1},
    {id:'rune_bar',name:'Stormcast Ingot',icon:'üî∑',levelReq:70,xp:170,masteryXp:50,ticks:15,consumes:{runite_ore:1,coal:4},produces:'rune_bar',qty:1},
    {id:'dragon_bar',name:'Duskwarden Ingot',icon:'üî∂',levelReq:85,xp:260,masteryXp:70,ticks:18,consumes:{dragon_ore:1,coal:6},produces:'dragon_bar',qty:1},
  ],
  smithingCraft:[
    // Roughplate Set (Lv 1-8)
    {id:'craft_bronze_sword',name:'Roughplate Blade',icon:'üó°Ô∏è',levelReq:1,xp:25,ticks:3,consumes:{bronze_bar:2},produces:'bronze_sword',qty:1},
    {id:'craft_bronze_shield',name:'Roughplate Ward',icon:'üõ°Ô∏è',levelReq:3,xp:20,ticks:3,consumes:{bronze_bar:2},produces:'bronze_shield',qty:1},
    {id:'craft_bronze_helmet',name:'Roughplate Helm',icon:'‚õëÔ∏è',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:1},produces:'bronze_helmet',qty:1},
    {id:'craft_bronze_body',name:'Roughplate Cuirass',icon:'ü¶∫',levelReq:8,xp:30,ticks:4,consumes:{bronze_bar:3},produces:'bronze_body',qty:1},
    {id:'craft_bronze_legs',name:'Roughplate Greaves',icon:'üëñ',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:2},produces:'bronze_legs',qty:1},
    {id:'craft_bronze_gloves',name:'Roughplate Gauntlets',icon:'üß§',levelReq:2,xp:18,ticks:3,consumes:{bronze_bar:1},produces:'bronze_gloves',qty:1},
    {id:'craft_bronze_boots',name:'Roughplate Sabatons',icon:'ü•æ',levelReq:4,xp:18,ticks:3,consumes:{bronze_bar:2},produces:'bronze_boots',qty:1},
    // Emberguard Set (Lv 15-28)
    {id:'craft_iron_sword',name:'Emberguard Blade',icon:'‚öîÔ∏è',levelReq:15,xp:50,ticks:5,consumes:{iron_bar:2},produces:'iron_sword',qty:1},
    {id:'craft_iron_shield',name:'Emberguard Ward',icon:'üõ°Ô∏è',levelReq:17,xp:40,ticks:5,consumes:{iron_bar:2},produces:'iron_shield',qty:1},
    {id:'craft_iron_helmet',name:'Emberguard Helm',icon:'‚õëÔ∏è',levelReq:19,xp:35,ticks:5,consumes:{iron_bar:2},produces:'iron_helmet',qty:1},
    {id:'craft_iron_body',name:'Emberguard Cuirass',icon:'üß•',levelReq:23,xp:60,ticks:7,consumes:{iron_bar:4},produces:'iron_body',qty:1},
    {id:'craft_iron_legs',name:'Emberguard Greaves',icon:'üëñ',levelReq:19,xp:55,ticks:7,consumes:{iron_bar:3},produces:'iron_legs',qty:1},
    {id:'craft_iron_gloves',name:'Emberguard Gauntlets',icon:'üß§',levelReq:16,xp:35,ticks:5,consumes:{iron_bar:2},produces:'iron_gloves',qty:1},
    {id:'craft_iron_boots',name:'Emberguard Sabatons',icon:'ü•æ',levelReq:18,xp:55,ticks:7,consumes:{iron_bar:3},produces:'iron_boots',qty:1},
    // Brightmail Set (Lv 20-28)
    {id:'craft_silver_sword',name:'Brightmail Blade',icon:'üó°Ô∏è',levelReq:20,xp:60,ticks:5,consumes:{silver_bar:2},produces:'silver_sword',qty:1},
    {id:'craft_silver_shield',name:'Brightmail Ward',icon:'üõ°Ô∏è',levelReq:22,xp:50,ticks:5,consumes:{silver_bar:2},produces:'silver_shield',qty:1},
    {id:'craft_silver_helmet',name:'Brightmail Helm',icon:'‚õëÔ∏è',levelReq:24,xp:45,ticks:5,consumes:{silver_bar:2},produces:'silver_helmet',qty:1},
    {id:'craft_silver_body',name:'Brightmail Cuirass',icon:'üß•',levelReq:28,xp:70,ticks:7,consumes:{silver_bar:4},produces:'silver_body',qty:1},
    {id:'craft_silver_legs',name:'Brightmail Greaves',icon:'üëñ',levelReq:24,xp:65,ticks:7,consumes:{silver_bar:3},produces:'silver_legs',qty:1},
    {id:'craft_silver_gloves',name:'Brightmail Gauntlets',icon:'üß§',levelReq:21,xp:45,ticks:5,consumes:{silver_bar:2},produces:'silver_gloves',qty:1},
    {id:'craft_silver_boots',name:'Brightmail Sabatons',icon:'ü•æ',levelReq:23,xp:65,ticks:7,consumes:{silver_bar:3},produces:'silver_boots',qty:1},
    // Grimforge Set (Lv 30-38)
    {id:'craft_steel_sword',name:'Grimforge Blade',icon:'üî±',levelReq:30,xp:80,ticks:7,consumes:{steel_bar:2},produces:'steel_sword',qty:1},
    {id:'craft_steel_shield',name:'Grimforge Ward',icon:'üõ°Ô∏è',levelReq:32,xp:70,ticks:7,consumes:{steel_bar:2},produces:'steel_shield',qty:1},
    {id:'craft_steel_helmet',name:'Grimforge Helm',icon:'‚õëÔ∏è',levelReq:34,xp:65,ticks:7,consumes:{steel_bar:2},produces:'steel_helmet',qty:1},
    {id:'craft_steel_body',name:'Grimforge Cuirass',icon:'üß•',levelReq:38,xp:100,ticks:9,consumes:{steel_bar:4},produces:'steel_body',qty:1},
    {id:'craft_steel_legs',name:'Grimforge Greaves',icon:'üëñ',levelReq:34,xp:85,ticks:8,consumes:{steel_bar:3},produces:'steel_legs',qty:1},
    {id:'craft_steel_gloves',name:'Grimforge Gauntlets',icon:'üß§',levelReq:31,xp:65,ticks:7,consumes:{steel_bar:2},produces:'steel_gloves',qty:1},
    {id:'craft_steel_boots',name:'Grimforge Sabatons',icon:'ü•æ',levelReq:33,xp:85,ticks:8,consumes:{steel_bar:3},produces:'steel_boots',qty:1},
    // Moonweave Set (Lv 40-48)
    {id:'craft_mithril_sword',name:'Moonweave Blade',icon:'‚öîÔ∏è',levelReq:40,xp:120,ticks:8,consumes:{mithril_bar:2},produces:'mithril_sword',qty:1},
    {id:'craft_mithril_shield',name:'Moonweave Ward',icon:'üõ°Ô∏è',levelReq:42,xp:100,ticks:8,consumes:{mithril_bar:2},produces:'mithril_shield',qty:1},
    {id:'craft_mithril_helmet',name:'Moonweave Helm',icon:'‚õëÔ∏è',levelReq:44,xp:90,ticks:8,consumes:{mithril_bar:2},produces:'mithril_helmet',qty:1},
    {id:'craft_mithril_body',name:'Moonweave Cuirass',icon:'üß•',levelReq:48,xp:150,ticks:10,consumes:{mithril_bar:4},produces:'mithril_body',qty:1},
    {id:'craft_mithril_legs',name:'Moonweave Greaves',icon:'üëñ',levelReq:44,xp:130,ticks:9,consumes:{mithril_bar:3},produces:'mithril_legs',qty:1},
    {id:'craft_mithril_gloves',name:'Moonweave Gauntlets',icon:'üß§',levelReq:41,xp:90,ticks:8,consumes:{mithril_bar:2},produces:'mithril_gloves',qty:1},
    {id:'craft_mithril_boots',name:'Moonweave Sabatons',icon:'ü•æ',levelReq:43,xp:130,ticks:9,consumes:{mithril_bar:3},produces:'mithril_boots',qty:1},
    // Sungilt Set (Lv 55-63)
    {id:'craft_adamant_sword',name:'Sungilt Blade',icon:'üó°Ô∏è',levelReq:55,xp:180,ticks:9,consumes:{adamant_bar:2},produces:'adamant_sword',qty:1},
    {id:'craft_adamant_shield',name:'Sungilt Ward',icon:'üõ°Ô∏è',levelReq:57,xp:150,ticks:9,consumes:{adamant_bar:2},produces:'adamant_shield',qty:1},
    {id:'craft_adamant_helmet',name:'Sungilt Helm',icon:'‚õëÔ∏è',levelReq:59,xp:140,ticks:9,consumes:{adamant_bar:2},produces:'adamant_helmet',qty:1},
    {id:'craft_adamant_body',name:'Sungilt Cuirass',icon:'üß•',levelReq:63,xp:220,ticks:11,consumes:{adamant_bar:4},produces:'adamant_body',qty:1},
    {id:'craft_adamant_legs',name:'Sungilt Greaves',icon:'üëñ',levelReq:59,xp:190,ticks:10,consumes:{adamant_bar:3},produces:'adamant_legs',qty:1},
    {id:'craft_adamant_gloves',name:'Sungilt Gauntlets',icon:'üß§',levelReq:56,xp:140,ticks:9,consumes:{adamant_bar:2},produces:'adamant_gloves',qty:1},
    {id:'craft_adamant_boots',name:'Sungilt Sabatons',icon:'ü•æ',levelReq:58,xp:190,ticks:10,consumes:{adamant_bar:3},produces:'adamant_boots',qty:1},
    // Stormcast Set (Lv 70-78)
    {id:'craft_rune_sword',name:'Stormcast Blade',icon:'üî±',levelReq:70,xp:260,ticks:10,consumes:{rune_bar:2},produces:'rune_sword',qty:1},
    {id:'craft_rune_shield',name:'Stormcast Ward',icon:'üõ°Ô∏è',levelReq:72,xp:220,ticks:10,consumes:{rune_bar:2},produces:'rune_shield',qty:1},
    {id:'craft_rune_helmet',name:'Stormcast Helm',icon:'‚õëÔ∏è',levelReq:74,xp:200,ticks:10,consumes:{rune_bar:2},produces:'rune_helmet',qty:1},
    {id:'craft_rune_body',name:'Stormcast Cuirass',icon:'üß•',levelReq:78,xp:320,ticks:12,consumes:{rune_bar:4},produces:'rune_body',qty:1},
    {id:'craft_rune_legs',name:'Stormcast Greaves',icon:'üëñ',levelReq:74,xp:280,ticks:11,consumes:{rune_bar:3},produces:'rune_legs',qty:1},
    {id:'craft_rune_gloves',name:'Stormcast Gauntlets',icon:'üß§',levelReq:71,xp:200,ticks:10,consumes:{rune_bar:2},produces:'rune_gloves',qty:1},
    {id:'craft_rune_boots',name:'Stormcast Sabatons',icon:'ü•æ',levelReq:73,xp:280,ticks:11,consumes:{rune_bar:3},produces:'rune_boots',qty:1},
    // Duskwarden Set (Lv 85-93)
    {id:'craft_dragon_sword',name:'Duskwarden Blade',icon:'‚öîÔ∏è',levelReq:85,xp:380,ticks:12,consumes:{dragon_bar:2},produces:'dragon_sword',qty:1},
    {id:'craft_dragon_shield',name:'Duskwarden Ward',icon:'üõ°Ô∏è',levelReq:87,xp:320,ticks:12,consumes:{dragon_bar:2},produces:'dragon_shield',qty:1},
    {id:'craft_dragon_helmet',name:'Duskwarden Helm',icon:'‚õëÔ∏è',levelReq:89,xp:300,ticks:12,consumes:{dragon_bar:2},produces:'dragon_helmet',qty:1},
    {id:'craft_dragon_body',name:'Duskwarden Cuirass',icon:'üß•',levelReq:93,xp:480,ticks:14,consumes:{dragon_bar:4},produces:'dragon_body',qty:1},
    {id:'craft_dragon_legs',name:'Duskwarden Greaves',icon:'üëñ',levelReq:89,xp:420,ticks:13,consumes:{dragon_bar:3},produces:'dragon_legs',qty:1},
    {id:'craft_dragon_gloves',name:'Duskwarden Gauntlets',icon:'üß§',levelReq:86,xp:300,ticks:12,consumes:{dragon_bar:2},produces:'dragon_gloves',qty:1},
    {id:'craft_dragon_boots',name:'Duskwarden Sabatons',icon:'ü•æ',levelReq:88,xp:420,ticks:13,consumes:{dragon_bar:3},produces:'dragon_boots',qty:1},
  ],
  cooking:[
    {id:'cook_shrimp',name:'Ripplefin',icon:'üç§',levelReq:1,xp:30,masteryXp:10,ticks:4,consumes:{raw_shrimp:1},produces:'cooked_shrimp',burnChance:0.35,burnItem:'burnt_shrimp'},
    {id:'cook_trout',name:'Stonebelly Carp',icon:'üç£',levelReq:15,xp:70,masteryXp:22,ticks:5,consumes:{raw_trout:1},produces:'cooked_trout',burnChance:0.35,burnItem:'burnt_trout'},
    {id:'cook_salmon',name:'Glintscale',icon:'ü•©',levelReq:25,xp:90,masteryXp:28,ticks:6,consumes:{raw_salmon:1},produces:'cooked_salmon',burnChance:0.35,burnItem:'burnt_salmon'},
    {id:'cook_tuna',name:'Longwhisk Pike',icon:'üç£',levelReq:35,xp:120,masteryXp:36,ticks:7,consumes:{raw_tuna:1},produces:'cooked_tuna',burnChance:0.32,burnItem:'burnt_tuna'},
    {id:'cook_lobster',name:'Bluecurrent Salmon',icon:'ü¶û',levelReq:40,xp:150,masteryXp:44,ticks:8,consumes:{raw_lobster:1},produces:'cooked_lobster',burnChance:0.30,burnItem:'burnt_lobster'},
    {id:'cook_bass',name:'Reefstrider',icon:'üç£',levelReq:50,xp:190,masteryXp:54,ticks:9,consumes:{raw_bass:1},produces:'cooked_bass',burnChance:0.28,burnItem:'burnt_bass'},
    {id:'cook_swordfish',name:'Mist Koi',icon:'üçñ',levelReq:55,xp:230,masteryXp:64,ticks:10,consumes:{raw_swordfish:1},produces:'cooked_swordfish',burnChance:0.25,burnItem:'burnt_swordfish'},
    {id:'cook_monkfish',name:'Thunderhead Catfish',icon:'üç£',levelReq:65,xp:280,masteryXp:76,ticks:11,consumes:{raw_monkfish:1},produces:'cooked_monkfish',burnChance:0.22,burnItem:'burnt_monkfish'},
    {id:'cook_shark',name:'Crystal Perch',icon:'üçñ',levelReq:75,xp:340,masteryXp:90,ticks:12,consumes:{raw_shark:1},produces:'cooked_shark',burnChance:0.20,burnItem:'burnt_shark'},
    {id:'cook_manta',name:'Abyss Lanternfish',icon:'üç£',levelReq:85,xp:420,masteryXp:106,ticks:13,consumes:{raw_manta:1},produces:'cooked_manta',burnChance:0.18,burnItem:'burnt_manta'},
    {id:'cook_turtle',name:'Crownray',icon:'üç≤',levelReq:95,xp:520,masteryXp:125,ticks:14,consumes:{raw_turtle:1},produces:'cooked_turtle',burnChance:0.15,burnItem:'burnt_turtle'},
  ],
};

// MONSTERS
// ============================================================
// COMBAT ZONES & MONSTERS
// ============================================================
const COMBAT_ZONES=[
  {
    id:'forest',
    name:'üå≤ Forest Clearing',
    desc:'A peaceful forest teeming with small creatures',
    levelReq:1,
    tier:'Roughplate'
  },
  {
    id:'cave',
    name:'üï≥Ô∏è Dark Caverns',
    desc:'Twisted tunnels filled with dangerous beasts',
    levelReq:15,
    tier:'Emberguard'
  },
  {
    id:'crypt',
    name:'‚ö∞Ô∏è Ancient Crypt',
    desc:'Forgotten tombs where the undead roam',
    levelReq:30,
    tier:'Grimforge'
  },
  {
    id:'volcano',
    name:'üåã Volcanic Peaks',
    desc:'Scorching mountains inhabited by fire creatures',
    levelReq:45,
    tier:'Moonweave'
  },
  {
    id:'abyss',
    name:'üåë Abyssal Depths',
    desc:'A dark realm where demons dwell',
    levelReq:60,
    tier:'Sungilt'
  },
  {
    id:'fortress',
    name:'üè∞ Shadow Fortress',
    desc:'An imposing stronghold guarded by elite warriors',
    levelReq:75,
    tier:'Stormcast'
  },
  {
    id:'realm',
    name:'‚ú® Celestial Realm',
    desc:'The domain of ancient dragons and gods',
    levelReq:85,
    tier:'Duskwarden'
  }
];

const MONSTERS=[
  // üå≤ FOREST CLEARING (Roughplate Tier, Lv 1-15)
  {id:'rat',name:'Giant Rat',icon:'üêÄ',zone:'forest',levelReq:1,hp:25,maxHp:25,atk:3,def:1,xp:12,drops:[
    {item:'bones',qty:1,chance:0.4},{item:'raw_shrimp',qty:1,chance:0.25},
    {gold:[2,6]}
  ]},
  {id:'goblin',name:'Goblin Scout',icon:'üë∫',zone:'forest',levelReq:3,hp:35,maxHp:35,atk:5,def:2,xp:18,drops:[
    {item:'bones',qty:1,chance:0.8},{item:'bronze_helmet',qty:1,chance:0.03},{item:'copper_ore',qty:1,chance:0.3},
    {gold:[3,10]}
  ]},
  {id:'wolf',name:'Forest Wolf',icon:'üê∫',zone:'forest',levelReq:8,hp:50,maxHp:50,atk:8,def:3,xp:25,drops:[
    {item:'bones',qty:1,chance:1},{item:'bronze_sword',qty:1,chance:0.04},{item:'bronze_body',qty:1,chance:0.02},
    {gold:[5,15]}
  ]},
  {id:'bear',name:'Black Bear',icon:'üêª',zone:'forest',levelReq:12,hp:75,maxHp:75,atk:12,def:5,xp:35,drops:[
    {item:'bones',qty:2,chance:1},{item:'bronze_body',qty:1,chance:0.05},{item:'bronze_legs',qty:1,chance:0.04},
    {gold:[8,22]}
  ]},
  
  // üï≥Ô∏è DARK CAVERNS (Emberguard Tier, Lv 15-30)
  {id:'bat',name:'Cave Bat',icon:'ü¶á',zone:'cave',levelReq:15,hp:90,maxHp:90,atk:15,def:6,xp:45,drops:[
    {item:'bones',qty:1,chance:0.5},{item:'iron_ore',qty:1,chance:0.3},{item:'iron_helmet',qty:1,chance:0.03},
    {gold:[12,28]}
  ]},
  {id:'spider',name:'Giant Spider',icon:'üï∑Ô∏è',zone:'cave',levelReq:18,hp:110,maxHp:110,atk:18,def:8,xp:55,drops:[
    {item:'iron_bar',qty:1,chance:0.25},{item:'iron_sword',qty:1,chance:0.04},{item:'iron_body',qty:1,chance:0.03},
    {gold:[15,35]}
  ]},
  {id:'troll',name:'Cave Troll',icon:'üëπ',zone:'cave',levelReq:23,hp:140,maxHp:140,atk:22,def:10,xp:70,drops:[
    {item:'bones',qty:2,chance:1},{item:'iron_bar',qty:2,chance:0.4},{item:'iron_legs',qty:1,chance:0.05},
    {gold:[20,45]}
  ]},
  {id:'scorpion',name:'Giant Scorpion',icon:'ü¶Ç',zone:'cave',levelReq:27,hp:170,maxHp:170,atk:26,def:12,xp:85,drops:[
    {item:'iron_bar',qty:2,chance:0.5},{item:'silver_ore',qty:1,chance:0.4},{item:'iron_shield',qty:1,chance:0.06},
    {gold:[25,55]}
  ]},
  
  // ‚ö∞Ô∏è ANCIENT CRYPT (Grimforge Tier, Lv 30-45)
  {id:'skeleton',name:'Skeleton Warrior',icon:'üíÄ',zone:'crypt',levelReq:30,hp:200,maxHp:200,atk:30,def:14,xp:100,drops:[
    {item:'bones',qty:3,chance:1},{item:'steel_bar',qty:1,chance:0.35},{item:'steel_helmet',qty:1,chance:0.04},
    {gold:[30,70]}
  ]},
  {id:'zombie',name:'Rotting Zombie',icon:'üßü',zone:'crypt',levelReq:34,hp:240,maxHp:240,atk:35,def:16,xp:120,drops:[
    {item:'bones',qty:2,chance:1},{item:'steel_bar',qty:1,chance:0.4},{item:'steel_body',qty:1,chance:0.04},
    {gold:[35,80]}
  ]},
  {id:'wraith',name:'Dark Wraith',icon:'üëª',zone:'crypt',levelReq:38,hp:220,maxHp:220,atk:42,def:14,xp:135,drops:[
    {item:'steel_bar',qty:2,chance:0.5},{item:'steel_sword',qty:1,chance:0.06},{item:'coal',qty:3,chance:0.6},
    {gold:[40,90]}
  ]},
  {id:'necromancer',name:'Necromancer',icon:'üßô',zone:'crypt',levelReq:43,hp:280,maxHp:280,atk:48,def:20,xp:160,drops:[
    {item:'bones',qty:5,chance:1},{item:'steel_bar',qty:2,chance:0.6},{item:'steel_body',qty:1,chance:0.07},{item:'mithril_ore',qty:1,chance:0.3},
    {gold:[50,115]}
  ]},
  
  // üåã VOLCANIC PEAKS (Moonweave Tier, Lv 45-60)
  {id:'fire_imp',name:'Fire Imp',icon:'üòà',zone:'volcano',levelReq:45,hp:300,maxHp:300,atk:52,def:22,xp:180,drops:[
    {item:'coal',qty:4,chance:0.8},{item:'mithril_bar',qty:1,chance:0.35},{item:'mithril_helmet',qty:1,chance:0.04},
    {gold:[60,130]}
  ]},
  {id:'lava_beast',name:'Lava Beast',icon:'üî•',zone:'volcano',levelReq:50,hp:360,maxHp:360,atk:58,def:26,xp:210,drops:[
    {item:'coal',qty:5,chance:0.9},{item:'mithril_bar',qty:2,chance:0.45},{item:'mithril_body',qty:1,chance:0.05},
    {gold:[70,150]}
  ]},
  {id:'fire_elemental',name:'Fire Elemental',icon:'üå™Ô∏è',zone:'volcano',levelReq:54,hp:340,maxHp:340,atk:65,def:24,xp:230,drops:[
    {item:'mithril_bar',qty:2,chance:0.5},{item:'mithril_sword',qty:1,chance:0.06},{item:'adamant_ore',qty:1,chance:0.3},
    {gold:[80,170]}
  ]},
  {id:'elder_dragon',name:'Elder Fire Dragon',icon:'üêâ',zone:'volcano',levelReq:58,hp:450,maxHp:450,atk:72,def:30,xp:270,drops:[
    {item:'mithril_bar',qty:3,chance:0.7},{item:'mithril_shield',qty:1,chance:0.08},{item:'adamant_ore',qty:2,chance:0.4},
    {gold:[100,200]}
  ]},
  
  // üåë ABYSSAL DEPTHS (Sungilt Tier, Lv 60-75)
  {id:'lesser_demon',name:'Lesser Demon',icon:'üòà',zone:'abyss',levelReq:60,hp:480,maxHp:480,atk:78,def:32,xp:300,drops:[
    {item:'bones',qty:3,chance:0.8},{item:'adamant_bar',qty:1,chance:0.35},{item:'adamant_helmet',qty:1,chance:0.04},
    {gold:[110,220]}
  ]},
  {id:'greater_demon',name:'Greater Demon',icon:'üëø',zone:'abyss',levelReq:65,hp:550,maxHp:550,atk:86,def:36,xp:340,drops:[
    {item:'adamant_bar',qty:2,chance:0.45},{item:'adamant_sword',qty:1,chance:0.06},{item:'adamant_body',qty:1,chance:0.05},
    {gold:[130,250]}
  ]},
  {id:'shadow_beast',name:'Shadow Beast',icon:'üêæ',zone:'abyss',levelReq:69,hp:520,maxHp:520,atk:92,def:34,xp:370,drops:[
    {item:'adamant_bar',qty:2,chance:0.5},{item:'adamant_legs',qty:1,chance:0.06},{item:'runite_ore',qty:1,chance:0.25},
    {gold:[140,270]}
  ]},
  {id:'demon_lord',name:'Demon Lord',icon:'üëπ',zone:'abyss',levelReq:73,hp:650,maxHp:650,atk:100,def:42,xp:420,drops:[
    {item:'adamant_bar',qty:3,chance:0.6},{item:'adamant_body',qty:1,chance:0.08},{item:'runite_ore',qty:2,chance:0.35},
    {gold:[160,300]}
  ]},
  
  // üè∞ SHADOW FORTRESS (Stormcast Tier, Lv 75-85)
  {id:'dark_knight',name:'Dark Knight',icon:'üó°Ô∏è',zone:'fortress',levelReq:75,hp:700,maxHp:700,atk:108,def:45,xp:480,drops:[
    {item:'runite_ore',qty:2,chance:0.5},{item:'rune_bar',qty:1,chance:0.35},{item:'rune_helmet',qty:1,chance:0.04},
    {gold:[180,340]}
  ]},
  {id:'void_warrior',name:'Void Warrior',icon:'‚öîÔ∏è',zone:'fortress',levelReq:79,hp:780,maxHp:780,atk:118,def:50,xp:540,drops:[
    {item:'rune_bar',qty:2,chance:0.45},{item:'rune_sword',qty:1,chance:0.06},{item:'rune_body',qty:1,chance:0.05},
    {gold:[200,380]}
  ]},
  {id:'lich',name:'Ancient Lich',icon:'‚ò†Ô∏è',zone:'fortress',levelReq:82,hp:850,maxHp:850,atk:125,def:48,xp:600,drops:[
    {item:'bones',qty:8,chance:1},{item:'rune_bar',qty:3,chance:0.55},{item:'rune_shield',qty:1,chance:0.07},{item:'dragon_ore',qty:1,chance:0.2},
    {gold:[220,420]}
  ]},
  {id:'titan',name:'Stone Titan',icon:'üóø',zone:'fortress',levelReq:85,hp:950,maxHp:950,atk:115,def:60,xp:680,drops:[
    {item:'runite_ore',qty:4,chance:0.7},{item:'rune_bar',qty:3,chance:0.6},{item:'rune_body',qty:1,chance:0.08},{item:'dragon_ore',qty:1,chance:0.25},
    {gold:[250,480]}
  ]},
  
  // ‚ú® CELESTIAL REALM (Duskwarden Tier, Lv 85-99)
  {id:'celestial_warrior',name:'Celestial Warrior',icon:'üëº',zone:'realm',levelReq:85,hp:1000,maxHp:1000,atk:135,def:55,xp:750,drops:[
    {item:'dragon_ore',qty:2,chance:0.45},{item:'dragon_bar',qty:1,chance:0.3},{item:'dragon_helmet',qty:1,chance:0.03},
    {item:'infusion_crystal',qty:1,chance:0.005}, // 0.5% ultra-rare
    {gold:[280,520]}
  ]},
  {id:'void_knight',name:'Void Knight',icon:'üõ°Ô∏è',zone:'realm',levelReq:88,hp:1150,maxHp:1150,atk:145,def:62,xp:850,drops:[
    {item:'dragon_bar',qty:2,chance:0.4},{item:'dragon_sword',qty:1,chance:0.05},{item:'dragon_body',qty:1,chance:0.04},
    {item:'infusion_crystal',qty:1,chance:0.0075}, // 0.75% ultra-rare
    {gold:[320,580]}
  ]},
  {id:'ancient_dragon',name:'Ancient Dragon',icon:'üê≤',zone:'realm',levelReq:91,hp:1300,maxHp:1300,atk:158,def:68,xp:980,drops:[
    {item:'dragon_ore',qty:4,chance:0.7},{item:'dragon_bar',qty:3,chance:0.5},{item:'dragon_shield',qty:1,chance:0.06},{item:'dragon_body',qty:1,chance:0.05},
    {item:'infusion_crystal',qty:1,chance:0.01}, // 1% ultra-rare
    {gold:[380,680]}
  ]},
  {id:'eternal_dragon',name:'Eternal Dragon',icon:'üêâ',zone:'realm',levelReq:95,hp:1500,maxHp:1500,atk:175,def:75,xp:1200,drops:[
    {item:'dragon_bar',qty:4,chance:0.7},{item:'dragon_sword',qty:1,chance:0.08},{item:'dragon_body',qty:1,chance:0.07},{item:'dragon_legs',qty:1,chance:0.06},
    {item:'infusion_crystal',qty:1,chance:0.015}, // 1.5% ultra-rare
    {gold:[450,800]}
  ]},
];


// ============================================================
// CONTRACTS
// ============================================================
const CONTRACT_TEMPLATES=[
  // Gathering contracts
  {id:'wood_basic',tier:'Basic',icon:'ü™µ',skill:'woodcutting',minLv:1,requirements:[{item:'normal_log',qty:25}],rewards:{gold:100,xp:50}},
  {id:'wood_oak',tier:'Common',icon:'üå≥',skill:'woodcutting',minLv:15,requirements:[{item:'oak_log',qty:20}],rewards:{gold:300,xp:150}},
  {id:'wood_willow',tier:'Uncommon',icon:'üåø',skill:'woodcutting',minLv:30,requirements:[{item:'willow_log',qty:15}],rewards:{gold:600,items:[{id:'bronze_sword',qty:1}],xp:300}},
  {id:'wood_maple',tier:'Rare',icon:'üçÅ',skill:'woodcutting',minLv:45,requirements:[{item:'maple_log',qty:12}],rewards:{gold:1200,items:[{id:'steel_sword',qty:1}],xp:500}},
  {id:'wood_yew',tier:'Epic',icon:'üå≤',skill:'woodcutting',minLv:65,requirements:[{item:'yew_log',qty:10}],rewards:{gold:2400,items:[{id:'mithril_bar',qty:5}],xp:800}},
  
  {id:'ore_basic',tier:'Basic',icon:'‚õ∞Ô∏è',skill:'mining',minLv:1,requirements:[{item:'copper_ore',qty:20},{item:'tin_ore',qty:20}],rewards:{gold:120,xp:50}},
  {id:'ore_iron',tier:'Common',icon:'‚öôÔ∏è',skill:'mining',minLv:15,requirements:[{item:'iron_ore',qty:25}],rewards:{gold:350,xp:150}},
  {id:'ore_coal',tier:'Uncommon',icon:'ü™®',skill:'mining',minLv:30,requirements:[{item:'coal',qty:20}],rewards:{gold:700,items:[{id:'bronze_helmet',qty:1}],xp:300}},
  {id:'ore_mithril',tier:'Rare',icon:'üíé',skill:'mining',minLv:45,requirements:[{item:'mithril_ore',qty:15}],rewards:{gold:1400,items:[{id:'steel_helmet',qty:1}],xp:500}},
  {id:'ore_adamant',tier:'Epic',icon:'üî∞',skill:'mining',minLv:60,requirements:[{item:'adamant_ore',qty:12}],rewards:{gold:2800,items:[{id:'adamant_bar',qty:3}],xp:800}},
  
  {id:'fish_basic',tier:'Basic',icon:'üé£',skill:'fishing',minLv:1,requirements:[{item:'raw_shrimp',qty:30}],rewards:{gold:90,xp:50}},
  {id:'fish_trout',tier:'Common',icon:'üêü',skill:'fishing',minLv:15,requirements:[{item:'raw_trout',qty:25}],rewards:{gold:280,xp:150}},
  {id:'fish_lobster',tier:'Uncommon',icon:'ü¶û',skill:'fishing',minLv:30,requirements:[{item:'raw_lobster',qty:18}],rewards:{gold:650,items:[{id:'bronze_body',qty:1}],xp:300}},
  {id:'fish_swordfish',tier:'Rare',icon:'üó°Ô∏è',skill:'fishing',minLv:55,requirements:[{item:'raw_swordfish',qty:15}],rewards:{gold:1300,items:[{id:'steel_body',qty:1}],xp:500}},
  {id:'fish_shark',tier:'Epic',icon:'ü¶à',skill:'fishing',minLv:75,requirements:[{item:'raw_shark',qty:10}],rewards:{gold:2600,items:[{id:'mithril_helmet',qty:1}],xp:800}},
  
  // Production contracts
  {id:'fire_basic',tier:'Basic',icon:'üî•',skill:'firemaking',minLv:1,requirements:[{item:'normal_log',qty:30}],rewards:{gold:140,xp:60}},
  {id:'fire_willow',tier:'Uncommon',icon:'üî•',skill:'firemaking',minLv:30,requirements:[{item:'willow_log',qty:20}],rewards:{gold:700,xp:320}},
  {id:'fire_yew',tier:'Rare',icon:'üî•',skill:'firemaking',minLv:65,requirements:[{item:'yew_log',qty:12}],rewards:{gold:1600,items:[{id:'mithril_bar',qty:3}],xp:600}},
  
  {id:'smith_bronze',tier:'Common',icon:'üî®',skill:'smithing',minLv:10,requirements:[{item:'bronze_bar',qty:15}],rewards:{gold:400,xp:180}},
  {id:'smith_iron',tier:'Uncommon',icon:'‚öíÔ∏è',skill:'smithing',minLv:25,requirements:[{item:'iron_bar',qty:12}],rewards:{gold:800,items:[{id:'bronze_shield',qty:1}],xp:350}},
  {id:'smith_steel',tier:'Rare',icon:'üõ†Ô∏è',skill:'smithing',minLv:40,requirements:[{item:'steel_bar',qty:10}],rewards:{gold:1600,items:[{id:'steel_shield',qty:1}],xp:550}},
  {id:'smith_mithril',tier:'Epic',icon:'‚öîÔ∏è',skill:'smithing',minLv:55,requirements:[{item:'mithril_bar',qty:8}],rewards:{gold:3200,items:[{id:'mithril_sword',qty:1}],xp:850}},
  
  {id:'cook_basic',tier:'Basic',icon:'üç≥',skill:'cooking',minLv:5,requirements:[{item:'cooked_shrimp',qty:20}],rewards:{gold:150,xp:60}},
  {id:'cook_lobster',tier:'Uncommon',icon:'ü¶û',skill:'cooking',minLv:30,requirements:[{item:'cooked_lobster',qty:12}],rewards:{gold:700,items:[{id:'cooked_shark',qty:3}],xp:320}},
  {id:'cook_shark',tier:'Rare',icon:'ü¶à',skill:'cooking',minLv:50,requirements:[{item:'cooked_shark',qty:8}],rewards:{gold:1500,items:[{id:'cooked_manta',qty:2}],xp:600}},
  
  // Combat contracts
  {id:'combat_bones',tier:'Common',icon:'ü¶¥',skill:'combat',minLv:10,requirements:[{item:'bones',qty:50}],rewards:{gold:400,xp:200}},
  {id:'combat_goblins',tier:'Uncommon',icon:'üë∫',skill:'combat',minLv:20,requirements:[{item:'bronze_sword',qty:3}],rewards:{gold:800,items:[{id:'iron_sword',qty:1}],xp:400}},
  {id:'combat_equipment',tier:'Rare',icon:'‚öîÔ∏è',skill:'combat',minLv:40,requirements:[{item:'steel_bar',qty:10},{item:'mithril_bar',qty:5}],rewards:{gold:2000,items:[{id:'adamant_shield',qty:1}],xp:700}},
];

// ============================================================
// GENERAL STORE
// ============================================================
const STORE_ITEMS=[
  // Food (2x value = convenience tax)
  {id:'cooked_shrimp',category:'food',price:40,stock:'unlimited'},
  {id:'cooked_trout',category:'food',price:120,stock:'unlimited'},
  {id:'cooked_salmon',category:'food',price:240,stock:'unlimited'},
  {id:'cooked_tuna',category:'food',price:360,stock:'unlimited'},
  {id:'cooked_lobster',category:'food',price:500,stock:'unlimited'},
  {id:'cooked_bass',category:'food',price:700,stock:'unlimited'},
  {id:'cooked_swordfish',category:'food',price:1000,stock:'unlimited'},
  {id:'cooked_monkfish',category:'food',price:1400,stock:'unlimited'},
  {id:'cooked_shark',category:'food',price:2000,stock:'unlimited'},
  {id:'cooked_manta',category:'food',price:2800,stock:'unlimited'},
  {id:'cooked_turtle',category:'food',price:4000,stock:'unlimited'},
  
  // Bars (3x value = skip smelting)
  {id:'bronze_bar',category:'bars',price:120,stock:'unlimited'},
  {id:'iron_bar',category:'bars',price:240,stock:'unlimited'},
  {id:'silver_bar',category:'bars',price:360,stock:'unlimited'},
  {id:'steel_bar',category:'bars',price:450,stock:'unlimited'},
  {id:'mithril_bar',category:'bars',price:900,stock:'unlimited'},
  {id:'adamant_bar',category:'bars',price:1800,stock:'unlimited'},
  {id:'rune_bar',category:'bars',price:3600,stock:'unlimited'},
  {id:'dragon_bar',category:'bars',price:7500,stock:'unlimited'},
  
  // Basic Gear (starter equipment)
  {id:'bronze_sword',category:'gear',price:200,stock:'unlimited'},
  {id:'bronze_helmet',category:'gear',price:150,stock:'unlimited'},
  {id:'bronze_body',category:'gear',price:250,stock:'unlimited'},
  {id:'bronze_legs',category:'gear',price:200,stock:'unlimited'},
  {id:'bronze_gloves',category:'gear',price:120,stock:'unlimited'},
  {id:'bronze_boots',category:'gear',price:150,stock:'unlimited'},
  {id:'bronze_shield',category:'gear',price:180,stock:'unlimited'},
  {id:'iron_sword',category:'gear',price:500,stock:'unlimited'},
  {id:'iron_helmet',category:'gear',price:400,stock:'unlimited'},
  {id:'iron_body',category:'gear',price:600,stock:'unlimited'},
  {id:'iron_legs',category:'gear',price:500,stock:'unlimited'},
  {id:'iron_gloves',category:'gear',price:300,stock:'unlimited'},
  {id:'iron_boots',category:'gear',price:400,stock:'unlimited'},
  {id:'iron_shield',category:'gear',price:450,stock:'unlimited'},
];

// ============================================================
// MASTERY UPGRADES
// ============================================================
const MASTERY_UPGRADES={
  woodcutting:[
    {id:'wc_yield',name:'Efficient Chopping',desc:'Gain more resources when woodcutting',effect:'+10% wood yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% wood yield`},
    {id:'wc_speed',name:'Swift Axe',desc:'Chop trees faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'wc_xp',name:'Lumberjack Knowledge',desc:'Gain more XP from woodcutting',effect:'+15% woodcutting XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% woodcutting XP`},
    {id:'wc_mastery',name:'Master Forester',desc:'Gain more mastery when cutting',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  mining:[
    {id:'mn_yield',name:'Keen Eye',desc:'Find more ore per strike',effect:'+10% ore yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% ore yield`},
    {id:'mn_speed',name:'Pickaxe Mastery',desc:'Mine rocks faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'mn_xp',name:'Geological Insight',desc:'Gain more mining XP',effect:'+15% mining XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% mining XP`},
    {id:'mn_mastery',name:'Master Miner',desc:'Gain more mastery when mining',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  fishing:[
    {id:'fh_yield',name:'Lucky Line',desc:'Catch more fish',effect:'+10% fish yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% fish yield`},
    {id:'fh_speed',name:'Nimble Hands',desc:'Fish faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'fh_xp',name:'Angler Expertise',desc:'Gain more fishing XP',effect:'+15% fishing XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% fishing XP`},
    {id:'fh_mastery',name:'Master Angler',desc:'Gain more mastery when fishing',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  firemaking:[
    {id:'fm_xp',name:'Pyromaniac',desc:'Gain more firemaking XP',effect:'+15% firemaking XP',cost:150,maxPurchases:3,stackEffect:(n)=>`+${n*15}% firemaking XP`},
    {id:'fm_speed',name:'Quick Kindle',desc:'Light fires faster',effect:'-5% action time',cost:180,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'fm_mastery',name:'Fire Master',desc:'Gain more mastery from fires',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  smithing:[
    {id:'sm_yield',name:'Precise Smithing',desc:'Sometimes create bonus bars',effect:'+10% bar yield',cost:120,maxPurchases:5,stackEffect:(n)=>`+${n*10}% bar yield`},
    {id:'sm_speed',name:'Forge Efficiency',desc:'Smith faster',effect:'-5% action time',cost:180,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'sm_xp',name:'Metallurgy Mastery',desc:'Gain more smithing XP',effect:'+15% smithing XP',cost:220,maxPurchases:3,stackEffect:(n)=>`+${n*15}% smithing XP`},
    {id:'sm_mastery',name:'Master Smith',desc:'Gain more mastery when smithing',effect:'+20% mastery gain',cost:280,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  cooking:[
    {id:'ck_success',name:'Careful Cooking',desc:'Reduce burn chance',effect:'-5% burn chance',cost:100,maxPurchases:5,stackEffect:(n)=>`-${n*5}% burn chance`},
    {id:'ck_speed',name:'Fast Fire',desc:'Cook food faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'ck_xp',name:'Culinary Arts',desc:'Gain more cooking XP',effect:'+15% cooking XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% cooking XP`},
    {id:'ck_mastery',name:'Master Chef',desc:'Gain more mastery when cooking',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  combat:[
    {id:'cb_damage',name:'Combat Prowess',desc:'Deal more damage in combat',effect:'+5% damage',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*5}% damage`},
    {id:'cb_defense',name:'Defensive Stance',desc:'Take less damage',effect:'+3% damage reduction',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*3}% damage reduction`},
    {id:'cb_xp',name:'Battle Experience',desc:'Gain more combat XP',effect:'+12% combat XP',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*12}% combat XP`},
    {id:'cb_drops',name:'Lucky Looter',desc:'Better drop rates',effect:'+8% drop chance',cost:300,maxPurchases:3,stackEffect:(n)=>`+${n*8}% drop chance`},
  ],
};

// ============================================================
// GAME STATE
// ============================================================
const GAME_VERSION = 2; // Increment when making breaking changes

let G = {
  version: GAME_VERSION,
  skills:{
    woodcutting:{xp:0,masteryXp:{}},
    mining:{xp:0,masteryXp:{}},
    fishing:{xp:0,masteryXp:{}},
    firemaking:{xp:0,masteryXp:{}},
    smithing:{xp:0,masteryXp:{}},
    cooking:{xp:0,masteryXp:{}},
    combat:{xp:0,masteryXp:{}},
    // Combat sub-skills
    attack:{xp:0,masteryXp:{}},        // ‚Üí Crit chance
    strength:{xp:0,masteryXp:{}},      // ‚Üí Power (bonus damage)
    haste:{xp:0,masteryXp:{}},         // ‚Üí Attack speed
    defense:{xp:0,masteryXp:{}},       // ‚Üí Armor + Block
    hitpoints:{xp:XP_TABLE[9],masteryXp:{}}, // starts at level 10
  },
  bank:{},
  bankOrder:[], // Custom ordering of bank items: [itemId1, itemId2, ...]
  gold:0,
  equipment:{weapon:null,helmet:null,body:null,legs:null,shield:null,gloves:null,boots:null,trinket:null},
  infusion:{}, // Track infusion levels: {slot: level} e.g. {weapon: 5, helmet: 3}
  combat:{
    active:false,
    monsterId:'goblin',
    playerHp:10,
    maxHp:10,
    monsterHp:0,
    maxMonsterHp:0,
    tickCounter:0,
    log:[],
  },
  selectedZone:'forest', // Currently selected combat zone
  activeActions:{},
  actionProgress:{},
  sessionCounts:{}, // Track items produced in current session: {actionId: count}
  lastSave:Date.now(),
  offlineBanner:null,
  contracts:[],
  contractsLastRefresh:0,
  masteryUpgrades:{}, // Track purchased upgrades: {skillName_upgradeId: count}
};

// ============================================================
// GAME LOGIC
// ============================================================
function getPlayerStats(){
  // Defensive: ensure combat skills exist (in case called during migration)
  if(!G.skills.attack)G.skills.attack={xp:0,masteryXp:{}};
  if(!G.skills.strength)G.skills.strength={xp:0,masteryXp:{}};
  if(!G.skills.haste)G.skills.haste={xp:0,masteryXp:{}};
  if(!G.skills.defense)G.skills.defense={xp:0,masteryXp:{}};
  if(!G.skills.hitpoints)G.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}};
  
  let atkLv=xpToLevel(G.skills.attack.xp);
  let strLv=xpToLevel(G.skills.strength.xp);
  let hasteLv=xpToLevel(G.skills.haste.xp);
  let defLv=xpToLevel(G.skills.defense.xp);
  const hpLv=xpToLevel(G.skills.hitpoints.xp);
  
  // Apply infusion bonuses to base levels BEFORE calculating derived stats
  // This ensures Attack ‚Üí Crit, Haste ‚Üí Speed, Defense ‚Üí Block all work correctly
  
  // weapon: atk, str
  if(G.infusion.weapon){
    const bonus=G.infusion.weapon*0.01;
    atkLv=Math.floor(atkLv*(1+bonus));
    strLv=Math.floor(strLv*(1+bonus));
  }
  // helmet, body, legs: atk, str, def
  ['helmet','body','legs'].forEach(slot=>{
    if(G.infusion[slot]){
      const bonus=G.infusion[slot]*0.01;
      atkLv=Math.floor(atkLv*(1+bonus));
      strLv=Math.floor(strLv*(1+bonus));
      defLv=Math.floor(defLv*(1+bonus));
    }
  });
  // boots: haste, def
  if(G.infusion.boots){
    const bonus=G.infusion.boots*0.01;
    hasteLv=Math.floor(hasteLv*(1+bonus));
    defLv=Math.floor(defLv*(1+bonus));
  }
  // shield: def, hp (hp handled separately below)
  if(G.infusion.shield){
    const bonus=G.infusion.shield*0.01;
    defLv=Math.floor(defLv*(1+bonus));
  }
  
  // Combat level = avg of 5 sub-skills (using base levels, not infused)
  const combatLevel=Math.max(1,Math.floor((xpToLevel(G.skills.attack.xp)+xpToLevel(G.skills.strength.xp)+xpToLevel(G.skills.haste.xp)+xpToLevel(G.skills.defense.xp)+hpLv)/5));

  // NOW calculate derived stats using infused levels
  // Crit chance: 5% base + 0.4% per Attack level (cap 50%)
  const critChance=Math.min(50, 5 + Math.floor(atkLv*0.4));
  // Power: flat bonus damage from Strength level
  const power=Math.floor(strLv*0.6);
  // Attack interval in ticks: base 4, -1 per 33 haste levels (min 2)
  const attackTicks=Math.max(2, 4 - Math.floor(hasteLv/33));
  const attackSpeed=(attackTicks*0.6).toFixed(1)+'s';
  // Armor: defense level + equipment
  let armor=Math.floor(defLv*0.5);
  // Block chance: 2% + 0.2% per defense level (cap 30%)
  const blockChance=Math.min(30, 2 + Math.floor(defLv*0.2));
  // Max HP from hitpoints level
  let maxHp=10 + hpLv*6;

  // Equipment bonuses (atk = overall hit bonus, def = armor)
  let eqAtk=1; let eqDef=0;
  const eq=G.equipment;
  if(eq.weapon&&ITEMS[eq.weapon]){eqAtk+=ITEMS[eq.weapon].atk||0;}
  if(eq.helmet&&ITEMS[eq.helmet]){eqDef+=ITEMS[eq.helmet].def||0; armor+=ITEMS[eq.helmet].def||0;}
  if(eq.body&&ITEMS[eq.body]){eqDef+=ITEMS[eq.body].def||0; armor+=ITEMS[eq.body].def||0;}
  if(eq.legs&&ITEMS[eq.legs]){eqDef+=ITEMS[eq.legs].def||0; armor+=ITEMS[eq.legs].def||0;}
  if(eq.gloves&&ITEMS[eq.gloves]){eqDef+=ITEMS[eq.gloves].def||0; armor+=ITEMS[eq.gloves].def||0;}
  if(eq.boots&&ITEMS[eq.boots]){eqDef+=ITEMS[eq.boots].def||0; armor+=ITEMS[eq.boots].def||0;}
  if(eq.shield&&ITEMS[eq.shield]){eqDef+=ITEMS[eq.shield].def||0; armor+=ITEMS[eq.shield].def||0;}

  // Overall atk/def for combat (uses infused levels)
  let atk=eqAtk+Math.floor(atkLv*0.5)+Math.floor(strLv*0.3);
  let def=armor;
  
  // Apply HP infusion bonuses (gloves, shield)
  if(G.infusion.gloves){
    const bonus=G.infusion.gloves*0.01;
    maxHp=Math.floor(maxHp*(1+bonus));
  }
  if(G.infusion.shield){
    const bonus=G.infusion.shield*0.01;
    maxHp=Math.floor(maxHp*(1+bonus));
  }
  
  // Brawler's Trinket bonus (10% to all combat stats)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  if(trinket&&trinket.skill==='combat'){
    atk=Math.floor(atk*1.1);
    armor=Math.floor(armor*1.1);
    def=armor;
  }

  // Return both infused levels (for display) and base levels (for requirements)
  return{atk,def,maxHp,combatLevel,critChance,power,attackTicks,attackSpeed,armor,blockChance,
         atkLv,strLv,hasteLv,defLv,hpLv,eqAtk,eqDef,
         baseAtkLv:xpToLevel(G.skills.attack.xp),
         baseStrLv:xpToLevel(G.skills.strength.xp),
         baseDefLv:xpToLevel(G.skills.defense.xp)};
}

function getMasteryLevel(skill,actionId){return xpToLevel(G.skills[skill].masteryXp[actionId]||0);}
function getMasteryXp(skill,actionId){return G.skills[skill].masteryXp[actionId]||0;}

function addToBank(itemId,qty){
  G.bank[itemId]=(G.bank[itemId]||0)+qty;
  updateBankQuantityDisplays();
}

function updateBankQuantityDisplays(){
  // Update all bank quantity displays on current page without full re-render
  if(!currentPage)return;
  
  // Update action card quantities
  document.querySelectorAll('[data-item-id]').forEach(el=>{
    const itemId=el.getAttribute('data-item-id');
    if(itemId&&G.bank[itemId]!==undefined){
      el.textContent=`(${fmt(G.bank[itemId]||0)})`;
    }
  });
  
  // Update ingredient quantities and availability
  document.querySelectorAll('[data-ingredient-id]').forEach(el=>{
    const itemId=el.getAttribute('data-ingredient-id');
    if(itemId){
      el.textContent=`(${G.bank[itemId]||0})`;
      // Update parent ingredient span's ok/missing class
      const parentSpan=el.closest('.ingredient');
      if(parentSpan){
        // Extract required quantity from the span text
        const match=parentSpan.textContent.match(/(\d+)x/);
        if(match){
          const requiredQty=parseInt(match[1]);
          const hasEnough=(G.bank[itemId]||0)>=requiredQty;
          parentSpan.classList.toggle('ok',hasEnough);
          parentSpan.classList.toggle('missing',!hasEnough);
        }
      }
    }
  });
}
function removeFromBank(itemId,qty){
  if(!G.bank[itemId]||G.bank[itemId]<qty)return false;
  G.bank[itemId]-=qty;
  if(G.bank[itemId]<=0)delete G.bank[itemId];
  updateBankQuantityDisplays();
  return true;
}
function hasMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    if((G.bank[k]||0)<v)return false;
  }
  return true;
}
function consumeMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    removeFromBank(k,v);
  }
}
function getCraftableCount(consumes){
  if(!consumes||Object.keys(consumes).length===0)return 0;
  let minCount=Infinity;
  for(const[itemId,qtyNeeded] of Object.entries(consumes)){
    const available=G.bank[itemId]||0;
    const canMake=Math.floor(available/qtyNeeded);
    minCount=Math.min(minCount,canMake);
  }
  return minCount===Infinity?0:minCount;
}

function stopAllActions(){
  // Stop all skill actions
  for(const skill of Object.keys(G.activeActions)){
    delete G.activeActions[skill];
    delete G.actionProgress[skill];
  }
  // Stop smithing craft
  smithingCraftAction=null;
  smithingCraftProgress=0;
  // Stop combat
  if(G.combat.active){
    G.combat.active=false;
  }
  // Update UI
  updateActiveActionDisplay();
}

function startAction(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq)return;
  stopAllActions(); // Stop everything else
  G.activeActions[skill]=actionId;
  G.actionProgress[skill]=0;
  G.sessionCounts[actionId]=0; // Reset session count
  updateActiveActionDisplay();
  renderSkillPage(skill);
  renderSidebar();
}
function stopAction(skill){
  delete G.activeActions[skill];
  delete G.actionProgress[skill];
  updateActiveActionDisplay();
  renderSkillPage(skill);
}

function startCombatAction(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0)G.combat.playerHp=Math.floor(stats.maxHp/2);
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;
  // No level requirement - fight any monster!
  stopAllActions(); // Stop everything else
  G.combat.active=true;
  G.combat.monsterHp=monster.maxHp;
  G.combat.maxMonsterHp=monster.maxHp;
  G.combat.tickCounter=0;
  addCombatLog('‚öîÔ∏è Engaging '+monster.name+'...','clog-p');
  updateActiveActionDisplay();
  renderCombatPage();
}
function stopCombat(){
  G.combat.active=false;
  updateActiveActionDisplay();
  renderCombatPage();
}

function eatFood(itemId){
  // Check if food exists
  if(!ITEMS[itemId]||ITEMS[itemId].cat!=='food'){
    notify('Not a valid food item!','info');
    return;
  }
  // Check if player has it
  if(!G.bank[itemId]||G.bank[itemId]<=0){
    notify('You don\'t have any '+ITEMS[itemId].name+'!','info');
    return;
  }
  // Get current stats
  const stats=getPlayerStats();
  const healAmount=ITEMS[itemId].heals||0;
  const oldHp=G.combat.playerHp;
  
  // Restore HP (capped at max)
  G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+healAmount);
  const actualHeal=G.combat.playerHp-oldHp;
  
  // Remove food from bank
  removeFromBank(itemId,1);
  
  // Show notification and log
  notify(`Ate ${ITEMS[itemId].icon} ${ITEMS[itemId].name} (+${actualHeal} HP)`,'lvl');
  if(G.combat.active){
    addCombatLog(`‚ù§Ô∏è You ate ${ITEMS[itemId].name} and restored ${actualHeal} HP!`,'clog-heal');
  }
  
  // Update UI
  renderCombatPage();
  updateHeader();
}

function addCombatLog(msg,cls='clog-p'){
  G.combat.log.unshift({msg,cls});
  if(G.combat.log.length>40)G.combat.log.pop();
  const el=document.getElementById('combat-log');
  if(el){
    el.innerHTML=G.combat.log.map(l=>`<p class="${l.cls}">${l.msg}</p>`).join('');
  }
}

function processCombatTick(){
  if(!G.combat.active)return;
  G.combat.tickCounter++;

  const stats=getPlayerStats();
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
  const hasCombatTrinket=equippedTrinket&&equippedTrinket.skill==='combat';

  // Passive haste XP each tick
  gainCombatSubXp('haste', 1);

  // Attack check: every attackTicks ticks
  if(G.combat.tickCounter % stats.attackTicks !== 0) return;

  // Determine if this hit crits
  const isCrit = Math.random() * 100 < stats.critChance;
  // Base damage: atk - monster.def + random variance
  let playerDmg = Math.max(1, stats.atk - Math.floor(monster.def/2) + Math.floor(Math.random()*4) - 1 + stats.power);
  if(isCrit) playerDmg = Math.floor(playerDmg * 1.5);
  
  // Apply combat damage bonus from mastery
  const dmgBonus=1+(getMasteryBonus('combat','damage')/100);
  playerDmg=Math.floor(playerDmg*dmgBonus);

  G.combat.monsterHp=Math.max(0,G.combat.monsterHp-playerDmg);
  if(isCrit){
    addCombatLog(`üí• CRIT! You strike ${monster.name} for ${playerDmg} damage!`,'clog-kill');
  } else {
    addCombatLog(`‚öîÔ∏è You hit ${monster.name} for ${playerDmg} damage.`,'clog-hit');
  }

  // XP for hitting (with combat XP bonus)
  let xpBonus=1+(getMasteryBonus('combat','xp')/100);
  if(hasCombatTrinket){
    xpBonus*=1.1; // 10% XP bonus
  }
  gainCombatSubXp('attack', Math.floor((4 + Math.floor(monster.xp * 0.15))*xpBonus));
  gainCombatSubXp('strength', Math.floor((Math.max(1, Math.floor(playerDmg * 0.5) + 2))*xpBonus));

  if(G.combat.monsterHp<=0){
    // On kill: bonus xp to all combat skills + old combat skill
    const killXp = monster.xp;
    gainCombatSubXp('attack', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('strength', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('haste', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('defense', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor(killXp*0.15*xpBonus));
    if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}}; // Safety check
    const prevCombatLv=xpToLevel(G.skills.combat.xp);
    G.skills.combat.xp += Math.floor(killXp*xpBonus);
    const newCombatLv=xpToLevel(G.skills.combat.xp);
    if(newCombatLv>prevCombatLv)checkCombatLvlUp('combat');
    addCombatLog(`‚ò†Ô∏è ${monster.name} defeated! Combat +${Math.floor(killXp*xpBonus)} XP`,'clog-kill');
    // Loot (with drop bonus from mastery and trinket)
    const dropBonus=getMasteryBonus('combat','drops')/100;
    const trinketBonus=hasCombatTrinket?0.1:0; // 10% loot boost
    let lootText=[];
    for(const drop of monster.drops){
      if(drop.gold){
        let gAmt=drop.gold[0]+Math.floor(Math.random()*(drop.gold[1]-drop.gold[0]+1));
        // Apply trinket bonus to gold
        if(trinketBonus>0)gAmt=Math.floor(gAmt*(1+trinketBonus));
        G.gold+=gAmt;lootText.push(`${gAmt}gp`);
      } else {
        const dropChance=Math.min(1,drop.chance+dropBonus+trinketBonus);
        if(Math.random()<dropChance){
          addToBank(drop.item,drop.qty);
          lootText.push(`${drop.qty}x ${ITEMS[drop.item].name}`);
        }
      }
    }
    // Brawler's Trinket drop chance (only if player doesn't have it in bank or equipped)
    const hasBrawlersTrinket=G.bank['brawlers_trinket']||(G.equipment.trinket==='brawlers_trinket');
    if(!hasBrawlersTrinket){
      const atkLv=xpToLevel(G.skills.attack.xp);
      const strLv=xpToLevel(G.skills.strength.xp);
      const hasteLv=xpToLevel(G.skills.haste.xp);
      const defLv=xpToLevel(G.skills.defense.xp);
      const hpLv=xpToLevel(G.skills.hitpoints.xp);
      const combatLv=Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5);
      const dropChance=0.001+(combatLv*0.0001);
      if(Math.random()<dropChance){
        addToBank('brawlers_trinket',1);
        notify(`‚ú® ${ITEMS['brawlers_trinket'].name} found!`,'item');
      }
    }
    if(lootText.length)addCombatLog('üí∞ Loot: '+lootText.join(', '),'clog-loot');
    
    // Heal to full HP on kill
    const healAmount=stats.maxHp-G.combat.playerHp;
    if(healAmount>0){
      G.combat.playerHp=stats.maxHp;
      addCombatLog(`üíö Healed to full HP (+${healAmount} HP)`,'clog-heal');
    }
    
    G.combat.monsterHp=monster.maxHp;
    G.combat.maxMonsterHp=monster.maxHp;
    return;
  }

  // Monster attacks player
  // Block check
  const blocked = Math.random()*100 < stats.blockChance;
  let monsterDmg = Math.max(0, monster.atk - Math.floor(stats.armor/3) + Math.floor(Math.random()*3) - 1);
  
  // Apply damage reduction from mastery
  const dmgReduction=1-(getMasteryBonus('combat','defense')/100);
  monsterDmg=Math.floor(monsterDmg*dmgReduction);
  
  if(blocked){ monsterDmg=0; addCombatLog(`üõ°Ô∏è You block ${monster.name}'s attack!`,'clog-p'); }
  else {
    G.combat.playerHp=Math.max(0,G.combat.playerHp-monsterDmg);
    addCombatLog(`üí¢ ${monster.name} hits you for ${monsterDmg} damage.`,'clog-mhit');
  }

  // XP for being hit
  if(monsterDmg>0){
    gainCombatSubXp('defense', Math.floor((3 + Math.floor(monsterDmg*0.4))*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor((2 + Math.floor(monsterDmg*0.25))*xpBonus));
  } else if(blocked){
    gainCombatSubXp('defense', Math.floor(5*xpBonus));
  }

  // Check for death BEFORE auto-eating (prevents unkillable bug)
  if(G.combat.playerHp<=0){
    G.combat.active=false;
    G.combat.playerHp=Math.floor(stats.maxHp/2);
    addCombatLog('üíÄ You have been defeated! Respawning with half HP...','clog-die');
    notify('‚ö†Ô∏è Combat stopped - You died! Click "Start Combat" to resume.','combat');
    renderCombatHP();
    return; // Exit immediately, don't auto-eat
  }

  // Auto-eat if HP < 40% (only happens if still alive)
  if(G.combat.playerHp/stats.maxHp<0.4){
    const foods=['cooked_salmon','cooked_trout','cooked_shrimp'];
    for(const f of foods){
      if(G.bank[f]&&G.bank[f]>0){
        const heal=ITEMS[f].heals;
        removeFromBank(f,1);
        G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+heal);
        addCombatLog(`üçñ You eat ${ITEMS[f].name} and heal ${heal} HP.`,'clog-eat');
        break;
      }
    }
  }

  renderCombatHP();
}

function gainCombatSubXp(skill, amount){
  if(!G.skills[skill])return;
  const prev=xpToLevel(G.skills[skill].xp);
  G.skills[skill].xp+=amount;
  const next=xpToLevel(G.skills[skill].xp);
  if(next>prev) checkCombatLvlUp(skill);
}
function checkCombatLvlUp(skill){
  if(!G.skills[skill])return; // Safety check
  const lv=xpToLevel(G.skills[skill].xp);
  const names={attack:'Attack',strength:'Strength',haste:'Haste',defense:'Defense',hitpoints:'Hitpoints',combat:'Combat'};
  notify(`üéâ ${names[skill]||skill} Level Up! Level ${lv}`,'lvl');
  if(currentPage==='stats')renderStatsPage();
}

function processSkillTick(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq){stopAction(skill);return;}

  G.actionProgress[skill]=(G.actionProgress[skill]||0)+1;
  const ticks=getMasteryTicks(action,getMasteryLevel(skill,actionId));
  if(G.actionProgress[skill]<ticks)return;
  G.actionProgress[skill]=0;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;

  // Check materials for production
  if(action.consumes){
    if(!hasMaterials(action.consumes)){
      stopAction(skill);
      notify('Out of materials for '+action.name+'!','info');
      return;
    }
    // Check for trinket save chance (25% for production skills)
    const shouldSave=equippedTrinket&&equippedTrinket.skill===skill&&Math.random()<0.25;
    if(!shouldSave){
      consumeMaterials(action.consumes);
    }
  }

  // Gain XP (with mastery upgrade bonus and trinket bonus)
  const prevLv=xpToLevel(G.skills[skill].xp);
  let xpBonus=1+(getMasteryBonus(skill,'xp')/100);
  // Apply trinket XP bonus (10%)
  if(equippedTrinket&&equippedTrinket.skill===skill){
    xpBonus*=1.1; // 10% XP bonus
  }
  G.skills[skill].xp+=Math.floor(action.xp*xpBonus);
  const newLv=xpToLevel(G.skills[skill].xp);
  if(newLv>prevLv)notify(`üéâ ${skill.charAt(0).toUpperCase()+skill.slice(1)} Level Up! Level ${newLv}`,'lvl');

  // Gain mastery XP (with mastery upgrade bonus)
  if(action.masteryXp){
    const prevMlv=getMasteryLevel(skill,actionId);
    const mastBonus=1+(getMasteryBonus(skill,'mastery')/100);
    G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+Math.floor(action.masteryXp*mastBonus);
    const newMlv=getMasteryLevel(skill,actionId);
    if(newMlv>prevMlv)notify(`‚≠ê ${action.name} Mastery ${newMlv}!`,'lvl');
  }

  // Produce item (with yield bonus)
  if(action.produces){
    let produced=action.produces;
    let qty=action.qty||1;
    // Burn chance for cooking (reduced by mastery upgrade)
    if(action.burnChance){
      const skillLv=xpToLevel(G.skills[skill].xp);
      const mastLv=getMasteryLevel(skill,actionId);
      const burnReduction=getMasteryBonus(skill,'success');
      const burnChance=Math.max(0,action.burnChance-(skillLv*0.005)-(mastLv*0.003)-(burnReduction/100));
      if(Math.random()<burnChance){produced=action.burnItem;qty=1;}
    }
    // Apply yield bonus
    const yieldBonus=1+(getMasteryBonus(skill,'yield')/100);
    // Apply trinket bonus (2x for gathering skills)
    if(equippedTrinket&&equippedTrinket.skill===skill){
      qty=Math.floor(qty*yieldBonus*2); // 2x with trinket
    }else{
      qty=Math.floor(qty*yieldBonus);
    }
    if(qty<1)qty=1;
    addToBank(produced,qty);
    // Increment session count
    G.sessionCounts[actionId]=(G.sessionCounts[actionId]||0)+qty;
  }
  
  // Trinket drop chance (scales with level: 0.1% + 0.01% per level)
  const trinketMap={woodcutting:'woodcutters_trinket',mining:'miners_trinket',fishing:'fishermans_trinket',firemaking:'firemakers_trinket',smithing:'smiths_trinket',cooking:'chefs_trinket'};
  const skillTrinketId=trinketMap[skill];
  if(skillTrinketId){
    const hasTrinket=G.bank[skillTrinketId]||(G.equipment.trinket===skillTrinketId);
    if(!hasTrinket){
      const dropChance=0.001+(lv*0.0001); // 0.1% base + 0.01% per level
      if(Math.random()<dropChance){
        addToBank(skillTrinketId,1);
        notify(`‚ú® ${ITEMS[skillTrinketId].name} found!`,'item');
      }
    }
  }
}

function getMasteryTicks(action,mastLv){
  const reduction=Math.floor(mastLv/15);
  // Apply speed bonus from mastery upgrades
  const skill=action.skill||'woodcutting'; // Fallback, should always have skill
  const speedBonus=getMasteryBonus(skill,'speed');
  const speedMult=1-(speedBonus/100);
  const baseTicks=Math.max(2,action.ticks-reduction);
  return Math.max(2,Math.floor(baseTicks*speedMult));
}

// ============================================================
// MAIN GAME LOOP (600ms tick)
// ============================================================
let tickCount=0;
setInterval(()=>{
  tickCount++;
  // Process skill actions
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue; // Skip - handled separately below
    processSkillTick(skill,actionId);
  }
  // Process smithing crafts
  if(G.activeActions['smithingCraft']){
    processCraftTick(G.activeActions['smithingCraft']);
  }
  // Process combat
  if(G.combat.active)processCombatTick();
  // Update HP regen (out of combat: 1 HP per 10 ticks)
  if(!G.combat.active){
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp<stats.maxHp&&tickCount%10===0){
      G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+1);
    }
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  }
  // Render updates
  updateProgressBars();
  updateHeader();
  updateActiveActionDisplay();
  updateSessionCounts(); // Update live session counts
  updateCraftableCounts(); // Update "Can make" counts
  if(getCurrentPage()==='combat')renderCombatHP();
  if(getCurrentPage()==='bank')renderBank();
  if(getCurrentPage()==='equipment'){renderEquipPage();}
  if(getCurrentPage()==='stats')renderStatsPage();
  // Auto-save every 30 ticks (~18s)
  if(tickCount%30===0)saveGame();
},600);

function updateSessionCounts(){
  // Update session count displays on skill pages
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    const count=G.sessionCounts[actionId]||0;
    const countEl=document.getElementById(`session-count-${actionId}`);
    if(countEl){
      if(count>0){
        countEl.textContent='('+fmt(count)+')';
        countEl.style.display='inline';
      }else{
        countEl.style.display='none';
      }
    }
  }
}

function updateCraftableCounts(){
  // Update "Can make" counts on skill pages
  const currentSkill=getCurrentPage();
  if(!['firemaking','cooking','smithing'].includes(currentSkill))return;
  
  const actions=currentSkill==='smithing'?[...ACTIONS.smithing,...ACTIONS.smithingCraft]:ACTIONS[currentSkill];
  if(!actions)return;
  
  for(const action of actions){
    if(!action.consumes)continue; // Skip actions that don't require materials
    
    const craftableCount=getCraftableCount(action.consumes);
    const countEl=document.getElementById(`can-make-${action.id}`);
    const statEl=document.getElementById(`can-make-stat-${action.id}`);
    
    if(countEl){
      countEl.textContent=fmt(craftableCount);
    }
    if(statEl){
      if(craftableCount>0){
        statEl.style.display='';
      }else{
        statEl.style.display='none';
      }
    }
  }
}

let smithingCraftAction=null;
let smithingCraftProgress=0;
function startCraft(actionId){
  const action=ACTIONS.smithingCraft.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills.smithing){
    G.skills.smithing={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills.smithing.xp);
  if(lv<action.levelReq){notify('Level '+action.levelReq+' Smithing required.','info');return;}
  if(!hasMaterials(action.consumes)){notify('Not enough materials!','info');return;}
  stopAllActions(); // Stop everything else
  smithingCraftAction=action;
  smithingCraftProgress=0;
  G.activeActions['smithingCraft']=actionId; // Mark as active
  G.sessionCounts[actionId]=0; // Reset session count
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function stopCraft(){
  smithingCraftAction=null;
  smithingCraftProgress=0;
  delete G.activeActions['smithingCraft'];
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function processCraftTick(id){
  if(!smithingCraftAction||smithingCraftAction.id!==id)return;
  smithingCraftProgress++;
  
  // Apply speed bonus
  const speedBonus=getMasteryBonus('smithing','speed');
  const speedMult=1-(speedBonus/100);
  const adjustedTicks=Math.max(2,Math.floor(smithingCraftAction.ticks*speedMult));
  
  if(smithingCraftProgress<adjustedTicks)return;
  smithingCraftProgress=0;
  if(!hasMaterials(smithingCraftAction.consumes)){
    stopCraft();
    notify('Out of materials!','info');
    return;
  }
  // Check for trinket save chance (25% for smithing)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  const shouldSave=trinket&&trinket.skill==='smithing'&&Math.random()<0.25;
  if(!shouldSave){
    consumeMaterials(smithingCraftAction.consumes);
  }
  const prevLv=xpToLevel(G.skills.smithing.xp);
  
  // Apply XP bonus (with trinket)
  let xpBonus=1+(getMasteryBonus('smithing','xp')/100);
  if(trinket&&trinket.skill==='smithing'){
    xpBonus*=1.1; // 10% XP bonus
  }
  G.skills.smithing.xp+=Math.floor(smithingCraftAction.xp*xpBonus);
  
  const newLv=xpToLevel(G.skills.smithing.xp);
  if(newLv>prevLv)notify(`üéâ Smithing Level Up! Level ${newLv}`,'lvl');
  
  // Apply yield bonus
  const yieldBonus=1+(getMasteryBonus('smithing','yield')/100);
  const qty=Math.max(1,Math.floor(smithingCraftAction.qty*yieldBonus));
  addToBank(smithingCraftAction.produces,qty);
  // Increment session count
  G.sessionCounts[id]=(G.sessionCounts[id]||0)+qty;
  
  // Trinket drop chance (only if player doesn't have it in bank or equipped)
  const hasSmithsTrinket=G.bank['smiths_trinket']||(G.equipment.trinket==='smiths_trinket');
  if(!hasSmithsTrinket){
    const lv=xpToLevel(G.skills.smithing.xp);
    const dropChance=0.001+(lv*0.0001);
    if(Math.random()<dropChance){
      addToBank('smiths_trinket',1);
      notify(`‚ú® ${ITEMS['smiths_trinket'].name} found!`,'item');
    }
  }
}
// Override to handle smithingCraft special case
const _origActiveActions=G.activeActions;
G.activeActions=new Proxy(_origActiveActions,{
  set(t,k,v){
    if(k==='smithingCraft'){smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===v);smithingCraftProgress=0;t[k]=v;return true;}
    return Reflect.set(t,k,v);
  },
  deleteProperty(t,k){
    if(k==='smithingCraft'){smithingCraftAction=null;smithingCraftProgress=0;}
    return Reflect.deleteProperty(t,k);
  }
});

// ============================================================
// SAVE / LOAD
// ============================================================
async function saveGame(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  // Remove non-serializable
  try{
    await window.storage.set('grindia_save',JSON.stringify(data));
  }catch(e){try{localStorage.setItem('grindia_save',JSON.stringify(data));}catch(e2){}}
}
async function loadGame(){
  try{
    let raw=null;
    try{const r=await window.storage.get('grindia_save');if(r)raw=r.value;}catch(e){}
    if(!raw)try{raw=localStorage.getItem('grindia_save');}catch(e){}
    if(!raw)return false;
    const saved=JSON.parse(raw);
    
    // VERSION MIGRATION: Handle saves from older versions
    const savedVersion = saved.version || 1;
    if(savedVersion < GAME_VERSION){
      console.log(`Migrating save from v${savedVersion} to v${GAME_VERSION}`);
      // v1 -> v2: Added attack/strength/haste/defense/hitpoints skills
      if(savedVersion < 2){
        // Initialize new combat skills if they don't exist
        if(!saved.skills.attack)saved.skills.attack={xp:0,masteryXp:{}};
        if(!saved.skills.strength)saved.skills.strength={xp:0,masteryXp:{}};
        if(!saved.skills.haste)saved.skills.haste={xp:0,masteryXp:{}};
        if(!saved.skills.defense)saved.skills.defense={xp:0,masteryXp:{}};
        if(!saved.skills.hitpoints)saved.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}}; // Start at lv 10
      }
      saved.version = GAME_VERSION;
    }
    
    // Offline progress
    const now=Date.now();
    const elapsedMs=Math.max(0,now-(saved.lastSave||now));
    const elapsedTicks=Math.min(Math.floor(elapsedMs/600),48000); // cap 8h
    // Merge saved state (don't overwrite new skills that didn't exist in old save)
    G.version = GAME_VERSION;
    if(saved.skills){
      for(const k of Object.keys(G.skills)){
        if(saved.skills[k])G.skills[k]=saved.skills[k];
      }
    }
    G.bank=saved.bank||{};
    G.gold=saved.gold||0;
    G.equipment=saved.equipment||G.equipment;
    // Ensure new equipment slots exist for old saves
    if(!G.equipment.gloves)G.equipment.gloves=null;
    if(!G.equipment.boots)G.equipment.boots=null;
    G.combat={...G.combat,...(saved.combat||{})};
    // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
    for(const k of Object.keys(G.activeActions)){
      delete G.activeActions[k];
    }
    if(saved.activeActions){
      for(const [k,v] of Object.entries(saved.activeActions)){
        G.activeActions[k]=v; // This triggers the Proxy set handler
      }
    }
    G.actionProgress=saved.actionProgress||{};
    G.contracts=saved.contracts||[];
    G.contractsLastRefresh=saved.contractsLastRefresh||Date.now(); // Set to now if not present to avoid immediate refresh
    G.masteryUpgrades=saved.masteryUpgrades||{};
    G.infusion=saved.infusion||{};
    G.bankOrder=saved.bankOrder||[];
    G.selectedZone=saved.selectedZone||'forest';
    // Restore smithingCraft
    if(G.activeActions.smithingCraft){
      smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
    }
    // Validate HP
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
    // Offline ticks simulation
    if(elapsedTicks>0){
      const results=simulateOffline(elapsedTicks);
      const hrs=Math.floor(elapsedMs/3600000);
      const mins=Math.floor((elapsedMs%3600000)/60000);
      
      // Check if results is combat data object or skill data object
      if(results&&results.type==='combat'){
        G.offlineBanner={time:`${hrs}h ${mins}m`,combat:results};
      }else if(results&&results.type==='skill'){
        G.offlineBanner={time:`${hrs}h ${mins}m`,skill:results};
      }
    }
    return true;
  }catch(e){console.error('Load failed',e);return false;}
}
function simulateOffline(ticks){
  const results=[];
  
  // Check if combat is active first
  if(G.combat.active){
    const offlineTicks=Math.floor(ticks*0.75); // 75% effectiveness (25% penalty)
    const stats=getPlayerStats();
    const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
    if(monster){
      const equippedTrinketId=G.equipment.trinket;
      const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
      const hasCombatTrinket=equippedTrinket&&equippedTrinket.skill==='combat';
      
      // Track detailed stats
      let kills=0;
      let totalGold=0;
      let lootItems={}; // {itemId: qty}
      let foodUsed={}; // {foodId: qty}
      
      // Track starting levels for each skill
      const startLevels={
        attack:xpToLevel(G.skills.attack?.xp||0),
        strength:xpToLevel(G.skills.strength?.xp||0),
        haste:xpToLevel(G.skills.haste?.xp||0),
        defense:xpToLevel(G.skills.defense?.xp||0),
        hitpoints:xpToLevel(G.skills.hitpoints?.xp||XP_TABLE[9]),
        combat:xpToLevel(G.skills.combat?.xp||0)
      };
      
      // Track XP gained
      let xpGained={attack:0,strength:0,haste:0,defense:0,hitpoints:0,combat:0};
      
      // Simulate combat turn by turn
      let currentHp=G.combat.playerHp;
      let currentMonsterHp=G.combat.monsterHp||monster.maxHp;
      let ticksProcessed=0;
      
      const xpBonus=1+(getMasteryBonus('combat','xp')/100);
      const finalXpBonus=hasCombatTrinket?xpBonus*1.1:xpBonus;
      const dropBonus=getMasteryBonus('combat','drops')/100;
      const trinketBonus=hasCombatTrinket?0.1:0;
      const dmgBonus=1+(getMasteryBonus('combat','damage')/100);
      const dmgReduction=1-(getMasteryBonus('combat','defense')/100);
      
      while(ticksProcessed<offlineTicks){
        // Player attacks every attackTicks
        if(ticksProcessed%stats.attackTicks===0){
          // Player damage
          const isCrit=Math.random()*100<stats.critChance;
          let playerDmg=Math.max(1,stats.atk-Math.floor(monster.def/2)+Math.floor(Math.random()*4)-1+stats.power);
          if(isCrit)playerDmg=Math.floor(playerDmg*1.5);
          playerDmg=Math.floor(playerDmg*dmgBonus);
          
          currentMonsterHp-=playerDmg;
          
          // XP for hitting
          const hitXp={
            attack:Math.floor((4+Math.floor(monster.xp*0.15))*finalXpBonus),
            strength:Math.floor(Math.max(1,Math.floor(playerDmg*0.5)+2)*finalXpBonus)
          };
          xpGained.attack+=hitXp.attack;
          xpGained.strength+=hitXp.strength;
          
          // Monster killed
          if(currentMonsterHp<=0){
            kills++;
            const killXp=monster.xp;
            xpGained.attack+=Math.floor(killXp*0.2*finalXpBonus);
            xpGained.strength+=Math.floor(killXp*0.2*finalXpBonus);
            xpGained.haste+=Math.floor(killXp*0.1*finalXpBonus);
            xpGained.defense+=Math.floor(killXp*0.1*finalXpBonus);
            xpGained.hitpoints+=Math.floor(killXp*0.15*finalXpBonus);
            xpGained.combat+=Math.floor(killXp*finalXpBonus);
            
            // Loot
            for(const drop of monster.drops){
              if(drop.gold){
                let gAmt=drop.gold[0]+Math.floor(Math.random()*(drop.gold[1]-drop.gold[0]+1));
                if(trinketBonus>0)gAmt=Math.floor(gAmt*(1+trinketBonus));
                totalGold+=gAmt;
              }else{
                const dropChance=Math.min(1,drop.chance+dropBonus+trinketBonus);
                if(Math.random()<dropChance){
                  lootItems[drop.item]=(lootItems[drop.item]||0)+drop.qty;
                }
              }
            }
            
            // Heal to full HP on kill
            currentHp=stats.maxHp;
            
            // Reset monster
            currentMonsterHp=monster.maxHp;
          }
          
          // Monster counter-attack
          const blocked=Math.random()*100<stats.blockChance;
          let monsterDmg=Math.max(0,monster.atk-Math.floor(stats.armor/3)+Math.floor(Math.random()*3)-1);
          monsterDmg=Math.floor(monsterDmg*dmgReduction);
          if(blocked)monsterDmg=0;
          
          currentHp-=monsterDmg;
          
          // Check if player died BEFORE auto-eating (prevents unkillable bug)
          if(currentHp<=0){
            // Player dies - stop combat
            G.combat.active=false;
            G.combat.playerHp=Math.floor(stats.maxHp/2);
            break;
          }
          
          // Auto-eat if HP < 40% (only if still alive)
          if(currentHp/stats.maxHp<0.4){
            const foods=['cooked_salmon','cooked_trout','cooked_shrimp'];
            for(const f of foods){
              if(G.bank[f]&&G.bank[f]>0){
                const heal=ITEMS[f].heals;
                removeFromBank(f,1);
                foodUsed[f]=(foodUsed[f]||0)+1;
                currentHp=Math.min(stats.maxHp,currentHp+heal);
                break;
              }
            }
          }
        }
        
        ticksProcessed++;
      }
      
      // Apply all XP gains
      if(!G.skills.attack)G.skills.attack={xp:0,masteryXp:{}};
      if(!G.skills.strength)G.skills.strength={xp:0,masteryXp:{}};
      if(!G.skills.haste)G.skills.haste={xp:0,masteryXp:{}};
      if(!G.skills.defense)G.skills.defense={xp:0,masteryXp:{}};
      if(!G.skills.hitpoints)G.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}};
      if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}};
      
      G.skills.attack.xp+=xpGained.attack;
      G.skills.strength.xp+=xpGained.strength;
      G.skills.haste.xp+=xpGained.haste;
      G.skills.defense.xp+=xpGained.defense;
      G.skills.hitpoints.xp+=xpGained.hitpoints;
      G.skills.combat.xp+=xpGained.combat;
      
      // Apply loot
      G.gold+=totalGold;
      for(const [itemId,qty] of Object.entries(lootItems)){
        addToBank(itemId,qty);
      }
      
      // Calculate levels gained
      const levelsGained={};
      for(const skill of ['attack','strength','haste','defense','hitpoints','combat']){
        const endLevel=xpToLevel(G.skills[skill].xp);
        const gained=endLevel-startLevels[skill];
        if(gained>0)levelsGained[skill]={start:startLevels[skill],end:endLevel};
      }
      
      // Update player HP
      G.combat.playerHp=currentHp;
      G.combat.monsterHp=currentMonsterHp;
      
      // Build detailed results object
      return {
        type:'combat',
        kills,
        monster:monster.name,
        gold:totalGold,
        loot:lootItems,
        xp:xpGained,
        levels:levelsGained,
        food:foodUsed,
        died:G.combat.active===false
      };
    }
  }
  
  // Only process the first active action (one at a time)
  const activeEntries=Object.entries(G.activeActions);
  if(activeEntries.length===0)return results;
  
  const [skill,actionId]=activeEntries[0];
  
  // Track detailed stats for all skills
  const startLevel=xpToLevel(G.skills[skill]?.xp||0);
  let xpGained=0;
  let materialsUsed={};
  let itemsProduced={};
  
  if(skill==='smithingCraft'){
    // Handle smithing craft separately
    if(smithingCraftAction){
      const completions=Math.floor(ticks/smithingCraftAction.ticks);
      let produced=0;
      for(let i=0;i<completions;i++){
        if(!hasMaterials(smithingCraftAction.consumes))break;
        // Track materials
        for(const [matId,qty] of Object.entries(smithingCraftAction.consumes)){
          materialsUsed[matId]=(materialsUsed[matId]||0)+qty;
        }
        consumeMaterials(smithingCraftAction.consumes);
        G.skills.smithing.xp+=smithingCraftAction.xp;
        xpGained+=smithingCraftAction.xp;
        addToBank(smithingCraftAction.produces,smithingCraftAction.qty||1);
        itemsProduced[smithingCraftAction.produces]=(itemsProduced[smithingCraftAction.produces]||0)+(smithingCraftAction.qty||1);
        produced++;
      }
      
      const endLevel=xpToLevel(G.skills.smithing.xp);
      const levelsGained=endLevel-startLevel;
      
      return {
        type:'skill',
        skill:'smithing',
        action:smithingCraftAction.name,
        xpGained,
        levelsGained,
        materialsUsed,
        itemsProduced
      };
    }
    return results;
  }
  
  const skillActions=ACTIONS[skill];
  if(!skillActions)return results;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return results;
  const mastLv=getMasteryLevel(skill,actionId);
  const actionTicks=getMasteryTicks(action,mastLv);
  const completions=Math.floor(ticks/actionTicks);
  if(completions<=0)return results;
  
  let produced=0;
  for(let i=0;i<completions;i++){
    if(action.consumes){
      if(!hasMaterials(action.consumes))break;
      // Track materials
      for(const [matId,qty] of Object.entries(action.consumes)){
        materialsUsed[matId]=(materialsUsed[matId]||0)+qty;
      }
      consumeMaterials(action.consumes);
    }
    G.skills[skill].xp+=action.xp;
    xpGained+=action.xp;
    if(action.masteryXp)G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+action.masteryXp;
    if(action.produces){
      let p=action.produces;
      if(action.burnChance&&Math.random()<0.1)p=action.burnItem;
      addToBank(p,action.qty||1);
      if(p)itemsProduced[p]=(itemsProduced[p]||0)+(action.qty||1);
      produced++;
    }
  }
  
  const endLevel=xpToLevel(G.skills[skill].xp);
  
  // Return detailed object instead of string array
  return {
    type:'skill',
    skill,
    action:action.name,
    xpGained,
    startLevel,
    endLevel,
    materialsUsed,
    itemsProduced
  };
}
function manualSave(){saveGame();notify('Game saved!','info');}

function exportSave(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`grindia-save-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  notify('Save exported!','info');
}

function importSave(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='application/json';
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    try{
      const text=await file.text();
      const imported=JSON.parse(text);
      
      // Validate it's a Grindia save
      if(!imported.skills||!imported.bank){
        notify('Invalid save file!','combat');
        return;
      }
      
      // Merge imported data
      G.version=imported.version||1;
      if(imported.skills){
        for(const k of Object.keys(G.skills)){
          if(imported.skills[k])G.skills[k]=imported.skills[k];
        }
      }
      G.bank=imported.bank||{};
      G.gold=imported.gold||0;
      G.equipment=imported.equipment||{weapon:null,helmet:null,body:null,legs:null,shield:null,gloves:null,boots:null,trinket:null};
      // Ensure new equipment slots exist for old saves
      if(!G.equipment.gloves)G.equipment.gloves=null;
      if(!G.equipment.boots)G.equipment.boots=null;
      if(!G.equipment.trinket)G.equipment.trinket=null;
      G.combat={...G.combat,...(imported.combat||{})};
      G.infusion=imported.infusion||{};
      G.bankOrder=imported.bankOrder||[];
      // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
      for(const k of Object.keys(G.activeActions)){
        delete G.activeActions[k];
      }
      if(imported.activeActions){
        for(const [k,v] of Object.entries(imported.activeActions)){
          G.activeActions[k]=v; // This triggers the Proxy set handler
        }
      }
      G.actionProgress=imported.actionProgress||{};
      G.contracts=imported.contracts||[];
      G.contractsLastRefresh=imported.contractsLastRefresh||Date.now();
      G.masteryUpgrades=imported.masteryUpgrades||{};
      G.selectedZone=imported.selectedZone||'forest';
      
      // Restore smithingCraft manually (Proxy should have handled it, but double-check)
      if(!smithingCraftAction && G.activeActions.smithingCraft){
        smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
      }
      
      // Validate and fix HP
      const stats=getPlayerStats();
      G.combat.maxHp=stats.maxHp;
      if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
      
      // Save to storage
      await saveGame();
      
      // Refresh UI
      showPage(currentPage);
      updateHeader();
      updateActiveActionDisplay();
      renderSidebar();
      
      notify('Save imported successfully!','lvl');
    }catch(err){
      console.error('Import error:',err);
      notify('Failed to import save!','combat');
    }
  };
  input.click();
}

// ============================================================
// UI RENDERING
// ============================================================
let currentPage='woodcutting';
function getCurrentPage(){return currentPage;}
function showPage(page){
  currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+page);
  if(pg)pg.classList.add('active');
  // Highlight the right nav item
  const nav=document.getElementById('nav-'+page);
  if(nav)nav.classList.add('active');
  // For combat sub-skills, also highlight their nav items
  const combatSubSkills=['attack','strength','haste','defense','hitpoints'];
  if(page==='stats'){
    combatSubSkills.forEach(s=>{
      const el=document.getElementById('nav-'+s);
      if(el)el.classList.add('active');
    });
  }
  renderSkillPage(page);
  if(page==='bank')renderBank();
  if(page==='equipment')renderEquipPage();
  if(page==='combat')renderCombatPage();
  if(page==='stats')renderStatsPage();
  if(page==='contracts')renderContractsPage();
  if(page==='mastery-shop')renderMasteryShop();
  if(page==='store')renderStore();
}

function renderSidebar(){
  const skills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat'];
  skills.forEach(s=>{
    if(!G.skills[s])return; // Safety check
    const lv=xpToLevel(G.skills[s].xp);
    const slEl=document.getElementById('sl-'+s);
    if(slEl)slEl.textContent='Lv '+lv;
    const mbEl=document.getElementById('mb-'+s);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[s].xp)*100)+'%';
  });
  // Combat sub-skills
  const stats=getPlayerStats();
  const combatSubs=[
    {key:'attack',stat:`${stats.critChance}% Crit`},
    {key:'strength',stat:`+${stats.power} Pwr`},
    {key:'haste',stat:`${stats.attackSpeed}`},
    {key:'defense',stat:`${stats.armor} Arm`},
    {key:'hitpoints',stat:`${stats.maxHp} HP`},
  ];
  combatSubs.forEach(({key,stat})=>{
    if(!G.skills[key])return; // Safety check
    const lv=xpToLevel(G.skills[key].xp);
    const slEl=document.getElementById('sl-'+key);
    if(slEl)slEl.textContent='Lv '+lv;
    const stEl=document.getElementById('sl-'+key+'-stat');
    if(stEl)stEl.textContent=' ¬∑ '+stat;
    const mbEl=document.getElementById('mb-'+key);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[key].xp)*100)+'%';
  });
}

function renderXPArea(skill){
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const xp=G.skills[skill].xp;
  const lv=xpToLevel(xp);
  const prog=xpProgress(xp)*100;
  const nextXp=lv<99?xpToNextLevel(xp):0;
  return `
    <div class="xp-row">
      <span class="xp-label">Level ${lv}</span>
      <div class="xp-bar"><div class="xp-bar-fill xp-fill-blue" style="width:${prog}%"></div></div>
      <span class="xp-txt">${fmt(xp)} XP ${lv<99?'('+fmt(nextXp)+' to next)':''}</span>
    </div>`;
}

function updateActiveActionDisplay(){
  const display=document.getElementById('active-action-display');
  if(!display)return;
  
  // Check combat first
  if(G.combat.active){
    const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
    if(monster){
      document.getElementById('aad-icon').textContent='‚öîÔ∏è';
      document.getElementById('aad-text').textContent='Fighting '+monster.name;
      display.classList.add('visible');
      return;
    }
  }
  
  // Check smithing craft
  if(smithingCraftAction){
    const count=G.sessionCounts[smithingCraftAction.id]||0;
    document.getElementById('aad-icon').textContent=smithingCraftAction.icon;
    document.getElementById('aad-text').textContent='Crafting '+smithingCraftAction.name+(count>0?' ('+fmt(count)+')':'');
    display.classList.add('visible');
    return;
  }
  
  // Check regular skills
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(action){
      const skillNames={
        woodcutting:'Woodcutting',mining:'Mining',fishing:'Fishing',
        firemaking:'Burning',smithing:'Smelting',cooking:'Cooking'
      };
      const count=G.sessionCounts[actionId]||0;
      document.getElementById('aad-icon').textContent=action.icon;
      document.getElementById('aad-text').textContent=(skillNames[skill]||skill)+' '+action.name+(count>0?' ('+fmt(count)+')':'');
      display.classList.add('visible');
      return;
    }
  }
  
  // Nothing active
  display.classList.remove('visible');
}

function updateHeader(){
  const stats=getPlayerStats();
  document.getElementById('hdr-gold').textContent=fmt(G.gold);
  document.getElementById('hdr-hp').textContent=Math.floor(G.combat.playerHp)+'/'+stats.maxHp;
  document.getElementById('hdr-atk').textContent=stats.critChance+'%';
  document.getElementById('hdr-def').textContent=stats.armor;
}

function updateProgressBars(){
  renderSidebar();
  const skills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat'];
  skills.forEach(s=>{
    const el=document.getElementById('pgxp-'+s);
    if(el&&currentPage===s)el.innerHTML=renderXPArea(s);
  });
  // Update active action progress bars
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(!action)continue;
    const mastLv=getMasteryLevel(skill,actionId);
    const ticks=getMasteryTicks(action,mastLv);
    const prog=(G.actionProgress[skill]||0)/ticks*100;
    const fill=document.getElementById('prog-fill-'+skill+'-'+actionId);
    if(fill)fill.style.width=prog+'%';
  }
  // Smithing craft progress
  if(smithingCraftAction){
    const fill=document.getElementById('prog-fill-smithing-craft');
    if(fill)fill.style.width=(smithingCraftProgress/smithingCraftAction.ticks*100)+'%';
  }
}

function renderSkillPage(skill){
  if(currentPage!==skill)return;
  // Safety: ensure skill exists
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const xpEl=document.getElementById('pgxp-'+skill);
  if(xpEl)xpEl.innerHTML=renderXPArea(skill);
  const curEl=document.getElementById('cur-'+skill);
  const lv=xpToLevel(G.skills[skill].xp);

  if(['woodcutting','mining','fishing'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const skillActions=ACTIONS[skill];
        const action=skillActions.find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">‚ñ† Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            <span class="ac-icon">${a.icon}</span>
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Item: <span>${ITEMS[a.produces]?ITEMS[a.produces].icon+' '+ITEMS[a.produces].name:'-'}${a.produces?' <span data-item-id="'+a.produces+'">('+fmt(G.bank[a.produces]||0)+')</span>':''}</span></div>
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  if(['firemaking','cooking'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">‚ñ† Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const hasMat=!a.consumes||hasMaterials(a.consumes);
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        const ingredientHtml=a.consumes?Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id]?ITEMS[id].icon+' ':''} ${qty}x ${ITEMS[id]?ITEMS[id].name:id} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
        }).join(''):'';
        const craftableCount=a.consumes?getCraftableCount(a.consumes):0;
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            <span class="ac-icon">${a.icon}</span>
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            ${a.produces&&ITEMS[a.produces]?`<div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>`:''}
            <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  if(skill==='smithing'){
    const actionId=G.activeActions[skill];
    const craftId=smithingCraftAction?smithingCraftAction.id:null;
    if(curEl){
      let curHtml='';
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curHtml+=`<div class="cur-action">
          <span class="ca-label">Smelting:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopAction('smithing')">‚ñ† Stop</button>
        </div>`;
      }
      if(craftId){
        const prog=smithingCraftProgress/smithingCraftAction.ticks*100;
        const sessionCount=G.sessionCounts[craftId]||0;
        curHtml+=`<div class="cur-action" style="border-color:var(--gold)">
          <span class="ca-label">Crafting:</span>
          <span class="ca-name">${smithingCraftAction.icon} ${smithingCraftAction.name} <span id="session-count-${craftId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill xp-fill-gold" id="prog-fill-smithing-craft" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopCraft()">‚ñ† Stop</button>
        </div>`;
      }
      curEl.innerHTML=curHtml;
    }
    const grid=document.getElementById('grid-smithing');
    if(grid){
      grid.innerHTML=ACTIONS.smithing.map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
        }).join('');
        const craftableCount=getCraftableCount(a.consumes);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\'smithing\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head"><span class="ac-icon">${a.icon}</span><span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>
            <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
    const craftGrid=document.getElementById('grid-smithing-craft');
    if(craftGrid){
      craftGrid.innerHTML=ACTIONS.smithingCraft.map(a=>{
        const locked=lv<a.levelReq;
        const active=smithingCraftAction&&smithingCraftAction.id===a.id;
        const hasMat=!locked&&hasMaterials(a.consumes);
        const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
        }).join('');
        const craftableCount=getCraftableCount(a.consumes);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startCraft(\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head"><span class="ac-icon">${a.icon}</span><span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(a.ticks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>
            <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
          </div>
        </div>`;
      }).join('');
    }
  }
}

function renderBank(){
  document.getElementById('bank-gold-disp').textContent=fmt(G.gold);
  const cats=['all','logs','ore','bar','fish','food','weapon','armor','trinket','junk'];
  const bankCats=document.getElementById('bank-cats');
  if(bankCats&&!bankCats.dataset.rendered){
    bankCats.innerHTML=cats.map(c=>`<button class="bcat-btn${c==='all'?' active':''}" onclick="filterBank('${c}')" id="bcat-${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</button>`).join('');
    bankCats.dataset.rendered='1';
  }
  const filter=window._bankFilter||'all';
  const grid=document.getElementById('bank-grid');
  let items=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&(filter==='all'||ITEMS[id].cat===filter||
    (filter==='weapon'&&ITEMS[id].cat==='weapon')||(filter==='armor'&&ITEMS[id].cat==='armor')));
  
  // Apply custom ordering if in 'all' tab and bankOrder exists
  if(filter==='all'&&G.bankOrder&&G.bankOrder.length>0){
    // Sort items by bankOrder, new items go to end
    items.sort((a,b)=>{
      const aIdx=G.bankOrder.indexOf(a[0]);
      const bIdx=G.bankOrder.indexOf(b[0]);
      if(aIdx===-1&&bIdx===-1)return 0;
      if(aIdx===-1)return 1;
      if(bIdx===-1)return -1;
      return aIdx-bIdx;
    });
  }
  
  if(items.length===0){grid.innerHTML='<div class="bank-empty">No items here. Start skilling!</div>';return;}
  grid.innerHTML=items.map(([id,qty])=>{
    const item=ITEMS[id];
    return `<div class="b-item" draggable="true" data-item-id="${id}" ondragstart="bankDragStart(event)" ondragover="bankDragOver(event)" ondrop="bankDrop(event)" ondragend="bankDragEnd(event)">
      <div class="b-sell-menu">
        ${qty>=1?`<button class="b-sell-btn" onclick="sellItem('${id}',1)" title="Sell 1">Sell 1</button>`:''}
        ${qty>=10?`<button class="b-sell-btn" onclick="sellItem('${id}',10)" title="Sell 10">Sell 10</button>`:''}
        ${qty>=100?`<button class="b-sell-btn" onclick="sellItem('${id}',100)" title="Sell 100">Sell 100</button>`:''}
        ${qty>=1000?`<button class="b-sell-btn" onclick="sellItem('${id}',1000)" title="Sell 1000">Sell 1K</button>`:''}
        <button class="b-sell-btn b-sell-all" onclick="sellItem('${id}',${qty})" title="Sell All">Sell All</button>
      </div>
      <div class="b-icon">${item.icon}</div>
      <div class="b-name">${item.name}</div>
      <div class="b-qty">${fmt(qty)}</div>
      ${item.value>0?`<div class="b-val">${item.value}gp ea</div>`:''}
    </div>`;
  }).join('');
}

let draggedBankItem=null;
function bankDragStart(e){
  draggedBankItem=e.currentTarget;
  e.currentTarget.style.opacity='0.5';
  e.dataTransfer.effectAllowed='move';
}
function bankDragOver(e){
  if(e.preventDefault)e.preventDefault();
  e.dataTransfer.dropEffect='move';
  const target=e.currentTarget;
  if(target&&target!==draggedBankItem){
    target.style.borderTop='3px solid var(--gold)';
  }
  return false;
}
function bankDrop(e){
  if(e.stopPropagation)e.stopPropagation();
  e.currentTarget.style.borderTop='';
  
  if(draggedBankItem!==e.currentTarget){
    const draggedId=draggedBankItem.dataset.itemId;
    const targetId=e.currentTarget.dataset.itemId;
    
    // Get current items in order
    const filter=window._bankFilter||'all';
    if(filter!=='all')return; // Only allow reordering in 'all' tab
    
    const allItems=Object.keys(G.bank).filter(id=>G.bank[id]>0&&ITEMS[id]);
    
    // Initialize bankOrder if empty
    if(!G.bankOrder||G.bankOrder.length===0){
      G.bankOrder=allItems.slice();
    }
    
    // Ensure all items are in bankOrder
    allItems.forEach(id=>{
      if(!G.bankOrder.includes(id)){
        G.bankOrder.push(id);
      }
    });
    
    // Remove dragged item and insert at target position
    const dragIdx=G.bankOrder.indexOf(draggedId);
    const targetIdx=G.bankOrder.indexOf(targetId);
    if(dragIdx!==-1){
      G.bankOrder.splice(dragIdx,1);
    }
    const newTargetIdx=G.bankOrder.indexOf(targetId);
    G.bankOrder.splice(newTargetIdx,0,draggedId);
    
    saveGame();
    renderBank();
  }
  return false;
}
function bankDragEnd(e){
  e.currentTarget.style.opacity='';
  document.querySelectorAll('.b-item').forEach(el=>el.style.borderTop='');
}

function filterBank(cat){
  window._bankFilter=cat;
  document.querySelectorAll('.bcat-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('bcat-'+cat);
  if(el)el.classList.add('active');
  renderBank();
}
function sellItem(id,qty){
  if(!G.bank[id]||G.bank[id]<qty)return;
  removeFromBank(id,qty);
  const value=(ITEMS[id]?.value||0)*qty;
  G.gold+=value;
  updateHeader();
  renderBank();
  if(value>0)notify(`Sold ${qty}x ${ITEMS[id].name} for ${value}gp`,'item');
}
function sellAllCategory(cat){
  let totalGold=0;
  for(const [id,qty] of Object.entries(G.bank)){
    if(ITEMS[id]&&ITEMS[id].cat===cat&&qty>0){
      totalGold+=ITEMS[id].value*qty;
      delete G.bank[id];
    }
  }
  G.gold+=totalGold;
  updateHeader();
  renderBank();
  if(totalGold>0)notify(`Sold all ${cat} for ${fmt(totalGold)}gp`,'item');
}

function renderStatsPage(){
  if(currentPage!=='stats')return;
  const stats=getPlayerStats();

  // Calculate total level
  const allSkills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat','attack','strength','haste','defense','hitpoints'];
  const totalLevel=allSkills.reduce((s,k)=>{
    if(!G.skills[k])return s; // Safety check for missing skills
    return s+xpToLevel(G.skills[k].xp);
  },0);
  const el=document.getElementById('stats-total-level');
  if(el)el.textContent=fmt(totalLevel);

  // Skill overview grid (gathering + production + combat overall)
  const skillRows=[
    {key:'woodcutting',icon:'ü™ì',name:'Woodcutting'},
    {key:'mining',icon:'‚õèÔ∏è',name:'Mining'},
    {key:'fishing',icon:'üé£',name:'Fishing'},
    {key:'firemaking',icon:'üî•',name:'Firemaking'},
    {key:'smithing',icon:'üî®',name:'Smithing'},
    {key:'cooking',icon:'üç≥',name:'Cooking'},
    {key:'combat',icon:'‚öîÔ∏è',name:'Combat'},
  ];
  const sgEl=document.getElementById('stats-skill-grid');
  if(sgEl){
    sgEl.innerHTML=skillRows.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      const xp=G.skills[s.key].xp;
      const lv=xpToLevel(xp);
      const prog=xpProgress(xp)*100;
      return `<div class="sog-item" onclick="showPage('${s.key==='combat'?'combat':s.key}')">
        <span class="sog-icon">${s.icon}</span>
        <div class="sog-info">
          <div class="sog-name">${s.name}</div>
          <div class="sog-level">${lv}</div>
          <div class="sog-xp-bar"><div class="sog-xp-fill" style="width:${prog}%"></div></div>
        </div>
      </div>`;
    }).join('');
  }

  // Combat stat cards
  const combatCards=[
    {icon:'üó°Ô∏è',label:'Attack',sub:'‚Üí Crit Chance',val:`${stats.critChance}%`,color:'var(--crit)',
      lv:stats.atkLv,xp:(G.skills.attack?.xp || 0),desc:'Chance to deal 1.5√ó damage on hit'},
    {icon:'üí™',label:'Strength',sub:'‚Üí Power Bonus',val:`+${stats.power}`,color:'var(--power)',
      lv:stats.strLv,xp:(G.skills.strength?.xp || 0),desc:'Flat damage added to every hit'},
    {icon:'‚ö°',label:'Haste',sub:'‚Üí Attack Speed',val:stats.attackSpeed,color:'var(--haste)',
      lv:stats.hasteLv,xp:(G.skills.haste?.xp || 0),desc:'How often you strike enemies'},
    {icon:'üõ°Ô∏è',label:'Defense',sub:'‚Üí Armor & Block',val:`${stats.armor} / ${stats.blockChance}%`,color:'var(--armor)',
      lv:stats.defLv,xp:(G.skills.defense?.xp || 0),desc:'Damage reduction + chance to fully block'},
    {icon:'‚ù§Ô∏è',label:'Hitpoints',sub:'‚Üí Max Health',val:stats.maxHp,color:'var(--hps)',
      lv:stats.hpLv,xp:(G.skills.hitpoints?.xp || XP_TABLE[9]),desc:'Maximum health pool in combat'},
  ];
  const cgEl=document.getElementById('stats-combat-grid');
  if(cgEl){
    cgEl.innerHTML=combatCards.map(c=>{
      const prog=xpProgress(c.xp)*100;
      return `<div class="combat-stat-card">
        <div class="csc-icon">${c.icon}</div>
        <div class="csc-label">${c.label}</div>
        <div class="csc-value" style="color:${c.color}">${c.val}</div>
        <div class="csc-sublabel">${c.sub}</div>
        <div class="csc-level" style="color:${c.color}">Lv ${c.lv}</div>
        <div class="csc-bar"><div class="csc-bar-fill" style="width:${prog}%;background:${c.color}"></div></div>
      </div>`;
    }).join('');
  }

  // Combat sub-skills XP detail
  const cxEl=document.getElementById('stats-combat-xp');
  if(cxEl){
    const subSkills=[
      {key:'attack',icon:'üó°Ô∏è',name:'Attack',color:'var(--crit)',effect:`${stats.critChance}% crit chance`},
      {key:'strength',icon:'üí™',name:'Strength',color:'var(--power)',effect:`+${stats.power} power bonus`},
      {key:'haste',icon:'‚ö°',name:'Haste',color:'var(--haste)',effect:`Attack every ${stats.attackSpeed}`},
      {key:'defense',icon:'üõ°Ô∏è',name:'Defense',color:'var(--armor)',effect:`${stats.armor} armor, ${stats.blockChance}% block`},
      {key:'hitpoints',icon:'‚ù§Ô∏è',name:'Hitpoints',color:'var(--hps)',effect:`${stats.maxHp} max HP`},
    ];
    cxEl.innerHTML=subSkills.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      const xp=G.skills[s.key].xp;
      const lv=xpToLevel(xp);
      const prog=xpProgress(xp)*100;
      const toNext=lv<99?xpToNextLevel(xp):0;
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;align-items:center">
          <span style="font-weight:600;color:${s.color}">${s.icon} ${s.name} <span style="font-size:12px;font-family:'Share Tech Mono',monospace">Lv ${lv}</span></span>
          <span style="font-size:10px;color:var(--text3)">${s.effect}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
            <div style="width:${prog}%;height:100%;background:${s.color};border-radius:4px;transition:width .4s"></div>
          </div>
          <span style="font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap">${fmt(xp)} XP${lv<99?' ('+fmt(toNext)+' to '+( lv+1)+')':' MAX'}</span>
        </div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Trained during combat${s.key==='haste'?' (passive)':s.key==='attack'?' (on hit)':s.key==='strength'?' (damage dealt)':' (damage taken)'}</div>
      </div>`;
    }).join('');
  }
  
  // Mastery Shop Purchases tracking
  const mtEl=document.getElementById('stats-mastery-track');
  if(mtEl){
    const skillsWithUpgrades=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat'];
    const purchaseData=skillsWithUpgrades.map(skill=>{
      const upgrades=MASTERY_UPGRADES[skill]||[];
      const purchasedUpgrades=upgrades.map(upgrade=>{
        const key=`${skill}_${upgrade.id}`;
        const count=G.masteryUpgrades[key]||0;
        return {upgrade,count,skill};
      }).filter(p=>p.count>0); // Only show purchased upgrades
      return {skill,purchasedUpgrades};
    }).filter(s=>s.purchasedUpgrades.length>0); // Only show skills with purchases
    
    if(purchaseData.length===0){
      mtEl.innerHTML='<div style="color:var(--text3);font-size:12px">Visit the Mastery Shop to purchase permanent upgrades!</div>';
    }else{
      mtEl.innerHTML=purchaseData.map(s=>{
        const skillIcon={'woodcutting':'ü™ì','mining':'‚õèÔ∏è','fishing':'üé£','firemaking':'üî•','smithing':'üî®','cooking':'üç≥','combat':'‚öîÔ∏è'}[s.skill];
        const skillName=s.skill.charAt(0).toUpperCase()+s.skill.slice(1);
        return `<div style="margin-bottom:14px">
          <div style="font-weight:600;margin-bottom:6px;color:var(--gold2)">${skillIcon} ${skillName}</div>
          ${s.purchasedUpgrades.map(p=>{
            const currentEffect=p.upgrade.stackEffect(p.count);
            const progressBars=[];
            for(let i=0;i<p.upgrade.maxPurchases;i++){
              const purchased=i<p.count;
              progressBars.push(`<span style="display:inline-block;width:20px;height:18px;background:${purchased?'var(--gold2)':'var(--bg4)'};border-radius:3px;margin-right:2px"></span>`);
            }
            return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:8px;background:var(--bg3);border-radius:6px">
              <div style="flex:1">
                <div style="font-size:11px;font-weight:600;margin-bottom:2px">${p.upgrade.name}</div>
                <div style="font-size:10px;color:var(--gold2)">${currentEffect}</div>
              </div>
              <div style="display:flex;gap:1px">${progressBars.join('')}</div>
              <span style="font-size:10px;color:var(--text3);min-width:50px;text-align:right">${p.count}/${p.upgrade.maxPurchases}</span>
            </div>`;
          }).join('')}
        </div>`;
      }).join('');
    }
  }
}

function renderCombatPage(){
  if(currentPage!=='combat')return;
  // XP area
  const xpEl=document.getElementById('pgxp-combat');
  if(xpEl)xpEl.innerHTML=renderXPArea('combat');
  renderCombatHP();
  
  // Zone select
  const zoneEl=document.getElementById('zone-select');
  if(zoneEl){
    if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}}; // Safety check
    const combatLv=xpToLevel(G.skills.combat.xp);
    
    // Get selected zone or default to first unlocked
    if(!G.selectedZone){
      const firstUnlocked=COMBAT_ZONES.find(z=>combatLv>=z.levelReq);
      G.selectedZone=firstUnlocked?firstUnlocked.id:'forest';
    }
    
    zoneEl.innerHTML=COMBAT_ZONES.map(z=>{
      const locked=combatLv<z.levelReq;
      const selected=G.selectedZone===z.id;
      return `<div class="zone-card${locked?' z-locked':''}${selected?' z-selected':''}" onclick="${locked?'':'selectZone(\''+z.id+'\')'}">
        <div class="zc-header">
          <div class="zc-name">${z.name}</div>
          <div class="zc-level">Lv ${z.levelReq}+</div>
        </div>
        <div class="zc-desc">${z.desc}</div>
        <div class="zc-tier">${z.tier} tier</div>
      </div>`;
    }).join('');
  }
  
  // Monster select (filtered by zone)
  const msEl=document.getElementById('monster-select');
  const monsterTitle=document.getElementById('monster-section-title');
  if(msEl&&monsterTitle){
    const selectedZone=G.selectedZone||'forest';
    const zoneMonsters=MONSTERS.filter(m=>m.zone===selectedZone);
    
    if(zoneMonsters.length>0){
      monsterTitle.style.display='block';
      const combatLv=xpToLevel(G.skills.combat?.xp||0);
      msEl.innerHTML=zoneMonsters.map(m=>{
        const locked=combatLv<m.levelReq;
        const sel=G.combat.monsterId===m.id;
        const dropHints=m.drops.filter(d=>d.item).map(d=>ITEMS[d.item].name).slice(0,3).join(', ');
        const moreDrops=m.drops.filter(d=>d.item).length>3?'...':'';
        return `<div class="monster-card${locked?' m-locked':''}${sel?' m-selected':''}" onclick="${locked?'':'selectMonster(\''+m.id+'\')'}">
          <div class="mc-head">
            <span class="mc-icon">${m.icon}</span>
            <span class="mc-name">${m.name}</span>
            <span class="mc-level">Lv ${m.levelReq}+</span>
          </div>
          <div class="mc-stats">
            <div class="mc-stat">HP: <span>${m.maxHp}</span></div>
            <div class="mc-stat">ATK: <span>${m.atk}</span></div>
            <div class="mc-stat">DEF: <span>${m.def}</span></div>
            <div class="mc-stat">XP: <span>${m.xp}</span></div>
          </div>
          ${dropHints?`<div class="mc-loot">Drops: ${dropHints}${moreDrops}</div>`:''}
        </div>`;
      }).join('');
    }else{
      monsterTitle.style.display='none';
      msEl.innerHTML='<div style="text-align:center;color:var(--text3);padding:20px">No monsters in this zone</div>';
    }
  }
  
  // Food display
  const foodEl=document.getElementById('food-display');
  if(foodEl){
    const foods=['cooked_shrimp','cooked_trout','cooked_salmon','cooked_tuna','cooked_lobster','cooked_bass','cooked_swordfish','cooked_monkfish','cooked_shark','cooked_manta','cooked_turtle'];
    const available=foods.filter(f=>G.bank[f]&&G.bank[f]>0);
    if(available.length===0){
      foodEl.textContent='No food available. Cook some fish first!';
    }
    else{
      foodEl.innerHTML=available.map(f=>`
        <button class="food-btn" onclick="eatFood('${f}')" title="Click to eat">
          ${ITEMS[f].icon} ${ITEMS[f].name} √ó ${G.bank[f]} 
          <span style="color:var(--green2)">(+${ITEMS[f].heals} HP)</span>
        </button>
      `).join('');
    }
  }
}
function selectZone(zoneId){
  G.selectedZone=zoneId;
  renderCombatPage();
  // Auto-scroll to monster section after selecting zone
  setTimeout(()=>{
    const monsterSection=document.getElementById('monster-section-title');
    if(monsterSection&&monsterSection.style.display!=='none'){
      monsterSection.scrollIntoView({behavior:'smooth',block:'start'});
    }
  },50);
}
function renderCombatHP(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  const el=document.getElementById('combatants-display');
  if(!el)return;
  const playerPct=Math.max(0,G.combat.playerHp/stats.maxHp*100);
  const monsterPct=G.combat.active?Math.max(0,G.combat.monsterHp/G.combat.maxMonsterHp*100):100;
  el.innerHTML=`
    <div class="combatant">
      <div class="comb-name" style="color:var(--blue2)">You</div>
      <div class="comb-hp-label">${Math.floor(G.combat.playerHp)} / ${stats.maxHp} HP</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-player" style="width:${playerPct}%"></div></div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">üó°Ô∏è ${stats.critChance}% Crit &nbsp;üí™ +${stats.power} Pwr &nbsp;‚ö° ${stats.attackSpeed}</div>
    </div>
    <div class="vs-badge">VS</div>
    <div class="combatant">
      <div class="comb-name" style="color:var(--red2)">${monster?monster.icon+' '+monster.name:'No Monster'}</div>
      <div class="comb-hp-label">${G.combat.active?Math.floor(G.combat.monsterHp)+' / '+G.combat.maxMonsterHp+' HP':'--- HP'}</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-monster" style="width:${monsterPct}%"></div></div>
      ${monster?`<div style="font-size:10px;color:var(--text3);margin-top:3px">ATK ${monster.atk} | DEF ${monster.def} | üõ°Ô∏è ${stats.blockChance}% Block</div>`:''}
    </div>`;
}
function selectMonster(id){
  if(G.combat.active)stopCombat();
  G.combat.monsterId=id;
  renderCombatPage();
}
function startCombat(){startCombatAction();}

function renderEquipPage(){
  if(currentPage!=='equipment')return;
  const stats=getPlayerStats();
  const slots=[
    {key:'weapon',label:'Weapon',icon:'‚öîÔ∏è'},
    {key:'helmet',label:'Helmet',icon:'‚õëÔ∏è'},
    {key:'body',label:'Body',icon:'üß•'},
    {key:'legs',label:'Legs',icon:'üëñ'},
    {key:'gloves',label:'Gloves',icon:'üß§'},
    {key:'boots',label:'Boots',icon:'ü•æ'},
    {key:'shield',label:'Shield',icon:'üõ°Ô∏è'},
    {key:'trinket',label:'Trinket',icon:'üíé'},
  ];
  const slotsEl=document.getElementById('equip-slots');
  if(slotsEl){
    slotsEl.innerHTML=`<div style="display:flex;flex-direction:column;gap:8px">
    ${slots.map(s=>{
      const itemId=G.equipment[s.key];
      const item=itemId?ITEMS[itemId]:null;
      const infusionLevel=G.infusion[s.key]||0;
      const infusionBonus=infusionLevel>0?getInfusionBonusText(s.key,infusionLevel):'';
      return `<div class="equip-slot${item?' filled':''}" onclick="openEquipModal('${s.key}')">
        ${item?`<button class="es-unequip" onclick="event.stopPropagation();unequipItem('${s.key}')">‚úï</button>`:''}
        <div class="es-label">${s.label}${infusionLevel>0?' <span style="color:var(--gold2)">+'+infusionLevel+'</span>':''}</div>
        <div class="es-icon">${item?item.icon:s.icon}</div>
        <div class="${item?'es-name':'es-empty'}">${item?item.name:'Empty'}</div>
        ${item&&(item.atk||item.def)?`<div class="es-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}</div>`:''}
        ${item&&item.bonus?`<div class="es-stat" style="font-size:10px;color:var(--gold2)">${item.bonus}</div>`:''}
        ${infusionBonus?`<div class="es-stat" style="font-size:10px;color:var(--green2)">‚ú® ${infusionBonus}</div>`:''}
      </div>`;
    }).join('')}
    </div>`;
  }
  const statsEl=document.getElementById('stats-display');
  if(statsEl){
    const combatLv=xpToLevel(G.skills.combat?.xp||0);
    statsEl.innerHTML=`<h3>‚öîÔ∏è Combat Summary</h3>
      <div class="stat-row"><span class="sr-label">‚öîÔ∏è Combat Level</span><span class="sr-val">${combatLv}</span></div>
      <div class="stat-row" style="font-size:10px;color:var(--text3);margin-top:-4px;margin-bottom:4px">
        <span style="margin-left:20px">üó°Ô∏è${stats.atkLv} üí™${stats.strLv} ‚ö°${stats.hasteLv} üõ°Ô∏è${stats.defLv} ‚ù§Ô∏è${stats.hpLv}</span>
      </div>
      <div class="stat-row"><span class="sr-label">üó°Ô∏è Crit Chance</span><span class="sr-val" style="color:var(--crit)">${stats.critChance}%</span></div>
      <div class="stat-row"><span class="sr-label">üí™ Power</span><span class="sr-val" style="color:var(--power)">+${stats.power} dmg</span></div>
      <div class="stat-row"><span class="sr-label">‚ö° Attack Speed</span><span class="sr-val" style="color:var(--haste)">${stats.attackSpeed}</span></div>
      <div class="stat-row"><span class="sr-label">üõ°Ô∏è Armor</span><span class="sr-val" style="color:var(--armor)">${stats.armor}${stats.eqDef?`<span class="sr-bonus">+${stats.eqDef} eq</span>`:''}</span></div>
      <div class="stat-row"><span class="sr-label">üö´ Block Chance</span><span class="sr-val" style="color:var(--armor)">${stats.blockChance}%</span></div>
      <div class="stat-row"><span class="sr-label">‚ù§Ô∏è Max HP</span><span class="sr-val" style="color:var(--hps)">${stats.maxHp}</span></div>
      <div class="stat-row"><span class="sr-label">Current HP</span><span class="sr-val" style="color:var(--green2)">${Math.floor(G.combat.playerHp)}</span></div>`;
  }
  const availEl=document.getElementById('equip-avail-grid');
  if(availEl){
    const equipItems=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&(ITEMS[id].cat==='weapon'||ITEMS[id].cat==='armor'||ITEMS[id].cat==='trinket'));
    if(equipItems.length===0){availEl.innerHTML='<div style="color:var(--text3);font-size:12px;grid-column:1/-1">No equipment in bank. Craft some at the smithery!</div>';}
    else{availEl.innerHTML=equipItems.map(([id,qty])=>{
      const item=ITEMS[id];
      let canEquip=true;
      let reqText='';
      if(item.reqAtk&&stats.baseAtkLv<item.reqAtk){canEquip=false;reqText+=`${item.reqAtk} Atk `;}
      if(item.reqStr&&stats.baseStrLv<item.reqStr){canEquip=false;reqText+=`${item.reqStr} Str `;}
      if(item.reqDef&&stats.baseDefLv<item.reqDef){canEquip=false;reqText+=`${item.reqDef} Def `;}
      return `<div class="ea-item${canEquip?'':' ea-locked'}" onclick="equipItemFromBank('${id}')">
        <div class="ea-icon">${item.icon}</div>
        <div class="ea-name">${item.name}</div>
        <div class="ea-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}${item.bonus?item.bonus:''}</div>
        ${reqText?`<div class="ea-req" style="color:var(--red2);font-size:10px">Req: ${reqText}</div>`:''}
        <div class="ea-qty">x${qty} in bank</div>
      </div>`;
    }).join('');}
  }
  
  // Render infusion options
  const infusionEl=document.getElementById('infusion-options');
  if(infusionEl){
    const infusableSlots=['weapon','helmet','body','legs','gloves','boots','shield'];
    const equippedInfusable=infusableSlots.filter(slot=>G.equipment[slot]);
    if(equippedInfusable.length===0){
      infusionEl.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:20px">Equip gear to begin infusion</div>';
    }else{
      const cardsHtml=equippedInfusable.map(slot=>{
        const itemId=G.equipment[slot];
        const item=ITEMS[itemId];
        const currentLevel=G.infusion[slot]||0;
        const nextLevel=currentLevel+1;
        const maxLevel=10;
        const canInfuse=nextLevel<=maxLevel;
        
        // NEW TIERED MATERIAL SYSTEM
        // Ranks 1-3: Item-tier bars (500 each) - Early game accessible
        // Ranks 4-6: Rune bars (1500 each) - Mid-game grind
        // Ranks 7-9: Dragon bars (3000 each) - Late game challenge
        // Rank 10: Infusion Crystal (1 each) - Ultra rare combat drop
        let materialId=null;
        let materialCost=0;
        
        if(nextLevel<=3){
          // Ranks 1-3: Use item's tier bars
          if(itemId.includes('bronze'))materialId='bronze_bar';
          else if(itemId.includes('iron'))materialId='iron_bar';
          else if(itemId.includes('silver'))materialId='silver_bar';
          else if(itemId.includes('steel'))materialId='steel_bar';
          else if(itemId.includes('mithril'))materialId='mithril_bar';
          else if(itemId.includes('adamant'))materialId='adamant_bar';
          else if(itemId.includes('rune'))materialId='rune_bar';
          else if(itemId.includes('dragon'))materialId='dragon_bar';
          materialCost=500;
        }else if(nextLevel<=6){
          // Ranks 4-6: Rune bars only
          materialId='rune_bar';
          materialCost=1500;
        }else if(nextLevel<=9){
          // Ranks 7-9: Dragon bars only
          materialId='dragon_bar';
          materialCost=3000;
        }else{
          // Rank 10: Infusion Crystal (ultra rare)
          materialId='infusion_crystal';
          materialCost=1;
        }
        
        const hasMaterial=materialId&&(G.bank[materialId]||0)>=materialCost;
        
        // Calculate bonuses
        const bonusText=getInfusionBonusText(slot,nextLevel);
        
        // Render rank progress
        const rankHtml=[];
        for(let i=1;i<=maxLevel;i++){
          rankHtml.push(`<div class="inf-rank${i<=currentLevel?' filled':''}">${i}</div>`);
        }
        
        // NEW GOLD COST SCALING
        // Ranks 1-3: 10K, 20K, 30K (60K total)
        // Ranks 4-6: 50K, 75K, 100K (225K total)
        // Ranks 7-9: 150K, 200K, 250K (600K total)
        // Rank 10: 500K
        // Total per slot: 1.385M gold (vs 275K before)
        let goldCost;
        if(nextLevel<=3){
          goldCost=nextLevel*10000; // 10K, 20K, 30K
        }else if(nextLevel<=6){
          goldCost=(nextLevel-3)*25000+25000; // 50K, 75K, 100K
        }else if(nextLevel<=9){
          goldCost=(nextLevel-6)*50000+100000; // 150K, 200K, 250K
        }else{
          goldCost=500000; // 500K for rank 10
        }
        const hasGold=G.gold>=goldCost;
        
        return `<div class="infusion-item">
          <div class="inf-header">
            <div class="inf-slot-name">${item.icon} ${slot.charAt(0).toUpperCase()+slot.slice(1)}</div>
            <div class="inf-level">+${currentLevel}</div>
          </div>
          <div class="inf-progress">${rankHtml.join('')}</div>
          ${canInfuse?`
            <div class="inf-cost">
              <div style="margin-bottom:4px">
                ${materialId?ITEMS[materialId]?.icon+' ':''}<span style="font-weight:600">${fmt(materialCost)}</span> ${materialId?ITEMS[materialId]?.name||materialId:''}
                <span style="color:var(--text3);font-size:10px;margin-left:6px">(have: <span data-ingredient-id="${materialId}">${fmt(G.bank[materialId]||0)}</span>)</span> 
                ${hasMaterial?'<span style="color:var(--green2)">‚úì</span>':'<span style="color:var(--red2)">‚úó</span>'}
              </div>
              <div>
                üí∞ <span style="font-weight:600;color:var(--gold2)">${fmt(goldCost)}gp</span>
                <span style="color:var(--text3);font-size:10px;margin-left:6px">(have: ${fmt(G.gold)}gp)</span>
                ${hasGold?'<span style="color:var(--green2)">‚úì</span>':'<span style="color:var(--red2)">‚úó</span>'}
              </div>
            </div>
            <div class="inf-bonus">Next: ${bonusText}</div>
            <button class="inf-button" ${!hasMaterial||!materialId||!hasGold?'disabled':''} onclick="infuseGear('${slot}','${materialId}',${materialCost},${goldCost})">Infuse to +${nextLevel}</button>
          `:`
            <div class="inf-max">‚ú® Maximum Infusion Reached ‚ú®</div>
            <div class="inf-bonus" style="margin-top:8px;color:var(--green2)">Current: ${getInfusionBonusText(slot,currentLevel)}</div>
          `}
        </div>`;
      }).join('');
      infusionEl.innerHTML=`<div class="infusion-grid">${cardsHtml}</div>`;
    }
  }
}

function getInfusionBonusText(slot,level){
  // Define bonus types per slot
  const bonuses={
    weapon:['Attack','Strength'],
    helmet:['Attack','Strength','Defense'],
    body:['Attack','Strength','Defense'],
    legs:['Attack','Strength','Defense'],
    gloves:['Hitpoints','Defense'],
    boots:['Haste','Defense'],
    shield:['Defense','Hitpoints']
  };
  const slotBonuses=bonuses[slot]||[];
  return `+${level}% ${slotBonuses.join(', ')}`;
}

function infuseGear(slot,materialId,materialCost,goldCost){
  const currentLevel=G.infusion[slot]||0;
  if(currentLevel>=10){
    notify('This gear is already at maximum infusion!','error');
    return;
  }
  
  // Check gold first
  if(G.gold<goldCost){
    notify(`Not enough gold! Need ${fmt(goldCost)}gp`,'error');
    return;
  }
  // Check materials
  if(!removeFromBank(materialId,materialCost)){
    notify('Not enough materials!','error');
    return;
  }
  // Deduct gold
  G.gold-=goldCost;
  G.infusion[slot]=(G.infusion[slot]||0)+1;
  const newLevel=G.infusion[slot];
  notify(`‚ú® ${slot.charAt(0).toUpperCase()+slot.slice(1)} infused to +${newLevel}!`,'success');
  renderEquipPage();
  renderSidebar(); // Update sidebar stats in real-time
  saveGame();
}

function openEquipModal(slot){
  const equipItems=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&ITEMS[id].slot===slot);
  const modal=document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent='Equip '+slot.charAt(0).toUpperCase()+slot.slice(1);
  const body=document.getElementById('modal-body');
  if(equipItems.length===0){body.innerHTML='<div style="color:var(--text3);padding:10px">No equipment of this type in your bank.</div>';}
  else{
    const stats=getPlayerStats();
    body.innerHTML=equipItems.map(([id,qty])=>{
      const item=ITEMS[id];
      let canEquip=true;
      let reqText='';
      if(item.reqAtk&&stats.baseAtkLv<item.reqAtk){canEquip=false;reqText+=`${item.reqAtk} Atk `;}
      if(item.reqStr&&stats.baseStrLv<item.reqStr){canEquip=false;reqText+=`${item.reqStr} Str `;}
      if(item.reqDef&&stats.baseDefLv<item.reqDef){canEquip=false;reqText+=`${item.reqDef} Def `;}
      return `<div class="equip-list-item${canEquip?'':' eli-locked'}" onclick="${canEquip?'equipItem(\''+id+'\');closeModal()':''}">
        <span class="eli-icon">${item.icon}</span>
        <div class="eli-info">
          <div class="eli-name">${item.name}</div>
          <div class="eli-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}${item.bonus?item.bonus:''}</div>
          ${reqText?`<div style="color:var(--red2);font-size:10px">Requires: ${reqText}</div>`:''}
        </div>
        <span class="eli-qty">x${qty}</span>
      </div>`;
    }).join('');
  }
  modal.classList.add('open');
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');}
function equipItem(id){
  const item=ITEMS[id];
  if(!item||!item.slot)return;
  if(!G.bank[id]||G.bank[id]<=0)return;
  
  // Check level requirements (use base levels, not infused)
  const stats=getPlayerStats();
  if(item.reqAtk){
    if(stats.baseAtkLv<item.reqAtk){
      notify(`Requires ${item.reqAtk} Attack to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqStr){
    if(stats.baseStrLv<item.reqStr){
      notify(`Requires ${item.reqStr} Strength to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqDef){
    if(stats.baseDefLv<item.reqDef){
      notify(`Requires ${item.reqDef} Defense to equip ${item.name}!`,'info');
      return;
    }
  }
  
  if(G.equipment[item.slot]){
    addToBank(G.equipment[item.slot],1);
  }
  removeFromBank(id,1);
  G.equipment[item.slot]=id;
  renderEquipPage();
  renderSidebar(); // Update sidebar stats in real-time
  updateHeader();
  notify(`Equipped ${item.name}!`,'item');
}
function equipItemFromBank(id){equipItem(id);}
function unequipItem(slot){
  if(!G.equipment[slot])return;
  const id=G.equipment[slot];
  addToBank(id,1);
  G.equipment[slot]=null;
  renderEquipPage();
  renderSidebar(); // Update sidebar stats in real-time
  updateHeader();
  notify(`Unequipped ${ITEMS[id].name}`,'info');
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function notify(msg,type='info'){
  const el=document.createElement('div');
  const cls={lvl:'notif-lvl',item:'notif-item',combat:'notif-combat',info:'notif-info'}[type]||'notif-info';
  el.className=`notif ${cls}`;
  el.textContent=msg;
  document.getElementById('notifs').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ============================================================
// OFFLINE BANNER
// ============================================================
function showOfflineBanner(banner){
  if(!banner)return;
  
  let contentHtml='';
  
  // Check if it's combat data
  if(banner.combat){
    const c=banner.combat;
    contentHtml=`<strong>‚öîÔ∏è Combat Results</strong><br>`;
    
    // Kills
    if(c.kills>0){
      contentHtml+=`<div style="margin-top:6px"><strong>üíÄ Defeated:</strong> ${c.kills}x ${c.monster}</div>`;
    }else{
      contentHtml+=`<div style="margin-top:6px"><strong>No enemies defeated</strong></div>`;
    }
    
    // Loot
    if(c.gold>0||Object.keys(c.loot).length>0){
      contentHtml+=`<div style="margin-top:4px"><strong>üí∞ Loot:</strong> `;
      const lootParts=[];
      if(c.gold>0)lootParts.push(`${fmt(c.gold)}gp`);
      for(const [itemId,qty] of Object.entries(c.loot)){
        lootParts.push(`${qty}x ${ITEMS[itemId].name}`);
      }
      contentHtml+=lootParts.join(', ')+'</div>';
    }
    
    // XP
    const xpParts=[];
    if(c.xp.combat>0)xpParts.push(`‚öîÔ∏è ${fmt(c.xp.combat)}`);
    if(c.xp.attack>0)xpParts.push(`üó°Ô∏è ${fmt(c.xp.attack)}`);
    if(c.xp.strength>0)xpParts.push(`üí™ ${fmt(c.xp.strength)}`);
    if(c.xp.defense>0)xpParts.push(`üõ°Ô∏è ${fmt(c.xp.defense)}`);
    if(c.xp.hitpoints>0)xpParts.push(`‚ù§Ô∏è ${fmt(c.xp.hitpoints)}`);
    if(xpParts.length>0){
      contentHtml+=`<div style="margin-top:4px"><strong>üìà XP:</strong> ${xpParts.join(', ')}</div>`;
    }
    
    // Levels
    if(Object.keys(c.levels).length>0){
      const lvlParts=[];
      for(const [skill,levelData] of Object.entries(c.levels)){
        const emoji={combat:'‚öîÔ∏è',attack:'üó°Ô∏è',strength:'üí™',defense:'üõ°Ô∏è',hitpoints:'‚ù§Ô∏è',haste:'‚ö°'}[skill]||'';
        lvlParts.push(`${emoji} ${skill.charAt(0).toUpperCase()+skill.slice(1)} ${levelData.start} ‚Üí ${levelData.end}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>üéâ Levels:</strong> ${lvlParts.join(', ')}</div>`;
    }
    
    // Food
    if(Object.keys(c.food).length>0){
      const foodParts=[];
      for(const [foodId,qty] of Object.entries(c.food)){
        foodParts.push(`${qty}x ${ITEMS[foodId].name}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>üçñ Food:</strong> ${foodParts.join(', ')}</div>`;
    }
    
    // Died warning
    if(c.died){
      contentHtml+=`<div style="margin-top:4px;color:var(--red2)"><strong>üíÄ You died!</strong> Combat stopped. Click "Start Combat" to resume.</div>`;
    }
    
  }else if(banner.skill){
    // Detailed skill results
    const s=banner.skill;
    const skillEmoji={
      woodcutting:'ü™ì',
      mining:'‚õèÔ∏è',
      fishing:'üé£',
      firemaking:'üî•',
      smithing:'üî®',
      cooking:'üç≥'
    }[s.skill]||'‚öôÔ∏è';
    
    contentHtml=`<strong>${skillEmoji} ${s.skill.charAt(0).toUpperCase()+s.skill.slice(1)} Results</strong><br>`;
    contentHtml+=`<div style="margin-top:6px"><strong>üìã Action:</strong> ${s.action}</div>`;
    
    // Materials used (for crafting skills)
    if(Object.keys(s.materialsUsed).length>0){
      const matParts=[];
      for(const [itemId,qty] of Object.entries(s.materialsUsed)){
        matParts.push(`${qty}x ${ITEMS[itemId]?.name||itemId}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>üì¶ Used:</strong> ${matParts.join(', ')}</div>`;
    }
    
    // Items produced
    if(Object.keys(s.itemsProduced).length>0){
      const prodParts=[];
      for(const [itemId,qty] of Object.entries(s.itemsProduced)){
        prodParts.push(`${qty}x ${ITEMS[itemId]?.name||itemId}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>‚ú® Produced:</strong> ${prodParts.join(', ')}</div>`;
    }
    
    // XP gained
    if(s.xpGained>0){
      contentHtml+=`<div style="margin-top:4px"><strong>üìà XP:</strong> ${fmt(s.xpGained)}</div>`;
    }
    
    // Levels gained
    if(s.endLevel>s.startLevel){
      contentHtml+=`<div style="margin-top:4px"><strong>üéâ Level:</strong> ${s.startLevel} ‚Üí ${s.endLevel}</div>`;
    }
    
  }else if(banner.results){
    // Legacy format (shouldn't happen anymore)
    contentHtml=`<strong>While you were gone:</strong> ${banner.results.join(', ')}!`;
  }else{
    contentHtml='Your character rested.';
  }
  
  const html=`<div class="offline-banner">
    <div class="ob-icon">‚è∞</div>
    <div class="ob-text">
      <strong>Welcome back!</strong> You were away for ${banner.time}.<br>
      ${contentHtml}
    </div>
    <button class="ob-close" onclick="this.parentElement.remove()">‚úï</button>
  </div>`;
  const content=document.getElementById('content');
  const temp=document.createElement('div');
  temp.innerHTML=html;
  const bannerEl=temp.firstChild;
  content.insertBefore(bannerEl,content.firstChild);
  
  // Auto-dismiss after 15 seconds (increased for detailed info)
  setTimeout(()=>{
    if(bannerEl&&bannerEl.parentElement){
      bannerEl.style.transition='opacity 0.3s';
      bannerEl.style.opacity='0';
      setTimeout(()=>bannerEl.remove(),300);
    }
  },15000);
}

// ============================================================
// CONTRACTS SYSTEM
// ============================================================
function generateContracts(){
  const contracts=[];
  const availableTemplates=CONTRACT_TEMPLATES.filter(t=>{
    const skillLv=xpToLevel(G.skills[t.skill]?.xp||0);
    return skillLv>=t.minLv;
  });
  
  // Pick 3-5 random contracts from available templates
  const numContracts=3+Math.floor(Math.random()*3);
  const shuffled=[...availableTemplates].sort(()=>Math.random()-0.5);
  for(let i=0;i<Math.min(numContracts,shuffled.length);i++){
    const template=shuffled[i];
    contracts.push({
      id:template.id+'_'+Date.now()+'_'+i,
      templateId:template.id,
      tier:template.tier,
      icon:template.icon,
      skill:template.skill,
      requirements:template.requirements,
      rewards:template.rewards,
      completed:false,
    });
  }
  return contracts;
}

function refreshContracts(){
  G.contracts=generateContracts();
  G.contractsLastRefresh=Date.now();
  renderContractsPage();
  notify('New contracts available!','info');
}

function canCompleteContract(contract){
  for(const req of contract.requirements){
    const have=G.bank[req.item]||0;
    if(have<req.qty)return false;
  }
  return true;
}

function completeContract(contractId){
  const contract=G.contracts.find(c=>c.id===contractId);
  if(!contract||contract.completed)return;
  if(!canCompleteContract(contract)){
    notify('Missing required items!','info');
    return;
  }
  
  // Remove required items
  for(const req of contract.requirements){
    removeFromBank(req.item,req.qty);
  }
  
  // Give rewards
  if(contract.rewards.gold){
    G.gold+=contract.rewards.gold;
  }
  if(contract.rewards.items){
    for(const item of contract.rewards.items){
      addToBank(item.id,item.qty);
      notify(`Received ${item.qty}x ${ITEMS[item.id].name}!`,'item');
    }
  }
  if(contract.rewards.xp&&G.skills[contract.skill]){
    G.skills[contract.skill].xp+=contract.rewards.xp;
  }
  
  contract.completed=true;
  updateHeader();
  renderContractsPage();
  renderSidebar();
  notify(`Contract completed! +${contract.rewards.gold}g`,'item');
  
  // Check if all completed
  if(G.contracts.every(c=>c.completed)){
    setTimeout(()=>refreshContracts(),1000);
  }
}

function renderContractsPage(){
  const grid=document.getElementById('contract-grid');
  const refreshTimer=document.getElementById('contract-refresh-timer');
  
  // Validate contracts - remove any with invalid items
  G.contracts=G.contracts.filter(contract=>{
    return contract.requirements.every(req=>ITEMS[req.item]!==undefined);
  });
  
  // Check if we need to generate initial contracts
  if(G.contracts.length===0){
    G.contracts=generateContracts();
    G.contractsLastRefresh=Date.now();
  }
  
  // Refresh timer
  const CONTRACT_REFRESH_HOURS=4;
  const nextRefresh=G.contractsLastRefresh+(CONTRACT_REFRESH_HOURS*60*60*1000);
  const timeUntil=nextRefresh-Date.now();
  const allCompleted=G.contracts.every(c=>c.completed);
  
  if(allCompleted){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">üîÑ All Complete! Get New Contracts</button>`;
  }else if(timeUntil<=0){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">üîÑ Refresh Available</button>`;
  }else{
    const hours=Math.floor(timeUntil/(60*60*1000));
    const mins=Math.floor((timeUntil%(60*60*1000))/(60*1000));
    refreshTimer.textContent=`Next refresh in ${hours}h ${mins}m, or complete all contracts`;
  }
  
  if(G.contracts.length===0){
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text3)">No contracts available. Check back later!</div>';
    return;
  }
  
  grid.innerHTML=G.contracts.map(contract=>{
    const template=CONTRACT_TEMPLATES.find(t=>t.id===contract.templateId);
    if(!template)return ''; // Safety check - skip if template not found
    const canComplete=canCompleteContract(contract);
    
    const reqHtml=contract.requirements.map(req=>{
      const item=ITEMS[req.item];
      if(!item){
        console.error('Invalid item in contract:',req.item);
        return `<div class="ct-req-item" style="color:var(--red2)">
          <span class="ct-req-icon">‚ùå</span>
          <span class="ct-req-name">Invalid item: ${req.item}</span>
          <span class="ct-req-progress incomplete">0/0</span>
        </div>`;
      }
      const have=G.bank[req.item]||0;
      const complete=have>=req.qty;
      return `<div class="ct-req-item">
        <span class="ct-req-icon">${item.icon}</span>
        <span class="ct-req-name">${item.name}</span>
        <span class="ct-req-progress ${complete?'complete':'incomplete'}">${have}/${req.qty}</span>
      </div>`;
    }).join('');
    
    const rewardParts=[];
    if(contract.rewards.gold)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">ü™ô</span><span class="ct-reward-val">${contract.rewards.gold}g</span></div>`);
    if(contract.rewards.xp)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">‚≠ê</span><span class="ct-reward-val">${contract.rewards.xp} XP</span></div>`);
    if(contract.rewards.items){
      contract.rewards.items.forEach(item=>{
        const it=ITEMS[item.id];
        if(it)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">${it.icon}</span><span class="ct-reward-val">${item.qty}x ${it.name}</span></div>`);
      });
    }
    
    return `<div class="contract-card ${contract.completed?'completed':''}">
      <div class="ct-header">
        <div class="ct-icon">${contract.icon}</div>
        <div class="ct-info">
          <div class="ct-title">${contract.skill.charAt(0).toUpperCase()+contract.skill.slice(1)} Contract</div>
          <div class="ct-tier">${contract.tier} Tier</div>
        </div>
      </div>
      <div class="ct-requirements">
        <div class="ct-req-title">Requirements</div>
        ${reqHtml}
      </div>
      <div class="ct-rewards">${rewardParts.join('')}</div>
      <div class="ct-actions">
        <button class="ct-btn ct-btn-complete" ${!canComplete||contract.completed?'disabled':''} onclick="completeContract('${contract.id}')">
          ${contract.completed?'‚úì Completed':'Complete Contract'}
        </button>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// MASTERY SHOP SYSTEM
// ============================================================
function getTotalMasteryPoints(){
  let total=0;
  for(const skill in G.skills){
    for(const actionId in G.skills[skill].masteryXp){
      const mx=G.skills[skill].masteryXp[actionId];
      const mlv=xpToLevel(mx);
      total+=mlv;
    }
  }
  // Subtract spent points
  for(const key in G.masteryUpgrades){
    total-=getMasteryUpgradeTotalCost(key);
  }
  return total;
}

function getMasteryUpgradeTotalCost(upgradeKey){
  const count=G.masteryUpgrades[upgradeKey]||0;
  const [skill,id]=upgradeKey.split('_',2);
  const fullId=upgradeKey.substring(skill.length+1); // Get the full upgrade ID after skill name
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===fullId);
  if(!upgrade)return 0;
  let total=0;
  for(let i=0;i<count;i++){
    total+=upgrade.cost+(i*50); // Each subsequent purchase costs +50 more
  }
  return total;
}

function purchaseMasteryUpgrade(skill,upgradeId){
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===upgradeId);
  if(!upgrade)return;
  
  const key=`${skill}_${upgradeId}`;
  const owned=G.masteryUpgrades[key]||0;
  
  if(owned>=upgrade.maxPurchases){
    notify('Already purchased maximum!','info');
    return;
  }
  
  const cost=upgrade.cost+(owned*50);
  const available=getTotalMasteryPoints();
  
  if(available<cost){
    notify('Not enough mastery points!','info');
    return;
  }
  
  G.masteryUpgrades[key]=(G.masteryUpgrades[key]||0)+1;
  renderMasteryShop();
  notify(`Purchased ${upgrade.name}!`,'item');
}

function getMasteryBonus(skill,bonusType){
  let bonus=0;
  const upgrades=MASTERY_UPGRADES[skill]||[];
  for(const upgrade of upgrades){
    const key=`${skill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    if(owned>0&&upgrade.id.includes(bonusType)){
      // Extract percentage from effect string
      const match=upgrade.effect.match(/(\d+)%/);
      if(match){
        bonus+=parseInt(match[1])*owned;
      }
    }
  }
  return bonus;
}

function renderMasteryShop(activeSkill='woodcutting'){
  const totalPoints=getTotalMasteryPoints();
  document.getElementById('ms-total-points').textContent=totalPoints;
  
  // Render tabs
  const tabs=document.getElementById('ms-tabs');
  const skillsWithUpgrades=Object.keys(MASTERY_UPGRADES);
  const skillIcons={
    woodcutting:'ü™ì',
    mining:'‚õèÔ∏è',
    fishing:'üé£',
    firemaking:'üî•',
    smithing:'üî®',
    cooking:'üç≥',
    combat:'‚öîÔ∏è'
  };
  tabs.innerHTML=skillsWithUpgrades.map(skill=>{
    const icon=skillIcons[skill]||'‚öôÔ∏è';
    return `<div class="ms-tab ${skill===activeSkill?'active':''}" onclick="renderMasteryShop('${skill}')">
      <span class="ms-tab-icon">${icon}</span>
      ${skill.charAt(0).toUpperCase()+skill.slice(1)}
    </div>`;
  }).join('');
  
  // Render upgrades for active skill
  const grid=document.getElementById('upgrade-grid');
  const upgrades=MASTERY_UPGRADES[activeSkill]||[];
  const skillLv=xpToLevel(G.skills[activeSkill]?.xp||0);
  
  grid.innerHTML=upgrades.map(upgrade=>{
    const key=`${activeSkill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    const cost=upgrade.cost+(owned*50);
    const canAfford=totalPoints>=cost;
    const maxedOut=owned>=upgrade.maxPurchases;
    
    const effectText=upgrade.stackEffect?upgrade.stackEffect(owned+1):upgrade.effect;
    
    return `<div class="upgrade-card ${maxedOut?'purchased':''}">
      <div class="up-header">
        <div class="up-icon">${upgrade.id.includes('yield')?'üìà':upgrade.id.includes('speed')?'‚ö°':upgrade.id.includes('xp')?'‚≠ê':upgrade.id.includes('mastery')?'üåü':'üíé'}</div>
        <div class="up-info">
          <div class="up-name">${upgrade.name}</div>
          <div class="up-desc">${upgrade.desc}</div>
          ${owned>0?`<div class="up-owned">Owned: ${owned}/${upgrade.maxPurchases} - Current: ${upgrade.stackEffect(owned)}</div>`:''}
          ${!maxedOut?`<div class="up-effect">Next: ${effectText}</div>`:''}
        </div>
      </div>
      <div class="up-footer">
        <div class="up-cost">
          <span class="up-cost-icon">‚≠ê</span>
          <span class="up-cost-val">${cost}</span>
        </div>
        ${maxedOut?
          `<div class="up-purchased">‚úì Maxed</div>`:
          `<button class="up-btn" ${!canAfford?'disabled':''} onclick="purchaseMasteryUpgrade('${activeSkill}','${upgrade.id}')">
            Purchase
          </button>`
        }
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// GENERAL STORE
// ============================================================
let currentStoreCategory='all'; // Track selected category

function renderStore(category='all'){
  if(currentPage!=='store')return;
  currentStoreCategory=category; // Save for re-render after purchase
  
  // Update gold display
  const goldEl=document.getElementById('store-gold');
  if(goldEl)goldEl.textContent=fmt(G.gold)+'gp';
  
  // Render category buttons
  const categories=[
    {id:'all',name:'All Items',icon:'üè™'},
    {id:'food',name:'Food',icon:'üçñ'},
    {id:'bars',name:'Bars',icon:'üî©'},
    {id:'gear',name:'Gear',icon:'‚öîÔ∏è'}
  ];
  
  const catEl=document.getElementById('store-categories');
  if(catEl){
    catEl.innerHTML=categories.map(c=>{
      const active=category===c.id?'active':'';
      return `<button class="store-cat-btn ${active}" onclick="renderStore('${c.id}')">${c.icon} ${c.name}</button>`;
    }).join('');
  }
  
  // Filter items by category
  const items=category==='all'?STORE_ITEMS:STORE_ITEMS.filter(i=>i.category===category);
  
  // Render store items
  const gridEl=document.getElementById('store-grid');
  if(gridEl){
    if(items.length===0){
      gridEl.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:40px">No items in this category</div>`;
      return;
    }
    
    gridEl.innerHTML=items.map(storeItem=>{
      const item=ITEMS[storeItem.id];
      if(!item)return '';
      
      const canBuy1=G.gold>=storeItem.price;
      const canBuy10=G.gold>=(storeItem.price*10);
      const canBuy100=G.gold>=(storeItem.price*100);
      const canBuy1000=G.gold>=(storeItem.price*1000);
      const desc=item.heals?`Heals ${item.heals} HP`:(item.cat==='bar'?'Processed bar':'Equipment');
      
      return `<div class="store-item">
        <div class="si-header">
          <div class="si-icon">${item.icon}</div>
          <div class="si-info">
            <div class="si-name">${item.name}</div>
            <div class="si-desc">${desc}</div>
          </div>
        </div>
        <div class="si-price">üí∞ ${fmt(storeItem.price)}gp each</div>
        <div class="si-stock">In Stock: ${storeItem.stock}</div>
        <div class="si-owned" style="font-size:11px;color:var(--text3);margin-top:2px">Owned: <span data-item-id="${storeItem.id}">${fmt(G.bank[storeItem.id]||0)}</span></div>
        <div class="si-buy-area">
          <button class="si-buy-btn" ${canBuy1?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},1)">
            Buy 1
          </button>
          <button class="si-buy-btn" ${canBuy10?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},10)">
            Buy 10
          </button>
          <button class="si-buy-btn" ${canBuy100?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},100)">
            Buy 100
          </button>
          <button class="si-buy-btn" ${canBuy1000?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},1000)">
            Buy 1K
          </button>
        </div>
      </div>`;
    }).join('');
  }
}

function buyStoreItem(itemId,price,qty){
  const totalCost=price*qty;
  
  if(G.gold<totalCost){
    notify('Not enough gold!','error');
    return;
  }
  
  G.gold-=totalCost;
  addToBank(itemId,qty);
  
  const item=ITEMS[itemId];
  const qtyText=qty>1?`${qty}x `:'';
  notify(`Purchased ${qtyText}${item.icon} ${item.name} for ${fmt(totalCost)}gp!`,'success');
  
  renderStore(currentStoreCategory); // Preserve category selection
  updateHeader();
  saveGame();
}

// ============================================================
// INIT
// ============================================================
async function init(){
  const loaded=await loadGame();
  if(loaded&&G.offlineBanner){showOfflineBanner(G.offlineBanner);G.offlineBanner=null;}
  // Init combat HP
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0||G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  showPage('woodcutting');
  updateHeader();
  updateActiveActionDisplay();
  renderSidebar();
  if(!loaded)notify('Welcome to Grindia! Click a skill on the left to begin.','info');
}
window.addEventListener('beforeunload',()=>saveGame());
init();
</script>
</body>
</html>
