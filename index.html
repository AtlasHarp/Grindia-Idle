<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grindia Idle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Exo+2:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0a0c10;--bg2:#0f1318;--bg3:#161c24;--bg4:#1e2530;
  --border:#252d3a;--border2:#2e3a4a;
  --text:#c8d4e0;--text2:#8fa3b8;--text3:#4a6070;
  --gold:#d4aa3a;--gold2:#f0cc5a;
  --blue:#3a8cd4;--blue2:#5aadff;
  --green:#2ea855;--green2:#4fd472;
  --red:#c03030;--red2:#e85050;
  --purple:#7a40d4;--purple2:#9a60f4;
  --xp:#1a6bc4;--mastery:#c4820a;
  --crit:#e0503a;--power:#d46a20;--haste:#2abacc;--armor:#5a8fd4;--hps:#3aaa5a;
}
body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;font-size:13px;height:100vh;display:flex;flex-direction:column;overflow:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(58,140,212,0.04) 0%,transparent 60%),radial-gradient(ellipse at 80% 80%,rgba(212,170,58,0.04) 0%,transparent 60%);pointer-events:none;z-index:0}

/* HEADER */
#header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 16px;height:50px;display:flex;align-items:center;gap:12px;flex-shrink:0;position:relative;z-index:10}
#active-action-display{position:absolute;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--green);border-radius:6px;padding:4px 12px;display:none;align-items:center;gap:8px;font-size:11px;color:var(--green2);font-weight:500;letter-spacing:0.3px}
#active-action-display.visible{display:flex}
#active-action-display .aad-icon{font-size:14px}
#active-action-display .aad-dot{width:6px;height:6px;background:var(--green2);border-radius:50%;animation:pulse 1.5s infinite}
#header h1{font-family:'Cinzel',serif;font-size:20px;color:var(--gold);letter-spacing:2px;text-shadow:0 0 20px rgba(212,170,58,0.4);white-space:nowrap}
.h-divider{width:1px;height:28px;background:var(--border);flex-shrink:0}
.h-stat{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:4px 10px;white-space:nowrap}
.h-stat .hs-label{color:var(--text3);font-size:10px;font-weight:300;letter-spacing:.5px;text-transform:uppercase}
.h-stat .hs-val{color:var(--text);font-weight:600;font-family:'Share Tech Mono',monospace;font-size:13px}
.h-stat .hs-icon{font-size:14px}
#header .spacer{flex:1}
.hdr-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:5px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;letter-spacing:.5px}
.hdr-btn:hover{background:var(--bg4);border-color:var(--border2);color:var(--text)}

/* MAIN LAYOUT */
#main{display:flex;flex:1;overflow:hidden;position:relative;z-index:1}
#sidebar{width:168px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column}
.nav-section{padding:6px 0}
.nav-group-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);padding:6px 12px 3px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:9px;padding:7px 12px;cursor:pointer;border-left:2px solid transparent;transition:all .12s}
.nav-item:hover{background:var(--bg3)}
.nav-item.active{background:var(--bg3);border-left-color:var(--gold)}
.nav-item .ni-icon{font-size:15px;width:18px;text-align:center;flex-shrink:0}
.nav-item .ni-info{flex:1;min-width:0}
.nav-item .ni-name{font-size:12px;font-weight:500;color:var(--text)}
.nav-item .ni-level{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;display:flex;gap:4px;align-items:center;margin-top:1px}
.mini-bar{height:2px;background:var(--bg4);border-radius:1px;margin-top:2px;overflow:hidden}
.mini-bar-fill{height:100%;border-radius:1px;transition:width .4s}
.mini-bar-xp .mini-bar-fill{background:var(--xp)}
.nav-divider{height:1px;background:var(--border);margin:4px 0}

/* CONTENT */
#content{flex:1;overflow-y:auto;padding:16px}
.page{display:none}
.page.active{display:block}

.pg-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:16px;padding-bottom:12px;border-bottom:1px solid var(--border)}
.pg-icon{font-size:36px;line-height:1;margin-top:2px}
.pg-title h2{font-family:'Cinzel',serif;font-size:17px;color:var(--gold);font-weight:600}
.pg-xp-area{margin-top:6px;display:flex;flex-direction:column;gap:3px}
.xp-row{display:flex;align-items:center;gap:8px}
.xp-label{font-size:10px;color:var(--text3);width:50px;flex-shrink:0}
.xp-bar{flex:1;height:7px;background:var(--bg4);border-radius:4px;overflow:hidden;min-width:120px}
.xp-bar-fill{height:100%;border-radius:4px;transition:width .3s}
.xp-fill-blue{background:linear-gradient(90deg,var(--xp),var(--blue2))}
.xp-fill-gold{background:linear-gradient(90deg,var(--mastery),var(--gold2))}
.xp-txt{font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap}

.action-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:10px;margin-bottom:16px}
.action-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.action-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02) 0%,transparent 100%);pointer-events:none}
.action-card:hover:not(.locked){border-color:var(--border2);background:var(--bg3)}
.action-card.active-action{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.08) 0%,var(--bg2) 100%)}
.action-card.locked{opacity:.45;cursor:not-allowed}
.ac-head{display:flex;align-items:center;gap:8px;margin-bottom:8px}
.ac-icon{font-size:22px}
.ac-name{font-weight:600;font-size:13px;flex:1}
.ac-lock{font-size:10px;background:var(--bg4);border:1px solid var(--border);border-radius:4px;padding:1px 6px;color:var(--text3)}
.ac-stats{font-size:11px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr;gap:2px 8px}
.ac-stat span{color:var(--text)}
.ac-mastery{margin-top:8px;border-top:1px solid var(--border);padding-top:6px}
.ac-m-row{display:flex;justify-content:space-between;margin-bottom:2px;font-size:10px;color:var(--text3)}
.ac-m-row span{color:var(--mastery)}
.ac-m-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.ac-m-fill{height:100%;background:linear-gradient(90deg,var(--mastery),var(--gold2));border-radius:2px;transition:width .3s}
.active-dot{position:absolute;top:8px;right:8px;width:7px;height:7px;background:var(--green2);border-radius:50%;box-shadow:0 0 6px var(--green2);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}

.cur-action{background:var(--bg2);border:1px solid var(--green);border-radius:8px;padding:10px 14px;margin-bottom:14px;display:flex;align-items:center;gap:12px}
.ca-label{font-size:11px;color:var(--text2);white-space:nowrap}
.ca-name{font-weight:600;color:var(--green2);flex:1}
.ca-prog-wrap{flex:1;max-width:180px}
.ca-prog-bar{height:5px;background:var(--bg4);border-radius:3px;overflow:hidden}
.ca-prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--green2));border-radius:3px;transition:width .1s linear}
.ca-stop{background:transparent;border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;transition:all .15s;font-family:'Exo 2',sans-serif}
.ca-stop:hover{border-color:var(--red);color:var(--red2)}

/* BANK */
.bank-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.bank-gold{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600;color:var(--gold2);font-family:'Share Tech Mono',monospace}
.bank-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:8px}
.b-item{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:8px;text-align:center;cursor:pointer;transition:all .15s;position:relative}
.b-item:hover{border-color:var(--gold);background:var(--bg3)}
.b-icon{font-size:26px;margin-bottom:3px;line-height:1.2}
.b-name{font-size:9px;color:var(--text3);margin-bottom:2px;line-height:1.3}
.b-qty{font-size:12px;font-weight:600;color:var(--text);font-family:'Share Tech Mono',monospace}
.b-val{font-size:9px;color:var(--gold);margin-top:1px}
.b-sell-menu{position:absolute;top:4px;right:4px;display:none;flex-direction:column;gap:2px;z-index:10}
.b-item:hover .b-sell-menu{display:flex}
.b-sell-btn{background:var(--bg4);border:1px solid var(--border);color:var(--text3);border-radius:4px;padding:2px 6px;font-size:9px;cursor:pointer;font-family:'Exo 2',sans-serif;transition:all .15s;white-space:nowrap}
.b-sell-btn:hover{background:var(--gold);border-color:var(--gold2);color:var(--bg1);transform:translateX(-2px)}
.b-sell-all{background:rgba(192,48,48,.2);border-color:var(--red);color:var(--red2)}
.b-sell-all:hover{background:var(--red);border-color:var(--red2);color:#fff}
.bank-empty{color:var(--text3);text-align:center;padding:40px;font-style:italic}
.bank-cats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:12px}
.bcat-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s}
.bcat-btn.active{background:var(--bg4);border-color:var(--blue);color:var(--blue2)}

/* COMBAT */
.combat-layout{display:grid;grid-template-columns:1fr 220px;gap:14px}
.combat-arena{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px}
.combatants{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:12px}
.combatant{text-align:center}
.comb-name{font-weight:600;font-size:13px;margin-bottom:6px}
.comb-hp-label{font-size:10px;color:var(--text3);margin-bottom:3px;font-family:'Share Tech Mono',monospace}
.hp-bar-wrap{height:10px;background:var(--bg4);border-radius:5px;overflow:hidden;margin-bottom:4px}
.hp-fill{height:100%;border-radius:5px;transition:width .3s}
.hp-fill-player{background:linear-gradient(90deg,var(--green),var(--green2))}
.hp-fill-monster{background:linear-gradient(90deg,var(--red),var(--red2))}
.vs-badge{background:var(--bg3);border:1px solid var(--border);border-radius:50%;width:34px;height:34px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:11px;color:var(--text3);flex-shrink:0}
.combat-log{max-height:130px;overflow-y:auto;font-size:11px;background:var(--bg3);border-radius:6px;padding:8px;margin-bottom:10px;line-height:1.6}
.clog-p{color:var(--text3)}
.clog-hit{color:var(--red2)}
.clog-mhit{color:var(--blue2)}
.clog-kill{color:var(--gold2);font-weight:600}
.clog-loot{color:var(--green2)}
.clog-heal{color:#4ade80;font-weight:600}
.clog-eat{color:var(--purple2)}
.clog-die{color:var(--red);font-weight:600}
.combat-btns{display:flex;gap:8px}
.btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:6px 14px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:all .15s;letter-spacing:.3px}
.btn:hover{background:var(--bg4);border-color:var(--border2)}
.btn-green{background:rgba(46,168,85,.15);border-color:var(--green);color:var(--green2)}
.btn-green:hover{background:rgba(46,168,85,.25)}
.btn-red{background:rgba(192,48,48,.15);border-color:var(--red);color:var(--red2)}
.btn-red:hover{background:rgba(192,48,48,.25)}
.btn-gold{background:rgba(212,170,58,.15);border-color:var(--gold);color:var(--gold2)}
.btn-gold:hover{background:rgba(212,170,58,.25)}
.food-btn{background:var(--bg3);border:1px solid var(--green);color:var(--text);padding:8px 12px;border-radius:6px;cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:all .15s;letter-spacing:.3px;margin-right:8px}
.food-btn:hover{background:rgba(46,168,85,.15);border-color:var(--green2);transform:translateY(-1px)}
.food-btn:active{transform:translateY(0px)}
.monster-select{display:flex;flex-direction:column;gap:8px;max-height:calc(100vh - 280px);overflow-y:auto;padding-right:4px}
.monster-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:10px;cursor:pointer;transition:all .15s}
.monster-card:hover:not(.m-locked){border-color:var(--red)}
.monster-card.m-selected{border-color:var(--red);background:rgba(192,48,48,.08)}
.monster-card.m-locked{opacity:.4;cursor:not-allowed}
.mc-head{display:flex;align-items:center;gap:8px;margin-bottom:5px}
.mc-icon{font-size:20px}
.mc-name{font-weight:600;font-size:12px}
.mc-level{font-size:10px;color:var(--text3);margin-left:auto;font-family:'Share Tech Mono',monospace}
.mc-stats{font-size:10px;color:var(--text2);display:flex;gap:8px;flex-wrap:wrap}
.mc-stat span{color:var(--red2)}
.mc-loot{font-size:9px;color:var(--text3);margin-top:3px}

/* EQUIPMENT */
.equip-layout{display:grid;grid-template-columns:240px 1fr;gap:16px}
.equip-slots{display:flex;flex-direction:column;gap:8px}
.equip-row{display:flex;gap:8px;justify-content:center}
.equip-slot{background:var(--bg2);border:1px dashed var(--border);border-radius:8px;padding:10px;min-width:100px;min-height:70px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;transition:all .15s;position:relative}
.equip-slot:hover{border-color:var(--gold)}
.equip-slot.filled{border-style:solid;border-color:var(--blue)}
.es-label{font-size:9px;color:var(--text3);text-transform:uppercase;letter-spacing:.8px;margin-bottom:4px}
.es-icon{font-size:24px;line-height:1}
.es-name{font-size:10px;color:var(--text);margin-top:3px;font-weight:500}
.es-stat{font-size:10px;color:var(--green2);margin-top:1px}
.es-empty{font-size:10px;color:var(--text3);font-style:italic}
.es-unequip{position:absolute;top:3px;right:3px;background:var(--bg4);border:1px solid var(--border);border-radius:3px;padding:1px 4px;font-size:8px;cursor:pointer;display:none;color:var(--red2);font-family:'Exo 2',sans-serif}
.equip-slot.filled:hover .es-unequip{display:block}
.stats-display{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px}
.stats-display h3{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.stat-row{display:flex;justify-content:space-between;padding:5px 0;border-bottom:1px solid var(--bg3)}
.stat-row:last-child{border:none}
.sr-label{color:var(--text2);display:flex;align-items:center;gap:6px}
.sr-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--text)}
.sr-bonus{font-size:10px;color:var(--green2);margin-left:4px}
.equip-available{margin-top:14px}
.equip-avail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:8px;margin-top:8px}
.ea-item{background:var(--bg2);border:1px solid var(--border);border-radius:7px;padding:8px;cursor:pointer;text-align:center;transition:all .15s}
.ea-item:hover{border-color:var(--gold);background:var(--bg3)}
.ea-icon{font-size:20px;margin-bottom:3px}
.ea-name{font-size:10px;font-weight:500;color:var(--text);margin-bottom:2px}
.ea-stat{font-size:10px;color:var(--green2)}
.ea-qty{font-size:9px;color:var(--text3);font-family:'Share Tech Mono',monospace}
.ea-locked{opacity:0.5;cursor:not-allowed}
.ea-locked:hover{border-color:var(--border);background:var(--bg2)}

/* PRODUCTION SKILLS */
.production-info{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:12px;margin-bottom:12px;font-size:12px;color:var(--text2);line-height:1.6}
.ingredient{display:inline-flex;align-items:center;gap:4px;margin:2px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:4px;padding:2px 7px;font-size:11px}
.ingredient.missing{border-color:var(--red);color:var(--red2)}
.ingredient.ok{border-color:var(--green);color:var(--green2)}

/* NOTIFICATIONS */
#notifs{position:fixed;top:58px;right:12px;z-index:200;display:flex;flex-direction:column;gap:6px;pointer-events:none;align-items:flex-end}
.notif{background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:7px 12px;font-size:12px;animation:notifIn .2s ease,notifOut .3s ease 2.5s forwards;max-width:220px;font-weight:500}
.notif-lvl{border-color:var(--gold);color:var(--gold2)}
.notif-item{border-color:var(--green);color:var(--green2)}
.notif-combat{border-color:var(--red);color:var(--red2)}
.notif-info{border-color:var(--blue);color:var(--blue2)}
@keyframes notifIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes notifOut{to{transform:translateX(15px);opacity:0}}

/* OFFLINE BANNER */
.offline-banner{background:linear-gradient(135deg,rgba(46,168,85,.1),rgba(26,107,196,.1));border:1px solid var(--green);border-radius:8px;padding:12px 16px;margin-bottom:16px;display:flex;align-items:center;gap:12px}
.ob-icon{font-size:24px}
.ob-text{flex:1;font-size:12px;line-height:1.6}
.ob-text strong{color:var(--green2)}
.ob-close{background:none;border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:5px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif}

/* SECTION TITLES */
.sec-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin:14px 0 8px;padding-bottom:5px;border-bottom:1px solid var(--border)}

/* TOOLTIPS */
.tooltip-wrap{position:relative;display:inline-block}
.tooltip-box{visibility:hidden;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:6px 10px;white-space:nowrap;font-size:11px;z-index:50;pointer-events:none}
.tooltip-wrap:hover .tooltip-box{visibility:visible}

/* CONTRACTS */
.contract-refresh{text-align:center;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-bottom:12px;font-size:11px;color:var(--text2)}
.contract-grid{display:grid;gap:10px}
.contract-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;transition:all .15s;position:relative}
.contract-card.completed{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.08) 0%,var(--bg2) 100%)}
.contract-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02) 0%,transparent 100%);pointer-events:none}
.ct-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.ct-icon{font-size:28px}
.ct-info{flex:1}
.ct-title{font-weight:600;font-size:14px;color:var(--gold);margin-bottom:2px}
.ct-tier{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.ct-requirements{background:var(--bg3);border:1px solid var(--border);border-radius:6px;padding:8px;margin-bottom:10px}
.ct-req-title{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px}
.ct-req-item{display:flex;align-items:center;gap:6px;padding:4px;font-size:12px}
.ct-req-icon{font-size:16px;flex-shrink:0}
.ct-req-name{flex:1;color:var(--text)}
.ct-req-progress{font-family:'Share Tech Mono',monospace;font-size:11px}
.ct-req-progress.complete{color:var(--green2)}
.ct-req-progress.incomplete{color:var(--text3)}
.ct-rewards{display:flex;align-items:center;gap:12px;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:6px;margin-bottom:10px}
.ct-reward{display:flex;align-items:center;gap:5px;font-size:12px}
.ct-reward-icon{font-size:16px}
.ct-reward-val{font-weight:600;font-family:'Share Tech Mono',monospace}
.ct-actions{display:flex;gap:6px}
.ct-btn{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;font-weight:500}
.ct-btn:hover{background:var(--bg4);border-color:var(--border2)}
.ct-btn-complete{border-color:var(--green);color:var(--green2)}
.ct-btn-complete:hover{background:var(--green);color:var(--bg);border-color:var(--green2)}
.ct-btn-complete:disabled{opacity:0.5;cursor:not-allowed;background:var(--bg3);color:var(--text3)}
.ct-btn-complete:disabled:hover{background:var(--bg3);color:var(--text3);border-color:var(--border)}

/* MASTERY SHOP */
.mastery-total{text-align:center;background:var(--bg3);border:1px solid var(--gold);border-radius:8px;padding:12px;margin-bottom:16px}
.mt-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px}
.mt-value{font-size:32px;font-weight:700;font-family:'Cinzel',serif;color:var(--mastery);text-shadow:0 0 20px rgba(196,130,10,0.4)}
.mt-sub{font-size:11px;color:var(--text3);margin-top:4px}
.mastery-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.ms-tab{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 12px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;display:flex;align-items:center;gap:6px}
.ms-tab:hover{background:var(--bg4)}
.ms-tab.active{background:var(--bg4);border-color:var(--mastery);color:var(--gold2)}
.ms-tab-icon{font-size:14px}
.upgrade-grid{display:grid;gap:10px}
.upgrade-card{background:var(--bg2);border:1px solid var(--border);border-radius:8px;padding:14px;transition:all .15s;position:relative}
.upgrade-card.purchased{border-color:var(--green);opacity:0.7}
.upgrade-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02) 0%,transparent 100%);pointer-events:none}
.up-header{display:flex;align-items:flex-start;gap:10px;margin-bottom:10px}
.up-icon{font-size:26px;margin-top:2px}
.up-info{flex:1}
.up-name{font-weight:600;font-size:14px;color:var(--gold);margin-bottom:4px}
.up-desc{font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:6px}
.up-effect{font-size:12px;color:var(--green2);font-weight:500;background:rgba(46,168,85,0.1);border-radius:4px;padding:4px 8px;display:inline-block;margin-bottom:6px}
.up-footer{display:flex;align-items:center;justify-content:space-between;gap:10px}
.up-cost{display:flex;align-items:center;gap:5px;font-size:12px;font-weight:600}
.up-cost-icon{font-size:16px;color:var(--mastery)}
.up-cost-val{font-family:'Share Tech Mono',monospace;color:var(--mastery)}
.up-level{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3)}
.up-level.met{color:var(--green2)}
.up-btn{background:var(--bg3);border:1px solid var(--mastery);color:var(--gold2);padding:6px 16px;border-radius:6px;cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:all .15s;font-weight:600}
.up-btn:hover{background:var(--mastery);color:var(--bg);border-color:var(--gold2)}
.up-btn:disabled{opacity:0.5;cursor:not-allowed;background:var(--bg3);color:var(--text3);border-color:var(--border)}
.up-btn:disabled:hover{background:var(--bg3);color:var(--text3);border-color:var(--border)}
.up-purchased{background:var(--green);color:var(--bg);border:1px solid var(--green2);padding:6px 16px;border-radius:6px;font-size:11px;font-weight:600;cursor:default}
.up-owned{font-size:10px;color:var(--green2);margin-top:4px;font-family:'Share Tech Mono',monospace}


/* SCROLLBAR */
::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

/* STATS PAGE */
.stats-page-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.stats-section{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:14px}
.stats-section h3{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px}
.skill-overview-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sog-item{display:flex;align-items:center;gap:8px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;padding:7px 10px;cursor:pointer;transition:all .12s}
.sog-item:hover{border-color:var(--gold);background:var(--bg4)}
.sog-icon{font-size:18px;width:22px;text-align:center;flex-shrink:0}
.sog-info{flex:1;min-width:0}
.sog-name{font-size:11px;font-weight:500;color:var(--text2)}
.sog-level{font-size:16px;font-weight:700;font-family:'Share Tech Mono',monospace;color:var(--text);line-height:1}
.sog-xp-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:3px;overflow:hidden}
.sog-xp-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--xp),var(--blue2))}
.combat-stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:8px;padding:12px;text-align:center;position:relative;overflow:hidden}
.combat-stat-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent);pointer-events:none}
.csc-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-bottom:10px}
.csc-icon{font-size:24px;margin-bottom:4px}
.csc-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:2px}
.csc-value{font-size:18px;font-weight:700;font-family:'Share Tech Mono',monospace;line-height:1}
.csc-sublabel{font-size:9px;color:var(--text3);margin-top:2px}
.csc-level{font-size:10px;color:var(--text3);margin-top:4px}
.csc-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:4px;overflow:hidden}
.csc-bar-fill{height:100%;border-radius:2px;transition:width .4s}
.total-level-display{text-align:center;padding:12px;background:var(--bg3);border:1px solid var(--gold);border-radius:8px;margin-bottom:12px}
.tld-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.tld-value{font-size:36px;font-weight:700;font-family:'Cinzel',serif;color:var(--gold);text-shadow:0 0 20px rgba(212,170,58,0.4);line-height:1.2}
.tld-sub{font-size:11px;color:var(--text3);margin-top:2px}
.combat-nav-badge{font-size:9px;background:var(--bg4);border:1px solid var(--border);border-radius:3px;padding:1px 5px;color:var(--text3);font-family:'Share Tech Mono',monospace;margin-left:auto}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:300;align-items:center;justify-content:center}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:1px solid var(--border);border-radius:10px;padding:20px;min-width:300px;max-width:420px;max-height:80vh;display:flex;flex-direction:column;gap:12px}
.modal h3{font-family:'Cinzel',serif;color:var(--gold);font-size:15px}
.modal-body{overflow-y:auto;flex:1}
.modal-footer{display:flex;gap:8px;justify-content:flex-end}
.equip-list-item{display:flex;align-items:center;gap:10px;padding:8px;background:var(--bg3);border:1px solid var(--border);border-radius:7px;cursor:pointer;transition:all .15s;margin-bottom:6px}
.equip-list-item:hover{border-color:var(--gold)}
.eli-icon{font-size:20px}
.eli-info{flex:1}
.eli-name{font-size:12px;font-weight:600}
.eli-stat{font-size:10px;color:var(--green2)}
.eli-qty{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace}
.eli-locked{opacity:0.5;cursor:not-allowed}
.eli-locked:hover{border-color:var(--border)}
.sell-all-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:8px}
</style>
</head>
<body>

<div id="header">
  <h1>‚öî GRINDIA</h1>
  <div class="h-divider"></div>
  <div id="active-action-display">
    <span class="aad-dot"></span>
    <span class="aad-icon" id="aad-icon">‚öíÔ∏è</span>
    <span id="aad-text">Mining Copper</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">ü™ô</span>
    <span class="hs-label">Gold</span>
    <span class="hs-val" id="hdr-gold">0</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">‚ù§Ô∏è</span>
    <span class="hs-label">HP</span>
    <span class="hs-val" id="hdr-hp">10/10</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">‚öîÔ∏è</span>
    <span class="hs-label">Crit</span>
    <span class="hs-val" id="hdr-atk">5%</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">üõ°Ô∏è</span>
    <span class="hs-label">Armor</span>
    <span class="hs-val" id="hdr-def">0</span>
  </div>
  <div class="spacer"></div>
  <button class="hdr-btn" onclick="exportSave()" title="Download save file">üíæ Export</button>
  <button class="hdr-btn" onclick="importSave()" title="Load save file">üìÇ Import</button>
  <button class="hdr-btn" onclick="manualSave()">üíæ Save</button>
</div>

<div id="main">
  <div id="sidebar" id="sidebar">
    <div class="nav-section">
      <div class="nav-group-title">Gathering</div>
      <div class="nav-item" onclick="showPage('woodcutting')" id="nav-woodcutting">
        <span class="ni-icon">ü™ì</span>
        <div class="ni-info">
          <div class="ni-name">Woodcutting</div>
          <div class="ni-level"><span id="sl-woodcutting">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-woodcutting" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('mining')" id="nav-mining">
        <span class="ni-icon">‚õèÔ∏è</span>
        <div class="ni-info">
          <div class="ni-name">Mining</div>
          <div class="ni-level"><span id="sl-mining">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-mining" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('fishing')" id="nav-fishing">
        <span class="ni-icon">üé£</span>
        <div class="ni-info">
          <div class="ni-name">Fishing</div>
          <div class="ni-level"><span id="sl-fishing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-fishing" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Production</div>
      <div class="nav-item" onclick="showPage('firemaking')" id="nav-firemaking">
        <span class="ni-icon">üî•</span>
        <div class="ni-info">
          <div class="ni-name">Firemaking</div>
          <div class="ni-level"><span id="sl-firemaking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-firemaking" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('smithing')" id="nav-smithing">
        <span class="ni-icon">üî®</span>
        <div class="ni-info">
          <div class="ni-name">Smithing</div>
          <div class="ni-level"><span id="sl-smithing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-smithing" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('cooking')" id="nav-cooking">
        <span class="ni-icon">üç≥</span>
        <div class="ni-info">
          <div class="ni-name">Cooking</div>
          <div class="ni-level"><span id="sl-cooking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-cooking" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Combat Skills</div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-attack">
        <span class="ni-icon">üó°Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Attack</div>
          <div class="ni-level"><span id="sl-attack">Lv 1</span><span style="color:var(--crit);font-size:9px" id="sl-attack-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--crit)" id="mb-attack"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-strength">
        <span class="ni-icon">üí™</span>
        <div class="ni-info">
          <div class="ni-name">Strength</div>
          <div class="ni-level"><span id="sl-strength">Lv 1</span><span style="color:var(--power);font-size:9px" id="sl-strength-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--power)" id="mb-strength"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-haste">
        <span class="ni-icon">‚ö°</span>
        <div class="ni-info">
          <div class="ni-name">Haste</div>
          <div class="ni-level"><span id="sl-haste">Lv 1</span><span style="color:var(--haste);font-size:9px" id="sl-haste-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--haste)" id="mb-haste"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-defense">
        <span class="ni-icon">üõ°Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Defense</div>
          <div class="ni-level"><span id="sl-defense">Lv 1</span><span style="color:var(--armor);font-size:9px" id="sl-defense-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--armor)" id="mb-defense"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-hitpoints">
        <span class="ni-icon">‚ù§Ô∏è</span>
        <div class="ni-info">
          <div class="ni-name">Hitpoints</div>
          <div class="ni-level"><span id="sl-hitpoints">Lv 10</span><span style="color:var(--hps);font-size:9px" id="sl-hitpoints-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--hps)" id="mb-hitpoints"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('combat')" id="nav-combat">
        <span class="ni-icon">‚öîÔ∏è</span>
        <div class="ni-info">
          <div class="ni-name">Combat</div>
          <div class="ni-level"><span id="sl-combat">Lv 3</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-combat" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-item" onclick="showPage('bank')" id="nav-bank">
        <span class="ni-icon">üè¶</span>
        <div class="ni-info"><div class="ni-name">Bank</div><div class="ni-level">Storage</div></div>
      </div>
      <div class="nav-item" onclick="showPage('equipment')" id="nav-equipment">
        <span class="ni-icon">üõ°Ô∏è</span>
        <div class="ni-info"><div class="ni-name">Equipment</div><div class="ni-level">Loadout</div></div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-stats">
        <span class="ni-icon">üìä</span>
        <div class="ni-info"><div class="ni-name">Stats</div><div class="ni-level">All Skills</div></div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-item" onclick="showPage('contracts')" id="nav-contracts">
        <span class="ni-icon">üìã</span>
        <div class="ni-info"><div class="ni-name">Contracts</div><div class="ni-level">Quests</div></div>
      </div>
      <div class="nav-item" onclick="showPage('mastery-shop')" id="nav-mastery-shop">
        <span class="ni-icon">‚≠ê</span>
        <div class="ni-info"><div class="ni-name">Mastery Shop</div><div class="ni-level">Upgrades</div></div>
      </div>
    </div>
  </div>

  <div id="content">
    <!-- WOODCUTTING -->
    <div class="page" id="page-woodcutting">
      <div id="cur-woodcutting"></div>
      <div class="pg-header">
        <div class="pg-icon">ü™ì</div>
        <div class="pg-title">
          <h2>Woodcutting</h2>
          <div class="pg-xp-area" id="pgxp-woodcutting"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-woodcutting"></div>
    </div>
    <!-- MINING -->
    <div class="page" id="page-mining">
      <div id="cur-mining"></div>
      <div class="pg-header">
        <div class="pg-icon">‚õèÔ∏è</div>
        <div class="pg-title">
          <h2>Mining</h2>
          <div class="pg-xp-area" id="pgxp-mining"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-mining"></div>
    </div>
    <!-- FISHING -->
    <div class="page" id="page-fishing">
      <div id="cur-fishing"></div>
      <div class="pg-header">
        <div class="pg-icon">üé£</div>
        <div class="pg-title">
          <h2>Fishing</h2>
          <div class="pg-xp-area" id="pgxp-fishing"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-fishing"></div>
    </div>
    <!-- FIREMAKING -->
    <div class="page" id="page-firemaking">
      <div id="cur-firemaking"></div>
      <div class="pg-header">
        <div class="pg-icon">üî•</div>
        <div class="pg-title">
          <h2>Firemaking</h2>
          <div class="pg-xp-area" id="pgxp-firemaking"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-firemaking"></div>
    </div>
    <!-- SMITHING -->
    <div class="page" id="page-smithing">
      <div id="cur-smithing"></div>
      <div class="pg-header">
        <div class="pg-icon">üî®</div>
        <div class="pg-title">
          <h2>Smithing</h2>
          <div class="pg-xp-area" id="pgxp-smithing"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-smithing"></div>
      <div class="sec-title">‚öíÔ∏è Craft Equipment</div>
      <div class="action-grid" id="grid-smithing-craft"></div>
    </div>
    <!-- COOKING -->
    <div class="page" id="page-cooking">
      <div id="cur-cooking"></div>
      <div class="pg-header">
        <div class="pg-icon">üç≥</div>
        <div class="pg-title">
          <h2>Cooking</h2>
          <div class="pg-xp-area" id="pgxp-cooking"></div>
        </div>
      </div>
      <div class="action-grid" id="grid-cooking"></div>
    </div>
    <!-- COMBAT -->
    <div class="page" id="page-combat">
      <div class="pg-header">
        <div class="pg-icon">‚öîÔ∏è</div>
        <div class="pg-title">
          <h2>Combat</h2>
          <div class="pg-xp-area" id="pgxp-combat"></div>
        </div>
      </div>
      <div class="combat-layout">
        <div>
          <div class="combat-arena">
            <div class="combatants" id="combatants-display"></div>
            <div class="combat-log" id="combat-log"><p class="clog-p">Select a monster to begin fighting...</p></div>
            <div class="combat-btns" id="combat-btns">
              <button class="btn btn-green" onclick="startCombat()" id="btn-fight">‚öîÔ∏è Fight</button>
              <button class="btn btn-red" onclick="stopCombat()">‚úã Stop</button>
            </div>
          </div>
          <div class="sec-title">üçñ Food in Bank</div>
          <div id="food-display" style="font-size:12px;color:var(--text2)">No food available. Cook some fish first!</div>
        </div>
        <div>
          <div class="sec-title">üëπ Select Monster</div>
          <div class="monster-select" id="monster-select"></div>
        </div>
      </div>
    </div>
    <!-- STATS -->
    <div class="page" id="page-stats">
      <div class="pg-header">
        <div class="pg-icon">üìä</div>
        <div class="pg-title"><h2>Player Stats</h2></div>
      </div>
      <div class="stats-page-grid">
        <div>
          <!-- Total Level -->
          <div class="total-level-display">
            <div class="tld-label">Total Level</div>
            <div class="tld-value" id="stats-total-level">-</div>
            <div class="tld-sub">Sum of all skill levels</div>
          </div>
          <!-- All Skills Overview -->
          <div class="stats-section">
            <h3>‚öíÔ∏è Skills</h3>
            <div class="skill-overview-grid" id="stats-skill-grid"></div>
          </div>
        </div>
        <div>
          <!-- Combat Stats -->
          <div class="stats-section">
            <h3>‚öîÔ∏è Combat Stats</h3>
            <div class="csc-grid" id="stats-combat-grid"></div>
          </div>
          <!-- Combat Sub-Skills XP -->
          <div class="stats-section" style="margin-top:12px">
            <h3>üß¨ Combat Skills XP</h3>
            <div id="stats-combat-xp"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- BANK -->
    <div class="page" id="page-bank">
      <div class="pg-header">
        <div class="pg-icon">üè¶</div>
        <div class="pg-title"><h2>Bank</h2></div>
      </div>
      <div class="bank-top">
        <div class="bank-gold">ü™ô <span id="bank-gold-disp">0</span> gp</div>
        <div class="sell-all-row">
          <button class="btn btn-gold" onclick="sellAllCategory('logs')">Sell All Logs</button>
          <button class="btn btn-gold" onclick="sellAllCategory('ore')">Sell All Ore</button>
          <button class="btn btn-gold" onclick="sellAllCategory('bar')">Sell All Bars</button>
          <button class="btn btn-gold" onclick="sellAllCategory('fish')">Sell All Fish</button>
        </div>
      </div>
      <div class="bank-cats" id="bank-cats"></div>
      <div class="bank-grid" id="bank-grid"></div>
    </div>
    <!-- EQUIPMENT -->
    <div class="page" id="page-equipment">
      <div class="pg-header">
        <div class="pg-icon">üõ°Ô∏è</div>
        <div class="pg-title"><h2>Equipment</h2></div>
      </div>
      <div class="equip-layout">
        <div>
          <div class="equip-slots" id="equip-slots"></div>
        </div>
        <div>
          <div class="stats-display" id="stats-display"></div>
          <div class="equip-available">
            <div class="sec-title">üì¶ Available to Equip</div>
            <div class="equip-avail-grid" id="equip-avail-grid"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- CONTRACTS -->
    <div class="page" id="page-contracts">
      <div class="pg-header">
        <div class="pg-icon">üìã</div>
        <div class="pg-title"><h2>Requisition Board</h2></div>
      </div>
      <div class="contract-refresh" id="contract-refresh-timer"></div>
      <div class="contract-grid" id="contract-grid"></div>
    </div>
    <!-- MASTERY SHOP -->
    <div class="page" id="page-mastery-shop">
      <div class="pg-header">
        <div class="pg-icon">‚≠ê</div>
        <div class="pg-title"><h2>Mastery Exchange</h2></div>
      </div>
      <div class="mastery-total">
        <div class="mt-label">Available Mastery Points</div>
        <div class="mt-value" id="ms-total-points">0</div>
        <div class="mt-sub">Spend mastery to unlock permanent bonuses</div>
      </div>
      <div class="mastery-tabs" id="ms-tabs"></div>
      <div class="upgrade-grid" id="upgrade-grid"></div>
    </div>
  </div>
</div>

<div id="notifs"></div>

<div class="modal-overlay" id="modal-overlay">
  <div class="modal">
    <h3 id="modal-title">Equip Item</h3>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ============================================================
// DATA DEFINITIONS
// ============================================================

// XP table (RS-style): XP needed to reach each level
const XP_TABLE = (()=>{
  const t=[0];
  let pts=0;
  for(let i=1;i<=99;i++){
    pts += Math.floor(i + 300 * Math.pow(2, i/7));
    t.push(Math.floor(pts/4));
  }
  return t;
})();

function xpToLevel(xp){
  let lv=1;
  for(let i=1;i<99;i++){if(xp>=XP_TABLE[i])lv=i+1;else break;}
  return lv;
}
function xpForLevel(lv){return XP_TABLE[lv-1]||0;}
function xpToNextLevel(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 0;
  return XP_TABLE[lv]-xp;
}
function xpProgress(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 1;
  const base=XP_TABLE[lv-1];
  const next=XP_TABLE[lv];
  return (xp-base)/(next-base);
}

const fmt=(n)=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':String(Math.floor(n));

// ITEMS
const ITEMS = {
  normal_log:{name:'Normal Log',icon:'ü™µ',value:5,cat:'logs'},
  oak_log:{name:'Oak Log',icon:'ü™µ',value:15,cat:'logs'},
  willow_log:{name:'Willow Log',icon:'ü™µ',value:30,cat:'logs'},
  maple_log:{name:'Maple Log',icon:'üçÅ',value:60,cat:'logs'},
  teak_log:{name:'Teak Log',icon:'ü™µ',value:90,cat:'logs'},
  yew_log:{name:'Yew Log',icon:'üå≤',value:140,cat:'logs'},
  magic_log:{name:'Magic Log',icon:'‚ú®',value:220,cat:'logs'},
  redwood_log:{name:'Redwood Log',icon:'üå≥',value:350,cat:'logs'},
  copper_ore:{name:'Copper Ore',icon:'üü§',value:5,cat:'ore'},
  tin_ore:{name:'Tin Ore',icon:'üîµ',value:5,cat:'ore'},
  iron_ore:{name:'Iron Ore',icon:'‚¨õ',value:15,cat:'ore'},
  silver_ore:{name:'Silver Ore',icon:'‚ö™',value:25,cat:'ore'},
  coal:{name:'Coal',icon:'üñ§',value:25,cat:'ore'},
  mithril_ore:{name:'Mithril Ore',icon:'üí†',value:60,cat:'ore'},
  adamant_ore:{name:'Adamant Ore',icon:'üü¢',value:120,cat:'ore'},
  runite_ore:{name:'Runite Ore',icon:'üî∑',value:200,cat:'ore'},
  dragon_ore:{name:'Dragon Ore',icon:'üî∂',value:400,cat:'ore'},
  raw_shrimp:{name:'Raw Shrimp',icon:'ü¶ê',value:3,cat:'fish'},
  raw_trout:{name:'Raw Trout',icon:'üêü',value:10,cat:'fish'},
  raw_salmon:{name:'Raw Salmon',icon:'üê†',value:20,cat:'fish'},
  raw_tuna:{name:'Raw Tuna',icon:'üêü',value:35,cat:'fish'},
  raw_lobster:{name:'Raw Lobster',icon:'ü¶û',value:50,cat:'fish'},
  raw_bass:{name:'Raw Bass',icon:'üêü',value:70,cat:'fish'},
  raw_swordfish:{name:'Raw Swordfish',icon:'üó°Ô∏è',value:100,cat:'fish'},
  raw_monkfish:{name:'Raw Monkfish',icon:'üêü',value:140,cat:'fish'},
  raw_shark:{name:'Raw Shark',icon:'ü¶à',value:200,cat:'fish'},
  raw_manta:{name:'Raw Manta Ray',icon:'üêü',value:280,cat:'fish'},
  raw_turtle:{name:'Raw Sea Turtle',icon:'üê¢',value:400,cat:'fish'},
  bronze_bar:{name:'Bronze Bar',icon:'üü´',value:40,cat:'bar'},
  iron_bar:{name:'Iron Bar',icon:'üî©',value:80,cat:'bar'},
  silver_bar:{name:'Silver Bar',icon:'‚öôÔ∏è',value:120,cat:'bar'},
  steel_bar:{name:'Steel Bar',icon:'‚öôÔ∏è',value:150,cat:'bar'},
  mithril_bar:{name:'Mithril Bar',icon:'üíé',value:300,cat:'bar'},
  adamant_bar:{name:'Adamant Bar',icon:'üî∞',value:600,cat:'bar'},
  rune_bar:{name:'Rune Bar',icon:'üî∑',value:1200,cat:'bar'},
  dragon_bar:{name:'Dragon Bar',icon:'üî∂',value:2500,cat:'bar'},
  cooked_shrimp:{name:'Cooked Shrimp',icon:'üç§',value:20,cat:'food',heals:3},
  cooked_trout:{name:'Cooked Trout',icon:'üç£',value:60,cat:'food',heals:7},
  cooked_salmon:{name:'Cooked Salmon',icon:'ü•©',value:120,cat:'food',heals:12},
  cooked_tuna:{name:'Cooked Tuna',icon:'üç£',value:180,cat:'food',heals:16},
  cooked_lobster:{name:'Cooked Lobster',icon:'ü¶û',value:250,cat:'food',heals:20},
  cooked_bass:{name:'Cooked Bass',icon:'üç£',value:350,cat:'food',heals:24},
  cooked_swordfish:{name:'Cooked Swordfish',icon:'üçñ',value:500,cat:'food',heals:28},
  cooked_monkfish:{name:'Cooked Monkfish',icon:'üç£',value:700,cat:'food',heals:32},
  cooked_shark:{name:'Cooked Shark',icon:'üçñ',value:1000,cat:'food',heals:36},
  cooked_manta:{name:'Cooked Manta Ray',icon:'üç£',value:1400,cat:'food',heals:40},
  cooked_turtle:{name:'Cooked Sea Turtle',icon:'üç≤',value:2000,cat:'food',heals:44},
  burnt_shrimp:{name:'Burnt Shrimp',icon:'üü´',value:0,cat:'junk'},
  burnt_trout:{name:'Burnt Trout',icon:'üü´',value:0,cat:'junk'},
  burnt_salmon:{name:'Burnt Salmon',icon:'üü´',value:0,cat:'junk'},
  burnt_tuna:{name:'Burnt Tuna',icon:'üü´',value:0,cat:'junk'},
  burnt_lobster:{name:'Burnt Lobster',icon:'üü´',value:0,cat:'junk'},
  burnt_bass:{name:'Burnt Bass',icon:'üü´',value:0,cat:'junk'},
  burnt_swordfish:{name:'Burnt Swordfish',icon:'üü´',value:0,cat:'junk'},
  burnt_monkfish:{name:'Burnt Monkfish',icon:'üü´',value:0,cat:'junk'},
  burnt_shark:{name:'Burnt Shark',icon:'üü´',value:0,cat:'junk'},
  burnt_manta:{name:'Burnt Manta Ray',icon:'üü´',value:0,cat:'junk'},
  burnt_turtle:{name:'Burnt Sea Turtle',icon:'üü´',value:0,cat:'junk'},
  bones:{name:'Bones',icon:'ü¶¥',value:2,cat:'junk'},
  // Trinkets (Unique drops)
  woodcutters_trinket:{name:'Woodcutter\'s Trinket',icon:'ü™ì',value:5000,cat:'trinket',slot:'trinket',skill:'woodcutting',bonus:'10% XP + 2x logs'},
  miners_trinket:{name:'Miner\'s Trinket',icon:'‚õèÔ∏è',value:5000,cat:'trinket',slot:'trinket',skill:'mining',bonus:'10% XP + 2x ore'},
  fishermans_trinket:{name:'Fisherman\'s Trinket',icon:'üé£',value:5000,cat:'trinket',slot:'trinket',skill:'fishing',bonus:'10% XP + 2x fish'},
  firemakers_trinket:{name:'Firemaker\'s Trinket',icon:'üî•',value:5000,cat:'trinket',slot:'trinket',skill:'firemaking',bonus:'10% XP + 25% save logs'},
  smiths_trinket:{name:'Smith\'s Trinket',icon:'üî®',value:5000,cat:'trinket',slot:'trinket',skill:'smithing',bonus:'10% XP + 25% save materials'},
  chefs_trinket:{name:'Chef\'s Trinket',icon:'üç≥',value:5000,cat:'trinket',slot:'trinket',skill:'cooking',bonus:'10% XP + 25% save fish'},
  brawlers_trinket:{name:'Brawler\'s Trinket',icon:'‚öîÔ∏è',value:5000,cat:'trinket',slot:'trinket',skill:'combat',bonus:'10% all combat stats + 10% loot'},
  // Equipment
  // Equipment - Weapons
  bronze_sword:{name:'Bronze Sword',icon:'üó°Ô∏è',value:200,cat:'weapon',slot:'weapon',atk:4,def:0,reqAtk:1,reqStr:1},
  iron_sword:{name:'Iron Sword',icon:'‚öîÔ∏è',value:500,cat:'weapon',slot:'weapon',atk:8,def:0,reqAtk:15,reqStr:15},
  silver_sword:{name:'Silver Sword',icon:'üó°Ô∏è',value:800,cat:'weapon',slot:'weapon',atk:12,def:0,reqAtk:20,reqStr:20},
  steel_sword:{name:'Steel Sword',icon:'üî±',value:1200,cat:'weapon',slot:'weapon',atk:14,def:0,reqAtk:30,reqStr:30},
  mithril_sword:{name:'Mithril Sword',icon:'‚öîÔ∏è',value:2000,cat:'weapon',slot:'weapon',atk:20,def:0,reqAtk:40,reqStr:40},
  adamant_sword:{name:'Adamant Sword',icon:'üó°Ô∏è',value:4000,cat:'weapon',slot:'weapon',atk:26,def:0,reqAtk:55,reqStr:55},
  rune_sword:{name:'Rune Sword',icon:'üî±',value:8000,cat:'weapon',slot:'weapon',atk:34,def:0,reqAtk:70,reqStr:70},
  dragon_sword:{name:'Dragon Sword',icon:'‚öîÔ∏è',value:16000,cat:'weapon',slot:'weapon',atk:44,def:0,reqAtk:85,reqStr:85},
  // Equipment - Shields
  bronze_shield:{name:'Bronze Shield',icon:'üõ°Ô∏è',value:160,cat:'armor',slot:'shield',atk:0,def:3,reqDef:1},
  iron_shield:{name:'Iron Shield',icon:'üõ°Ô∏è',value:400,cat:'armor',slot:'shield',atk:0,def:7,reqDef:15},
  silver_shield:{name:'Silver Shield',icon:'üõ°Ô∏è',value:650,cat:'armor',slot:'shield',atk:0,def:10,reqDef:20},
  steel_shield:{name:'Steel Shield',icon:'üõ°Ô∏è',value:900,cat:'armor',slot:'shield',atk:0,def:12,reqDef:30},
  mithril_shield:{name:'Mithril Shield',icon:'üõ°Ô∏è',value:1600,cat:'armor',slot:'shield',atk:0,def:18,reqDef:40},
  adamant_shield:{name:'Adamant Shield',icon:'üõ°Ô∏è',value:3200,cat:'armor',slot:'shield',atk:0,def:24,reqDef:55},
  rune_shield:{name:'Rune Shield',icon:'üõ°Ô∏è',value:6400,cat:'armor',slot:'shield',atk:0,def:32,reqDef:70},
  dragon_shield:{name:'Dragon Shield',icon:'üõ°Ô∏è',value:12800,cat:'armor',slot:'shield',atk:0,def:42,reqDef:85},
  // Equipment - Body
  bronze_body:{name:'Bronze Body',icon:'ü¶∫',value:140,cat:'armor',slot:'body',atk:0,def:5,reqDef:1},
  leather_body:{name:'Leather Body',icon:'ü¶∫',value:120,cat:'armor',slot:'body',atk:0,def:4,reqDef:1},
  iron_body:{name:'Iron Body',icon:'üß•',value:600,cat:'armor',slot:'body',atk:0,def:10,reqDef:15},
  silver_body:{name:'Silver Body',icon:'üß•',value:1000,cat:'armor',slot:'body',atk:0,def:14,reqDef:20},
  steel_body:{name:'Steel Body',icon:'üß•',value:1400,cat:'armor',slot:'body',atk:0,def:16,reqDef:30},
  mithril_body:{name:'Mithril Body',icon:'üß•',value:2400,cat:'armor',slot:'body',atk:0,def:24,reqDef:40},
  adamant_body:{name:'Adamant Body',icon:'üß•',value:4800,cat:'armor',slot:'body',atk:0,def:32,reqDef:55},
  rune_body:{name:'Rune Body',icon:'üß•',value:9600,cat:'armor',slot:'body',atk:0,def:42,reqDef:70},
  dragon_body:{name:'Dragon Body',icon:'üß•',value:19200,cat:'armor',slot:'body',atk:0,def:54,reqDef:85},
  // Equipment - Helmets
  bronze_helmet:{name:'Bronze Helmet',icon:'‚õëÔ∏è',value:100,cat:'armor',slot:'helmet',atk:0,def:2,reqDef:1},
  iron_helmet:{name:'Iron Helmet',icon:'‚õëÔ∏è',value:350,cat:'armor',slot:'helmet',atk:0,def:6,reqDef:15},
  silver_helmet:{name:'Silver Helmet',icon:'‚õëÔ∏è',value:550,cat:'armor',slot:'helmet',atk:0,def:9,reqDef:20},
  steel_helmet:{name:'Steel Helmet',icon:'‚õëÔ∏è',value:800,cat:'armor',slot:'helmet',atk:0,def:10,reqDef:30},
  mithril_helmet:{name:'Mithril Helmet',icon:'‚õëÔ∏è',value:1400,cat:'armor',slot:'helmet',atk:0,def:16,reqDef:40},
  adamant_helmet:{name:'Adamant Helmet',icon:'‚õëÔ∏è',value:2800,cat:'armor',slot:'helmet',atk:0,def:22,reqDef:55},
  rune_helmet:{name:'Rune Helmet',icon:'‚õëÔ∏è',value:5600,cat:'armor',slot:'helmet',atk:0,def:30,reqDef:70},
  dragon_helmet:{name:'Dragon Helmet',icon:'‚õëÔ∏è',value:11200,cat:'armor',slot:'helmet',atk:0,def:40,reqDef:85},
  // Equipment - Legs
  bronze_legs:{name:'Bronze Legs',icon:'üëñ',value:100,cat:'armor',slot:'legs',atk:0,def:3,reqDef:1},
  iron_legs:{name:'Iron Legs',icon:'üëñ',value:350,cat:'armor',slot:'legs',atk:0,def:7,reqDef:15},
  silver_legs:{name:'Silver Legs',icon:'üëñ',value:550,cat:'armor',slot:'legs',atk:0,def:10,reqDef:20},
  steel_legs:{name:'Steel Legs',icon:'üëñ',value:800,cat:'armor',slot:'legs',atk:0,def:11,reqDef:30},
  mithril_legs:{name:'Mithril Legs',icon:'üëñ',value:1400,cat:'armor',slot:'legs',atk:0,def:18,reqDef:40},
  adamant_legs:{name:'Adamant Legs',icon:'üëñ',value:2800,cat:'armor',slot:'legs',atk:0,def:24,reqDef:55},
  rune_legs:{name:'Rune Legs',icon:'üëñ',value:5600,cat:'armor',slot:'legs',atk:0,def:32,reqDef:70},
  dragon_legs:{name:'Dragon Legs',icon:'üëñ',value:11200,cat:'armor',slot:'legs',atk:0,def:44,reqDef:85},
};

// SKILL ACTIONS
const ACTIONS = {
  woodcutting:[
    {id:'normal_tree',name:'Normal Tree',icon:'üå≥',levelReq:1,xp:25,masteryXp:8,ticks:5,produces:'normal_log',qty:1},
    {id:'oak_tree',name:'Oak Tree',icon:'üå≤',levelReq:15,xp:37,masteryXp:12,ticks:7,produces:'oak_log',qty:1},
    {id:'willow_tree',name:'Willow Tree',icon:'üåø',levelReq:30,xp:67,masteryXp:20,ticks:10,produces:'willow_log',qty:1},
    {id:'maple_tree',name:'Maple Tree',icon:'üçÅ',levelReq:45,xp:100,masteryXp:32,ticks:13,produces:'maple_log',qty:1},
    {id:'teak_tree',name:'Teak Tree',icon:'ü™µ',levelReq:55,xp:135,masteryXp:42,ticks:16,produces:'teak_log',qty:1},
    {id:'yew_tree',name:'Yew Tree',icon:'üå≤',levelReq:65,xp:180,masteryXp:54,ticks:19,produces:'yew_log',qty:1},
    {id:'magic_tree',name:'Magic Tree',icon:'‚ú®',levelReq:75,xp:240,masteryXp:68,ticks:22,produces:'magic_log',qty:1},
    {id:'redwood_tree',name:'Redwood Tree',icon:'üå≥',levelReq:85,xp:320,masteryXp:85,ticks:26,produces:'redwood_log',qty:1},
  ],
  mining:[
    {id:'copper_rock',name:'Copper Rock',icon:'üü§',levelReq:1,xp:17,masteryXp:6,ticks:4,produces:'copper_ore',qty:1},
    {id:'tin_rock',name:'Tin Rock',icon:'üîµ',levelReq:1,xp:17,masteryXp:6,ticks:4,produces:'tin_ore',qty:1},
    {id:'iron_rock',name:'Iron Rock',icon:'‚¨õ',levelReq:15,xp:35,masteryXp:12,ticks:7,produces:'iron_ore',qty:1},
    {id:'silver_rock',name:'Silver Rock',icon:'‚ö™',levelReq:20,xp:40,masteryXp:14,ticks:8,produces:'silver_ore',qty:1},
    {id:'coal_rock',name:'Coal Rock',icon:'üñ§',levelReq:30,xp:50,masteryXp:16,ticks:12,produces:'coal',qty:1},
    {id:'mithril_rock',name:'Mithril Rock',icon:'üí†',levelReq:40,xp:80,masteryXp:24,ticks:14,produces:'mithril_ore',qty:1},
    {id:'adamant_rock',name:'Adamant Rock',icon:'üü¢',levelReq:55,xp:120,masteryXp:36,ticks:18,produces:'adamant_ore',qty:1},
    {id:'runite_rock',name:'Runite Rock',icon:'üî∑',levelReq:70,xp:180,masteryXp:50,ticks:22,produces:'runite_ore',qty:1},
    {id:'dragon_rock',name:'Dragon Rock',icon:'üî∂',levelReq:85,xp:280,masteryXp:70,ticks:28,produces:'dragon_ore',qty:1},
  ],
  fishing:[
    {id:'shrimp_spot',name:'Shrimp Spot',icon:'ü¶ê',levelReq:1,xp:10,masteryXp:4,ticks:4,produces:'raw_shrimp',qty:1},
    {id:'trout_spot',name:'Trout Spot',icon:'üêü',levelReq:15,xp:40,masteryXp:14,ticks:6,produces:'raw_trout',qty:1},
    {id:'salmon_spot',name:'Salmon Spot',icon:'üê†',levelReq:25,xp:60,masteryXp:20,ticks:8,produces:'raw_salmon',qty:1},
    {id:'tuna_spot',name:'Tuna Spot',icon:'üêü',levelReq:35,xp:85,masteryXp:28,ticks:10,produces:'raw_tuna',qty:1},
    {id:'lobster_spot',name:'Lobster Spot',icon:'ü¶û',levelReq:40,xp:110,masteryXp:36,ticks:12,produces:'raw_lobster',qty:1},
    {id:'bass_spot',name:'Bass Spot',icon:'üêü',levelReq:50,xp:140,masteryXp:44,ticks:14,produces:'raw_bass',qty:1},
    {id:'swordfish_spot',name:'Swordfish Spot',icon:'üó°Ô∏è',levelReq:55,xp:170,masteryXp:52,ticks:16,produces:'raw_swordfish',qty:1},
    {id:'monkfish_spot',name:'Monkfish Spot',icon:'üêü',levelReq:65,xp:210,masteryXp:62,ticks:18,produces:'raw_monkfish',qty:1},
    {id:'shark_spot',name:'Shark Spot',icon:'ü¶à',levelReq:75,xp:260,masteryXp:74,ticks:20,produces:'raw_shark',qty:1},
    {id:'manta_spot',name:'Manta Ray Spot',icon:'üêü',levelReq:85,xp:320,masteryXp:88,ticks:23,produces:'raw_manta',qty:1},
    {id:'turtle_spot',name:'Sea Turtle Spot',icon:'üê¢',levelReq:95,xp:400,masteryXp:105,ticks:26,produces:'raw_turtle',qty:1},
  ],
  firemaking:[
    {id:'burn_log',name:'Normal Log',icon:'üî•',levelReq:1,xp:40,masteryXp:14,ticks:3,consumes:{normal_log:1}},
    {id:'burn_oak',name:'Oak Log',icon:'üî•',levelReq:15,xp:60,masteryXp:20,ticks:3,consumes:{oak_log:1}},
    {id:'burn_willow',name:'Willow Log',icon:'üî•',levelReq:30,xp:90,masteryXp:28,ticks:4,consumes:{willow_log:1}},
    {id:'burn_maple',name:'Maple Log',icon:'üî•',levelReq:45,xp:135,masteryXp:40,ticks:4,consumes:{maple_log:1}},
    {id:'burn_teak',name:'Teak Log',icon:'üî•',levelReq:55,xp:180,masteryXp:50,ticks:5,consumes:{teak_log:1}},
    {id:'burn_yew',name:'Yew Log',icon:'üî•',levelReq:65,xp:240,masteryXp:62,ticks:5,consumes:{yew_log:1}},
    {id:'burn_magic',name:'Magic Log',icon:'üî•',levelReq:75,xp:320,masteryXp:76,ticks:6,consumes:{magic_log:1}},
    {id:'burn_redwood',name:'Redwood Log',icon:'üî•',levelReq:85,xp:425,masteryXp:92,ticks:6,consumes:{redwood_log:1}},
  ],
  smithing:[
    {id:'bronze_bar',name:'Bronze Bar',icon:'üü´',levelReq:1,xp:12,masteryXp:5,ticks:4,consumes:{copper_ore:1,tin_ore:1},produces:'bronze_bar',qty:1},
    {id:'iron_bar',name:'Iron Bar',icon:'üî©',levelReq:15,xp:25,masteryXp:10,ticks:6,consumes:{iron_ore:2},produces:'iron_bar',qty:1},
    {id:'silver_bar',name:'Silver Bar',icon:'‚öôÔ∏è',levelReq:20,xp:30,masteryXp:12,ticks:7,consumes:{silver_ore:1},produces:'silver_bar',qty:1},
    {id:'steel_bar',name:'Steel Bar',icon:'‚öôÔ∏è',levelReq:30,xp:37,masteryXp:14,ticks:9,consumes:{iron_ore:1,coal:2},produces:'steel_bar',qty:1},
    {id:'mithril_bar',name:'Mithril Bar',icon:'üíé',levelReq:40,xp:70,masteryXp:24,ticks:11,consumes:{mithril_ore:1,coal:2},produces:'mithril_bar',qty:1},
    {id:'adamant_bar',name:'Adamant Bar',icon:'üî∞',levelReq:55,xp:110,masteryXp:36,ticks:13,consumes:{adamant_ore:1,coal:3},produces:'adamant_bar',qty:1},
    {id:'rune_bar',name:'Rune Bar',icon:'üî∑',levelReq:70,xp:170,masteryXp:50,ticks:15,consumes:{runite_ore:1,coal:4},produces:'rune_bar',qty:1},
    {id:'dragon_bar',name:'Dragon Bar',icon:'üî∂',levelReq:85,xp:260,masteryXp:70,ticks:18,consumes:{dragon_ore:1,coal:6},produces:'dragon_bar',qty:1},
  ],
  smithingCraft:[
    // Bronze Set (Lv 1-8)
    {id:'craft_bronze_sword',name:'Bronze Sword',icon:'üó°Ô∏è',levelReq:1,xp:25,ticks:3,consumes:{bronze_bar:2},produces:'bronze_sword',qty:1},
    {id:'craft_bronze_shield',name:'Bronze Shield',icon:'üõ°Ô∏è',levelReq:3,xp:20,ticks:3,consumes:{bronze_bar:2},produces:'bronze_shield',qty:1},
    {id:'craft_bronze_helmet',name:'Bronze Helmet',icon:'‚õëÔ∏è',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:1},produces:'bronze_helmet',qty:1},
    {id:'craft_bronze_body',name:'Bronze Body',icon:'ü¶∫',levelReq:8,xp:30,ticks:4,consumes:{bronze_bar:3},produces:'bronze_body',qty:1},
    {id:'craft_bronze_legs',name:'Bronze Legs',icon:'üëñ',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:2},produces:'bronze_legs',qty:1},
    // Iron Set (Lv 15-28)
    {id:'craft_iron_sword',name:'Iron Sword',icon:'‚öîÔ∏è',levelReq:15,xp:50,ticks:5,consumes:{iron_bar:2},produces:'iron_sword',qty:1},
    {id:'craft_iron_shield',name:'Iron Shield',icon:'üõ°Ô∏è',levelReq:17,xp:40,ticks:5,consumes:{iron_bar:2},produces:'iron_shield',qty:1},
    {id:'craft_iron_helmet',name:'Iron Helmet',icon:'‚õëÔ∏è',levelReq:19,xp:35,ticks:5,consumes:{iron_bar:2},produces:'iron_helmet',qty:1},
    {id:'craft_iron_body',name:'Iron Body',icon:'üß•',levelReq:23,xp:60,ticks:7,consumes:{iron_bar:4},produces:'iron_body',qty:1},
    {id:'craft_iron_legs',name:'Iron Legs',icon:'üëñ',levelReq:19,xp:55,ticks:7,consumes:{iron_bar:3},produces:'iron_legs',qty:1},
    // Silver Set (Lv 20-28)
    {id:'craft_silver_sword',name:'Silver Sword',icon:'üó°Ô∏è',levelReq:20,xp:60,ticks:5,consumes:{silver_bar:2},produces:'silver_sword',qty:1},
    {id:'craft_silver_shield',name:'Silver Shield',icon:'üõ°Ô∏è',levelReq:22,xp:50,ticks:5,consumes:{silver_bar:2},produces:'silver_shield',qty:1},
    {id:'craft_silver_helmet',name:'Silver Helmet',icon:'‚õëÔ∏è',levelReq:24,xp:45,ticks:5,consumes:{silver_bar:2},produces:'silver_helmet',qty:1},
    {id:'craft_silver_body',name:'Silver Body',icon:'üß•',levelReq:28,xp:70,ticks:7,consumes:{silver_bar:4},produces:'silver_body',qty:1},
    {id:'craft_silver_legs',name:'Silver Legs',icon:'üëñ',levelReq:24,xp:65,ticks:7,consumes:{silver_bar:3},produces:'silver_legs',qty:1},
    // Steel Set (Lv 30-38)
    {id:'craft_steel_sword',name:'Steel Sword',icon:'üî±',levelReq:30,xp:80,ticks:7,consumes:{steel_bar:2},produces:'steel_sword',qty:1},
    {id:'craft_steel_shield',name:'Steel Shield',icon:'üõ°Ô∏è',levelReq:32,xp:70,ticks:7,consumes:{steel_bar:2},produces:'steel_shield',qty:1},
    {id:'craft_steel_helmet',name:'Steel Helmet',icon:'‚õëÔ∏è',levelReq:34,xp:65,ticks:7,consumes:{steel_bar:2},produces:'steel_helmet',qty:1},
    {id:'craft_steel_body',name:'Steel Body',icon:'üß•',levelReq:38,xp:100,ticks:9,consumes:{steel_bar:4},produces:'steel_body',qty:1},
    {id:'craft_steel_legs',name:'Steel Legs',icon:'üëñ',levelReq:34,xp:85,ticks:8,consumes:{steel_bar:3},produces:'steel_legs',qty:1},
    // Mithril Set (Lv 40-48)
    {id:'craft_mithril_sword',name:'Mithril Sword',icon:'‚öîÔ∏è',levelReq:40,xp:120,ticks:8,consumes:{mithril_bar:2},produces:'mithril_sword',qty:1},
    {id:'craft_mithril_shield',name:'Mithril Shield',icon:'üõ°Ô∏è',levelReq:42,xp:100,ticks:8,consumes:{mithril_bar:2},produces:'mithril_shield',qty:1},
    {id:'craft_mithril_helmet',name:'Mithril Helmet',icon:'‚õëÔ∏è',levelReq:44,xp:90,ticks:8,consumes:{mithril_bar:2},produces:'mithril_helmet',qty:1},
    {id:'craft_mithril_body',name:'Mithril Body',icon:'üß•',levelReq:48,xp:150,ticks:10,consumes:{mithril_bar:4},produces:'mithril_body',qty:1},
    {id:'craft_mithril_legs',name:'Mithril Legs',icon:'üëñ',levelReq:44,xp:130,ticks:9,consumes:{mithril_bar:3},produces:'mithril_legs',qty:1},
    // Adamant Set (Lv 55-63)
    {id:'craft_adamant_sword',name:'Adamant Sword',icon:'üó°Ô∏è',levelReq:55,xp:180,ticks:9,consumes:{adamant_bar:2},produces:'adamant_sword',qty:1},
    {id:'craft_adamant_shield',name:'Adamant Shield',icon:'üõ°Ô∏è',levelReq:57,xp:150,ticks:9,consumes:{adamant_bar:2},produces:'adamant_shield',qty:1},
    {id:'craft_adamant_helmet',name:'Adamant Helmet',icon:'‚õëÔ∏è',levelReq:59,xp:140,ticks:9,consumes:{adamant_bar:2},produces:'adamant_helmet',qty:1},
    {id:'craft_adamant_body',name:'Adamant Body',icon:'üß•',levelReq:63,xp:220,ticks:11,consumes:{adamant_bar:4},produces:'adamant_body',qty:1},
    {id:'craft_adamant_legs',name:'Adamant Legs',icon:'üëñ',levelReq:59,xp:190,ticks:10,consumes:{adamant_bar:3},produces:'adamant_legs',qty:1},
    // Rune Set (Lv 70-78)
    {id:'craft_rune_sword',name:'Rune Sword',icon:'üî±',levelReq:70,xp:260,ticks:10,consumes:{rune_bar:2},produces:'rune_sword',qty:1},
    {id:'craft_rune_shield',name:'Rune Shield',icon:'üõ°Ô∏è',levelReq:72,xp:220,ticks:10,consumes:{rune_bar:2},produces:'rune_shield',qty:1},
    {id:'craft_rune_helmet',name:'Rune Helmet',icon:'‚õëÔ∏è',levelReq:74,xp:200,ticks:10,consumes:{rune_bar:2},produces:'rune_helmet',qty:1},
    {id:'craft_rune_body',name:'Rune Body',icon:'üß•',levelReq:78,xp:320,ticks:12,consumes:{rune_bar:4},produces:'rune_body',qty:1},
    {id:'craft_rune_legs',name:'Rune Legs',icon:'üëñ',levelReq:74,xp:280,ticks:11,consumes:{rune_bar:3},produces:'rune_legs',qty:1},
    // Dragon Set (Lv 85-93)
    {id:'craft_dragon_sword',name:'Dragon Sword',icon:'‚öîÔ∏è',levelReq:85,xp:380,ticks:12,consumes:{dragon_bar:2},produces:'dragon_sword',qty:1},
    {id:'craft_dragon_shield',name:'Dragon Shield',icon:'üõ°Ô∏è',levelReq:87,xp:320,ticks:12,consumes:{dragon_bar:2},produces:'dragon_shield',qty:1},
    {id:'craft_dragon_helmet',name:'Dragon Helmet',icon:'‚õëÔ∏è',levelReq:89,xp:300,ticks:12,consumes:{dragon_bar:2},produces:'dragon_helmet',qty:1},
    {id:'craft_dragon_body',name:'Dragon Body',icon:'üß•',levelReq:93,xp:480,ticks:14,consumes:{dragon_bar:4},produces:'dragon_body',qty:1},
    {id:'craft_dragon_legs',name:'Dragon Legs',icon:'üëñ',levelReq:89,xp:420,ticks:13,consumes:{dragon_bar:3},produces:'dragon_legs',qty:1},
  ],
  cooking:[
    {id:'cook_shrimp',name:'Shrimp',icon:'üç§',levelReq:1,xp:30,masteryXp:10,ticks:4,consumes:{raw_shrimp:1},produces:'cooked_shrimp',burnChance:0.35,burnItem:'burnt_shrimp'},
    {id:'cook_trout',name:'Trout',icon:'üç£',levelReq:15,xp:70,masteryXp:22,ticks:5,consumes:{raw_trout:1},produces:'cooked_trout',burnChance:0.35,burnItem:'burnt_trout'},
    {id:'cook_salmon',name:'Salmon',icon:'ü•©',levelReq:25,xp:90,masteryXp:28,ticks:6,consumes:{raw_salmon:1},produces:'cooked_salmon',burnChance:0.35,burnItem:'burnt_salmon'},
    {id:'cook_tuna',name:'Tuna',icon:'üç£',levelReq:35,xp:120,masteryXp:36,ticks:7,consumes:{raw_tuna:1},produces:'cooked_tuna',burnChance:0.32,burnItem:'burnt_tuna'},
    {id:'cook_lobster',name:'Lobster',icon:'ü¶û',levelReq:40,xp:150,masteryXp:44,ticks:8,consumes:{raw_lobster:1},produces:'cooked_lobster',burnChance:0.30,burnItem:'burnt_lobster'},
    {id:'cook_bass',name:'Bass',icon:'üç£',levelReq:50,xp:190,masteryXp:54,ticks:9,consumes:{raw_bass:1},produces:'cooked_bass',burnChance:0.28,burnItem:'burnt_bass'},
    {id:'cook_swordfish',name:'Swordfish',icon:'üçñ',levelReq:55,xp:230,masteryXp:64,ticks:10,consumes:{raw_swordfish:1},produces:'cooked_swordfish',burnChance:0.25,burnItem:'burnt_swordfish'},
    {id:'cook_monkfish',name:'Monkfish',icon:'üç£',levelReq:65,xp:280,masteryXp:76,ticks:11,consumes:{raw_monkfish:1},produces:'cooked_monkfish',burnChance:0.22,burnItem:'burnt_monkfish'},
    {id:'cook_shark',name:'Shark',icon:'üçñ',levelReq:75,xp:340,masteryXp:90,ticks:12,consumes:{raw_shark:1},produces:'cooked_shark',burnChance:0.20,burnItem:'burnt_shark'},
    {id:'cook_manta',name:'Manta Ray',icon:'üç£',levelReq:85,xp:420,masteryXp:106,ticks:13,consumes:{raw_manta:1},produces:'cooked_manta',burnChance:0.18,burnItem:'burnt_manta'},
    {id:'cook_turtle',name:'Sea Turtle',icon:'üç≤',levelReq:95,xp:520,masteryXp:125,ticks:14,consumes:{raw_turtle:1},produces:'cooked_turtle',burnChance:0.15,burnItem:'burnt_turtle'},
  ],
};

// MONSTERS
const MONSTERS=[
  {id:'goblin',name:'Goblin',icon:'üë∫',levelReq:1,hp:20,maxHp:20,atk:2,def:0,xp:10,drops:[
    {item:'bones',qty:1,chance:1},{item:'bronze_sword',qty:1,chance:0.05},
    {gold:[1,5]}
  ]},
  {id:'rat',name:'Giant Rat',icon:'üêÄ',levelReq:1,hp:15,maxHp:15,atk:1,def:0,xp:8,drops:[
    {item:'bones',qty:1,chance:0.5},{item:'raw_shrimp',qty:1,chance:0.3},
    {gold:[1,3]}
  ]},
  {id:'spider',name:'Spider',icon:'üï∑Ô∏è',levelReq:5,hp:30,maxHp:30,atk:4,def:1,xp:15,drops:[
    {item:'bronze_helmet',qty:1,chance:0.04},{item:'bronze_shield',qty:1,chance:0.04},
    {gold:[2,8]}
  ]},
  {id:'bandit',name:'Bandit',icon:'ü•∑',levelReq:10,hp:45,maxHp:45,atk:6,def:2,xp:20,drops:[
    {item:'bronze_sword',qty:1,chance:0.15},{item:'bronze_body',qty:1,chance:0.05},{item:'silver_ore',qty:1,chance:0.2},
    {gold:[5,15]}
  ]},
  {id:'skeleton',name:'Skeleton',icon:'üíÄ',levelReq:20,hp:70,maxHp:70,atk:8,def:3,xp:30,drops:[
    {item:'bones',qty:1,chance:1},{item:'silver_ore',qty:2,chance:0.4},{item:'silver_sword',qty:1,chance:0.06},
    {gold:[8,20]}
  ]},
  {id:'wolf',name:'Dire Wolf',icon:'üê∫',levelReq:25,hp:85,maxHp:85,atk:10,def:4,xp:38,drops:[
    {item:'bones',qty:1,chance:1},{item:'leather_body',qty:1,chance:0.12},{item:'silver_helmet',qty:1,chance:0.08},
    {gold:[10,25]}
  ]},
  {id:'orc',name:'Orc Warrior',icon:'üëπ',levelReq:30,hp:100,maxHp:100,atk:12,def:6,xp:45,drops:[
    {item:'steel_bar',qty:1,chance:0.4},{item:'steel_helmet',qty:1,chance:0.08},{item:'steel_legs',qty:1,chance:0.06},
    {gold:[15,35]}
  ]},
  {id:'zombie',name:'Zombie',icon:'üßü',levelReq:35,hp:120,maxHp:120,atk:14,def:7,xp:55,drops:[
    {item:'bones',qty:2,chance:1},{item:'steel_bar',qty:1,chance:0.5},{item:'steel_body',qty:1,chance:0.08},
    {gold:[18,40]}
  ]},
  {id:'ghost',name:'Ghost',icon:'üëª',levelReq:40,hp:110,maxHp:110,atk:18,def:5,xp:60,drops:[
    {item:'coal',qty:2,chance:0.6},{item:'mithril_bar',qty:1,chance:0.3},{item:'mithril_shield',qty:1,chance:0.1},
    {gold:[20,50]}
  ]},
  {id:'cave_troll',name:'Cave Troll',icon:'üëπ',levelReq:45,hp:160,maxHp:160,atk:20,def:10,xp:80,drops:[
    {item:'mithril_bar',qty:1,chance:0.5},{item:'mithril_sword',qty:1,chance:0.05},{item:'mithril_body',qty:1,chance:0.1},
    {gold:[30,70]}
  ]},
  {id:'demon',name:'Lesser Demon',icon:'üòà',levelReq:50,hp:180,maxHp:180,atk:24,def:12,xp:100,drops:[
    {item:'mithril_bar',qty:2,chance:0.6},{item:'mithril_helmet',qty:1,chance:0.08},{item:'adamant_ore',qty:1,chance:0.3},
    {gold:[40,90]}
  ]},
  {id:'ogre',name:'Ogre',icon:'üëπ',levelReq:55,hp:220,maxHp:220,atk:28,def:14,xp:120,drops:[
    {item:'adamant_bar',qty:1,chance:0.5},{item:'adamant_body',qty:1,chance:0.06},{item:'adamant_legs',qty:1,chance:0.08},
    {gold:[50,110]}
  ]},
  {id:'dragon',name:'Young Dragon',icon:'üêâ',levelReq:60,hp:280,maxHp:280,atk:32,def:18,xp:150,drops:[
    {item:'adamant_bar',qty:2,chance:0.7},{item:'adamant_body',qty:1,chance:0.1},{item:'adamant_sword',qty:1,chance:0.08},
    {gold:[80,150]}
  ]},
  {id:'lich',name:'Lich',icon:'‚ò†Ô∏è',levelReq:65,hp:250,maxHp:250,atk:36,def:16,xp:180,drops:[
    {item:'bones',qty:5,chance:1},{item:'rune_bar',qty:1,chance:0.5},{item:'rune_shield',qty:1,chance:0.12},
    {gold:[100,200]}
  ]},
  {id:'golem',name:'Stone Golem',icon:'üóø',levelReq:70,hp:350,maxHp:350,atk:30,def:25,xp:200,drops:[
    {item:'runite_ore',qty:2,chance:0.6},{item:'rune_bar',qty:2,chance:0.5},{item:'rune_helmet',qty:1,chance:0.15},
    {gold:[120,250]}
  ]},
  {id:'ancient_dragon',name:'Ancient Dragon',icon:'üê≤',levelReq:80,hp:500,maxHp:500,atk:45,def:30,xp:300,drops:[
    {item:'dragon_ore',qty:2,chance:0.8},{item:'dragon_bar',qty:1,chance:0.5},{item:'dragon_sword',qty:1,chance:0.15},{item:'dragon_shield',qty:1,chance:0.15},
    {gold:[200,400]}
  ]},
];

// ============================================================
// CONTRACTS
// ============================================================
const CONTRACT_TEMPLATES=[
  // Gathering contracts
  {id:'wood_basic',tier:'Basic',icon:'ü™µ',skill:'woodcutting',minLv:1,requirements:[{item:'normal_log',qty:25}],rewards:{gold:100,xp:50}},
  {id:'wood_oak',tier:'Common',icon:'üå≥',skill:'woodcutting',minLv:15,requirements:[{item:'oak_log',qty:20}],rewards:{gold:300,xp:150}},
  {id:'wood_willow',tier:'Uncommon',icon:'üåø',skill:'woodcutting',minLv:30,requirements:[{item:'willow_log',qty:15}],rewards:{gold:600,items:[{id:'bronze_sword',qty:1}],xp:300}},
  {id:'wood_maple',tier:'Rare',icon:'üçÅ',skill:'woodcutting',minLv:45,requirements:[{item:'maple_log',qty:12}],rewards:{gold:1200,items:[{id:'steel_sword',qty:1}],xp:500}},
  {id:'wood_yew',tier:'Epic',icon:'üå≤',skill:'woodcutting',minLv:65,requirements:[{item:'yew_log',qty:10}],rewards:{gold:2400,items:[{id:'mithril_bar',qty:5}],xp:800}},
  
  {id:'ore_basic',tier:'Basic',icon:'‚õ∞Ô∏è',skill:'mining',minLv:1,requirements:[{item:'copper_ore',qty:20},{item:'tin_ore',qty:20}],rewards:{gold:120,xp:50}},
  {id:'ore_iron',tier:'Common',icon:'‚öôÔ∏è',skill:'mining',minLv:15,requirements:[{item:'iron_ore',qty:25}],rewards:{gold:350,xp:150}},
  {id:'ore_coal',tier:'Uncommon',icon:'ü™®',skill:'mining',minLv:30,requirements:[{item:'coal',qty:20}],rewards:{gold:700,items:[{id:'bronze_helmet',qty:1}],xp:300}},
  {id:'ore_mithril',tier:'Rare',icon:'üíé',skill:'mining',minLv:45,requirements:[{item:'mithril_ore',qty:15}],rewards:{gold:1400,items:[{id:'steel_helmet',qty:1}],xp:500}},
  {id:'ore_adamant',tier:'Epic',icon:'üî∞',skill:'mining',minLv:60,requirements:[{item:'adamant_ore',qty:12}],rewards:{gold:2800,items:[{id:'adamant_bar',qty:3}],xp:800}},
  
  {id:'fish_basic',tier:'Basic',icon:'üé£',skill:'fishing',minLv:1,requirements:[{item:'raw_shrimp',qty:30}],rewards:{gold:90,xp:50}},
  {id:'fish_trout',tier:'Common',icon:'üêü',skill:'fishing',minLv:15,requirements:[{item:'raw_trout',qty:25}],rewards:{gold:280,xp:150}},
  {id:'fish_lobster',tier:'Uncommon',icon:'ü¶û',skill:'fishing',minLv:30,requirements:[{item:'raw_lobster',qty:18}],rewards:{gold:650,items:[{id:'bronze_body',qty:1}],xp:300}},
  {id:'fish_swordfish',tier:'Rare',icon:'üó°Ô∏è',skill:'fishing',minLv:55,requirements:[{item:'raw_swordfish',qty:15}],rewards:{gold:1300,items:[{id:'steel_body',qty:1}],xp:500}},
  {id:'fish_shark',tier:'Epic',icon:'ü¶à',skill:'fishing',minLv:75,requirements:[{item:'raw_shark',qty:10}],rewards:{gold:2600,items:[{id:'mithril_helmet',qty:1}],xp:800}},
  
  // Production contracts
  {id:'fire_basic',tier:'Basic',icon:'üî•',skill:'firemaking',minLv:1,requirements:[{item:'normal_log',qty:30}],rewards:{gold:140,xp:60}},
  {id:'fire_willow',tier:'Uncommon',icon:'üî•',skill:'firemaking',minLv:30,requirements:[{item:'willow_log',qty:20}],rewards:{gold:700,xp:320}},
  {id:'fire_yew',tier:'Rare',icon:'üî•',skill:'firemaking',minLv:65,requirements:[{item:'yew_log',qty:12}],rewards:{gold:1600,items:[{id:'mithril_bar',qty:3}],xp:600}},
  
  {id:'smith_bronze',tier:'Common',icon:'üî®',skill:'smithing',minLv:10,requirements:[{item:'bronze_bar',qty:15}],rewards:{gold:400,xp:180}},
  {id:'smith_iron',tier:'Uncommon',icon:'‚öíÔ∏è',skill:'smithing',minLv:25,requirements:[{item:'iron_bar',qty:12}],rewards:{gold:800,items:[{id:'bronze_shield',qty:1}],xp:350}},
  {id:'smith_steel',tier:'Rare',icon:'üõ†Ô∏è',skill:'smithing',minLv:40,requirements:[{item:'steel_bar',qty:10}],rewards:{gold:1600,items:[{id:'steel_shield',qty:1}],xp:550}},
  {id:'smith_mithril',tier:'Epic',icon:'‚öîÔ∏è',skill:'smithing',minLv:55,requirements:[{item:'mithril_bar',qty:8}],rewards:{gold:3200,items:[{id:'mithril_sword',qty:1}],xp:850}},
  
  {id:'cook_basic',tier:'Basic',icon:'üç≥',skill:'cooking',minLv:5,requirements:[{item:'cooked_shrimp',qty:20}],rewards:{gold:150,xp:60}},
  {id:'cook_lobster',tier:'Uncommon',icon:'ü¶û',skill:'cooking',minLv:30,requirements:[{item:'cooked_lobster',qty:12}],rewards:{gold:700,items:[{id:'cooked_shark',qty:3}],xp:320}},
  {id:'cook_shark',tier:'Rare',icon:'ü¶à',skill:'cooking',minLv:50,requirements:[{item:'cooked_shark',qty:8}],rewards:{gold:1500,items:[{id:'cooked_manta',qty:2}],xp:600}},
  
  // Combat contracts
  {id:'combat_bones',tier:'Common',icon:'ü¶¥',skill:'combat',minLv:10,requirements:[{item:'bones',qty:50}],rewards:{gold:400,xp:200}},
  {id:'combat_goblins',tier:'Uncommon',icon:'üë∫',skill:'combat',minLv:20,requirements:[{item:'bronze_sword',qty:3}],rewards:{gold:800,items:[{id:'iron_sword',qty:1}],xp:400}},
  {id:'combat_equipment',tier:'Rare',icon:'‚öîÔ∏è',skill:'combat',minLv:40,requirements:[{item:'steel_bar',qty:10},{item:'mithril_bar',qty:5}],rewards:{gold:2000,items:[{id:'adamant_shield',qty:1}],xp:700}},
];

// ============================================================
// MASTERY UPGRADES
// ============================================================
const MASTERY_UPGRADES={
  woodcutting:[
    {id:'wc_yield',name:'Efficient Chopping',desc:'Gain more resources when woodcutting',effect:'+10% wood yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% wood yield`},
    {id:'wc_speed',name:'Swift Axe',desc:'Chop trees faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'wc_xp',name:'Lumberjack Knowledge',desc:'Gain more XP from woodcutting',effect:'+15% woodcutting XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% woodcutting XP`},
    {id:'wc_mastery',name:'Master Forester',desc:'Gain more mastery when cutting',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  mining:[
    {id:'mn_yield',name:'Keen Eye',desc:'Find more ore per strike',effect:'+10% ore yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% ore yield`},
    {id:'mn_speed',name:'Pickaxe Mastery',desc:'Mine rocks faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'mn_xp',name:'Geological Insight',desc:'Gain more mining XP',effect:'+15% mining XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% mining XP`},
    {id:'mn_mastery',name:'Master Miner',desc:'Gain more mastery when mining',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  fishing:[
    {id:'fh_yield',name:'Lucky Line',desc:'Catch more fish',effect:'+10% fish yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% fish yield`},
    {id:'fh_speed',name:'Nimble Hands',desc:'Fish faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'fh_xp',name:'Angler Expertise',desc:'Gain more fishing XP',effect:'+15% fishing XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% fishing XP`},
    {id:'fh_mastery',name:'Master Angler',desc:'Gain more mastery when fishing',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  firemaking:[
    {id:'fm_xp',name:'Pyromaniac',desc:'Gain more firemaking XP',effect:'+15% firemaking XP',cost:150,maxPurchases:3,stackEffect:(n)=>`+${n*15}% firemaking XP`},
    {id:'fm_speed',name:'Quick Kindle',desc:'Light fires faster',effect:'-5% action time',cost:180,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'fm_mastery',name:'Fire Master',desc:'Gain more mastery from fires',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  smithing:[
    {id:'sm_yield',name:'Precise Smithing',desc:'Sometimes create bonus bars',effect:'+10% bar yield',cost:120,maxPurchases:5,stackEffect:(n)=>`+${n*10}% bar yield`},
    {id:'sm_speed',name:'Forge Efficiency',desc:'Smith faster',effect:'-5% action time',cost:180,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'sm_xp',name:'Metallurgy Mastery',desc:'Gain more smithing XP',effect:'+15% smithing XP',cost:220,maxPurchases:3,stackEffect:(n)=>`+${n*15}% smithing XP`},
    {id:'sm_mastery',name:'Master Smith',desc:'Gain more mastery when smithing',effect:'+20% mastery gain',cost:280,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  cooking:[
    {id:'ck_success',name:'Careful Cooking',desc:'Reduce burn chance',effect:'-5% burn chance',cost:100,maxPurchases:5,stackEffect:(n)=>`-${n*5}% burn chance`},
    {id:'ck_speed',name:'Fast Fire',desc:'Cook food faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'ck_xp',name:'Culinary Arts',desc:'Gain more cooking XP',effect:'+15% cooking XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% cooking XP`},
    {id:'ck_mastery',name:'Master Chef',desc:'Gain more mastery when cooking',effect:'+20% mastery gain',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*20}% mastery gain`},
  ],
  combat:[
    {id:'cb_damage',name:'Combat Prowess',desc:'Deal more damage in combat',effect:'+5% damage',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*5}% damage`},
    {id:'cb_defense',name:'Defensive Stance',desc:'Take less damage',effect:'+3% damage reduction',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*3}% damage reduction`},
    {id:'cb_xp',name:'Battle Experience',desc:'Gain more combat XP',effect:'+12% combat XP',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*12}% combat XP`},
    {id:'cb_drops',name:'Lucky Looter',desc:'Better drop rates',effect:'+8% drop chance',cost:300,maxPurchases:3,stackEffect:(n)=>`+${n*8}% drop chance`},
  ],
};

// ============================================================
// GAME STATE
// ============================================================
const GAME_VERSION = 2; // Increment when making breaking changes

let G = {
  version: GAME_VERSION,
  skills:{
    woodcutting:{xp:0,masteryXp:{}},
    mining:{xp:0,masteryXp:{}},
    fishing:{xp:0,masteryXp:{}},
    firemaking:{xp:0,masteryXp:{}},
    smithing:{xp:0,masteryXp:{}},
    cooking:{xp:0,masteryXp:{}},
    combat:{xp:0,masteryXp:{}},
    // Combat sub-skills
    attack:{xp:0,masteryXp:{}},        // ‚Üí Crit chance
    strength:{xp:0,masteryXp:{}},      // ‚Üí Power (bonus damage)
    haste:{xp:0,masteryXp:{}},         // ‚Üí Attack speed
    defense:{xp:0,masteryXp:{}},       // ‚Üí Armor + Block
    hitpoints:{xp:XP_TABLE[9],masteryXp:{}}, // starts at level 10
  },
  bank:{},
  gold:0,
  equipment:{weapon:null,helmet:null,body:null,legs:null,shield:null,trinket:null},
  combat:{
    active:false,
    monsterId:'goblin',
    playerHp:10,
    maxHp:10,
    monsterHp:0,
    maxMonsterHp:0,
    tickCounter:0,
    log:[],
  },
  activeActions:{},
  actionProgress:{},
  lastSave:Date.now(),
  offlineBanner:null,
  contracts:[],
  contractsLastRefresh:0,
  masteryUpgrades:{}, // Track purchased upgrades: {skillName_upgradeId: count}
};

// ============================================================
// GAME LOGIC
// ============================================================
function getPlayerStats(){
  // Defensive: ensure combat skills exist (in case called during migration)
  if(!G.skills.attack)G.skills.attack={xp:0,masteryXp:{}};
  if(!G.skills.strength)G.skills.strength={xp:0,masteryXp:{}};
  if(!G.skills.haste)G.skills.haste={xp:0,masteryXp:{}};
  if(!G.skills.defense)G.skills.defense={xp:0,masteryXp:{}};
  if(!G.skills.hitpoints)G.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}};
  
  const atkLv=xpToLevel(G.skills.attack.xp);
  const strLv=xpToLevel(G.skills.strength.xp);
  const hasteLv=xpToLevel(G.skills.haste.xp);
  const defLv=xpToLevel(G.skills.defense.xp);
  const hpLv=xpToLevel(G.skills.hitpoints.xp);
  // Combat level = avg of 5 sub-skills (like RS formula simplified)
  const combatLevel=Math.max(1,Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5));

  // Crit chance: 5% base + 0.4% per Attack level (cap 50%)
  const critChance=Math.min(50, 5 + Math.floor(atkLv*0.4));
  // Power: flat bonus damage from Strength level
  const power=Math.floor(strLv*0.6);
  // Attack interval in ticks: base 4, -1 per 33 haste levels (min 2)
  const attackTicks=Math.max(2, 4 - Math.floor(hasteLv/33));
  const attackSpeed=(attackTicks*0.6).toFixed(1)+'s';
  // Armor: defense level + equipment
  let armor=Math.floor(defLv*0.5);
  // Block chance: 2% + 0.2% per defense level (cap 30%)
  const blockChance=Math.min(30, 2 + Math.floor(defLv*0.2));
  // Max HP from hitpoints level
  let maxHp=10 + hpLv*6;

  // Equipment bonuses (atk = overall hit bonus, def = armor)
  let eqAtk=1; let eqDef=0;
  const eq=G.equipment;
  if(eq.weapon&&ITEMS[eq.weapon]){eqAtk+=ITEMS[eq.weapon].atk||0;}
  if(eq.helmet&&ITEMS[eq.helmet]){eqDef+=ITEMS[eq.helmet].def||0; armor+=ITEMS[eq.helmet].def||0;}
  if(eq.body&&ITEMS[eq.body]){eqDef+=ITEMS[eq.body].def||0; armor+=ITEMS[eq.body].def||0;}
  if(eq.legs&&ITEMS[eq.legs]){eqDef+=ITEMS[eq.legs].def||0; armor+=ITEMS[eq.legs].def||0;}
  if(eq.shield&&ITEMS[eq.shield]){eqDef+=ITEMS[eq.shield].def||0; armor+=ITEMS[eq.shield].def||0;}

  // Overall atk/def for combat (kept for compatibility)
  let atk=eqAtk+Math.floor(atkLv*0.5)+Math.floor(strLv*0.3);
  let def=armor;
  
  // Brawler's Trinket bonus (10% to all combat stats)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  if(trinket&&trinket.skill==='combat'){
    atk=Math.floor(atk*1.1);
    armor=Math.floor(armor*1.1);
    def=armor;
  }

  return{atk,def,maxHp,combatLevel,critChance,power,attackTicks,attackSpeed,armor,blockChance,
         atkLv,strLv,hasteLv,defLv,hpLv,eqAtk,eqDef};
}

function getMasteryLevel(skill,actionId){return xpToLevel(G.skills[skill].masteryXp[actionId]||0);}
function getMasteryXp(skill,actionId){return G.skills[skill].masteryXp[actionId]||0;}

function addToBank(itemId,qty){
  G.bank[itemId]=(G.bank[itemId]||0)+qty;
}
function removeFromBank(itemId,qty){
  if(!G.bank[itemId]||G.bank[itemId]<qty)return false;
  G.bank[itemId]-=qty;
  if(G.bank[itemId]<=0)delete G.bank[itemId];
  return true;
}
function hasMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    if((G.bank[k]||0)<v)return false;
  }
  return true;
}
function consumeMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    removeFromBank(k,v);
  }
}

function stopAllActions(){
  // Stop all skill actions
  for(const skill of Object.keys(G.activeActions)){
    delete G.activeActions[skill];
    delete G.actionProgress[skill];
  }
  // Stop smithing craft
  smithingCraftAction=null;
  smithingCraftProgress=0;
  // Stop combat
  if(G.combat.active){
    G.combat.active=false;
  }
  // Update UI
  updateActiveActionDisplay();
}

function startAction(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq)return;
  stopAllActions(); // Stop everything else
  G.activeActions[skill]=actionId;
  G.actionProgress[skill]=0;
  updateActiveActionDisplay();
  renderSkillPage(skill);
  renderSidebar();
}
function stopAction(skill){
  delete G.activeActions[skill];
  delete G.actionProgress[skill];
  updateActiveActionDisplay();
  renderSkillPage(skill);
}

function startCombatAction(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0)G.combat.playerHp=Math.floor(stats.maxHp/2);
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;
  // No level requirement - fight any monster!
  stopAllActions(); // Stop everything else
  G.combat.active=true;
  G.combat.monsterHp=monster.maxHp;
  G.combat.maxMonsterHp=monster.maxHp;
  G.combat.tickCounter=0;
  addCombatLog('‚öîÔ∏è Engaging '+monster.name+'...','clog-p');
  updateActiveActionDisplay();
  renderCombatPage();
}
function stopCombat(){
  G.combat.active=false;
  updateActiveActionDisplay();
  renderCombatPage();
}

function eatFood(itemId){
  // Check if food exists
  if(!ITEMS[itemId]||ITEMS[itemId].cat!=='food'){
    notify('Not a valid food item!','info');
    return;
  }
  // Check if player has it
  if(!G.bank[itemId]||G.bank[itemId]<=0){
    notify('You don\'t have any '+ITEMS[itemId].name+'!','info');
    return;
  }
  // Get current stats
  const stats=getPlayerStats();
  const healAmount=ITEMS[itemId].heals||0;
  const oldHp=G.combat.playerHp;
  
  // Restore HP (capped at max)
  G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+healAmount);
  const actualHeal=G.combat.playerHp-oldHp;
  
  // Remove food from bank
  removeFromBank(itemId,1);
  
  // Show notification and log
  notify(`Ate ${ITEMS[itemId].icon} ${ITEMS[itemId].name} (+${actualHeal} HP)`,'lvl');
  if(G.combat.active){
    addCombatLog(`‚ù§Ô∏è You ate ${ITEMS[itemId].name} and restored ${actualHeal} HP!`,'clog-heal');
  }
  
  // Update UI
  renderCombatPage();
  updateHeader();
}

function addCombatLog(msg,cls='clog-p'){
  G.combat.log.unshift({msg,cls});
  if(G.combat.log.length>40)G.combat.log.pop();
  const el=document.getElementById('combat-log');
  if(el){
    el.innerHTML=G.combat.log.map(l=>`<p class="${l.cls}">${l.msg}</p>`).join('');
  }
}

function processCombatTick(){
  if(!G.combat.active)return;
  G.combat.tickCounter++;

  const stats=getPlayerStats();
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
  const hasCombatTrinket=equippedTrinket&&equippedTrinket.skill==='combat';

  // Passive haste XP each tick
  gainCombatSubXp('haste', 1);

  // Attack check: every attackTicks ticks
  if(G.combat.tickCounter % stats.attackTicks !== 0) return;

  // Determine if this hit crits
  const isCrit = Math.random() * 100 < stats.critChance;
  // Base damage: atk - monster.def + random variance
  let playerDmg = Math.max(1, stats.atk - Math.floor(monster.def/2) + Math.floor(Math.random()*4) - 1 + stats.power);
  if(isCrit) playerDmg = Math.floor(playerDmg * 1.5);
  
  // Apply combat damage bonus from mastery
  const dmgBonus=1+(getMasteryBonus('combat','damage')/100);
  playerDmg=Math.floor(playerDmg*dmgBonus);

  G.combat.monsterHp=Math.max(0,G.combat.monsterHp-playerDmg);
  if(isCrit){
    addCombatLog(`üí• CRIT! You strike ${monster.name} for ${playerDmg} damage!`,'clog-kill');
  } else {
    addCombatLog(`‚öîÔ∏è You hit ${monster.name} for ${playerDmg} damage.`,'clog-hit');
  }

  // XP for hitting (with combat XP bonus)
  let xpBonus=1+(getMasteryBonus('combat','xp')/100);
  if(hasCombatTrinket){
    xpBonus*=1.1; // 10% XP bonus
  }
  gainCombatSubXp('attack', Math.floor((4 + Math.floor(monster.xp * 0.15))*xpBonus));
  gainCombatSubXp('strength', Math.floor((Math.max(1, Math.floor(playerDmg * 0.5) + 2))*xpBonus));

  if(G.combat.monsterHp<=0){
    // On kill: bonus xp to all combat skills + old combat skill
    const killXp = monster.xp;
    gainCombatSubXp('attack', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('strength', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('haste', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('defense', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor(killXp*0.15*xpBonus));
    if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}}; // Safety check
    G.skills.combat.xp += Math.floor(killXp*xpBonus);
    checkCombatLvlUp('combat');
    addCombatLog(`‚ò†Ô∏è ${monster.name} defeated! Combat +${Math.floor(killXp*xpBonus)} XP`,'clog-kill');
    // Loot (with drop bonus from mastery and trinket)
    const dropBonus=getMasteryBonus('combat','drops')/100;
    const trinketBonus=hasCombatTrinket?0.1:0; // 10% loot boost
    let lootText=[];
    for(const drop of monster.drops){
      if(drop.gold){
        let gAmt=drop.gold[0]+Math.floor(Math.random()*(drop.gold[1]-drop.gold[0]+1));
        // Apply trinket bonus to gold
        if(trinketBonus>0)gAmt=Math.floor(gAmt*(1+trinketBonus));
        G.gold+=gAmt;lootText.push(`${gAmt}gp`);
      } else {
        const dropChance=Math.min(1,drop.chance+dropBonus+trinketBonus);
        if(Math.random()<dropChance){
          addToBank(drop.item,drop.qty);
          lootText.push(`${drop.qty}x ${ITEMS[drop.item].name}`);
        }
      }
    }
    // Brawler's Trinket drop chance
    if(!G.bank['brawlers_trinket']){
      const atkLv=xpToLevel(G.skills.attack.xp);
      const strLv=xpToLevel(G.skills.strength.xp);
      const hasteLv=xpToLevel(G.skills.haste.xp);
      const defLv=xpToLevel(G.skills.defense.xp);
      const hpLv=xpToLevel(G.skills.hitpoints.xp);
      const combatLv=Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5);
      const dropChance=0.001+(combatLv*0.0001);
      if(Math.random()<dropChance){
        addToBank('brawlers_trinket',1);
        notify(`‚ú® ${ITEMS['brawlers_trinket'].name} found!`,'item');
      }
    }
    if(lootText.length)addCombatLog('üí∞ Loot: '+lootText.join(', '),'clog-loot');
    G.combat.monsterHp=monster.maxHp;
    G.combat.maxMonsterHp=monster.maxHp;
    return;
  }

  // Monster attacks player
  // Block check
  const blocked = Math.random()*100 < stats.blockChance;
  let monsterDmg = Math.max(0, monster.atk - Math.floor(stats.armor/3) + Math.floor(Math.random()*3) - 1);
  
  // Apply damage reduction from mastery
  const dmgReduction=1-(getMasteryBonus('combat','defense')/100);
  monsterDmg=Math.floor(monsterDmg*dmgReduction);
  
  if(blocked){ monsterDmg=0; addCombatLog(`üõ°Ô∏è You block ${monster.name}'s attack!`,'clog-p'); }
  else {
    G.combat.playerHp=Math.max(0,G.combat.playerHp-monsterDmg);
    addCombatLog(`üí¢ ${monster.name} hits you for ${monsterDmg} damage.`,'clog-mhit');
  }

  // XP for being hit
  if(monsterDmg>0){
    gainCombatSubXp('defense', Math.floor((3 + Math.floor(monsterDmg*0.4))*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor((2 + Math.floor(monsterDmg*0.25))*xpBonus));
  } else if(blocked){
    gainCombatSubXp('defense', Math.floor(5*xpBonus));
  }

  // Auto-eat if HP < 40%
  if(G.combat.playerHp/stats.maxHp<0.4){
    const foods=['cooked_salmon','cooked_trout','cooked_shrimp'];
    for(const f of foods){
      if(G.bank[f]&&G.bank[f]>0){
        const heal=ITEMS[f].heals;
        removeFromBank(f,1);
        G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+heal);
        addCombatLog(`üçñ You eat ${ITEMS[f].name} and heal ${heal} HP.`,'clog-eat');
        break;
      }
    }
  }

  if(G.combat.playerHp<=0){
    G.combat.active=false;
    G.combat.playerHp=Math.floor(stats.maxHp/2);
    addCombatLog('üíÄ You have been defeated! Respawning with half HP...','clog-die');
  }

  renderCombatHP();
}

function gainCombatSubXp(skill, amount){
  if(!G.skills[skill])return;
  const prev=xpToLevel(G.skills[skill].xp);
  G.skills[skill].xp+=amount;
  const next=xpToLevel(G.skills[skill].xp);
  if(next>prev) checkCombatLvlUp(skill);
}
function checkCombatLvlUp(skill){
  if(!G.skills[skill])return; // Safety check
  const lv=xpToLevel(G.skills[skill].xp);
  const names={attack:'Attack',strength:'Strength',haste:'Haste',defense:'Defense',hitpoints:'Hitpoints',combat:'Combat'};
  notify(`üéâ ${names[skill]||skill} Level Up! Level ${lv}`,'lvl');
  if(currentPage==='stats')renderStatsPage();
}

function processSkillTick(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq){stopAction(skill);return;}

  G.actionProgress[skill]=(G.actionProgress[skill]||0)+1;
  const ticks=getMasteryTicks(action,getMasteryLevel(skill,actionId));
  if(G.actionProgress[skill]<ticks)return;
  G.actionProgress[skill]=0;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;

  // Check materials for production
  if(action.consumes){
    if(!hasMaterials(action.consumes)){
      stopAction(skill);
      notify('Out of materials for '+action.name+'!','info');
      return;
    }
    // Check for trinket save chance (25% for production skills)
    const shouldSave=equippedTrinket&&equippedTrinket.skill===skill&&Math.random()<0.25;
    if(!shouldSave){
      consumeMaterials(action.consumes);
    }
  }

  // Gain XP (with mastery upgrade bonus and trinket bonus)
  const prevLv=xpToLevel(G.skills[skill].xp);
  let xpBonus=1+(getMasteryBonus(skill,'xp')/100);
  // Apply trinket XP bonus (10%)
  if(equippedTrinket&&equippedTrinket.skill===skill){
    xpBonus*=1.1; // 10% XP bonus
  }
  G.skills[skill].xp+=Math.floor(action.xp*xpBonus);
  const newLv=xpToLevel(G.skills[skill].xp);
  if(newLv>prevLv)notify(`üéâ ${skill.charAt(0).toUpperCase()+skill.slice(1)} Level Up! Level ${newLv}`,'lvl');

  // Gain mastery XP (with mastery upgrade bonus)
  if(action.masteryXp){
    const prevMlv=getMasteryLevel(skill,actionId);
    const mastBonus=1+(getMasteryBonus(skill,'mastery')/100);
    G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+Math.floor(action.masteryXp*mastBonus);
    const newMlv=getMasteryLevel(skill,actionId);
    if(newMlv>prevMlv)notify(`‚≠ê ${action.name} Mastery ${newMlv}!`,'lvl');
  }

  // Produce item (with yield bonus)
  if(action.produces){
    let produced=action.produces;
    let qty=action.qty||1;
    // Burn chance for cooking (reduced by mastery upgrade)
    if(action.burnChance){
      const skillLv=xpToLevel(G.skills[skill].xp);
      const mastLv=getMasteryLevel(skill,actionId);
      const burnReduction=getMasteryBonus(skill,'success');
      const burnChance=Math.max(0,action.burnChance-(skillLv*0.005)-(mastLv*0.003)-(burnReduction/100));
      if(Math.random()<burnChance){produced=action.burnItem;qty=1;}
    }
    // Apply yield bonus
    const yieldBonus=1+(getMasteryBonus(skill,'yield')/100);
    // Apply trinket bonus (2x for gathering skills)
    if(equippedTrinket&&equippedTrinket.skill===skill){
      qty=Math.floor(qty*yieldBonus*2); // 2x with trinket
    }else{
      qty=Math.floor(qty*yieldBonus);
    }
    if(qty<1)qty=1;
    addToBank(produced,qty);
  }
  
  // Trinket drop chance (scales with level: 0.1% + 0.01% per level)
  const trinketMap={woodcutting:'woodcutters_trinket',mining:'miners_trinket',fishing:'fishermans_trinket',firemaking:'firemakers_trinket',smithing:'smiths_trinket',cooking:'chefs_trinket'};
  const skillTrinketId=trinketMap[skill];
  if(skillTrinketId&&!G.bank[skillTrinketId]){
    const dropChance=0.001+(lv*0.0001); // 0.1% base + 0.01% per level
    if(Math.random()<dropChance){
      addToBank(skillTrinketId,1);
      notify(`‚ú® ${ITEMS[skillTrinketId].name} found!`,'item');
    }
  }
}

function getMasteryTicks(action,mastLv){
  const reduction=Math.floor(mastLv/15);
  // Apply speed bonus from mastery upgrades
  const skill=action.skill||'woodcutting'; // Fallback, should always have skill
  const speedBonus=getMasteryBonus(skill,'speed');
  const speedMult=1-(speedBonus/100);
  const baseTicks=Math.max(2,action.ticks-reduction);
  return Math.max(2,Math.floor(baseTicks*speedMult));
}

// ============================================================
// MAIN GAME LOOP (600ms tick)
// ============================================================
let tickCount=0;
setInterval(()=>{
  tickCount++;
  // Process skill actions
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue; // Skip - handled separately below
    processSkillTick(skill,actionId);
  }
  // Process smithing crafts
  if(G.activeActions['smithingCraft']){
    processCraftTick(G.activeActions['smithingCraft']);
  }
  // Process combat
  if(G.combat.active)processCombatTick();
  // Update HP regen (out of combat: 1 HP per 10 ticks)
  if(!G.combat.active){
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp<stats.maxHp&&tickCount%10===0){
      G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+1);
    }
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  }
  // Render updates
  updateProgressBars();
  updateHeader();
  updateActiveActionDisplay();
  if(getCurrentPage()==='combat')renderCombatHP();
  if(getCurrentPage()==='bank')renderBank();
  if(getCurrentPage()==='equipment'){renderEquipPage();}
  if(getCurrentPage()==='stats')renderStatsPage();
  // Auto-save every 30 ticks (~18s)
  if(tickCount%30===0)saveGame();
},600);

let smithingCraftAction=null;
let smithingCraftProgress=0;
function startCraft(actionId){
  const action=ACTIONS.smithingCraft.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills.smithing){
    G.skills.smithing={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills.smithing.xp);
  if(lv<action.levelReq){notify('Level '+action.levelReq+' Smithing required.','info');return;}
  if(!hasMaterials(action.consumes)){notify('Not enough materials!','info');return;}
  stopAllActions(); // Stop everything else
  smithingCraftAction=action;
  smithingCraftProgress=0;
  G.activeActions['smithingCraft']=actionId; // Mark as active
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function stopCraft(){
  smithingCraftAction=null;
  smithingCraftProgress=0;
  delete G.activeActions['smithingCraft'];
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function processCraftTick(id){
  if(!smithingCraftAction||smithingCraftAction.id!==id)return;
  smithingCraftProgress++;
  
  // Apply speed bonus
  const speedBonus=getMasteryBonus('smithing','speed');
  const speedMult=1-(speedBonus/100);
  const adjustedTicks=Math.max(2,Math.floor(smithingCraftAction.ticks*speedMult));
  
  if(smithingCraftProgress<adjustedTicks)return;
  smithingCraftProgress=0;
  if(!hasMaterials(smithingCraftAction.consumes)){
    stopCraft();
    notify('Out of materials!','info');
    return;
  }
  // Check for trinket save chance (25% for smithing)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  const shouldSave=trinket&&trinket.skill==='smithing'&&Math.random()<0.25;
  if(!shouldSave){
    consumeMaterials(smithingCraftAction.consumes);
  }
  const prevLv=xpToLevel(G.skills.smithing.xp);
  
  // Apply XP bonus (with trinket)
  let xpBonus=1+(getMasteryBonus('smithing','xp')/100);
  if(trinket&&trinket.skill==='smithing'){
    xpBonus*=1.1; // 10% XP bonus
  }
  G.skills.smithing.xp+=Math.floor(smithingCraftAction.xp*xpBonus);
  
  const newLv=xpToLevel(G.skills.smithing.xp);
  if(newLv>prevLv)notify(`üéâ Smithing Level Up! Level ${newLv}`,'lvl');
  
  // Apply yield bonus
  const yieldBonus=1+(getMasteryBonus('smithing','yield')/100);
  const qty=Math.max(1,Math.floor(smithingCraftAction.qty*yieldBonus));
  addToBank(smithingCraftAction.produces,qty);
  
  // Trinket drop chance
  if(!G.bank['smiths_trinket']){
    const lv=xpToLevel(G.skills.smithing.xp);
    const dropChance=0.001+(lv*0.0001);
    if(Math.random()<dropChance){
      addToBank('smiths_trinket',1);
      notify(`‚ú® ${ITEMS['smiths_trinket'].name} found!`,'item');
    }
  }
}
// Override to handle smithingCraft special case
const _origActiveActions=G.activeActions;
G.activeActions=new Proxy(_origActiveActions,{
  set(t,k,v){
    if(k==='smithingCraft'){smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===v);smithingCraftProgress=0;t[k]=v;return true;}
    return Reflect.set(t,k,v);
  },
  deleteProperty(t,k){
    if(k==='smithingCraft'){smithingCraftAction=null;smithingCraftProgress=0;}
    return Reflect.deleteProperty(t,k);
  }
});

// ============================================================
// SAVE / LOAD
// ============================================================
async function saveGame(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  // Remove non-serializable
  try{
    await window.storage.set('grindia_save',JSON.stringify(data));
  }catch(e){try{localStorage.setItem('grindia_save',JSON.stringify(data));}catch(e2){}}
}
async function loadGame(){
  try{
    let raw=null;
    try{const r=await window.storage.get('grindia_save');if(r)raw=r.value;}catch(e){}
    if(!raw)try{raw=localStorage.getItem('grindia_save');}catch(e){}
    if(!raw)return false;
    const saved=JSON.parse(raw);
    
    // VERSION MIGRATION: Handle saves from older versions
    const savedVersion = saved.version || 1;
    if(savedVersion < GAME_VERSION){
      console.log(`Migrating save from v${savedVersion} to v${GAME_VERSION}`);
      // v1 -> v2: Added attack/strength/haste/defense/hitpoints skills
      if(savedVersion < 2){
        // Initialize new combat skills if they don't exist
        if(!saved.skills.attack)saved.skills.attack={xp:0,masteryXp:{}};
        if(!saved.skills.strength)saved.skills.strength={xp:0,masteryXp:{}};
        if(!saved.skills.haste)saved.skills.haste={xp:0,masteryXp:{}};
        if(!saved.skills.defense)saved.skills.defense={xp:0,masteryXp:{}};
        if(!saved.skills.hitpoints)saved.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}}; // Start at lv 10
      }
      saved.version = GAME_VERSION;
    }
    
    // Offline progress
    const now=Date.now();
    const elapsedMs=Math.max(0,now-(saved.lastSave||now));
    const elapsedTicks=Math.min(Math.floor(elapsedMs/600),48000); // cap 8h
    // Merge saved state (don't overwrite new skills that didn't exist in old save)
    G.version = GAME_VERSION;
    if(saved.skills){
      for(const k of Object.keys(G.skills)){
        if(saved.skills[k])G.skills[k]=saved.skills[k];
      }
    }
    G.bank=saved.bank||{};
    G.gold=saved.gold||0;
    G.equipment=saved.equipment||G.equipment;
    G.combat={...G.combat,...(saved.combat||{})};
    // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
    for(const k of Object.keys(G.activeActions)){
      delete G.activeActions[k];
    }
    if(saved.activeActions){
      for(const [k,v] of Object.entries(saved.activeActions)){
        G.activeActions[k]=v; // This triggers the Proxy set handler
      }
    }
    G.actionProgress=saved.actionProgress||{};
    G.contracts=saved.contracts||[];
    G.contractsLastRefresh=saved.contractsLastRefresh||Date.now(); // Set to now if not present to avoid immediate refresh
    G.masteryUpgrades=saved.masteryUpgrades||{};
    // Restore smithingCraft
    if(G.activeActions.smithingCraft){
      smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
    }
    // Validate HP
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
    // Offline ticks simulation
    if(elapsedTicks>0){
      const results=simulateOffline(elapsedTicks);
      if(results.length>0){
        const hrs=Math.floor(elapsedMs/3600000);
        const mins=Math.floor((elapsedMs%3600000)/60000);
        G.offlineBanner={time:`${hrs}h ${mins}m`,results};
      }
    }
    return true;
  }catch(e){console.error('Load failed',e);return false;}
}
function simulateOffline(ticks){
  const results=[];
  // Only process the first active action (one at a time)
  const activeEntries=Object.entries(G.activeActions);
  if(activeEntries.length===0)return results;
  
  const [skill,actionId]=activeEntries[0];
  if(skill==='smithingCraft'){
    // Handle smithing craft separately
    if(smithingCraftAction){
      const completions=Math.floor(ticks/smithingCraftAction.ticks);
      let produced=0;
      for(let i=0;i<completions;i++){
        if(!hasMaterials(smithingCraftAction.consumes))break;
        consumeMaterials(smithingCraftAction.consumes);
        G.skills.smithing.xp+=smithingCraftAction.xp;
        addToBank(smithingCraftAction.produces,smithingCraftAction.qty||1);
        produced++;
      }
      if(produced>0)results.push(`${produced}x ${ITEMS[smithingCraftAction.produces].name} crafted`);
    }
    return results;
  }
  
  const skillActions=ACTIONS[skill];
  if(!skillActions)return results;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return results;
  const mastLv=getMasteryLevel(skill,actionId);
  const actionTicks=getMasteryTicks(action,mastLv);
  const completions=Math.floor(ticks/actionTicks);
  if(completions<=0)return results;
  
  let produced=0;
  for(let i=0;i<completions;i++){
    if(action.consumes){
      if(!hasMaterials(action.consumes))break;
      consumeMaterials(action.consumes);
    }
    G.skills[skill].xp+=action.xp;
    if(action.masteryXp)G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+action.masteryXp;
    if(action.produces){
      let p=action.produces;
      if(action.burnChance&&Math.random()<0.1)p=action.burnItem;
      addToBank(p,action.qty||1);
      produced++;
    }
  }
  if(produced>0)results.push(`${produced}x ${ITEMS[action.produces]?ITEMS[action.produces].name:action.name}`);
  else if(completions>0)results.push(`${completions}x ${action.name} completed`);
  
  return results;
}
function manualSave(){saveGame();notify('Game saved!','info');}

function exportSave(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`grindia-save-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  notify('Save exported!','info');
}

function importSave(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='application/json';
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    try{
      const text=await file.text();
      const imported=JSON.parse(text);
      
      // Validate it's a Grindia save
      if(!imported.skills||!imported.bank){
        notify('Invalid save file!','combat');
        return;
      }
      
      // Merge imported data
      G.version=imported.version||1;
      if(imported.skills){
        for(const k of Object.keys(G.skills)){
          if(imported.skills[k])G.skills[k]=imported.skills[k];
        }
      }
      G.bank=imported.bank||{};
      G.gold=imported.gold||0;
      G.equipment=imported.equipment||{weapon:null,helmet:null,body:null,legs:null,shield:null};
      G.combat={...G.combat,...(imported.combat||{})};
      // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
      for(const k of Object.keys(G.activeActions)){
        delete G.activeActions[k];
      }
      if(imported.activeActions){
        for(const [k,v] of Object.entries(imported.activeActions)){
          G.activeActions[k]=v; // This triggers the Proxy set handler
        }
      }
      G.actionProgress=imported.actionProgress||{};
      
      // Restore smithingCraft manually (Proxy should have handled it, but double-check)
      if(!smithingCraftAction && G.activeActions.smithingCraft){
        smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
      }
      
      // Validate and fix HP
      const stats=getPlayerStats();
      G.combat.maxHp=stats.maxHp;
      if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
      
      // Save to storage
      await saveGame();
      
      // Refresh UI
      showPage(currentPage);
      updateHeader();
      updateActiveActionDisplay();
      renderSidebar();
      
      notify('Save imported successfully!','lvl');
    }catch(err){
      console.error('Import error:',err);
      notify('Failed to import save!','combat');
    }
  };
  input.click();
}

// ============================================================
// UI RENDERING
// ============================================================
let currentPage='woodcutting';
function getCurrentPage(){return currentPage;}
function showPage(page){
  currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+page);
  if(pg)pg.classList.add('active');
  // Highlight the right nav item
  const nav=document.getElementById('nav-'+page);
  if(nav)nav.classList.add('active');
  // For combat sub-skills, also highlight their nav items
  const combatSubSkills=['attack','strength','haste','defense','hitpoints'];
  if(page==='stats'){
    combatSubSkills.forEach(s=>{
      const el=document.getElementById('nav-'+s);
      if(el)el.classList.add('active');
    });
  }
  renderSkillPage(page);
  if(page==='bank')renderBank();
  if(page==='equipment')renderEquipPage();
  if(page==='combat')renderCombatPage();
  if(page==='stats')renderStatsPage();
  if(page==='contracts')renderContractsPage();
  if(page==='mastery-shop')renderMasteryShop();
}

function renderSidebar(){
  const skills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat'];
  skills.forEach(s=>{
    if(!G.skills[s])return; // Safety check
    const lv=xpToLevel(G.skills[s].xp);
    const slEl=document.getElementById('sl-'+s);
    if(slEl)slEl.textContent='Lv '+lv;
    const mbEl=document.getElementById('mb-'+s);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[s].xp)*100)+'%';
  });
  // Combat sub-skills
  const stats=getPlayerStats();
  const combatSubs=[
    {key:'attack',stat:`${stats.critChance}% Crit`},
    {key:'strength',stat:`+${stats.power} Pwr`},
    {key:'haste',stat:`${stats.attackSpeed}`},
    {key:'defense',stat:`${stats.armor} Arm`},
    {key:'hitpoints',stat:`${stats.maxHp} HP`},
  ];
  combatSubs.forEach(({key,stat})=>{
    if(!G.skills[key])return; // Safety check
    const lv=xpToLevel(G.skills[key].xp);
    const slEl=document.getElementById('sl-'+key);
    if(slEl)slEl.textContent='Lv '+lv;
    const stEl=document.getElementById('sl-'+key+'-stat');
    if(stEl)stEl.textContent=' ¬∑ '+stat;
    const mbEl=document.getElementById('mb-'+key);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[key].xp)*100)+'%';
  });
}

function renderXPArea(skill){
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const xp=G.skills[skill].xp;
  const lv=xpToLevel(xp);
  const prog=xpProgress(xp)*100;
  const nextXp=lv<99?xpToNextLevel(xp):0;
  return `
    <div class="xp-row">
      <span class="xp-label">Level ${lv}</span>
      <div class="xp-bar"><div class="xp-bar-fill xp-fill-blue" style="width:${prog}%"></div></div>
      <span class="xp-txt">${fmt(xp)} XP ${lv<99?'('+fmt(nextXp)+' to next)':''}</span>
    </div>`;
}

function updateActiveActionDisplay(){
  const display=document.getElementById('active-action-display');
  if(!display)return;
  
  // Check combat first
  if(G.combat.active){
    const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
    if(monster){
      document.getElementById('aad-icon').textContent='‚öîÔ∏è';
      document.getElementById('aad-text').textContent='Fighting '+monster.name;
      display.classList.add('visible');
      return;
    }
  }
  
  // Check smithing craft
  if(smithingCraftAction){
    document.getElementById('aad-icon').textContent=smithingCraftAction.icon;
    document.getElementById('aad-text').textContent='Crafting '+smithingCraftAction.name;
    display.classList.add('visible');
    return;
  }
  
  // Check regular skills
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(action){
      const skillNames={
        woodcutting:'Woodcutting',mining:'Mining',fishing:'Fishing',
        firemaking:'Burning',smithing:'Smelting',cooking:'Cooking'
      };
      document.getElementById('aad-icon').textContent=action.icon;
      document.getElementById('aad-text').textContent=(skillNames[skill]||skill)+' '+action.name;
      display.classList.add('visible');
      return;
    }
  }
  
  // Nothing active
  display.classList.remove('visible');
}

function updateHeader(){
  const stats=getPlayerStats();
  document.getElementById('hdr-gold').textContent=fmt(G.gold);
  document.getElementById('hdr-hp').textContent=Math.floor(G.combat.playerHp)+'/'+stats.maxHp;
  document.getElementById('hdr-atk').textContent=stats.critChance+'%';
  document.getElementById('hdr-def').textContent=stats.armor;
}

function updateProgressBars(){
  renderSidebar();
  const skills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat'];
  skills.forEach(s=>{
    const el=document.getElementById('pgxp-'+s);
    if(el&&currentPage===s)el.innerHTML=renderXPArea(s);
  });
  // Update active action progress bars
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(!action)continue;
    const mastLv=getMasteryLevel(skill,actionId);
    const ticks=getMasteryTicks(action,mastLv);
    const prog=(G.actionProgress[skill]||0)/ticks*100;
    const fill=document.getElementById('prog-fill-'+skill+'-'+actionId);
    if(fill)fill.style.width=prog+'%';
  }
  // Smithing craft progress
  if(smithingCraftAction){
    const fill=document.getElementById('prog-fill-smithing-craft');
    if(fill)fill.style.width=(smithingCraftProgress/smithingCraftAction.ticks*100)+'%';
  }
}

function renderSkillPage(skill){
  if(currentPage!==skill)return;
  // Safety: ensure skill exists
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const xpEl=document.getElementById('pgxp-'+skill);
  if(xpEl)xpEl.innerHTML=renderXPArea(skill);
  const curEl=document.getElementById('cur-'+skill);
  const lv=xpToLevel(G.skills[skill].xp);

  if(['woodcutting','mining','fishing'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const skillActions=ACTIONS[skill];
        const action=skillActions.find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name}</span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">‚ñ† Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            <span class="ac-icon">${a.icon}</span>
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Item: <span>${ITEMS[a.produces]?ITEMS[a.produces].icon+' '+ITEMS[a.produces].name:'-'}</span></div>
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  if(['firemaking','cooking'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name}</span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">‚ñ† Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const hasMat=!a.consumes||hasMaterials(a.consumes);
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        const ingredientHtml=a.consumes?Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id]?ITEMS[id].icon+' ':''} ${qty}x ${ITEMS[id]?ITEMS[id].name:id} (${G.bank[id]||0})</span>`;
        }).join(''):'';
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            <span class="ac-icon">${a.icon}</span>
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            ${a.produces&&ITEMS[a.produces]?`<div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name}</span></div>`:''}
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  if(skill==='smithing'){
    const actionId=G.activeActions[skill];
    const craftId=smithingCraftAction?smithingCraftAction.id:null;
    if(curEl){
      let curHtml='';
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        curHtml+=`<div class="cur-action">
          <span class="ca-label">Smelting:</span>
          <span class="ca-name">${action.icon} ${action.name}</span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopAction('smithing')">‚ñ† Stop</button>
        </div>`;
      }
      if(craftId){
        const prog=smithingCraftProgress/smithingCraftAction.ticks*100;
        curHtml+=`<div class="cur-action" style="border-color:var(--gold)">
          <span class="ca-label">Crafting:</span>
          <span class="ca-name">${smithingCraftAction.icon} ${smithingCraftAction.name}</span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill xp-fill-gold" id="prog-fill-smithing-craft" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopCraft()">‚ñ† Stop</button>
        </div>`;
      }
      curEl.innerHTML=curHtml;
    }
    const grid=document.getElementById('grid-smithing');
    if(grid){
      grid.innerHTML=ACTIONS.smithing.map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv);
        const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} (${G.bank[id]||0})</span>`;
        }).join('');
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\'smithing\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head"><span class="ac-icon">${a.icon}</span><span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Mastery: <span>Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span>${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
    const craftGrid=document.getElementById('grid-smithing-craft');
    if(craftGrid){
      craftGrid.innerHTML=ACTIONS.smithingCraft.map(a=>{
        const locked=lv<a.levelReq;
        const active=smithingCraftAction&&smithingCraftAction.id===a.id;
        const hasMat=!locked&&hasMaterials(a.consumes);
        const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} (${G.bank[id]||0})</span>`;
        }).join('');
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startCraft(\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head"><span class="ac-icon">${a.icon}</span><span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(a.ticks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name}</span></div>
          </div>
        </div>`;
      }).join('');
    }
  }
}

function renderBank(){
  document.getElementById('bank-gold-disp').textContent=fmt(G.gold);
  const cats=['all','logs','ore','bar','fish','food','weapon','armor','trinket','junk'];
  const bankCats=document.getElementById('bank-cats');
  if(bankCats&&!bankCats.dataset.rendered){
    bankCats.innerHTML=cats.map(c=>`<button class="bcat-btn${c==='all'?' active':''}" onclick="filterBank('${c}')" id="bcat-${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</button>`).join('');
    bankCats.dataset.rendered='1';
  }
  const filter=window._bankFilter||'all';
  const grid=document.getElementById('bank-grid');
  const items=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&(filter==='all'||ITEMS[id].cat===filter||
    (filter==='weapon'&&ITEMS[id].cat==='weapon')||(filter==='armor'&&ITEMS[id].cat==='armor')));
  if(items.length===0){grid.innerHTML='<div class="bank-empty">No items here. Start skilling!</div>';return;}
  grid.innerHTML=items.map(([id,qty])=>{
    const item=ITEMS[id];
    return `<div class="b-item">
      <div class="b-sell-menu">
        ${qty>=1?`<button class="b-sell-btn" onclick="sellItem('${id}',1)" title="Sell 1">1x</button>`:''}
        ${qty>=10?`<button class="b-sell-btn" onclick="sellItem('${id}',10)" title="Sell 10">10x</button>`:''}
        ${qty>=100?`<button class="b-sell-btn" onclick="sellItem('${id}',100)" title="Sell 100">100x</button>`:''}
        ${qty>=1000?`<button class="b-sell-btn" onclick="sellItem('${id}',1000)" title="Sell 1000">1kx</button>`:''}
        <button class="b-sell-btn b-sell-all" onclick="sellItem('${id}',${qty})" title="Sell All">All</button>
      </div>
      <div class="b-icon">${item.icon}</div>
      <div class="b-name">${item.name}</div>
      <div class="b-qty">${fmt(qty)}</div>
      ${item.value>0?`<div class="b-val">${item.value}gp ea</div>`:''}
    </div>`;
  }).join('');
}
function filterBank(cat){
  window._bankFilter=cat;
  document.querySelectorAll('.bcat-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('bcat-'+cat);
  if(el)el.classList.add('active');
  renderBank();
}
function sellItem(id,qty){
  if(!G.bank[id]||G.bank[id]<qty)return;
  removeFromBank(id,qty);
  const value=(ITEMS[id]?.value||0)*qty;
  G.gold+=value;
  updateHeader();
  renderBank();
  if(value>0)notify(`Sold ${qty}x ${ITEMS[id].name} for ${value}gp`,'item');
}
function sellAllCategory(cat){
  let totalGold=0;
  for(const [id,qty] of Object.entries(G.bank)){
    if(ITEMS[id]&&ITEMS[id].cat===cat&&qty>0){
      totalGold+=ITEMS[id].value*qty;
      delete G.bank[id];
    }
  }
  G.gold+=totalGold;
  updateHeader();
  renderBank();
  if(totalGold>0)notify(`Sold all ${cat} for ${fmt(totalGold)}gp`,'item');
}

function renderStatsPage(){
  if(currentPage!=='stats')return;
  const stats=getPlayerStats();

  // Calculate total level
  const allSkills=['woodcutting','mining','fishing','firemaking','smithing','cooking','combat','attack','strength','haste','defense','hitpoints'];
  const totalLevel=allSkills.reduce((s,k)=>{
    if(!G.skills[k])return s; // Safety check for missing skills
    return s+xpToLevel(G.skills[k].xp);
  },0);
  const el=document.getElementById('stats-total-level');
  if(el)el.textContent=fmt(totalLevel);

  // Skill overview grid (gathering + production + combat overall)
  const skillRows=[
    {key:'woodcutting',icon:'ü™ì',name:'Woodcutting'},
    {key:'mining',icon:'‚õèÔ∏è',name:'Mining'},
    {key:'fishing',icon:'üé£',name:'Fishing'},
    {key:'firemaking',icon:'üî•',name:'Firemaking'},
    {key:'smithing',icon:'üî®',name:'Smithing'},
    {key:'cooking',icon:'üç≥',name:'Cooking'},
    {key:'combat',icon:'‚öîÔ∏è',name:'Combat'},
  ];
  const sgEl=document.getElementById('stats-skill-grid');
  if(sgEl){
    sgEl.innerHTML=skillRows.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      const xp=G.skills[s.key].xp;
      const lv=xpToLevel(xp);
      const prog=xpProgress(xp)*100;
      return `<div class="sog-item" onclick="showPage('${s.key==='combat'?'combat':s.key}')">
        <span class="sog-icon">${s.icon}</span>
        <div class="sog-info">
          <div class="sog-name">${s.name}</div>
          <div class="sog-level">${lv}</div>
          <div class="sog-xp-bar"><div class="sog-xp-fill" style="width:${prog}%"></div></div>
        </div>
      </div>`;
    }).join('');
  }

  // Combat stat cards
  const combatCards=[
    {icon:'üó°Ô∏è',label:'Attack',sub:'‚Üí Crit Chance',val:`${stats.critChance}%`,color:'var(--crit)',
      lv:stats.atkLv,xp:(G.skills.attack?.xp || 0),desc:'Chance to deal 1.5√ó damage on hit'},
    {icon:'üí™',label:'Strength',sub:'‚Üí Power Bonus',val:`+${stats.power}`,color:'var(--power)',
      lv:stats.strLv,xp:(G.skills.strength?.xp || 0),desc:'Flat damage added to every hit'},
    {icon:'‚ö°',label:'Haste',sub:'‚Üí Attack Speed',val:stats.attackSpeed,color:'var(--haste)',
      lv:stats.hasteLv,xp:(G.skills.haste?.xp || 0),desc:'How often you strike enemies'},
    {icon:'üõ°Ô∏è',label:'Defense',sub:'‚Üí Armor & Block',val:`${stats.armor} / ${stats.blockChance}%`,color:'var(--armor)',
      lv:stats.defLv,xp:(G.skills.defense?.xp || 0),desc:'Damage reduction + chance to fully block'},
    {icon:'‚ù§Ô∏è',label:'Hitpoints',sub:'‚Üí Max Health',val:stats.maxHp,color:'var(--hps)',
      lv:stats.hpLv,xp:(G.skills.hitpoints?.xp || XP_TABLE[9]),desc:'Maximum health pool in combat'},
  ];
  const cgEl=document.getElementById('stats-combat-grid');
  if(cgEl){
    cgEl.innerHTML=combatCards.map(c=>{
      const prog=xpProgress(c.xp)*100;
      return `<div class="combat-stat-card">
        <div class="csc-icon">${c.icon}</div>
        <div class="csc-label">${c.label}</div>
        <div class="csc-value" style="color:${c.color}">${c.val}</div>
        <div class="csc-sublabel">${c.sub}</div>
        <div class="csc-level" style="color:${c.color}">Lv ${c.lv}</div>
        <div class="csc-bar"><div class="csc-bar-fill" style="width:${prog}%;background:${c.color}"></div></div>
      </div>`;
    }).join('');
  }

  // Combat sub-skills XP detail
  const cxEl=document.getElementById('stats-combat-xp');
  if(cxEl){
    const subSkills=[
      {key:'attack',icon:'üó°Ô∏è',name:'Attack',color:'var(--crit)',effect:`${stats.critChance}% crit chance`},
      {key:'strength',icon:'üí™',name:'Strength',color:'var(--power)',effect:`+${stats.power} power bonus`},
      {key:'haste',icon:'‚ö°',name:'Haste',color:'var(--haste)',effect:`Attack every ${stats.attackSpeed}`},
      {key:'defense',icon:'üõ°Ô∏è',name:'Defense',color:'var(--armor)',effect:`${stats.armor} armor, ${stats.blockChance}% block`},
      {key:'hitpoints',icon:'‚ù§Ô∏è',name:'Hitpoints',color:'var(--hps)',effect:`${stats.maxHp} max HP`},
    ];
    cxEl.innerHTML=subSkills.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      const xp=G.skills[s.key].xp;
      const lv=xpToLevel(xp);
      const prog=xpProgress(xp)*100;
      const toNext=lv<99?xpToNextLevel(xp):0;
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;align-items:center">
          <span style="font-weight:600;color:${s.color}">${s.icon} ${s.name} <span style="font-size:12px;font-family:'Share Tech Mono',monospace">Lv ${lv}</span></span>
          <span style="font-size:10px;color:var(--text3)">${s.effect}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
            <div style="width:${prog}%;height:100%;background:${s.color};border-radius:4px;transition:width .4s"></div>
          </div>
          <span style="font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap">${fmt(xp)} XP${lv<99?' ('+fmt(toNext)+' to '+( lv+1)+')':' MAX'}</span>
        </div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Trained during combat${s.key==='haste'?' (passive)':s.key==='attack'?' (on hit)':s.key==='strength'?' (damage dealt)':' (damage taken)'}</div>
      </div>`;
    }).join('');
  }
}

function renderCombatPage(){
  if(currentPage!=='combat')return;
  // XP area
  const xpEl=document.getElementById('pgxp-combat');
  if(xpEl)xpEl.innerHTML=renderXPArea('combat');
  renderCombatHP();
  // Monster select
  const msEl=document.getElementById('monster-select');
  if(msEl){
    if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}}; // Safety check
    const combatLv=xpToLevel(G.skills.combat.xp);
    msEl.innerHTML=MONSTERS.map(m=>{
      const locked=false; // All monsters unlocked!
      const sel=G.combat.monsterId===m.id;
      const dropHints=m.drops.filter(d=>d.item).map(d=>ITEMS[d.item].name).join(', ');
      return `<div class="monster-card${locked?' m-locked':''}${sel?' m-selected':''}" onclick="${locked?'':'selectMonster(\''+m.id+'\')'}">
        <div class="mc-head">
          <span class="mc-icon">${m.icon}</span>
          <span class="mc-name">${m.name}</span>
          <span class="mc-level">Lv ${m.levelReq}+</span>
        </div>
        <div class="mc-stats">
          <div class="mc-stat">HP: <span>${m.maxHp}</span></div>
          <div class="mc-stat">ATK: <span>${m.atk}</span></div>
          <div class="mc-stat">DEF: <span>${m.def}</span></div>
          <div class="mc-stat">XP: <span>${m.xp}</span></div>
        </div>
        <div class="mc-loot">Drops: ${dropHints}</div>
      </div>`;
    }).join('');
  }
  // Food display
  const foodEl=document.getElementById('food-display');
  if(foodEl){
    const foods=['cooked_shrimp','cooked_trout','cooked_salmon','cooked_tuna','cooked_lobster','cooked_bass','cooked_swordfish','cooked_monkfish','cooked_shark','cooked_manta','cooked_turtle'];
    const available=foods.filter(f=>G.bank[f]&&G.bank[f]>0);
    if(available.length===0){
      foodEl.textContent='No food available. Cook some fish first!';
    }
    else{
      foodEl.innerHTML=available.map(f=>`
        <button class="food-btn" onclick="eatFood('${f}')" title="Click to eat">
          ${ITEMS[f].icon} ${ITEMS[f].name} √ó ${G.bank[f]} 
          <span style="color:var(--green2)">(+${ITEMS[f].heals} HP)</span>
        </button>
      `).join('');
    }
  }
}
function renderCombatHP(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  const el=document.getElementById('combatants-display');
  if(!el)return;
  const playerPct=Math.max(0,G.combat.playerHp/stats.maxHp*100);
  const monsterPct=G.combat.active?Math.max(0,G.combat.monsterHp/G.combat.maxMonsterHp*100):100;
  el.innerHTML=`
    <div class="combatant">
      <div class="comb-name" style="color:var(--blue2)">You</div>
      <div class="comb-hp-label">${Math.floor(G.combat.playerHp)} / ${stats.maxHp} HP</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-player" style="width:${playerPct}%"></div></div>
      <div style="font-size:10px;color:var(--text3);margin-top:3px">üó°Ô∏è ${stats.critChance}% Crit &nbsp;üí™ +${stats.power} Pwr &nbsp;‚ö° ${stats.attackSpeed}</div>
    </div>
    <div class="vs-badge">VS</div>
    <div class="combatant">
      <div class="comb-name" style="color:var(--red2)">${monster?monster.icon+' '+monster.name:'No Monster'}</div>
      <div class="comb-hp-label">${G.combat.active?Math.floor(G.combat.monsterHp)+' / '+G.combat.maxMonsterHp+' HP':'--- HP'}</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-monster" style="width:${monsterPct}%"></div></div>
      ${monster?`<div style="font-size:10px;color:var(--text3);margin-top:3px">ATK ${monster.atk} | DEF ${monster.def} | üõ°Ô∏è ${stats.blockChance}% Block</div>`:''}
    </div>`;
}
function selectMonster(id){
  if(G.combat.active)stopCombat();
  G.combat.monsterId=id;
  renderCombatPage();
}
function startCombat(){startCombatAction();}

function renderEquipPage(){
  if(currentPage!=='equipment')return;
  const stats=getPlayerStats();
  const slots=[
    {key:'weapon',label:'Weapon',icon:'‚öîÔ∏è'},
    {key:'helmet',label:'Helmet',icon:'‚õëÔ∏è'},
    {key:'body',label:'Body',icon:'üß•'},
    {key:'legs',label:'Legs',icon:'üëñ'},
    {key:'shield',label:'Shield',icon:'üõ°Ô∏è'},
    {key:'trinket',label:'Trinket',icon:'üíé'},
  ];
  const slotsEl=document.getElementById('equip-slots');
  if(slotsEl){
    slotsEl.innerHTML=`<div style="display:flex;flex-direction:column;gap:8px">
    ${slots.map(s=>{
      const itemId=G.equipment[s.key];
      const item=itemId?ITEMS[itemId]:null;
      return `<div class="equip-slot${item?' filled':''}" onclick="openEquipModal('${s.key}')">
        ${item?`<button class="es-unequip" onclick="event.stopPropagation();unequipItem('${s.key}')">‚úï</button>`:''}
        <div class="es-label">${s.label}</div>
        <div class="es-icon">${item?item.icon:s.icon}</div>
        <div class="${item?'es-name':'es-empty'}">${item?item.name:'Empty'}</div>
        ${item&&(item.atk||item.def)?`<div class="es-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}</div>`:''}
        ${item&&item.bonus?`<div class="es-stat" style="font-size:10px;color:var(--gold2)">${item.bonus}</div>`:''}
      </div>`;
    }).join('')}
    </div>`;
  }
  const statsEl=document.getElementById('stats-display');
  if(statsEl){
    statsEl.innerHTML=`<h3>‚öîÔ∏è Combat Summary</h3>
      <div class="stat-row"><span class="sr-label">Combat Level</span><span class="sr-val">${stats.combatLevel}</span></div>
      <div class="stat-row"><span class="sr-label">üó°Ô∏è Crit Chance</span><span class="sr-val" style="color:var(--crit)">${stats.critChance}%</span></div>
      <div class="stat-row"><span class="sr-label">üí™ Power</span><span class="sr-val" style="color:var(--power)">+${stats.power} dmg</span></div>
      <div class="stat-row"><span class="sr-label">‚ö° Attack Speed</span><span class="sr-val" style="color:var(--haste)">${stats.attackSpeed}</span></div>
      <div class="stat-row"><span class="sr-label">üõ°Ô∏è Armor</span><span class="sr-val" style="color:var(--armor)">${stats.armor}${stats.eqDef?`<span class="sr-bonus">+${stats.eqDef} eq</span>`:''}</span></div>
      <div class="stat-row"><span class="sr-label">üö´ Block Chance</span><span class="sr-val" style="color:var(--armor)">${stats.blockChance}%</span></div>
      <div class="stat-row"><span class="sr-label">‚ù§Ô∏è Max HP</span><span class="sr-val" style="color:var(--hps)">${stats.maxHp}</span></div>
      <div class="stat-row"><span class="sr-label">Current HP</span><span class="sr-val" style="color:var(--green2)">${Math.floor(G.combat.playerHp)}</span></div>`;
  }
  const availEl=document.getElementById('equip-avail-grid');
  if(availEl){
    const equipItems=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&(ITEMS[id].cat==='weapon'||ITEMS[id].cat==='armor'||ITEMS[id].cat==='trinket'));
    if(equipItems.length===0){availEl.innerHTML='<div style="color:var(--text3);font-size:12px;grid-column:1/-1">No equipment in bank. Craft some at the smithery!</div>';}
    else{availEl.innerHTML=equipItems.map(([id,qty])=>{
      const item=ITEMS[id];
      const stats=getPlayerStats();
      let canEquip=true;
      let reqText='';
      if(item.reqAtk&&stats.atkLv<item.reqAtk){canEquip=false;reqText+=`${item.reqAtk} Atk `;}
      if(item.reqStr&&stats.strLv<item.reqStr){canEquip=false;reqText+=`${item.reqStr} Str `;}
      if(item.reqDef&&stats.defLv<item.reqDef){canEquip=false;reqText+=`${item.reqDef} Def `;}
      return `<div class="ea-item${canEquip?'':' ea-locked'}" onclick="equipItemFromBank('${id}')">
        <div class="ea-icon">${item.icon}</div>
        <div class="ea-name">${item.name}</div>
        <div class="ea-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}${item.bonus?item.bonus:''}</div>
        ${reqText?`<div class="ea-req" style="color:var(--red2);font-size:10px">Req: ${reqText}</div>`:''}
        <div class="ea-qty">x${qty} in bank</div>
      </div>`;
    }).join('');}
  }
}

function openEquipModal(slot){
  const equipItems=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&ITEMS[id].slot===slot);
  const modal=document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent='Equip '+slot.charAt(0).toUpperCase()+slot.slice(1);
  const body=document.getElementById('modal-body');
  if(equipItems.length===0){body.innerHTML='<div style="color:var(--text3);padding:10px">No equipment of this type in your bank.</div>';}
  else{
    const stats=getPlayerStats();
    body.innerHTML=equipItems.map(([id,qty])=>{
      const item=ITEMS[id];
      let canEquip=true;
      let reqText='';
      if(item.reqAtk&&stats.atkLv<item.reqAtk){canEquip=false;reqText+=`${item.reqAtk} Atk `;}
      if(item.reqStr&&stats.strLv<item.reqStr){canEquip=false;reqText+=`${item.reqStr} Str `;}
      if(item.reqDef&&stats.defLv<item.reqDef){canEquip=false;reqText+=`${item.reqDef} Def `;}
      return `<div class="equip-list-item${canEquip?'':' eli-locked'}" onclick="${canEquip?'equipItem(\''+id+'\');closeModal()':''}">
        <span class="eli-icon">${item.icon}</span>
        <div class="eli-info">
          <div class="eli-name">${item.name}</div>
          <div class="eli-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}${item.bonus?item.bonus:''}</div>
          ${reqText?`<div style="color:var(--red2);font-size:10px">Requires: ${reqText}</div>`:''}
        </div>
        <span class="eli-qty">x${qty}</span>
      </div>`;
    }).join('');
  }
  modal.classList.add('open');
}
function closeModal(){document.getElementById('modal-overlay').classList.remove('open');}
function equipItem(id){
  const item=ITEMS[id];
  if(!item||!item.slot)return;
  if(!G.bank[id]||G.bank[id]<=0)return;
  
  // Check level requirements
  const stats=getPlayerStats();
  if(item.reqAtk){
    if(stats.atkLv<item.reqAtk){
      notify(`Requires ${item.reqAtk} Attack to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqStr){
    if(stats.strLv<item.reqStr){
      notify(`Requires ${item.reqStr} Strength to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqDef){
    if(stats.defLv<item.reqDef){
      notify(`Requires ${item.reqDef} Defense to equip ${item.name}!`,'info');
      return;
    }
  }
  
  if(G.equipment[item.slot]){
    addToBank(G.equipment[item.slot],1);
  }
  removeFromBank(id,1);
  G.equipment[item.slot]=id;
  renderEquipPage();
  updateHeader();
  notify(`Equipped ${item.name}!`,'item');
}
function equipItemFromBank(id){equipItem(id);}
function unequipItem(slot){
  if(!G.equipment[slot])return;
  const id=G.equipment[slot];
  addToBank(id,1);
  G.equipment[slot]=null;
  renderEquipPage();
  updateHeader();
  notify(`Unequipped ${ITEMS[id].name}`,'info');
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function notify(msg,type='info'){
  const el=document.createElement('div');
  const cls={lvl:'notif-lvl',item:'notif-item',combat:'notif-combat',info:'notif-info'}[type]||'notif-info';
  el.className=`notif ${cls}`;
  el.textContent=msg;
  document.getElementById('notifs').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ============================================================
// OFFLINE BANNER
// ============================================================
function showOfflineBanner(banner){
  if(!banner)return;
  const html=`<div class="offline-banner">
    <div class="ob-icon">‚è∞</div>
    <div class="ob-text">
      <strong>Welcome back!</strong> You were away for ${banner.time}.<br>
      ${banner.results.length>0?'While you were gone: '+banner.results.join(', ')+'!':'Your character rested.'}
    </div>
    <button class="ob-close" onclick="this.parentElement.remove()">‚úï</button>
  </div>`;
  const content=document.getElementById('content');
  const temp=document.createElement('div');
  temp.innerHTML=html;
  content.insertBefore(temp.firstChild,content.firstChild);
}

// ============================================================
// CONTRACTS SYSTEM
// ============================================================
function generateContracts(){
  const contracts=[];
  const availableTemplates=CONTRACT_TEMPLATES.filter(t=>{
    const skillLv=xpToLevel(G.skills[t.skill]?.xp||0);
    return skillLv>=t.minLv;
  });
  
  // Pick 3-5 random contracts from available templates
  const numContracts=3+Math.floor(Math.random()*3);
  const shuffled=[...availableTemplates].sort(()=>Math.random()-0.5);
  for(let i=0;i<Math.min(numContracts,shuffled.length);i++){
    const template=shuffled[i];
    contracts.push({
      id:template.id+'_'+Date.now()+'_'+i,
      templateId:template.id,
      tier:template.tier,
      icon:template.icon,
      skill:template.skill,
      requirements:template.requirements,
      rewards:template.rewards,
      completed:false,
    });
  }
  return contracts;
}

function refreshContracts(){
  G.contracts=generateContracts();
  G.contractsLastRefresh=Date.now();
  renderContractsPage();
  notify('New contracts available!','info');
}

function canCompleteContract(contract){
  for(const req of contract.requirements){
    const have=G.bank[req.item]||0;
    if(have<req.qty)return false;
  }
  return true;
}

function completeContract(contractId){
  const contract=G.contracts.find(c=>c.id===contractId);
  if(!contract||contract.completed)return;
  if(!canCompleteContract(contract)){
    notify('Missing required items!','info');
    return;
  }
  
  // Remove required items
  for(const req of contract.requirements){
    removeFromBank(req.item,req.qty);
  }
  
  // Give rewards
  if(contract.rewards.gold){
    G.gold+=contract.rewards.gold;
  }
  if(contract.rewards.items){
    for(const item of contract.rewards.items){
      addToBank(item.id,item.qty);
      notify(`Received ${item.qty}x ${ITEMS[item.id].name}!`,'item');
    }
  }
  if(contract.rewards.xp&&G.skills[contract.skill]){
    G.skills[contract.skill].xp+=contract.rewards.xp;
  }
  
  contract.completed=true;
  updateHeader();
  renderContractsPage();
  renderSidebar();
  notify(`Contract completed! +${contract.rewards.gold}g`,'item');
  
  // Check if all completed
  if(G.contracts.every(c=>c.completed)){
    setTimeout(()=>refreshContracts(),1000);
  }
}

function renderContractsPage(){
  const grid=document.getElementById('contract-grid');
  const refreshTimer=document.getElementById('contract-refresh-timer');
  
  // Validate contracts - remove any with invalid items
  G.contracts=G.contracts.filter(contract=>{
    return contract.requirements.every(req=>ITEMS[req.item]!==undefined);
  });
  
  // Check if we need to generate initial contracts
  if(G.contracts.length===0){
    G.contracts=generateContracts();
    G.contractsLastRefresh=Date.now();
  }
  
  // Refresh timer
  const CONTRACT_REFRESH_HOURS=4;
  const nextRefresh=G.contractsLastRefresh+(CONTRACT_REFRESH_HOURS*60*60*1000);
  const timeUntil=nextRefresh-Date.now();
  const allCompleted=G.contracts.every(c=>c.completed);
  
  if(allCompleted){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">üîÑ All Complete! Get New Contracts</button>`;
  }else if(timeUntil<=0){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">üîÑ Refresh Available</button>`;
  }else{
    const hours=Math.floor(timeUntil/(60*60*1000));
    const mins=Math.floor((timeUntil%(60*60*1000))/(60*1000));
    refreshTimer.textContent=`Next refresh in ${hours}h ${mins}m, or complete all contracts`;
  }
  
  if(G.contracts.length===0){
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text3)">No contracts available. Check back later!</div>';
    return;
  }
  
  grid.innerHTML=G.contracts.map(contract=>{
    const template=CONTRACT_TEMPLATES.find(t=>t.id===contract.templateId);
    if(!template)return ''; // Safety check - skip if template not found
    const canComplete=canCompleteContract(contract);
    
    const reqHtml=contract.requirements.map(req=>{
      const item=ITEMS[req.item];
      if(!item){
        console.error('Invalid item in contract:',req.item);
        return `<div class="ct-req-item" style="color:var(--red2)">
          <span class="ct-req-icon">‚ùå</span>
          <span class="ct-req-name">Invalid item: ${req.item}</span>
          <span class="ct-req-progress incomplete">0/0</span>
        </div>`;
      }
      const have=G.bank[req.item]||0;
      const complete=have>=req.qty;
      return `<div class="ct-req-item">
        <span class="ct-req-icon">${item.icon}</span>
        <span class="ct-req-name">${item.name}</span>
        <span class="ct-req-progress ${complete?'complete':'incomplete'}">${have}/${req.qty}</span>
      </div>`;
    }).join('');
    
    const rewardParts=[];
    if(contract.rewards.gold)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">ü™ô</span><span class="ct-reward-val">${contract.rewards.gold}g</span></div>`);
    if(contract.rewards.xp)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">‚≠ê</span><span class="ct-reward-val">${contract.rewards.xp} XP</span></div>`);
    if(contract.rewards.items){
      contract.rewards.items.forEach(item=>{
        const it=ITEMS[item.id];
        if(it)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">${it.icon}</span><span class="ct-reward-val">${item.qty}x ${it.name}</span></div>`);
      });
    }
    
    return `<div class="contract-card ${contract.completed?'completed':''}">
      <div class="ct-header">
        <div class="ct-icon">${contract.icon}</div>
        <div class="ct-info">
          <div class="ct-title">${contract.skill.charAt(0).toUpperCase()+contract.skill.slice(1)} Contract</div>
          <div class="ct-tier">${contract.tier} Tier</div>
        </div>
      </div>
      <div class="ct-requirements">
        <div class="ct-req-title">Requirements</div>
        ${reqHtml}
      </div>
      <div class="ct-rewards">${rewardParts.join('')}</div>
      <div class="ct-actions">
        <button class="ct-btn ct-btn-complete" ${!canComplete||contract.completed?'disabled':''} onclick="completeContract('${contract.id}')">
          ${contract.completed?'‚úì Completed':'Complete Contract'}
        </button>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// MASTERY SHOP SYSTEM
// ============================================================
function getTotalMasteryPoints(){
  let total=0;
  for(const skill in G.skills){
    for(const actionId in G.skills[skill].masteryXp){
      const mx=G.skills[skill].masteryXp[actionId];
      const mlv=xpToLevel(mx);
      total+=mlv;
    }
  }
  // Subtract spent points
  for(const key in G.masteryUpgrades){
    total-=getMasteryUpgradeTotalCost(key);
  }
  return total;
}

function getMasteryUpgradeTotalCost(upgradeKey){
  const count=G.masteryUpgrades[upgradeKey]||0;
  const [skill,id]=upgradeKey.split('_',2);
  const fullId=upgradeKey.substring(skill.length+1); // Get the full upgrade ID after skill name
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===fullId);
  if(!upgrade)return 0;
  let total=0;
  for(let i=0;i<count;i++){
    total+=upgrade.cost+(i*50); // Each subsequent purchase costs +50 more
  }
  return total;
}

function purchaseMasteryUpgrade(skill,upgradeId){
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===upgradeId);
  if(!upgrade)return;
  
  const key=`${skill}_${upgradeId}`;
  const owned=G.masteryUpgrades[key]||0;
  
  if(owned>=upgrade.maxPurchases){
    notify('Already purchased maximum!','info');
    return;
  }
  
  const cost=upgrade.cost+(owned*50);
  const available=getTotalMasteryPoints();
  
  if(available<cost){
    notify('Not enough mastery points!','info');
    return;
  }
  
  G.masteryUpgrades[key]=(G.masteryUpgrades[key]||0)+1;
  renderMasteryShop();
  notify(`Purchased ${upgrade.name}!`,'item');
}

function getMasteryBonus(skill,bonusType){
  let bonus=0;
  const upgrades=MASTERY_UPGRADES[skill]||[];
  for(const upgrade of upgrades){
    const key=`${skill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    if(owned>0&&upgrade.id.includes(bonusType)){
      // Extract percentage from effect string
      const match=upgrade.effect.match(/(\d+)%/);
      if(match){
        bonus+=parseInt(match[1])*owned;
      }
    }
  }
  return bonus;
}

function renderMasteryShop(activeSkill='woodcutting'){
  const totalPoints=getTotalMasteryPoints();
  document.getElementById('ms-total-points').textContent=totalPoints;
  
  // Render tabs
  const tabs=document.getElementById('ms-tabs');
  const skillsWithUpgrades=Object.keys(MASTERY_UPGRADES);
  const skillIcons={
    woodcutting:'ü™ì',
    mining:'‚õèÔ∏è',
    fishing:'üé£',
    firemaking:'üî•',
    smithing:'üî®',
    cooking:'üç≥',
    combat:'‚öîÔ∏è'
  };
  tabs.innerHTML=skillsWithUpgrades.map(skill=>{
    const icon=skillIcons[skill]||'‚öôÔ∏è';
    return `<div class="ms-tab ${skill===activeSkill?'active':''}" onclick="renderMasteryShop('${skill}')">
      <span class="ms-tab-icon">${icon}</span>
      ${skill.charAt(0).toUpperCase()+skill.slice(1)}
    </div>`;
  }).join('');
  
  // Render upgrades for active skill
  const grid=document.getElementById('upgrade-grid');
  const upgrades=MASTERY_UPGRADES[activeSkill]||[];
  const skillLv=xpToLevel(G.skills[activeSkill]?.xp||0);
  
  grid.innerHTML=upgrades.map(upgrade=>{
    const key=`${activeSkill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    const cost=upgrade.cost+(owned*50);
    const canAfford=totalPoints>=cost;
    const maxedOut=owned>=upgrade.maxPurchases;
    
    const effectText=upgrade.stackEffect?upgrade.stackEffect(owned+1):upgrade.effect;
    
    return `<div class="upgrade-card ${maxedOut?'purchased':''}">
      <div class="up-header">
        <div class="up-icon">${upgrade.id.includes('yield')?'üìà':upgrade.id.includes('speed')?'‚ö°':upgrade.id.includes('xp')?'‚≠ê':upgrade.id.includes('mastery')?'üåü':'üíé'}</div>
        <div class="up-info">
          <div class="up-name">${upgrade.name}</div>
          <div class="up-desc">${upgrade.desc}</div>
          ${owned>0?`<div class="up-owned">Owned: ${owned}/${upgrade.maxPurchases} - Current: ${upgrade.stackEffect(owned)}</div>`:''}
          ${!maxedOut?`<div class="up-effect">Next: ${effectText}</div>`:''}
        </div>
      </div>
      <div class="up-footer">
        <div class="up-cost">
          <span class="up-cost-icon">‚≠ê</span>
          <span class="up-cost-val">${cost}</span>
        </div>
        ${maxedOut?
          `<div class="up-purchased">‚úì Maxed</div>`:
          `<button class="up-btn" ${!canAfford?'disabled':''} onclick="purchaseMasteryUpgrade('${activeSkill}','${upgrade.id}')">
            Purchase
          </button>`
        }
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// INIT
// ============================================================
async function init(){
  const loaded=await loadGame();
  if(loaded&&G.offlineBanner){showOfflineBanner(G.offlineBanner);G.offlineBanner=null;}
  // Init combat HP
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0||G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  showPage('woodcutting');
  updateHeader();
  updateActiveActionDisplay();
  renderSidebar();
  if(!loaded)notify('Welcome to Grindia! Click a skill on the left to begin.','info');
}
window.addEventListener('beforeunload',()=>saveGame());
init();
</script>
</body>
</html>
