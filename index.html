<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Grindia Idle</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Exo+2:wght@300;400;500;600&family=Share+Tech+Mono&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  /* Core Colors */
  --bg:#0a0c10;--bg2:#0f1318;--bg3:#161c24;--bg4:#1e2530;
  --border:#252d3a;--border2:#2e3a4a;
  --text:#c8d4e0;--text2:#8fa3b8;--text3:#4a6070;
  
  /* Accent Colors */
  --gold:#d4aa3a;--gold2:#f0cc5a;--gold3:#ffe680;
  --blue:#3a8cd4;--blue2:#5aadff;
  --green:#2ea855;--green2:#4fd472;
  --red:#c03030;--red2:#e85050;
  --purple:#7a40d4;--purple2:#9a60f4;
  
  /* Semantic Colors */
  --xp:#1a6bc4;--mastery:#c4820a;
  --crit:#e0503a;--power:#d46a20;--haste:#2abacc;--armor:#5a8fd4;--hps:#3aaa5a;
  
  /* Spacing Scale */
  --space-xs:4px;--space-sm:8px;--space-md:12px;--space-lg:16px;--space-xl:20px;--space-2xl:24px;
  
  /* Border Radius */
  --radius-sm:6px;--radius-md:8px;--radius-lg:10px;--radius-xl:12px;
  
  /* Shadows */
  --shadow-sm:0 1px 2px rgba(0,0,0,0.2);
  --shadow-md:0 2px 4px rgba(0,0,0,0.25),0 1px 2px rgba(0,0,0,0.15);
  --shadow-lg:0 4px 8px rgba(0,0,0,0.3),0 2px 4px rgba(0,0,0,0.2);
  --shadow-xl:0 8px 16px rgba(0,0,0,0.4),0 4px 8px rgba(0,0,0,0.25);
  
  /* Transitions */
  --transition-fast:0.15s ease-out;
  --transition-normal:0.3s ease-out;
  --transition-slow:0.5s ease-out;
}
body{background:var(--bg);color:var(--text);font-family:'Exo 2',sans-serif;font-size:13px;line-height:1.5;height:100vh;display:flex;flex-direction:column;overflow:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse at 20% 20%,rgba(58,140,212,0.05) 0%,transparent 60%),radial-gradient(ellipse at 80% 80%,rgba(212,170,58,0.05) 0%,transparent 60%);pointer-events:none;z-index:0}

/* HEADER */
#header{background:var(--bg2);border-bottom:1px solid var(--border);padding:0 var(--space-lg);height:50px;display:flex;align-items:center;gap:var(--space-md);flex-shrink:0;position:relative;z-index:10;box-shadow:var(--shadow-sm)}
#active-action-display{position:absolute;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--green);border-radius:var(--radius-md);padding:6px var(--space-md);display:none;align-items:center;gap:var(--space-sm);font-size:11px;color:var(--green2);font-weight:500;letter-spacing:0.3px;box-shadow:var(--shadow-md);transition:var(--transition-fast);white-space:nowrap}
#active-action-display.visible{display:flex}
#active-action-display.clickable{cursor:pointer}
#active-action-display.clickable:hover{border-color:var(--gold);box-shadow:var(--shadow-md)}
#tracker-panel{position:absolute;top:50px;left:50%;transform:translateX(-50%);background:var(--bg2);border:1px solid var(--border2);border-radius:var(--radius-lg);padding:14px 16px;min-width:280px;max-width:400px;z-index:200;box-shadow:var(--shadow-xl);display:none}
#tracker-panel.open{display:block;animation:fadeIn 0.15s ease-out}
.tp-section{margin-bottom:10px}
.tp-section:last-child{margin-bottom:0}
.tp-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:600;margin-bottom:6px}
.tp-row{display:flex;align-items:center;justify-content:space-between;padding:3px 0;font-size:11px;border-bottom:1px solid rgba(255,255,255,0.03)}
.tp-row:last-child{border-bottom:none}
.tp-label{color:var(--text2);display:flex;align-items:center;gap:5px}
.tp-vals{display:flex;align-items:center;gap:8px;font-family:'Share Tech Mono',monospace}
.tp-count{color:var(--text);font-weight:600;font-size:11px}
.tp-rate{color:var(--text3);font-size:10px}
.tp-xp{color:var(--xp);font-weight:600}
.tp-gold{color:var(--gold2);font-weight:600}
.tp-divider{height:1px;background:var(--border);margin:8px 0}
.tp-empty{color:var(--text3);font-size:11px;font-style:italic;text-align:center;padding:4px 0}
#active-action-display .aad-icon{font-size:14px}
#active-action-display .aad-dot{width:6px;height:6px;background:var(--green2);border-radius:50%;animation:pulse 1.5s ease-in-out infinite;box-shadow:0 0 4px var(--green2)}
#header h1{font-family:'Cinzel',serif;font-size:20px;color:var(--gold);letter-spacing:2px;text-shadow:0 0 20px rgba(212,170,58,0.5);white-space:nowrap;font-weight:600}
.h-divider{width:1px;height:28px;background:var(--border);flex-shrink:0}
.h-stat{display:flex;align-items:center;gap:6px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:4px 10px;white-space:nowrap;transition:var(--transition-fast)}
.h-stat:hover{border-color:var(--border2)}
.h-stat .hs-label{color:var(--text3);font-size:10px;font-weight:400;letter-spacing:.5px;text-transform:uppercase}
.h-stat .hs-val{color:var(--text);font-weight:600;font-family:'Share Tech Mono',monospace;font-size:13px}
.h-stat .hs-icon{font-size:14px;filter:drop-shadow(0 0 2px rgba(212,170,58,0.3))}
#header .spacer{flex:1}
.hdr-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px var(--space-md);border-radius:var(--radius-md);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);letter-spacing:.5px;font-weight:500}
.hdr-btn:hover{background:var(--bg4);border-color:var(--border2);color:var(--text);transform:translateY(-1px)}
.hdr-btn:active{transform:translateY(0)}

/* MAIN LAYOUT */
#main{display:flex;flex:1;overflow:hidden;position:relative;z-index:1}
#sidebar{width:168px;background:var(--bg2);border-right:1px solid var(--border);overflow-y:auto;flex-shrink:0;display:flex;flex-direction:column;box-shadow:var(--shadow-sm)}
.nav-section{padding:6px 0}
.nav-group-title{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);padding:8px var(--space-md) 4px;font-weight:600}
.nav-item{display:flex;align-items:center;gap:9px;padding:8px var(--space-md);cursor:pointer;border-left:3px solid transparent;transition:var(--transition-fast);position:relative}
.nav-item:hover{background:var(--bg3);border-left-color:var(--border2)}
.nav-item.active{background:var(--bg3);border-left-color:var(--gold);box-shadow:inset 0 0 12px rgba(212,170,58,0.1)}
.nav-item.active .ni-icon{filter:drop-shadow(0 0 4px rgba(212,170,58,0.4))}
.nav-item .ni-icon{font-size:16px;width:24px;height:24px;text-align:center;flex-shrink:0;transition:var(--transition-fast);display:flex;align-items:center;justify-content:center}
.nav-item:hover .ni-icon{transform:scale(1.1)}
.nav-item .ni-info{flex:1;min-width:0}
.nav-item .ni-name{font-size:12px;font-weight:500;color:var(--text);line-height:1.3}
.nav-item .ni-level{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;display:flex;gap:4px;align-items:center;margin-top:2px}
.mini-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:3px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.mini-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease-out}
.mini-bar-xp .mini-bar-fill{background:linear-gradient(90deg,var(--xp),var(--blue2));box-shadow:0 0 4px rgba(26,107,196,0.5)}
.nav-divider{height:1px;background:var(--border);margin:6px 0}

/* CONTENT */
#content{flex:1;overflow-y:auto;padding:var(--space-lg)}
.page{display:none}
.page.active{display:block;animation:fadeIn 0.2s ease-out}
@keyframes fadeIn{from{opacity:0;transform:translateY(4px)}to{opacity:1;transform:translateY(0)}}

/* Make current action containers sticky */
#cur-woodcutting,#cur-mining,#cur-fishing,#cur-smithing,#cur-cooking,#cur-woodworking,#cur-prospecting,#cur-jewelcrafting{
  position:sticky;
  top:-16px;
  z-index:100;
  margin:-16px -16px 0 -16px;
  padding:16px 16px 0 16px;
  background:var(--bg);
}

.pg-header{display:flex;align-items:flex-start;gap:14px;margin-bottom:var(--space-lg);padding-bottom:var(--space-md);border-bottom:1px solid var(--border)}
.pg-icon{font-size:36px;line-height:1;margin-top:2px;filter:drop-shadow(0 0 6px rgba(212,170,58,0.3))}
.pg-title h2{font-family:'Cinzel',serif;font-size:18px;color:var(--gold);font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.3);letter-spacing:0.5px}
.pg-xp-area{margin-top:8px;display:flex;flex-direction:column;gap:4px}
.xp-row{display:flex;align-items:center;gap:var(--space-sm)}
.xp-label{font-size:10px;color:var(--text3);width:50px;flex-shrink:0;font-weight:500}
.xp-bar{flex:1;height:8px;background:var(--bg4);border-radius:var(--radius-sm);overflow:hidden;min-width:120px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.xp-bar-fill{height:100%;border-radius:var(--radius-sm);transition:width 0.4s ease-out}
.xp-fill-blue{background:linear-gradient(90deg,var(--xp),var(--blue2));box-shadow:0 0 6px rgba(26,107,196,0.4)}
.xp-fill-gold{background:linear-gradient(90deg,var(--mastery),var(--gold2));box-shadow:0 0 6px rgba(196,130,10,0.4)}
.xp-txt{font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap}

.action-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:var(--space-md);margin-bottom:var(--space-lg)}
.action-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-md);cursor:pointer;transition:var(--transition-fast);position:relative;overflow:hidden;box-shadow:var(--shadow-sm)}
.action-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03) 0%,transparent 100%);pointer-events:none}
.action-card:hover:not(.locked){border-color:var(--border2);background:var(--bg3);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.action-card.active-action{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.1) 0%,var(--bg2) 100%);box-shadow:0 0 12px rgba(46,168,85,0.2)}
.action-card.locked{opacity:.45;cursor:not-allowed}
.ac-head{display:flex;align-items:center;gap:var(--space-sm);margin-bottom:var(--space-sm)}
.ac-icon{font-size:24px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}

/* ── ICON PILL SYSTEM ───────────────────────────────────────────────────── */
.icon-pill{
  display:inline-flex;align-items:center;justify-content:center;
  border-radius:8px;border:1px solid;flex-shrink:0;line-height:1;
  box-shadow:inset 0 1px 0 rgba(255,255,255,0.07),0 2px 4px rgba(0,0,0,0.35);
  position:relative;overflow:hidden;
}
.icon-pill::after{
  content:'';position:absolute;inset:0;
  background:linear-gradient(160deg,rgba(255,255,255,0.08) 0%,transparent 60%);
  pointer-events:none;border-radius:inherit;
}
/* sizes */
.icon-pill-sm{font-size:14px;width:28px;height:28px;}
.icon-pill-md{font-size:22px;width:38px;height:38px;}
.icon-pill-lg{font-size:30px;width:50px;height:50px;}
.icon-pill-xl{font-size:22px;width:32px;height:32px;}
/* nav sidebar size */
.ni-icon .icon-pill{font-size:13px;width:22px;height:22px;border-radius:5px;}
/* category colours: bg / border */
.ip-logs    {background:rgba(62,42,18,0.85);  border-color:rgba(155,100,45,0.6);}
.ip-ore     {background:rgba(52,46,38,0.85);  border-color:rgba(130,108,78,0.6);}
.ip-bar     {background:rgba(38,48,62,0.85);  border-color:rgba(100,125,162,0.6);}
.ip-fish    {background:rgba(18,42,72,0.85);  border-color:rgba(55,108,185,0.6);}
.ip-food    {background:rgba(68,35,12,0.85);  border-color:rgba(185,112,38,0.6);}
.ip-gem     {background:rgba(48,22,72,0.85);  border-color:rgba(135,65,195,0.6);}
.ip-jewelry {background:rgba(45,32,8,0.85);   border-color:rgba(198,155,28,0.6);}
.ip-weapon  {background:rgba(62,15,15,0.85);  border-color:rgba(165,42,42,0.6);}
.ip-armor   {background:rgba(22,32,58,0.85);  border-color:rgba(65,92,158,0.6);}
.ip-tool    {background:rgba(55,38,18,0.85);  border-color:rgba(142,98,42,0.6);}
.ip-trinket {background:rgba(48,40,8,0.85);   border-color:rgba(215,178,35,0.7);}
.ip-material{background:rgba(12,52,52,0.85);  border-color:rgba(28,162,162,0.6);}
.ip-junk    {background:rgba(25,22,18,0.85);  border-color:rgba(65,58,48,0.5);}
.ip-combat  {background:rgba(62,12,12,0.85);  border-color:rgba(165,35,35,0.6);}
.ip-skill   {background:rgba(18,25,38,0.85);  border-color:rgba(58,112,185,0.5);}
.ip-misc    {background:rgba(22,22,28,0.85);  border-color:rgba(65,65,85,0.5);}
/* action card icon — slightly larger pill */
.ac-head .icon-pill{font-size:20px;width:34px;height:34px;}
/* bank icon pill */
.b-icon .icon-pill{font-size:26px;width:44px;height:44px;border-radius:10px;margin-bottom:4px;}
/* page header icon */
.pg-icon .icon-pill{font-size:28px;width:46px;height:46px;border-radius:10px;}
/* contract icon */
.ct-icon .icon-pill{font-size:30px;width:46px;height:46px;border-radius:10px;}
/* ob-icon (offline banner) */
.ob-icon .icon-pill{font-size:24px;width:38px;height:38px;}
.ac-name{font-weight:600;font-size:13px;flex:1;line-height:1.3}
.ac-lock{font-size:10px;background:var(--bg4);border:1px solid var(--border);border-radius:var(--radius-sm);padding:2px 6px;color:var(--text3);font-weight:500}
.ac-stats{font-size:11px;color:var(--text2);display:grid;grid-template-columns:1fr 1fr;gap:3px var(--space-sm);line-height:1.4}
.ac-stat span{color:var(--text);font-weight:500}
.ac-mastery{margin-top:var(--space-sm);border-top:1px solid var(--border);padding-top:6px}
.ac-m-row{display:flex;justify-content:space-between;margin-bottom:3px;font-size:10px;color:var(--text3);font-weight:500}
.ac-m-row span{color:var(--mastery)}
.ac-m-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.ac-m-fill{height:100%;background:linear-gradient(90deg,var(--mastery),var(--gold2));border-radius:2px;transition:width 0.4s ease-out;box-shadow:0 0 4px rgba(196,130,10,0.4)}
.active-dot{position:absolute;top:var(--space-sm);right:var(--space-sm);width:8px;height:8px;background:var(--green2);border-radius:50%;box-shadow:0 0 8px var(--green2);animation:pulse 1.5s ease-in-out infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.4;transform:scale(0.9)}}

.cur-action{background:var(--bg2);border:1px solid var(--green);border-radius:var(--radius-lg);padding:var(--space-md) 14px;margin-bottom:14px;display:flex;align-items:center;gap:var(--space-md);box-shadow:var(--shadow-md)}
.ca-label{font-size:11px;color:var(--text2);white-space:nowrap;font-weight:500}
.ca-name{font-weight:600;color:var(--green2);flex:1}
.ca-prog-wrap{flex:1;max-width:180px}
.ca-prog-bar{height:6px;background:var(--bg4);border-radius:3px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.ca-prog-fill{height:100%;background:linear-gradient(90deg,var(--green),var(--green2));border-radius:3px;transition:width .1s linear;box-shadow:0 0 4px rgba(46,168,85,0.5)}
.ca-stop{background:transparent;border:1px solid var(--border);color:var(--text3);padding:4px 10px;border-radius:var(--radius-sm);cursor:pointer;font-size:11px;transition:var(--transition-fast);font-family:'Exo 2',sans-serif;font-weight:500}
.ca-stop:hover{border-color:var(--red);color:var(--red2);background:rgba(192,48,48,0.1)}
.ca-stop:active{transform:scale(0.95)}

/* BANK */
.bank-top{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-md)}
.bank-gold{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:600;color:var(--gold2);font-family:'Share Tech Mono',monospace;text-shadow:0 0 8px rgba(240,204,90,0.3)}
.bank-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(84px,1fr));gap:var(--space-sm)}
.b-item{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-sm);text-align:center;cursor:grab;transition:var(--transition-fast);position:relative;box-shadow:var(--shadow-sm)}
.b-item:active{cursor:grabbing}
.b-item:hover{border-color:var(--gold);background:var(--bg3);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.b-icon{font-size:28px;margin-bottom:4px;line-height:1.2;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.b-name{font-size:11px;color:var(--text2);margin-bottom:3px;line-height:1.3;font-weight:500}
.b-qty{font-size:13px;font-weight:600;color:var(--text);font-family:'Share Tech Mono',monospace}
.b-val{font-size:10px;color:var(--gold2);margin-top:2px;font-weight:500}
.b-sell-menu{position:absolute;top:4px;right:4px;display:none;flex-direction:column;gap:2px;z-index:10}
.b-item:hover .b-sell-menu{display:flex}
.b-sell-btn{background:var(--bg4);border:1px solid var(--border);color:var(--text3);border-radius:var(--radius-sm);padding:2px 6px;font-size:9px;cursor:pointer;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);white-space:nowrap;font-weight:500}
.b-sell-btn:hover{background:var(--gold);border-color:var(--gold2);color:var(--bg);transform:translateX(-2px);box-shadow:0 2px 4px rgba(212,170,58,0.3)}
.b-sell-all{background:rgba(192,48,48,.2);border-color:var(--red);color:var(--red2)}
.b-sell-all:hover{background:var(--red);border-color:var(--red2);color:#fff}
.bank-empty{color:var(--text2);text-align:center;padding:40px;font-style:italic;font-size:12px}
.bank-cats{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:var(--space-md)}
/* Bank controls */
.bank-controls{margin-bottom:var(--space-md);display:flex;flex-direction:column;gap:8px}
.bank-gold-row{display:flex;align-items:center;justify-content:space-between;gap:8px}
.bank-action-btns{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
.bank-sell-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-md);overflow:hidden}
.bank-sell-header{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;cursor:pointer;user-select:none;font-size:12px;color:var(--text2)}
.bank-sell-header:hover{background:var(--bg3)}
.bank-sell-header-label{display:flex;align-items:center;gap:6px;font-weight:600}
.bank-sell-header-hint{font-size:10px;color:var(--text4);font-style:italic}
.bank-sell-body{padding:10px 12px;border-top:1px solid var(--border);display:none}
.bank-sell-body.open{display:block}
.sell-group{margin-bottom:8px}
.sell-group:last-child{margin-bottom:0}
.sell-group-label{font-size:10px;color:var(--text4);text-transform:uppercase;letter-spacing:0.1em;margin-bottom:5px;font-weight:600}
.sell-group-btns{display:flex;gap:5px;flex-wrap:wrap}
.btn-sell-cat{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:4px 9px;border-radius:var(--radius-sm);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);font-weight:500}
.btn-sell-cat:hover{background:rgba(212,170,58,0.15);border-color:var(--gold);color:var(--gold2)}
.btn-sell-cat.danger{border-color:var(--red);color:var(--red2)}
.btn-sell-cat.danger:hover{background:rgba(192,48,48,0.2)}
/* Select mode */
.btn-select-mode{padding:5px 11px;font-size:11px}
.btn-select-mode.active{background:var(--blue);border-color:var(--blue2);color:#fff}
.b-item.select-mode{cursor:pointer}
.b-item.select-mode:hover{border-color:var(--blue2)}
.b-item.b-selected{border-color:var(--gold)!important;background:rgba(212,170,58,0.12)!important;box-shadow:0 0 8px rgba(212,170,58,0.2)}
.b-check{position:absolute;top:4px;left:4px;width:16px;height:16px;border:2px solid var(--border2);border-radius:3px;background:var(--bg3);display:none;align-items:center;justify-content:center;font-size:10px;z-index:5}
.select-mode .b-check{display:flex}
.b-selected .b-check{background:var(--gold);border-color:var(--gold2);color:var(--bg)}
/* Selected items bar — inline, shown below guide section */
.bank-selected-bar{background:linear-gradient(135deg,var(--bg3),var(--bg4));border:1px solid var(--gold);border-radius:var(--radius-md);padding:10px 16px;display:none;align-items:center;justify-content:space-between;gap:12px;margin-bottom:var(--space-md);box-shadow:0 2px 12px rgba(212,170,58,0.15)}
.bank-selected-bar.visible{display:flex}
.bsb-info{display:flex;flex-direction:column;gap:2px}
.bsb-count{font-size:13px;font-weight:600;color:var(--text1)}
.bsb-value{font-size:11px;color:var(--gold2);font-family:'Share Tech Mono',monospace}
.bsb-actions{display:flex;gap:6px;align-items:center}
.bsb-clear{font-size:11px;padding:4px 10px;background:transparent;border:1px solid var(--border2);color:var(--text3);border-radius:var(--radius-sm);cursor:pointer}
.bsb-clear:hover{border-color:var(--text2);color:var(--text1)}
.bsb-sell{font-size:12px;padding:6px 14px;background:var(--green);border:1px solid var(--green2);color:#fff;border-radius:var(--radius-sm);cursor:pointer;font-weight:600}
.bsb-sell:hover{background:var(--green2)}
.bcat-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:5px 10px;border-radius:var(--radius-sm);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);font-weight:500}
.bcat-btn:hover{background:var(--bg4);border-color:var(--border2)}
.bcat-btn.active{background:var(--bg4);border-color:var(--blue);color:var(--blue2);box-shadow:0 0 8px rgba(58,140,212,0.3)}

/* COMBAT */
.combat-layout{display:grid;grid-template-columns:1fr 220px;gap:14px}
.combat-arena{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow-md)}
.combatants{display:grid;grid-template-columns:1fr auto 1fr;gap:10px;align-items:center;margin-bottom:var(--space-md)}
.combatant{text-align:center}
.comb-name{font-weight:600;font-size:13px;margin-bottom:6px}
.comb-hp-label{font-size:10px;color:var(--text3);margin-bottom:3px;font-family:'Share Tech Mono',monospace;font-weight:500}
.hp-bar-wrap{height:10px;background:var(--bg4);border-radius:5px;overflow:hidden;margin-bottom:4px;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.hp-fill{height:100%;border-radius:5px;transition:width 0.3s ease-out}
.hp-fill-player{background:linear-gradient(90deg,var(--green),var(--green2));box-shadow:0 0 6px rgba(46,168,85,0.5)}
.hp-fill-monster{background:linear-gradient(90deg,var(--red),var(--red2));box-shadow:0 0 6px rgba(192,48,48,0.5)}
.vs-badge{background:var(--bg3);border:1px solid var(--border);border-radius:50%;width:36px;height:36px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:var(--text3);flex-shrink:0;box-shadow:var(--shadow-sm)}
.combat-log{max-height:130px;overflow-y:auto;font-size:11px;background:var(--bg3);border-radius:var(--radius-md);padding:var(--space-sm);margin-bottom:10px;line-height:1.6;box-shadow:inset 0 1px 2px rgba(0,0,0,0.2)}
.clog-p{color:var(--text3)}
.clog-hit{color:var(--red2)}
.clog-mhit{color:var(--blue2)}
.clog-kill{color:var(--gold2);font-weight:600}
.clog-loot{color:var(--green2)}
.clog-heal{color:#4ade80;font-weight:600}
.clog-eat{color:var(--purple2)}
.clog-die{color:var(--red);font-weight:600}
.combat-btns{display:flex;gap:var(--space-sm)}
.btn{background:var(--bg3);border:1px solid var(--border);color:var(--text);padding:8px 14px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:var(--transition-fast);letter-spacing:.3px;box-shadow:var(--shadow-sm)}
.btn:hover{background:var(--bg4);border-color:var(--border2);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.btn:active{transform:translateY(0)}
.btn-green{background:rgba(46,168,85,.15);border-color:var(--green);color:var(--green2)}
.btn-green:hover{background:rgba(46,168,85,.25);border-color:var(--green2);box-shadow:0 0 12px rgba(46,168,85,0.3)}
.btn-red{background:rgba(192,48,48,.15);border-color:var(--red);color:var(--red2)}
.btn-red:hover{background:rgba(192,48,48,.25);border-color:var(--red2);box-shadow:0 0 12px rgba(192,48,48,0.3)}
.btn-gold{background:rgba(212,170,58,.15);border-color:var(--gold);color:var(--gold2)}
.btn-gold:hover{background:rgba(212,170,58,.25);border-color:var(--gold2);box-shadow:0 0 12px rgba(212,170,58,0.3)}
.food-btn{background:var(--bg3);border:1px solid var(--green);color:var(--text);padding:8px 12px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;font-weight:500;transition:var(--transition-fast);letter-spacing:.3px;margin-right:var(--space-sm);box-shadow:var(--shadow-sm)}
.food-btn:hover{background:rgba(46,168,85,.15);border-color:var(--green2);transform:translateY(-1px);box-shadow:0 0 12px rgba(46,168,85,0.3)}
.food-btn:active{transform:translateY(0)}
/* Zone grid — full-width hero cards */
.zone-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--space-lg);margin-bottom:var(--space-xl)}
/* Keep zone-select selector as alias */
.zone-select{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--space-lg);margin-bottom:var(--space-xl)}
.zone-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-lg);cursor:pointer;transition:var(--transition-normal);box-shadow:var(--shadow-sm);position:relative;overflow:hidden}
.zone-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent);pointer-events:none}
.zone-card:hover:not(.z-locked){border-color:var(--red);transform:translateY(-3px);box-shadow:var(--shadow-md),0 0 20px rgba(192,48,48,0.15)}
.zone-card.z-selected{border-color:rgba(212,170,58,0.6);background:linear-gradient(135deg,rgba(212,170,58,0.06),var(--bg2));box-shadow:0 0 20px rgba(212,170,58,0.15)}
.zone-card.z-locked{opacity:0.55;cursor:not-allowed}
.zc-top{display:flex;align-items:flex-start;gap:var(--space-md);margin-bottom:var(--space-sm)}
.zc-emoji{flex-shrink:0}
.zc-info{flex:1;min-width:0}
.zc-name{font-family:'Cinzel',serif;font-weight:700;font-size:15px;color:var(--gold);text-shadow:0 1px 2px rgba(0,0,0,0.3);line-height:1.2;margin-bottom:4px}
.zc-tier-badge{font-size:9px;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);font-weight:600}
.zc-req-badge{font-size:11px;color:var(--text2);background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:4px 8px;flex-shrink:0;white-space:nowrap;font-family:'Share Tech Mono',monospace}
.zc-locked-badge{color:var(--red2);border-color:var(--red)}
.zc-desc{font-size:11px;color:var(--text2);line-height:1.5;margin-bottom:var(--space-sm)}
.zc-footer{display:flex;align-items:center;justify-content:space-between;margin-top:var(--space-sm)}
.zc-monsters-preview{font-size:18px;letter-spacing:2px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.zc-count{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;font-weight:500}
.zc-mastery-badge{font-size:10px;color:var(--mastery);margin-top:6px;font-weight:600}
.zc-enter-hint{position:absolute;bottom:10px;right:12px;font-size:10px;color:var(--text3);opacity:0;transition:opacity 0.2s}
.zone-card:hover:not(.z-locked) .zc-enter-hint{opacity:1;color:var(--red2)}

/* Zone monster modal list */
.zm-list{display:flex;flex-direction:column;gap:var(--space-sm)}
.zm-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-md);cursor:pointer;transition:var(--transition-fast);position:relative}
.zm-card:hover:not(.zm-locked){border-color:var(--red);background:rgba(192,48,48,0.06);transform:translateX(2px)}
.zm-card.zm-locked{opacity:0.45;cursor:not-allowed}
.zm-card.zm-current{border-color:rgba(212,170,58,0.6);background:rgba(212,170,58,0.05)}
.zm-head{display:flex;align-items:center;gap:var(--space-md);margin-bottom:var(--space-sm)}
.zm-icon{flex-shrink:0}
.zm-info{flex:1;min-width:0}
.zm-name{font-weight:700;font-size:13px;color:var(--text);display:flex;align-items:center;gap:6px}
.zm-active-badge{font-size:9px;background:rgba(212,170,58,0.2);color:var(--gold2);border:1px solid rgba(212,170,58,0.4);border-radius:var(--radius-sm);padding:1px 6px;font-family:'Exo 2',sans-serif;font-weight:700;letter-spacing:.5px;text-transform:uppercase}
.zm-level{font-size:11px;color:var(--text3);margin-top:2px}
.zm-level-locked{color:var(--red2)}
.zm-stats{display:flex;gap:var(--space-md);margin-bottom:var(--space-sm);flex-wrap:wrap}
.zm-stat{font-size:11px;color:var(--text2);font-family:'Share Tech Mono',monospace;font-weight:600}
.zm-stat-label{color:var(--text3);font-size:10px;font-family:'Exo 2',sans-serif}
.zm-drops{font-size:10px;color:var(--text3);margin-bottom:var(--space-sm);line-height:1.4}
.zm-mastery{margin-top:4px}
.zm-m-row{display:flex;justify-content:space-between;font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;margin-bottom:3px}
.zm-m-bar{height:4px;background:var(--bg4);border-radius:2px;overflow:hidden}
.zm-m-fill{height:100%;background:linear-gradient(90deg,var(--mastery),var(--gold2));border-radius:2px;transition:width .4s}

/* Arena wrap */
.combat-arena-wrap{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-lg);margin-bottom:var(--space-lg);box-shadow:var(--shadow-md);animation:fadeIn 0.3s ease-out}
#zone-grid-title{margin-top:0}
.zone-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-md);cursor:pointer;transition:var(--transition-normal);box-shadow:var(--shadow-sm)}
.zone-card:hover:not(.z-locked){border-color:var(--gold);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.zone-card.z-selected{border-color:var(--gold);background:linear-gradient(135deg,rgba(212,170,58,0.12) 0%,var(--bg2) 100%);box-shadow:0 0 16px rgba(212,170,58,0.2);animation:zonePulse 0.6s ease-out}
.zone-card.z-locked{opacity:0.5;cursor:not-allowed}
.zc-header{display:flex;align-items:center;gap:var(--space-sm);margin-bottom:6px}
.zc-name{font-weight:600;font-size:13px;color:var(--gold);font-family:'Cinzel',serif;flex:1;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.zc-level{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;background:var(--bg3);padding:3px 6px;border-radius:var(--radius-sm);font-weight:500}
.zc-desc{font-size:10px;color:var(--text3);line-height:1.4;margin-top:4px}
.zc-tier{font-size:9px;color:var(--gold2);text-transform:uppercase;letter-spacing:1px;margin-top:6px;font-weight:600}
.monster-select{display:flex;flex-direction:column;gap:var(--space-sm);max-height:calc(100vh - 520px);overflow-y:auto;padding-right:4px}
.monster-card{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:10px;cursor:pointer;transition:var(--transition-fast);box-shadow:var(--shadow-sm)}
.monster-card:hover:not(.m-locked){border-color:var(--red);background:var(--bg3);transform:translateY(-1px)}
.monster-card.m-selected{border-color:var(--red);background:rgba(192,48,48,.1);box-shadow:0 0 12px rgba(192,48,48,0.2)}
.monster-card.m-locked{opacity:.4;cursor:not-allowed}
.mc-head{display:flex;align-items:center;gap:var(--space-sm);margin-bottom:5px}
.mc-icon{font-size:22px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.mc-name{font-weight:600;font-size:12px}
.mc-level{font-size:10px;color:var(--text3);margin-left:auto;font-family:'Share Tech Mono',monospace;font-weight:500}
.mc-stats{font-size:10px;color:var(--text2);display:flex;gap:var(--space-sm);flex-wrap:wrap;line-height:1.4}
.mc-stat span{color:var(--red2);font-weight:500}
.mc-loot{font-size:9px;color:var(--text3);margin-top:3px;line-height:1.3}

/* ── COMBAT UI POLISH ─────────────────────────────── */
.zc-icon{flex-shrink:0}
.zc-header{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.zone-card{position:relative;overflow:hidden}
.zone-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent);pointer-events:none}
.zone-card.z-selected::before{background:linear-gradient(135deg,rgba(212,170,58,0.08),transparent)}
.combatant-mini-stats{display:flex;gap:8px;justify-content:center;margin-top:5px;font-size:10px;font-family:'Share Tech Mono',monospace;font-weight:600}
.combatant-mini-stats .icon-pill{vertical-align:middle}
.vs-badge{background:linear-gradient(135deg,rgba(192,48,48,0.2),var(--bg3));border:2px solid rgba(192,48,48,0.4);border-radius:50%;width:42px;height:42px;display:flex;align-items:center;justify-content:center;flex-shrink:0;box-shadow:0 0 12px rgba(192,48,48,0.2),var(--shadow-sm)}
.combat-mastery-tip{font-size:11px;color:var(--text2);margin:4px 0 8px 0;padding:8px 10px;background:var(--bg3);border-radius:var(--radius-md);border:1px solid var(--border);border-left:3px solid var(--mastery);line-height:1.5}
.mc-head .icon-pill{flex-shrink:0}
.food-btn .icon-pill{vertical-align:middle}

/* ── MASTERY SHOP POLISH ──────────────────────────── */
.ms-tab-icon .icon-pill{vertical-align:middle}
.ms-tab.active .icon-pill{box-shadow:0 0 8px rgba(196,130,10,0.4)}
.up-icon .icon-pill{display:flex;margin:0 auto}
.mastery-total{position:relative;overflow:hidden}
.mastery-total::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(196,130,10,0.06),transparent);pointer-events:none;border-radius:inherit}

/* EQUIPMENT */



.equip-slot{background:var(--bg2);border:2px dashed var(--border);border-radius:var(--radius-lg);padding:var(--space-md);min-width:100px;min-height:80px;display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center;cursor:pointer;transition:var(--transition-normal);position:relative;box-shadow:var(--shadow-sm)}
.equip-slot:hover{border-color:var(--gold);transform:translateY(-2px);box-shadow:var(--shadow-md)}
.equip-slot.filled{border-style:solid;border-color:var(--blue);background:linear-gradient(135deg,rgba(59,130,246,0.08) 0%,var(--bg2) 100%);box-shadow:0 0 12px rgba(59,130,246,0.15)}
.equip-slot.filled:hover{border-color:var(--gold)}
.es-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;font-weight:600}
.es-icon{font-size:30px;line-height:1;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.es-name{font-size:11px;color:var(--text);margin-top:4px;font-weight:600}
.es-stat{font-size:10px;color:var(--green2);margin-top:2px;font-weight:600}
.es-empty{font-size:10px;color:var(--text3);font-style:italic}
.es-unequip{position:absolute;top:5px;right:5px;background:var(--bg4);border:1px solid var(--border);border-radius:var(--radius-sm);padding:2px 6px;font-size:9px;cursor:pointer;display:none;color:var(--red2);font-family:'Exo 2',sans-serif;font-weight:600;transition:var(--transition-fast)}
.es-unequip:hover{background:var(--red2);color:white;border-color:var(--red2);transform:scale(1.05)}
.equip-slot.filled:hover .es-unequip{display:block}
.stats-display{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-lg);box-shadow:var(--shadow-md)}
.stats-display h3{font-family:'Cinzel',serif;font-size:15px;color:var(--gold);margin-bottom:var(--space-md);padding-bottom:var(--space-sm);border-bottom:2px solid var(--border);text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.stat-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--bg3);transition:var(--transition-fast)}
.stat-row:hover{background:rgba(255,255,255,0.02)}
.stat-row:last-child{border:none}
.sr-label{color:var(--text2);display:flex;align-items:center;gap:6px;font-size:12px}
.sr-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--text);font-size:13px}
.sr-bonus{font-size:10px;color:var(--green2);margin-left:4px;font-weight:600}






.inf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:10px;border-bottom:1px solid var(--border)}
.inf-slot-name{font-weight:600;font-size:14px;color:var(--text);font-family:'Cinzel',serif}
.inf-level{font-size:20px;color:var(--gold2);font-weight:700;font-family:'Share Tech Mono',monospace}
.inf-progress{display:flex;gap:3px;margin-bottom:12px;flex-wrap:wrap;justify-content:center}
.inf-rank{width:26px;height:26px;border-radius:6px;background:var(--bg4);border:2px solid var(--border);font-size:10px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-weight:600;transition:all .2s}
.inf-rank.filled{background:linear-gradient(135deg,var(--gold2) 0%,var(--gold) 100%);color:var(--bg1);border-color:var(--gold2);box-shadow:0 2px 4px rgba(255,215,0,0.3)}
.inf-cost{font-size:11px;color:var(--text2);margin-bottom:8px;padding:8px;background:var(--bg3);border-radius:6px;text-align:center}
.inf-bonus{font-size:12px;color:var(--green2);margin-bottom:12px;text-align:center;font-weight:600;padding:6px;background:rgba(46,168,85,0.1);border-radius:6px}
.inf-button{width:100%;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);color:var(--bg1);border:none;padding:10px;border-radius:8px;font-size:12px;font-weight:600;cursor:pointer;font-family:'Exo 2',sans-serif;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 6px rgba(255,215,0,0.3);transition:all .2s}
.inf-button:hover{transform:translateY(-1px);box-shadow:0 4px 8px rgba(255,215,0,0.4)}
.inf-button:active{transform:translateY(0)}
.inf-button:disabled{background:var(--bg4);color:var(--text3);cursor:not-allowed;opacity:0.5;box-shadow:none;transform:none}
.inf-max{font-size:13px;color:var(--gold2);text-align:center;padding:12px;font-weight:600;background:linear-gradient(135deg,rgba(255,215,0,0.1) 0%,transparent 100%);border-radius:8px;text-transform:uppercase;letter-spacing:1px}










.inf-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:var(--space-md);padding-bottom:10px;border-bottom:1px solid var(--border)}
.inf-slot-name{font-weight:600;font-size:14px;color:var(--text);font-family:'Cinzel',serif;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.inf-level{font-size:20px;color:var(--gold2);font-weight:700;font-family:'Share Tech Mono',monospace;text-shadow:0 0 8px rgba(240,204,90,0.5)}
.inf-progress{display:flex;gap:3px;margin-bottom:var(--space-md);flex-wrap:wrap;justify-content:center}
.inf-rank{width:26px;height:26px;border-radius:6px;background:var(--bg4);border:2px solid var(--border);font-size:10px;display:flex;align-items:center;justify-content:center;color:var(--text3);font-weight:600;transition:var(--transition-normal)}
.inf-rank.filled{background:linear-gradient(135deg,var(--gold2) 0%,var(--gold) 100%);color:var(--bg);border-color:var(--gold2);box-shadow:0 2px 6px rgba(255,215,0,0.4)}
.inf-cost{font-size:11px;color:var(--text2);margin-bottom:var(--space-sm);padding:var(--space-sm);background:var(--bg3);border-radius:var(--radius-md);text-align:center;font-weight:500}
.inf-bonus{font-size:12px;color:var(--green2);margin-bottom:var(--space-md);text-align:center;font-weight:600;padding:6px;background:rgba(46,168,85,0.12);border-radius:var(--radius-md)}
.inf-button{width:100%;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);color:var(--bg);border:none;padding:10px;border-radius:var(--radius-md);font-size:12px;font-weight:600;cursor:pointer;font-family:'Exo 2',sans-serif;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 6px rgba(255,215,0,0.4);transition:var(--transition-normal)}
.inf-button:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(255,215,0,0.5)}
.inf-button:active{transform:translateY(0)}
.inf-button:disabled{background:var(--bg4);color:var(--text3);cursor:not-allowed;opacity:0.5;box-shadow:none;transform:none}
.inf-max{font-size:13px;color:var(--gold2);text-align:center;padding:var(--space-md);font-weight:600;background:linear-gradient(135deg,rgba(255,215,0,0.12) 0%,transparent 100%);border-radius:var(--radius-md);text-transform:uppercase;letter-spacing:1px}










/* PRODUCTION SKILLS */
.production-info{
  background:linear-gradient(135deg,rgba(255,255,255,0.02) 0%,transparent 100%),var(--bg2);
  border:1px solid var(--border);border-left:3px solid var(--gold);
  border-radius:var(--radius-lg);padding:var(--space-md) 14px;
  margin-bottom:var(--space-md);font-size:12px;color:var(--text2);line-height:1.7;
  box-shadow:var(--shadow-sm);
}
.production-info strong{color:var(--text);font-weight:600;}
.production-info em{color:var(--gold2);font-style:normal;font-weight:600;}
/* Per-skill accent stripe on info banner */
#page-woodcutting .production-info{border-left-color:#4a8a35;}
#page-mining      .production-info{border-left-color:#8a7048;}
#page-fishing     .production-info{border-left-color:#2a6ab5;}
#page-smithing    .production-info{border-left-color:#7a5e30;}
#page-cooking     .production-info{border-left-color:#b56420;}
#page-pickpocketing .production-info{border-left-color:#6a40a0;}
#page-woodworking .production-info{border-left-color:#8a6030;}
#page-prospecting .production-info{border-left-color:#5a3a8a;}
#page-jewelcrafting .production-info{border-left-color:var(--gold);}
#page-combat      .production-info{border-left-color:var(--red);}
#page-bank        .production-info{border-left-color:var(--text3);}
#page-equipment   .production-info{border-left-color:var(--armor);}
.production-info em{color:var(--gold2);font-style:normal;font-weight:600;}
.ingredient{display:inline-flex;align-items:center;gap:4px;margin:2px 4px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-sm);padding:2px 7px;font-size:11px;font-weight:500;transition:var(--transition-fast)}
.ingredient.missing{border-color:var(--red);color:var(--red2)}
.ingredient.ok{border-color:var(--green);color:var(--green2)}

/* NOTIFICATIONS */
#notifs{position:fixed;top:58px;right:12px;z-index:200;display:flex;flex-direction:column;gap:6px;pointer-events:none;align-items:flex-end}
.notif{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:8px var(--space-md);font-size:12px;animation:notifIn .25s ease-out,notifOut .3s ease 2.5s forwards;max-width:220px;font-weight:500;pointer-events:auto;box-shadow:var(--shadow-lg)}
.notif-close{background:rgba(255,59,48,0.15);border:1px solid rgba(255,59,48,0.5);color:#ff3b30;padding:4px 8px;border-radius:var(--radius-sm);cursor:pointer;font-size:14px;font-weight:700;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);flex-shrink:0;min-width:28px;min-height:28px;display:flex;align-items:center;justify-content:center}
.notif-close:hover{background:rgba(255,59,48,0.3);border-color:#ff3b30;transform:scale(1.1)}
.notif-lvl{border-color:var(--gold);color:var(--gold2);box-shadow:0 0 12px rgba(212,170,58,0.3)}
.notif-item{border-color:var(--green);color:var(--green2);box-shadow:0 0 12px rgba(46,168,85,0.3)}
.notif-combat{border-color:var(--red);color:var(--red2);box-shadow:0 0 12px rgba(192,48,48,0.3)}
.notif-info{border-color:var(--blue);color:var(--blue2);box-shadow:0 0 12px rgba(58,140,212,0.3)}
@keyframes notifIn{from{transform:translateX(20px);opacity:0}to{transform:translateX(0);opacity:1}}
@keyframes notifOut{to{transform:translateX(15px);opacity:0}}
@keyframes zonePulse{0%{box-shadow:var(--shadow-sm)}50%{box-shadow:0 0 20px rgba(212,170,58,0.4)}100%{box-shadow:var(--shadow-sm)}}

/* OFFLINE BANNER */
.offline-banner{background:linear-gradient(135deg,rgba(46,168,85,.12),rgba(26,107,196,.12));border:2px solid var(--green);border-radius:var(--radius-lg);padding:14px 18px;margin-bottom:var(--space-lg);display:flex;align-items:flex-start;gap:14px;box-shadow:0 0 16px rgba(46,168,85,0.2)}
.ob-icon{font-size:28px;flex-shrink:0;margin-top:2px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.ob-text{flex:1;font-size:12px;line-height:1.7}
.ob-text strong{color:var(--green2);font-weight:600}
.ob-close{background:rgba(255,59,48,0.15);border:2px solid rgba(255,59,48,0.5);color:#ff3b30;padding:8px 14px;border-radius:var(--radius-md);cursor:pointer;font-size:18px;font-weight:700;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);flex-shrink:0;align-self:flex-start;min-width:40px;min-height:40px;display:flex;align-items:center;justify-content:center}
.ob-close:hover{background:rgba(255,59,48,0.3);border-color:#ff3b30;transform:scale(1.05);box-shadow:0 4px 12px rgba(255,59,48,0.4)}

/* SECTION TITLES */
.sec-title{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin:14px 0 var(--space-sm);padding-bottom:5px;border-bottom:1px solid var(--border);scroll-margin-top:20px;font-weight:600;text-shadow:0 1px 2px rgba(0,0,0,0.3)}

/* GENERAL STORE */
.store-categories{display:flex;gap:var(--space-sm);flex-wrap:wrap;margin-bottom:var(--space-lg)}
.store-cat-btn{background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:6px 14px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);font-weight:500}
.store-cat-btn:hover{background:var(--bg4);border-color:var(--gold);transform:translateY(-1px)}
.store-cat-btn.active{background:linear-gradient(135deg,rgba(212,170,58,.18),var(--bg3));border-color:var(--gold);color:var(--gold2);box-shadow:0 0 12px rgba(212,170,58,0.3)}
.store-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:var(--space-md)}
.store-item{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);padding:14px;transition:var(--transition-normal);box-shadow:var(--shadow-sm)}
.store-item:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);border-color:var(--gold)}
.si-header{display:flex;align-items:center;gap:10px;margin-bottom:10px}
.si-icon{font-size:34px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.si-info{flex:1}
.si-name{font-weight:600;font-size:13px;color:var(--text);margin-bottom:2px}
.si-desc{font-size:10px;color:var(--text3);line-height:1.4}
.si-price{font-size:14px;color:var(--gold2);font-weight:600;margin-bottom:var(--space-sm);font-family:'Share Tech Mono',monospace;text-shadow:0 0 6px rgba(240,204,90,0.3)}
.si-stock{font-size:10px;color:var(--text3);margin-bottom:10px;font-weight:500}
.si-buy-area{display:flex;gap:4px}
.si-buy-btn{flex:1;background:var(--bg3);border:1px solid var(--gold);color:var(--gold2);padding:8px 6px;border-radius:var(--radius-md);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;font-weight:600;transition:var(--transition-fast);letter-spacing:.3px;box-shadow:var(--shadow-sm)}
.si-buy-btn:hover:not(:disabled){background:linear-gradient(135deg,rgba(212,170,58,.22),var(--bg3));transform:translateY(-1px);box-shadow:0 0 12px rgba(212,170,58,0.3)}
.si-buy-btn:active:not(:disabled){transform:translateY(0)}
.si-buy-btn:disabled{opacity:.4;cursor:not-allowed;border-color:var(--border);color:var(--text3)}
.si-buy-max{background:linear-gradient(135deg,rgba(46,168,85,0.15),var(--bg3));border-color:var(--green);color:var(--green2);}
.si-buy-max:hover:not(:disabled){background:linear-gradient(135deg,rgba(46,168,85,0.28),var(--bg3));box-shadow:0 0 12px rgba(46,168,85,0.3);}
.si-buy-x{background:linear-gradient(135deg,rgba(26,107,196,0.15),var(--bg3));border-color:var(--blue2);color:var(--blue2);}
.si-buy-x:hover{background:linear-gradient(135deg,rgba(26,107,196,0.28),var(--bg3));box-shadow:0 0 12px rgba(26,107,196,0.3);transform:translateY(-1px);}

/* TOOLTIPS */
.tooltip-wrap{position:relative;display:inline-block}
.tooltip-box{visibility:hidden;position:absolute;bottom:105%;left:50%;transform:translateX(-50%);background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:6px 10px;white-space:nowrap;font-size:11px;z-index:50;pointer-events:none;box-shadow:var(--shadow-md)}
.tooltip-wrap:hover .tooltip-box{visibility:visible;animation:fadeIn 0.15s ease-out}

/* CONTRACTS */
.contract-refresh{text-align:center;padding:10px;background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);margin-bottom:var(--space-lg);font-size:11px;color:var(--text2);box-shadow:var(--shadow-md);font-weight:500}
.contract-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:14px}
.contract-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-lg);transition:var(--transition-normal);position:relative;box-shadow:var(--shadow-md);overflow:hidden}
.contract-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-color:var(--gold)}
.contract-card.completed{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.1) 0%,var(--bg2) 100%);box-shadow:0 0 16px rgba(46,168,85,0.3)}
.contract-card.completed::after{content:'✓';position:absolute;top:12px;right:12px;font-size:26px;color:var(--green);font-weight:bold;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.contract-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.04) 0%,transparent 100%);pointer-events:none}
.ct-header{display:flex;align-items:center;gap:var(--space-md);margin-bottom:14px;padding-bottom:var(--space-md);border-bottom:1px solid var(--border)}
.ct-icon{font-size:34px;line-height:1;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.ct-info{flex:1}
.ct-title{font-weight:600;font-size:15px;color:var(--gold);margin-bottom:3px;font-family:'Cinzel',serif;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.ct-tier{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;font-weight:600}
.ct-requirements{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:10px;margin-bottom:var(--space-md)}
.ct-req-title{font-size:10px;color:var(--gold2);text-transform:uppercase;letter-spacing:1px;margin-bottom:var(--space-sm);font-weight:600}
.ct-req-item{display:flex;align-items:center;gap:var(--space-sm);padding:5px 0;font-size:12px}
.ct-req-icon{font-size:20px;flex-shrink:0;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.ct-req-name{flex:1;color:var(--text);font-weight:500}
.ct-req-progress{font-family:'Share Tech Mono',monospace;font-size:11px;font-weight:600}
.ct-req-progress.complete{color:var(--green2)}
.ct-req-progress.incomplete{color:var(--red2)}
.ct-rewards{display:flex;align-items:center;gap:14px;padding:10px;background:linear-gradient(135deg,var(--bg3) 0%,var(--bg2) 100%);border:1px solid var(--border);border-radius:var(--radius-md);margin-bottom:var(--space-md)}
.ct-reward{display:flex;align-items:center;gap:6px;font-size:12px}
.ct-reward-icon{font-size:20px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.ct-reward-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--gold2)}
.ct-actions{display:flex;gap:var(--space-sm)}
.ct-btn{flex:1;background:var(--bg3);border:1px solid var(--border);color:var(--text2);padding:8px 14px;border-radius:var(--radius-md);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:var(--transition-fast);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm)}
.ct-btn:hover{background:var(--bg4);border-color:var(--gold);color:var(--text);transform:translateY(-1px)}
.ct-btn:active{transform:translateY(0)}
.ct-btn-complete{background:var(--green);border-color:var(--green);color:white}
.ct-btn-complete:hover{background:#2ba855;border-color:#2ba855;box-shadow:0 0 12px rgba(46,168,85,0.4)}
.ct-btn:disabled{background:var(--bg4);border-color:var(--border);color:var(--text3);cursor:not-allowed;opacity:0.5;transform:none}
.ct-btn-complete:disabled{opacity:0.5;cursor:not-allowed;background:var(--bg3);color:var(--text3)}
.ct-btn-complete:disabled:hover{background:var(--bg3);color:var(--text3);border-color:var(--border);transform:none}

/* MASTERY SHOP */
.mastery-total{text-align:center;background:var(--bg2);border:2px solid var(--gold);border-radius:var(--radius-xl);padding:var(--space-lg);margin-bottom:20px;box-shadow:0 0 16px rgba(196,130,10,0.25)}
.mt-label{font-size:11px;color:var(--text3);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px;font-weight:600}
.mt-value{font-size:36px;font-weight:700;font-family:'Cinzel',serif;color:var(--mastery);text-shadow:0 0 20px rgba(196,130,10,0.6),0 2px 4px rgba(0,0,0,0.3)}
.mt-sub{font-size:11px;color:var(--text3);margin-top:6px}
.mastery-tabs{display:flex;gap:var(--space-sm);margin-bottom:var(--space-lg);flex-wrap:wrap;justify-content:center}
.ms-tab{background:var(--bg3);border:2px solid var(--border);color:var(--text2);padding:8px 16px;border-radius:var(--radius-md);cursor:pointer;font-size:12px;font-family:'Exo 2',sans-serif;transition:var(--transition-normal);display:flex;align-items:center;gap:var(--space-sm);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;box-shadow:var(--shadow-sm)}
.ms-tab:hover{background:var(--bg4);border-color:var(--mastery);transform:translateY(-1px);box-shadow:var(--shadow-md)}
.ms-tab.active{background:linear-gradient(135deg,rgba(196,130,10,0.18) 0%,var(--bg4) 100%);border-color:var(--mastery);color:var(--gold2);box-shadow:0 0 12px rgba(196,130,10,0.3)}
.ms-tab-icon{font-size:18px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.upgrade-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:14px}
.upgrade-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-lg);transition:var(--transition-normal);position:relative;box-shadow:var(--shadow-md);overflow:hidden}
.upgrade-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg);border-color:var(--mastery)}
.upgrade-card.purchased{border-color:var(--green);background:linear-gradient(135deg,rgba(46,168,85,0.1) 0%,var(--bg2) 100%);box-shadow:0 0 12px rgba(46,168,85,0.3)}
.upgrade-card.purchased::after{content:'✓';position:absolute;top:12px;right:12px;font-size:26px;color:var(--green);font-weight:bold;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.upgrade-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.04) 0%,transparent 100%);pointer-events:none}
.up-header{display:flex;align-items:flex-start;gap:var(--space-md);margin-bottom:var(--space-md);padding-bottom:10px;border-bottom:1px solid var(--border)}
.up-icon{font-size:34px;line-height:1;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.up-info{flex:1}
.up-name{font-weight:600;font-size:15px;color:var(--gold);margin-bottom:4px;font-family:'Cinzel',serif;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.up-desc{font-size:11px;color:var(--text2);line-height:1.6;margin-bottom:var(--space-sm)}
.up-effect{font-size:12px;color:var(--green2);font-weight:600;background:linear-gradient(135deg,rgba(46,168,85,0.18) 0%,rgba(46,168,85,0.05) 100%);border-radius:var(--radius-md);padding:6px 10px;display:inline-block;margin-bottom:10px;border:1px solid rgba(46,168,85,0.4)}
.up-footer{display:flex;align-items:center;justify-content:space-between;gap:var(--space-md);margin-top:var(--space-sm)}
.up-cost{display:flex;align-items:center;gap:6px;font-size:13px;font-weight:600;background:var(--bg3);padding:6px 10px;border-radius:var(--radius-md);border:1px solid var(--border)}
.up-cost-icon{font-size:20px;color:var(--mastery);filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.up-cost-val{font-family:'Share Tech Mono',monospace;color:var(--mastery)}
.up-level{display:flex;align-items:center;gap:4px;font-size:11px;color:var(--text3);font-weight:600}
.up-level.met{color:var(--green2)}
.up-btn{background:linear-gradient(135deg,var(--mastery) 0%,var(--gold) 100%);border:none;color:var(--bg);padding:8px 18px;border-radius:var(--radius-md);cursor:pointer;font-size:11px;font-family:'Exo 2',sans-serif;transition:var(--transition-normal);font-weight:600;text-transform:uppercase;letter-spacing:0.5px;box-shadow:0 2px 6px rgba(196,130,10,0.4)}
.up-btn:hover{transform:translateY(-1px);box-shadow:0 4px 10px rgba(196,130,10,0.5)}
.up-btn:active{transform:translateY(0)}
.up-btn:disabled{background:var(--bg4);color:var(--text3);cursor:not-allowed;opacity:0.5;box-shadow:none;transform:none}
.up-purchased{background:var(--green);color:var(--bg);border:1px solid var(--green2);padding:6px 16px;border-radius:var(--radius-md);font-size:11px;font-weight:600;cursor:default}
.up-owned{font-size:10px;color:var(--green2);margin-top:4px;font-family:'Share Tech Mono',monospace}

/* SCROLLBAR */
::-webkit-scrollbar{width:6px;height:6px}
::-webkit-scrollbar-track{background:var(--bg)}
::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:3px;transition:var(--transition-fast)}
::-webkit-scrollbar-thumb:hover{background:var(--border2)}

/* STATS PAGE */
.stats-page-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--space-lg)}
.stats-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:14px;box-shadow:var(--shadow-sm)}
.stats-section h3{font-family:'Cinzel',serif;font-size:13px;color:var(--gold);margin-bottom:var(--space-md);padding-bottom:var(--space-sm);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:7px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.skill-overview-grid{display:grid;grid-template-columns:1fr 1fr;gap:6px}
.sog-item{display:flex;align-items:center;gap:var(--space-sm);background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:7px 10px;cursor:pointer;transition:var(--transition-fast)}
.sog-item:hover{border-color:var(--gold);background:var(--bg4);transform:translateY(-1px)}
.sog-icon{font-size:20px;width:22px;text-align:center;flex-shrink:0;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.sog-info{flex:1;min-width:0}
.sog-name{font-size:11px;font-weight:500;color:var(--text2)}
.sog-level{font-size:16px;font-weight:700;font-family:'Share Tech Mono',monospace;color:var(--text);line-height:1}
.sog-xp-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:3px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.sog-xp-fill{height:100%;border-radius:2px;background:linear-gradient(90deg,var(--xp),var(--blue2));transition:width 0.4s ease-out;box-shadow:0 0 4px rgba(26,107,196,0.5)}
.combat-stat-card{background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);padding:var(--space-md);text-align:center;position:relative;overflow:hidden}
.combat-stat-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03),transparent);pointer-events:none}
.csc-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:var(--space-sm);margin-bottom:10px}
.csc-icon{font-size:26px;margin-bottom:4px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.csc-label{font-size:9px;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:2px;font-weight:600}
.csc-value{font-size:18px;font-weight:700;font-family:'Share Tech Mono',monospace;line-height:1}
.csc-sublabel{font-size:9px;color:var(--text3);margin-top:2px}
.csc-level{font-size:10px;color:var(--text3);margin-top:4px;font-weight:500}
.csc-bar{height:3px;background:var(--bg4);border-radius:2px;margin-top:4px;overflow:hidden;box-shadow:inset 0 1px 2px rgba(0,0,0,0.3)}
.csc-bar-fill{height:100%;border-radius:2px;transition:width 0.4s ease-out}
.total-level-display{text-align:center;padding:var(--space-md);background:var(--bg3);border:1px solid var(--gold);border-radius:var(--radius-md);margin-bottom:var(--space-md);box-shadow:0 0 12px rgba(212,170,58,0.2)}
.tld-label{font-size:10px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;font-weight:600}
.tld-value{font-size:36px;font-weight:700;font-family:'Cinzel',serif;color:var(--gold);text-shadow:0 0 20px rgba(212,170,58,0.5),0 2px 4px rgba(0,0,0,0.3);line-height:1.2}
.tld-sub{font-size:11px;color:var(--text3);margin-top:2px}
.combat-nav-badge{font-size:9px;background:var(--bg4);border:1px solid var(--border);border-radius:3px;padding:2px 5px;color:var(--text3);font-family:'Share Tech Mono',monospace;margin-left:auto;font-weight:600}

.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);backdrop-filter:blur(4px);z-index:300;align-items:center;justify-content:center;animation:fadeIn 0.2s ease-out}
.modal-overlay.open{display:flex}
.modal{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:20px;min-width:300px;max-width:420px;max-height:80vh;display:flex;flex-direction:column;gap:var(--space-md);box-shadow:var(--shadow-xl);animation:modalSlideIn 0.3s ease-out}
.modal-overlay.modal-wide .modal{max-width:680px;width:90vw}
@keyframes modalSlideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.modal h3{font-family:'Cinzel',serif;color:var(--gold);font-size:16px;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.modal-body{overflow-y:auto;flex:1}
.modal-footer{display:flex;gap:var(--space-sm);justify-content:flex-end}
.equip-list-item{display:flex;align-items:center;gap:10px;padding:var(--space-sm);background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md);cursor:pointer;transition:var(--transition-fast);margin-bottom:6px;box-shadow:var(--shadow-sm)}
.equip-list-item:hover{border-color:var(--gold);background:var(--bg4);transform:translateX(2px)}
.eli-icon{font-size:22px;filter:drop-shadow(0 1px 2px rgba(0,0,0,0.3))}
.eli-info{flex:1}
.eli-name{font-size:12px;font-weight:600}
.eli-stat{font-size:10px;color:var(--green2);font-weight:500}
.eli-qty{font-size:10px;color:var(--text3);font-family:'Share Tech Mono',monospace;font-weight:600}
.eli-locked{opacity:0.5;cursor:not-allowed}
.eli-locked:hover{border-color:var(--border);background:var(--bg3);transform:none}
.sell-all-row{display:flex;gap:6px;flex-wrap:wrap;margin-bottom:var(--space-sm)}

/* HOME PAGE */
.home-container{max-width:1000px;margin:0 auto;padding:var(--space-2xl)}
.home-logo-section{text-align:center;margin-bottom:var(--space-2xl)}
.home-logo{max-width:600px;width:100%;height:auto;filter:drop-shadow(0 4px 12px rgba(212,170,58,0.3));animation:logoFloat 3s ease-in-out infinite;margin-bottom:var(--space-lg);mix-blend-mode:screen}
@keyframes logoFloat{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.home-tagline{font-family:'Cinzel',serif;font-size:18px;color:var(--gold2);letter-spacing:2px;text-shadow:0 2px 4px rgba(0,0,0,0.5);margin-top:var(--space-md)}
.home-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-xl);padding:var(--space-2xl);margin-bottom:var(--space-xl);box-shadow:var(--shadow-lg);position:relative;overflow:hidden}
.home-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,170,58,0.03) 0%,transparent 50%);pointer-events:none}
.home-card-title{font-family:'Cinzel',serif;font-size:20px;color:var(--gold);margin-bottom:var(--space-lg);text-shadow:0 2px 4px rgba(0,0,0,0.3);display:flex;align-items:center;gap:var(--space-md)}
.home-text{font-size:14px;line-height:1.8;color:var(--text);margin-bottom:0}
.home-text strong{color:var(--gold2);font-weight:600}
.guide-section{display:flex;flex-direction:column;gap:var(--space-xl)}
.guide-step{display:flex;gap:var(--space-lg);align-items:flex-start}
.guide-icon{font-size:32px;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.guide-content h3{font-size:16px;color:var(--gold2);margin-bottom:var(--space-sm);font-weight:600}
.guide-content p{font-size:13px;line-height:1.7;color:var(--text2);margin:0}
.guide-content strong{color:var(--text);font-weight:600}
.guide-content em{color:var(--red2);font-style:normal;font-weight:600}
.tips-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:var(--space-lg)}
.tip-card{background:linear-gradient(135deg,rgba(255,255,255,0.02),transparent),var(--bg3);border:1px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-lg);transition:var(--transition-normal);text-align:center}
.tip-card:hover{border-color:var(--gold);transform:translateY(-4px);box-shadow:var(--shadow-md)}
.tip-icon{font-size:36px;margin-bottom:var(--space-md);filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.tip-title{font-size:14px;color:var(--gold2);font-weight:600;margin-bottom:var(--space-sm)}
.tip-card p{font-size:12px;line-height:1.6;color:var(--text3);margin:0}
.home-cta{background:linear-gradient(135deg,rgba(212,170,58,0.1) 0%,rgba(58,140,212,0.1) 100%);border:2px solid var(--gold);border-radius:var(--radius-xl);padding:var(--space-2xl);text-align:center;box-shadow:0 0 20px rgba(212,170,58,0.2)}
.home-cta h2{font-family:'Cinzel',serif;font-size:22px;color:var(--gold2);margin-bottom:var(--space-xl);text-shadow:0 2px 4px rgba(0,0,0,0.3)}
.cta-buttons{display:flex;gap:var(--space-lg);justify-content:center;flex-wrap:wrap}
.cta-btn{padding:14px 28px;border-radius:var(--radius-lg);font-size:14px;font-weight:600;font-family:'Exo 2',sans-serif;cursor:pointer;transition:var(--transition-normal);border:2px solid;letter-spacing:0.5px;box-shadow:var(--shadow-md)}
.cta-btn-primary{background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);border-color:var(--gold2);color:var(--bg)}
.cta-btn-primary:hover{transform:translateY(-2px);box-shadow:0 6px 16px rgba(212,170,58,0.4)}
.cta-btn-primary:active{transform:translateY(0)}
.cta-btn-secondary{background:var(--bg3);border-color:var(--border2);color:var(--text)}
.cta-btn-secondary:hover{background:var(--bg4);border-color:var(--gold);color:var(--gold2);transform:translateY(-2px)}
.cta-btn-secondary:active{transform:translateY(0)}

/* STATISTICS PAGE */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(320px,1fr));gap:var(--space-xl);padding:var(--space-xl)}
.stat-card{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--gold);border-radius:var(--radius-xl);padding:var(--space-xl);box-shadow:var(--shadow-lg)}
.stat-card-title{font-family:'Cinzel',serif;font-size:16px;color:var(--gold2);margin-bottom:var(--space-lg);padding-bottom:var(--space-md);border-bottom:2px solid var(--border);text-shadow:0 2px 4px rgba(0,0,0,0.3)}
.stat-row{display:flex;justify-content:space-between;padding:var(--space-sm) 0;border-bottom:1px solid var(--bg3);font-size:13px}
.stat-row:last-child{border-bottom:none}
.stat-row span:first-child{color:var(--text2)}
.stat-val{font-weight:600;font-family:'Share Tech Mono',monospace;color:var(--text)}
.stat-gold{color:var(--gold2)!important}
.stat-success{color:var(--green2)!important}
.stat-danger{color:var(--red2)!important}
.stat-highlight{color:var(--gold2)!important}
.stat-val{font-weight:600;color:var(--text);font-family:'Share Tech Mono',monospace}
.stat-highlight{color:var(--gold2)!important}
.stat-success{color:var(--green2)!important}
.stat-danger{color:var(--red2)!important}
.stat-gold{color:var(--gold)!important}

/* COLLECTION LOG PAGE */
.collection-header{text-align:center;padding:var(--space-2xl);background:linear-gradient(135deg,rgba(212,170,58,0.1) 0%,rgba(58,140,212,0.1) 100%);border:2px solid var(--gold);border-radius:var(--radius-xl);margin:var(--space-xl);box-shadow:0 0 20px rgba(212,170,58,0.2)}
.collection-overall{display:inline-block}
.collection-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(--space-lg);padding:var(--space-xl)}
.collection-card{background:var(--bg2);border:1px solid var(--border);border-left:3px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-lg);transition:var(--transition-normal);position:relative;overflow:hidden}
.collection-card:hover{transform:translateY(-4px);box-shadow:var(--shadow-md);border-color:var(--gold)}
.collection-complete{border-color:rgba(212,170,58,0.5)!important;border-left-color:var(--gold)!important;background:linear-gradient(135deg,rgba(212,170,58,0.05),var(--bg2))!important}
.collection-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,170,58,0.03) 0%,transparent 50%);pointer-events:none}
.collection-card-header{display:flex;align-items:center;gap:var(--space-md);margin-bottom:var(--space-md)}
.collection-icon{font-size:28px;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.collection-title{flex:1;font-size:14px;font-weight:600;color:var(--text)}
.collection-count{font-size:13px;font-weight:700;color:var(--gold2);font-family:'Share Tech Mono',monospace}
.collection-progress{height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;margin-bottom:var(--space-sm)}
.collection-progress-bar{height:100%;background:linear-gradient(90deg,var(--gold) 0%,var(--gold2) 100%);transition:width 0.5s ease;box-shadow:0 0 8px rgba(212,170,58,0.5)}
.collection-badge{text-align:center;font-size:11px;font-weight:700;color:var(--green2);padding:4px;background:rgba(76,175,80,0.1);border-radius:4px;margin-top:var(--space-sm)}
.collection-note{text-align:center;font-size:11px;color:var(--text3);font-style:italic;margin-top:var(--space-sm)}
.collection-complete{border-color:var(--green2);background:linear-gradient(135deg,rgba(76,175,80,0.05) 0%,transparent 50%)}
.collection-complete .collection-progress-bar{background:linear-gradient(90deg,var(--green) 0%,var(--green2) 100%)}

/* ACHIEVEMENTS PAGE */
.achievement-header{text-align:center;padding:var(--space-2xl);background:linear-gradient(135deg,rgba(212,170,58,0.1) 0%,rgba(58,140,212,0.1) 100%);border:2px solid var(--gold);border-radius:var(--radius-xl);margin:var(--space-xl);box-shadow:0 0 20px rgba(212,170,58,0.2)}
.achievement-overall{display:inline-block}
.achievement-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:var(--space-lg);padding:var(--space-xl)}
.achievement-card{background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);padding:var(--space-lg);display:flex;gap:var(--space-lg);align-items:center;transition:var(--transition-normal);position:relative;overflow:hidden}
.achievement-card::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(212,170,58,0.03) 0%,transparent 50%);pointer-events:none}
.achievement-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-md)}
.achievement-tier-easy.achievement-unlocked{border-color:rgba(46,168,85,0.5);background:linear-gradient(135deg,rgba(46,168,85,0.06),var(--bg2))}
.achievement-tier-medium.achievement-unlocked{border-color:rgba(212,170,58,0.5);background:linear-gradient(135deg,rgba(212,170,58,0.06),var(--bg2))}
.achievement-tier-hard.achievement-unlocked{border-color:rgba(192,48,48,0.5);background:linear-gradient(135deg,rgba(192,48,48,0.06),var(--bg2))}
.achievement-tier-easy.achievement-locked{opacity:.65}
.achievement-tier-medium.achievement-locked{opacity:.6}
.achievement-tier-hard.achievement-locked{opacity:.55}
.achievement-icon .icon-pill{display:flex;align-items:center;justify-content:center;}
.achievement-header,.collection-header{display:flex;justify-content:center;padding:var(--space-xl) var(--space-xl) var(--space-lg)}
.achievement-overall,.collection-overall{text-align:center;max-width:320px;width:100%}
.achievement-tier-section{margin-bottom:var(--space-xl)}
.achievement-tier-title{font-family:'Cinzel',serif;font-size:15px;padding:10px var(--space-xl);margin:0;border-bottom:1px solid var(--border);font-weight:700;letter-spacing:.5px}
.achievement-unlocked{border-color:var(--gold);background:linear-gradient(135deg,rgba(212,170,58,0.05) 0%,transparent 50%)}
.achievement-unlocked:hover{border-color:var(--gold2)}
.achievement-locked{opacity:0.5}
.achievement-icon{font-size:48px;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.3))}
.achievement-info{flex:1}
.achievement-name{font-size:16px;font-weight:700;color:var(--gold2);margin-bottom:4px}
.achievement-desc{font-size:12px;color:var(--text2);line-height:1.5}
.achievement-date{font-size:10px;color:var(--text3);margin-top:6px;font-style:italic}

/* ACHIEVEMENT TIERS */
.achievement-tier-section{margin:var(--space-xl);padding-top:var(--space-lg)}
.achievement-tier-title{font-family:'Cinzel',serif;font-size:18px;margin-bottom:var(--space-lg);padding-bottom:var(--space-md);border-bottom:2px solid var(--border);text-shadow:0 2px 4px rgba(0,0,0,0.3)}
.achievement-tier-easy{border-left:4px solid var(--green2)!important}
.achievement-tier-medium{border-left:4px solid var(--gold2)!important}
.achievement-tier-hard{border-left:4px solid var(--red2)!important}

/* BADGE SYSTEM */
.achievement-badge-display{margin-top:var(--space-sm);font-size:12px;color:var(--text2)}
.badge-name{color:var(--gold);font-weight:700;font-family:'Cinzel',serif;text-shadow:0 1px 2px rgba(0,0,0,0.3)}
.badge-equip-btn{margin-top:var(--space-sm);padding:6px 14px;background:linear-gradient(135deg,var(--gold) 0%,var(--gold2) 100%);border:2px solid var(--gold2);border-radius:var(--radius-md);color:var(--bg);font-size:11px;font-weight:700;cursor:pointer;transition:var(--transition-normal);font-family:'Exo 2',sans-serif}
.badge-equip-btn:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(212,170,58,0.4)}
.badge-equip-btn:active{transform:translateY(0)}
.badge-equip-btn.badge-equipped{background:var(--green);border-color:var(--green2);cursor:default;opacity:0.7}
.badge-equip-btn.badge-equipped:hover{transform:none;box-shadow:none}
.achievement-locked-text{font-size:11px;color:var(--text3);margin-top:var(--space-sm);font-style:italic}

/* EQUIPPED BADGE DISPLAY (Stats Page) */
.equipped-badge-display{background:linear-gradient(135deg,rgba(212,170,58,0.15) 0%,rgba(212,170,58,0.05) 100%);border:2px solid var(--gold);border-radius:var(--radius-xl);padding:var(--space-xl);text-align:center;margin:var(--space-lg) 0;box-shadow:0 0 20px rgba(212,170,58,0.2)}
.ebd-label{font-size:12px;color:var(--text3);text-transform:uppercase;letter-spacing:1px;margin-bottom:var(--space-sm)}
.ebd-badge{font-family:'Cinzel',serif;font-size:28px;color:var(--gold);font-weight:700;text-shadow:0 2px 6px rgba(0,0,0,0.4);margin:var(--space-md) 0}
.ebd-sub{font-size:11px;color:var(--text3);margin-top:var(--space-sm)}

/* COLLECTION MODAL */
.coll-modal{max-height:60vh;overflow-y:auto;padding:var(--space-lg)}
.coll-section h4{font-family:'Exo 2',sans-serif;font-size:14px;margin-bottom:var(--space-md);padding-bottom:var(--space-sm);border-bottom:1px solid var(--border)}
.coll-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:var(--space-sm)}
.coll-item{padding:var(--space-sm);background:var(--bg3);border-radius:var(--radius-md);font-size:12px;display:flex;align-items:center;gap:6px}
.coll-obtained{border-left:3px solid var(--green2);color:var(--text)}
.coll-missing{border-left:3px solid var(--text3);color:var(--text3);opacity:0.6}

/* COMBAT MASTERY DISPLAY */
.combat-mastery-display{padding:12px;background:var(--bg2);border:2px solid var(--border);border-radius:var(--radius-lg);margin-bottom:var(--space-md)}

/* ── EQUIPMENT PAGE REDESIGN ─────────────────────────────── */
.equip-top{display:grid;grid-template-columns:1fr 1fr 260px;gap:16px;margin-bottom:20px}
.equip-col-label{font-family:'Cinzel',serif;font-size:11px;color:var(--gold);text-transform:uppercase;letter-spacing:1px;margin-bottom:8px;padding-bottom:4px;border-bottom:1px solid var(--border)}
.equip-slots-combat{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.equip-slots-utility{display:flex;flex-direction:column;gap:8px}
.equip-infusion-section{background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-xl);padding:16px;box-shadow:var(--shadow-md)}
.infusion-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(210px,1fr));gap:12px}
.infusion-item{background:var(--bg3);border:2px solid var(--border);border-radius:var(--radius-xl);padding:14px;transition:var(--transition-normal);position:relative;box-shadow:var(--shadow-sm);overflow:hidden}
.infusion-item:hover{border-color:var(--gold);box-shadow:var(--shadow-md)}
.infusion-item::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,215,0,0.04) 0%,transparent 60%);pointer-events:none}
.infusion-guide-details{position:relative}
.infusion-guide-popup{position:absolute;right:0;top:calc(100% + 6px);z-index:50;background:var(--bg2);border:1px solid var(--border);border-radius:var(--radius-lg);padding:12px 14px;font-size:11px;color:var(--text2);line-height:2;white-space:nowrap;box-shadow:var(--shadow-lg)}
</style>
</head>
<body>

<div id="header">
  <h1>⚔ GRINDIA</h1>
  <div class="h-divider"></div>
  <div id="active-action-display" class="clickable" onclick="toggleTracker()">
    <span class="aad-dot"></span>
    <span class="aad-icon" id="aad-icon">⚒️</span>
    <span id="aad-text">Mining Copper</span>
  </div>
  <div id="tracker-panel"></div>
  <div class="h-stat">
    <span class="hs-icon">🪙</span>
    <span class="hs-label">Gold</span>
    <span class="hs-val" id="hdr-gold">0</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">❤️</span>
    <span class="hs-label">HP</span>
    <span class="hs-val" id="hdr-hp">10/10</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">⚔️</span>
    <span class="hs-label">Crit</span>
    <span class="hs-val" id="hdr-atk">5%</span>
  </div>
  <div class="h-stat">
    <span class="hs-icon">🛡️</span>
    <span class="hs-label">Armor</span>
    <span class="hs-val" id="hdr-def">0</span>
  </div>
  <div class="spacer"></div>
  <button class="hdr-btn" onclick="exportSave()" title="Download save file">💾 Export</button>
  <button class="hdr-btn" onclick="importSave()" title="Load save file">📂 Import</button>
  <button class="hdr-btn" onclick="manualSave()">💾 Save</button>
</div>

<div id="main">
  <div id="sidebar">
    <div class="nav-section">
      <div class="nav-item active" onclick="showPage('home')" id="nav-home" style="border-bottom: 1px solid var(--border); margin-bottom: 6px; padding-bottom: 10px;">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">🏠</span></span>
        <div class="ni-info">
          <div class="ni-name" style="font-size: 13px; font-weight: 600;">Home</div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Gathering</div>
      <div class="nav-item" onclick="showPage('woodcutting')" id="nav-woodcutting">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-logs">🪓</span></span>
        <div class="ni-info">
          <div class="ni-name">Woodcutting</div>
          <div class="ni-level"><span id="sl-woodcutting">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-woodcutting" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('mining')" id="nav-mining">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-ore">⛏️</span></span>
        <div class="ni-info">
          <div class="ni-name">Mining</div>
          <div class="ni-level"><span id="sl-mining">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-mining" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('fishing')" id="nav-fishing">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-fish">🎣</span></span>
        <div class="ni-info">
          <div class="ni-name">Fishing</div>
          <div class="ni-level"><span id="sl-fishing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-fishing" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('pickpocketing')" id="nav-pickpocketing">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">🥷</span></span>
        <div class="ni-info">
          <div class="ni-name">Pickpocketing</div>
          <div class="ni-level"><span id="sl-pickpocketing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-pickpocketing" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Production</div>
      <div class="nav-item" onclick="showPage('smithing')" id="nav-smithing">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-bar">🔨</span></span>
        <div class="ni-info">
          <div class="ni-name">Blacksmithing</div>
          <div class="ni-level"><span id="sl-smithing">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-smithing" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('cooking')" id="nav-cooking">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-food">🍳</span></span>
        <div class="ni-info">
          <div class="ni-name">Cooking</div>
          <div class="ni-level"><span id="sl-cooking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-cooking" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('woodworking')" id="nav-woodworking">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-tool">🪚</span></span>
        <div class="ni-info">
          <div class="ni-name">Woodworking</div>
          <div class="ni-level"><span id="sl-woodworking">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-woodworking" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('prospecting')" id="nav-prospecting">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-gem">🔍</span></span>
        <div class="ni-info">
          <div class="ni-name">Prospecting</div>
          <div class="ni-level"><span id="sl-prospecting">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-prospecting" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('jewelcrafting')" id="nav-jewelcrafting">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-jewelry">💍</span></span>
        <div class="ni-info">
          <div class="ni-name">Jewelcrafting</div>
          <div class="ni-level"><span id="sl-jewelcrafting">Lv 1</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-jewelcrafting" style="width:0%"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-section">
      <div class="nav-group-title">Combat Skills</div>
      <div class="nav-item" onclick="showPage('combat')" id="nav-combat">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-combat">⚔️</span></span>
        <div class="ni-info">
          <div class="ni-name">Combat</div>
          <div class="ni-level"><span id="sl-combat">Lv 3</span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" id="mb-combat" style="width:0%"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-attack">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-combat">🗡️</span></span>
        <div class="ni-info">
          <div class="ni-name">Attack</div>
          <div class="ni-level"><span id="sl-attack">Lv 1</span><span style="color:var(--crit);font-size:9px" id="sl-attack-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--crit)" id="mb-attack"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-strength">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-combat">💪</span></span>
        <div class="ni-info">
          <div class="ni-name">Strength</div>
          <div class="ni-level"><span id="sl-strength">Lv 1</span><span style="color:var(--power);font-size:9px" id="sl-strength-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--power)" id="mb-strength"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-haste">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-combat">⚡</span></span>
        <div class="ni-info">
          <div class="ni-name">Haste</div>
          <div class="ni-level"><span id="sl-haste">Lv 1</span><span style="color:var(--haste);font-size:9px" id="sl-haste-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--haste)" id="mb-haste"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-defense">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-armor">🛡️</span></span>
        <div class="ni-info">
          <div class="ni-name">Defense</div>
          <div class="ni-level"><span id="sl-defense">Lv 1</span><span style="color:var(--armor);font-size:9px" id="sl-defense-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--armor)" id="mb-defense"></div></div>
        </div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-hitpoints">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-combat">❤️</span></span>
        <div class="ni-info">
          <div class="ni-name">Hitpoints</div>
          <div class="ni-level"><span id="sl-hitpoints">Lv 10</span><span style="color:var(--hps);font-size:9px" id="sl-hitpoints-stat"></span></div>
          <div class="mini-bar mini-bar-xp"><div class="mini-bar-fill" style="background:var(--hps)" id="mb-hitpoints"></div></div>
        </div>
      </div>
    </div>
    <div class="nav-divider"></div>
    <div class="nav-section">
      <div class="nav-item" onclick="showPage('bank')" id="nav-bank">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">🏦</span></span>
        <div class="ni-info"><div class="ni-name">Bank</div><div class="ni-level">Storage</div></div>
      </div>
      <div class="nav-item" onclick="showPage('equipment')" id="nav-equipment">
        <span class="ni-icon">🛡️</span>
        <div class="ni-info"><div class="ni-name">Equipment</div><div class="ni-level">Loadout</div></div>
      </div>
      <div class="nav-item" onclick="showPage('stats')" id="nav-stats">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">📊</span></span>
        <div class="ni-info"><div class="ni-name">Stats</div><div class="ni-level">All Skills</div></div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-item" onclick="showPage('contracts')" id="nav-contracts">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">📋</span></span>
        <div class="ni-info"><div class="ni-name">Contracts</div><div class="ni-level">Quests</div></div>
      </div>
      <div class="nav-item" onclick="showPage('mastery-shop')" id="nav-mastery-shop">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">⭐</span></span>
        <div class="ni-info"><div class="ni-name">Mastery Shop</div><div class="ni-level">Upgrades</div></div>
      </div>
      <div class="nav-item" onclick="showPage('store')" id="nav-store">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">🏪</span></span>
        <div class="ni-info"><div class="ni-name">General Store</div><div class="ni-level">Buy Items</div></div>
      </div>
      <div class="nav-divider"></div>
      <div class="nav-item" onclick="showPage('statistics')" id="nav-statistics">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">📈</span></span>
        <div class="ni-info"><div class="ni-name">Statistics</div><div class="ni-level">Your Stats</div></div>
      </div>
      <div class="nav-item" onclick="showPage('collection')" id="nav-collection">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">📚</span></span>
        <div class="ni-info"><div class="ni-name">Collection Log</div><div class="ni-level">Discoveries</div></div>
      </div>
      <div class="nav-item" onclick="showPage('achievements')" id="nav-achievements">
        <span class="ni-icon"><span class="icon-pill icon-pill-xl ip-misc">🏆</span></span>
        <div class="ni-info"><div class="ni-name">Achievements</div><div class="ni-level">Milestones</div></div>
      </div>
    </div>
  </div>

  <div id="content">
    <!-- HOME -->
    <div class="page active" id="page-home">
      <div class="home-container">
        <!-- Logo Section -->
        <div class="home-logo-section">
          <img src="Grindia_logo.png" alt="Grindia" class="home-logo">
          <p class="home-tagline">An Epic Idle Adventure</p>
        </div>

        <!-- Welcome Message -->
        <div class="home-card">
          <h2 class="home-card-title">🎮 Welcome, Adventurer!</h2>
          <p class="home-text">
            Welcome to <strong>Grindia</strong>, an idle RPG where you master skills, craft powerful equipment, 
            and battle fearsome monsters. Progress through gathering, production, and combat as you build 
            your legacy in this epic adventure!
          </p>
        </div>

        <!-- Quick Start Guide -->
        <div class="home-card">
          <h2 class="home-card-title">🚀 Quick Start Guide</h2>
          
          <div class="guide-section">
            <div class="guide-step">
              <div class="guide-icon"><span class="icon-pill icon-pill-md ip-misc">1️⃣</span></div>
              <div class="guide-content">
                <h3>Gather Resources</h3>
                <p>Start with <strong>Mining</strong> or <strong>Fishing</strong> to gather raw materials. Mine ores to smelt into bars for gear, or catch fish to cook into food for combat healing. Every resource you gather feeds into another skill!</p>
              </div>
            </div>

            <div class="guide-step">
              <div class="guide-icon"><span class="icon-pill icon-pill-md ip-misc">2️⃣</span></div>
              <div class="guide-content">
                <h3>Craft Gear & Tools</h3>
                <p>Use <strong>Blacksmithing</strong> to smelt bars and forge weapons and armor. Use <strong>Woodworking</strong> to craft skilling tools that speed up your gathering. Always equip the highest tier tool you can make — they make a big difference!</p>
              </div>
            </div>

            <div class="guide-step">
              <div class="guide-icon"><span class="icon-pill icon-pill-md ip-misc">3️⃣</span></div>
              <div class="guide-content">
                <h3>Enter Combat</h3>
                <p>Fight monsters across 7 zones — from Forest to the Celestial Realm. <strong>Combat level</strong> is the average of 5 sub-skills: ATK, STR, DEF, HP, and HASTE. Keep cooked food stocked at all times — food is essential for survival!</p>
              </div>
            </div>

            <div class="guide-step">
              <div class="guide-icon"><span class="icon-pill icon-pill-md ip-misc">4️⃣</span></div>
              <div class="guide-content">
                <h3>Unlock the Full Skill Chain</h3>
                <p><strong>Prospecting</strong> extracts gems from ores. <strong>Jewelcrafting</strong> combines gems and bars into powerful amulets and rings. <strong>Pickpocketing</strong> earns gold fast. Each skill feeds others — the deeper you go, the stronger everything becomes!</p>
              </div>
            </div>

            <div class="guide-step">
              <div class="guide-icon"><span class="icon-pill icon-pill-md ip-misc">5️⃣</span></div>
              <div class="guide-content">
                <h3>Master & Infuse Everything</h3>
                <p>Every resource has its own <strong>Mastery</strong> track that speeds up actions. Spend mastery points in the <strong>Mastery Shop</strong> for permanent skill bonuses. Use <strong>Gear Infusion</strong> to push your equipment up to +10 ranks for powerful stat boosts. Hunt for rare <strong>Trinkets</strong> unique to each skill!</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Pro Tips -->
        <div class="home-card">
          <h2 class="home-card-title">💡 Pro Tips</h2>
          <div class="tips-grid">
            <div class="tip-card">
              <div class="tip-icon"><span class="icon-pill icon-pill-md ip-misc">🔗</span></div>
              <div class="tip-title">Skills Feed Each Other</div>
              <p>Fish → Cook for combat food. Mine → Smelt → Forge gear. Mine → Prospect gems → Jewelcraft rings and amulets. The whole game is one big chain!</p>
            </div>
            <div class="tip-card">
              <div class="tip-icon"><span class="icon-pill icon-pill-md ip-misc">🌙</span></div>
              <div class="tip-title">Idle While Away</div>
              <p>Gathering and production skills run fully offline. Set Combat to the highest monster you can survive and let it run — loot, XP, and mastery all accumulate while you're gone.</p>
            </div>
            <div class="tip-card">
              <div class="tip-icon"><span class="icon-pill icon-pill-md ip-trinket">✨</span></div>
              <div class="tip-title">Trinkets Are Rare & Powerful</div>
              <p>Each skill has a unique Trinket that drops while training it. They double resources, boost XP, and more. The <strong>Brawler's Trinket</strong> from Combat is the biggest combat power spike in the game.</p>
            </div>
            <div class="tip-card">
              <div class="tip-icon"><span class="icon-pill icon-pill-md ip-material">⚗️</span></div>
              <div class="tip-title">Infuse Your Gear</div>
              <p>Use bars to infuse equipment up to +10 ranks. Offensive stats gain +1% per rank; defensive stats +0.7%. Always infuse your weapon first for the biggest combat boost.</p>
            </div>
          </div>
        </div>

        <!-- Ready to Begin -->
        <div class="home-cta">
          <h2>Ready to Begin Your Adventure?</h2>
          <div class="cta-buttons">
            <button class="cta-btn cta-btn-primary" onclick="showPage('mining')">⛏️ Start Mining</button>
            <button class="cta-btn cta-btn-secondary" onclick="showPage('fishing')">🎣 Start Fishing</button>
            <button class="cta-btn cta-btn-secondary" onclick="showPage('combat')">⚔️ Enter Combat</button>
          </div>
        </div>
      </div>
    </div>
    <!-- WOODCUTTING -->
    <div class="page" id="page-woodcutting">
      <div id="cur-woodcutting"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-logs">🪓</span></div>
        <div class="pg-title">
          <h2>Woodcutting</h2>
          <div class="pg-xp-area" id="pgxp-woodcutting"></div>
        </div>
      </div>
      <div class="production-info">
        🪓 Chop <strong>logs</strong> from increasingly rare trees to earn XP. Logs are used in <strong>Woodworking</strong> to craft skilling tools. Equip a <strong>Woodcutting tool</strong> from the Equipment tab to chop faster. Mastery speeds up actions and unlocks rare rewards at the Mastery Shop!
      </div>
      <div class="action-grid" id="grid-woodcutting"></div>
    </div>
    <!-- MINING -->
    <div class="page" id="page-mining">
      <div id="cur-mining"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-ore">⛏️</span></div>
        <div class="pg-title">
          <h2>Mining</h2>
          <div class="pg-xp-area" id="pgxp-mining"></div>
        </div>
      </div>
      <div class="production-info">
        ⛏️ Mine <strong>ores</strong> across 9 types — from common Graveliron to legendary Nightnickel. Ores are smelted into <strong>bars</strong> at Blacksmithing, and can also be <strong>Prospected</strong> for rare gems. Equip a <strong>Mining tool</strong> to dig faster. Higher tier ores give more XP and unlock more powerful crafting recipes!
      </div>
      <div class="action-grid" id="grid-mining"></div>
    </div>
    <!-- FISHING -->
    <div class="page" id="page-fishing">
      <div id="cur-fishing"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-fish">🎣</span></div>
        <div class="pg-title">
          <h2>Fishing</h2>
          <div class="pg-xp-area" id="pgxp-fishing"></div>
        </div>
      </div>
      <div class="production-info">
        🎣 Catch <strong>raw fish</strong> from rivers, seas, and mystic waters. All fish can be cooked at <strong>Cooking</strong> — cooked food <strong>auto-heals you in combat</strong> when your HP drops below 40%. Equip a <strong>Fishing rod</strong> to cast faster. Higher tier fish heals more HP per bite, making it essential for tough fights!
      </div>
      <div class="action-grid" id="grid-fishing"></div>
    </div>
    <!-- SMITHING -->
    <div class="page" id="page-smithing">
      <div id="cur-smithing"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-bar">🔨</span></div>
        <div class="pg-title">
          <h2>Blacksmithing</h2>
          <div class="pg-xp-area" id="pgxp-smithing"></div>
        </div>
      </div>
      <div class="production-info">
        🔨 Smelt <strong>raw ores</strong> from Mining into <strong>metal bars</strong>, then forge powerful <strong>weapons and armor</strong>. Gear can be equipped in the <strong>Equipment tab</strong> to boost your combat stats. Bars are also used in <strong>Woodworking</strong> for skilling tools. Equip a <strong>Blacksmithing hammer</strong> to work faster!
      </div>
      <div class="action-grid" id="grid-smithing"></div>
      <div class="sec-title">⚒️ Craft Equipment</div>
      <div class="action-grid" id="grid-smithing-craft"></div>
    </div>
    <!-- COOKING -->
    <div class="page" id="page-cooking">
      <div id="cur-cooking"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-food">🍳</span></div>
        <div class="pg-title">
          <h2>Cooking</h2>
          <div class="pg-xp-area" id="pgxp-cooking"></div>
        </div>
      </div>
      <div class="production-info">
        🍳 Cook <strong>raw fish</strong> from Fishing into hearty meals. Cooked food is stored in your bank and <strong>automatically eaten during combat</strong> when your HP drops below 40%. Better food = more HP restored per bite. Equip a <strong>Cooking cauldron</strong> to cook faster. Always keep a stockpile — it could save your life!
      </div>
      <div class="action-grid" id="grid-cooking"></div>
    </div>
    <!-- PICKPOCKETING -->
    <div class="page" id="page-pickpocketing">
      <div id="cur-pickpocketing"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">🥷</span></div>
        <div class="pg-title">
          <h2>Pickpocketing</h2>
          <div class="pg-xp-area" id="pgxp-pickpocketing"></div>
        </div>
      </div>
      <div class="production-info">
        🥷 Steal <strong>gold</strong> directly from NPCs of increasing wealth. Every successful pickpocket fills your pockets — failed attempts still cost a tick but grant a small XP consolation. Equip a <strong>Pickpocketing tool</strong> to steal faster. Mastery upgrades in the Mastery Shop can dramatically boost your gold-per-hour!
      </div>
      <div class="action-grid" id="grid-pickpocketing"></div>
    </div>
    <!-- WOODWORKING -->
    <div class="page" id="page-woodworking">
      <div id="cur-woodworking"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-tool">🪚</span></div>
        <div class="pg-title">
          <h2>Woodworking</h2>
          <div class="pg-xp-area" id="pgxp-woodworking"></div>
        </div>
      </div>
      <div class="production-info">
        ⚒️ Combine <strong>metal bars</strong> from Blacksmithing with <strong>logs</strong> from Woodcutting to craft powerful <strong>Skilling Tools</strong>. Equip a tool to reduce action time for its matching skill by up to <strong>24%</strong>. Only one tool can be equipped at a time — swap freely in the Equipment tab!
      </div>
      <div class="action-grid" id="grid-woodworking"></div>
    </div>
    <!-- PROSPECTING -->
    <div class="page" id="page-prospecting">
      <div id="cur-prospecting"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-gem">🔍</span></div>
        <div class="pg-title">
          <h2>Prospecting</h2>
          <div class="pg-xp-area" id="pgxp-prospecting"></div>
        </div>
      </div>
      <div class="production-info">
        💎 Carefully inspect <strong>raw ores</strong> from Mining to extract precious <strong>gems</strong>. Base gem chance varies by ore <strong>(28–40%)</strong>, scaling up to <strong>97%</strong> with mastery and Mastery Shop upgrades. Gems are used in Jewelcrafting to create powerful <strong>amulets and rings</strong>. The ore is always consumed — rarer ores yield rarer gems!
      </div>
      <div class="action-grid" id="grid-prospecting"></div>
    </div>
    <!-- JEWELCRAFTING -->
    <div class="page" id="page-jewelcrafting">
      <div id="cur-jewelcrafting"></div>
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-jewelry">💍</span></div>
        <div class="pg-title">
          <h2>Jewelcrafting</h2>
          <div class="pg-xp-area" id="pgxp-jewelcrafting"></div>
        </div>
      </div>
      <div class="production-info">
        ✨ Combine <strong>gems</strong> from Prospecting with <strong>metal bars</strong> from Blacksmithing to forge powerful jewelry. <strong>Amulets</strong> provide broad XP bonuses to Gathering or Artisan skills, while <strong>Rings</strong> offer focused speed boosts per skill or sharp combat stat bonuses. Equip 1 amulet + 2 rings in the Equipment tab!
      </div>
      <div class="action-grid" id="grid-jewelcrafting"></div>
    </div>
    <!-- COMBAT -->
    <div class="page" id="page-combat">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-combat">⚔️</span></div>
        <div class="pg-title">
          <h2>Combat</h2>
          <div class="pg-xp-area" id="pgxp-combat"></div>
        </div>
      </div>
      <div class="production-info" style="border-left-color:var(--red)">
        ⚔️ Fight <strong>monsters</strong> across 7 zones to earn combat XP, gold, and valuable item drops. Each combat sub-skill (Attack, Strength, Haste, Defense, Hitpoints) levels independently. Forge or buy <strong>weapons and armor</strong> in the Equipment tab to boost your power. Cooked food <strong>auto-heals</strong> you mid-fight — always keep some in your bank!
      </div>

      <!-- ARENA: shown when a monster is selected -->
      <div class="combat-arena-wrap" id="combat-arena-wrap" style="display:none">
        <div class="combat-arena">
          <div class="combatants" id="combatants-display"></div>
          <div class="combat-mastery-display" id="combat-mastery-display" style="display:none">
            <div style="font-size:11px;color:var(--text3);margin-bottom:4px">Enemy Mastery</div>
            <div style="display:flex;align-items:center;gap:8px">
              <div style="flex:1;height:8px;background:var(--bg3);border-radius:4px;overflow:hidden;border:1px solid var(--border)">
                <div id="combat-mastery-bar" style="height:100%;background:linear-gradient(90deg,var(--gold),var(--gold2));transition:width 0.3s ease"></div>
              </div>
              <div id="combat-mastery-text" style="font-size:12px;font-weight:600;color:var(--gold2);min-width:80px;text-align:right">Lv 1 (0%)</div>
            </div>
          </div>
          <div class="combat-log" id="combat-log"><p class="clog-p">Select a zone below, then pick a monster to begin!</p></div>
          <div class="combat-btns" id="combat-btns">
            <button class="btn btn-green" onclick="startCombat()" id="btn-fight">⚔️ Fight</button>
            <button class="btn btn-red" onclick="stopCombat()">✋ Stop</button>
            <button class="btn" onclick="openZoneGrid()" style="margin-left:auto">🗺️ Change Monster</button>
          </div>
        </div>
        <div class="sec-title" style="margin-top:10px">🍖 Food in Bank</div>
        <div id="food-display" style="font-size:12px;color:var(--text2);margin-bottom:14px">No food available. Cook some fish first!</div>
      </div>

      <!-- ZONE GRID: always visible, select a zone to open monster modal -->
      <div id="zone-grid-wrap">
        <div class="sec-title" id="zone-grid-title">🗺️ Choose a Zone</div>
        <div class="zone-grid" id="zone-select"></div>
      </div>
    </div>
    <!-- STATS -->
    <div class="page" id="page-stats">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">📊</span></div>
        <div class="pg-title"><h2>Player Stats</h2></div>
      </div>
      <div class="stats-page-grid">
        <div>
          <!-- Equipped Badge -->
          <div class="equipped-badge-display" id="equipped-badge-display" style="display:none">
            <div class="ebd-label">Equipped Badge</div>
            <div class="ebd-badge" id="equipped-badge-value">-</div>
            <div class="ebd-sub">Unlocked from achievements</div>
          </div>
          <!-- Total Level -->
          <div class="total-level-display">
            <div class="tld-label">Total Level</div>
            <div class="tld-value" id="stats-total-level">-</div>
            <div class="tld-sub">Sum of all skill levels</div>
          </div>
          <!-- All Skills Overview -->
          <div class="stats-section">
            <h3>⚒️ Skills</h3>
            <div class="skill-overview-grid" id="stats-skill-grid"></div>
          </div>
          <!-- Mastery Shop Purchases -->
          <div class="stats-section" style="margin-top:12px">
            <h3 onclick="toggleMasteryPurchases()" style="cursor:pointer;user-select:none">🛒 Mastery Shop Purchases <span id="mastery-toggle" style="font-size:14px;color:var(--text3)">▶</span></h3>
            <div id="stats-mastery-track" style="display:none"></div>
          </div>
        </div>
        <div>
          <!-- Combat Stats -->
          <div class="stats-section">
            <h3>⚔️ Combat Stats</h3>
            <div class="csc-grid" id="stats-combat-grid"></div>
          </div>
          <!-- Combat Sub-Skills XP -->
          <div class="stats-section" style="margin-top:12px">
            <h3>🧬 Combat Skills XP</h3>
            <div id="stats-combat-xp"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- BANK -->
    <div class="page" id="page-bank">
      <div class="pg-header">
        <div class="pg-icon">🏦</div>
        <div class="pg-title"><h2>Bank</h2></div>
        <button class="btn" onclick="renderBank()" style="margin-left:auto;padding:6px 12px;font-size:12px" title="Refresh bank display">🔄 Refresh</button>
      </div>

      <div class="bank-controls">
        <!-- Gold + action buttons -->
        <div class="bank-gold-row">
          <div class="bank-gold">🪙 <span id="bank-gold-disp">0</span> gp</div>
          <div class="bank-action-btns">
            <button class="btn btn-select-mode" id="bank-select-btn" onclick="toggleBankSelectMode()">☑ Select Items</button>
          </div>
        </div>

        <!-- Sell All section (collapsible) -->
        <div class="bank-sell-section">
          <div class="bank-sell-header" onclick="toggleBankSellSection()">
            <div class="bank-sell-header-label">💰 Sell All by Category <span id="bank-sell-toggle" style="font-size:12px;color:var(--text4)">▶</span></div>
            <div class="bank-sell-header-hint">Click to expand sell options</div>
          </div>
          <div class="bank-sell-body" id="bank-sell-body">
            <div class="sell-group">
              <div class="sell-group-label">Raw Materials</div>
              <div class="sell-group-btns">
                <button class="btn-sell-cat" onclick="sellAllCategory('logs')">🪵 All Logs</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('ore')">🪨 All Ore</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('fish')">🐟 All Raw Fish</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('gem')">💎 All Gems</button>
              </div>
            </div>
            <div class="sell-group">
              <div class="sell-group-label">Processed Goods</div>
              <div class="sell-group-btns">
                <button class="btn-sell-cat" onclick="sellAllCategory('bar')">🔩 All Bars</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('food')">🍖 All Food</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('jewelry')">📿 All Jewelry</button>
              </div>
            </div>
            <div class="sell-group">
              <div class="sell-group-label">Equipment</div>
              <div class="sell-group-btns">
                <button class="btn-sell-cat" onclick="sellAllCategory('weapon')">⚔️ All Weapons</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('armor')">🛡️ All Armor</button>
                <button class="btn-sell-cat" onclick="sellAllCategory('tool')">🔧 All Tools</button>
              </div>
            </div>
            <div class="sell-group">
              <div class="sell-group-label">Other</div>
              <div class="sell-group-btns">
                <button class="btn-sell-cat" onclick="sellAllCategory('junk')">🗑️ All Junk</button>
                <button class="btn-sell-cat danger" onclick="sellAllValueable()">💸 Sell All Valuables</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="production-info">
        🏦 Your bank stores every resource, material, and item you collect. Use the <strong>category tabs</strong> to filter by item type. In the <strong>All</strong> tab, <strong>drag and drop items to reorder</strong> them. <strong>Hover any item</strong> to see sell options, or use <strong>Select Items</strong> to pick multiple items and sell them together. Expand <strong>Sell All by Category</strong> to bulk-sell entire item groups at once.
      </div>

      <!-- Selected bar — shown inline when select mode is active -->
      <div class="bank-selected-bar" id="bank-selected-bar">
        <div class="bsb-info">
          <div class="bsb-count" id="bsb-count">0 items selected</div>
          <div class="bsb-value" id="bsb-value">0 gp total</div>
        </div>
        <div class="bsb-actions">
          <button class="bsb-clear" onclick="clearBankSelection()">Clear</button>
          <button class="bsb-sell" onclick="sellSelected()">💰 Sell Selected</button>
        </div>
      </div>

      <div class="bank-cats" id="bank-cats"></div>
      <div class="bank-grid" id="bank-grid"></div>
    </div>
    <!-- EQUIPMENT -->
    <div class="page" id="page-equipment">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-armor">🛡️</span></div>
        <div class="pg-title"><h2>Equipment</h2></div>
      </div>
      <div class="production-info">
        🛡️ Equip <strong>weapons and armor</strong> forged at Blacksmithing to boost your combat stats. Craft <strong>skilling tools</strong> at Woodworking to speed up gathering and production skills — only one can be equipped at a time. Find rare <strong>Trinkets</strong> tied to each skill — each one drops while training its own skill (0.1% base chance, increasing with your level) — amplifying XP, doubling resources, or boosting gem chances, and complete Jewelcrafting recipes to craft powerful <strong>amulets and rings</strong>. Once geared up, use <strong>Gear Infusion</strong> below to push your equipment further — up to +10 ranks per piece, boosting offensive stats by 1% per rank and defensive stats by 0.7% per rank!
      </div>
      <div class="equip-top">
        <div class="equip-col-combat">
          <div class="equip-col-label">⚔️ Combat Gear</div>
          <div class="equip-slots-combat" id="equip-slots-combat"></div>
        </div>
        <div class="equip-col-utility">
          <div class="equip-col-label">🎒 Utility</div>
          <div class="equip-slots-utility" id="equip-slots-utility"></div>
        </div>
        <div class="equip-col-stats">
          <div class="stats-display" id="stats-display"></div>
        </div>
      </div>
      <div class="equip-infusion-section">
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:10px">
          <div class="sec-title" style="margin:0;border:none">✨ Gear Infusion</div>
          <details class="infusion-guide-details">
            <summary style="cursor:pointer;font-size:11px;color:var(--blue2);font-weight:600;list-style:none;padding:4px 10px;background:var(--bg3);border:1px solid var(--border);border-radius:var(--radius-md)">📘 Bonus Guide ▾</summary>
            <div class="infusion-guide-popup">
              <div style="color:var(--text3);margin-bottom:6px;font-size:10px">Offensive stats: +1%/rank · Defensive stats: +0.7%/rank</div>
              <div><strong style="color:var(--gold2)">⚔️ Weapon:</strong> Eq. ATK, Crit, Power <em style="color:var(--text3)">(+1%)</em></div>
              <div><strong style="color:var(--gold2)">⛑️ Helmet:</strong> Eq. DEF, Crit, Power <em style="color:var(--text3)">(+1%)</em> · Armor, Block <em style="color:var(--text3)">(+0.7%)</em></div>
              <div><strong style="color:var(--gold2)">🧥 Body:</strong> Eq. DEF, Crit, Power <em style="color:var(--text3)">(+1%)</em> · Armor, Block <em style="color:var(--text3)">(+0.7%)</em></div>
              <div><strong style="color:var(--gold2)">👖 Legs:</strong> Eq. DEF, Crit, Power <em style="color:var(--text3)">(+1%)</em> · Armor, Block <em style="color:var(--text3)">(+0.7%)</em></div>
              <div><strong style="color:var(--gold2)">🧤 Gloves:</strong> Eq. DEF <em style="color:var(--text3)">(+1%)</em> · Max HP, Armor, Block <em style="color:var(--text3)">(+0.7%)</em></div>
              <div><strong style="color:var(--gold2)">🥾 Boots:</strong> Eq. DEF <em style="color:var(--text3)">(+1%)</em> · Atk Speed, Armor, Block <em style="color:var(--text3)">(+0.7%)</em></div>
              <div><strong style="color:var(--gold2)">🛡️ Shield:</strong> Eq. DEF <em style="color:var(--text3)">(+1%)</em> · Armor, Block, Max HP <em style="color:var(--text3)">(+0.7%)</em></div>
            </div>
          </details>
        </div>
        <div class="infusion-row" id="infusion-options"></div>
      </div>
    </div>
    <!-- CONTRACTS -->
    <div class="page" id="page-contracts">
      <div class="pg-header">
        <div class="pg-icon">📋</div>
        <div class="pg-title"><h2>Requisition Board</h2></div>
      </div>
      <details style="margin:0 16px 12px 16px;padding:10px;background:var(--bg3);border-radius:6px;border:1px solid var(--border)">
        <summary style="cursor:pointer;font-size:12px;color:var(--blue2);font-weight:600;padding:4px">ℹ️ How Contracts Work</summary>
        <div style="margin-top:8px;font-size:11px;color:var(--text2);line-height:1.6">
          <p style="margin:4px 0"><strong style="color:var(--gold2)">What are contracts?</strong> The Requisition Board offers a rotating set of contracts — each asking you to deliver specific items in exchange for <strong>gold, XP, and gear rewards</strong>.</p>
          <ul style="margin:6px 0;padding-left:20px">
            <li><strong>Tiers:</strong> Basic → Common → Uncommon → Rare → Epic → Legendary. Higher tiers give better rewards but need better items.</li>
            <li><strong>Refresh:</strong> Contracts refresh every 4 hours, or immediately when all current contracts are completed.</li>
            <li><strong>XP Rewards:</strong> Completing a contract grants XP directly to the matching skill — a great way to boost skills beyond grinding.</li>
            <li><strong>Item Rewards:</strong> Many contracts also reward crafted gear, ingots, or cooked food on top of gold.</li>
            <li><strong>Keep your bank stocked</strong> — contracts check your bank for required items. Having diverse materials ready lets you complete any contract that shows up.</li>
          </ul>
          <p style="margin:4px 0;color:var(--text3);font-size:10px">💡 Tip: All 10 skills have contracts. Check your Mastery upgrades — they can speed up gathering the items you need!</p>
        </div>
      </details>
      <div class="contract-refresh" id="contract-refresh-timer"></div>
      <div class="contract-grid" id="contract-grid"></div>
    </div>
    <!-- MASTERY SHOP -->
    <div class="page" id="page-mastery-shop">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-trinket">⭐</span></div>
        <div class="pg-title"><h2>Mastery Exchange</h2></div>
      </div>
      <div class="production-info" style="border-left-color:var(--mastery)">
        ⭐ Earn mastery points by training actions — each action and monster has its own mastery track. <strong>2.5 points per mastery level</strong> (Lv 99 = 247 pts). Spend points on permanent bonuses below. The <strong>🔄 Reset</strong> button refunds all spent points for 50,000gp (doubles each use, 7-day cooldown) — your mastery XP is never lost.
      </div>
      <div class="mastery-total">
        <div class="mt-label">Available Mastery Points</div>
        <div class="mt-value" id="ms-total-points">0</div>
        <div class="mt-sub">Spend mastery to unlock permanent bonuses</div>
        <button id="mastery-reset-btn" onclick="confirmMasteryReset()" style="margin-top:12px;padding:8px 18px;background:var(--bg3);border:1px solid var(--red);color:var(--red2);border-radius:6px;cursor:pointer;font-size:12px;font-weight:600;transition:all 0.2s" onmouseover="this.style.background='rgba(220,50,50,0.15)'" onmouseout="this.style.background='var(--bg3)'">🔄 Reset Mastery Unlocks</button>
        <div id="mastery-reset-cost" style="margin-top:6px;font-size:11px;color:var(--text3)"></div>
      </div>
      <div class="mastery-tabs" id="ms-tabs"></div>
      <div class="upgrade-grid" id="upgrade-grid"></div>
    </div>
    <!-- GENERAL STORE -->
    <div class="page" id="page-store">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">🏪</span></div>
        <div class="pg-title">
          <h2>General Store</h2>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">💰 Your Gold: <span style="color:var(--gold2);font-weight:600" id="store-gold">0gp</span></div>
        </div>
      </div>
      <div class="production-info" style="border-left-color:var(--gold2)">
        🏪 Buy <strong>food, bars, and gear</strong> using gold earned from combat and pickpocketing. Use <strong>Buy X</strong> to purchase any exact quantity. Food is the most important purchase — always keep a stockpile for combat!
      </div>
      <div class="store-categories" id="store-categories"></div>
      <div class="store-grid" id="store-grid"></div>
    </div>
    
    <!-- STATISTICS -->
    <div class="page" id="page-statistics">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">📈</span></div>
        <div class="pg-title">
          <h2>Statistics</h2>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Your Lifetime Stats</div>
        </div>
      </div>
      <div id="statistics-content"></div>
    </div>
    
    <!-- COLLECTION LOG -->
    <div class="page" id="page-collection">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">📚</span></div>
        <div class="pg-title">
          <h2>Collection Log</h2>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Track Your Discoveries</div>
        </div>
      </div>
      <div id="collection-content"></div>
    </div>
    
    <!-- ACHIEVEMENTS -->
    <div class="page" id="page-achievements">
      <div class="pg-header">
        <div class="pg-icon"><span class="icon-pill icon-pill-lg ip-misc">🏆</span></div>
        <div class="pg-title">
          <h2>Achievements</h2>
          <div style="font-size:12px;color:var(--text3);margin-top:4px">Your Milestones</div>
        </div>
      </div>
      <div id="achievements-content"></div>
    </div>
  </div>
</div>

<div id="notifs"></div>

<div class="modal-overlay" id="modal-overlay" onclick="event.target===this&&closeModal()">
  <div class="modal" onclick="event.stopPropagation()">
    <h3 id="modal-title">Equip Item</h3>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-footer">
      <button class="btn" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
// ── ICON PILL HELPER ──────────────────────────────────────────────────────────
// Maps item category (or explicit type) to CSS colour class
const CAT_CLASS = {
  logs:'ip-logs', ore:'ip-ore', bar:'ip-bar', fish:'ip-fish', food:'ip-food',
  gem:'ip-gem', jewelry:'ip-jewelry', weapon:'ip-weapon', armor:'ip-armor',
  tool:'ip-tool', trinket:'ip-trinket', material:'ip-material', junk:'ip-junk',
  combat:'ip-combat', skill:'ip-skill', misc:'ip-misc',
  // skill aliases
  woodcutting:'ip-logs', mining:'ip-ore', fishing:'ip-fish', smithing:'ip-bar',
  cooking:'ip-food', pickpocketing:'ip-misc', woodworking:'ip-tool',
  prospecting:'ip-gem', jewelcrafting:'ip-jewelry',
};
function iconPill(emoji, cat, size='md'){
  const cls = CAT_CLASS[cat] || 'ip-misc';
  return `<span class="icon-pill icon-pill-${size} ${cls}">${emoji}</span>`;
}
// Convenience: build pill from an ITEMS entry
function itemPill(itemId, size='md'){
  const it = ITEMS[itemId];
  if(!it) return '';
  return iconPill(it.icon, it.cat, size);
}

// ============================================================
// DATA DEFINITIONS
// ============================================================

// XP table (RS-style): XP needed to reach each level
const XP_TABLE = (()=>{
  const t=[0];
  let pts=0;
  for(let i=1;i<=99;i++){
    pts += Math.floor(i + 300 * Math.pow(2, i/7));
    t.push(Math.floor(pts/4));
  }
  return t;
})();

function xpToLevel(xp){
  let lv=1;
  for(let i=1;i<99;i++){if(xp>=XP_TABLE[i])lv=i+1;else break;}
  return lv;
}
function xpForLevel(lv){return XP_TABLE[lv-1]||0;}
function xpToNextLevel(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 0;
  return XP_TABLE[lv]-xp;
}
function xpProgress(xp){
  const lv=xpToLevel(xp);
  if(lv>=99)return 1;
  const base=XP_TABLE[lv-1];
  const next=XP_TABLE[lv];
  return (xp-base)/(next-base);
}

const fmt=(n)=>n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'k':String(Math.floor(n));

// ============================================================
// INTERNAL ID → IN-GAME NAME REFERENCE
// Internal item keys use legacy generic names. The player-facing
// names are set in the .name field. Use the table below when
// reading or editing any item IDs, drop tables, contracts, etc.
//
//  Key prefix    In-game tier name
//  ----------    -----------------
//  bronze_       Roughplate
//  iron_         Emberguard
//  silver_       Brightmail
//  steel_        Grimforge
//  mithril_      Moonweave
//  adamant_      Sungilt
//  rune_         Stormcast
//  dragon_       Duskwarden
//
//  Ore / bar names (internal → display):
//  copper_ore    Graveliron Ore        bronze_bar    Roughplate Bar
//  tin_ore       Graveliron Flux       iron_bar      Emberguard Bar
//  iron_ore      Redvein Ore           silver_bar    Brightmail Bar
//  silver_ore    Tinflare Ore          steel_bar     Grimforge Bar
//  coal          Emberstone            mithril_bar   Moonweave Bar
//  mithril_ore   Pale Silver Ore       adamant_bar   Sungilt Bar
//  adamant_ore   Goldember Ore         rune_bar      Stormcast Bar
//  runite_ore    Cobalite Ore          dragon_bar    Duskwarden Bar
//  dragon_ore    Nightnickel Ore
// ============================================================

// ITEMS
const ITEMS = {
  normal_log:{name:'Kindlewood',icon:'🪵',value:5,cat:'logs'},
  oak_log:{name:'Brackenbark',icon:'🪵',value:15,cat:'logs'},
  willow_log:{name:'Ironroot',icon:'🪵',value:30,cat:'logs'},
  maple_log:{name:'Duskhollow',icon:'🍁',value:60,cat:'logs'},
  teak_log:{name:'Ambergrain',icon:'🪵',value:90,cat:'logs'},
  yew_log:{name:'Frostelm',icon:'🌲',value:140,cat:'logs'},
  magic_log:{name:'Stormheart Timber',icon:'✨',value:220,cat:'logs'},
  redwood_log:{name:'Mythoak',icon:'🌳',value:350,cat:'logs'},
  copper_ore:{name:'Graveliron Ore',icon:'🟤',value:5,cat:'ore'},
  tin_ore:{name:'Graveliron Flux',icon:'🔵',value:5,cat:'ore'},
  iron_ore:{name:'Redvein Copper',icon:'⬛',value:15,cat:'ore'},
  silver_ore:{name:'Tinflare Ore',icon:'⚪',value:25,cat:'ore'},
  coal:{name:'Emberstone',icon:'🖤',value:25,cat:'ore'},
  mithril_ore:{name:'Pale Silver',icon:'💠',value:60,cat:'ore'},
  adamant_ore:{name:'Goldember Ore',icon:'🟢',value:120,cat:'ore'},
  runite_ore:{name:'Cobalite Ore',icon:'🔷',value:200,cat:'ore'},
  dragon_ore:{name:'Nightnickel Ore',icon:'🔶',value:400,cat:'ore'},
  raw_shrimp:{name:'Ripplefin',icon:'🦐',value:3,cat:'fish'},
  raw_trout:{name:'Stonebelly Carp',icon:'🐟',value:10,cat:'fish'},
  raw_salmon:{name:'Glintscale',icon:'🐠',value:20,cat:'fish'},
  raw_tuna:{name:'Longwhisk Pike',icon:'🐟',value:35,cat:'fish'},
  raw_lobster:{name:'Bluecurrent Salmon',icon:'🦞',value:50,cat:'fish'},
  raw_bass:{name:'Reefstrider',icon:'🐟',value:70,cat:'fish'},
  raw_swordfish:{name:'Mist Koi',icon:'🗡️',value:100,cat:'fish'},
  raw_monkfish:{name:'Thunderhead Catfish',icon:'🐟',value:140,cat:'fish'},
  raw_shark:{name:'Crystal Perch',icon:'🦈',value:200,cat:'fish'},
  raw_manta:{name:'Abyss Lanternfish',icon:'🐟',value:280,cat:'fish'},
  raw_turtle:{name:'Crownray',icon:'🐢',value:400,cat:'fish'},
  bronze_bar:{name:'Graveliron Ingot',icon:'🟫',value:40,cat:'bar'},
  iron_bar:{name:'Emberguard Ingot',icon:'🔩',value:80,cat:'bar'},
  silver_bar:{name:'Brightmail Ingot',icon:'⚙️',value:120,cat:'bar'},
  steel_bar:{name:'Grimforge Ingot',icon:'⚙️',value:150,cat:'bar'},
  mithril_bar:{name:'Moonweave Ingot',icon:'💎',value:300,cat:'bar'},
  adamant_bar:{name:'Sungilt Ingot',icon:'🔰',value:600,cat:'bar'},
  rune_bar:{name:'Stormcast Ingot',icon:'🔷',value:1200,cat:'bar'},
  dragon_bar:{name:'Duskwarden Ingot',icon:'🔶',value:2500,cat:'bar'},
  infusion_crystal:{name:'Infusion Crystal',icon:'💎',value:100000,cat:'material'},
  // ── GEMS (cat:'gem') ─────────────────────────────────────────────────────
  ashshard:{name:'Ashshard',icon:'🔮',value:20,cat:'gem'},
  dustchip:{name:'Dustchip',icon:'💎',value:25,cat:'gem'},
  emberspark:{name:'Emberspark',icon:'🔴',value:60,cat:'gem'},
  silversliver:{name:'Silversliver',icon:'🔷',value:100,cat:'gem'},
  coalite:{name:'Coalite',icon:'⚫',value:100,cat:'gem'},
  mooncrystal:{name:'Mooncrystal',icon:'🌙',value:250,cat:'gem'},
  sungem:{name:'Sungem',icon:'🌟',value:500,cat:'gem'},
  stormstone:{name:'Stormstone',icon:'⚡',value:1000,cat:'gem'},
  voidgem:{name:'Voidgem',icon:'🌌',value:2000,cat:'gem'},
  // ── JEWELRY – GATHERING AMULETS (slot:'amulet', amuletType:'gathering') ──
  graveliron_amulet:{name:'Graveliron Amulet',icon:'📿',value:200,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:2,bonus:'+2% Gathering XP'},
  emberguard_amulet:{name:'Emberguard Amulet',icon:'📿',value:400,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:4,bonus:'+4% Gathering XP'},
  brightmail_amulet:{name:'Brightmail Amulet',icon:'📿',value:800,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:6,bonus:'+6% Gathering XP'},
  grimforge_amulet:{name:'Grimforge Amulet',icon:'📿',value:1500,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:8,bonus:'+8% Gathering XP'},
  moonweave_amulet:{name:'Moonweave Amulet',icon:'📿',value:3000,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:10,bonus:'+10% Gathering XP'},
  sungilt_amulet:{name:'Sungilt Amulet',icon:'📿',value:6000,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:12,bonus:'+12% Gathering XP'},
  stormcast_amulet:{name:'Stormcast Amulet',icon:'📿',value:12000,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:14,bonus:'+14% Gathering XP'},
  duskwarden_amulet:{name:'Duskwarden Amulet',icon:'📿',value:25000,cat:'jewelry',slot:'amulet',amuletType:'gathering',xpBonus:16,bonus:'+16% Gathering XP'},
  // ── JEWELRY – ARTISAN AMULETS (slot:'amulet', amuletType:'artisan') ───────
  graveliron_artisan_amulet:{name:'Graveliron Artisan Amulet',icon:'📿',value:200,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:2,bonus:'+2% Artisan XP'},
  emberguard_artisan_amulet:{name:'Emberguard Artisan Amulet',icon:'📿',value:400,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:4,bonus:'+4% Artisan XP'},
  brightmail_artisan_amulet:{name:'Brightmail Artisan Amulet',icon:'📿',value:800,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:6,bonus:'+6% Artisan XP'},
  grimforge_artisan_amulet:{name:'Grimforge Artisan Amulet',icon:'📿',value:1500,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:8,bonus:'+8% Artisan XP'},
  moonweave_artisan_amulet:{name:'Moonweave Artisan Amulet',icon:'📿',value:3000,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:10,bonus:'+10% Artisan XP'},
  sungilt_artisan_amulet:{name:'Sungilt Artisan Amulet',icon:'📿',value:6000,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:12,bonus:'+12% Artisan XP'},
  stormcast_artisan_amulet:{name:'Stormcast Artisan Amulet',icon:'📿',value:12000,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:14,bonus:'+14% Artisan XP'},
  duskwarden_artisan_amulet:{name:'Duskwarden Artisan Amulet',icon:'📿',value:25000,cat:'jewelry',slot:'amulet',amuletType:'artisan',xpBonus:16,bonus:'+16% Artisan XP'},
  // ── JEWELRY – COMBAT AMULETS (slot:'amulet', amuletType:'combat') ─────────
  valor_amulet_t1:{name:'Amulet of Valor',icon:'📿',value:500,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:1,defBonus:1,bonus:'+1 ATK, +1 DEF'},
  valor_amulet_t2:{name:'Amulet of Might',icon:'📿',value:1200,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:2,defBonus:2,bonus:'+2 ATK, +2 DEF'},
  valor_amulet_t3:{name:'Amulet of Fury',icon:'📿',value:2500,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:3,defBonus:3,bonus:'+3 ATK, +3 DEF'},
  valor_amulet_t4:{name:'Amulet of Power',icon:'📿',value:5000,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:4,defBonus:4,bonus:'+4 ATK, +4 DEF'},
  valor_amulet_t5:{name:'Amulet of the Warden',icon:'📿',value:10000,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:5,defBonus:5,bonus:'+5 ATK, +5 DEF'},
  valor_amulet_t6:{name:'Amulet of the Storm',icon:'📿',value:20000,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:6,defBonus:6,bonus:'+6 ATK, +6 DEF'},
  valor_amulet_t7:{name:'Amulet of the Void',icon:'📿',value:40000,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:7,defBonus:7,bonus:'+7 ATK, +7 DEF'},
  valor_amulet_t8:{name:'Amulet of Eternity',icon:'📿',value:80000,cat:'jewelry',slot:'amulet',amuletType:'combat',atkBonus:8,defBonus:8,bonus:'+8 ATK, +8 DEF'},
  // ── JEWELRY – SKILLING RINGS (slot:'ring') ────────────────────────────────
  ring_of_felled:{name:'Ring of the Felled',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'woodcutting',speedBonus:5,bonus:'-5% Woodcutting time'},
  ring_of_veins:{name:'Ring of the Veins',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'mining',speedBonus:5,bonus:'-5% Mining time'},
  ring_of_deep:{name:'Ring of the Deep',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'fishing',speedBonus:5,bonus:'-5% Fishing time'},
  ring_of_hearth:{name:'Ring of the Hearth',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'cooking',speedBonus:5,bonus:'-5% Cooking time'},
  ring_of_craft:{name:'Ring of the Craft',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'woodworking',speedBonus:5,bonus:'-5% Woodworking time'},
  ring_of_forge:{name:'Ring of the Forge',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'smithing',speedBonus:5,bonus:'-5% Blacksmithing time'},
  ring_of_shadow:{name:'Ring of the Shadow',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'pickpocketing',speedBonus:5,bonus:'-5% Pickpocketing time'},
  ring_of_lens:{name:'Ring of the Lens',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'prospecting',speedBonus:5,bonus:'-5% Prospecting time'},
  ring_of_facet:{name:'Ring of the Facet',icon:'💍',value:2000,cat:'jewelry',slot:'ring',ringSkill:'jewelcrafting',speedBonus:5,bonus:'-5% Jewelcrafting time'},
  // ── JEWELRY – COMBAT RINGS (slot:'ring') ─────────────────────────────────
  bloodstone_ring:{name:'Bloodstone Ring',icon:'💍',value:3000,cat:'jewelry',slot:'ring',ringType:'crit',critBonus:2,bonus:'+2% Crit Chance'},
  crimson_ring:{name:'Crimson Sigil Ring',icon:'💍',value:18000,cat:'jewelry',slot:'ring',ringType:'crit',critBonus:5,bonus:'+5% Crit Chance'},
  fury_ring:{name:'Ring of Fury',icon:'💍',value:3000,cat:'jewelry',slot:'ring',ringType:'power',powerBonus:3,bonus:'+3 Power'},
  rage_ring:{name:'Ring of Rage',icon:'💍',value:18000,cat:'jewelry',slot:'ring',ringType:'power',powerBonus:8,bonus:'+8 Power'},
  ironwill_ring:{name:'Ironwill Ring',icon:'💍',value:3500,cat:'jewelry',slot:'ring',ringType:'defense',defBonus:5,bonus:'+5 Defense'},
  bulwark_ring:{name:'Bulwark Ring',icon:'💍',value:20000,cat:'jewelry',slot:'ring',ringType:'defense',defBonus:12,bonus:'+12 Defense'},
  swiftblade_ring:{name:'Swiftblade Ring',icon:'💍',value:4000,cat:'jewelry',slot:'ring',ringType:'haste',hasteBonus:1,bonus:'-1 Attack Interval'},
  stormstep_ring:{name:'Stormstep Ring',icon:'💍',value:22000,cat:'jewelry',slot:'ring',ringType:'haste',hasteBonus:2,bonus:'-2 Attack Interval'},
  // ── SKILLING TOOLS (cat:'tool', slot:'tool') ──────────────────────────────
  // Tier 1 – Graveliron (3% speed)
  graveliron_axe:{name:'Graveliron Axe',icon:'🪓',value:50,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:3,bonus:'-3% Woodcutting time'},
  graveliron_mattock:{name:'Graveliron Mattock',icon:'⛏️',value:50,cat:'tool',slot:'tool',skill:'mining',speedBonus:3,bonus:'-3% Mining time'},
  graveliron_rod:{name:'Graveliron Rod',icon:'🎣',value:50,cat:'tool',slot:'tool',skill:'fishing',speedBonus:3,bonus:'-3% Fishing time'},
  graveliron_hammer:{name:'Graveliron Hammer',icon:'🔨',value:50,cat:'tool',slot:'tool',skill:'smithing',speedBonus:3,bonus:'-3% Blacksmithing time'},
  graveliron_cauldron:{name:'Graveliron Cauldron',icon:'🍲',value:50,cat:'tool',slot:'tool',skill:'cooking',speedBonus:3,bonus:'-3% Cooking time'},
  graveliron_pick:{name:'Graveliron Pick',icon:'🗝️',value:50,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:3,bonus:'-3% Pickpocketing time'},
  graveliron_plane:{name:'Graveliron Plane',icon:'📐',value:50,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:3,bonus:'-3% Woodworking time'},
  graveliron_loupe:{name:'Graveliron Loupe',icon:'🔭',value:50,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:3,bonus:'-3% Prospecting time'},
  graveliron_shears:{name:'Graveliron Shears',icon:'✂️',value:50,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:3,bonus:'-3% Jewelcrafting time'},
  // Tier 2 – Emberguard (6% speed)
  emberguard_axe:{name:'Emberguard Axe',icon:'🪓',value:150,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:6,bonus:'-6% Woodcutting time'},
  emberguard_mattock:{name:'Emberguard Mattock',icon:'⛏️',value:150,cat:'tool',slot:'tool',skill:'mining',speedBonus:6,bonus:'-6% Mining time'},
  emberguard_rod:{name:'Emberguard Rod',icon:'🎣',value:150,cat:'tool',slot:'tool',skill:'fishing',speedBonus:6,bonus:'-6% Fishing time'},
  emberguard_hammer:{name:'Emberguard Hammer',icon:'🔨',value:150,cat:'tool',slot:'tool',skill:'smithing',speedBonus:6,bonus:'-6% Blacksmithing time'},
  emberguard_cauldron:{name:'Emberguard Cauldron',icon:'🍲',value:150,cat:'tool',slot:'tool',skill:'cooking',speedBonus:6,bonus:'-6% Cooking time'},
  emberguard_pick:{name:'Emberguard Pick',icon:'🗝️',value:150,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:6,bonus:'-6% Pickpocketing time'},
  emberguard_plane:{name:'Emberguard Plane',icon:'📐',value:150,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:6,bonus:'-6% Woodworking time'},
  emberguard_loupe:{name:'Emberguard Loupe',icon:'🔭',value:150,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:6,bonus:'-6% Prospecting time'},
  emberguard_shears:{name:'Emberguard Shears',icon:'✂️',value:150,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:6,bonus:'-6% Jewelcrafting time'},
  // Tier 3 – Brightmail (9% speed)
  brightmail_axe:{name:'Brightmail Axe',icon:'🪓',value:350,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:9,bonus:'-9% Woodcutting time'},
  brightmail_mattock:{name:'Brightmail Mattock',icon:'⛏️',value:350,cat:'tool',slot:'tool',skill:'mining',speedBonus:9,bonus:'-9% Mining time'},
  brightmail_rod:{name:'Brightmail Rod',icon:'🎣',value:350,cat:'tool',slot:'tool',skill:'fishing',speedBonus:9,bonus:'-9% Fishing time'},
  brightmail_hammer:{name:'Brightmail Hammer',icon:'🔨',value:350,cat:'tool',slot:'tool',skill:'smithing',speedBonus:9,bonus:'-9% Blacksmithing time'},
  brightmail_cauldron:{name:'Brightmail Cauldron',icon:'🍲',value:350,cat:'tool',slot:'tool',skill:'cooking',speedBonus:9,bonus:'-9% Cooking time'},
  brightmail_pick:{name:'Brightmail Pick',icon:'🗝️',value:350,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:9,bonus:'-9% Pickpocketing time'},
  brightmail_plane:{name:'Brightmail Plane',icon:'📐',value:350,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:9,bonus:'-9% Woodworking time'},
  brightmail_loupe:{name:'Brightmail Loupe',icon:'🔭',value:350,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:9,bonus:'-9% Prospecting time'},
  brightmail_shears:{name:'Brightmail Shears',icon:'✂️',value:350,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:9,bonus:'-9% Jewelcrafting time'},
  // Tier 4 – Grimforge (12% speed)
  grimforge_axe:{name:'Grimforge Axe',icon:'🪓',value:800,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:12,bonus:'-12% Woodcutting time'},
  grimforge_mattock:{name:'Grimforge Mattock',icon:'⛏️',value:800,cat:'tool',slot:'tool',skill:'mining',speedBonus:12,bonus:'-12% Mining time'},
  grimforge_rod:{name:'Grimforge Rod',icon:'🎣',value:800,cat:'tool',slot:'tool',skill:'fishing',speedBonus:12,bonus:'-12% Fishing time'},
  grimforge_hammer:{name:'Grimforge Hammer',icon:'🔨',value:800,cat:'tool',slot:'tool',skill:'smithing',speedBonus:12,bonus:'-12% Blacksmithing time'},
  grimforge_cauldron:{name:'Grimforge Cauldron',icon:'🍲',value:800,cat:'tool',slot:'tool',skill:'cooking',speedBonus:12,bonus:'-12% Cooking time'},
  grimforge_pick:{name:'Grimforge Pick',icon:'🗝️',value:800,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:12,bonus:'-12% Pickpocketing time'},
  grimforge_plane:{name:'Grimforge Plane',icon:'📐',value:800,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:12,bonus:'-12% Woodworking time'},
  grimforge_loupe:{name:'Grimforge Loupe',icon:'🔭',value:800,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:12,bonus:'-12% Prospecting time'},
  grimforge_shears:{name:'Grimforge Shears',icon:'✂️',value:800,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:12,bonus:'-12% Jewelcrafting time'},
  // Tier 5 – Moonweave (15% speed)
  moonweave_axe:{name:'Moonweave Axe',icon:'🪓',value:1800,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:15,bonus:'-15% Woodcutting time'},
  moonweave_mattock:{name:'Moonweave Mattock',icon:'⛏️',value:1800,cat:'tool',slot:'tool',skill:'mining',speedBonus:15,bonus:'-15% Mining time'},
  moonweave_rod:{name:'Moonweave Rod',icon:'🎣',value:1800,cat:'tool',slot:'tool',skill:'fishing',speedBonus:15,bonus:'-15% Fishing time'},
  moonweave_hammer:{name:'Moonweave Hammer',icon:'🔨',value:1800,cat:'tool',slot:'tool',skill:'smithing',speedBonus:15,bonus:'-15% Blacksmithing time'},
  moonweave_cauldron:{name:'Moonweave Cauldron',icon:'🍲',value:1800,cat:'tool',slot:'tool',skill:'cooking',speedBonus:15,bonus:'-15% Cooking time'},
  moonweave_pick:{name:'Moonweave Pick',icon:'🗝️',value:1800,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:15,bonus:'-15% Pickpocketing time'},
  moonweave_plane:{name:'Moonweave Plane',icon:'📐',value:1800,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:15,bonus:'-15% Woodworking time'},
  moonweave_loupe:{name:'Moonweave Loupe',icon:'🔭',value:1800,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:15,bonus:'-15% Prospecting time'},
  moonweave_shears:{name:'Moonweave Shears',icon:'✂️',value:1800,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:15,bonus:'-15% Jewelcrafting time'},
  // Tier 6 – Sungilt (18% speed)
  sungilt_axe:{name:'Sungilt Axe',icon:'🪓',value:4000,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:18,bonus:'-18% Woodcutting time'},
  sungilt_mattock:{name:'Sungilt Mattock',icon:'⛏️',value:4000,cat:'tool',slot:'tool',skill:'mining',speedBonus:18,bonus:'-18% Mining time'},
  sungilt_rod:{name:'Sungilt Rod',icon:'🎣',value:4000,cat:'tool',slot:'tool',skill:'fishing',speedBonus:18,bonus:'-18% Fishing time'},
  sungilt_hammer:{name:'Sungilt Hammer',icon:'🔨',value:4000,cat:'tool',slot:'tool',skill:'smithing',speedBonus:18,bonus:'-18% Blacksmithing time'},
  sungilt_cauldron:{name:'Sungilt Cauldron',icon:'🍲',value:4000,cat:'tool',slot:'tool',skill:'cooking',speedBonus:18,bonus:'-18% Cooking time'},
  sungilt_pick:{name:'Sungilt Pick',icon:'🗝️',value:4000,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:18,bonus:'-18% Pickpocketing time'},
  sungilt_plane:{name:'Sungilt Plane',icon:'📐',value:4000,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:18,bonus:'-18% Woodworking time'},
  sungilt_loupe:{name:'Sungilt Loupe',icon:'🔭',value:4000,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:18,bonus:'-18% Prospecting time'},
  sungilt_shears:{name:'Sungilt Shears',icon:'✂️',value:4000,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:18,bonus:'-18% Jewelcrafting time'},
  // Tier 7 – Stormcast (21% speed)
  stormcast_axe:{name:'Stormcast Axe',icon:'🪓',value:9000,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:21,bonus:'-21% Woodcutting time'},
  stormcast_mattock:{name:'Stormcast Mattock',icon:'⛏️',value:9000,cat:'tool',slot:'tool',skill:'mining',speedBonus:21,bonus:'-21% Mining time'},
  stormcast_rod:{name:'Stormcast Rod',icon:'🎣',value:9000,cat:'tool',slot:'tool',skill:'fishing',speedBonus:21,bonus:'-21% Fishing time'},
  stormcast_hammer:{name:'Stormcast Hammer',icon:'🔨',value:9000,cat:'tool',slot:'tool',skill:'smithing',speedBonus:21,bonus:'-21% Blacksmithing time'},
  stormcast_cauldron:{name:'Stormcast Cauldron',icon:'🍲',value:9000,cat:'tool',slot:'tool',skill:'cooking',speedBonus:21,bonus:'-21% Cooking time'},
  stormcast_pick:{name:'Stormcast Pick',icon:'🗝️',value:9000,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:21,bonus:'-21% Pickpocketing time'},
  stormcast_plane:{name:'Stormcast Plane',icon:'📐',value:9000,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:21,bonus:'-21% Woodworking time'},
  stormcast_loupe:{name:'Stormcast Loupe',icon:'🔭',value:9000,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:21,bonus:'-21% Prospecting time'},
  stormcast_shears:{name:'Stormcast Shears',icon:'✂️',value:9000,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:21,bonus:'-21% Jewelcrafting time'},
  // Tier 8 – Duskwarden (24% speed)
  duskwarden_axe:{name:'Duskwarden Axe',icon:'🪓',value:20000,cat:'tool',slot:'tool',skill:'woodcutting',speedBonus:24,bonus:'-24% Woodcutting time'},
  duskwarden_mattock:{name:'Duskwarden Mattock',icon:'⛏️',value:20000,cat:'tool',slot:'tool',skill:'mining',speedBonus:24,bonus:'-24% Mining time'},
  duskwarden_rod:{name:'Duskwarden Rod',icon:'🎣',value:20000,cat:'tool',slot:'tool',skill:'fishing',speedBonus:24,bonus:'-24% Fishing time'},
  duskwarden_hammer:{name:'Duskwarden Hammer',icon:'🔨',value:20000,cat:'tool',slot:'tool',skill:'smithing',speedBonus:24,bonus:'-24% Blacksmithing time'},
  duskwarden_cauldron:{name:'Duskwarden Cauldron',icon:'🍲',value:20000,cat:'tool',slot:'tool',skill:'cooking',speedBonus:24,bonus:'-24% Cooking time'},
  duskwarden_pick:{name:'Duskwarden Pick',icon:'🗝️',value:20000,cat:'tool',slot:'tool',skill:'pickpocketing',speedBonus:24,bonus:'-24% Pickpocketing time'},
  duskwarden_plane:{name:'Duskwarden Plane',icon:'📐',value:20000,cat:'tool',slot:'tool',skill:'woodworking',speedBonus:24,bonus:'-24% Woodworking time'},
  duskwarden_loupe:{name:'Duskwarden Loupe',icon:'🔭',value:20000,cat:'tool',slot:'tool',skill:'prospecting',speedBonus:24,bonus:'-24% Prospecting time'},
  duskwarden_shears:{name:'Duskwarden Shears',icon:'✂️',value:20000,cat:'tool',slot:'tool',skill:'jewelcrafting',speedBonus:24,bonus:'-24% Jewelcrafting time'},
  cooked_shrimp:{name:'Grilled Ripplefin',icon:'🍤',value:20,cat:'food',heals:3},
  cooked_trout:{name:'Grilled Stonebelly',icon:'🍣',value:60,cat:'food',heals:7},
  cooked_salmon:{name:'Grilled Glintscale',icon:'🥩',value:120,cat:'food',heals:12},
  cooked_tuna:{name:'Grilled Longwhisk',icon:'🍣',value:180,cat:'food',heals:16},
  cooked_lobster:{name:'Grilled Bluecurrent',icon:'🦞',value:250,cat:'food',heals:20},
  cooked_bass:{name:'Grilled Reefstrider',icon:'🍣',value:350,cat:'food',heals:24},
  cooked_swordfish:{name:'Grilled Mist Koi',icon:'🍖',value:500,cat:'food',heals:28},
  cooked_monkfish:{name:'Grilled Thunderhead',icon:'🍣',value:700,cat:'food',heals:32},
  cooked_shark:{name:'Grilled Crystal Perch',icon:'🍖',value:1000,cat:'food',heals:36},
  cooked_manta:{name:'Grilled Lanternfish',icon:'🍣',value:1400,cat:'food',heals:40},
  cooked_turtle:{name:'Grilled Crownray',icon:'🍲',value:2000,cat:'food',heals:44},
  burnt_shrimp:{name:'Charred Ripplefin',icon:'🟫',value:0,cat:'junk'},
  burnt_trout:{name:'Charred Stonebelly',icon:'🟫',value:0,cat:'junk'},
  burnt_salmon:{name:'Charred Glintscale',icon:'🟫',value:0,cat:'junk'},
  burnt_tuna:{name:'Charred Longwhisk',icon:'🟫',value:0,cat:'junk'},
  burnt_lobster:{name:'Charred Bluecurrent',icon:'🟫',value:0,cat:'junk'},
  burnt_bass:{name:'Charred Reefstrider',icon:'🟫',value:0,cat:'junk'},
  burnt_swordfish:{name:'Charred Mist Koi',icon:'🟫',value:0,cat:'junk'},
  burnt_monkfish:{name:'Charred Thunderhead',icon:'🟫',value:0,cat:'junk'},
  burnt_shark:{name:'Charred Crystal Perch',icon:'🟫',value:0,cat:'junk'},
  burnt_manta:{name:'Charred Lanternfish',icon:'🟫',value:0,cat:'junk'},
  burnt_turtle:{name:'Charred Crownray',icon:'🟫',value:0,cat:'junk'},
  bones:{name:'Bones',icon:'🦴',value:2,cat:'junk'},
  // Trinkets (Unique drops)
  woodcutters_trinket:{name:'Woodcutter\'s Trinket',icon:'🪓',value:5000,cat:'trinket',slot:'trinket',skill:'woodcutting',bonus:'10% XP + 2x logs'},
  miners_trinket:{name:'Miner\'s Trinket',icon:'⛏️',value:5000,cat:'trinket',slot:'trinket',skill:'mining',bonus:'10% XP + 2x ore'},
  fishermans_trinket:{name:'Fisherman\'s Trinket',icon:'🎣',value:5000,cat:'trinket',slot:'trinket',skill:'fishing',bonus:'10% XP + 2x fish'},
  smiths_trinket:{name:'Blacksmith\'s Trinket',icon:'🔨',value:5000,cat:'trinket',slot:'trinket',skill:'smithing',bonus:'10% XP + 25% save materials'},
  chefs_trinket:{name:'Chef\'s Trinket',icon:'🍳',value:5000,cat:'trinket',slot:'trinket',skill:'cooking',bonus:'10% XP + 25% save fish'},
  thiefs_trinket:{name:'Thief\'s Trinket',icon:'🥷',value:5000,cat:'trinket',slot:'trinket',skill:'pickpocketing',bonus:'10% XP + 2x gold'},
  brawlers_trinket:{name:'Brawler\'s Trinket',icon:'⚔️',value:5000,cat:'trinket',slot:'trinket',skill:'combat',bonus:'10% all combat stats + 10% loot'},
  woodworkers_trinket:{name:'Woodworker\'s Trinket',icon:'🪚',value:5000,cat:'trinket',slot:'trinket',skill:'woodworking',bonus:'10% XP + 25% save materials'},
  prospectors_trinket:{name:'Prospector\'s Trinket',icon:'🔍',value:5000,cat:'trinket',slot:'trinket',skill:'prospecting',bonus:'10% XP + +15% gem chance'},
  jewelers_trinket:{name:'Jeweler\'s Trinket',icon:'💍',value:5000,cat:'trinket',slot:'trinket',skill:'jewelcrafting',bonus:'10% XP + 25% save materials'},
  // Equipment
  // Equipment - Weapons
  bronze_sword:{name:'Roughplate Blade',icon:'🗡️',value:200,cat:'weapon',slot:'weapon',atk:4,def:0,reqAtk:1,reqStr:1},
  iron_sword:{name:'Emberguard Blade',icon:'⚔️',value:500,cat:'weapon',slot:'weapon',atk:8,def:0,reqAtk:15,reqStr:15},
  silver_sword:{name:'Brightmail Blade',icon:'🗡️',value:800,cat:'weapon',slot:'weapon',atk:12,def:0,reqAtk:20,reqStr:20},
  steel_sword:{name:'Grimforge Blade',icon:'🔱',value:1200,cat:'weapon',slot:'weapon',atk:14,def:0,reqAtk:30,reqStr:30},
  mithril_sword:{name:'Moonweave Blade',icon:'⚔️',value:2000,cat:'weapon',slot:'weapon',atk:20,def:0,reqAtk:40,reqStr:40},
  adamant_sword:{name:'Sungilt Blade',icon:'🗡️',value:4000,cat:'weapon',slot:'weapon',atk:26,def:0,reqAtk:55,reqStr:55},
  rune_sword:{name:'Stormcast Blade',icon:'🔱',value:8000,cat:'weapon',slot:'weapon',atk:34,def:0,reqAtk:70,reqStr:70},
  dragon_sword:{name:'Duskwarden Blade',icon:'⚔️',value:16000,cat:'weapon',slot:'weapon',atk:44,def:0,reqAtk:85,reqStr:85},
  // Equipment - Shields
  bronze_shield:{name:'Roughplate Ward',icon:'🛡️',value:160,cat:'armor',slot:'shield',atk:0,def:3,reqDef:1},
  iron_shield:{name:'Emberguard Ward',icon:'🛡️',value:400,cat:'armor',slot:'shield',atk:0,def:7,reqDef:15},
  silver_shield:{name:'Brightmail Ward',icon:'🛡️',value:650,cat:'armor',slot:'shield',atk:0,def:10,reqDef:20},
  steel_shield:{name:'Grimforge Ward',icon:'🛡️',value:900,cat:'armor',slot:'shield',atk:0,def:12,reqDef:30},
  mithril_shield:{name:'Moonweave Ward',icon:'🛡️',value:1600,cat:'armor',slot:'shield',atk:0,def:18,reqDef:40},
  adamant_shield:{name:'Sungilt Ward',icon:'🛡️',value:3200,cat:'armor',slot:'shield',atk:0,def:24,reqDef:55},
  rune_shield:{name:'Stormcast Ward',icon:'🛡️',value:6400,cat:'armor',slot:'shield',atk:0,def:32,reqDef:70},
  dragon_shield:{name:'Duskwarden Ward',icon:'🛡️',value:12800,cat:'armor',slot:'shield',atk:0,def:42,reqDef:85},
  // Equipment - Body
  bronze_body:{name:'Roughplate Cuirass',icon:'🦺',value:140,cat:'armor',slot:'body',atk:0,def:5,reqDef:1},
  leather_body:{name:'Hide Jerkin',icon:'🦺',value:120,cat:'armor',slot:'body',atk:0,def:4,reqDef:1},
  iron_body:{name:'Emberguard Cuirass',icon:'🧥',value:600,cat:'armor',slot:'body',atk:0,def:10,reqDef:15},
  silver_body:{name:'Brightmail Cuirass',icon:'🧥',value:1000,cat:'armor',slot:'body',atk:0,def:14,reqDef:20},
  steel_body:{name:'Grimforge Cuirass',icon:'🧥',value:1400,cat:'armor',slot:'body',atk:0,def:16,reqDef:30},
  mithril_body:{name:'Moonweave Cuirass',icon:'🧥',value:2400,cat:'armor',slot:'body',atk:0,def:24,reqDef:40},
  adamant_body:{name:'Sungilt Cuirass',icon:'🧥',value:4800,cat:'armor',slot:'body',atk:0,def:32,reqDef:55},
  rune_body:{name:'Stormcast Cuirass',icon:'🧥',value:9600,cat:'armor',slot:'body',atk:0,def:42,reqDef:70},
  dragon_body:{name:'Duskwarden Cuirass',icon:'🧥',value:19200,cat:'armor',slot:'body',atk:0,def:54,reqDef:85},
  // Equipment - Helmets
  bronze_helmet:{name:'Roughplate Helm',icon:'⛑️',value:100,cat:'armor',slot:'helmet',atk:0,def:2,reqDef:1},
  iron_helmet:{name:'Emberguard Helm',icon:'⛑️',value:350,cat:'armor',slot:'helmet',atk:0,def:6,reqDef:15},
  silver_helmet:{name:'Brightmail Helm',icon:'⛑️',value:550,cat:'armor',slot:'helmet',atk:0,def:9,reqDef:20},
  steel_helmet:{name:'Grimforge Helm',icon:'⛑️',value:800,cat:'armor',slot:'helmet',atk:0,def:10,reqDef:30},
  mithril_helmet:{name:'Moonweave Helm',icon:'⛑️',value:1400,cat:'armor',slot:'helmet',atk:0,def:16,reqDef:40},
  adamant_helmet:{name:'Sungilt Helm',icon:'⛑️',value:2800,cat:'armor',slot:'helmet',atk:0,def:22,reqDef:55},
  rune_helmet:{name:'Stormcast Helm',icon:'⛑️',value:5600,cat:'armor',slot:'helmet',atk:0,def:30,reqDef:70},
  dragon_helmet:{name:'Duskwarden Helm',icon:'⛑️',value:11200,cat:'armor',slot:'helmet',atk:0,def:40,reqDef:85},
  // Equipment - Legs
  bronze_legs:{name:'Roughplate Greaves',icon:'👖',value:100,cat:'armor',slot:'legs',atk:0,def:3,reqDef:1},
  iron_legs:{name:'Emberguard Greaves',icon:'👖',value:350,cat:'armor',slot:'legs',atk:0,def:7,reqDef:15},
  silver_legs:{name:'Brightmail Greaves',icon:'👖',value:550,cat:'armor',slot:'legs',atk:0,def:10,reqDef:20},
  steel_legs:{name:'Grimforge Greaves',icon:'👖',value:800,cat:'armor',slot:'legs',atk:0,def:11,reqDef:30},
  mithril_legs:{name:'Moonweave Greaves',icon:'👖',value:1400,cat:'armor',slot:'legs',atk:0,def:18,reqDef:40},
  adamant_legs:{name:'Sungilt Greaves',icon:'👖',value:2800,cat:'armor',slot:'legs',atk:0,def:24,reqDef:55},
  rune_legs:{name:'Stormcast Greaves',icon:'👖',value:5600,cat:'armor',slot:'legs',atk:0,def:32,reqDef:70},
  dragon_legs:{name:'Duskwarden Greaves',icon:'👖',value:11200,cat:'armor',slot:'legs',atk:0,def:44,reqDef:85},
  // Equipment - Gloves
  bronze_gloves:{name:'Roughplate Gauntlets',icon:'🧤',value:100,cat:'armor',slot:'gloves',atk:0,def:2,reqDef:1},
  iron_gloves:{name:'Emberguard Gauntlets',icon:'🧤',value:350,cat:'armor',slot:'gloves',atk:0,def:6,reqDef:15},
  silver_gloves:{name:'Brightmail Gauntlets',icon:'🧤',value:550,cat:'armor',slot:'gloves',atk:0,def:9,reqDef:20},
  steel_gloves:{name:'Grimforge Gauntlets',icon:'🧤',value:800,cat:'armor',slot:'gloves',atk:0,def:10,reqDef:30},
  mithril_gloves:{name:'Moonweave Gauntlets',icon:'🧤',value:1400,cat:'armor',slot:'gloves',atk:0,def:16,reqDef:40},
  adamant_gloves:{name:'Sungilt Gauntlets',icon:'🧤',value:2800,cat:'armor',slot:'gloves',atk:0,def:22,reqDef:55},
  rune_gloves:{name:'Stormcast Gauntlets',icon:'🧤',value:5600,cat:'armor',slot:'gloves',atk:0,def:30,reqDef:70},
  dragon_gloves:{name:'Duskwarden Gauntlets',icon:'🧤',value:11200,cat:'armor',slot:'gloves',atk:0,def:40,reqDef:85},
  // Equipment - Boots
  bronze_boots:{name:'Roughplate Sabatons',icon:'🥾',value:100,cat:'armor',slot:'boots',atk:0,def:3,reqDef:1},
  iron_boots:{name:'Emberguard Sabatons',icon:'🥾',value:350,cat:'armor',slot:'boots',atk:0,def:7,reqDef:15},
  silver_boots:{name:'Brightmail Sabatons',icon:'🥾',value:550,cat:'armor',slot:'boots',atk:0,def:10,reqDef:20},
  steel_boots:{name:'Grimforge Sabatons',icon:'🥾',value:800,cat:'armor',slot:'boots',atk:0,def:11,reqDef:30},
  mithril_boots:{name:'Moonweave Sabatons',icon:'🥾',value:1400,cat:'armor',slot:'boots',atk:0,def:18,reqDef:40},
  adamant_boots:{name:'Sungilt Sabatons',icon:'🥾',value:2800,cat:'armor',slot:'boots',atk:0,def:24,reqDef:55},
  rune_boots:{name:'Stormcast Sabatons',icon:'🥾',value:5600,cat:'armor',slot:'boots',atk:0,def:32,reqDef:70},
  dragon_boots:{name:'Duskwarden Sabatons',icon:'🥾',value:11200,cat:'armor',slot:'boots',atk:0,def:44,reqDef:85},
};

// SKILL ACTIONS
const ACTIONS = {
  woodcutting:[
    {id:'normal_tree',name:'Kindlewood Tree',icon:'🌳',levelReq:1,xp:25,masteryXp:16,ticks:5,produces:'normal_log',qty:1},
    {id:'oak_tree',name:'Brackenbark Tree',icon:'🌲',levelReq:15,xp:37,masteryXp:24,ticks:7,produces:'oak_log',qty:1},
    {id:'willow_tree',name:'Ironroot Tree',icon:'🌿',levelReq:30,xp:67,masteryXp:40,ticks:10,produces:'willow_log',qty:1},
    {id:'maple_tree',name:'Duskhollow Tree',icon:'🍁',levelReq:45,xp:100,masteryXp:64,ticks:13,produces:'maple_log',qty:1},
    {id:'teak_tree',name:'Ambergrain Tree',icon:'🪵',levelReq:55,xp:135,masteryXp:84,ticks:16,produces:'teak_log',qty:1},
    {id:'yew_tree',name:'Frostelm Tree',icon:'🌲',levelReq:65,xp:180,masteryXp:108,ticks:19,produces:'yew_log',qty:1},
    {id:'magic_tree',name:'Stormheart',icon:'✨',levelReq:75,xp:240,masteryXp:136,ticks:22,produces:'magic_log',qty:1},
    {id:'redwood_tree',name:'Mythoak',icon:'🌳',levelReq:85,xp:320,masteryXp:170,ticks:26,produces:'redwood_log',qty:1},
  ],
  mining:[
    {id:'copper_rock',name:'Graveliron Deposit',icon:'🟤',levelReq:1,xp:17,masteryXp:12,ticks:4,produces:'copper_ore',qty:1},
    {id:'tin_rock',name:'Graveliron Flux Vein',icon:'🔵',levelReq:1,xp:17,masteryXp:12,ticks:4,produces:'tin_ore',qty:1},
    {id:'iron_rock',name:'Redvein Deposit',icon:'⬛',levelReq:15,xp:35,masteryXp:24,ticks:7,produces:'iron_ore',qty:1},
    {id:'silver_rock',name:'Tinflare Vein',icon:'⚪',levelReq:20,xp:40,masteryXp:28,ticks:8,produces:'silver_ore',qty:1},
    {id:'coal_rock',name:'Emberstone Seam',icon:'🖤',levelReq:30,xp:50,masteryXp:32,ticks:12,produces:'coal',qty:1},
    {id:'mithril_rock',name:'Pale Silver Node',icon:'💠',levelReq:40,xp:80,masteryXp:48,ticks:14,produces:'mithril_ore',qty:1},
    {id:'adamant_rock',name:'Goldember Vein',icon:'🟢',levelReq:55,xp:120,masteryXp:72,ticks:18,produces:'adamant_ore',qty:1},
    {id:'runite_rock',name:'Cobalite Deposit',icon:'🔷',levelReq:70,xp:180,masteryXp:100,ticks:22,produces:'runite_ore',qty:1},
    {id:'dragon_rock',name:'Nightnickel Outcrop',icon:'🔶',levelReq:85,xp:280,masteryXp:140,ticks:28,produces:'dragon_ore',qty:1},
  ],
  fishing:[
    {id:'shrimp_spot',name:'Ripplefin School',icon:'🦐',levelReq:1,xp:10,masteryXp:8,ticks:4,produces:'raw_shrimp',qty:1},
    {id:'trout_spot',name:'Stonebelly Pool',icon:'🐟',levelReq:15,xp:40,masteryXp:28,ticks:6,produces:'raw_trout',qty:1},
    {id:'salmon_spot',name:'Glintscale Run',icon:'🐠',levelReq:25,xp:60,masteryXp:40,ticks:8,produces:'raw_salmon',qty:1},
    {id:'tuna_spot',name:'Longwhisk Waters',icon:'🐟',levelReq:35,xp:85,masteryXp:56,ticks:10,produces:'raw_tuna',qty:1},
    {id:'lobster_spot',name:'Bluecurrent Shallows',icon:'🦞',levelReq:40,xp:110,masteryXp:72,ticks:12,produces:'raw_lobster',qty:1},
    {id:'bass_spot',name:'Reefstrider Grounds',icon:'🐟',levelReq:50,xp:140,masteryXp:88,ticks:14,produces:'raw_bass',qty:1},
    {id:'swordfish_spot',name:'Mist Koi Depths',icon:'🗡️',levelReq:55,xp:170,masteryXp:104,ticks:16,produces:'raw_swordfish',qty:1},
    {id:'monkfish_spot',name:'Thunderhead Basin',icon:'🐟',levelReq:65,xp:210,masteryXp:124,ticks:18,produces:'raw_monkfish',qty:1},
    {id:'shark_spot',name:'Crystal Perch Trench',icon:'🦈',levelReq:75,xp:260,masteryXp:148,ticks:20,produces:'raw_shark',qty:1},
    {id:'manta_spot',name:'Abyss Pool',icon:'🐟',levelReq:85,xp:320,masteryXp:176,ticks:23,produces:'raw_manta',qty:1},
    {id:'turtle_spot',name:'Crownray Sanctuary',icon:'🐢',levelReq:95,xp:400,masteryXp:210,ticks:26,produces:'raw_turtle',qty:1},
  ],
  smithing:[
    {id:'bronze_bar',name:'Graveliron Ingot',icon:'🟫',levelReq:1,xp:12,masteryXp:10,ticks:4,consumes:{copper_ore:1,tin_ore:1},produces:'bronze_bar',qty:1},
    {id:'iron_bar',name:'Emberguard Ingot',icon:'🔩',levelReq:15,xp:25,masteryXp:20,ticks:6,consumes:{iron_ore:2},produces:'iron_bar',qty:1},
    {id:'silver_bar',name:'Brightmail Ingot',icon:'⚙️',levelReq:20,xp:30,masteryXp:24,ticks:7,consumes:{silver_ore:1},produces:'silver_bar',qty:1},
    {id:'steel_bar',name:'Grimforge Ingot',icon:'⚙️',levelReq:30,xp:37,masteryXp:28,ticks:9,consumes:{iron_ore:1,coal:2},produces:'steel_bar',qty:1},
    {id:'mithril_bar',name:'Moonweave Ingot',icon:'💎',levelReq:40,xp:70,masteryXp:48,ticks:11,consumes:{mithril_ore:1,coal:2},produces:'mithril_bar',qty:1},
    {id:'adamant_bar',name:'Sungilt Ingot',icon:'🔰',levelReq:55,xp:110,masteryXp:72,ticks:13,consumes:{adamant_ore:1,coal:3},produces:'adamant_bar',qty:1},
    {id:'rune_bar',name:'Stormcast Ingot',icon:'🔷',levelReq:70,xp:170,masteryXp:100,ticks:15,consumes:{runite_ore:1,coal:4},produces:'rune_bar',qty:1},
    {id:'dragon_bar',name:'Duskwarden Ingot',icon:'🔶',levelReq:85,xp:260,masteryXp:140,ticks:18,consumes:{dragon_ore:1,coal:6},produces:'dragon_bar',qty:1},
  ],
  smithingCraft:[
    // Roughplate Set (Lv 1-8)
    {id:'craft_bronze_sword',name:'Roughplate Blade',icon:'🗡️',levelReq:1,xp:25,ticks:3,consumes:{bronze_bar:2},produces:'bronze_sword',qty:1},
    {id:'craft_bronze_shield',name:'Roughplate Ward',icon:'🛡️',levelReq:3,xp:20,ticks:3,consumes:{bronze_bar:2},produces:'bronze_shield',qty:1},
    {id:'craft_bronze_helmet',name:'Roughplate Helm',icon:'⛑️',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:1},produces:'bronze_helmet',qty:1},
    {id:'craft_bronze_body',name:'Roughplate Cuirass',icon:'🦺',levelReq:8,xp:30,ticks:4,consumes:{bronze_bar:3},produces:'bronze_body',qty:1},
    {id:'craft_bronze_legs',name:'Roughplate Greaves',icon:'👖',levelReq:5,xp:18,ticks:3,consumes:{bronze_bar:2},produces:'bronze_legs',qty:1},
    {id:'craft_bronze_gloves',name:'Roughplate Gauntlets',icon:'🧤',levelReq:2,xp:18,ticks:3,consumes:{bronze_bar:1},produces:'bronze_gloves',qty:1},
    {id:'craft_bronze_boots',name:'Roughplate Sabatons',icon:'🥾',levelReq:4,xp:18,ticks:3,consumes:{bronze_bar:2},produces:'bronze_boots',qty:1},
    // Emberguard Set (Lv 15-28)
    {id:'craft_iron_sword',name:'Emberguard Blade',icon:'⚔️',levelReq:15,xp:50,ticks:5,consumes:{iron_bar:2},produces:'iron_sword',qty:1},
    {id:'craft_iron_shield',name:'Emberguard Ward',icon:'🛡️',levelReq:17,xp:40,ticks:5,consumes:{iron_bar:2},produces:'iron_shield',qty:1},
    {id:'craft_iron_helmet',name:'Emberguard Helm',icon:'⛑️',levelReq:19,xp:35,ticks:5,consumes:{iron_bar:2},produces:'iron_helmet',qty:1},
    {id:'craft_iron_body',name:'Emberguard Cuirass',icon:'🧥',levelReq:23,xp:60,ticks:7,consumes:{iron_bar:4},produces:'iron_body',qty:1},
    {id:'craft_iron_legs',name:'Emberguard Greaves',icon:'👖',levelReq:19,xp:55,ticks:7,consumes:{iron_bar:3},produces:'iron_legs',qty:1},
    {id:'craft_iron_gloves',name:'Emberguard Gauntlets',icon:'🧤',levelReq:16,xp:35,ticks:5,consumes:{iron_bar:2},produces:'iron_gloves',qty:1},
    {id:'craft_iron_boots',name:'Emberguard Sabatons',icon:'🥾',levelReq:18,xp:55,ticks:7,consumes:{iron_bar:3},produces:'iron_boots',qty:1},
    // Brightmail Set (Lv 20-28)
    {id:'craft_silver_sword',name:'Brightmail Blade',icon:'🗡️',levelReq:20,xp:60,ticks:5,consumes:{silver_bar:2},produces:'silver_sword',qty:1},
    {id:'craft_silver_shield',name:'Brightmail Ward',icon:'🛡️',levelReq:22,xp:50,ticks:5,consumes:{silver_bar:2},produces:'silver_shield',qty:1},
    {id:'craft_silver_helmet',name:'Brightmail Helm',icon:'⛑️',levelReq:24,xp:45,ticks:5,consumes:{silver_bar:2},produces:'silver_helmet',qty:1},
    {id:'craft_silver_body',name:'Brightmail Cuirass',icon:'🧥',levelReq:28,xp:70,ticks:7,consumes:{silver_bar:4},produces:'silver_body',qty:1},
    {id:'craft_silver_legs',name:'Brightmail Greaves',icon:'👖',levelReq:24,xp:65,ticks:7,consumes:{silver_bar:3},produces:'silver_legs',qty:1},
    {id:'craft_silver_gloves',name:'Brightmail Gauntlets',icon:'🧤',levelReq:21,xp:45,ticks:5,consumes:{silver_bar:2},produces:'silver_gloves',qty:1},
    {id:'craft_silver_boots',name:'Brightmail Sabatons',icon:'🥾',levelReq:23,xp:65,ticks:7,consumes:{silver_bar:3},produces:'silver_boots',qty:1},
    // Grimforge Set (Lv 30-38)
    {id:'craft_steel_sword',name:'Grimforge Blade',icon:'🔱',levelReq:30,xp:80,ticks:7,consumes:{steel_bar:2},produces:'steel_sword',qty:1},
    {id:'craft_steel_shield',name:'Grimforge Ward',icon:'🛡️',levelReq:32,xp:70,ticks:7,consumes:{steel_bar:2},produces:'steel_shield',qty:1},
    {id:'craft_steel_helmet',name:'Grimforge Helm',icon:'⛑️',levelReq:34,xp:65,ticks:7,consumes:{steel_bar:2},produces:'steel_helmet',qty:1},
    {id:'craft_steel_body',name:'Grimforge Cuirass',icon:'🧥',levelReq:38,xp:100,ticks:9,consumes:{steel_bar:4},produces:'steel_body',qty:1},
    {id:'craft_steel_legs',name:'Grimforge Greaves',icon:'👖',levelReq:34,xp:85,ticks:8,consumes:{steel_bar:3},produces:'steel_legs',qty:1},
    {id:'craft_steel_gloves',name:'Grimforge Gauntlets',icon:'🧤',levelReq:31,xp:65,ticks:7,consumes:{steel_bar:2},produces:'steel_gloves',qty:1},
    {id:'craft_steel_boots',name:'Grimforge Sabatons',icon:'🥾',levelReq:33,xp:85,ticks:8,consumes:{steel_bar:3},produces:'steel_boots',qty:1},
    // Moonweave Set (Lv 40-48)
    {id:'craft_mithril_sword',name:'Moonweave Blade',icon:'⚔️',levelReq:40,xp:120,ticks:8,consumes:{mithril_bar:2},produces:'mithril_sword',qty:1},
    {id:'craft_mithril_shield',name:'Moonweave Ward',icon:'🛡️',levelReq:42,xp:100,ticks:8,consumes:{mithril_bar:2},produces:'mithril_shield',qty:1},
    {id:'craft_mithril_helmet',name:'Moonweave Helm',icon:'⛑️',levelReq:44,xp:90,ticks:8,consumes:{mithril_bar:2},produces:'mithril_helmet',qty:1},
    {id:'craft_mithril_body',name:'Moonweave Cuirass',icon:'🧥',levelReq:48,xp:150,ticks:10,consumes:{mithril_bar:4},produces:'mithril_body',qty:1},
    {id:'craft_mithril_legs',name:'Moonweave Greaves',icon:'👖',levelReq:44,xp:130,ticks:9,consumes:{mithril_bar:3},produces:'mithril_legs',qty:1},
    {id:'craft_mithril_gloves',name:'Moonweave Gauntlets',icon:'🧤',levelReq:41,xp:90,ticks:8,consumes:{mithril_bar:2},produces:'mithril_gloves',qty:1},
    {id:'craft_mithril_boots',name:'Moonweave Sabatons',icon:'🥾',levelReq:43,xp:130,ticks:9,consumes:{mithril_bar:3},produces:'mithril_boots',qty:1},
    // Sungilt Set (Lv 55-63)
    {id:'craft_adamant_sword',name:'Sungilt Blade',icon:'🗡️',levelReq:55,xp:180,ticks:9,consumes:{adamant_bar:2},produces:'adamant_sword',qty:1},
    {id:'craft_adamant_shield',name:'Sungilt Ward',icon:'🛡️',levelReq:57,xp:150,ticks:9,consumes:{adamant_bar:2},produces:'adamant_shield',qty:1},
    {id:'craft_adamant_helmet',name:'Sungilt Helm',icon:'⛑️',levelReq:59,xp:140,ticks:9,consumes:{adamant_bar:2},produces:'adamant_helmet',qty:1},
    {id:'craft_adamant_body',name:'Sungilt Cuirass',icon:'🧥',levelReq:63,xp:220,ticks:11,consumes:{adamant_bar:4},produces:'adamant_body',qty:1},
    {id:'craft_adamant_legs',name:'Sungilt Greaves',icon:'👖',levelReq:59,xp:190,ticks:10,consumes:{adamant_bar:3},produces:'adamant_legs',qty:1},
    {id:'craft_adamant_gloves',name:'Sungilt Gauntlets',icon:'🧤',levelReq:56,xp:140,ticks:9,consumes:{adamant_bar:2},produces:'adamant_gloves',qty:1},
    {id:'craft_adamant_boots',name:'Sungilt Sabatons',icon:'🥾',levelReq:58,xp:190,ticks:10,consumes:{adamant_bar:3},produces:'adamant_boots',qty:1},
    // Stormcast Set (Lv 70-78)
    {id:'craft_rune_sword',name:'Stormcast Blade',icon:'🔱',levelReq:70,xp:260,ticks:10,consumes:{rune_bar:2},produces:'rune_sword',qty:1},
    {id:'craft_rune_shield',name:'Stormcast Ward',icon:'🛡️',levelReq:72,xp:220,ticks:10,consumes:{rune_bar:2},produces:'rune_shield',qty:1},
    {id:'craft_rune_helmet',name:'Stormcast Helm',icon:'⛑️',levelReq:74,xp:200,ticks:10,consumes:{rune_bar:2},produces:'rune_helmet',qty:1},
    {id:'craft_rune_body',name:'Stormcast Cuirass',icon:'🧥',levelReq:78,xp:320,ticks:12,consumes:{rune_bar:4},produces:'rune_body',qty:1},
    {id:'craft_rune_legs',name:'Stormcast Greaves',icon:'👖',levelReq:74,xp:280,ticks:11,consumes:{rune_bar:3},produces:'rune_legs',qty:1},
    {id:'craft_rune_gloves',name:'Stormcast Gauntlets',icon:'🧤',levelReq:71,xp:200,ticks:10,consumes:{rune_bar:2},produces:'rune_gloves',qty:1},
    {id:'craft_rune_boots',name:'Stormcast Sabatons',icon:'🥾',levelReq:73,xp:280,ticks:11,consumes:{rune_bar:3},produces:'rune_boots',qty:1},
    // Duskwarden Set (Lv 85-93)
    {id:'craft_dragon_sword',name:'Duskwarden Blade',icon:'⚔️',levelReq:85,xp:380,ticks:12,consumes:{dragon_bar:2},produces:'dragon_sword',qty:1},
    {id:'craft_dragon_shield',name:'Duskwarden Ward',icon:'🛡️',levelReq:87,xp:320,ticks:12,consumes:{dragon_bar:2},produces:'dragon_shield',qty:1},
    {id:'craft_dragon_helmet',name:'Duskwarden Helm',icon:'⛑️',levelReq:89,xp:300,ticks:12,consumes:{dragon_bar:2},produces:'dragon_helmet',qty:1},
    {id:'craft_dragon_body',name:'Duskwarden Cuirass',icon:'🧥',levelReq:93,xp:480,ticks:14,consumes:{dragon_bar:4},produces:'dragon_body',qty:1},
    {id:'craft_dragon_legs',name:'Duskwarden Greaves',icon:'👖',levelReq:89,xp:420,ticks:13,consumes:{dragon_bar:3},produces:'dragon_legs',qty:1},
    {id:'craft_dragon_gloves',name:'Duskwarden Gauntlets',icon:'🧤',levelReq:86,xp:300,ticks:12,consumes:{dragon_bar:2},produces:'dragon_gloves',qty:1},
    {id:'craft_dragon_boots',name:'Duskwarden Sabatons',icon:'🥾',levelReq:88,xp:420,ticks:13,consumes:{dragon_bar:3},produces:'dragon_boots',qty:1},
  ],
  cooking:[
    {id:'cook_shrimp',name:'Ripplefin',icon:'🍤',levelReq:1,xp:30,masteryXp:20,ticks:4,consumes:{raw_shrimp:1},produces:'cooked_shrimp',burnChance:0.35,burnItem:'burnt_shrimp'},
    {id:'cook_trout',name:'Stonebelly Carp',icon:'🍣',levelReq:15,xp:70,masteryXp:44,ticks:5,consumes:{raw_trout:1},produces:'cooked_trout',burnChance:0.35,burnItem:'burnt_trout'},
    {id:'cook_salmon',name:'Glintscale',icon:'🥩',levelReq:25,xp:90,masteryXp:56,ticks:6,consumes:{raw_salmon:1},produces:'cooked_salmon',burnChance:0.35,burnItem:'burnt_salmon'},
    {id:'cook_tuna',name:'Longwhisk Pike',icon:'🍣',levelReq:35,xp:120,masteryXp:72,ticks:7,consumes:{raw_tuna:1},produces:'cooked_tuna',burnChance:0.32,burnItem:'burnt_tuna'},
    {id:'cook_lobster',name:'Bluecurrent Salmon',icon:'🦞',levelReq:40,xp:150,masteryXp:88,ticks:8,consumes:{raw_lobster:1},produces:'cooked_lobster',burnChance:0.30,burnItem:'burnt_lobster'},
    {id:'cook_bass',name:'Reefstrider',icon:'🍣',levelReq:50,xp:190,masteryXp:108,ticks:9,consumes:{raw_bass:1},produces:'cooked_bass',burnChance:0.28,burnItem:'burnt_bass'},
    {id:'cook_swordfish',name:'Mist Koi',icon:'🍖',levelReq:55,xp:230,masteryXp:128,ticks:10,consumes:{raw_swordfish:1},produces:'cooked_swordfish',burnChance:0.25,burnItem:'burnt_swordfish'},
    {id:'cook_monkfish',name:'Thunderhead Catfish',icon:'🍣',levelReq:65,xp:280,masteryXp:152,ticks:11,consumes:{raw_monkfish:1},produces:'cooked_monkfish',burnChance:0.22,burnItem:'burnt_monkfish'},
    {id:'cook_shark',name:'Crystal Perch',icon:'🍖',levelReq:75,xp:340,masteryXp:180,ticks:12,consumes:{raw_shark:1},produces:'cooked_shark',burnChance:0.20,burnItem:'burnt_shark'},
    {id:'cook_manta',name:'Abyss Lanternfish',icon:'🍣',levelReq:85,xp:420,masteryXp:212,ticks:13,consumes:{raw_manta:1},produces:'cooked_manta',burnChance:0.18,burnItem:'burnt_manta'},
    {id:'cook_turtle',name:'Crownray',icon:'🍲',levelReq:95,xp:520,masteryXp:250,ticks:14,consumes:{raw_turtle:1},produces:'cooked_turtle',burnChance:0.15,burnItem:'burnt_turtle'},
  ],
  woodworking:[
    // Tier 1 – Graveliron (2x bronze_bar + 5x normal_log, Lv 1)
    {id:'craft_graveliron_axe',      name:'Graveliron Axe',      icon:'🪓',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_axe',      qty:1},
    {id:'craft_graveliron_mattock',  name:'Graveliron Mattock',  icon:'⛏️',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_mattock',  qty:1},
    {id:'craft_graveliron_rod',      name:'Graveliron Rod',      icon:'🎣',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_rod',      qty:1},
    {id:'craft_graveliron_hammer',   name:'Graveliron Hammer',   icon:'🔨',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_hammer',   qty:1},
    {id:'craft_graveliron_cauldron', name:'Graveliron Cauldron', icon:'🍲',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_cauldron', qty:1},
    {id:'craft_graveliron_pick',     name:'Graveliron Pick',     icon:'🗝️',levelReq:1, xp:50, masteryXp:30, ticks:4, consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_pick',     qty:1},
    {id:'craft_graveliron_plane',               name:'Graveliron Plane',  icon:'📐',levelReq:1,xp:50,masteryXp:30,ticks:4,consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_plane',     qty:1},
    {id:'craft_graveliron_loupe',               name:'Graveliron Loupe',  icon:'🔭',levelReq:1,xp:50,masteryXp:30,ticks:4,consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_loupe',     qty:1},
    {id:'craft_graveliron_shears',              name:'Graveliron Shears', icon:'✂️',levelReq:1,xp:50,masteryXp:30,ticks:4,consumes:{bronze_bar:2,normal_log:5},   produces:'graveliron_shears',    qty:1},
    // Tier 2 – Emberguard (2x iron_bar + 5x oak_log, Lv 15)
    {id:'craft_emberguard_axe',      name:'Emberguard Axe',      icon:'🪓',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_axe',      qty:1},
    {id:'craft_emberguard_mattock',  name:'Emberguard Mattock',  icon:'⛏️',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_mattock',  qty:1},
    {id:'craft_emberguard_rod',      name:'Emberguard Rod',      icon:'🎣',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_rod',      qty:1},
    {id:'craft_emberguard_hammer',   name:'Emberguard Hammer',   icon:'🔨',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_hammer',   qty:1},
    {id:'craft_emberguard_cauldron', name:'Emberguard Cauldron', icon:'🍲',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_cauldron', qty:1},
    {id:'craft_emberguard_pick',     name:'Emberguard Pick',     icon:'🗝️',levelReq:15,xp:90, masteryXp:55, ticks:5, consumes:{iron_bar:2,oak_log:5},        produces:'emberguard_pick',     qty:1},
    {id:'craft_emberguard_plane',               name:'Emberguard Plane',  icon:'📐',levelReq:15,xp:90,masteryXp:55,ticks:5,consumes:{iron_bar:2,oak_log:5},   produces:'emberguard_plane',     qty:1},
    {id:'craft_emberguard_loupe',               name:'Emberguard Loupe',  icon:'🔭',levelReq:15,xp:90,masteryXp:55,ticks:5,consumes:{iron_bar:2,oak_log:5},   produces:'emberguard_loupe',     qty:1},
    {id:'craft_emberguard_shears',              name:'Emberguard Shears', icon:'✂️',levelReq:15,xp:90,masteryXp:55,ticks:5,consumes:{iron_bar:2,oak_log:5},   produces:'emberguard_shears',    qty:1},
    // Tier 3 – Brightmail (2x silver_bar + 5x willow_log, Lv 25)
    {id:'craft_brightmail_axe',      name:'Brightmail Axe',      icon:'🪓',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_axe',      qty:1},
    {id:'craft_brightmail_mattock',  name:'Brightmail Mattock',  icon:'⛏️',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_mattock',  qty:1},
    {id:'craft_brightmail_rod',      name:'Brightmail Rod',      icon:'🎣',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_rod',      qty:1},
    {id:'craft_brightmail_hammer',   name:'Brightmail Hammer',   icon:'🔨',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_hammer',   qty:1},
    {id:'craft_brightmail_cauldron', name:'Brightmail Cauldron', icon:'🍲',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_cauldron', qty:1},
    {id:'craft_brightmail_pick',     name:'Brightmail Pick',     icon:'🗝️',levelReq:25,xp:120,masteryXp:72, ticks:6, consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_pick',     qty:1},
    {id:'craft_brightmail_plane',               name:'Brightmail Plane',  icon:'📐',levelReq:25,xp:120,masteryXp:72,ticks:6,consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_plane',     qty:1},
    {id:'craft_brightmail_loupe',               name:'Brightmail Loupe',  icon:'🔭',levelReq:25,xp:120,masteryXp:72,ticks:6,consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_loupe',     qty:1},
    {id:'craft_brightmail_shears',              name:'Brightmail Shears', icon:'✂️',levelReq:25,xp:120,masteryXp:72,ticks:6,consumes:{silver_bar:2,willow_log:5},   produces:'brightmail_shears',    qty:1},
    // Tier 4 – Grimforge (3x steel_bar + 8x maple_log, Lv 35)
    {id:'craft_grimforge_axe',       name:'Grimforge Axe',       icon:'🪓',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_axe',       qty:1},
    {id:'craft_grimforge_mattock',   name:'Grimforge Mattock',   icon:'⛏️',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_mattock',   qty:1},
    {id:'craft_grimforge_rod',       name:'Grimforge Rod',       icon:'🎣',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_rod',       qty:1},
    {id:'craft_grimforge_hammer',    name:'Grimforge Hammer',    icon:'🔨',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_hammer',    qty:1},
    {id:'craft_grimforge_cauldron',  name:'Grimforge Cauldron',  icon:'🍲',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_cauldron',  qty:1},
    {id:'craft_grimforge_pick',      name:'Grimforge Pick',      icon:'🗝️',levelReq:35,xp:160,masteryXp:95, ticks:7, consumes:{steel_bar:3,maple_log:8},    produces:'grimforge_pick',      qty:1},
    {id:'craft_grimforge_plane',                name:'Grimforge Plane',   icon:'📐',levelReq:35,xp:160,masteryXp:95,ticks:7,consumes:{steel_bar:3,maple_log:8},   produces:'grimforge_plane',     qty:1},
    {id:'craft_grimforge_loupe',                name:'Grimforge Loupe',   icon:'🔭',levelReq:35,xp:160,masteryXp:95,ticks:7,consumes:{steel_bar:3,maple_log:8},   produces:'grimforge_loupe',     qty:1},
    {id:'craft_grimforge_shears',               name:'Grimforge Shears',  icon:'✂️',levelReq:35,xp:160,masteryXp:95,ticks:7,consumes:{steel_bar:3,maple_log:8},   produces:'grimforge_shears',    qty:1},
    // Tier 5 – Moonweave (3x mithril_bar + 8x teak_log, Lv 45)
    {id:'craft_moonweave_axe',       name:'Moonweave Axe',       icon:'🪓',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_axe',       qty:1},
    {id:'craft_moonweave_mattock',   name:'Moonweave Mattock',   icon:'⛏️',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_mattock',   qty:1},
    {id:'craft_moonweave_rod',       name:'Moonweave Rod',       icon:'🎣',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_rod',       qty:1},
    {id:'craft_moonweave_hammer',    name:'Moonweave Hammer',    icon:'🔨',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_hammer',    qty:1},
    {id:'craft_moonweave_cauldron',  name:'Moonweave Cauldron',  icon:'🍲',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_cauldron',  qty:1},
    {id:'craft_moonweave_pick',      name:'Moonweave Pick',      icon:'🗝️',levelReq:45,xp:210,masteryXp:125,ticks:8, consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_pick',      qty:1},
    {id:'craft_moonweave_plane',                name:'Moonweave Plane',   icon:'📐',levelReq:45,xp:210,masteryXp:125,ticks:8,consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_plane',     qty:1},
    {id:'craft_moonweave_loupe',                name:'Moonweave Loupe',   icon:'🔭',levelReq:45,xp:210,masteryXp:125,ticks:8,consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_loupe',     qty:1},
    {id:'craft_moonweave_shears',               name:'Moonweave Shears',  icon:'✂️',levelReq:45,xp:210,masteryXp:125,ticks:8,consumes:{mithril_bar:3,teak_log:8},   produces:'moonweave_shears',    qty:1},
    // Tier 6 – Sungilt (3x adamant_bar + 8x yew_log, Lv 55)
    {id:'craft_sungilt_axe',         name:'Sungilt Axe',         icon:'🪓',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_axe',         qty:1},
    {id:'craft_sungilt_mattock',     name:'Sungilt Mattock',     icon:'⛏️',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_mattock',     qty:1},
    {id:'craft_sungilt_rod',         name:'Sungilt Rod',         icon:'🎣',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_rod',         qty:1},
    {id:'craft_sungilt_hammer',      name:'Sungilt Hammer',      icon:'🔨',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_hammer',      qty:1},
    {id:'craft_sungilt_cauldron',    name:'Sungilt Cauldron',    icon:'🍲',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_cauldron',    qty:1},
    {id:'craft_sungilt_pick',        name:'Sungilt Pick',        icon:'🗝️',levelReq:55,xp:270,masteryXp:160,ticks:9, consumes:{adamant_bar:3,yew_log:8},    produces:'sungilt_pick',        qty:1},
    {id:'craft_sungilt_plane',                  name:'Sungilt Plane',     icon:'📐',levelReq:55,xp:270,masteryXp:160,ticks:9,consumes:{adamant_bar:3,yew_log:8},   produces:'sungilt_plane',     qty:1},
    {id:'craft_sungilt_loupe',                  name:'Sungilt Loupe',     icon:'🔭',levelReq:55,xp:270,masteryXp:160,ticks:9,consumes:{adamant_bar:3,yew_log:8},   produces:'sungilt_loupe',     qty:1},
    {id:'craft_sungilt_shears',                 name:'Sungilt Shears',    icon:'✂️',levelReq:55,xp:270,masteryXp:160,ticks:9,consumes:{adamant_bar:3,yew_log:8},   produces:'sungilt_shears',    qty:1},
    // Tier 7 – Stormcast (4x rune_bar + 10x magic_log, Lv 70)
    {id:'craft_stormcast_axe',       name:'Stormcast Axe',       icon:'🪓',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_axe',       qty:1},
    {id:'craft_stormcast_mattock',   name:'Stormcast Mattock',   icon:'⛏️',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_mattock',   qty:1},
    {id:'craft_stormcast_rod',       name:'Stormcast Rod',       icon:'🎣',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_rod',       qty:1},
    {id:'craft_stormcast_hammer',    name:'Stormcast Hammer',    icon:'🔨',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_hammer',    qty:1},
    {id:'craft_stormcast_cauldron',  name:'Stormcast Cauldron',  icon:'🍲',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_cauldron',  qty:1},
    {id:'craft_stormcast_pick',      name:'Stormcast Pick',      icon:'🗝️',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},    produces:'stormcast_pick',      qty:1},
    {id:'craft_stormcast_plane',                name:'Stormcast Plane',   icon:'📐',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},   produces:'stormcast_plane',     qty:1},
    {id:'craft_stormcast_loupe',                name:'Stormcast Loupe',   icon:'🔭',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},   produces:'stormcast_loupe',     qty:1},
    {id:'craft_stormcast_shears',               name:'Stormcast Shears',  icon:'✂️',levelReq:70,xp:340,masteryXp:205,ticks:10,consumes:{rune_bar:4,magic_log:10},   produces:'stormcast_shears',    qty:1},
    // Tier 8 – Duskwarden (4x dragon_bar + 10x redwood_log, Lv 85)
    {id:'craft_duskwarden_axe',      name:'Duskwarden Axe',      icon:'🪓',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_axe',      qty:1},
    {id:'craft_duskwarden_mattock',  name:'Duskwarden Mattock',  icon:'⛏️',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_mattock',  qty:1},
    {id:'craft_duskwarden_rod',      name:'Duskwarden Rod',      icon:'🎣',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_rod',      qty:1},
    {id:'craft_duskwarden_hammer',   name:'Duskwarden Hammer',   icon:'🔨',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_hammer',   qty:1},
    {id:'craft_duskwarden_cauldron', name:'Duskwarden Cauldron', icon:'🍲',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_cauldron', qty:1},
    {id:'craft_duskwarden_pick',     name:'Duskwarden Pick',     icon:'🗝️',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10}, produces:'duskwarden_pick',     qty:1},
    {id:'craft_duskwarden_plane',               name:'Duskwarden Plane',  icon:'📐',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10},   produces:'duskwarden_plane',     qty:1},
    {id:'craft_duskwarden_loupe',               name:'Duskwarden Loupe',  icon:'🔭',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10},   produces:'duskwarden_loupe',     qty:1},
    {id:'craft_duskwarden_shears',              name:'Duskwarden Shears', icon:'✂️',levelReq:85,xp:430,masteryXp:260,ticks:12,consumes:{dragon_bar:4,redwood_log:10},   produces:'duskwarden_shears',    qty:1},
  ],
  pickpocketing:[
    {id:'pickpocket_peasant',name:'Ragged Peasant',icon:'👨‍🌾',levelReq:1,xp:20,masteryXp:12,ticks:4,goldReward:80},
    {id:'pickpocket_farmer',name:'Village Farmer',icon:'🧑‍🌾',levelReq:15,xp:45,masteryXp:28,ticks:6,goldReward:220},
    {id:'pickpocket_merchant',name:'Market Vendor',icon:'🧑‍💼',levelReq:25,xp:70,masteryXp:42,ticks:8,goldReward:400},
    {id:'pickpocket_guard',name:'City Watchman',icon:'💂',levelReq:35,xp:100,masteryXp:60,ticks:10,goldReward:700},
    {id:'pickpocket_noble',name:'Minor Noble',icon:'🤵',levelReq:45,xp:140,masteryXp:82,ticks:13,goldReward:1200},
    {id:'pickpocket_banker',name:'Guild Financier',icon:'🧑‍💼',levelReq:55,xp:190,masteryXp:108,ticks:16,goldReward:2200},
    {id:'pickpocket_magistrate',name:'Royal Magistrate',icon:'👨‍⚖️',levelReq:70,xp:260,masteryXp:140,ticks:20,goldReward:4000},
    {id:'pickpocket_sovereign',name:'High Sovereign',icon:'👑',levelReq:85,xp:360,masteryXp:180,ticks:25,goldReward:7000},
  ],
  prospecting:[
    {id:'prospect_copper',name:'Graveliron Ore',icon:'🟤',levelReq:1,xp:20,masteryXp:15,ticks:5,consumes:{copper_ore:1},produces:'ashshard',gemChance:0.40},
    {id:'prospect_tin',name:'Graveliron Flux',icon:'🔵',levelReq:1,xp:20,masteryXp:15,ticks:5,consumes:{tin_ore:1},produces:'dustchip',gemChance:0.40},
    {id:'prospect_iron',name:'Redvein Copper',icon:'⬛',levelReq:15,xp:35,masteryXp:25,ticks:6,consumes:{iron_ore:1},produces:'emberspark',gemChance:0.38},
    {id:'prospect_silver',name:'Tinflare Ore',icon:'⚪',levelReq:20,xp:45,masteryXp:30,ticks:6,consumes:{silver_ore:1},produces:'silversliver',gemChance:0.37},
    {id:'prospect_coal',name:'Emberstone',icon:'🖤',levelReq:30,xp:55,masteryXp:36,ticks:7,consumes:{coal:1},produces:'coalite',gemChance:0.36},
    {id:'prospect_mithril',name:'Pale Silver',icon:'💠',levelReq:40,xp:80,masteryXp:50,ticks:8,consumes:{mithril_ore:1},produces:'mooncrystal',gemChance:0.35},
    {id:'prospect_adamant',name:'Goldember Ore',icon:'🟢',levelReq:55,xp:120,masteryXp:72,ticks:10,consumes:{adamant_ore:1},produces:'sungem',gemChance:0.33},
    {id:'prospect_runite',name:'Cobalite Ore',icon:'🔷',levelReq:70,xp:175,masteryXp:100,ticks:12,consumes:{runite_ore:1},produces:'stormstone',gemChance:0.30},
    {id:'prospect_dragon',name:'Nightnickel Ore',icon:'🔶',levelReq:85,xp:270,masteryXp:145,ticks:15,consumes:{dragon_ore:1},produces:'voidgem',gemChance:0.28},
  ],
  jewelcrafting:[
    // Gathering Amulets (woodcutting/mining/fishing XP)
    {id:'craft_graveliron_amulet',name:'Graveliron Amulet',icon:'📿',levelReq:1,xp:30,masteryXp:20,ticks:3,consumes:{ashshard:1,bronze_bar:1},produces:'graveliron_amulet',qty:1},
    {id:'craft_emberguard_amulet',name:'Emberguard Amulet',icon:'📿',levelReq:15,xp:55,masteryXp:36,ticks:4,consumes:{emberspark:1,iron_bar:1},produces:'emberguard_amulet',qty:1},
    {id:'craft_brightmail_amulet',name:'Brightmail Amulet',icon:'📿',levelReq:25,xp:80,masteryXp:52,ticks:5,consumes:{silversliver:1,silver_bar:1},produces:'brightmail_amulet',qty:1},
    {id:'craft_grimforge_amulet',name:'Grimforge Amulet',icon:'📿',levelReq:35,xp:115,masteryXp:72,ticks:6,consumes:{coalite:1,steel_bar:1},produces:'grimforge_amulet',qty:1},
    {id:'craft_moonweave_amulet',name:'Moonweave Amulet',icon:'📿',levelReq:45,xp:160,masteryXp:96,ticks:7,consumes:{mooncrystal:1,mithril_bar:1},produces:'moonweave_amulet',qty:1},
    {id:'craft_sungilt_amulet',name:'Sungilt Amulet',icon:'📿',levelReq:60,xp:220,masteryXp:128,ticks:8,consumes:{sungem:1,adamant_bar:1},produces:'sungilt_amulet',qty:1},
    {id:'craft_stormcast_amulet',name:'Stormcast Amulet',icon:'📿',levelReq:75,xp:300,masteryXp:164,ticks:9,consumes:{stormstone:1,rune_bar:1},produces:'stormcast_amulet',qty:1},
    {id:'craft_duskwarden_amulet',name:'Duskwarden Amulet',icon:'📿',levelReq:90,xp:400,masteryXp:208,ticks:10,consumes:{voidgem:1,dragon_bar:1},produces:'duskwarden_amulet',qty:1},
    {id:'craft_graveliron_artisan_amulet',name:'Graveliron Artisan Amulet',icon:'📿',levelReq:5,xp:30,masteryXp:20,ticks:3,consumes:{dustchip:1,bronze_bar:1},produces:'graveliron_artisan_amulet',qty:1},
    {id:'craft_emberguard_artisan_amulet',name:'Emberguard Artisan Amulet',icon:'📿',levelReq:18,xp:55,masteryXp:36,ticks:4,consumes:{ashshard:1,iron_bar:1},produces:'emberguard_artisan_amulet',qty:1},
    {id:'craft_brightmail_artisan_amulet',name:'Brightmail Artisan Amulet',icon:'📿',levelReq:28,xp:80,masteryXp:52,ticks:5,consumes:{emberspark:1,silver_bar:1},produces:'brightmail_artisan_amulet',qty:1},
    {id:'craft_grimforge_artisan_amulet',name:'Grimforge Artisan Amulet',icon:'📿',levelReq:38,xp:115,masteryXp:72,ticks:6,consumes:{silversliver:1,steel_bar:1},produces:'grimforge_artisan_amulet',qty:1},
    {id:'craft_moonweave_artisan_amulet',name:'Moonweave Artisan Amulet',icon:'📿',levelReq:48,xp:160,masteryXp:96,ticks:7,consumes:{coalite:1,mithril_bar:1},produces:'moonweave_artisan_amulet',qty:1},
    {id:'craft_sungilt_artisan_amulet',name:'Sungilt Artisan Amulet',icon:'📿',levelReq:62,xp:220,masteryXp:128,ticks:8,consumes:{mooncrystal:1,adamant_bar:1},produces:'sungilt_artisan_amulet',qty:1},
    {id:'craft_stormcast_artisan_amulet',name:'Stormcast Artisan Amulet',icon:'📿',levelReq:77,xp:300,masteryXp:164,ticks:9,consumes:{sungem:1,rune_bar:1},produces:'stormcast_artisan_amulet',qty:1},
    {id:'craft_duskwarden_artisan_amulet',name:'Duskwarden Artisan Amulet',icon:'📿',levelReq:90,xp:400,masteryXp:208,ticks:10,consumes:{stormstone:1,dragon_bar:1},produces:'duskwarden_artisan_amulet',qty:1},
    // Combat Amulets (+ATK/+DEF)
    {id:'craft_valor_amulet_t1',name:'Amulet of Valor',icon:'📿',levelReq:5,xp:35,masteryXp:22,ticks:3,consumes:{ashshard:1,iron_bar:1},produces:'valor_amulet_t1',qty:1},
    {id:'craft_valor_amulet_t2',name:'Amulet of Might',icon:'📿',levelReq:20,xp:65,masteryXp:42,ticks:4,consumes:{emberspark:1,silver_bar:1},produces:'valor_amulet_t2',qty:1},
    {id:'craft_valor_amulet_t3',name:'Amulet of Fury',icon:'📿',levelReq:30,xp:95,masteryXp:60,ticks:5,consumes:{silversliver:1,steel_bar:1},produces:'valor_amulet_t3',qty:1},
    {id:'craft_valor_amulet_t4',name:'Amulet of Power',icon:'📿',levelReq:40,xp:135,masteryXp:82,ticks:6,consumes:{coalite:1,mithril_bar:1},produces:'valor_amulet_t4',qty:1},
    {id:'craft_valor_amulet_t5',name:'Amulet of the Warden',icon:'📿',levelReq:50,xp:185,masteryXp:108,ticks:7,consumes:{mooncrystal:1,adamant_bar:1},produces:'valor_amulet_t5',qty:1},
    {id:'craft_valor_amulet_t6',name:'Amulet of the Storm',icon:'📿',levelReq:65,xp:255,masteryXp:142,ticks:8,consumes:{sungem:1,rune_bar:1},produces:'valor_amulet_t6',qty:1},
    {id:'craft_valor_amulet_t7',name:'Amulet of the Void',icon:'📿',levelReq:80,xp:340,masteryXp:180,ticks:9,consumes:{stormstone:1,rune_bar:2},produces:'valor_amulet_t7',qty:1},
    {id:'craft_valor_amulet_t8',name:'Amulet of Eternity',icon:'📿',levelReq:90,xp:450,masteryXp:226,ticks:10,consumes:{voidgem:1,dragon_bar:2},produces:'valor_amulet_t8',qty:1},
    // Skilling Rings (–5% speed per matching skill)
    {id:'craft_ring_of_felled',name:'Ring of the Felled',icon:'💍',levelReq:1,xp:25,masteryXp:18,ticks:3,consumes:{ashshard:1,bronze_bar:1},produces:'ring_of_felled',qty:1},
    {id:'craft_ring_of_veins',name:'Ring of the Veins',icon:'💍',levelReq:15,xp:50,masteryXp:33,ticks:4,consumes:{dustchip:1,iron_bar:1},produces:'ring_of_veins',qty:1},
    {id:'craft_ring_of_deep',name:'Ring of the Deep',icon:'💍',levelReq:25,xp:75,masteryXp:48,ticks:5,consumes:{emberspark:1,silver_bar:1},produces:'ring_of_deep',qty:1},
    {id:'craft_ring_of_lens',name:'Ring of the Lens',icon:'💍',levelReq:35,xp:105,masteryXp:63,ticks:6,consumes:{silversliver:1,steel_bar:1},produces:'ring_of_lens',qty:1},
    {id:'craft_ring_of_hearth',name:'Ring of the Hearth',icon:'💍',levelReq:45,xp:155,masteryXp:92,ticks:7,consumes:{coalite:1,mithril_bar:1},produces:'ring_of_hearth',qty:1},
    {id:'craft_ring_of_craft',name:'Ring of the Craft',icon:'💍',levelReq:60,xp:210,masteryXp:122,ticks:8,consumes:{mooncrystal:1,adamant_bar:1},produces:'ring_of_craft',qty:1},
    {id:'craft_ring_of_forge',name:'Ring of the Forge',icon:'💍',levelReq:75,xp:285,masteryXp:156,ticks:9,consumes:{sungem:1,rune_bar:1},produces:'ring_of_forge',qty:1},
    {id:'craft_ring_of_shadow',name:'Ring of the Shadow',icon:'💍',levelReq:85,xp:375,masteryXp:195,ticks:10,consumes:{stormstone:1,dragon_bar:1},produces:'ring_of_shadow',qty:1},
    {id:'craft_ring_of_facet',name:'Ring of the Facet',icon:'💍',levelReq:90,xp:420,masteryXp:212,ticks:11,consumes:{voidgem:1,dragon_bar:1},produces:'ring_of_facet',qty:1},
    // Combat Rings
    {id:'craft_bloodstone_ring',name:'Bloodstone Ring',icon:'💍',levelReq:10,xp:40,masteryXp:26,ticks:3,consumes:{ashshard:1,iron_bar:1},produces:'bloodstone_ring',qty:1},
    {id:'craft_crimson_ring',name:'Crimson Sigil Ring',icon:'💍',levelReq:85,xp:420,masteryXp:214,ticks:10,consumes:{voidgem:1,dragon_bar:2},produces:'crimson_ring',qty:1},
    {id:'craft_fury_ring',name:'Ring of Fury',icon:'💍',levelReq:10,xp:40,masteryXp:26,ticks:3,consumes:{dustchip:1,iron_bar:1},produces:'fury_ring',qty:1},
    {id:'craft_rage_ring',name:'Ring of Rage',icon:'💍',levelReq:85,xp:420,masteryXp:214,ticks:10,consumes:{voidgem:1,rune_bar:2},produces:'rage_ring',qty:1},
    {id:'craft_ironwill_ring',name:'Ironwill Ring',icon:'💍',levelReq:20,xp:60,masteryXp:40,ticks:4,consumes:{emberspark:1,silver_bar:1},produces:'ironwill_ring',qty:1},
    {id:'craft_bulwark_ring',name:'Bulwark Ring',icon:'💍',levelReq:80,xp:380,masteryXp:196,ticks:9,consumes:{voidgem:1,rune_bar:1},produces:'bulwark_ring',qty:1},
    {id:'craft_swiftblade_ring',name:'Swiftblade Ring',icon:'💍',levelReq:30,xp:85,masteryXp:55,ticks:5,consumes:{silversliver:1,steel_bar:1},produces:'swiftblade_ring',qty:1},
    {id:'craft_stormstep_ring',name:'Stormstep Ring',icon:'💍',levelReq:85,xp:420,masteryXp:214,ticks:10,consumes:{stormstone:1,dragon_bar:2},produces:'stormstep_ring',qty:1},
  ],
};

// MONSTERS
// ============================================================
// COMBAT ZONES & MONSTERS
// ============================================================
const COMBAT_ZONES=[
  {
    id:'forest',
    name:'🌲 Forest Clearing',
    desc:'A peaceful forest teeming with small creatures',
    levelReq:1,
    tier:'Roughplate'
  },
  {
    id:'cave',
    name:'🕳️ Dark Caverns',
    desc:'Twisted tunnels filled with dangerous beasts',
    levelReq:15,
    tier:'Emberguard'
  },
  {
    id:'crypt',
    name:'⚰️ Ancient Crypt',
    desc:'Forgotten tombs where the undead roam',
    levelReq:30,
    tier:'Grimforge'
  },
  {
    id:'volcano',
    name:'🌋 Volcanic Peaks',
    desc:'Scorching mountains inhabited by fire creatures',
    levelReq:45,
    tier:'Moonweave'
  },
  {
    id:'abyss',
    name:'🌑 Abyssal Depths',
    desc:'A dark realm where demons dwell',
    levelReq:60,
    tier:'Sungilt'
  },
  {
    id:'fortress',
    name:'🏰 Shadow Fortress',
    desc:'An imposing stronghold guarded by elite warriors',
    levelReq:75,
    tier:'Stormcast'
  },
  {
    id:'realm',
    name:'✨ Celestial Realm',
    desc:'The domain of ancient dragons and gods',
    levelReq:85,
    tier:'Duskwarden'
  }
];

const MONSTERS=[
  // 🌲 FOREST CLEARING (Roughplate Tier, Lv 1-15)
  {id:'rat',name:'Giant Rat',icon:'🐀',zone:'forest',levelReq:1,hp:25,maxHp:25,atk:3,def:1,xp:12,drops:[
    {item:'bones',qty:1,chance:0.4},{item:'raw_shrimp',qty:1,chance:0.25},
    {gold:[2,6]}
  ]},
  {id:'goblin',name:'Goblin Scout',icon:'👺',zone:'forest',levelReq:3,hp:35,maxHp:35,atk:5,def:2,xp:18,drops:[
    {item:'bones',qty:1,chance:0.8},{item:'bronze_helmet',qty:1,chance:0.03},{item:'copper_ore',qty:1,chance:0.3},
    {gold:[3,10]}
  ]},
  {id:'wolf',name:'Forest Wolf',icon:'🐺',zone:'forest',levelReq:8,hp:50,maxHp:50,atk:8,def:3,xp:25,drops:[
    {item:'bones',qty:1,chance:1},{item:'bronze_sword',qty:1,chance:0.04},{item:'bronze_body',qty:1,chance:0.02},
    {gold:[5,15]}
  ]},
  {id:'bear',name:'Black Bear',icon:'🐻',zone:'forest',levelReq:12,hp:75,maxHp:75,atk:12,def:5,xp:35,drops:[
    {item:'bones',qty:2,chance:1},{item:'bronze_body',qty:1,chance:0.05},{item:'bronze_legs',qty:1,chance:0.04},
    {gold:[8,22]}
  ]},
  
  // 🕳️ DARK CAVERNS (Emberguard Tier, Lv 15-30)
  {id:'bat',name:'Cave Bat',icon:'🦇',zone:'cave',levelReq:15,hp:90,maxHp:90,atk:15,def:6,xp:45,drops:[
    {item:'bones',qty:1,chance:0.5},{item:'iron_ore',qty:1,chance:0.3},{item:'iron_helmet',qty:1,chance:0.03},
    {gold:[12,28]}
  ]},
  {id:'spider',name:'Giant Spider',icon:'🕷️',zone:'cave',levelReq:18,hp:110,maxHp:110,atk:18,def:8,xp:55,drops:[
    {item:'iron_bar',qty:1,chance:0.25},{item:'iron_sword',qty:1,chance:0.04},{item:'iron_body',qty:1,chance:0.03},
    {gold:[15,35]}
  ]},
  {id:'troll',name:'Cave Troll',icon:'👹',zone:'cave',levelReq:23,hp:140,maxHp:140,atk:22,def:10,xp:70,drops:[
    {item:'bones',qty:2,chance:1},{item:'iron_bar',qty:2,chance:0.4},{item:'iron_legs',qty:1,chance:0.05},
    {gold:[20,45]}
  ]},
  {id:'scorpion',name:'Giant Scorpion',icon:'🦂',zone:'cave',levelReq:27,hp:170,maxHp:170,atk:26,def:12,xp:85,drops:[
    {item:'iron_bar',qty:2,chance:0.5},{item:'silver_ore',qty:1,chance:0.4},{item:'iron_shield',qty:1,chance:0.06},
    {gold:[25,55]}
  ]},
  
  // ⚰️ ANCIENT CRYPT (Grimforge Tier, Lv 30-45)
  {id:'skeleton',name:'Skeleton Warrior',icon:'💀',zone:'crypt',levelReq:30,hp:200,maxHp:200,atk:30,def:14,xp:100,drops:[
    {item:'bones',qty:3,chance:1},{item:'steel_bar',qty:1,chance:0.35},{item:'steel_helmet',qty:1,chance:0.04},
    {gold:[30,70]}
  ]},
  {id:'zombie',name:'Rotting Zombie',icon:'🧟',zone:'crypt',levelReq:34,hp:240,maxHp:240,atk:35,def:16,xp:120,drops:[
    {item:'bones',qty:2,chance:1},{item:'steel_bar',qty:1,chance:0.4},{item:'steel_body',qty:1,chance:0.04},
    {gold:[35,80]}
  ]},
  {id:'wraith',name:'Dark Wraith',icon:'👻',zone:'crypt',levelReq:38,hp:220,maxHp:220,atk:42,def:14,xp:135,drops:[
    {item:'steel_bar',qty:2,chance:0.5},{item:'steel_sword',qty:1,chance:0.06},{item:'coal',qty:3,chance:0.6},
    {gold:[40,90]}
  ]},
  {id:'necromancer',name:'Necromancer',icon:'🧙',zone:'crypt',levelReq:43,hp:280,maxHp:280,atk:48,def:20,xp:160,drops:[
    {item:'bones',qty:5,chance:1},{item:'steel_bar',qty:2,chance:0.6},{item:'steel_body',qty:1,chance:0.07},{item:'mithril_ore',qty:1,chance:0.3},
    {gold:[50,115]}
  ]},
  
  // 🌋 VOLCANIC PEAKS (Moonweave Tier, Lv 45-60)
  {id:'fire_imp',name:'Fire Imp',icon:'😈',zone:'volcano',levelReq:45,hp:300,maxHp:300,atk:52,def:22,xp:180,drops:[
    {item:'coal',qty:4,chance:0.8},{item:'mithril_bar',qty:1,chance:0.35},{item:'mithril_helmet',qty:1,chance:0.04},
    {gold:[60,130]}
  ]},
  {id:'lava_beast',name:'Lava Beast',icon:'🔥',zone:'volcano',levelReq:50,hp:360,maxHp:360,atk:58,def:26,xp:210,drops:[
    {item:'coal',qty:5,chance:0.9},{item:'mithril_bar',qty:2,chance:0.45},{item:'mithril_body',qty:1,chance:0.05},
    {gold:[70,150]}
  ]},
  {id:'fire_elemental',name:'Fire Elemental',icon:'🌪️',zone:'volcano',levelReq:54,hp:340,maxHp:340,atk:65,def:24,xp:230,drops:[
    {item:'mithril_bar',qty:2,chance:0.5},{item:'mithril_sword',qty:1,chance:0.06},{item:'adamant_ore',qty:1,chance:0.3},
    {gold:[80,170]}
  ]},
  {id:'elder_dragon',name:'Elder Fire Dragon',icon:'🐉',zone:'volcano',levelReq:58,hp:450,maxHp:450,atk:72,def:30,xp:270,drops:[
    {item:'mithril_bar',qty:3,chance:0.7},{item:'mithril_shield',qty:1,chance:0.08},{item:'adamant_ore',qty:2,chance:0.4},
    {gold:[100,200]}
  ]},
  
  // 🌑 ABYSSAL DEPTHS (Sungilt Tier, Lv 60-75)
  {id:'lesser_demon',name:'Lesser Demon',icon:'😈',zone:'abyss',levelReq:60,hp:480,maxHp:480,atk:78,def:32,xp:300,drops:[
    {item:'bones',qty:3,chance:0.8},{item:'adamant_bar',qty:1,chance:0.35},{item:'adamant_helmet',qty:1,chance:0.04},
    {gold:[110,220]}
  ]},
  {id:'greater_demon',name:'Greater Demon',icon:'👿',zone:'abyss',levelReq:65,hp:550,maxHp:550,atk:86,def:36,xp:340,drops:[
    {item:'adamant_bar',qty:2,chance:0.45},{item:'adamant_sword',qty:1,chance:0.06},{item:'adamant_body',qty:1,chance:0.05},
    {gold:[130,250]}
  ]},
  {id:'shadow_beast',name:'Shadow Beast',icon:'🐾',zone:'abyss',levelReq:69,hp:520,maxHp:520,atk:92,def:34,xp:370,drops:[
    {item:'adamant_bar',qty:2,chance:0.5},{item:'adamant_legs',qty:1,chance:0.06},{item:'runite_ore',qty:1,chance:0.25},
    {gold:[140,270]}
  ]},
  {id:'demon_lord',name:'Demon Lord',icon:'👹',zone:'abyss',levelReq:73,hp:650,maxHp:650,atk:130,def:42,xp:420,drops:[
    {item:'adamant_bar',qty:3,chance:0.6},{item:'adamant_body',qty:1,chance:0.08},{item:'runite_ore',qty:2,chance:0.35},
    {gold:[160,300]}
  ]},
  
  // 🏰 SHADOW FORTRESS (Stormcast Tier, Lv 75-85)
  {id:'dark_knight',name:'Dark Knight',icon:'🗡️',zone:'fortress',levelReq:75,hp:700,maxHp:700,atk:140,def:45,xp:480,drops:[
    {item:'runite_ore',qty:2,chance:0.5},{item:'rune_bar',qty:1,chance:0.35},{item:'rune_helmet',qty:1,chance:0.04},
    {gold:[180,340]}
  ]},
  {id:'void_warrior',name:'Void Warrior',icon:'⚔️',zone:'fortress',levelReq:79,hp:780,maxHp:780,atk:153,def:50,xp:540,drops:[
    {item:'rune_bar',qty:2,chance:0.45},{item:'rune_sword',qty:1,chance:0.06},{item:'rune_body',qty:1,chance:0.05},
    {gold:[200,380]}
  ]},
  {id:'lich',name:'Ancient Lich',icon:'☠️',zone:'fortress',levelReq:82,hp:850,maxHp:850,atk:163,def:48,xp:600,drops:[
    {item:'bones',qty:8,chance:1},{item:'rune_bar',qty:3,chance:0.55},{item:'rune_shield',qty:1,chance:0.07},{item:'dragon_ore',qty:1,chance:0.2},
    {gold:[220,420]}
  ]},
  {id:'titan',name:'Stone Titan',icon:'🗿',zone:'fortress',levelReq:85,hp:950,maxHp:950,atk:150,def:60,xp:680,drops:[
    {item:'runite_ore',qty:4,chance:0.7},{item:'rune_bar',qty:3,chance:0.6},{item:'rune_body',qty:1,chance:0.08},{item:'dragon_ore',qty:1,chance:0.25},
    {gold:[250,480]}
  ]},
  
  // ✨ CELESTIAL REALM (Duskwarden Tier, Lv 85-99)
  {id:'celestial_warrior',name:'Celestial Warrior',icon:'👼',zone:'realm',levelReq:85,hp:1000,maxHp:1000,atk:176,def:55,xp:750,drops:[
    {item:'dragon_ore',qty:2,chance:0.45},{item:'dragon_bar',qty:1,chance:0.3},{item:'dragon_helmet',qty:1,chance:0.03},
    {item:'infusion_crystal',qty:1,chance:0.005}, // 0.5% ultra-rare
    {gold:[280,520]}
  ]},
  {id:'void_knight',name:'Void Knight',icon:'🛡️',zone:'realm',levelReq:88,hp:1150,maxHp:1150,atk:189,def:62,xp:850,drops:[
    {item:'dragon_bar',qty:2,chance:0.4},{item:'dragon_sword',qty:1,chance:0.05},{item:'dragon_body',qty:1,chance:0.04},
    {item:'infusion_crystal',qty:1,chance:0.0075}, // 0.75% ultra-rare
    {gold:[320,580]}
  ]},
  {id:'ancient_dragon',name:'Ancient Dragon',icon:'🐲',zone:'realm',levelReq:91,hp:1300,maxHp:1300,atk:205,def:68,xp:980,drops:[
    {item:'dragon_ore',qty:4,chance:0.7},{item:'dragon_bar',qty:3,chance:0.5},{item:'dragon_shield',qty:1,chance:0.06},{item:'dragon_body',qty:1,chance:0.05},
    {item:'infusion_crystal',qty:1,chance:0.01}, // 1% ultra-rare
    {gold:[380,680]}
  ]},
  {id:'eternal_dragon',name:'Eternal Dragon',icon:'🐉',zone:'realm',levelReq:95,hp:1500,maxHp:1500,atk:228,def:75,xp:1200,drops:[
    {item:'dragon_bar',qty:4,chance:0.7},{item:'dragon_sword',qty:1,chance:0.08},{item:'dragon_body',qty:1,chance:0.07},{item:'dragon_legs',qty:1,chance:0.06},
    {item:'infusion_crystal',qty:1,chance:0.015}, // 1.5% ultra-rare
    {gold:[450,800]}
  ]},
];


// ============================================================
// CONTRACTS
// ============================================================
const CONTRACT_TEMPLATES=[
  // ── WOODCUTTING ─────────────────────────────────────────────
  {id:'wood_basic',    tier:'Basic',    icon:'🪵',skill:'woodcutting',minLv:1,  requirements:[{item:'normal_log',qty:25}],                                          rewards:{gold:500,   xp:200}},
  {id:'wood_oak',      tier:'Common',   icon:'🌳',skill:'woodcutting',minLv:15, requirements:[{item:'oak_log',qty:20}],                                             rewards:{gold:1500,  xp:600}},
  {id:'wood_willow',   tier:'Uncommon', icon:'🌿',skill:'woodcutting',minLv:30, requirements:[{item:'willow_log',qty:15}],                                          rewards:{gold:3500,  items:[{id:'iron_sword',qty:1},{id:'bronze_bar',qty:10}],       xp:1200}},
  {id:'wood_maple',    tier:'Rare',     icon:'🍁',skill:'woodcutting',minLv:45, requirements:[{item:'maple_log',qty:12}],                                           rewards:{gold:7500,  items:[{id:'steel_sword',qty:1},{id:'steel_bar',qty:8}],         xp:2500}},
  {id:'wood_yew',      tier:'Epic',     icon:'🌲',skill:'woodcutting',minLv:65, requirements:[{item:'yew_log',qty:10}],                                             rewards:{gold:15000, items:[{id:'mithril_helmet',qty:1},{id:'mithril_bar',qty:10}],  xp:5000}},
  {id:'wood_redwood',  tier:'Legendary',icon:'🌳',skill:'woodcutting',minLv:85, requirements:[{item:'redwood_log',qty:8}],                                          rewards:{gold:30000, items:[{id:'rune_body',qty:1},{id:'rune_bar',qty:8}],         xp:10000}},

  // ── MINING ───────────────────────────────────────────────────
  {id:'ore_basic',     tier:'Basic',    icon:'⛰️',skill:'mining',    minLv:1,  requirements:[{item:'copper_ore',qty:20},{item:'tin_ore',qty:20}],                   rewards:{gold:600,   xp:200}},
  {id:'ore_iron',      tier:'Common',   icon:'⚙️',skill:'mining',    minLv:15, requirements:[{item:'iron_ore',qty:25}],                                             rewards:{gold:1800,  xp:600}},
  {id:'ore_coal',      tier:'Uncommon', icon:'🪨',skill:'mining',    minLv:30, requirements:[{item:'coal',qty:20}],                                                 rewards:{gold:4000,  items:[{id:'iron_helmet',qty:1},{id:'iron_bar',qty:12}],         xp:1200}},
  {id:'ore_mithril',   tier:'Rare',     icon:'💎',skill:'mining',    minLv:45, requirements:[{item:'mithril_ore',qty:15}],                                          rewards:{gold:8500,  items:[{id:'steel_helmet',qty:1},{id:'mithril_bar',qty:8}],      xp:2500}},
  {id:'ore_adamant',   tier:'Epic',     icon:'🔰',skill:'mining',    minLv:60, requirements:[{item:'adamant_ore',qty:12}],                                          rewards:{gold:17000, items:[{id:'adamant_helmet',qty:1},{id:'adamant_bar',qty:6}],  xp:5000}},
  {id:'ore_dragon',    tier:'Legendary',icon:'🌑',skill:'mining',    minLv:85, requirements:[{item:'dragon_ore',qty:8}],                                            rewards:{gold:35000, items:[{id:'rune_helmet',qty:1},{id:'rune_bar',qty:6}],        xp:10000}},

  // ── FISHING ──────────────────────────────────────────────────
  {id:'fish_basic',    tier:'Basic',    icon:'🎣',skill:'fishing',   minLv:1,  requirements:[{item:'raw_shrimp',qty:30}],                                           rewards:{gold:450,   xp:200}},
  {id:'fish_trout',    tier:'Common',   icon:'🐟',skill:'fishing',   minLv:15, requirements:[{item:'raw_trout',qty:25}],                                            rewards:{gold:1400,  xp:600}},
  {id:'fish_lobster',  tier:'Uncommon', icon:'🦞',skill:'fishing',   minLv:30, requirements:[{item:'raw_lobster',qty:18}],                                          rewards:{gold:3800,  items:[{id:'iron_body',qty:1},{id:'cooked_lobster',qty:10}],    xp:1200}},
  {id:'fish_swordfish',tier:'Rare',     icon:'🗡️',skill:'fishing',   minLv:55, requirements:[{item:'raw_swordfish',qty:15}],                                        rewards:{gold:8000,  items:[{id:'steel_body',qty:1},{id:'cooked_swordfish',qty:8}],  xp:2500}},
  {id:'fish_shark',    tier:'Epic',     icon:'🦈',skill:'fishing',   minLv:75, requirements:[{item:'raw_shark',qty:10}],                                            rewards:{gold:16000, items:[{id:'mithril_body',qty:1},{id:'cooked_shark',qty:6}],   xp:5000}},
  {id:'fish_turtle',   tier:'Legendary',icon:'🐢',skill:'fishing',   minLv:95, requirements:[{item:'raw_turtle',qty:6}],                                            rewards:{gold:40000, items:[{id:'adamant_body',qty:1},{id:'cooked_turtle',qty:4}], xp:10000}},

  // ── SMITHING ─────────────────────────────────────────────────
  {id:'smith_basic',   tier:'Basic',    icon:'🪨',skill:'smithing',  minLv:1,  requirements:[{item:'bronze_bar',qty:10}],                                            rewards:{gold:800,   xp:300}},
  {id:'smith_bronze',  tier:'Common',   icon:'🔨',skill:'smithing',  minLv:10, requirements:[{item:'bronze_bar',qty:15}],                                            rewards:{gold:2000,  xp:700}},
  {id:'smith_iron',    tier:'Uncommon', icon:'⚒️',skill:'smithing',  minLv:25, requirements:[{item:'iron_bar',qty:12}],                                              rewards:{gold:4500,  items:[{id:'iron_shield',qty:1},{id:'steel_bar',qty:5}],         xp:1400}},
  {id:'smith_steel',   tier:'Rare',     icon:'🛠️',skill:'smithing',  minLv:40, requirements:[{item:'steel_bar',qty:10}],                                            rewards:{gold:9500,  items:[{id:'steel_shield',qty:1},{id:'mithril_bar',qty:5}],      xp:2800}},
  {id:'smith_mithril', tier:'Epic',     icon:'⚔️',skill:'smithing',  minLv:55, requirements:[{item:'mithril_bar',qty:8}],                                           rewards:{gold:19000, items:[{id:'mithril_sword',qty:1},{id:'adamant_bar',qty:4}],  xp:5500}},
  {id:'smith_dragon',  tier:'Legendary',icon:'🔥',skill:'smithing',  minLv:85, requirements:[{item:'dragon_bar',qty:5}],                                            rewards:{gold:45000, items:[{id:'dragon_sword',qty:1},{id:'dragon_bar',qty:3}],     xp:12000}},

  // ── COOKING ──────────────────────────────────────────────────
  {id:'cook_basic',    tier:'Basic',    icon:'🍳',skill:'cooking',   minLv:5,  requirements:[{item:'cooked_shrimp',qty:20}],                                        rewards:{gold:600,   xp:250}},
  {id:'cook_lobster',  tier:'Uncommon', icon:'🦞',skill:'cooking',   minLv:30, requirements:[{item:'cooked_lobster',qty:12}],                                       rewards:{gold:4000,  items:[{id:'cooked_shark',qty:5},{id:'cooked_swordfish',qty:3}],  xp:1300}},
  {id:'cook_shark',    tier:'Rare',     icon:'🦈',skill:'cooking',   minLv:50, requirements:[{item:'cooked_shark',qty:8}],                                          rewards:{gold:8500,  items:[{id:'cooked_manta',qty:4},{id:'cooked_turtle',qty:2}],    xp:3000}},
  {id:'cook_manta',    tier:'Epic',     icon:'🌊',skill:'cooking',   minLv:75, requirements:[{item:'cooked_manta',qty:6}],                                          rewards:{gold:18000, items:[{id:'cooked_turtle',qty:5},{id:'cooked_shark',qty:8}],  xp:6000}},
  {id:'cook_turtle',   tier:'Legendary',icon:'🐢',skill:'cooking',   minLv:95, requirements:[{item:'cooked_turtle',qty:5}],                                         rewards:{gold:40000, items:[{id:'rune_sword',qty:1},{id:'cooked_turtle',qty:8}],   xp:12000}},

  // ── WOODWORKING ──────────────────────────────────────────────
  {id:'ww_graveliron', tier:'Basic',    icon:'🪚',skill:'woodworking',minLv:1, requirements:[{item:'graveliron_axe',qty:1},{item:'graveliron_pick',qty:1}],          rewards:{gold:800,   xp:350}},
  {id:'ww_emberguard', tier:'Common',   icon:'🔧',skill:'woodworking',minLv:15,requirements:[{item:'emberguard_rod',qty:1},{item:'emberguard_hammer',qty:1}],        rewards:{gold:2500,  xp:900}},
  {id:'ww_grimforge',  tier:'Uncommon', icon:'⚙️',skill:'woodworking',minLv:35,requirements:[{item:'grimforge_mattock',qty:1},{item:'grimforge_cauldron',qty:1}],    rewards:{gold:6000,  items:[{id:'steel_bar',qty:5},{id:'maple_log',qty:15}],         xp:1800}},
  {id:'ww_moonweave',  tier:'Rare',     icon:'🌙',skill:'woodworking',minLv:55,requirements:[{item:'moonweave_axe',qty:1},{item:'moonweave_rod',qty:1}],             rewards:{gold:13000, items:[{id:'mithril_bar',qty:5},{id:'teak_log',qty:12}],       xp:3500}},
  {id:'ww_stormcast',  tier:'Epic',     icon:'⚡',skill:'woodworking',minLv:70,requirements:[{item:'stormcast_plane',qty:1},{item:'stormcast_pick',qty:1}],          rewards:{gold:25000, items:[{id:'rune_bar',qty:4},{id:'magic_log',qty:10}],         xp:7000}},
  {id:'ww_duskwarden', tier:'Legendary',icon:'🌑',skill:'woodworking',minLv:85,requirements:[{item:'duskwarden_axe',qty:1},{item:'duskwarden_hammer',qty:1}],        rewards:{gold:55000, items:[{id:'dragon_bar',qty:3},{id:'redwood_log',qty:8}],      xp:14000}},

  // ── PROSPECTING ──────────────────────────────────────────────
  {id:'prosp_basic',   tier:'Basic',    icon:'🔍',skill:'prospecting',minLv:1, requirements:[{item:'ashshard',qty:15},{item:'dustchip',qty:15}],                    rewards:{gold:700,   xp:300}},
  {id:'prosp_ember',   tier:'Common',   icon:'🔥',skill:'prospecting',minLv:15,requirements:[{item:'emberspark',qty:20}],                                           rewards:{gold:2200,  xp:900}},
  {id:'prosp_coalite', tier:'Uncommon', icon:'🖤',skill:'prospecting',minLv:30,requirements:[{item:'coalite',qty:15}],                                              rewards:{gold:5500,  items:[{id:'iron_bar',qty:8},{id:'graveliron_loupe',qty:1}],       xp:1800}},
  {id:'prosp_sungem',  tier:'Rare',     icon:'☀️',skill:'prospecting',minLv:55,requirements:[{item:'sungem',qty:10}],                                               rewards:{gold:14000, items:[{id:'adamant_bar',qty:5},{id:'emberguard_loupe',qty:1}],  xp:4000}},
  {id:'prosp_storm',   tier:'Epic',     icon:'⛈️',skill:'prospecting',minLv:70,requirements:[{item:'stormstone',qty:8}],                                            rewards:{gold:28000, items:[{id:'rune_bar',qty:4},{id:'grimforge_loupe',qty:1}],      xp:8000}},
  {id:'prosp_void',    tier:'Legendary',icon:'🌑',skill:'prospecting',minLv:85,requirements:[{item:'voidgem',qty:5}],                                               rewards:{gold:60000, items:[{id:'dragon_bar',qty:3},{id:'moonweave_loupe',qty:1}],    xp:15000}},

  // ── JEWELCRAFTING ────────────────────────────────────────────
  {id:'jc_basic',      tier:'Basic',    icon:'💍',skill:'jewelcrafting',minLv:1, requirements:[{item:'graveliron_amulet',qty:3}],                                   rewards:{gold:900,   xp:400}},
  {id:'jc_common',     tier:'Common',   icon:'📿',skill:'jewelcrafting',minLv:15,requirements:[{item:'emberguard_amulet',qty:2},{item:'ring_of_veins',qty:1}],      rewards:{gold:2800,  xp:1000}},
  {id:'jc_uncommon',   tier:'Uncommon', icon:'💠',skill:'jewelcrafting',minLv:35,requirements:[{item:'grimforge_amulet',qty:2}],                                    rewards:{gold:6500,  items:[{id:'silver_bar',qty:8},{id:'steel_bar',qty:5}],          xp:2000}},
  {id:'jc_rare',       tier:'Rare',     icon:'✨',skill:'jewelcrafting',minLv:50,requirements:[{item:'valor_amulet_t5',qty:1},{item:'ring_of_craft',qty:1}],        rewards:{gold:15000, items:[{id:'adamant_bar',qty:5},{id:'mooncrystal',qty:3}],    xp:4500}},
  {id:'jc_epic',       tier:'Epic',     icon:'🌟',skill:'jewelcrafting',minLv:75,requirements:[{item:'valor_amulet_t7',qty:1},{item:'ring_of_forge',qty:1}],        rewards:{gold:32000, items:[{id:'rune_bar',qty:4},{id:'stormstone',qty:3}],        xp:9000}},
  {id:'jc_legendary',  tier:'Legendary',icon:'🌠',skill:'jewelcrafting',minLv:90,requirements:[{item:'valor_amulet_t8',qty:1},{item:'ring_of_shadow',qty:1}],       rewards:{gold:70000, items:[{id:'dragon_bar',qty:3},{id:'voidgem',qty:2}],         xp:18000}},

  // ── PICKPOCKETING ────────────────────────────────────────────
  // Requirements use {gold:amount} — player pays gold as proof of their haul
  {id:'pp_farmer',     tier:'Basic',    icon:'🥷',skill:'pickpocketing',minLv:1, requirements:[{gold:2000}],                                                         rewards:{gold:1000,  xp:400}},
  {id:'pp_watchman',   tier:'Common',   icon:'🗡️',skill:'pickpocketing',minLv:25,requirements:[{gold:8000}],                                                         rewards:{gold:3500,  xp:1100}},
  {id:'pp_noble',      tier:'Uncommon', icon:'👑',skill:'pickpocketing',minLv:45,requirements:[{gold:25000}],                                                        rewards:{gold:9000,  items:[{id:'iron_bar',qty:10},{id:'silver_bar',qty:5}],         xp:2200}},
  {id:'pp_magistrate', tier:'Rare',     icon:'⚖️',skill:'pickpocketing',minLv:70,requirements:[{gold:60000}],                                                        rewards:{gold:20000, items:[{id:'steel_bar',qty:8},{id:'mithril_bar',qty:4}],       xp:5000}},
  {id:'pp_sovereign',  tier:'Epic',     icon:'🏰',skill:'pickpocketing',minLv:85,requirements:[{gold:150000}],                                                       rewards:{gold:45000, items:[{id:'adamant_bar',qty:6},{id:'rune_bar',qty:3}],        xp:11000}},
  {id:'pp_phantom',    tier:'Legendary',icon:'🌑',skill:'pickpocketing',minLv:95,requirements:[{gold:350000}],                                                       rewards:{gold:80000, items:[{id:'dragon_bar',qty:3},{id:'rune_bar',qty:5}],         xp:20000}},

  // ── COMBAT ───────────────────────────────────────────────────
  {id:'combat_bones',     tier:'Common',   icon:'🦴',skill:'combat',minLv:10, requirements:[{item:'bones',qty:50}],                                                 rewards:{gold:2000,  xp:800}},
  {id:'combat_goblins',   tier:'Uncommon', icon:'👺',skill:'combat',minLv:20, requirements:[{item:'bronze_sword',qty:3}],                                           rewards:{gold:4500,  items:[{id:'iron_sword',qty:2},{id:'iron_bar',qty:5}],         xp:1500}},
  {id:'combat_equipment', tier:'Rare',     icon:'⚔️',skill:'combat',minLv:40, requirements:[{item:'steel_bar',qty:10},{item:'mithril_bar',qty:5}],                  rewards:{gold:12000, items:[{id:'adamant_shield',qty:1},{id:'adamant_sword',qty:1}],xp:3500}},
  {id:'combat_warlord',   tier:'Epic',     icon:'🛡️',skill:'combat',minLv:65, requirements:[{item:'adamant_bar',qty:8},{item:'rune_bar',qty:4}],                    rewards:{gold:28000, items:[{id:'rune_sword',qty:1},{id:'rune_shield',qty:1}],     xp:7500}},
  {id:'combat_legend',    tier:'Legendary',icon:'🐉',skill:'combat',minLv:85, requirements:[{item:'dragon_bar',qty:5},{item:'rune_bar',qty:8}],                     rewards:{gold:65000, items:[{id:'dragon_sword',qty:1},{id:'dragon_shield',qty:1}], xp:16000}},
];

// ============================================================
// GENERAL STORE
// ============================================================
const STORE_ITEMS=[
  // Food (2x value = convenience tax)
  {id:'cooked_shrimp',category:'food',price:40,stock:'unlimited'},
  {id:'cooked_trout',category:'food',price:120,stock:'unlimited'},
  {id:'cooked_salmon',category:'food',price:240,stock:'unlimited'},
  {id:'cooked_tuna',category:'food',price:360,stock:'unlimited'},
  {id:'cooked_lobster',category:'food',price:500,stock:'unlimited'},
  {id:'cooked_bass',category:'food',price:700,stock:'unlimited'},
  {id:'cooked_swordfish',category:'food',price:1000,stock:'unlimited'},
  {id:'cooked_monkfish',category:'food',price:1400,stock:'unlimited'},
  {id:'cooked_shark',category:'food',price:2000,stock:'unlimited'},
  {id:'cooked_manta',category:'food',price:2800,stock:'unlimited'},
  {id:'cooked_turtle',category:'food',price:4000,stock:'unlimited'},
  
  // Bars (3x value = skip smelting)
  {id:'bronze_bar',category:'bars',price:120,stock:'unlimited'},
  {id:'iron_bar',category:'bars',price:240,stock:'unlimited'},
  {id:'silver_bar',category:'bars',price:360,stock:'unlimited'},
  {id:'steel_bar',category:'bars',price:450,stock:'unlimited'},
  {id:'mithril_bar',category:'bars',price:900,stock:'unlimited'},
  {id:'adamant_bar',category:'bars',price:1800,stock:'unlimited'},
  {id:'rune_bar',category:'bars',price:3600,stock:'unlimited'},
  {id:'dragon_bar',category:'bars',price:7500,stock:'unlimited'},
  
  // Basic Gear (starter equipment)
  {id:'bronze_sword',category:'gear',price:200,stock:'unlimited'},
  {id:'bronze_helmet',category:'gear',price:150,stock:'unlimited'},
  {id:'bronze_body',category:'gear',price:250,stock:'unlimited'},
  {id:'bronze_legs',category:'gear',price:200,stock:'unlimited'},
  {id:'bronze_gloves',category:'gear',price:120,stock:'unlimited'},
  {id:'bronze_boots',category:'gear',price:150,stock:'unlimited'},
  {id:'bronze_shield',category:'gear',price:180,stock:'unlimited'},
  {id:'iron_sword',category:'gear',price:500,stock:'unlimited'},
  {id:'iron_helmet',category:'gear',price:400,stock:'unlimited'},
  {id:'iron_body',category:'gear',price:600,stock:'unlimited'},
  {id:'iron_legs',category:'gear',price:500,stock:'unlimited'},
  {id:'iron_gloves',category:'gear',price:300,stock:'unlimited'},
  {id:'iron_boots',category:'gear',price:400,stock:'unlimited'},
  {id:'iron_shield',category:'gear',price:450,stock:'unlimited'},
];

// ============================================================
// MASTERY UPGRADES
// ============================================================
const MASTERY_UPGRADES={
  woodcutting:[
    {id:'wc_mastery',name:'Master Forester',desc:'Gain more mastery when cutting',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'wc_yield',name:'Efficient Chopping',desc:'Gain more resources when woodcutting',effect:'+10% wood yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% wood yield`},
    {id:'wc_speed',name:'Swift Axe',desc:'Chop trees faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'wc_xp',name:'Lumberjack Knowledge',desc:'Gain more XP from woodcutting',effect:'+15% woodcutting XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% woodcutting XP`},
  ],
  mining:[
    {id:'mn_mastery',name:'Master Miner',desc:'Gain more mastery when mining',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'mn_yield',name:'Keen Eye',desc:'Find more ore per strike',effect:'+10% ore yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% ore yield`},
    {id:'mn_speed',name:'Pickaxe Mastery',desc:'Mine rocks faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'mn_xp',name:'Geological Insight',desc:'Gain more mining XP',effect:'+15% mining XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% mining XP`},
  ],
  fishing:[
    {id:'fh_mastery',name:'Master Angler',desc:'Gain more mastery when fishing',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'fh_yield',name:'Lucky Line',desc:'Catch more fish',effect:'+10% fish yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% fish yield`},
    {id:'fh_speed',name:'Nimble Hands',desc:'Fish faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'fh_xp',name:'Angler Expertise',desc:'Gain more fishing XP',effect:'+15% fishing XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% fishing XP`},
  ],
  smithing:[
    {id:'sm_mastery',name:'Master Blacksmith',desc:'Gain more mastery when blacksmithing',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'sm_yield',name:'Precise Forging',desc:'Sometimes create bonus bars',effect:'+10% bar yield',cost:120,maxPurchases:5,stackEffect:(n)=>`+${n*10}% bar yield`},
    {id:'sm_speed',name:'Forge Efficiency',desc:'Smith faster',effect:'-5% action time',cost:180,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'sm_xp',name:'Metallurgy Mastery',desc:'Gain more blacksmithing XP',effect:'+15% blacksmithing XP',cost:220,maxPurchases:3,stackEffect:(n)=>`+${n*15}% blacksmithing XP`},
  ],
  cooking:[
    {id:'ck_mastery',name:'Master Chef',desc:'Gain more mastery when cooking',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'ck_yield',name:'Plentiful Cook',desc:'Occasionally produce bonus food when cooking',effect:'+25% food yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*25}% food yield`},
    {id:'ck_speed',name:'Fast Fire',desc:'Cook food faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'ck_xp',name:'Culinary Arts',desc:'Gain more cooking XP',effect:'+15% cooking XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% cooking XP`},
  ],
  pickpocketing:[
    {id:'pp_mastery',name:'Master Thief',desc:'Gain more mastery when pickpocketing',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'pp_yield',name:'Nimble Fingers',desc:'Steal more gold per pickpocket',effect:'+10% gold yield',cost:100,maxPurchases:5,stackEffect:(n)=>`+${n*10}% gold yield`},
    {id:'pp_speed',name:'Swift Hands',desc:'Pickpocket faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'pp_xp',name:'Street Wisdom',desc:'Gain more pickpocketing XP',effect:'+15% pickpocketing XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% pickpocketing XP`},
  ],
  combat:[
    {id:'cb_damage',name:'Combat Prowess',desc:'Deal more damage in combat',effect:'+5% damage',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*5}% damage`},
    {id:'cb_defense',name:'Defensive Stance',desc:'Take less damage',effect:'+3% damage reduction',cost:200,maxPurchases:5,stackEffect:(n)=>`+${n*3}% damage reduction`},
    {id:'cb_xp',name:'Battle Experience',desc:'Gain more combat XP',effect:'+12% combat XP',cost:250,maxPurchases:3,stackEffect:(n)=>`+${n*12}% combat XP`},
    {id:'cb_drops',name:'Lucky Looter',desc:'Better drop rates',effect:'+8% drop chance',cost:300,maxPurchases:3,stackEffect:(n)=>`+${n*8}% drop chance`},
  ],
  woodworking:[
    {id:'ww_mastery',name:'Master Craftsman',desc:'Gain more mastery when woodworking',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'ww_speed',name:'Artisan Efficiency',desc:'Craft tools faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'ww_xp',name:'Craft Knowledge',desc:'Gain more woodworking XP',effect:'+15% woodworking XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% woodworking XP`},
    {id:'ww_yield',name:'Material Savvy',desc:'Produce more items per craft',effect:'+25% item yield',cost:180,maxPurchases:3,stackEffect:(n)=>`+${n*25}% item yield`},
  ],
  prospecting:[
    {id:'pr_mastery',name:'Keen Prospector',desc:'Gain more mastery when prospecting',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'pr_success',name:'Sharp Eye',desc:'Higher gem chance per ore',effect:'+5% gem chance',cost:120,maxPurchases:5,stackEffect:(n)=>`+${n*5}% gem chance`},
    {id:'pr_speed',name:'Swift Inspection',desc:'Prospect ores faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'pr_xp',name:'Geological Mastery',desc:'Gain more prospecting XP',effect:'+15% prospecting XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% prospecting XP`},
  ],
  jewelcrafting:[
    {id:'jc_mastery',name:'Master Jeweler',desc:'Gain more mastery when jewelcrafting',effect:'+25% mastery gain',cost:100,maxPurchases:3,stackEffect:(n)=>`+${n*25}% mastery gain`},
    {id:'jc_speed',name:'Steady Hand',desc:'Craft jewelry faster',effect:'-5% action time',cost:150,maxPurchases:4,stackEffect:(n)=>`-${n*5}% action time`},
    {id:'jc_yield',name:'Gem Cutter',desc:'Produce more jewelry per craft',effect:'+25% item yield',cost:180,maxPurchases:3,stackEffect:(n)=>`+${n*25}% item yield`},
    {id:'jc_xp',name:'Artisan Gemcraft',desc:'Gain more jewelcrafting XP',effect:'+15% jewelcrafting XP',cost:200,maxPurchases:3,stackEffect:(n)=>`+${n*15}% jewelcrafting XP`},
  ],
};

// ============================================================
// GAME STATE
// ============================================================
const GAME_VERSION = 5; // Increment when making breaking changes

let G = {
  version: GAME_VERSION,
  skills:{
    woodcutting:{xp:0,masteryXp:{}},
    mining:{xp:0,masteryXp:{}},
    fishing:{xp:0,masteryXp:{}},
    smithing:{xp:0,masteryXp:{}},
    cooking:{xp:0,masteryXp:{}},
    pickpocketing:{xp:0,masteryXp:{}},
    woodworking:{xp:0,masteryXp:{}},
    prospecting:{xp:0,masteryXp:{}},
    jewelcrafting:{xp:0,masteryXp:{}},
    combat:{xp:0,masteryXp:{}},
    // Combat sub-skills
    attack:{xp:0,masteryXp:{}},        // → Crit chance
    strength:{xp:0,masteryXp:{}},      // → Power (bonus damage)
    haste:{xp:0,masteryXp:{}},         // → Attack speed
    defense:{xp:0,masteryXp:{}},       // → Armor + Block
    hitpoints:{xp:XP_TABLE[9],masteryXp:{}}, // starts at level 10
  },
  bank:{},
  bankOrder:[], // Custom ordering of bank items: [itemId1, itemId2, ...]
  gold:0,
  equipment:{weapon:null,helmet:null,body:null,legs:null,shield:null,gloves:null,boots:null,trinket:null,tool:null,amulet:null,ring1:null,ring2:null},
  infusion:{}, // Track infusion levels: {slot: level} e.g. {weapon: 5, helmet: 3}
  combat:{
    active:false,
    monsterId:'goblin',
    playerHp:10,
    maxHp:10,
    monsterHp:0,
    maxMonsterHp:0,
    tickCounter:0,
    log:[],
    tookDamageThisFight:false, // Track if damage was taken in current fight (for flawless victories)
    isRareSpawn:false, // Track if current monster is a rare variant (0.5% chance, 2x XP/loot)
  },
  selectedZone:'forest', // Currently selected combat zone
  activeActions:{},
  actionProgress:{},
  sessionCounts:{}, // Track items produced in current session: {actionId: count}
  lastSave:Date.now(),
  offlineBanner:null,
  xpTracker:{snapshots:[],activeKey:null}, // Rolling XP/hr tracker
  tracker:{open:false,xpSnaps:{},lootLog:{},goldLog:[],activeKey:null}, // Session tracker panel
  contracts:[],
  contractsLastRefresh:0,
  masteryUpgrades:{}, // Track purchased upgrades: {skillName_upgradeId: count}
  currentMasteryTab:'woodcutting', // Track which mastery tab is active
  
  // Statistics tracking
  stats:{
    // Time tracking
    sessionStart:Date.now(),
    totalPlayTime:0, // milliseconds
    
    // General stats
    actionsCompleted:0,
    totalXpGained:0,
    
    // Skill stats
    logsChopped:0,
    oresMined:0,
    fishCaught:0,
    barsSmelted:0,
    itemsCooked:0,
    itemsCrafted:0,
    npcsPickpocketed:0,
    monstersDefeated:0,
    
    // Combat stats
    totalDamageDealt:0,
    highestHit:0,
    foodConsumed:0,
    deaths:0,
    flawlessVictories:0, // Kills without taking damage
    monsterKillStreak:0, // Current streak of kills without dying (for Deathless achievement)
    
    // Economy stats
    totalGoldEarned:0,
    totalGoldSpent:0,
    itemsSold:0,
    itemsBought:0,
    
    // Personal bests
    longestSession:0, // milliseconds
    mostXpInOneAction:0,
    contractsCompleted:0,
    contractXpGained:0,
  },
  masteryResets:0, // Number of times mastery has been fully reset
  masteryLastReset:0, // Timestamp of last reset (for 7-day cooldown)
  
  // Collection log - track what player has obtained
  collection:{
    logs:{}, // {oak_log: true, willow_log: true, ...}
    ores:{}, // {copper_ore: true, iron_ore: true, ...}
    fish:{}, // {shrimp: true, trout: true, ...}
    food:{}, // {cooked_shrimp: true, ...}
    bars:{}, // {bronze_bar: true, ...}
    gems:{}, // {ashshard: true, emberspark: true, ...}
    jewelry:{}, // {graveliron_amulet: true, ...}
    tools:{}, // {graveliron_axe: true, emberguard_rod: true, ...}
    equipment:{}, // {bronze_sword: true, ...}
    monsters:{}, // {goblin: true, skeleton: true, ...}
    trinkets:{}, // {woodcutters_trinket: true, ...}
    rares:{}, // {shiny_goblin: true, golden_oak: true, ...} - rare variants
  },
  
  // Achievements
  achievements:{
    // unlocked achievements: {achievement_id: timestamp_unlocked}
  },
  
  // Equipped badge (from achievements)
  equippedBadge:null, // Badge name to display
};

// ============================================================
// GAME LOGIC
// ============================================================
function getPlayerStats(){
  // Defensive: ensure combat skills exist (in case called during migration)
  if(!G.skills.attack)G.skills.attack={xp:0,masteryXp:{}};
  if(!G.skills.strength)G.skills.strength={xp:0,masteryXp:{}};
  if(!G.skills.haste)G.skills.haste={xp:0,masteryXp:{}};
  if(!G.skills.defense)G.skills.defense={xp:0,masteryXp:{}};
  if(!G.skills.hitpoints)G.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}};
  
  // Base skill levels (never modified by infusion)
  const atkLv=xpToLevel(G.skills.attack.xp);
  const strLv=xpToLevel(G.skills.strength.xp);
  const hasteLv=xpToLevel(G.skills.haste.xp);
  const defLv=xpToLevel(G.skills.defense.xp);
  const hpLv=xpToLevel(G.skills.hitpoints.xp);
  
  // Combat level = avg of 5 sub-skills
  const combatLevel=Math.max(1,Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5));

  // Base derived stats from skill levels (no equipment, no infusion)
  let critChance=Math.min(50, 5 + Math.floor(atkLv*0.4));
  let power=Math.floor(strLv*0.6);
  let attackTicks=Math.max(1, 4 - Math.floor(hasteLv/33));
  let attackSpeed=(attackTicks*0.6).toFixed(1)+'s';
  let armor=Math.floor(defLv*0.5);
  let blockChance=Math.min(30, 2 + Math.floor(defLv*0.2));
  let maxHp=10 + hpLv*6;

  // Equipment bonuses with infusion applied to EQUIPPED gear only
  let eqAtk=1; 
  let eqDef=0;
  const eq=G.equipment;
  
  // Weapon: atk + infusion boosts (crit, power)
  if(eq.weapon&&ITEMS[eq.weapon]){
    const baseAtk=ITEMS[eq.weapon].atk||0;
    const infusion=G.infusion.weapon||0;
    const boostedAtk=Math.floor(baseAtk*(1+infusion*0.01));
    eqAtk+=boostedAtk;
    // Weapon infusion also boosts crit and power
    if(infusion>0){
      critChance=Math.min(50, Math.floor(critChance*(1+infusion*0.01)));
      power=Math.floor(power*(1+infusion*0.01));
    }
  }
  
  // Helmet: def + infusion boosts (crit, power, armor, block)
  if(eq.helmet&&ITEMS[eq.helmet]){
    const baseDef=ITEMS[eq.helmet].def||0;
    const infusion=G.infusion.helmet||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      critChance=Math.min(50, Math.floor(critChance*(1+infusion*0.01)));
      power=Math.floor(power*(1+infusion*0.01));
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
    }
  }
  
  // Body: def + infusion boosts (crit, power, armor, block)
  if(eq.body&&ITEMS[eq.body]){
    const baseDef=ITEMS[eq.body].def||0;
    const infusion=G.infusion.body||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      critChance=Math.min(50, Math.floor(critChance*(1+infusion*0.01)));
      power=Math.floor(power*(1+infusion*0.01));
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
    }
  }
  
  // Legs: def + infusion boosts (crit, power, armor, block)
  if(eq.legs&&ITEMS[eq.legs]){
    const baseDef=ITEMS[eq.legs].def||0;
    const infusion=G.infusion.legs||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      critChance=Math.min(50, Math.floor(critChance*(1+infusion*0.01)));
      power=Math.floor(power*(1+infusion*0.01));
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
    }
  }
  
  // Gloves: def + infusion boosts (maxHp, armor, block)
  if(eq.gloves&&ITEMS[eq.gloves]){
    const baseDef=ITEMS[eq.gloves].def||0;
    const infusion=G.infusion.gloves||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      maxHp=Math.floor(maxHp*(1+infusion*0.007));
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
    }
  }
  
  // Boots: def + infusion boosts (attack speed, armor, block)
  if(eq.boots&&ITEMS[eq.boots]){
    const baseDef=ITEMS[eq.boots].def||0;
    const infusion=G.infusion.boots||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      // Boots infusion reduces attack ticks (faster attack)
      const tickReduction=Math.floor(infusion*0.03); // -1 tick per ~3 ranks
      attackTicks=Math.max(1, attackTicks-tickReduction);
      attackSpeed=(attackTicks*0.6).toFixed(1)+'s';
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
    }
  }
  
  // Shield: def + infusion boosts (armor, block, maxHp)
  if(eq.shield&&ITEMS[eq.shield]){
    const baseDef=ITEMS[eq.shield].def||0;
    const infusion=G.infusion.shield||0;
    const boostedDef=Math.floor(baseDef*(1+infusion*0.01));
    eqDef+=boostedDef;
    armor+=boostedDef;
    if(infusion>0){
      armor=Math.floor(armor*(1+infusion*0.007));
      blockChance=Math.min(30, Math.floor(blockChance*(1+infusion*0.007)));
      maxHp=Math.floor(maxHp*(1+infusion*0.007));
    }
  }

  // Overall atk/def for combat
  let atk=eqAtk+Math.floor(atkLv*0.5)+Math.floor(strLv*0.3);
  let def=armor;
  
  // Brawler's Trinket bonus (10% to ALL combat stats - same as infusion)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  if(trinket&&trinket.skill==='combat'){
    // Boost all offensive stats
    atk=Math.floor(atk*1.1);
    critChance=Math.min(50, Math.floor(critChance*1.1));
    power=Math.floor(power*1.1);
    
    // Boost attack speed (reduce ticks)
    const tickReduction=Math.floor(attackTicks*0.1); // 10% faster
    attackTicks=Math.max(1, attackTicks-tickReduction);
    attackSpeed=(attackTicks*0.6).toFixed(1)+'s';
    
    // Boost all defensive stats
    armor=Math.floor(armor*1.1);
    def=armor;
    blockChance=Math.min(30, Math.floor(blockChance*1.1));
    maxHp=Math.floor(maxHp*1.1);
  }

  // Combat Amulet bonuses
  const equippedAmuletId=G.equipment.amulet;
  const equippedAmulet=equippedAmuletId?ITEMS[equippedAmuletId]:null;
  if(equippedAmulet&&equippedAmulet.amuletType==='combat'){
    atk+=(equippedAmulet.atkBonus||0);
    armor+=(equippedAmulet.defBonus||0);
    def=armor;
  }

  // Combat Ring bonuses (ring1 + ring2)
  const equippedRings=[G.equipment.ring1,G.equipment.ring2];
  for(const ringId of equippedRings){
    const ring=ringId?ITEMS[ringId]:null;
    if(!ring||ring.cat!=='jewelry')continue;
    if(ring.critBonus)critChance=Math.min(50,critChance+ring.critBonus);
    if(ring.powerBonus)power+=ring.powerBonus;
    if(ring.defBonus){armor+=ring.defBonus;def=armor;}
    if(ring.hasteBonus){attackTicks=Math.max(1,attackTicks-ring.hasteBonus);attackSpeed=(attackTicks*0.6).toFixed(1)+'s';}
  }

  // Return stats (base levels for display and requirements)
  return{atk,def,maxHp,combatLevel,critChance,power,attackTicks,attackSpeed,armor,blockChance,
         atkLv,strLv,hasteLv,defLv,hpLv,eqAtk,eqDef,
         baseAtkLv:atkLv,baseStrLv:strLv,baseDefLv:defLv,baseHpLv:hpLv};
}

function getMasteryLevel(skill,actionId){return xpToLevel(G.skills[skill].masteryXp[actionId]||0);}
function getMasteryProgress(skill,actionId){
  const xp=G.skills[skill]?.masteryXp?.[actionId]||0;
  const lv=xpToLevel(xp);
  if(lv>=99)return 100; // Max level
  const req=XP_TABLE[lv-1]; // Current level's starting XP
  const next=XP_TABLE[lv]; // Next level's requirement
  if(!next||next<=req)return 100; // Safety check
  return ((xp-req)/(next-req))*100;
}
function getMasteryXp(skill,actionId){return G.skills[skill].masteryXp[actionId]||0;}

function addToBank(itemId,qty){
  G.bank[itemId]=(G.bank[itemId]||0)+qty;
  updateBankQuantityDisplays();
}

function updateBankQuantityDisplays(){
  // Update all bank quantity displays on current page without full re-render
  if(!currentPage)return;
  
  // ========== CRITICAL: DO NOT UPDATE WHEN ON BANK PAGE ==========
  // Updating any DOM elements while on bank page causes corruption
  // Bank stays frozen and only updates on manual refresh or page switch
  if(getCurrentPage()==='bank')return;
  // ================================================================
  
  // Update action card quantities (but NOT bank items!)
  // Only select elements that are NOT inside .b-item (bank items)
  document.querySelectorAll('[data-item-id]:not(.b-item):not(.b-item [data-item-id])').forEach(el=>{
    const itemId=el.getAttribute('data-item-id');
    if(itemId&&G.bank[itemId]!==undefined){
      el.textContent=`(${fmt(G.bank[itemId]||0)})`;
    }
  });
  
  // Update ingredient quantities and availability
  document.querySelectorAll('[data-ingredient-id]').forEach(el=>{
    const itemId=el.getAttribute('data-ingredient-id');
    if(itemId){
      el.textContent=`(${G.bank[itemId]||0})`;
      // Update parent ingredient span's ok/missing class
      const parentSpan=el.closest('.ingredient');
      if(parentSpan){
        // Extract required quantity from the span text
        const match=parentSpan.textContent.match(/(\d+)x/);
        if(match){
          const requiredQty=parseInt(match[1]);
          const hasEnough=(G.bank[itemId]||0)>=requiredQty;
          parentSpan.classList.toggle('ok',hasEnough);
          parentSpan.classList.toggle('missing',!hasEnough);
        }
      }
    }
  });
}
function removeFromBank(itemId,qty){
  if(!G.bank[itemId]||G.bank[itemId]<qty)return false;
  G.bank[itemId]-=qty;
  if(G.bank[itemId]<=0)delete G.bank[itemId];
  updateBankQuantityDisplays();
  
  // Bank will auto-refresh when needed (on page switch, manual refresh, etc.)
  // No automatic DOM updates to prevent corruption
  
  return true;
}

// Helper function to update a single bank item's display
function updateBankItemDisplay(itemId){
  if(getCurrentPage()!=='bank')return;
  
  const itemEl=document.querySelector(`.b-item[data-item-id="${itemId}"]`);
  if(!itemEl)return;
  
  const qty=G.bank[itemId]||0;
  const item=ITEMS[itemId];
  if(!item)return;
  
  // Update quantity display
  const qtyEl=itemEl.querySelector('.b-qty');
  if(qtyEl)qtyEl.textContent=fmt(qty);
  
  // Update sell menu buttons
  const sellMenu=itemEl.querySelector('.b-sell-menu');
  if(sellMenu){
    sellMenu.innerHTML=`
      ${qty>=1?`<button class="b-sell-btn" onclick="sellItem('${itemId}',1)" title="Sell 1">Sell 1</button>`:''}
      ${qty>=10?`<button class="b-sell-btn" onclick="sellItem('${itemId}',10)" title="Sell 10">Sell 10</button>`:''}
      ${qty>=100?`<button class="b-sell-btn" onclick="sellItem('${itemId}',100)" title="Sell 100">Sell 100</button>`:''}
      ${qty>=1000?`<button class="b-sell-btn" onclick="sellItem('${itemId}',1000)" title="Sell 1000">Sell 1K</button>`:''}
      <button class="b-sell-btn b-sell-all" onclick="sellItem('${itemId}',${qty})" title="Sell All">Sell All</button>
    `;
  }
}

function hasMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    if((G.bank[k]||0)<v)return false;
  }
  return true;
}
function consumeMaterials(consumes){
  for(const[k,v] of Object.entries(consumes)){
    removeFromBank(k,v);
  }
}
function getCraftableCount(consumes){
  if(!consumes||Object.keys(consumes).length===0)return 0;
  let minCount=Infinity;
  for(const[itemId,qtyNeeded] of Object.entries(consumes)){
    const available=G.bank[itemId]||0;
    const canMake=Math.floor(available/qtyNeeded);
    minCount=Math.min(minCount,canMake);
  }
  return minCount===Infinity?0:minCount;
}

function stopAllActions(){
  // Stop all skill actions
  for(const skill of Object.keys(G.activeActions)){
    delete G.activeActions[skill];
    delete G.actionProgress[skill];
  }
  // Stop smithing craft
  smithingCraftAction=null;
  smithingCraftProgress=0;
  // Stop combat
  if(G.combat.active){
    G.combat.active=false;
  }
  // Update UI
  updateActiveActionDisplay();
}

function startAction(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq)return;
  stopAllActions(); // Stop everything else
  G.activeActions[skill]=actionId;
  G.actionProgress[skill]=0;
  G.sessionCounts[actionId]=0; // Reset session count
  updateActiveActionDisplay();
  renderSkillPage(skill);
  renderSidebar();
}
function stopAction(skill){
  delete G.activeActions[skill];
  delete G.actionProgress[skill];
  updateActiveActionDisplay();
  renderSkillPage(skill);
}

function startCombatAction(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0)G.combat.playerHp=Math.floor(stats.maxHp/2);
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;
  // No level requirement - fight any monster!
  stopAllActions(); // Stop everything else
  
  // ========== RARE SPAWN LOGIC (0.5% chance) ==========
  G.combat.isRareSpawn=(Math.random()<0.005); // 0.5% chance
  if(G.combat.isRareSpawn){
    addCombatLog('✨ A SHINY '+monster.name.toUpperCase()+' appears! (2x XP & Loot)','clog-kill');
    notify(`✨ Rare Shiny ${monster.name} spawned!`,'lvl');
    // Track in collection
    G.collection.rares[monster.id]=true;
  }
  // ===================================================
  
  G.combat.active=true;
  G.combat.monsterHp=monster.maxHp;
  G.combat.maxMonsterHp=monster.maxHp;
  G.combat.tickCounter=0;
  if(!G.combat.isRareSpawn){
    addCombatLog('⚔️ Engaging '+monster.name+'...','clog-p');
  }
  updateActiveActionDisplay();
  renderCombatPage();
}
function stopCombat(){
  G.combat.active=false;
  updateActiveActionDisplay();
  renderCombatPage();
}

function eatFood(itemId){
  // Check if food exists
  if(!ITEMS[itemId]||ITEMS[itemId].cat!=='food'){
    notify('Not a valid food item!','info');
    return;
  }
  // Check if player has it
  if(!G.bank[itemId]||G.bank[itemId]<=0){
    notify('You don\'t have any '+ITEMS[itemId].name+'!','info');
    return;
  }
  // Get current stats
  const stats=getPlayerStats();
  const healAmount=ITEMS[itemId].heals||0;
  const oldHp=G.combat.playerHp;
  
  // Restore HP (capped at max)
  G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+healAmount);
  const actualHeal=G.combat.playerHp-oldHp;
  
  // Remove food from bank
  removeFromBank(itemId,1);
  
  // Stats tracking
  G.stats.foodConsumed++;
  
  // Show notification and log
  notify(`Ate ${ITEMS[itemId].icon} ${ITEMS[itemId].name} (+${actualHeal} HP)`,'lvl');
  if(G.combat.active){
    addCombatLog(`❤️ You ate ${ITEMS[itemId].name} and restored ${actualHeal} HP!`,'clog-heal');
  }
  
  // Update UI
  renderCombatPage();
  updateHeader();
  // Note: Bank updates handled efficiently by removeFromBank()
}

function addCombatLog(msg,cls='clog-p'){
  G.combat.log.unshift({msg,cls});
  if(G.combat.log.length>40)G.combat.log.pop();
  const el=document.getElementById('combat-log');
  if(el){
    el.innerHTML=G.combat.log.map(l=>`<p class="${l.cls}">${l.msg}</p>`).join('');
  }
}

function processCombatTick(){
  if(!G.combat.active)return;
  G.combat.tickCounter++;

  const stats=getPlayerStats();
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
  const hasCombatTrinket=equippedTrinket&&equippedTrinket.skill==='combat';

  // Attack check: every attackTicks ticks
  if(G.combat.tickCounter % stats.attackTicks !== 0) return;

  // Determine if this hit crits
  const isCrit = Math.random() * 100 < stats.critChance;
  // Base damage: atk - monster.def + random variance
  let playerDmg = Math.max(1, stats.atk - Math.floor(monster.def/2) + Math.floor(Math.random()*4) - 1 + stats.power);
  if(isCrit) playerDmg = Math.floor(playerDmg * 1.5);
  
  // Apply combat damage bonus from mastery
  const dmgBonus=1+(getMasteryBonus('combat','damage')/100);
  playerDmg=Math.floor(playerDmg*dmgBonus);

  G.combat.monsterHp=Math.max(0,G.combat.monsterHp-playerDmg);
  
  // ========== STATISTICS TRACKING ==========
  G.stats.totalDamageDealt+=playerDmg;
  if(playerDmg>G.stats.highestHit)G.stats.highestHit=playerDmg;
  // ========================================
  
  if(isCrit){
    addCombatLog(`💥 CRIT! You strike ${monster.name} for ${playerDmg} damage!`,'clog-kill');
  } else {
    addCombatLog(`⚔️ You hit ${monster.name} for ${playerDmg} damage.`,'clog-hit');
  }

  // XP for hitting (with combat XP bonus)
  let xpBonus=1+(getMasteryBonus('combat','xp')/100);
  if(hasCombatTrinket){
    xpBonus*=1.1; // 10% XP bonus
  }
  gainCombatSubXp('attack', Math.floor((4 + Math.floor(monster.xp * 0.15))*xpBonus));
  gainCombatSubXp('strength', Math.floor((Math.max(1, Math.floor(playerDmg * 0.5) + 2))*xpBonus));
  gainCombatSubXp('haste', Math.floor((2 + Math.floor(monster.xp * 0.08))*xpBonus)); // Now gains XP on hit
  gainCombatSubXp('defense', Math.floor((3 + Math.floor(monster.xp * 0.1))*xpBonus)); // Now gains XP on hit
  gainCombatSubXp('hitpoints', Math.floor((2 + Math.floor(monster.xp * 0.12))*xpBonus)); // Now gains XP on hit

  if(G.combat.monsterHp<=0){
    // ========== RARE SPAWN MULTIPLIER ==========
    const rareMultiplier=G.combat.isRareSpawn?2:1;
    // ===========================================
    
    // On kill: bonus xp to all combat skills (combat is now calculated, not trained)
    const killXp = monster.xp * rareMultiplier;
    gainCombatSubXp('attack', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('strength', Math.floor(killXp*0.2*xpBonus));
    gainCombatSubXp('haste', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('defense', Math.floor(killXp*0.1*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor(killXp*0.15*xpBonus));
    // Combat is now a calculated level (average of 5 sub-skills), not a trainable skill
    
    // ========== COMBAT MASTERY XP ==========
    // Award mastery XP for this specific monster
    const masteryXpGain=50; // Fixed amount per kill
    if(!G.skills.combat.masteryXp[monster.id])G.skills.combat.masteryXp[monster.id]=0;
    G.skills.combat.masteryXp[monster.id]+=masteryXpGain;
    updateCombatMastery(); // Update mastery bar in real-time
    // ========================================
    
    const xpText=G.combat.isRareSpawn?`💫 ${Math.floor(killXp*xpBonus)} XP (SHINY BONUS!)`:Math.floor(killXp*xpBonus)+' XP';
    addCombatLog(`☠️ ${monster.name} defeated! Combat +${xpText}`,'clog-kill');
    
    // ========== STATISTICS TRACKING ==========
    G.stats.monstersDefeated++;
    G.stats.monsterKillStreak++; // Increment streak (reset on death)
    G.stats.totalXpGained+=Math.floor(killXp*xpBonus);
    // Check for flawless victory (no damage taken during this fight)
    if(!G.combat.tookDamageThisFight){
      G.stats.flawlessVictories++;
    }
    // Reset damage tracker for next fight
    G.combat.tookDamageThisFight=false;
    // Collection log
    G.collection.monsters[monster.id]=true;
    // ========================================
    
    // Loot (with drop bonus from mastery and trinket)
    const dropBonus=getMasteryBonus('combat','drops')/100;
    const trinketBonus=hasCombatTrinket?0.1:0; // 10% loot boost
    let lootText=[];
    for(const drop of monster.drops){
      if(drop.gold){
        let gAmt=drop.gold[0]+Math.floor(Math.random()*(drop.gold[1]-drop.gold[0]+1));
        // Apply trinket bonus to gold
        if(trinketBonus>0)gAmt=Math.floor(gAmt*(1+trinketBonus));
        // Apply rare spawn 2x multiplier
        if(rareMultiplier>1)gAmt=Math.floor(gAmt*rareMultiplier);
        G.gold+=gAmt;lootText.push(`${gAmt}gp`);
        trackGold(gAmt);
        // Stats tracking
        G.stats.totalGoldEarned+=gAmt;
      } else {
        const dropChance=Math.min(1,drop.chance+dropBonus+trinketBonus);
        if(Math.random()<dropChance){
          let qty=drop.qty;
          // Apply rare spawn 2x multiplier to item quantity
          if(rareMultiplier>1)qty=Math.floor(qty*rareMultiplier);
          addToBank(drop.item,qty);
          trackLoot(drop.item,qty);
          lootText.push(`${qty}x ${ITEMS[drop.item].name}`);
        }
      }
    }
    // Brawler's Trinket drop chance (only if player doesn't have it in bank or equipped)
    const hasBrawlersTrinket=G.bank['brawlers_trinket']||(G.equipment.trinket==='brawlers_trinket');
    if(!hasBrawlersTrinket){
      const atkLv=xpToLevel(G.skills.attack.xp);
      const strLv=xpToLevel(G.skills.strength.xp);
      const hasteLv=xpToLevel(G.skills.haste.xp);
      const defLv=xpToLevel(G.skills.defense.xp);
      const hpLv=xpToLevel(G.skills.hitpoints.xp);
      const combatLv=Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5);
      const dropChance=0.001+(combatLv*0.0001);
      if(Math.random()<dropChance){
        addToBank('brawlers_trinket',1);
        trackLoot('brawlers_trinket',1);
        notify(`✨ ${ITEMS['brawlers_trinket'].name} found!`,'item');
        // Collection log
        G.collection.trinkets['brawlers_trinket']=true;
      }
    }
    if(lootText.length)addCombatLog('💰 Loot: '+lootText.join(', '),'clog-loot');
    
    // Heal 12% of max HP on kill (balanced to make food essential)
    const healAmount=Math.floor(stats.maxHp*0.12);
    G.combat.playerHp=Math.min(stats.maxHp, G.combat.playerHp+healAmount);
    if(healAmount>0){
      addCombatLog(`💚 Healed +${healAmount} HP (${Math.floor(G.combat.playerHp)}/${stats.maxHp})`,'clog-heal');
    }
    
    // Respawn monster with rare spawn check
    G.combat.isRareSpawn=(Math.random()<0.005); // 0.5% chance for next spawn
    if(G.combat.isRareSpawn){
      addCombatLog('✨ A SHINY '+monster.name.toUpperCase()+' appears! (2x XP & Loot)','clog-kill');
      notify(`✨ Rare Shiny ${monster.name} spawned!`,'lvl');
      // Track in collection
      G.collection.rares[monster.id]=true;
    }
    
    G.combat.monsterHp=monster.maxHp;
    G.combat.maxMonsterHp=monster.maxHp;
    return;
  }

  // Monster attacks player
  // Block check
  const blocked = Math.random()*100 < stats.blockChance;
  let monsterDmg = Math.max(0, monster.atk - Math.floor(stats.armor/2.5) + Math.floor(Math.random()*3) - 1);
  
  // Apply damage reduction from mastery
  const dmgReduction=1-(getMasteryBonus('combat','defense')/100);
  monsterDmg=Math.floor(monsterDmg*dmgReduction);
  
  if(blocked){ monsterDmg=0; addCombatLog(`🛡️ You block ${monster.name}'s attack!`,'clog-p'); }
  else {
    G.combat.playerHp=Math.max(0,G.combat.playerHp-monsterDmg);
    addCombatLog(`💢 ${monster.name} hits you for ${monsterDmg} damage.`,'clog-mhit');
    // Track that damage was taken this fight (for flawless victory tracking)
    if(monsterDmg>0)G.combat.tookDamageThisFight=true;
  }

  // XP for being hit
  if(monsterDmg>0){
    gainCombatSubXp('defense', Math.floor((3 + Math.floor(monsterDmg*0.4))*xpBonus));
    gainCombatSubXp('hitpoints', Math.floor((2 + Math.floor(monsterDmg*0.25))*xpBonus));
  } else if(blocked){
    gainCombatSubXp('defense', Math.floor(5*xpBonus));
  }

  // Check for death BEFORE auto-eating (prevents unkillable bug)
  if(G.combat.playerHp<=0){
    G.combat.active=false;
    G.combat.playerHp=Math.floor(stats.maxHp/2);
    addCombatLog('💀 You have been defeated! Respawning with half HP...','clog-die');
    notify('⚠️ Combat stopped - You died! Click "Start Combat" to resume.','combat');
    // Stats tracking
    G.stats.deaths++;
    G.stats.monsterKillStreak=0; // Reset streak on death
    renderCombatHP();
    return; // Exit immediately, don't auto-eat
  }

  // Auto-eat if HP < 40% (only happens if still alive)
  // Checks all foods from best to worst to maximize survival
  if(G.combat.playerHp/stats.maxHp<0.4){
    const foods=['cooked_turtle','cooked_manta','cooked_shark','cooked_monkfish','cooked_swordfish','cooked_bass','cooked_lobster','cooked_tuna','cooked_salmon','cooked_trout','cooked_shrimp'];
    for(const f of foods){
      if(G.bank[f]&&G.bank[f]>0){
        const heal=ITEMS[f].heals;
        removeFromBank(f,1);
        G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+heal);
        addCombatLog(`🍖 You eat ${ITEMS[f].name} and heal ${heal} HP.`,'clog-eat');
        // Stats tracking
        G.stats.foodConsumed++;
        break;
      }
    }
  }

  renderCombatHP();
}

function gainCombatSubXp(skill, amount){
  if(!G.skills[skill])return;
  const prev=xpToLevel(G.skills[skill].xp);
  G.skills[skill].xp+=amount;
  const next=xpToLevel(G.skills[skill].xp);
  if(next>prev) checkCombatLvlUp(skill);
}
function checkCombatLvlUp(skill){
  if(!G.skills[skill])return; // Safety check
  const lv=xpToLevel(G.skills[skill].xp);
  const names={attack:'Attack',strength:'Strength',haste:'Haste',defense:'Defense',hitpoints:'Hitpoints',combat:'Combat'};
  notify(`🎉 ${names[skill]||skill} Level Up! Level ${lv}`,'lvl');
  if(currentPage==='stats')renderStatsPage();
  // Re-render combat page if combat level up to show newly unlocked zones/monsters
  if(skill==='combat'&&currentPage==='combat')renderCombatPage();
  // Re-render equipment page to show updated stats
  if(currentPage==='equipment')renderEquipPage();
}

function processSkillTick(skill,actionId){
  const skillActions=ACTIONS[skill];
  if(!skillActions)return;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills[skill].xp);
  if(lv<action.levelReq){stopAction(skill);return;}

  G.actionProgress[skill]=(G.actionProgress[skill]||0)+1;
  const ticks=getMasteryTicks(action,getMasteryLevel(skill,actionId),skill);
  if(G.actionProgress[skill]<ticks)return;
  G.actionProgress[skill]=0;

  // Get trinket once for this function
  const equippedTrinketId=G.equipment.trinket;
  const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;

  // Check materials for production
  if(action.consumes){
    if(!hasMaterials(action.consumes)){
      stopAction(skill);
      notify('Out of materials for '+action.name+'!','info');
      return;
    }
    // Check for trinket save chance (25% for production skills)
    const shouldSave=equippedTrinket&&equippedTrinket.skill===skill&&Math.random()<0.25;
    if(!shouldSave){
      consumeMaterials(action.consumes);
    }
  }

  // Gain XP (with mastery upgrade bonus and trinket bonus)
  const prevLv=xpToLevel(G.skills[skill].xp);
  let xpBonus=1+(getMasteryBonus(skill,'xp')/100);
  // Apply trinket XP bonus (10%)
  if(equippedTrinket&&equippedTrinket.skill===skill){
    xpBonus*=1.1; // 10% XP bonus
  }
  // Apply amulet XP bonus (gathering or artisan)
  const equippedAmuletId=G.equipment.amulet;
  const equippedAmulet=equippedAmuletId?ITEMS[equippedAmuletId]:null;
  if(equippedAmulet&&equippedAmulet.xpBonus){
    const gatheringSkills=['woodcutting','mining','fishing','pickpocketing'];
    const artisanSkills=['cooking','smithing','woodworking','jewelcrafting','prospecting'];
    if(equippedAmulet.amuletType==='gathering'&&gatheringSkills.includes(skill)){
      xpBonus*=1+(equippedAmulet.xpBonus/100);
    }else if(equippedAmulet.amuletType==='artisan'&&artisanSkills.includes(skill)){
      xpBonus*=1+(equippedAmulet.xpBonus/100);
    }
  }
  G.skills[skill].xp+=Math.floor(action.xp*xpBonus);
  const newLv=xpToLevel(G.skills[skill].xp);
  if(newLv>prevLv){
    notify(`🎉 ${skill.charAt(0).toUpperCase()+skill.slice(1)} Level Up! Level ${newLv}`,'lvl');
    // Re-render current page to show newly unlocked actions
    renderSkillPage(skill);
  }

  // Gain mastery XP (with mastery upgrade bonus)
  if(action.masteryXp){
    const prevMlv=getMasteryLevel(skill,actionId);
    const mastBonus=1+(getMasteryBonus(skill,'mastery')/100);
    G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+Math.floor(action.masteryXp*mastBonus);
    const newMlv=getMasteryLevel(skill,actionId);
    if(newMlv>prevMlv)notify(`⭐ ${action.name} Mastery ${newMlv}!`,'lvl');
  }

  // Produce item (with yield bonus)
  if(action.produces){
    let produced=action.produces;
    let qty=action.qty||1;
    // PROSPECTING: chance-based gem production (scales with mastery)
    if(action.gemChance!==undefined){
      const mastLv=getMasteryLevel(skill,actionId);
      // Base chance + mastery scaling + shop upgrade bonus + trinket bonus
      const shopBonus=getMasteryBonus(skill,'success')/100;
      const trinketBonus=(equippedTrinket&&equippedTrinket.skill==='prospecting')?0.15:0;
      const successChance=Math.min(0.97,action.gemChance+(mastLv/99)*0.5+shopBonus+trinketBonus);
      if(Math.random()<successChance){
        addToBank(action.produces,1);
        trackLoot(action.produces,1);
        G.sessionCounts[actionId]=(G.sessionCounts[actionId]||0)+1;
        G.stats.gemsProspected=(G.stats.gemsProspected||0)+1;
      }
      // Skip normal produce logic for prospecting
    } else {
    // Burn chance for cooking (reduced by mastery upgrade)
    if(action.burnChance){
      const skillLv=xpToLevel(G.skills[skill].xp);
      const mastLv=getMasteryLevel(skill,actionId);
      const burnReduction=getMasteryBonus(skill,'success');
      const burnChance=Math.max(0,action.burnChance-(skillLv*0.005)-(mastLv*0.003)-(burnReduction/100));
      if(Math.random()<burnChance){produced=action.burnItem;qty=1;}
    }
    // Apply yield bonus
    const yieldBonus=1+(getMasteryBonus(skill,'yield')/100);
    // Apply trinket bonus (2x for gathering skills)
    if(equippedTrinket&&equippedTrinket.skill===skill){
      // Probabilistic rounding so fractional bonuses work on qty=1 items
      const rawQty=qty*yieldBonus*2;
      qty=Math.floor(rawQty)+(Math.random()<(rawQty%1)?1:0);
    }else{
      // Probabilistic rounding so fractional bonuses work on qty=1 items
      const rawQty=qty*yieldBonus;
      qty=Math.floor(rawQty)+(Math.random()<(rawQty%1)?1:0);
    }
    if(qty<1)qty=1;
    addToBank(produced,qty);
    trackLoot(produced,qty);
    // Increment session count
    G.sessionCounts[actionId]=(G.sessionCounts[actionId]||0)+qty;
    } // end else (non-prospecting produce)
  }
  
  // Gold reward (for pickpocketing)
  if(action.goldReward){
    let goldAmount=action.goldReward;
    // Apply yield bonus (affects gold for pickpocketing)
    const yieldBonus=1+(getMasteryBonus(skill,'yield')/100);
    // Apply trinket bonus (2x for pickpocketing)
    if(equippedTrinket&&equippedTrinket.skill===skill){
      const rawGold=goldAmount*yieldBonus*2;
      goldAmount=Math.floor(rawGold)+(Math.random()<(rawGold%1)?1:0);
    }else{
      const rawGold=goldAmount*yieldBonus;
      goldAmount=Math.floor(rawGold)+(Math.random()<(rawGold%1)?1:0);
    }
    G.gold+=goldAmount;
    trackGold(goldAmount);
    updateHeader();
    // Increment session count for gold earned
    G.sessionCounts[actionId]=(G.sessionCounts[actionId]||0)+goldAmount;
    // Track stats
    G.stats.totalGoldEarned+=goldAmount;
    G.stats.npcsPickpocketed++;
  }
  
  // ========== STATISTICS TRACKING ==========
  G.stats.actionsCompleted++;
  const xpGained=Math.floor(action.xp*xpBonus);
  G.stats.totalXpGained+=xpGained;
  if(xpGained>G.stats.mostXpInOneAction)G.stats.mostXpInOneAction=xpGained;
  
  // Skill-specific stats
  if(skill==='woodcutting')G.stats.logsChopped++;
  else if(skill==='mining')G.stats.oresMined++;
  else if(skill==='fishing')G.stats.fishCaught++;
  else if(skill==='smithing')G.stats.barsSmelted++;
  else if(skill==='cooking')G.stats.itemsCooked++;
  else if(skill==='woodworking')G.stats.itemsCrafted++;
  else if(skill==='prospecting'){G.stats.oresMined++;}
  else if(skill==='jewelcrafting'){G.stats.itemsCrafted++;}
  
  // Collection log - track items obtained
  if(action.produces){
    const item=ITEMS[action.produces];
    if(item){
      if(item.cat==='logs')G.collection.logs[action.produces]=true;
      else if(item.cat==='ore')G.collection.ores[action.produces]=true;
      else if(item.cat==='fish')G.collection.fish[action.produces]=true;
      else if(item.cat==='food')G.collection.food[action.produces]=true;
      else if(item.cat==='bar')G.collection.bars[action.produces]=true;
      else if(item.cat==='gem')G.collection.gems[action.produces]=true;
      else if(item.cat==='jewelry')G.collection.jewelry[action.produces]=true;
      else if(item.cat==='tool')G.collection.tools[action.produces]=true;
    }
  }
  // ========================================
  
  // Trinket drop chance (scales with level: 0.1% + 0.01% per level)
  const trinketMap={woodcutting:'woodcutters_trinket',mining:'miners_trinket',fishing:'fishermans_trinket',smithing:'smiths_trinket',cooking:'chefs_trinket',pickpocketing:'thiefs_trinket',woodworking:'woodworkers_trinket',prospecting:'prospectors_trinket',jewelcrafting:'jewelers_trinket'};
  const skillTrinketId=trinketMap[skill];
  if(skillTrinketId){
    const hasTrinket=G.bank[skillTrinketId]||(G.equipment.trinket===skillTrinketId);
    if(!hasTrinket){
      const dropChance=0.001+(lv*0.0001); // 0.1% base + 0.01% per level
      if(Math.random()<dropChance){
        addToBank(skillTrinketId,1);
        notify(`✨ ${ITEMS[skillTrinketId].name} found!`,'item');
        // Collection log
        G.collection.trinkets[skillTrinketId]=true;
      }
    }
  }
}

function getMasteryTicks(action,mastLv,skill){
  const reduction=Math.floor(mastLv/15);
  // Apply speed bonus from mastery upgrades
  const speedBonus=getMasteryBonus(skill,'speed');
  const speedMult=1-(speedBonus/100);
  const baseTicks=Math.max(2,action.ticks-reduction);
  let ticks=Math.max(2,Math.floor(baseTicks*speedMult));
  // Apply equipped tool speed bonus if tool matches this skill
  const toolId=G.equipment.tool;
  const tool=toolId?ITEMS[toolId]:null;
  if(tool&&tool.cat==='tool'&&tool.skill===skill){
    ticks=Math.max(2,Math.floor(ticks*(1-tool.speedBonus/100)));
  }
  // Apply ring speed bonuses (ring1 + ring2) if ring matches this skill
  const rings=[G.equipment.ring1,G.equipment.ring2];
  for(const ringId of rings){
    const ring=ringId?ITEMS[ringId]:null;
    if(ring&&ring.cat==='jewelry'&&ring.ringSkill===skill){
      ticks=Math.max(2,Math.floor(ticks*(1-ring.speedBonus/100)));
    }
  }
  return ticks;
}

// ============================================================
// MAIN GAME LOOP (600ms tick)
// ============================================================
let tickCount=0;
setInterval(()=>{
  tickCount++;
  
  // ========== TIME TRACKING ==========
  // Update total play time (600ms per tick)
  G.stats.totalPlayTime+=600;
  // Check for longest session (every 30 ticks = 18 seconds)
  if(tickCount%30===0){
    const currentSession=Date.now()-G.stats.sessionStart;
    if(currentSession>G.stats.longestSession){
      G.stats.longestSession=currentSession;
    }
  }
  // ====================================
  
  // Process skill actions
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue; // Skip - handled separately below
    processSkillTick(skill,actionId);
  }
  // Process smithing crafts
  if(G.activeActions['smithingCraft']){
    processCraftTick(G.activeActions['smithingCraft']);
  }
  // Process combat
  if(G.combat.active)processCombatTick();
  // Update HP regen (out of combat: 1 HP per 10 ticks)
  if(!G.combat.active){
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp<stats.maxHp&&tickCount%10===0){
      G.combat.playerHp=Math.min(stats.maxHp,G.combat.playerHp+1);
    }
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  }
  // Render updates
  updateProgressBars();
  updateHeader();
  sampleXpRate();
  sampleTrackerXp();
  updateActiveActionDisplay();
  if(G.tracker?.open)updateTrackerPanel();
  updateSessionCounts(); // Update live session counts
  updateCraftableCounts(); // Update "Can make" counts
  if(getCurrentPage()==='combat')renderCombatHP();
  // Update statistics page every 5 ticks (3 seconds) if viewing it
  if(tickCount%5===0 && getCurrentPage()==='statistics')renderStatisticsPage();
  // Update collection page every 10 ticks (6 seconds) if viewing it
  if(tickCount%10===0 && getCurrentPage()==='collection')renderCollectionPage();
  // Note: renderBank(), renderEquipPage(), and renderStatsPage() are no longer called every tick
  // They are only called when content actually changes (items added/removed, equipment changed, etc.)
  // This prevents hover state blinking and improves performance
  // Auto-save every 30 ticks (~18s)
  if(tickCount%30===0)saveGame();
},600);

function updateSessionCounts(){
  // Update session count displays on skill pages
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    const count=G.sessionCounts[actionId]||0;
    const countEl=document.getElementById(`session-count-${actionId}`);
    if(countEl){
      if(count>0){
        // Check if this is pickpocketing to add gold formatting
        const isPickpocketing=skill==='pickpocketing';
        countEl.textContent='('+(isPickpocketing?'💰 ':'')+fmt(count)+(isPickpocketing?'gp':'')+')';
        countEl.style.display='inline';
      }else{
        countEl.style.display='none';
      }
    }
  }
}

function updateCraftableCounts(){
  // Update "Can make" counts on skill pages
  const currentSkill=getCurrentPage();
  if(!['cooking','smithing','woodworking','prospecting','jewelcrafting'].includes(currentSkill))return;
  
  const actions=currentSkill==='smithing'?[...ACTIONS.smithing,...ACTIONS.smithingCraft]:ACTIONS[currentSkill];
  if(!actions)return;
  
  for(const action of actions){
    if(!action.consumes)continue; // Skip actions that don't require materials
    
    const craftableCount=getCraftableCount(action.consumes);
    const countEl=document.getElementById(`can-make-${action.id}`);
    const statEl=document.getElementById(`can-make-stat-${action.id}`);
    
    if(countEl){
      countEl.textContent=fmt(craftableCount);
    }
    if(statEl){
      if(craftableCount>0){
        statEl.style.display='';
      }else{
        statEl.style.display='none';
      }
    }
  }
}

let smithingCraftAction=null;
let smithingCraftProgress=0;
function startCraft(actionId){
  const action=ACTIONS.smithingCraft.find(a=>a.id===actionId);
  if(!action)return;
  if(!G.skills.smithing){
    G.skills.smithing={xp:0,masteryXp:{}};
  }
  const lv=xpToLevel(G.skills.smithing.xp);
  if(lv<action.levelReq){notify('Level '+action.levelReq+' Smithing required.','info');return;}
  if(!hasMaterials(action.consumes)){notify('Not enough materials!','info');return;}
  stopAllActions(); // Stop everything else
  smithingCraftAction=action;
  smithingCraftProgress=0;
  G.activeActions['smithingCraft']=actionId; // Mark as active
  G.sessionCounts[actionId]=0; // Reset session count
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function stopCraft(){
  smithingCraftAction=null;
  smithingCraftProgress=0;
  delete G.activeActions['smithingCraft'];
  updateActiveActionDisplay();
  renderSkillPage('smithing');
}
function processCraftTick(id){
  if(!smithingCraftAction||smithingCraftAction.id!==id)return;
  smithingCraftProgress++;
  
  // Apply speed bonus
  const speedBonus=getMasteryBonus('smithing','speed');
  const speedMult=1-(speedBonus/100);
  const adjustedTicks=Math.max(2,Math.floor(smithingCraftAction.ticks*speedMult));
  
  if(smithingCraftProgress<adjustedTicks)return;
  smithingCraftProgress=0;
  if(!hasMaterials(smithingCraftAction.consumes)){
    stopCraft();
    notify('Out of materials!','info');
    return;
  }
  // Check for trinket save chance (25% for smithing)
  const trinketId=G.equipment.trinket;
  const trinket=trinketId?ITEMS[trinketId]:null;
  const shouldSave=trinket&&trinket.skill==='smithing'&&Math.random()<0.25;
  if(!shouldSave){
    consumeMaterials(smithingCraftAction.consumes);
  }
  const prevLv=xpToLevel(G.skills.smithing.xp);
  
  // Apply XP bonus (with trinket)
  let xpBonus=1+(getMasteryBonus('smithing','xp')/100);
  if(trinket&&trinket.skill==='smithing'){
    xpBonus*=1.1; // 10% XP bonus
  }
  G.skills.smithing.xp+=Math.floor(smithingCraftAction.xp*xpBonus);
  
  const newLv=xpToLevel(G.skills.smithing.xp);
  if(newLv>prevLv){
    notify(`🎉 Blacksmithing Level Up! Level ${newLv}`,'lvl');
    // Re-render smithing page to show newly unlocked crafts
    if(currentPage==='smithing')renderSkillPage('smithing');
  }
  
  // Apply yield bonus
  const yieldBonus=1+(getMasteryBonus('smithing','yield')/100);
  const qty=Math.max(1,Math.floor(smithingCraftAction.qty*yieldBonus));
  addToBank(smithingCraftAction.produces,qty);
  trackLoot(smithingCraftAction.produces,qty);
  // Increment session count
  G.sessionCounts[id]=(G.sessionCounts[id]||0)+qty;
  
  // ========== STATISTICS TRACKING ==========
  G.stats.actionsCompleted++;
  G.stats.itemsCrafted+=qty;
  const xpGained=Math.floor(smithingCraftAction.xp*xpBonus);
  G.stats.totalXpGained+=xpGained;
  if(xpGained>G.stats.mostXpInOneAction)G.stats.mostXpInOneAction=xpGained;
  
  // Collection log - track crafted equipment
  const item=ITEMS[smithingCraftAction.produces];
  if(item&&(item.cat==='weapon'||item.cat==='armor')){
    G.collection.equipment[smithingCraftAction.produces]=true;
  }
  // ========================================
  
  // Trinket drop chance (only if player doesn't have it in bank or equipped)
  const hasSmithsTrinket=G.bank['smiths_trinket']||(G.equipment.trinket==='smiths_trinket');
  if(!hasSmithsTrinket){
    const lv=xpToLevel(G.skills.smithing.xp);
    const dropChance=0.001+(lv*0.0001);
    if(Math.random()<dropChance){
      addToBank('smiths_trinket',1);
      notify(`✨ ${ITEMS['smiths_trinket'].name} found!`,'item');
      // Collection log
      G.collection.trinkets['smiths_trinket']=true;
    }
  }
}
// Override to handle smithingCraft special case
const _origActiveActions=G.activeActions;
G.activeActions=new Proxy(_origActiveActions,{
  set(t,k,v){
    if(k==='smithingCraft'){smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===v);smithingCraftProgress=0;t[k]=v;return true;}
    return Reflect.set(t,k,v);
  },
  deleteProperty(t,k){
    if(k==='smithingCraft'){smithingCraftAction=null;smithingCraftProgress=0;}
    return Reflect.deleteProperty(t,k);
  }
});

// ============================================================
// SAVE / LOAD
// ============================================================
async function saveGame(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  // Remove non-serializable
  try{
    await window.storage.set('grindia_save',JSON.stringify(data));
  }catch(e){try{localStorage.setItem('grindia_save',JSON.stringify(data));}catch(e2){}}
}
async function loadGame(){
  try{
    let raw=null;
    try{const r=await window.storage.get('grindia_save');if(r)raw=r.value;}catch(e){}
    if(!raw)try{raw=localStorage.getItem('grindia_save');}catch(e){}
    if(!raw)return false;
    const saved=JSON.parse(raw);
    
    // VERSION MIGRATION: Handle saves from older versions
    const savedVersion = saved.version || 1;
    if(savedVersion < GAME_VERSION){
      console.log(`Migrating save from v${savedVersion} to v${GAME_VERSION}`);
      // v1 -> v2: Added attack/strength/haste/defense/hitpoints skills
      if(savedVersion < 2){
        // Initialize new combat skills if they don't exist
        if(!saved.skills.attack)saved.skills.attack={xp:0,masteryXp:{}};
        if(!saved.skills.strength)saved.skills.strength={xp:0,masteryXp:{}};
        if(!saved.skills.haste)saved.skills.haste={xp:0,masteryXp:{}};
        if(!saved.skills.defense)saved.skills.defense={xp:0,masteryXp:{}};
        if(!saved.skills.hitpoints)saved.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}}; // Start at lv 10
      }
      // v2 -> v3: Added woodworking skill + tool equipment slot
      if(savedVersion < 3){
        if(!saved.skills.woodworking)saved.skills.woodworking={xp:0,masteryXp:{}};
        if(saved.equipment&&saved.equipment.tool===undefined)saved.equipment.tool=null;
      }
      // v3 -> v4: Added prospecting + jewelcrafting skills + amulet/ring1/ring2 equipment slots
      if(savedVersion < 4){
        if(!saved.skills.prospecting)saved.skills.prospecting={xp:0,masteryXp:{}};
        if(!saved.skills.jewelcrafting)saved.skills.jewelcrafting={xp:0,masteryXp:{}};
        if(saved.equipment){
          if(saved.equipment.amulet===undefined)saved.equipment.amulet=null;
          if(saved.equipment.ring1===undefined)saved.equipment.ring1=null;
          if(saved.equipment.ring2===undefined)saved.equipment.ring2=null;
        }
      }
      // v4 -> v5: Removed firemaking skill + all related items (tinders, ring_of_ember, trinket)
      if(savedVersion < 5){
        // Remove firemaking skill from saves
        if(saved.skills)delete saved.skills.firemaking;
        // Stop any active firemaking action
        if(saved.activeActions&&saved.activeActions.firemaking)delete saved.activeActions.firemaking;
        // Clear equipped items that no longer exist
        const removedItems=new Set(['firemakers_trinket','ring_of_ember',
          'graveliron_tinder','emberguard_tinder','brightmail_tinder','grimforge_tinder',
          'moonweave_tinder','sungilt_tinder','stormcast_tinder','duskwarden_tinder']);
        if(saved.equipment){
          for(const slot of Object.keys(saved.equipment)){
            if(removedItems.has(saved.equipment[slot]))saved.equipment[slot]=null;
          }
        }
        // Remove deleted items from bank
        if(saved.bank){
          for(const itemId of removedItems)delete saved.bank[itemId];
        }
        // Remove firemaking mastery upgrades
        if(saved.masteryUpgrades){
          for(const key of Object.keys(saved.masteryUpgrades)){
            if(key.startsWith('firemaking_'))delete saved.masteryUpgrades[key];
          }
        }
        // Reset mastery tab if it was on firemaking
        if(saved.currentMasteryTab==='firemaking')saved.currentMasteryTab='woodcutting';
      }
      saved.version = GAME_VERSION;
    }
    
    // Offline progress
    const now=Date.now();
    const elapsedMs=Math.max(0,now-(saved.lastSave||now));
    const elapsedTicks=Math.min(Math.floor(elapsedMs/600),48000); // cap 8h
    // Merge saved state (don't overwrite new skills that didn't exist in old save)
    G.version = GAME_VERSION;
    if(saved.skills){
      for(const k of Object.keys(G.skills)){
        if(saved.skills[k])G.skills[k]=saved.skills[k];
      }
    }
    G.bank=saved.bank||{};
    G.gold=saved.gold||0;
    G.equipment=saved.equipment||G.equipment;
    // Ensure new equipment slots exist for old saves
    if(!G.equipment.gloves)G.equipment.gloves=null;
    if(!G.equipment.boots)G.equipment.boots=null;
    if(G.equipment.tool===undefined)G.equipment.tool=null;
    if(G.equipment.amulet===undefined)G.equipment.amulet=null;
    if(G.equipment.ring1===undefined)G.equipment.ring1=null;
    if(G.equipment.ring2===undefined)G.equipment.ring2=null;
    G.combat={...G.combat,...(saved.combat||{})};
    // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
    for(const k of Object.keys(G.activeActions)){
      delete G.activeActions[k];
    }
    if(saved.activeActions){
      for(const [k,v] of Object.entries(saved.activeActions)){
        G.activeActions[k]=v; // This triggers the Proxy set handler
      }
    }
    G.actionProgress=saved.actionProgress||{};
    G.contracts=saved.contracts||[];
    G.contractsLastRefresh=saved.contractsLastRefresh||Date.now(); // Set to now if not present to avoid immediate refresh
    G.masteryUpgrades=saved.masteryUpgrades||{};
    G.infusion=saved.infusion||{};
    G.bankOrder=saved.bankOrder||[];
    G.selectedZone=saved.selectedZone||'forest';
    G.currentMasteryTab=saved.currentMasteryTab||'woodcutting';
    
    // Load new systems (backward compatible)
    G.stats=saved.stats||G.stats;
    G.collection=saved.collection||G.collection;
    // Ensure new collection categories exist on old saves
    if(!G.collection.gems)G.collection.gems={};
    if(!G.collection.jewelry)G.collection.jewelry={};
    if(!G.collection.tools)G.collection.tools={};
    G.achievements=saved.achievements||G.achievements;
    G.equippedBadge=saved.equippedBadge||null;
    
    // ========== COLLECTION LOG MIGRATION ==========
    // For old saves: scan bank and populate collection retroactively
    // This ensures players get credit for items they already own
    if(!saved.collection || Object.keys(saved.collection.logs||{}).length===0){
      // This is an old save without collection tracking
      // Scan bank and add everything to collection
      for(const itemId in G.bank){
        if(G.bank[itemId]>0 && ITEMS[itemId]){
          const item=ITEMS[itemId];
          // Add to appropriate collection category
          if(item.cat==='logs')G.collection.logs[itemId]=true;
          if(item.cat==='ore')G.collection.ores[itemId]=true;
          if(item.cat==='fish')G.collection.fish[itemId]=true;
          if(item.cat==='food')G.collection.food[itemId]=true;
          if(item.cat==='bar')G.collection.bars[itemId]=true;
          if(item.cat==='weapon'||item.cat==='armor')G.collection.equipment[itemId]=true;
          if(item.cat==='gem')G.collection.gems[itemId]=true;
          if(item.cat==='jewelry')G.collection.jewelry[itemId]=true;
          if(item.cat==='trinket')G.collection.trinkets[itemId]=true;
          if(item.cat==='tool')G.collection.tools[itemId]=true;
        }
      }
      // Also scan equipped items (they might not be in bank)
      for(const slot in G.equipment){
        const itemId=G.equipment[slot];
        if(itemId && ITEMS[itemId]){
          const item=ITEMS[itemId];
          if(item.cat==='weapon'||item.cat==='armor')G.collection.equipment[itemId]=true;
          if(item.cat==='gem')G.collection.gems[itemId]=true;
          if(item.cat==='jewelry')G.collection.jewelry[itemId]=true;
          if(item.cat==='trinket')G.collection.trinkets[itemId]=true;
          if(item.cat==='tool')G.collection.tools[itemId]=true;
        }
      }
    }
    
    // ========== STATS MIGRATION (Fix negative net worth) ==========
    // For old saves: if totalGoldEarned is 0 but player has gold, initialize it
    // This prevents showing negative net worth for existing players
    if(!saved.stats && G.gold>0){
      // This is an old save without stats tracking
      // Estimate totalGoldEarned based on current gold + gear value
      let estimatedEarned=G.gold;
      
      // Add value of equipped items
      for(const slot in G.equipment){
        const itemId=G.equipment[slot];
        if(itemId && ITEMS[itemId] && ITEMS[itemId].value){
          estimatedEarned+=ITEMS[itemId].value;
        }
      }
      
      // Add value of banked items
      for(const itemId in G.bank){
        if(ITEMS[itemId] && ITEMS[itemId].value && G.bank[itemId]>0){
          estimatedEarned+=ITEMS[itemId].value*G.bank[itemId];
        }
      }
      
      // Set totalGoldEarned to prevent negative net worth
      // This is a conservative estimate (doesn't count sold/consumed items)
      G.stats.totalGoldEarned=Math.max(estimatedEarned, G.gold);
    }
    // =============================================
    
    // Initialize stats session start if loading saved game
    if(saved.stats)G.stats.sessionStart=Date.now();
    
    // Migrate missing stats fields for existing saves
    if(G.stats.contractsCompleted===undefined)G.stats.contractsCompleted=0;
    if(G.stats.contractXpGained===undefined)G.stats.contractXpGained=0;
    if(G.masteryResets===undefined)G.masteryResets=0;
    if(G.masteryLastReset===undefined)G.masteryLastReset=0;
    
    // Restore smithingCraft
    if(G.activeActions.smithingCraft){
      smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
    }
    // Validate HP
    const stats=getPlayerStats();
    G.combat.maxHp=stats.maxHp;
    if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
    // Offline ticks simulation
    if(elapsedTicks>0){
      // Track offline time
      G.stats.totalPlayTime+=elapsedMs;
      if(elapsedMs>G.stats.longestSession){
        G.stats.longestSession=elapsedMs;
      }
      
      const results=simulateOffline(elapsedTicks);
      const hrs=Math.floor(elapsedMs/3600000);
      const mins=Math.floor((elapsedMs%3600000)/60000);
      
      // Check if results is combat data object or skill data object
      if(results&&results.type==='combat'){
        G.offlineBanner={time:`${hrs}h ${mins}m`,combat:results};
      }else if(results&&results.type==='skill'){
        G.offlineBanner={time:`${hrs}h ${mins}m`,skill:results};
      }
    }
    return true;
  }catch(e){console.error('Load failed',e);return false;}
}
function simulateOffline(ticks){
  const results=[];
  
  // Check if combat is active first
  if(G.combat.active){
    const offlineTicks=Math.floor(ticks*0.75); // 75% effectiveness (25% penalty)
    const stats=getPlayerStats();
    const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
    if(monster){
      const equippedTrinketId=G.equipment.trinket;
      const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
      const hasCombatTrinket=equippedTrinket&&equippedTrinket.skill==='combat';
      
      // Track detailed stats
      let kills=0;
      let totalGold=0;
      let totalDmgDealt=0;
      let highestHit=0;
      let lootItems={}; // {itemId: qty}
      let foodUsed={}; // {foodId: qty}
      let flawlessKills=0; // kills without taking damage
      let tookDamageThisFight=false; // reset each kill
      
      // Track starting levels for each skill (combat is calculated, not tracked)
      const startLevels={
        attack:xpToLevel(G.skills.attack?.xp||0),
        strength:xpToLevel(G.skills.strength?.xp||0),
        haste:xpToLevel(G.skills.haste?.xp||0),
        defense:xpToLevel(G.skills.defense?.xp||0),
        hitpoints:xpToLevel(G.skills.hitpoints?.xp||XP_TABLE[9])
      };
      
      // Track XP gained (combat is calculated, not tracked)
      let xpGained={attack:0,strength:0,haste:0,defense:0,hitpoints:0};
      
      // Simulate combat turn by turn
      let currentHp=G.combat.playerHp;
      let currentMonsterHp=G.combat.monsterHp||monster.maxHp;
      let ticksProcessed=0;
      
      const xpBonus=1+(getMasteryBonus('combat','xp')/100);
      const finalXpBonus=hasCombatTrinket?xpBonus*1.1:xpBonus;
      const dropBonus=getMasteryBonus('combat','drops')/100;
      const trinketBonus=hasCombatTrinket?0.1:0;
      const dmgBonus=1+(getMasteryBonus('combat','damage')/100);
      const dmgReduction=1-(getMasteryBonus('combat','defense')/100);
      
      while(ticksProcessed<offlineTicks){
        // Player attacks every attackTicks
        if(ticksProcessed%stats.attackTicks===0){
          // Player damage
          const isCrit=Math.random()*100<stats.critChance;
          let playerDmg=Math.max(1,stats.atk-Math.floor(monster.def/2)+Math.floor(Math.random()*4)-1+stats.power);
          if(isCrit)playerDmg=Math.floor(playerDmg*1.5);
          playerDmg=Math.floor(playerDmg*dmgBonus);
          
          currentMonsterHp-=playerDmg;
          totalDmgDealt+=playerDmg;
          if(playerDmg>highestHit)highestHit=playerDmg;
          // XP for hitting (defense and HP now gain XP on hit too)
          const hitXp={
            attack:Math.floor((4+Math.floor(monster.xp*0.15))*finalXpBonus),
            strength:Math.floor(Math.max(1,Math.floor(playerDmg*0.5)+2)*finalXpBonus),
            haste:Math.floor((2+Math.floor(monster.xp*0.08))*finalXpBonus),
            defense:Math.floor((3+Math.floor(monster.xp*0.1))*finalXpBonus),
            hitpoints:Math.floor((2+Math.floor(monster.xp*0.12))*finalXpBonus)
          };
          xpGained.attack+=hitXp.attack;
          xpGained.strength+=hitXp.strength;
          xpGained.haste+=hitXp.haste;
          xpGained.defense+=hitXp.defense;
          xpGained.hitpoints+=hitXp.hitpoints;
          
          // Monster killed
          if(currentMonsterHp<=0){
            kills++;
            if(!tookDamageThisFight)flawlessKills++;
            tookDamageThisFight=false; // reset for next fight
            const killXp=monster.xp;
            xpGained.attack+=Math.floor(killXp*0.2*finalXpBonus);
            xpGained.strength+=Math.floor(killXp*0.2*finalXpBonus);
            xpGained.haste+=Math.floor(killXp*0.1*finalXpBonus);
            xpGained.defense+=Math.floor(killXp*0.1*finalXpBonus);
            xpGained.hitpoints+=Math.floor(killXp*0.15*finalXpBonus);
            // Combat is now a calculated level, not trained
            
            // Loot
            for(const drop of monster.drops){
              if(drop.gold){
                let gAmt=drop.gold[0]+Math.floor(Math.random()*(drop.gold[1]-drop.gold[0]+1));
                if(trinketBonus>0)gAmt=Math.floor(gAmt*(1+trinketBonus));
                totalGold+=gAmt;
              }else{
                const dropChance=Math.min(1,drop.chance+dropBonus+trinketBonus);
                if(Math.random()<dropChance){
                  lootItems[drop.item]=(lootItems[drop.item]||0)+drop.qty;
                }
              }
            }
            
            // Combat mastery XP (50 per kill, same as online)
            if(!G.skills.combat.masteryXp[monster.id])G.skills.combat.masteryXp[monster.id]=0;
            G.skills.combat.masteryXp[monster.id]+=50;
            
            // Brawlers trinket drop chance (same as online)
            const hasBrawlersTrinket=G.bank['brawlers_trinket']||(G.equipment.trinket==='brawlers_trinket');
            if(!hasBrawlersTrinket){
              const atkLv=xpToLevel(G.skills.attack.xp||0);
              const strLv=xpToLevel(G.skills.strength.xp||0);
              const hasteLv=xpToLevel(G.skills.haste.xp||0);
              const defLv=xpToLevel(G.skills.defense.xp||0);
              const hpLv=xpToLevel(G.skills.hitpoints.xp||0);
              const combatLv=Math.floor((atkLv+strLv+hasteLv+defLv+hpLv)/5);
              const trinketDrop=0.001+(combatLv*0.0001);
              if(Math.random()<trinketDrop){
                addToBank('brawlers_trinket',1);
                G.collection.trinkets['brawlers_trinket']=true;
              }
            }
            
            // Heal 12% of max HP on kill (balanced to make food essential)
            const healAmount=Math.floor(stats.maxHp*0.12);
            currentHp=Math.min(stats.maxHp, currentHp+healAmount);
            
            // Reset monster
            currentMonsterHp=monster.maxHp;
            continue; // Monster died — skip counter-attack this tick
          }
          
          // Monster counter-attack
          const blocked=Math.random()*100<stats.blockChance;
          let monsterDmg=Math.max(0,monster.atk-Math.floor(stats.armor/2.5)+Math.floor(Math.random()*3)-1);
          monsterDmg=Math.floor(monsterDmg*dmgReduction);
          if(blocked)monsterDmg=0;
          
          currentHp-=monsterDmg;
          
          // Being-hit XP (Defense and Hitpoints gain bonus XP when struck, matching online)
          if(monsterDmg>0){
            tookDamageThisFight=true;
            xpGained.defense+=Math.floor((3+Math.floor(monsterDmg*0.4))*finalXpBonus);
            xpGained.hitpoints+=Math.floor((2+Math.floor(monsterDmg*0.25))*finalXpBonus);
          }
          
          // Check if player died BEFORE auto-eating (prevents unkillable bug)
          if(currentHp<=0){
            // Player dies - stop combat
            G.combat.active=false;
            G.combat.playerHp=Math.floor(stats.maxHp/2);
            G.stats.deaths++;
            G.stats.monsterKillStreak=0; // Reset streak on death
            break;
          }
          
          // Auto-eat if HP < 40% (only if still alive)
          // Checks all foods from best to worst to maximize survival
          if(currentHp/stats.maxHp<0.4){
            const foods=['cooked_turtle','cooked_manta','cooked_shark','cooked_monkfish','cooked_swordfish','cooked_bass','cooked_lobster','cooked_tuna','cooked_salmon','cooked_trout','cooked_shrimp'];
            for(const f of foods){
              if(G.bank[f]&&G.bank[f]>0){
                const heal=ITEMS[f].heals;
                removeFromBank(f,1);
                foodUsed[f]=(foodUsed[f]||0)+1;
                currentHp=Math.min(stats.maxHp,currentHp+heal);
                break;
              }
            }
          }
        }
        
        ticksProcessed++;
      }
      
      // Apply all XP gains
      if(!G.skills.attack)G.skills.attack={xp:0,masteryXp:{}};
      if(!G.skills.strength)G.skills.strength={xp:0,masteryXp:{}};
      if(!G.skills.haste)G.skills.haste={xp:0,masteryXp:{}};
      if(!G.skills.defense)G.skills.defense={xp:0,masteryXp:{}};
      if(!G.skills.hitpoints)G.skills.hitpoints={xp:XP_TABLE[9],masteryXp:{}};
      if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}}; // Keep for backward compatibility
      
      G.skills.attack.xp+=xpGained.attack;
      G.skills.strength.xp+=xpGained.strength;
      G.skills.haste.xp+=xpGained.haste;
      G.skills.defense.xp+=xpGained.defense;
      G.skills.hitpoints.xp+=xpGained.hitpoints;
      // Combat is now a calculated level, not trained
      
      // Apply loot
      G.gold+=totalGold;
      for(const [itemId,qty] of Object.entries(lootItems)){
        addToBank(itemId,qty);
      }
      
      // Calculate levels gained (combat is now calculated, not tracked)
      const levelsGained={};
      for(const skill of ['attack','strength','haste','defense','hitpoints']){
        const endLevel=xpToLevel(G.skills[skill].xp);
        const gained=endLevel-startLevels[skill];
        if(gained>0)levelsGained[skill]={start:startLevels[skill],end:endLevel};
      }
      
      // Update player HP
      G.combat.playerHp=currentHp;
      G.combat.monsterHp=currentMonsterHp;
      
      // ========== OFFLINE STATS TRACKING ==========
      G.stats.monstersDefeated+=kills;
      G.stats.monsterKillStreak+=kills; // Add to streak (will be reset if died)
      G.stats.totalGoldEarned+=totalGold;
      G.stats.totalDamageDealt+=totalDmgDealt;
      if(highestHit>G.stats.highestHit)G.stats.highestHit=highestHit;
      G.stats.totalXpGained+=(xpGained.attack+xpGained.strength+xpGained.haste+xpGained.defense+xpGained.hitpoints);
      G.stats.flawlessVictories+=flawlessKills;
      // Food consumed tracking
      for(const foodId in foodUsed){
        G.stats.foodConsumed+=foodUsed[foodId];
      }
      // =============================================
      
      // Build detailed results object
      return {
        type:'combat',
        kills,
        monster:monster.name,
        gold:totalGold,
        loot:lootItems,
        xp:xpGained,
        levels:levelsGained,
        food:foodUsed,
        died:G.combat.active===false
      };
    }
  }
  
  // Only process the first active action (one at a time)
  const activeEntries=Object.entries(G.activeActions);
  if(activeEntries.length===0)return results;
  
  const [skill,actionId]=activeEntries[0];
  
  // Track detailed stats for all skills
  // Fix startLevel for smithingCraft (maps to smithing skill)
  const skillKey=skill==='smithingCraft'?'smithing':skill;
  const startLevel=xpToLevel(G.skills[skillKey]?.xp||0);
  let xpGained=0;
  let materialsUsed={};
  let itemsProduced={};
  
  if(skill==='smithingCraft'){
    // Handle smithing craft separately
    if(smithingCraftAction){
      const completions=Math.floor(ticks/smithingCraftAction.ticks);
      let produced=0;
      for(let i=0;i<completions;i++){
        if(!hasMaterials(smithingCraftAction.consumes))break;
        // Track materials
        for(const [matId,qty] of Object.entries(smithingCraftAction.consumes)){
          materialsUsed[matId]=(materialsUsed[matId]||0)+qty;
        }
        consumeMaterials(smithingCraftAction.consumes);
        G.skills.smithing.xp+=smithingCraftAction.xp;
        xpGained+=smithingCraftAction.xp;
        addToBank(smithingCraftAction.produces,smithingCraftAction.qty||1);
        itemsProduced[smithingCraftAction.produces]=(itemsProduced[smithingCraftAction.produces]||0)+(smithingCraftAction.qty||1);
        produced++;
      }
      
      const endLevel=xpToLevel(G.skills.smithing.xp);
      
      // ========== OFFLINE STATS TRACKING - smithingCraft ==========
      G.stats.actionsCompleted+=produced;
      G.stats.totalXpGained+=xpGained;
      if(smithingCraftAction.xp>G.stats.mostXpInOneAction)G.stats.mostXpInOneAction=smithingCraftAction.xp;
      G.stats.itemsCrafted+=produced*(smithingCraftAction.qty||1);
      // ============================================================
      
      return {
        type:'skill',
        skill:'smithing',
        action:smithingCraftAction.name,
        xpGained,
        startLevel,
        endLevel,
        materialsUsed,
        itemsProduced
      };
    }
    return results;
  }
  
  const skillActions=ACTIONS[skill];
  if(!skillActions)return results;
  const action=skillActions.find(a=>a.id===actionId);
  if(!action)return results;
  const mastLv=getMasteryLevel(skill,actionId);
  const actionTicks=getMasteryTicks(action,mastLv,skill);
  const completions=Math.floor(ticks/actionTicks);
  if(completions<=0)return results;
  
  let produced=0;
  for(let i=0;i<completions;i++){
    if(action.consumes){
      if(!hasMaterials(action.consumes))break;
      // Track materials
      for(const [matId,qty] of Object.entries(action.consumes)){
        materialsUsed[matId]=(materialsUsed[matId]||0)+qty;
      }
      consumeMaterials(action.consumes);
    }
    G.skills[skill].xp+=action.xp;
    xpGained+=action.xp;
    if(action.masteryXp){const mastBonus=1+(getMasteryBonus(skill,'mastery')/100);G.skills[skill].masteryXp[actionId]=(G.skills[skill].masteryXp[actionId]||0)+Math.floor(action.masteryXp*mastBonus);}
    if(action.produces){
      // PROSPECTING: chance-based gem production (same formula as online)
      if(action.gemChance!==undefined){
        const shopBonus=getMasteryBonus(skill,'success')/100;
        const equippedTrinketId=G.equipment.trinket;
        const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
        const trinketBonus=(equippedTrinket&&equippedTrinket.skill==='prospecting')?0.15:0;
        const successChance=Math.min(0.97,action.gemChance+(mastLv/99)*0.5+shopBonus+trinketBonus);
        if(Math.random()<successChance){
          addToBank(action.produces,1);
          itemsProduced[action.produces]=(itemsProduced[action.produces]||0)+1;
          G.stats.gemsProspected=(G.stats.gemsProspected||0)+1;
        }
        produced++;
      } else {
        let p=action.produces;
        let qty=action.qty||1;
        
        // Burn chance for cooking (same formula as online)
        if(action.burnChance){
          const skillLv=xpToLevel(G.skills[skill].xp);
          const burnReduction=getMasteryBonus(skill,'success');
          const burnChance=Math.max(0,action.burnChance-(skillLv*0.005)-(mastLv*0.003)-(burnReduction/100));
          if(Math.random()<burnChance){
            p=action.burnItem;
            qty=1;
          }
        }
        
        // Apply yield bonus (same as online)
        if(!action.burnChance || p!==action.burnItem){
          const yieldBonus=1+(getMasteryBonus(skill,'yield')/100);
          const equippedTrinketId=G.equipment.trinket;
          const equippedTrinket=equippedTrinketId?ITEMS[equippedTrinketId]:null;
          if(equippedTrinket&&equippedTrinket.skill===skill){
            qty=Math.floor(qty*yieldBonus*2);
          }else{
            qty=Math.floor(qty*yieldBonus);
          }
          if(qty<1)qty=1;
        }
        
        addToBank(p,qty);
        if(p)itemsProduced[p]=(itemsProduced[p]||0)+qty;
        produced++;
      }
    }
    // Gold reward (for pickpocketing)
    if(action.goldReward){
      G.gold+=action.goldReward;
      produced++;
    }
  }
  
  const endLevel=xpToLevel(G.skills[skill].xp);
  
  // ========== OFFLINE TRINKET DROP ==========
  const offlineTrinketMap={woodcutting:'woodcutters_trinket',mining:'miners_trinket',fishing:'fishermans_trinket',smithing:'smiths_trinket',cooking:'chefs_trinket',pickpocketing:'thiefs_trinket',woodworking:'woodworkers_trinket',prospecting:'prospectors_trinket',jewelcrafting:'jewelers_trinket'};
  const offlineTrinketId=offlineTrinketMap[skill];
  if(offlineTrinketId){
    const hasTrinket=G.bank[offlineTrinketId]||(G.equipment.trinket===offlineTrinketId);
    if(!hasTrinket){
      const lv=endLevel;
      const dropChance=(0.001+(lv*0.0001))*produced; // Scale by completions for fair offline parity
      if(Math.random()<dropChance){
        addToBank(offlineTrinketId,1);
        G.collection.trinkets[offlineTrinketId]=true;
      }
    }
  }
  // ==========================================
  
  // ========== OFFLINE STATS TRACKING ==========
  G.stats.actionsCompleted+=produced;
  G.stats.totalXpGained+=xpGained;
  if(action.xp>G.stats.mostXpInOneAction)G.stats.mostXpInOneAction=action.xp;
  
  // Skill-specific stats
  if(skill==='woodcutting')G.stats.logsChopped+=produced;
  if(skill==='mining')G.stats.oresMined+=produced;
  if(skill==='fishing')G.stats.fishCaught+=produced;
  if(skill==='smithing')G.stats.barsSmelted+=produced;
  if(skill==='cooking')G.stats.itemsCooked+=produced;
  if(skill==='woodworking')G.stats.itemsCrafted+=produced;
  if(skill==='prospecting')G.stats.oresMined+=produced; // ore consumed each attempt
  if(skill==='jewelcrafting')G.stats.itemsCrafted+=produced;
  if(skill==='pickpocketing'){
    G.stats.npcsPickpocketed+=produced;
    if(action.goldReward)G.stats.totalGoldEarned+=(action.goldReward*completions);
  }
  // =============================================
  
  // Return detailed object instead of string array
  return {
    type:'skill',
    skill,
    action:action.name,
    xpGained,
    startLevel,
    endLevel,
    materialsUsed,
    itemsProduced,
    goldGained:action.goldReward?action.goldReward*completions:0
  };
}
function manualSave(){saveGame();notify('Game saved!','info');}

function exportSave(){
  const data={...G,activeActions:{...G.activeActions},lastSave:Date.now()};
  const json=JSON.stringify(data,null,2);
  const blob=new Blob([json],{type:'application/json'});
  const url=URL.createObjectURL(blob);
  const a=document.createElement('a');
  a.href=url;
  a.download=`grindia-save-${new Date().toISOString().split('T')[0]}.json`;
  a.click();
  URL.revokeObjectURL(url);
  notify('Save exported!','info');
}

function importSave(){
  const input=document.createElement('input');
  input.type='file';
  input.accept='application/json';
  input.onchange=async(e)=>{
    const file=e.target.files[0];
    if(!file)return;
    try{
      const text=await file.text();
      const imported=JSON.parse(text);
      
      // Validate it's a Grindia save
      if(!imported.skills||!imported.bank){
        notify('Invalid save file!','combat');
        return;
      }
      
      // Merge imported data
      G.version=imported.version||1;
      if(imported.skills){
        for(const k of Object.keys(G.skills)){
          if(imported.skills[k])G.skills[k]=imported.skills[k];
        }
      }
      G.bank=imported.bank||{};
      G.gold=imported.gold||0;
      G.equipment=imported.equipment||{weapon:null,helmet:null,body:null,legs:null,shield:null,gloves:null,boots:null,trinket:null};
      // Ensure new equipment slots exist for old saves
      if(!G.equipment.gloves)G.equipment.gloves=null;
      if(!G.equipment.boots)G.equipment.boots=null;
      if(!G.equipment.trinket)G.equipment.trinket=null;
      G.combat={...G.combat,...(imported.combat||{})};
      G.infusion=imported.infusion||{};
      G.bankOrder=imported.bankOrder||[];
      // IMPORTANT: Clear and repopulate activeActions to preserve Proxy
      for(const k of Object.keys(G.activeActions)){
        delete G.activeActions[k];
      }
      if(imported.activeActions){
        for(const [k,v] of Object.entries(imported.activeActions)){
          G.activeActions[k]=v; // This triggers the Proxy set handler
        }
      }
      G.actionProgress=imported.actionProgress||{};
      G.contracts=imported.contracts||[];
      G.contractsLastRefresh=imported.contractsLastRefresh||Date.now();
      G.masteryUpgrades=imported.masteryUpgrades||{};
      G.selectedZone=imported.selectedZone||'forest';
      
      // Restore smithingCraft manually (Proxy should have handled it, but double-check)
      if(!smithingCraftAction && G.activeActions.smithingCraft){
        smithingCraftAction=ACTIONS.smithingCraft.find(a=>a.id===G.activeActions.smithingCraft);
      }
      
      // Validate and fix HP
      const stats=getPlayerStats();
      G.combat.maxHp=stats.maxHp;
      if(G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
      
      // Save to storage
      await saveGame();
      
      // Refresh UI
      showPage(currentPage);
      updateHeader();
      updateActiveActionDisplay();
      renderSidebar();
      
      notify('Save imported successfully!','lvl');
    }catch(err){
      console.error('Import error:',err);
      notify('Failed to import save!','combat');
    }
  };
  input.click();
}

// ============================================================
// UI RENDERING
// ============================================================
let currentPage='home';
function getCurrentPage(){return currentPage;}
function showPage(page){
  currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  const pg=document.getElementById('page-'+page);
  if(pg)pg.classList.add('active');
  // Highlight the right nav item
  const nav=document.getElementById('nav-'+page);
  if(nav)nav.classList.add('active');
  // For combat sub-skills, also highlight their nav items
  const combatSubSkills=['attack','strength','haste','defense','hitpoints'];
  if(page==='stats'){
    combatSubSkills.forEach(s=>{
      const el=document.getElementById('nav-'+s);
      if(el)el.classList.add('active');
    });
  }
  renderSkillPage(page);
  if(page==='bank')renderBank();
  if(page==='equipment')renderEquipPage();
  if(page==='combat')renderCombatPage();
  if(page==='stats')renderStatsPage();
  if(page==='contracts')renderContractsPage();
  if(page==='mastery-shop')renderMasteryShop();
  if(page==='store')renderStore();
  if(page==='statistics')renderStatisticsPage();
  if(page==='collection')renderCollectionPage();
  if(page==='achievements')renderAchievementsPage();
}

function renderSidebar(){
  const skills=['woodcutting','mining','fishing','smithing','cooking','pickpocketing','woodworking','prospecting','jewelcrafting'];
  skills.forEach(s=>{
    if(!G.skills[s])return; // Safety check
    const lv=xpToLevel(G.skills[s].xp);
    const slEl=document.getElementById('sl-'+s);
    if(slEl)slEl.textContent='Lv '+lv;
    const mbEl=document.getElementById('mb-'+s);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[s].xp)*100)+'%';
  });
  
  // Combat level is now calculated (average of 5 sub-skills)
  const stats=getPlayerStats();
  const combatLv=stats.combatLevel;
  const slCombat=document.getElementById('sl-combat');
  if(slCombat)slCombat.textContent='Lv '+combatLv;
  // Combat progress bar shows average progress of 5 sub-skills
  const avgProgress=(xpProgress(G.skills.attack.xp)+xpProgress(G.skills.strength.xp)+xpProgress(G.skills.haste.xp)+xpProgress(G.skills.defense.xp)+xpProgress(G.skills.hitpoints.xp))/5;
  const mbCombat=document.getElementById('mb-combat');
  if(mbCombat)mbCombat.style.width=(avgProgress*100)+'%';
  
  // Combat sub-skills
  const combatSubs=[
    {key:'attack',stat:`${stats.critChance}% Crit`},
    {key:'strength',stat:`+${stats.power} Pwr`},
    {key:'haste',stat:`${stats.attackSpeed}`},
    {key:'defense',stat:`${stats.armor} Arm`},
    {key:'hitpoints',stat:`${stats.maxHp} HP`},
  ];
  combatSubs.forEach(({key,stat})=>{
    if(!G.skills[key])return; // Safety check
    const lv=xpToLevel(G.skills[key].xp);
    const slEl=document.getElementById('sl-'+key);
    if(slEl)slEl.textContent='Lv '+lv;
    const stEl=document.getElementById('sl-'+key+'-stat');
    if(stEl)stEl.textContent=' · '+stat;
    const mbEl=document.getElementById('mb-'+key);
    if(mbEl)mbEl.style.width=(xpProgress(G.skills[key].xp)*100)+'%';
  });
}

function renderXPArea(skill){
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  
  let lv, prog, xp, nextXp;
  
  if(skill==='combat'){
    // Combat is calculated, not from XP
    const stats=getPlayerStats();
    lv=stats.combatLevel;
    // Progress is average of 5 combat skills
    const avgProg=(xpProgress(G.skills.attack.xp)+xpProgress(G.skills.strength.xp)+
                   xpProgress(G.skills.haste.xp)+xpProgress(G.skills.defense.xp)+
                   xpProgress(G.skills.hitpoints.xp))/5;
    prog=avgProg*100;
    xp=G.skills.combat.xp; // Show old XP for reference
    nextXp=0; // No "next level" for calculated stat
  }else{
    xp=G.skills[skill].xp;
    lv=xpToLevel(xp);
    prog=xpProgress(xp)*100;
    nextXp=lv<99?xpToNextLevel(xp):0;
  }
  
  return `
    <div class="xp-row">
      <span class="xp-label">Level ${lv}</span>
      <div class="xp-bar"><div class="xp-bar-fill xp-fill-blue" style="width:${prog}%"></div></div>
      <span class="xp-txt">${fmt(xp)} XP ${lv<99&&nextXp>0?'('+fmt(nextXp)+' to next)':''}</span>
    </div>`;
}

function updateCombatMastery(){
  // Update enemy mastery bar in real-time during combat
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  if(!monster)return;
  
  const masteryXp=G.skills.combat?.masteryXp?.[monster.id]||0;
  const masteryLv=getMasteryLevel('combat',monster.id);
  const masteryPct=getMasteryProgress('combat',monster.id);
  
  const masteryBar=document.getElementById('combat-mastery-bar');
  const masteryText=document.getElementById('combat-mastery-text');
  if(masteryBar)masteryBar.style.width=`${masteryPct}%`;
  if(masteryText)masteryText.textContent=`Lv ${masteryLv} - ${fmt(masteryXp)} XP`;
  
  // Also update the monster card mastery bar if it exists
  const cardFill=document.getElementById(`mast-fill-combat-${monster.id}`);
  const cardLv=document.getElementById(`mast-lv-combat-${monster.id}`);
  const cardXp=document.getElementById(`mast-xp-combat-${monster.id}`);
  if(cardFill)cardFill.style.width=`${masteryPct}%`;
  if(cardLv)cardLv.textContent=`Mastery Lv ${masteryLv}`;
  if(cardXp)cardXp.textContent=fmt(masteryXp);
}


// ============================================================
// SESSION TRACKER
// ============================================================
function trackerActiveKey(){
  if(G.combat.active)return 'combat';
  if(smithingCraftAction)return 'smithingCraft';
  const entry=Object.entries(G.activeActions)[0];
  return entry?entry[0]:null;
}

function trackerReset(){
  G.tracker.xpSnaps={};
  G.tracker.lootLog={};
  G.tracker.goldLog=[];
  G.tracker.activeKey=trackerActiveKey();
}

function trackLoot(itemId,qty){
  if(!G.tracker)return;
  const key=trackerActiveKey();
  if(key!==G.tracker.activeKey)trackerReset();
  const now=Date.now();
  if(!G.tracker.lootLog[itemId])G.tracker.lootLog[itemId]=[];
  G.tracker.lootLog[itemId].push({time:now,qty});
  // Prune old entries beyond 60s
  const cutoff=now-60000;
  G.tracker.lootLog[itemId]=G.tracker.lootLog[itemId].filter(e=>e.time>=cutoff);
}

function trackGold(amount){
  if(!G.tracker)return;
  const key=trackerActiveKey();
  if(key!==G.tracker.activeKey)trackerReset();
  const now=Date.now();
  G.tracker.goldLog.push({time:now,amount});
  const cutoff=now-60000;
  G.tracker.goldLog=G.tracker.goldLog.filter(e=>e.time>=cutoff);
}

function sampleTrackerXp(){
  if(!G.tracker)return;
  const key=trackerActiveKey();
  if(key!==G.tracker.activeKey)trackerReset();
  if(!key)return;
  const now=Date.now();
  const cutoff=now-60000;

  // Determine which skills to sample
  const skills=key==='combat'
    ?['attack','strength','haste','defense','hitpoints']
    :[key==='smithingCraft'?'smithing':key];

  for(const sk of skills){
    const xp=G.skills[sk]?.xp||0;
    if(!G.tracker.xpSnaps[sk])G.tracker.xpSnaps[sk]=[];
    G.tracker.xpSnaps[sk].push({time:now,xp});
    G.tracker.xpSnaps[sk]=G.tracker.xpSnaps[sk].filter(e=>e.time>=cutoff);
  }
}

function getSkillXpRate(sk){
  const snaps=G.tracker.xpSnaps[sk];
  if(!snaps||snaps.length<2)return 0;
  const elapsed=snaps[snaps.length-1].time-snaps[0].time;
  if(elapsed<2000)return 0;
  return Math.round(((snaps[snaps.length-1].xp-snaps[0].xp)/elapsed)*3600000);
}

function getItemRate(itemId){
  const log=G.tracker.lootLog[itemId];
  if(!log||log.length===0)return{count:0,rate:0};
  const count=log.reduce((s,e)=>s+e.qty,0);
  if(log.length<2)return{count,rate:0};
  const elapsed=log[log.length-1].time-log[0].time;
  if(elapsed<2000)return{count,rate:0};
  return{count,rate:Math.round((count/elapsed)*3600000)};
}

function getGoldRate(){
  const log=G.tracker.goldLog;
  if(!log||log.length===0)return{total:0,rate:0};
  const total=log.reduce((s,e)=>s+e.amount,0);
  if(log.length<2)return{total,rate:0};
  const elapsed=log[log.length-1].time-log[0].time;
  if(elapsed<2000)return{total,rate:0};
  return{total,rate:Math.round((total/elapsed)*3600000)};
}

function toggleTracker(){
  if(!G.tracker)return;
  const key=trackerActiveKey();
  if(!key){G.tracker.open=false;return;}
  G.tracker.open=!G.tracker.open;
  updateTrackerPanel();
}

function updateTrackerPanel(){
  const panel=document.getElementById('tracker-panel');
  if(!panel)return;
  if(!G.tracker?.open){panel.classList.remove('open');return;}
  panel.classList.add('open');

  const key=trackerActiveKey();
  if(!key){panel.classList.remove('open');G.tracker.open=false;return;}

  let html='';

  // ── XP Section ──────────────────────────────────────────────
  html+='<div class="tp-section"><div class="tp-title">XP / Hour</div>';

  if(key==='combat'){
    const subSkills=[
      {id:'attack',label:'Attack'},
      {id:'strength',label:'Strength'},
      {id:'haste',label:'Haste'},
      {id:'defense',label:'Defense'},
      {id:'hitpoints',label:'Hitpoints'}
    ];
    for(const s of subSkills){
      const rate=getSkillXpRate(s.id);
      html+=`<div class="tp-row">
        <span class="tp-label">${s.label}</span>
        <span class="tp-vals"><span class="tp-xp">${rate>0?fmt(rate)+' xp/hr':'—'}</span></span>
      </div>`;
    }
  } else {
    const sk=key==='smithingCraft'?'smithing':key;
    const rate=getSkillXpRate(sk);
    html+=`<div class="tp-row">
      <span class="tp-label">XP Rate</span>
      <span class="tp-vals"><span class="tp-xp">${rate>0?fmt(rate)+' xp/hr':'Measuring...'}</span></span>
    </div>`;
  }
  html+='</div>';

  // ── Loot Section ─────────────────────────────────────────────
  const lootKeys=Object.keys(G.tracker.lootLog||{});
  const goldData=getGoldRate();
  const hasLoot=lootKeys.length>0||goldData.total>0;

  html+='<div class="tp-divider"></div>';
  html+='<div class="tp-section"><div class="tp-title">Loot (last 60s)</div>';

  if(!hasLoot){
    html+='<div class="tp-empty">No loot yet</div>';
  } else {
    // Gold row
    if(goldData.total>0){
      html+=`<div class="tp-row">
        <span class="tp-label">🪙 Gold</span>
        <span class="tp-vals">
          <span class="tp-gold">${fmt(goldData.total)}g</span>
          ${goldData.rate>0?`<span class="tp-rate">${fmt(goldData.rate)}/hr</span>`:''}
        </span>
      </div>`;
    }
    // Item rows
    for(const itemId of lootKeys){
      const item=ITEMS[itemId];
      if(!item)continue;
      const {count,rate}=getItemRate(itemId);
      if(count===0)continue;
      html+=`<div class="tp-row">
        <span class="tp-label">${item.icon} ${item.name}</span>
        <span class="tp-vals">
          <span class="tp-count">${fmt(count)}</span>
          ${rate>0?`<span class="tp-rate">${fmt(rate)}/hr</span>`:''}
        </span>
      </div>`;
    }
  }
  html+='</div>';

  panel.innerHTML=html;
}

// Close tracker when clicking outside
document.addEventListener('click',e=>{
  if(!G.tracker?.open)return;
  const aad=document.getElementById('active-action-display');
  const panel=document.getElementById('tracker-panel');
  if(aad&&!aad.contains(e.target)&&panel&&!panel.contains(e.target)){
    G.tracker.open=false;
    updateTrackerPanel();
  }
});

// ============================================================
// XP RATE TRACKER (header bar rate display)
// ============================================================
function getActiveXpKey(){
  // Returns a string key identifying what skill is active, or null
  if(G.combat.active)return 'combat';
  if(smithingCraftAction)return 'smithingCraft';
  const entry=Object.entries(G.activeActions)[0];
  return entry?entry[0]:null;
}

function getActiveXpTotal(key){
  // Returns current cumulative XP for the active skill
  if(!key)return 0;
  if(key==='combat'){
    return (G.skills.attack?.xp||0)+(G.skills.strength?.xp||0)+
           (G.skills.haste?.xp||0)+(G.skills.defense?.xp||0)+
           (G.skills.hitpoints?.xp||0);
  }
  if(key==='smithingCraft')return G.skills.smithing?.xp||0;
  return G.skills[key]?.xp||0;
}

function sampleXpRate(){
  if(!G.xpTracker)G.xpTracker={snapshots:[],activeKey:null};
  const key=getActiveXpKey();
  const now=Date.now();

  // Reset tracker if skill changed
  if(key!==G.xpTracker.activeKey){
    G.xpTracker.snapshots=[];
    G.xpTracker.activeKey=key;
  }
  if(!key)return;

  const xp=getActiveXpTotal(key);
  G.xpTracker.snapshots.push({time:now,xp});

  // Keep only last 60 seconds of samples (100 samples at 600ms each)
  const cutoff=now-60000;
  G.xpTracker.snapshots=G.xpTracker.snapshots.filter(s=>s.time>=cutoff);
}

function getXpRate(){
  // For the header bar: sum all active skill rates from the tracker
  const key=trackerActiveKey();
  if(!key)return 0;
  if(key==='combat'){
    return ['attack','strength','haste','defense','hitpoints']
      .reduce((sum,sk)=>sum+getSkillXpRate(sk),0);
  }
  const sk=key==='smithingCraft'?'smithing':key;
  return getSkillXpRate(sk);
}

function updateActiveActionDisplay(){
  const display=document.getElementById('active-action-display');
  if(!display)return;

  const rate=getXpRate();
  const rateStr=rate>0?` <span style="color:var(--xp);font-size:10px;opacity:0.85">${fmt(rate)} xp/hr</span>`:'';

  // Check combat first
  if(G.combat.active){
    const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
    if(monster){
      document.getElementById('aad-icon').textContent='⚔️';
      document.getElementById('aad-text').innerHTML='Fighting '+monster.name+rateStr;
      display.classList.add('visible');
      return;
    }
  }

  // Check smithing craft
  if(smithingCraftAction){
    const count=G.sessionCounts[smithingCraftAction.id]||0;
    document.getElementById('aad-icon').textContent=smithingCraftAction.icon;
    document.getElementById('aad-text').innerHTML='Crafting '+smithingCraftAction.name+(count>0?' ('+fmt(count)+')':'')+rateStr;
    display.classList.add('visible');
    return;
  }

  // Check regular skills
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(action){
      const skillNames={
        woodcutting:'Woodcutting',mining:'Mining',fishing:'Fishing',
        smithing:'Smelting',cooking:'Cooking',pickpocketing:'Pickpocketing',
        woodworking:'Woodworking',prospecting:'Prospecting',jewelcrafting:'Jewelcrafting'
      };
      const count=G.sessionCounts[actionId]||0;
      const suffix=skill==='pickpocketing'?'gp':'';
      const countPrefix=skill==='pickpocketing'?'💰 ':action.icon+' ';
      document.getElementById('aad-icon').textContent=action.icon;
      document.getElementById('aad-text').innerHTML=(skillNames[skill]||skill)+' '+action.name+(count>0?' ('+countPrefix+fmt(count)+suffix+')':'')+rateStr;
      display.classList.add('visible');
      return;
    }
  }

  // Nothing active
  display.classList.remove('visible');
}

function updateHeader(){
  const stats=getPlayerStats();
  document.getElementById('hdr-gold').textContent=fmt(G.gold);
  document.getElementById('hdr-hp').textContent=Math.floor(G.combat.playerHp)+'/'+stats.maxHp;
  document.getElementById('hdr-atk').textContent=stats.critChance+'%';
  document.getElementById('hdr-def').textContent=stats.armor;
}

function updateProgressBars(){
  renderSidebar();
  const skills=['woodcutting','mining','fishing','smithing','cooking','pickpocketing','woodworking','prospecting','jewelcrafting','combat'];
  skills.forEach(s=>{
    const el=document.getElementById('pgxp-'+s);
    if(el&&currentPage===s)el.innerHTML=renderXPArea(s);
  });
  // Update active action progress bars
  for(const [skill,actionId] of Object.entries(G.activeActions)){
    if(skill==='smithingCraft')continue;
    const skillActions=ACTIONS[skill];
    if(!skillActions)continue;
    const action=skillActions.find(a=>a.id===actionId);
    if(!action)continue;
    const mastLv=getMasteryLevel(skill,actionId);
    const ticks=getMasteryTicks(action,mastLv,skill);
    const prog=(G.actionProgress[skill]||0)/ticks*100;
    const fill=document.getElementById('prog-fill-'+skill+'-'+actionId);
    if(fill)fill.style.width=prog+'%';
  }
  // Smithing craft progress
  if(smithingCraftAction){
    const fill=document.getElementById('prog-fill-smithing-craft');
    if(fill)fill.style.width=(smithingCraftProgress/smithingCraftAction.ticks*100)+'%';
  }
  
  // Update mastery bars on all visible action cards
  const currentSkill=getCurrentPage();
  if(['woodcutting','mining','fishing','smithing','cooking','pickpocketing','woodworking','prospecting','jewelcrafting'].includes(currentSkill)){
    const actions=currentSkill==='smithing'?[...ACTIONS.smithing,...ACTIONS.smithingCraft]:ACTIONS[currentSkill];
    if(actions){
      actions.forEach(action=>{
        const mastXp=getMasteryXp(currentSkill,action.id);
        const mastProg=xpProgress(mastXp)*100;
        const mastFill=document.getElementById(`mast-fill-${currentSkill}-${action.id}`);
        if(mastFill)mastFill.style.width=mastProg+'%';
        // Update mastery level text
        const mastLvEl=document.getElementById(`mast-lv-${currentSkill}-${action.id}`);
        if(mastLvEl)mastLvEl.textContent='Lv '+getMasteryLevel(currentSkill,action.id);
        // Update mastery XP count
        const mastXpEl=document.getElementById(`mast-xp-${currentSkill}-${action.id}`);
        if(mastXpEl)mastXpEl.textContent=Math.floor(mastXp)+' XP';
      });
    }
  }
  // Update combat monster mastery bars
  if(currentSkill==='combat'){
    MONSTERS.forEach(monster=>{
      const mastXp=getMasteryXp('combat',monster.id);
      const mastProg=xpProgress(mastXp)*100;
      const mastFill=document.getElementById(`mast-fill-combat-${monster.id}`);
      if(mastFill)mastFill.style.width=mastProg+'%';
      // Update mastery level text
      const mastLvEl=document.getElementById(`mast-lv-combat-${monster.id}`);
      if(mastLvEl)mastLvEl.textContent='Lv '+getMasteryLevel('combat',monster.id);
      // Update mastery XP count
      const mastXpEl=document.getElementById(`mast-xp-combat-${monster.id}`);
      if(mastXpEl)mastXpEl.textContent=Math.floor(mastXp)+' XP';
    });
  }
}

function renderSkillPage(skill){
  if(currentPage!==skill)return;
  // Safety: ensure skill exists
  if(!G.skills[skill]){
    G.skills[skill]={xp:0,masteryXp:{}};
  }
  const xpEl=document.getElementById('pgxp-'+skill);
  if(xpEl)xpEl.innerHTML=renderXPArea(skill);
  const curEl=document.getElementById('cur-'+skill);
  const lv=xpToLevel(G.skills[skill].xp);

  if(['woodcutting','mining','fishing','pickpocketing'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const skillActions=ACTIONS[skill];
        const action=skillActions.find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv,skill);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${skill==='pickpocketing'?'💰 ':''}${fmt(sessionCount)}${skill==='pickpocketing'?'gp':''})</span></span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">■ Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv,skill);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            ${iconPill(a.icon, skill||a.cat||'misc')}
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">${skill==='pickpocketing'?'Gold':'Item'}: <span>${skill==='pickpocketing'?'💰 '+fmt(a.goldReward)+'gp':(ITEMS[a.produces]?ITEMS[a.produces].icon+' '+ITEMS[a.produces].name:'-')}${a.produces?' <span data-item-id="'+a.produces+'">('+fmt(G.bank[a.produces]||0)+')</span>':''}</span></div>
            <div class="ac-stat">Mastery: <span id="mast-lv-${skill}-${a.id}">Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span id="mast-xp-${skill}-${a.id}">${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" id="mast-fill-${skill}-${a.id}" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  if(['cooking','prospecting'].includes(skill)){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv,skill);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap">
            <div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div>
          </div>
          <button class="ca-stop" onclick="stopAction('${skill}')">■ Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-'+skill);
    if(grid){
      grid.innerHTML=ACTIONS[skill].map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const hasMat=!a.consumes||hasMaterials(a.consumes);
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv,skill);
        const ingredientHtml=a.consumes?Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id]?ITEMS[id].icon+' ':''} ${qty}x ${ITEMS[id]?ITEMS[id].name:id} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
        }).join(''):'';
        const craftableCount=a.consumes?getCraftableCount(a.consumes):0;
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\''+skill+'\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">
            ${iconPill(a.icon, skill||a.cat||'misc')}
            <span class="ac-name">${a.name}</span>
            ${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}
          </div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            ${a.gemChance!==undefined?`<div class="ac-stat" style="color:var(--purple2)">Gem Chance: <span>${Math.round(Math.min(97,(a.gemChance+(getMasteryLevel(skill,a.id)/99)*0.5+getMasteryBonus(skill,'success')/100)*100))}%</span></div>`:
              (a.produces&&ITEMS[a.produces]?`<div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>`:'')}
            ${a.gemChance!==undefined&&ITEMS[a.produces]?`<div class="ac-stat">Gem: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>`:''}
            <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
            <div class="ac-stat">Mastery: <span id="mast-lv-${skill}-${a.id}">Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span id="mast-xp-${skill}-${a.id}">${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" id="mast-fill-${skill}-${a.id}" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
  }

  // ── WOODWORKING — tiered by material set ────────────────────────────────
  if(skill==='woodworking'){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv,skill);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopAction('woodworking')">■ Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-woodworking');
    if(grid){
      const wwTiers=[
        {name:'Graveliron Tools',color:'#d4a017',reqLv:1, prefix:'graveliron'},
        {name:'Emberguard Tools',color:'#ff8c00',reqLv:15,prefix:'emberguard'},
        {name:'Brightmail Tools',color:'#c0c0c0',reqLv:25,prefix:'brightmail'},
        {name:'Grimforge Tools', color:'#708090',reqLv:35,prefix:'grimforge'},
        {name:'Moonweave Tools', color:'#9370db',reqLv:45,prefix:'moonweave'},
        {name:'Sungilt Tools',   color:'#ffd700',reqLv:55,prefix:'sungilt'},
        {name:'Stormcast Tools', color:'#4169e1',reqLv:70,prefix:'stormcast'},
        {name:'Duskwarden Tools',color:'#9400d3',reqLv:85,prefix:'duskwarden'},
      ];
      let html='';
      for(const tier of wwTiers){
        const tierItems=ACTIONS.woodworking.filter(a=>a.id.startsWith('craft_'+tier.prefix));
        if(tierItems.length===0)continue;
        html+=`<div style="grid-column:1/-1;padding:8px 0 4px 0;margin-top:${html?'16px':'0'}">
          <div style="font-size:14px;font-weight:600;color:${tier.color};border-bottom:2px solid ${tier.color};padding-bottom:4px;display:flex;justify-content:space-between;align-items:center">
            <span>${tier.name}</span>
            <span style="font-size:12px;font-weight:500;opacity:0.85">Requires Level ${tier.reqLv} Woodworking</span>
          </div>
        </div>`;
        html+=tierItems.map(a=>{
          const locked=lv<a.levelReq;
          const active=G.activeActions.woodworking===a.id;
          const mastLv=getMasteryLevel('woodworking',a.id);
          const mastXp=getMasteryXp('woodworking',a.id);
          const mastProg=xpProgress(mastXp)*100;
          const reducedTicks=getMasteryTicks(a,mastLv,'woodworking');
          const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
            const has=(G.bank[id]||0)>=qty;
            return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id]?ITEMS[id].icon:''} ${qty}x ${ITEMS[id]?ITEMS[id].name:id} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
          }).join('');
          const craftableCount=getCraftableCount(a.consumes);
          const outputItem=ITEMS[a.produces];
          return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\'woodworking\',\''+a.id+'\')'}">
            ${active?'<div class="active-dot"></div>':''}
            <div class="ac-head">${iconPill(a.icon, skill||a.cat||'misc')}<span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
            <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
            <div class="ac-stats">
              <div class="ac-stat">XP: <span>${a.xp}</span></div>
              <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
              ${outputItem?`<div class="ac-stat">Output: <span>${outputItem.icon} ${outputItem.name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>`:''}
              <div class="ac-stat" style="color:var(--haste)">${outputItem?.speedBonus?`-${outputItem.speedBonus}% ${outputItem.skill} time`:''}</div>
              <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
              <div class="ac-stat">Mastery: <span id="mast-lv-woodworking-${a.id}">Lv ${mastLv}</span></div>
            </div>
            <div class="ac-mastery">
              <div class="ac-m-row"><span>Mastery XP</span><span id="mast-xp-woodworking-${a.id}">${fmt(mastXp)}</span></div>
              <div class="ac-m-bar"><div class="ac-m-fill" id="mast-fill-woodworking-${a.id}" style="width:${mastProg}%"></div></div>
            </div>
          </div>`;
        }).join('');
      }
      grid.innerHTML=html;
    }
  }

  // ── JEWELCRAFTING — tiered by category ──────────────────────────────────
  if(skill==='jewelcrafting'){
    const actionId=G.activeActions[skill];
    if(curEl){
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv,skill);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curEl.innerHTML=`<div class="cur-action">
          <span class="ca-label">Active:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopAction('jewelcrafting')">■ Stop</button>
        </div>`;
      } else {curEl.innerHTML='';}
    }
    const grid=document.getElementById('grid-jewelcrafting');
    if(grid){
      const jcCategories=[
        {name:'Gathering Amulets',color:'#4fd472',desc:'Boost XP for Woodcutting, Mining, Fishing & Pickpocketing',
         filter:a=>a.id.includes('amulet')&&!a.id.includes('artisan')&&!a.id.includes('valor')},
        {name:'Artisan Amulets', color:'#f0a030',desc:'Boost XP for Cooking, Smithing, Woodworking & more',
         filter:a=>a.id.includes('artisan_amulet')},
        {name:'Combat Amulets',  color:'#e85050',desc:'Flat ATK & DEF bonus for combat',
         filter:a=>a.id.includes('valor_amulet')},
        {name:'Skilling Rings',  color:'#5aadff',desc:'Reduce action time for a specific skill',
         filter:a=>a.id.includes('ring_of_')},
        {name:'Combat Rings',    color:'#c084fc',desc:'Focused combat bonuses — Crit, Power, Defense or Speed',
         filter:a=>a.id.includes('ring')&&!a.id.includes('ring_of_')},
      ];
      let html='';
      for(const cat of jcCategories){
        const catItems=ACTIONS.jewelcrafting.filter(cat.filter);
        if(catItems.length===0)continue;
        html+=`<div style="grid-column:1/-1;padding:8px 0 4px 0;margin-top:${html?'16px':'0'}">
          <div style="font-size:14px;font-weight:600;color:${cat.color};border-bottom:2px solid ${cat.color};padding-bottom:4px;display:flex;justify-content:space-between;align-items:center">
            <span>${cat.name}</span>
            <span style="font-size:11px;font-weight:400;opacity:0.75;font-style:italic">${cat.desc}</span>
          </div>
        </div>`;
        html+=catItems.map(a=>{
          const locked=lv<a.levelReq;
          const active=G.activeActions.jewelcrafting===a.id;
          const mastLv=getMasteryLevel('jewelcrafting',a.id);
          const mastXp=getMasteryXp('jewelcrafting',a.id);
          const mastProg=xpProgress(mastXp)*100;
          const reducedTicks=getMasteryTicks(a,mastLv,'jewelcrafting');
          const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
            const has=(G.bank[id]||0)>=qty;
            return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id]?ITEMS[id].icon:''} ${qty}x ${ITEMS[id]?ITEMS[id].name:id} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
          }).join('');
          const craftableCount=getCraftableCount(a.consumes);
          const outputItem=ITEMS[a.produces];
          return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\'jewelcrafting\',\''+a.id+'\')'}">
            ${active?'<div class="active-dot"></div>':''}
            <div class="ac-head">${iconPill(a.icon, skill||a.cat||'misc')}<span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
            <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
            <div class="ac-stats">
              <div class="ac-stat">XP: <span>${a.xp}</span></div>
              <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
              ${outputItem?`<div class="ac-stat">Output: <span>${outputItem.icon} ${outputItem.name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>`:''}
              ${outputItem?.bonus?`<div class="ac-stat" style="color:${cat.color};font-size:10px">${outputItem.bonus}</div>`:''}
              <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
              <div class="ac-stat">Mastery: <span id="mast-lv-jewelcrafting-${a.id}">Lv ${mastLv}</span></div>
            </div>
            <div class="ac-mastery">
              <div class="ac-m-row"><span>Mastery XP</span><span id="mast-xp-jewelcrafting-${a.id}">${fmt(mastXp)}</span></div>
              <div class="ac-m-bar"><div class="ac-m-fill" id="mast-fill-jewelcrafting-${a.id}" style="width:${mastProg}%"></div></div>
            </div>
          </div>`;
        }).join('');
      }
      grid.innerHTML=html;
    }
  }

  if(skill==='smithing'){
    const actionId=G.activeActions[skill];
    const craftId=smithingCraftAction?smithingCraftAction.id:null;
    if(curEl){
      let curHtml='';
      if(actionId){
        const action=ACTIONS[skill].find(a=>a.id===actionId);
        const mastLv=getMasteryLevel(skill,actionId);
        const ticks=getMasteryTicks(action,mastLv,skill);
        const prog=(G.actionProgress[skill]||0)/ticks*100;
        const sessionCount=G.sessionCounts[actionId]||0;
        curHtml+=`<div class="cur-action">
          <span class="ca-label">Smelting:</span>
          <span class="ca-name">${action.icon} ${action.name} <span id="session-count-${actionId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill" id="prog-fill-${skill}-${actionId}" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopAction('smithing')">■ Stop</button>
        </div>`;
      }
      if(craftId){
        const prog=smithingCraftProgress/smithingCraftAction.ticks*100;
        const sessionCount=G.sessionCounts[craftId]||0;
        curHtml+=`<div class="cur-action" style="border-color:var(--gold)">
          <span class="ca-label">Crafting:</span>
          <span class="ca-name">${smithingCraftAction.icon} ${smithingCraftAction.name} <span id="session-count-${craftId}" style="color:var(--green2);${sessionCount>0?'':'display:none'}">(${fmt(sessionCount)})</span></span>
          <div class="ca-prog-wrap"><div class="ca-prog-bar"><div class="ca-prog-fill xp-fill-gold" id="prog-fill-smithing-craft" style="width:${prog}%"></div></div></div>
          <button class="ca-stop" onclick="stopCraft()">■ Stop</button>
        </div>`;
      }
      curEl.innerHTML=curHtml;
    }
    const grid=document.getElementById('grid-smithing');
    if(grid){
      grid.innerHTML=ACTIONS.smithing.map(a=>{
        const locked=lv<a.levelReq;
        const active=G.activeActions[skill]===a.id;
        const mastLv=getMasteryLevel(skill,a.id);
        const mastXp=getMasteryXp(skill,a.id);
        const mastProg=xpProgress(mastXp)*100;
        const reducedTicks=getMasteryTicks(a,mastLv,skill);
        const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
          const has=(G.bank[id]||0)>=qty;
          return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
        }).join('');
        const craftableCount=getCraftableCount(a.consumes);
        return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startAction(\'smithing\',\''+a.id+'\')'}">
          ${active?'<div class="active-dot"></div>':''}
          <div class="ac-head">${iconPill(a.icon, skill||a.cat||'misc')}<span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
          <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
          <div class="ac-stats">
            <div class="ac-stat">XP: <span>${a.xp}</span></div>
            <div class="ac-stat">Time: <span>${(reducedTicks*0.6).toFixed(1)}s</span></div>
            <div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>
            <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
            <div class="ac-stat">Mastery: <span id="mast-lv-${skill}-${a.id}">Lv ${mastLv}</span></div>
          </div>
          <div class="ac-mastery">
            <div class="ac-m-row"><span>Mastery XP</span><span id="mast-xp-${skill}-${a.id}">${fmt(mastXp)}</span></div>
            <div class="ac-m-bar"><div class="ac-m-fill" id="mast-fill-${skill}-${a.id}" style="width:${mastProg}%"></div></div>
          </div>
        </div>`;
      }).join('');
    }
    const craftGrid=document.getElementById('grid-smithing-craft');
    if(craftGrid){
      // Group equipment by tier with level requirements
      const tiers=[
        {name:'Roughplate Set',color:'#d4a017',reqLv:1,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('bronze'))},
        {name:'Emberguard Set',color:'#ff8c00',reqLv:15,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('iron'))},
        {name:'Brightmail Set',color:'#c0c0c0',reqLv:20,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('silver'))},
        {name:'Grimforge Set',color:'#708090',reqLv:30,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('steel'))},
        {name:'Moonweave Set',color:'#9370db',reqLv:40,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('mithril'))},
        {name:'Sungilt Set',color:'#ffd700',reqLv:55,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('adamant'))},
        {name:'Stormcast Set',color:'#4169e1',reqLv:70,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('rune'))},
        {name:'Duskwarden Set',color:'#9400d3',reqLv:85,items:ACTIONS.smithingCraft.filter(a=>a.id.includes('dragon'))},
      ];

      let html='';
      for(const tier of tiers){
        if(tier.items.length===0)continue;
        
        // Tier header with level requirement
        html+=`<div style="grid-column:1/-1;padding:8px 0 4px 0;margin-top:${html?'16px':'0'}">
          <div style="font-size:14px;font-weight:600;color:${tier.color};border-bottom:2px solid ${tier.color};padding-bottom:4px;display:flex;justify-content:space-between;align-items:center">
            <span>${tier.name}</span>
            <span style="font-size:12px;font-weight:500;opacity:0.85">Requires Level ${tier.reqLv} Attack, Strength & Defense</span>
          </div>
        </div>`;
        
        // Tier items
        html+=tier.items.map(a=>{
          const locked=lv<a.levelReq;
          const active=smithingCraftAction&&smithingCraftAction.id===a.id;
          const hasMat=!locked&&hasMaterials(a.consumes);
          const ingredientHtml=Object.entries(a.consumes).map(([id,qty])=>{
            const has=(G.bank[id]||0)>=qty;
            return `<span class="ingredient ${has?'ok':'missing'}">${ITEMS[id].icon} ${qty}x ${ITEMS[id].name} <span data-ingredient-id="${id}">(${G.bank[id]||0})</span></span>`;
          }).join('');
          const craftableCount=getCraftableCount(a.consumes);
          return `<div class="action-card${locked?' locked':''}${active?' active-action':''}" onclick="${locked?'':'startCraft(\''+a.id+'\')'}">
            ${active?'<div class="active-dot"></div>':''}
            <div class="ac-head">${iconPill(a.icon, skill||a.cat||'misc')}<span class="ac-name">${a.name}</span>${locked?`<span class="ac-lock">Lv ${a.levelReq}</span>`:''}</div>
            <div style="font-size:11px;margin-bottom:6px">${ingredientHtml}</div>
            <div class="ac-stats">
              <div class="ac-stat">XP: <span>${a.xp}</span></div>
              <div class="ac-stat">Time: <span>${(a.ticks*0.6).toFixed(1)}s</span></div>
              <div class="ac-stat">Output: <span>${ITEMS[a.produces].icon} ${ITEMS[a.produces].name} <span data-item-id="${a.produces}">(${fmt(G.bank[a.produces]||0)})</span></span></div>
              <div class="ac-stat" style="color:var(--green2);${craftableCount>0?'':'display:none'}" id="can-make-stat-${a.id}">Can make: <span id="can-make-${a.id}">${fmt(craftableCount)}</span></div>
            </div>
          </div>`;
        }).join('');
      }
      
      craftGrid.innerHTML=html;
    }
  }
}

function renderBank(){
  document.getElementById('bank-gold-disp').textContent=fmt(G.gold);
  const cats=['all','logs','ore','bar','fish','food','gem','weapon','armor','trinket','tool','jewelry','junk'];
  const bankCats=document.getElementById('bank-cats');
  if(bankCats&&!bankCats.dataset.rendered){
    bankCats.innerHTML=cats.map(c=>`<button class="bcat-btn${c==='all'?' active':''}" onclick="filterBank('${c}')" id="bcat-${c}">${c.charAt(0).toUpperCase()+c.slice(1)}</button>`).join('');
    bankCats.dataset.rendered='1';
  }
  const filter=window._bankFilter||'all';
  const selectMode=window._bankSelectMode||false;
  const selected=window._bankSelected||{};
  const grid=document.getElementById('bank-grid');
  let items=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&(filter==='all'||ITEMS[id].cat===filter||
    (filter==='weapon'&&ITEMS[id].cat==='weapon')||(filter==='armor'&&ITEMS[id].cat==='armor')));

  if(filter==='all'&&G.bankOrder&&G.bankOrder.length>0){
    items.sort((a,b)=>{
      const aIdx=G.bankOrder.indexOf(a[0]);
      const bIdx=G.bankOrder.indexOf(b[0]);
      if(aIdx===-1&&bIdx===-1)return 0;
      if(aIdx===-1)return 1;
      if(bIdx===-1)return -1;
      return aIdx-bIdx;
    });
  }

  if(items.length===0){grid.innerHTML='<div class="bank-empty">No items here. Start skilling!</div>';updateBankSelectedBar();return;}
  grid.innerHTML=items.map(([id,qty])=>{
    const item=ITEMS[id];
    const isSel=selected[id]?true:false;
    const selClass=isSel?' b-selected':'';
    const modeClass=selectMode?' select-mode':'';
    const draggable=!selectMode;
    const dragAttrs=draggable?`draggable="true" ondragstart="bankDragStart(event)" ondragover="bankDragOver(event)" ondrop="bankDrop(event)" ondragend="bankDragEnd(event)"`:'draggable="false"';
    const clickAttr=selectMode?`onclick="toggleBankItem('${id}')"`:''
    return `<div class="b-item${selClass}${modeClass}" ${dragAttrs} data-item-id="${id}" ${clickAttr}>
      <div class="b-check">${isSel?'✓':''}</div>
      ${!selectMode?`<div class="b-sell-menu">
        ${qty>=1?`<button class="b-sell-btn" onclick="sellItem('${id}',1)">Sell 1</button>`:''}
        ${qty>=10?`<button class="b-sell-btn" onclick="sellItem('${id}',10)">Sell 10</button>`:''}
        ${qty>=100?`<button class="b-sell-btn" onclick="sellItem('${id}',100)">Sell 100</button>`:''}
        ${qty>=1000?`<button class="b-sell-btn" onclick="sellItem('${id}',1000)">Sell 1K</button>`:''}
        <button class="b-sell-btn b-sell-all" onclick="sellItem('${id}',${qty})">Sell All</button>
      </div>`:''}
      <div class="b-icon">${iconPill(item.icon, item.cat, 'md')}</div>
      <div class="b-name">${item.name}</div>
      <div class="b-qty">${fmt(qty)}</div>
      ${item.value>0?`<div class="b-val">${item.value}gp ea</div>`:''}
    </div>`;
  }).join('');
  updateBankSelectedBar();
}

let draggedBankItem=null;
function bankDragStart(e){
  draggedBankItem=e.currentTarget;
  e.currentTarget.style.opacity='0.5';
  e.dataTransfer.effectAllowed='move';
}
function bankDragOver(e){
  if(e.preventDefault)e.preventDefault();
  e.dataTransfer.dropEffect='move';
  const target=e.currentTarget;
  if(target&&target!==draggedBankItem){
    target.style.borderTop='3px solid var(--gold)';
  }
  return false;
}
function bankDrop(e){
  if(e.stopPropagation)e.stopPropagation();
  e.currentTarget.style.borderTop='';
  
  if(draggedBankItem!==e.currentTarget){
    const draggedId=draggedBankItem.dataset.itemId;
    const targetId=e.currentTarget.dataset.itemId;
    
    // Get current items in order
    const filter=window._bankFilter||'all';
    if(filter!=='all')return; // Only allow reordering in 'all' tab
    
    const allItems=Object.keys(G.bank).filter(id=>G.bank[id]>0&&ITEMS[id]);
    
    // Initialize bankOrder if empty
    if(!G.bankOrder||G.bankOrder.length===0){
      G.bankOrder=allItems.slice();
    }
    
    // Ensure all items are in bankOrder
    allItems.forEach(id=>{
      if(!G.bankOrder.includes(id)){
        G.bankOrder.push(id);
      }
    });
    
    // Remove dragged item and insert at target position
    const dragIdx=G.bankOrder.indexOf(draggedId);
    const targetIdx=G.bankOrder.indexOf(targetId);
    if(dragIdx!==-1){
      G.bankOrder.splice(dragIdx,1);
    }
    const newTargetIdx=G.bankOrder.indexOf(targetId);
    G.bankOrder.splice(newTargetIdx,0,draggedId);
    
    saveGame();
    renderBank();
  }
  return false;
}
function bankDragEnd(e){
  e.currentTarget.style.opacity='';
  document.querySelectorAll('.b-item').forEach(el=>el.style.borderTop='');
}

function filterBank(cat){
  window._bankFilter=cat;
  document.querySelectorAll('.bcat-btn').forEach(b=>b.classList.remove('active'));
  const el=document.getElementById('bcat-'+cat);
  if(el)el.classList.add('active');
  renderBank();
}
function sellItem(id,qty){
  if(!G.bank[id]||G.bank[id]<qty)return;
  
  const item=ITEMS[id];
  const value=(item?.value||0)*qty;
  const qtyText=qty>1?`${qty}x `:'';
  
  // Show confirmation modal
  showConfirmModal(
    '💰 Sell Confirmation',
    `<div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">${item.icon}</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px">${qtyText}${item.name}</div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:20px">
        <div>Unit Value: <span style="color:var(--gold2)">${fmt(item.value)}gp</span></div>
        <div>Quantity: <span style="color:var(--text1)">${qty}</span></div>
        <div style="margin-top:8px;color:var(--red2)">In Bank: ${G.bank[id]} → ${G.bank[id]-qty}</div>
      </div>
      <div style="font-size:20px;font-weight:700;color:var(--green2);border-top:2px solid var(--border);padding-top:12px">
        Total Gained: ${fmt(value)}gp
      </div>
      <div style="font-size:12px;color:var(--text3);margin-top:8px">
        Balance After: ${fmt(G.gold+value)}gp
      </div>
    </div>`,
    function(){
      removeFromBank(id,qty);
      G.gold+=value;
      // Stats tracking
      G.stats.totalGoldEarned+=value;
      G.stats.itemsSold+=qty;
      updateHeader();
      renderBank(); // Update bank display after selling
      if(value>0)notify(`Sold ${qtyText}${item.name} for ${fmt(value)}gp`,'item');
    }
  );
}
function sellAllCategory(cat){
  // Calculate total value first
  let totalGold=0;
  let itemCount=0;
  const itemsList=[];
  
  for(const [id,qty] of Object.entries(G.bank)){
    if(ITEMS[id]&&ITEMS[id].cat===cat&&qty>0){
      const itemValue=ITEMS[id].value*qty;
      totalGold+=itemValue;
      itemCount+=qty;
      itemsList.push(`${ITEMS[id].icon} ${qty}x ${ITEMS[id].name}`);
    }
  }
  
  if(totalGold===0){
    notify(`No ${cat} items to sell!`,'info');
    return;
  }
  
  // Show confirmation modal
  const itemsDisplay=itemsList.length>10?itemsList.slice(0,10).join(', ')+` and ${itemsList.length-10} more...`:itemsList.join(', ');
  
  showConfirmModal(
    '⚠️ Sell All Confirmation',
    `<div style="text-align:center;padding:20px">
      <div style="font-size:18px;font-weight:600;margin-bottom:12px;color:var(--orange2)">
        Sell ALL ${cat}?
      </div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:16px;max-height:150px;overflow-y:auto;text-align:left;padding:12px;background:var(--bg3);border-radius:8px">
        ${itemsDisplay}
      </div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:20px">
        <div>Total Items: <span style="color:var(--text1)">${itemCount}</span></div>
        <div style="margin-top:4px;color:var(--red2);font-weight:600">⚠️ This cannot be undone!</div>
      </div>
      <div style="font-size:20px;font-weight:700;color:var(--green2);border-top:2px solid var(--border);padding-top:12px">
        Total Gained: ${fmt(totalGold)}gp
      </div>
      <div style="font-size:12px;color:var(--text3);margin-top:8px">
        Balance After: ${fmt(G.gold+totalGold)}gp
      </div>
    </div>`,
    function(){
      let soldCount=0;
      for(const [id,qty] of Object.entries(G.bank)){
        if(ITEMS[id]&&ITEMS[id].cat===cat&&qty>0){
          soldCount+=qty;
          delete G.bank[id];
        }
      }
      G.gold+=totalGold;
      // Stats tracking
      G.stats.totalGoldEarned+=totalGold;
      G.stats.itemsSold+=soldCount;
      updateHeader();
      renderBank();
      notify(`Sold all ${cat} for ${fmt(totalGold)}gp`,'item');
    }
  );
}

function renderStatsPage(){
  if(currentPage!=='stats')return;
  const stats=getPlayerStats();

  // Calculate total level (combat is now calculated, not from XP)
  const gatheringSkills=['woodcutting','mining','fishing','smithing','cooking','pickpocketing','woodworking','prospecting','jewelcrafting'];
  const combatSkills=['attack','strength','haste','defense','hitpoints'];
  const totalLevel=gatheringSkills.reduce((s,k)=>{
    if(!G.skills[k])return s;
    return s+xpToLevel(G.skills[k].xp);
  },0) + combatSkills.reduce((s,k)=>{
    if(!G.skills[k])return s;
    return s+xpToLevel(G.skills[k].xp);
  },0) + stats.combatLevel; // Add calculated combat level
  const el=document.getElementById('stats-total-level');
  if(el)el.textContent=totalLevel.toLocaleString();
  
  // Show equipped badge if any
  const badgeEl=document.getElementById('equipped-badge-display');
  const badgeValEl=document.getElementById('equipped-badge-value');
  if(badgeEl&&badgeValEl){
    if(G.equippedBadge){
      badgeEl.style.display='block';
      badgeValEl.textContent=`[${G.equippedBadge}]`;
    }else{
      badgeEl.style.display='none';
    }
  }

  // Skill overview grid (gathering + production + combat overall)
  const skillRows=[
    {key:'woodcutting',icon:'🪓',name:'Woodcutting'},
    {key:'mining',icon:'⛏️',name:'Mining'},
    {key:'fishing',icon:'🎣',name:'Fishing'},
    {key:'smithing',icon:'🔨',name:'Blacksmithing'},
    {key:'cooking',icon:'🍳',name:'Cooking'},
    {key:'pickpocketing',icon:'🥷',name:'Pickpocketing'},
    {key:'woodworking',icon:'🪚',name:'Woodworking'},
    {key:'prospecting',icon:'🔍',name:'Prospecting'},
    {key:'jewelcrafting',icon:'💍',name:'Jewelcrafting'},
    {key:'combat',icon:'⚔️',name:'Combat'},
  ];
  const sgEl=document.getElementById('stats-skill-grid');
  if(sgEl){
    sgEl.innerHTML=skillRows.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      let lv, prog;
      if(s.key==='combat'){
        // Combat is calculated, not from XP
        lv=stats.combatLevel;
        // Progress is average of 5 combat skills
        prog=(xpProgress(G.skills.attack.xp)+xpProgress(G.skills.strength.xp)+xpProgress(G.skills.haste.xp)+xpProgress(G.skills.defense.xp)+xpProgress(G.skills.hitpoints.xp))/5*100;
      }else{
        const xp=G.skills[s.key].xp;
        lv=xpToLevel(xp);
        prog=xpProgress(xp)*100;
      }
      return `<div class="sog-item" onclick="showPage('${s.key==='combat'?'combat':s.key}')">
        ${iconPill(s.icon, s.key==='combat'?'combat':({woodcutting:'logs',mining:'ore',fishing:'fish',smithing:'bar',cooking:'food',pickpocketing:'misc',woodworking:'tool',prospecting:'gem',jewelcrafting:'jewelry'}[s.key]||'misc'), 'sm')}
        <div class="sog-info">
          <div class="sog-name">${s.name}</div>
          <div class="sog-level">${lv}</div>
          <div class="sog-xp-bar"><div class="sog-xp-fill" style="width:${prog}%"></div></div>
        </div>
      </div>`;
    }).join('');
  }

  // Combat stat cards
  const combatCards=[
    {icon:'🗡️',label:'Attack',sub:'→ Crit Chance',val:`${stats.critChance}%`,color:'var(--crit)',
      lv:stats.atkLv,xp:(G.skills.attack?.xp || 0),desc:'Trained during combat (on hit)'},
    {icon:'💪',label:'Strength',sub:'→ Power Bonus',val:`+${stats.power}`,color:'var(--power)',
      lv:stats.strLv,xp:(G.skills.strength?.xp || 0),desc:'Trained during combat (damage dealt)'},
    {icon:'⚡',label:'Haste',sub:'→ Attack Speed',val:stats.attackSpeed,color:'var(--haste)',
      lv:stats.hasteLv,xp:(G.skills.haste?.xp || 0),desc:'Trained during combat (on hit)'},
    {icon:'🛡️',label:'Defense',sub:'→ Armor & Block',val:`${stats.armor} / ${stats.blockChance}%`,color:'var(--armor)',
      lv:stats.defLv,xp:(G.skills.defense?.xp || 0),desc:'Trained during combat (on hit)'},
    {icon:'❤️',label:'Hitpoints',sub:'→ Max Health',val:stats.maxHp,color:'var(--hps)',
      lv:stats.hpLv,xp:(G.skills.hitpoints?.xp || XP_TABLE[9]),desc:'Trained during combat (on hit)'},
  ];
  const cgEl=document.getElementById('stats-combat-grid');
  if(cgEl){
    cgEl.innerHTML=combatCards.map(c=>{
      const prog=xpProgress(c.xp)*100;
      return `<div class="combat-stat-card">
        <div class="csc-icon">${iconPill(c.icon,'combat','md')}</div>
        <div class="csc-label">${c.label}</div>
        <div class="csc-value" style="color:${c.color}">${c.val}</div>
        <div class="csc-sublabel">${c.sub}</div>
        <div class="csc-level" style="color:${c.color}">Lv ${c.lv}</div>
        <div class="csc-bar"><div class="csc-bar-fill" style="width:${prog}%;background:${c.color}"></div></div>
      </div>`;
    }).join('');
  }

  // Combat sub-skills XP detail
  const cxEl=document.getElementById('stats-combat-xp');
  if(cxEl){
    const subSkills=[
      {key:'attack',icon:'🗡️',name:'Attack',color:'var(--crit)',effect:`${stats.critChance}% crit chance`},
      {key:'strength',icon:'💪',name:'Strength',color:'var(--power)',effect:`+${stats.power} power bonus`},
      {key:'haste',icon:'⚡',name:'Haste',color:'var(--haste)',effect:`Attack every ${stats.attackSpeed}`},
      {key:'defense',icon:'🛡️',name:'Defense',color:'var(--armor)',effect:`${stats.armor} armor, ${stats.blockChance}% block`},
      {key:'hitpoints',icon:'❤️',name:'Hitpoints',color:'var(--hps)',effect:`${stats.maxHp} max HP`},
    ];
    cxEl.innerHTML=subSkills.map(s=>{
      if(!G.skills[s.key])return ''; // Safety check
      const xp=G.skills[s.key].xp;
      const lv=xpToLevel(xp);
      const prog=xpProgress(xp)*100;
      const toNext=lv<99?xpToNextLevel(xp):0;
      return `<div style="margin-bottom:10px">
        <div style="display:flex;justify-content:space-between;margin-bottom:3px;align-items:center">
          <span style="font-weight:600;color:${s.color}">${s.icon} ${s.name} <span style="font-size:12px;font-family:'Share Tech Mono',monospace">Lv ${lv}</span></span>
          <span style="font-size:10px;color:var(--text3)">${s.effect}</span>
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <div style="flex:1;height:8px;background:var(--bg4);border-radius:4px;overflow:hidden">
            <div style="width:${prog}%;height:100%;background:${s.color};border-radius:4px;transition:width .4s"></div>
          </div>
          <span style="font-size:10px;color:var(--text2);font-family:'Share Tech Mono',monospace;white-space:nowrap">${fmt(xp)} XP${lv<99?' ('+fmt(toNext)+' to '+( lv+1)+')':' MAX'}</span>
        </div>
        <div style="font-size:9px;color:var(--text3);margin-top:2px">Trained during combat${s.key==='haste'?' (on hit)':s.key==='attack'?' (on hit)':s.key==='strength'?' (damage dealt)':s.key==='defense'?' (on hit)':s.key==='hitpoints'?' (on hit)':''}</div>
      </div>`;
    }).join('');
  }
  
  // Mastery Shop Purchases tracking
  const mtEl=document.getElementById('stats-mastery-track');
  if(mtEl){
    const skillsWithUpgrades=['woodcutting','mining','fishing','smithing','cooking','pickpocketing','combat'];
    const purchaseData=skillsWithUpgrades.map(skill=>{
      const upgrades=MASTERY_UPGRADES[skill]||[];
      const purchasedUpgrades=upgrades.map(upgrade=>{
        const key=`${skill}_${upgrade.id}`;
        const count=G.masteryUpgrades[key]||0;
        return {upgrade,count,skill};
      }).filter(p=>p.count>0); // Only show purchased upgrades
      return {skill,purchasedUpgrades};
    }).filter(s=>s.purchasedUpgrades.length>0); // Only show skills with purchases
    
    if(purchaseData.length===0){
      mtEl.innerHTML='<div style="color:var(--text3);font-size:12px">Visit the Mastery Shop to purchase permanent upgrades!</div>';
    }else{
      mtEl.innerHTML=purchaseData.map(s=>{
        const skillIcon={'woodcutting':'🪓','mining':'⛏️','fishing':'🎣','smithing':'🔨','cooking':'🍳','pickpocketing':'🥷','combat':'⚔️'}[s.skill];
        const skillName=s.skill.charAt(0).toUpperCase()+s.skill.slice(1);
        return `<div style="margin-bottom:14px">
          <div style="font-weight:600;margin-bottom:6px;color:var(--gold2)">${skillIcon} ${skillName}</div>
          ${s.purchasedUpgrades.map(p=>{
            const currentEffect=p.upgrade.stackEffect(p.count);
            const progressBars=[];
            for(let i=0;i<p.upgrade.maxPurchases;i++){
              const purchased=i<p.count;
              progressBars.push(`<span style="display:inline-block;width:20px;height:18px;background:${purchased?'var(--gold2)':'var(--bg4)'};border-radius:3px;margin-right:2px"></span>`);
            }
            return `<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;padding:8px;background:var(--bg3);border-radius:6px">
              <div style="flex:1">
                <div style="font-size:11px;font-weight:600;margin-bottom:2px">${p.upgrade.name}</div>
                <div style="font-size:10px;color:var(--gold2)">${currentEffect}</div>
              </div>
              <div style="display:flex;gap:1px">${progressBars.join('')}</div>
              <span style="font-size:10px;color:var(--text3);min-width:50px;text-align:right">${p.count}/${p.upgrade.maxPurchases}</span>
            </div>`;
          }).join('')}
        </div>`;
      }).join('');
    }
  }
}

function toggleMasteryPurchases(){
  const el=document.getElementById('stats-mastery-track');
  const toggle=document.getElementById('mastery-toggle');
  if(!el||!toggle)return;
  if(el.style.display==='none'){
    el.style.display='block';
    toggle.textContent='▼';
  }else{
    el.style.display='none';
    toggle.textContent='▶';
  }
}

function toggleBankSellSection(){
  const body=document.getElementById('bank-sell-body');
  const toggle=document.getElementById('bank-sell-toggle');
  if(!body||!toggle)return;
  const open=body.classList.toggle('open');
  toggle.textContent=open?'▼':'▶';
}

function toggleBankSelectMode(){
  window._bankSelectMode=!window._bankSelectMode;
  window._bankSelected={};
  const btn=document.getElementById('bank-select-btn');
  if(btn){
    btn.classList.toggle('active',window._bankSelectMode);
    btn.textContent=window._bankSelectMode?'✕ Cancel Select':'☑ Select Items';
  }
  renderBank();
}

function toggleBankItem(id){
  if(!window._bankSelected)window._bankSelected={};
  if(window._bankSelected[id])delete window._bankSelected[id];
  else window._bankSelected[id]=true;
  // Update just this item's visual without full re-render
  const el=document.querySelector(`.b-item[data-item-id="${id}"]`);
  if(el){
    const sel=window._bankSelected[id];
    el.classList.toggle('b-selected',!!sel);
    const cb=el.querySelector('.b-check');
    if(cb)cb.textContent=sel?'✓':'';
  }
  updateBankSelectedBar();
}

function updateBankSelectedBar(){
  const bar=document.getElementById('bank-selected-bar');
  if(!bar)return;
  const selected=window._bankSelected||{};
  const keys=Object.keys(selected);
  if(!window._bankSelectMode||keys.length===0){bar.classList.remove('visible');return;}
  let totalGold=0,totalItems=0;
  keys.forEach(id=>{
    const qty=G.bank[id]||0;
    totalGold+=(ITEMS[id]?.value||0)*qty;
    totalItems+=qty;
  });
  document.getElementById('bsb-count').textContent=`${keys.length} item type${keys.length!==1?'s':''} selected (${fmt(totalItems)} total)`;
  document.getElementById('bsb-value').textContent=`${fmt(totalGold)} gp`;
  bar.classList.add('visible');
}

function clearBankSelection(){
  window._bankSelected={};
  renderBank();
}

function sellSelected(){
  const selected=window._bankSelected||{};
  const keys=Object.keys(selected).filter(id=>G.bank[id]>0&&ITEMS[id]&&(ITEMS[id].value||0)>0);
  if(keys.length===0){notify('No sellable items selected!','info');return;}
  let totalGold=0,totalQty=0;
  const lines=keys.map(id=>{
    const qty=G.bank[id];
    const val=(ITEMS[id].value||0)*qty;
    totalGold+=val;
    totalQty+=qty;
    return `<div style="display:flex;justify-content:space-between;gap:12px;padding:3px 0;border-bottom:1px solid var(--border)">
      <span>${ITEMS[id].icon} ${ITEMS[id].name} <span style="color:var(--text3)">×${fmt(qty)}</span></span>
      <span style="color:var(--gold2);font-family:'Share Tech Mono',monospace">${fmt(val)}gp</span>
    </div>`;
  }).join('');
  showConfirmModal(
    '💰 Sell Selected Items',
    `<div style="padding:16px">
      <div style="max-height:220px;overflow-y:auto;margin-bottom:14px;font-size:13px">${lines}</div>
      <div style="font-size:13px;color:var(--text3);margin-bottom:6px">Total items: <span style="color:var(--text1)">${fmt(totalQty)}</span></div>
      <div style="font-size:13px;color:var(--text3);margin-bottom:14px;color:var(--red2);font-weight:500">⚠️ This cannot be undone!</div>
      <div style="font-size:20px;font-weight:700;color:var(--green2);border-top:2px solid var(--border);padding-top:12px">Total Gained: ${fmt(totalGold)}gp</div>
      <div style="font-size:12px;color:var(--text3);margin-top:8px">Balance After: ${fmt(G.gold+totalGold)}gp</div>
    </div>`,
    function(){
      keys.forEach(id=>{
        const qty=G.bank[id]||0;
        const val=(ITEMS[id].value||0)*qty;
        G.stats.totalGoldEarned+=val;
        G.stats.itemsSold+=qty;
        delete G.bank[id];
      });
      G.gold+=totalGold;
      window._bankSelected={};
      window._bankSelectMode=false;
      const btn=document.getElementById('bank-select-btn');
      if(btn){btn.classList.remove('active');btn.textContent='☑ Select Items';}
      updateHeader();
      renderBank();
      notify(`Sold ${keys.length} item types for ${fmt(totalGold)}gp`,'item');
    }
  );
}

function sellAllValueable(){
  // Sell everything with a value > 0, excluding equipped items and trinkets
  let totalGold=0,itemCount=0;
  const toSell=[];
  for(const [id,qty] of Object.entries(G.bank)){
    if(!ITEMS[id]||qty<=0)continue;
    if(ITEMS[id].cat==='trinket')continue; // Never sell trinkets
    if((ITEMS[id].value||0)<=0)continue;
    toSell.push({id,qty,value:ITEMS[id].value*qty});
    totalGold+=ITEMS[id].value*qty;
    itemCount+=qty;
  }
  if(toSell.length===0){notify('No valuables to sell!','info');return;}
  const preview=toSell.slice(0,8).map(x=>`${ITEMS[x.id].icon} ${ITEMS[x.id].name} ×${fmt(x.qty)}`).join(', ');
  const extra=toSell.length>8?` + ${toSell.length-8} more types`:'';
  showConfirmModal(
    '⚠️ Sell All Valuables',
    `<div style="text-align:center;padding:20px">
      <div style="font-size:28px;margin-bottom:12px">💸</div>
      <div style="font-size:14px;color:var(--red2);font-weight:600;margin-bottom:12px">This will sell EVERY item with a gold value!</div>
      <div style="font-size:12px;color:var(--text3);background:var(--bg3);border-radius:6px;padding:10px;margin-bottom:16px;text-align:left">${preview}${extra}</div>
      <div style="font-size:13px;color:var(--text3);margin-bottom:6px">Total Items: <span style="color:var(--text1)">${fmt(itemCount)}</span></div>
      <div style="font-size:13px;color:var(--red2);font-weight:600;margin-bottom:16px">⚠️ Trinkets are excluded. Cannot be undone!</div>
      <div style="font-size:20px;font-weight:700;color:var(--green2);border-top:2px solid var(--border);padding-top:12px">Total Gained: ${fmt(totalGold)}gp</div>
      <div style="font-size:12px;color:var(--text3);margin-top:8px">Balance After: ${fmt(G.gold+totalGold)}gp</div>
    </div>`,
    function(){
      toSell.forEach(({id,qty})=>{
        G.stats.totalGoldEarned+=(ITEMS[id].value||0)*qty;
        G.stats.itemsSold+=qty;
        delete G.bank[id];
      });
      G.gold+=totalGold;
      updateHeader();
      renderBank();
      notify(`Sold all valuables for ${fmt(totalGold)}gp`,'item');
    }
  );
}

function renderCombatPage(){
  if(currentPage!=='combat')return;
  // XP area
  const xpEl=document.getElementById('pgxp-combat');
  if(xpEl)xpEl.innerHTML=renderXPArea('combat');
  renderCombatHP();
  renderZoneGrid();
  renderFoodDisplay();
  // Show/hide arena based on whether a monster is selected
  const arenaWrap=document.getElementById('combat-arena-wrap');
  if(arenaWrap)arenaWrap.style.display=G.combat.monsterId?'block':'none';
}

function renderZoneGrid(){
  if(!G.skills.combat)G.skills.combat={xp:0,masteryXp:{}};
  const stats=getPlayerStats();
  const combatLv=stats.combatLevel;
  const zoneEl=document.getElementById('zone-select');
  if(!zoneEl)return;
  zoneEl.innerHTML=COMBAT_ZONES.map(z=>{
    const locked=combatLv<z.levelReq;
    const isActive=G.selectedZone===z.id;
    const nameParts=z.name.split(' ');
    const zoneEmoji=nameParts[0];
    const zoneName=nameParts.slice(1).join(' ');
    const zoneMonsters=MONSTERS.filter(m=>m.zone===z.id);
    const monsterCount=zoneMonsters.length;
    const minLv=Math.min(...zoneMonsters.map(m=>m.levelReq));
    const maxLv=Math.max(...zoneMonsters.map(m=>m.levelReq));
    const monsterIcons=zoneMonsters.slice(0,4).map(m=>m.icon).join(' ');
    // Check if player has any mastery in this zone
    const masteredCount=zoneMonsters.filter(m=>(G.skills.combat?.masteryXp?.[m.id]||0)>0).length;
    return `<div class="zone-card${locked?' z-locked':''}${isActive?' z-selected':''}" data-zone="${z.id}"
      onclick="${locked?'':'openZoneMonsters(this.dataset.zone)'}">`+`
      <div class="zc-top">
        <div class="zc-emoji">${iconPill(zoneEmoji,'combat','md')}</div>
        <div class="zc-info">
          <div class="zc-name">${zoneName}</div>
          <div class="zc-tier-badge">${z.tier}</div>
        </div>
        <div class="zc-req-badge ${locked?'zc-locked-badge':''}">${locked?'🔒 ':''}<strong>Lv ${z.levelReq}</strong></div>
      </div>
      <div class="zc-desc">${z.desc}</div>
      <div class="zc-footer">
        <span class="zc-monsters-preview">${monsterIcons}</span>
        <span class="zc-count">${monsterCount} monsters &middot; Lv ${minLv}–${maxLv}</span>
      </div>
      ${masteredCount>0?`<div class="zc-mastery-badge">⭐ ${masteredCount}/${monsterCount} mastered</div>`:''}
      ${locked?'':'<div class="zc-enter-hint">Click to explore →</div>'}
    </div>`;
  }).join('');
}

function renderFoodDisplay(){
  const foodEl=document.getElementById('food-display');
  if(!foodEl)return;
  const foods=['cooked_shrimp','cooked_trout','cooked_salmon','cooked_tuna','cooked_lobster','cooked_bass','cooked_swordfish','cooked_monkfish','cooked_shark','cooked_manta','cooked_turtle'];
  const available=foods.filter(f=>G.bank[f]&&G.bank[f]>0);
  if(available.length===0){
    foodEl.textContent='No food available. Cook some fish first!';
  }else{
    foodEl.innerHTML=available.map(f=>`
      <button class="food-btn" onclick="eatFood('${f}')" title="Click to eat">
        ${iconPill(ITEMS[f].icon,'food','sm')} ${ITEMS[f].name} × ${G.bank[f]} <span style="color:var(--green2)">(+${ITEMS[f].heals} HP)</span>
      </button>
    `).join('');
  }
}

function openZoneMonsters(zoneId){
  G.selectedZone=zoneId;
  const zone=COMBAT_ZONES.find(z=>z.id===zoneId);
  if(!zone)return;
  const stats=getPlayerStats();
  const combatLv=stats.combatLevel;
  const zoneMonsters=MONSTERS.filter(m=>m.zone===zoneId);
  const nameParts=zone.name.split(' ');
  const zoneEmoji=nameParts[0];
  const zoneName=nameParts.slice(1).join(' ');

  const monsterListHTML=zoneMonsters.map(m=>{
    const locked=combatLv<m.levelReq;
    const isCurrent=G.combat.monsterId===m.id;
    const mastLv=getMasteryLevel('combat',m.id);
    const mastXp=getMasteryXp('combat',m.id);
    const mastProg=xpProgress(mastXp)*100;
    const dropHints=m.drops.filter(d=>d.item).map(d=>ITEMS[d.item]?.name||d.item).slice(0,3).join(', ');
    const hasGold=m.drops.some(d=>d.gold);
    return `<div class="zm-card${locked?' zm-locked':''}${isCurrent?' zm-current':''}" data-mid="${m.id}"
      onclick="${locked?'':'pickMonster(this.dataset.mid)'}">`+`
      <div class="zm-head">
        <div class="zm-icon">${iconPill(m.icon,'combat','md')}</div>
        <div class="zm-info">
          <div class="zm-name">${m.name} ${isCurrent?'<span class="zm-active-badge">▶ Active</span>':''}</div>
          <div class="zm-level ${locked?'zm-level-locked':''}">
            ${locked?'🔒 Requires Lv '+m.levelReq:'Lv '+m.levelReq+'+'}
          </div>
        </div>
      </div>
      <div class="zm-stats">
        <div class="zm-stat"><span class="zm-stat-label">❤️ HP</span> ${m.maxHp}</div>
        <div class="zm-stat"><span class="zm-stat-label">⚔️ ATK</span> ${m.atk}</div>
        <div class="zm-stat"><span class="zm-stat-label">🛡️ DEF</span> ${m.def}</div>
        <div class="zm-stat"><span class="zm-stat-label">⭐ XP</span> ${m.xp}</div>
      </div>
      ${dropHints?`<div class="zm-drops">Drops: ${dropHints}${hasGold?' · Gold':''}</div>`:''}
      <div class="zm-mastery">
        <div class="zm-m-row">
          <span>Mastery Lv ${mastLv}</span>
          <span style="color:var(--text3);font-size:10px">${fmt(mastXp)} XP</span>
        </div>
        <div class="zm-m-bar"><div class="zm-m-fill" style="width:${mastProg}%"></div></div>
      </div>
    </div>`;
  }).join('');

  const modal=document.getElementById('modal-overlay');
  const titleEl=document.getElementById('modal-title');
  const bodyEl=document.getElementById('modal-body');
  const footer=modal.querySelector('.modal-footer');
  titleEl.innerHTML=iconPill(zoneEmoji,'combat','sm')+' '+zoneName+' — <small style="color:var(--text3)">'+zone.tier+' tier</small>';
  bodyEl.innerHTML=`
    <div style="font-size:12px;color:var(--text2);margin-bottom:14px;padding-bottom:10px;border-bottom:1px solid var(--border)">${zone.desc} — <strong style="color:var(--text)">${zoneMonsters.length} monsters</strong></div>
    <div class="zm-list">${monsterListHTML}</div>`;
  footer.innerHTML=`<button class="btn" onclick="closeModal()">← Back to Zones</button>`;
  modal.classList.add('open','modal-wide');
}

function pickMonster(id){
  closeModal();
  selectMonster(id);
  // Scroll arena into view
  setTimeout(()=>{
    const arena=document.getElementById('combat-arena-wrap');
    if(arena)arena.scrollIntoView({behavior:'smooth',block:'start'});
  },80);
}

function openZoneGrid(){
  // Called from "Change Monster" button in arena — just scroll down to zone grid
  const grid=document.getElementById('zone-grid-wrap');
  if(grid)grid.scrollIntoView({behavior:'smooth',block:'start'});
}

function selectZone(zoneId){
  G.selectedZone=zoneId;
  openZoneMonsters(zoneId);
}
function renderCombatHP(){
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  const monster=MONSTERS.find(m=>m.id===G.combat.monsterId);
  const el=document.getElementById('combatants-display');
  if(!el)return;
  const playerPct=Math.max(0,G.combat.playerHp/stats.maxHp*100);
  const monsterPct=G.combat.active&&G.combat.maxMonsterHp>0?Math.max(0,G.combat.monsterHp/G.combat.maxMonsterHp*100):100;
  el.innerHTML=`
    <div class="combatant">
      <div class="comb-name" style="color:var(--blue2)">You</div>
      <div class="comb-hp-label">${Math.floor(G.combat.playerHp)} / ${stats.maxHp} HP</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-player" style="width:${playerPct}%"></div></div>
      <div class="combatant-mini-stats">
        <span style="color:var(--crit)">${iconPill('🗡️','skill','sm')} ${stats.critChance}%</span>
        <span style="color:var(--power)">${iconPill('💪','combat','sm')} +${stats.power}</span>
        <span style="color:var(--haste)">${iconPill('⚡','skill','sm')} ${stats.attackSpeed}</span>
      </div>
    </div>
    <div class="vs-badge"><span style="color:var(--red2);font-family:'Cinzel',serif;font-size:14px;letter-spacing:1px">VS</span></div>
    <div class="combatant">
      <div class="comb-name" style="color:var(--red2)">${monster?iconPill(monster.icon,'combat','sm')+' '+monster.name:'No Monster'}</div>
      <div class="comb-hp-label">${G.combat.active?Math.floor(G.combat.monsterHp)+' / '+G.combat.maxMonsterHp+' HP':'--- HP'}</div>
      <div class="hp-bar-wrap"><div class="hp-fill hp-fill-monster" style="width:${monsterPct}%"></div></div>
      ${monster?`<div style="font-size:10px;color:var(--text3);margin-top:3px">ATK ${monster.atk} | DEF ${monster.def} | 🛡️ ${stats.blockChance}% Block</div>`:''}
    </div>`;
  
  // ========== UPDATE MASTERY DISPLAY ==========
  const masteryDisplay=document.getElementById('combat-mastery-display');
  if(monster && masteryDisplay){
    // Show mastery display
    masteryDisplay.style.display='block';
    
    // Get mastery XP for current monster
    const masteryXp=G.skills.combat?.masteryXp?.[monster.id]||0;
    const masteryLv=getMasteryLevel('combat',monster.id);
    const masteryPct=getMasteryProgress('combat',monster.id);
    
    // Update mastery bar and text - show XP instead of percentage
    const masteryBar=document.getElementById('combat-mastery-bar');
    const masteryText=document.getElementById('combat-mastery-text');
    if(masteryBar)masteryBar.style.width=`${masteryPct}%`;
    if(masteryText)masteryText.textContent=`Lv ${masteryLv} - ${fmt(masteryXp)} XP`;
  } else if(masteryDisplay){
    // Hide mastery display if no monster selected
    masteryDisplay.style.display='none';
  }
  // ============================================
}
function selectMonster(id){
  if(G.combat.active)stopCombat();
  G.combat.monsterId=id;
  renderCombatPage();
  const arenaWrap=document.getElementById('combat-arena-wrap');
  if(arenaWrap)arenaWrap.style.display='block';
  renderZoneGrid(); // highlight the active zone
}
function startCombat(){startCombatAction();}

function updateEquipmentStats(){
  // Update combat stats display on equipment page
  const statsEl=document.getElementById('stats-display');
  if(!statsEl)return;
  
  const stats=getPlayerStats();
  const combatLv=stats.combatLevel; // Use calculated combat level
  
  statsEl.innerHTML=`<h3>⚔️ Combat Summary</h3>
    <div class="stat-row"><span class="sr-label">⚔️ Combat Level</span><span class="sr-val">${combatLv}</span></div>
    <div class="stat-row" style="font-size:10px;color:var(--text3);margin-top:-4px;margin-bottom:4px">
      <span style="margin-left:20px">🗡️${stats.atkLv} 💪${stats.strLv} ⚡${stats.hasteLv} 🛡️${stats.defLv} ❤️${stats.hpLv}</span>
    </div>
    <div class="stat-row"><span class="sr-label">🗡️ Crit Chance</span><span class="sr-val" style="color:var(--crit)">${stats.critChance}%</span></div>
    <div class="stat-row"><span class="sr-label">💪 Power</span><span class="sr-val" style="color:var(--power)">+${stats.power} dmg</span></div>
    <div class="stat-row"><span class="sr-label">⚡ Attack Speed</span><span class="sr-val" style="color:var(--haste)">${stats.attackSpeed}</span></div>
    <div class="stat-row"><span class="sr-label">🛡️ Armor</span><span class="sr-val" style="color:var(--armor)">${stats.armor}${stats.eqDef?`<span class="sr-bonus">+${stats.eqDef} eq</span>`:''}</span></div>
    <div class="stat-row"><span class="sr-label">🚫 Block Chance</span><span class="sr-val" style="color:var(--armor)">${stats.blockChance}%</span></div>
    <div class="stat-row"><span class="sr-label">❤️ Max HP</span><span class="sr-val" style="color:var(--hps)">${stats.maxHp}</span></div>
    <div class="stat-row"><span class="sr-label">Current HP</span><span class="sr-val" style="color:var(--green2)">${Math.floor(G.combat.playerHp)}</span></div>`;
}

function renderEquipPage(){
  if(currentPage!=='equipment')return;
  const stats=getPlayerStats();

  // ── SLOT RENDERER ────────────────────────────────────────────────────────
  function renderSlot(s){
    const itemId=G.equipment[s.key];
    const item=itemId?ITEMS[itemId]:null;
    const infusionLevel=G.infusion[s.key]||0;
    const infusionBonus=infusionLevel>0?getInfusionBonusText(s.key,infusionLevel):'';
    return `<div class="equip-slot${item?' filled':''}" onclick="openEquipModal('${s.key}')">
      ${item?`<button class="es-unequip" onclick="event.stopPropagation();unequipItem('${s.key}')">✕</button>`:''}
      <div class="es-label">${s.label}${infusionLevel>0?' <span style="color:var(--gold2)">+'+infusionLevel+'</span>':''}</div>
      <div class="es-icon">${item?item.icon:s.icon}</div>
      <div class="${item?'es-name':'es-empty'}">${item?item.name:'Empty'}</div>
      ${item&&s.key==='tool'&&item.speedBonus?`<div class="es-stat" style="color:var(--haste)">-${item.speedBonus}% ${item.skill} time</div>`:''}
      ${item&&s.key==='amulet'&&item.bonus?`<div class="es-stat" style="color:var(--gold2);font-size:10px">${item.bonus}</div>`:''}
      ${item&&(s.key==='ring1'||s.key==='ring2')&&item.bonus?`<div class="es-stat" style="color:var(--purple2);font-size:10px">${item.bonus}</div>`:''}
      ${item&&!['tool','amulet','ring1','ring2'].includes(s.key)&&(item.atk||item.def)?`<div class="es-stat">${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}</div>`:''}
      ${item&&item.bonus&&!['tool','amulet','ring1','ring2'].includes(s.key)?`<div class="es-stat" style="font-size:10px;color:var(--gold2)">${item.bonus}</div>`:''}
      ${infusionBonus?`<div class="es-stat" style="font-size:10px;color:var(--green2)">✨ ${infusionBonus}</div>`:''}
    </div>`;
  }

  // ── COMBAT SLOTS (2-col grid) ─────────────────────────────────────────
  const combatEl=document.getElementById('equip-slots-combat');
  if(combatEl){
    const combatSlots=[
      {key:'weapon',label:'Weapon',icon:'⚔️'},
      {key:'helmet',label:'Helmet',icon:'⛑️'},
      {key:'body',label:'Body',icon:'🧥'},
      {key:'legs',label:'Legs',icon:'👖'},
      {key:'gloves',label:'Gloves',icon:'🧤'},
      {key:'boots',label:'Boots',icon:'🥾'},
      {key:'shield',label:'Shield',icon:'🛡️'},
    ];
    combatEl.innerHTML=combatSlots.map(renderSlot).join('');
  }

  // ── UTILITY SLOTS (single col) ────────────────────────────────────────
  const utilityEl=document.getElementById('equip-slots-utility');
  if(utilityEl){
    const utilitySlots=[
      {key:'trinket',label:'Trinket',icon:'💎'},
      {key:'tool',label:'Skilling Tool',icon:'🪚'},
      {key:'amulet',label:'Amulet',icon:'📿'},
      {key:'ring1',label:'Ring Slot 1',icon:'💍'},
      {key:'ring2',label:'Ring Slot 2',icon:'💍'},
    ];
    utilityEl.innerHTML=utilitySlots.map(renderSlot).join('');
  }

  // ── COMBAT STATS ──────────────────────────────────────────────────────
  updateEquipmentStats();

  // ── INFUSION ROW ──────────────────────────────────────────────────────
  const infusionEl=document.getElementById('infusion-options');
  if(infusionEl){
    const infusableSlots=['weapon','helmet','body','legs','gloves','boots','shield'];
    const equippedInfusable=infusableSlots.filter(slot=>G.equipment[slot]);
    if(equippedInfusable.length===0){
      infusionEl.innerHTML='<div style="color:var(--text3);font-size:12px;text-align:center;padding:20px;width:100%">Equip combat gear to begin infusion</div>';
    }else{
      infusionEl.innerHTML=equippedInfusable.map(slot=>{
        const itemId=G.equipment[slot];
        const item=ITEMS[itemId];
        const currentLevel=G.infusion[slot]||0;
        const nextLevel=currentLevel+1;
        const maxLevel=10;
        const canInfuse=nextLevel<=maxLevel;

        let materialId=null,materialCost=0;
        if(nextLevel<=3){
          if(itemId.includes('bronze'))materialId='bronze_bar';
          else if(itemId.includes('iron'))materialId='iron_bar';
          else if(itemId.includes('silver'))materialId='silver_bar';
          else if(itemId.includes('steel'))materialId='steel_bar';
          else if(itemId.includes('mithril'))materialId='mithril_bar';
          else if(itemId.includes('adamant'))materialId='adamant_bar';
          else if(itemId.includes('rune'))materialId='rune_bar';
          else if(itemId.includes('dragon'))materialId='dragon_bar';
          materialCost=500;
        }else if(nextLevel<=6){materialId='rune_bar';materialCost=1500;}
        else if(nextLevel<=9){materialId='dragon_bar';materialCost=3000;}
        else{materialId='infusion_crystal';materialCost=1;}

        const hasMaterial=materialId&&(G.bank[materialId]||0)>=materialCost;
        const bonusText=getInfusionBonusText(slot,nextLevel);

        let goldCost;
        if(nextLevel<=3)goldCost=nextLevel*10000;
        else if(nextLevel<=6)goldCost=(nextLevel-3)*25000+25000;
        else if(nextLevel<=9)goldCost=(nextLevel-6)*50000+100000;
        else goldCost=500000;
        const hasGold=G.gold>=goldCost;

        const rankPips=Array.from({length:maxLevel},(_,i)=>
          `<div class="inf-rank${i<currentLevel?' filled':''}" title="Rank ${i+1}"></div>`
        ).join('');

        return `<div class="infusion-item">
          <div class="inf-header">
            <div class="inf-slot-name">${item.icon} ${slot.charAt(0).toUpperCase()+slot.slice(1)}</div>
            <div class="inf-level${currentLevel>=10?' inf-max-badge':''}">+${currentLevel}</div>
          </div>
          <div style="font-size:9px;color:var(--text3);margin-bottom:6px">${getInfusionBonusText(slot,1).replace(/\+\d+%/,'').trim()}</div>
          <div class="inf-progress">${rankPips}</div>
          ${canInfuse?`
            <div class="inf-cost">
              <div>${materialId?ITEMS[materialId]?.icon+' ':''}<b>${fmt(materialCost)}</b> ${materialId?ITEMS[materialId]?.name||materialId:''}
                ${hasMaterial?'<span style="color:var(--green2)">✓</span>':'<span style="color:var(--red2)">✗</span>'}
              </div>
              <div>💰 <b style="color:var(--gold2)">${fmt(goldCost)}gp</b>
                ${hasGold?'<span style="color:var(--green2)">✓</span>':'<span style="color:var(--red2)">✗</span>'}
              </div>
            </div>
            <div class="inf-bonus">→ ${bonusText}</div>
            <button class="inf-button" ${!hasMaterial||!materialId||!hasGold?'disabled':''} onclick="infuseGear('${slot}','${materialId}',${materialCost},${goldCost})">Infuse to +${nextLevel}</button>
          `:`
            <div class="inf-max">✨ Max Rank</div>
            <div class="inf-bonus" style="color:var(--green2)">${getInfusionBonusText(slot,currentLevel)}</div>
          `}
        </div>`;
      }).join('');
    }
  }
}
function getInfusionBonusText(slot,level){
  // Offensive stats scale at 1% per rank; defensive stats (armor/block/maxHp/atkSpeed) at 0.7%
  const offPct=level;
  const defPct=parseFloat((level*0.7).toFixed(1));
  const slotText={
    weapon:`+${offPct}% Eq. ATK, Crit, Power`,
    helmet:`+${offPct}% Eq. DEF, Crit, Power · +${defPct}% Armor, Block`,
    body:  `+${offPct}% Eq. DEF, Crit, Power · +${defPct}% Armor, Block`,
    legs:  `+${offPct}% Eq. DEF, Crit, Power · +${defPct}% Armor, Block`,
    gloves:`+${offPct}% Eq. DEF · +${defPct}% Max HP, Armor, Block`,
    boots: `+${offPct}% Eq. DEF · +${defPct}% Atk Speed, Armor, Block`,
    shield:`+${offPct}% Eq. DEF · +${defPct}% Armor, Block, Max HP`,
  };
  return slotText[slot]||`+${offPct}%`;
}

function infuseGear(slot,materialId,materialCost,goldCost){
  const currentLevel=G.infusion[slot]||0;
  if(currentLevel>=10){
    notify('This gear is already at maximum infusion!','error');
    return;
  }
  
  // Check gold first
  if(G.gold<goldCost){
    notify(`Not enough gold! Need ${fmt(goldCost)}gp`,'error');
    return;
  }
  // Check materials
  if(!removeFromBank(materialId,materialCost)){
    notify('Not enough materials!','error');
    return;
  }
  // Deduct gold
  G.gold-=goldCost;
  G.infusion[slot]=(G.infusion[slot]||0)+1;
  const newLevel=G.infusion[slot];
  notify(`✨ ${slot.charAt(0).toUpperCase()+slot.slice(1)} infused to +${newLevel}!`,'success');
  renderEquipPage();
  updateEquipmentStats(); // Update combat stats in real-time
  renderSidebar(); // Update sidebar stats in real-time
  saveGame();
}

// Returns 1-2 HTML lines describing what a piece of equipment does
function getItemStatLines(item){
  const SKILL_LABELS={
    woodcutting:'Woodcutting',mining:'Mining',fishing:'Fishing',
    pickpocketing:'Pickpocketing',woodworking:'Woodworking',
    prospecting:'Prospecting',jewelcrafting:'Jewelcrafting'
  };
  if(item.cat==='tool'){
    const skillName=SKILL_LABELS[item.skill]||item.skill;
    return `<span style="color:var(--haste)">-${item.speedBonus}% ${skillName} speed</span>`;
  }
  if(item.cat==='jewelry'){
    if(item.amuletType==='gathering'){
      return `<span style="color:var(--gold2)">${item.bonus}</span>`+
             `<span style="color:var(--text3);font-size:10px;display:block;margin-top:2px">Woodcutting · Mining · Fishing · Pickpocketing</span>`;
    }
    if(item.amuletType==='artisan'){
      return `<span style="color:var(--gold2)">${item.bonus}</span>`+
             `<span style="color:var(--text3);font-size:10px;display:block;margin-top:2px">Cooking · Smithing · Woodworking · Prospecting · Jewelcrafting</span>`;
    }
    if(item.amuletType==='combat'){
      return `<span style="color:var(--red2)">${item.bonus}</span>`+
             `<span style="color:var(--text3);font-size:10px;display:block;margin-top:2px">ATK & DEF for all combat</span>`;
    }
    if(item.ringSkill){
      const skillName=SKILL_LABELS[item.ringSkill]||item.ringSkill;
      return `<span style="color:var(--purple2)">-${item.speedBonus}% ${skillName} speed</span>`;
    }
    // Combat rings
    return `<span style="color:var(--purple2)">${item.bonus}</span>`;
  }
  // Armour / weapon / trinket
  return `${item.atk?'+'+item.atk+' ATK':''}${item.def?' +'+item.def+' DEF':''}${item.bonus?' '+item.bonus:''}`;
}

function openEquipModal(slot){
  // ring1 and ring2 both show items with slot:'ring'
  const filterSlot=(slot==='ring1'||slot==='ring2')?'ring':slot;
  const equipItems=Object.entries(G.bank).filter(([id,qty])=>qty>0&&ITEMS[id]&&ITEMS[id].slot===filterSlot);
  const modal=document.getElementById('modal-overlay');
  const slotLabel=slot==='ring1'?'Ring Slot 1':slot==='ring2'?'Ring Slot 2':slot.charAt(0).toUpperCase()+slot.slice(1).replace('tool','Skilling Tool');
  document.getElementById('modal-title').textContent='Equip '+slotLabel;
  const body=document.getElementById('modal-body');
  if(equipItems.length===0){body.innerHTML='<div style="color:var(--text3);padding:10px">No equipment of this type in your bank.</div>';}
  else{
    const stats=getPlayerStats();
    body.innerHTML=equipItems.map(([id,qty])=>{
      const item=ITEMS[id];
      let canEquip=true;
      let reqText='';
      if(item.reqAtk&&stats.baseAtkLv<item.reqAtk){canEquip=false;reqText+=`${item.reqAtk} Atk `;}
      if(item.reqStr&&stats.baseStrLv<item.reqStr){canEquip=false;reqText+=`${item.reqStr} Str `;}
      if(item.reqDef&&stats.baseDefLv<item.reqDef){canEquip=false;reqText+=`${item.reqDef} Def `;}
      const statLine=getItemStatLines(item);
      return `<div class="equip-list-item${canEquip?'':' eli-locked'}" onclick="${canEquip?'equipItemToSlot(\''+id+'\',\''+slot+'\');closeModal()':''}">
        <span class="eli-icon">${item.icon}</span>
        <div class="eli-info">
          <div class="eli-name">${item.name}</div>
          <div class="eli-stat">${statLine}</div>
          ${reqText?`<div style="color:var(--red2);font-size:10px">Requires: ${reqText}</div>`:''}
        </div>
        <span class="eli-qty">x${qty}</span>
      </div>`;
    }).join('');
  }
  modal.classList.add('open');
}
function closeModal(){const mo=document.getElementById('modal-overlay');mo.classList.remove('open');mo.classList.remove('modal-wide');}

// Equip item to a specific slot (used for ring1/ring2 disambiguation)
function equipItemToSlot(id,slot){
  const item=ITEMS[id];
  if(!item||!item.slot)return;
  if(!G.bank[id]||G.bank[id]<=0)return;
  // Validate level requirements
  const stats=getPlayerStats();
  if(item.reqAtk&&stats.baseAtkLv<item.reqAtk){notify(`Requires ${item.reqAtk} Attack!`,'info');return;}
  if(item.reqStr&&stats.baseStrLv<item.reqStr){notify(`Requires ${item.reqStr} Strength!`,'info');return;}
  if(item.reqDef&&stats.baseDefLv<item.reqDef){notify(`Requires ${item.reqDef} Defense!`,'info');return;}
  // Unequip whatever is in the target slot
  if(G.equipment[slot])addToBank(G.equipment[slot],1);
  removeFromBank(id,1);
  G.equipment[slot]=id;
  renderEquipPage();
  updateEquipmentStats();
  renderSidebar();
  updateHeader();
  notify(`Equipped ${item.name}!`,'item');
}

// Confirmation modal for buy/sell actions
function showConfirmModal(title,message,onConfirm,infoOnly=false){
  const modal=document.getElementById('modal-overlay');
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-body').innerHTML=message;
  
  // Update footer based on mode
  const footer=modal.querySelector('.modal-footer');
  if(infoOnly || !onConfirm){
    // Info-only mode: single Close button
    footer.innerHTML=`<button class="btn" onclick="closeModal()">Close</button>`;
  }else{
    // Confirmation mode: Cancel and Confirm buttons
    footer.innerHTML=`
      <button class="btn" onclick="closeModal()">Cancel</button>
      <button class="btn" style="background:var(--green2);color:white" id="confirm-btn">Confirm</button>
    `;
    
    // Add confirm handler
    document.getElementById('confirm-btn').onclick=function(){
      closeModal();
      onConfirm();
    };
  }
  
  modal.classList.add('open');
}

function equipItem(id){
  const item=ITEMS[id];
  if(!item||!item.slot)return;
  if(!G.bank[id]||G.bank[id]<=0)return;
  
  // Check level requirements (use base levels, not infused)
  const stats=getPlayerStats();
  if(item.reqAtk){
    if(stats.baseAtkLv<item.reqAtk){
      notify(`Requires ${item.reqAtk} Attack to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqStr){
    if(stats.baseStrLv<item.reqStr){
      notify(`Requires ${item.reqStr} Strength to equip ${item.name}!`,'info');
      return;
    }
  }
  if(item.reqDef){
    if(stats.baseDefLv<item.reqDef){
      notify(`Requires ${item.reqDef} Defense to equip ${item.name}!`,'info');
      return;
    }
  }
  
  // Handle ring slot — auto-assign to ring1 or ring2
  let targetSlot=item.slot;
  if(item.slot==='ring'){
    targetSlot=!G.equipment.ring1?'ring1':!G.equipment.ring2?'ring2':'ring1';
  }
  if(G.equipment[targetSlot]){
    addToBank(G.equipment[targetSlot],1);
  }
  removeFromBank(id,1);
  G.equipment[targetSlot]=id;
  renderEquipPage();
  updateEquipmentStats(); // Update combat stats in real-time
  renderSidebar(); // Update sidebar stats in real-time
  updateHeader();
  notify(`Equipped ${item.name}!`,'item');
}
function equipItemFromBank(id){equipItem(id);}
function unequipItem(slot){
  if(!G.equipment[slot])return;
  const id=G.equipment[slot];
  addToBank(id,1);
  G.equipment[slot]=null;
  renderEquipPage();
  updateEquipmentStats(); // Update combat stats in real-time
  renderSidebar(); // Update sidebar stats in real-time
  updateHeader();
  notify(`Unequipped ${ITEMS[id].name}`,'info');
}

// ============================================================
// NOTIFICATIONS
// ============================================================
function notify(msg,type='info'){
  const el=document.createElement('div');
  const cls={lvl:'notif-lvl',item:'notif-item',combat:'notif-combat',info:'notif-info'}[type]||'notif-info';
  el.className=`notif ${cls}`;
  
  // Add close button
  const closeBtn=document.createElement('button');
  closeBtn.className='notif-close';
  closeBtn.innerHTML='✕';
  closeBtn.onclick=(e)=>{
    e.stopPropagation();
    el.remove();
  };
  
  const msgSpan=document.createElement('span');
  msgSpan.textContent=msg;
  msgSpan.style.flex='1';
  
  el.appendChild(msgSpan);
  el.appendChild(closeBtn);
  el.style.display='flex';
  el.style.alignItems='center';
  el.style.gap='8px';
  
  document.getElementById('notifs').appendChild(el);
  setTimeout(()=>el.remove(),3000);
}

// ============================================================
// OFFLINE BANNER
// ============================================================
function showOfflineBanner(banner){
  if(!banner)return;
  
  let contentHtml='';
  
  // Check if it's combat data
  if(banner.combat){
    const c=banner.combat;
    contentHtml=`<strong>⚔️ Combat Results</strong><br>`;
    
    // Kills
    if(c.kills>0){
      contentHtml+=`<div style="margin-top:6px"><strong>💀 Defeated:</strong> ${c.kills}x ${c.monster}</div>`;
    }else{
      contentHtml+=`<div style="margin-top:6px"><strong>No enemies defeated</strong></div>`;
    }
    
    // Loot
    if(c.gold>0||Object.keys(c.loot).length>0){
      contentHtml+=`<div style="margin-top:4px"><strong>💰 Loot:</strong> `;
      const lootParts=[];
      if(c.gold>0)lootParts.push(`${fmt(c.gold)}gp`);
      for(const [itemId,qty] of Object.entries(c.loot)){
        lootParts.push(`${qty}x ${ITEMS[itemId].name}`);
      }
      contentHtml+=lootParts.join(', ')+'</div>';
    }
    
    // XP
    const xpParts=[];
    if(c.xp.combat>0)xpParts.push(`⚔️ ${fmt(c.xp.combat)}`);
    if(c.xp.attack>0)xpParts.push(`🗡️ ${fmt(c.xp.attack)}`);
    if(c.xp.strength>0)xpParts.push(`💪 ${fmt(c.xp.strength)}`);
    if(c.xp.defense>0)xpParts.push(`🛡️ ${fmt(c.xp.defense)}`);
    if(c.xp.hitpoints>0)xpParts.push(`❤️ ${fmt(c.xp.hitpoints)}`);
    if(xpParts.length>0){
      contentHtml+=`<div style="margin-top:4px"><strong>📈 XP:</strong> ${xpParts.join(', ')}</div>`;
    }
    
    // Levels
    if(Object.keys(c.levels).length>0){
      const lvlParts=[];
      for(const [skill,levelData] of Object.entries(c.levels)){
        const emoji={combat:'⚔️',attack:'🗡️',strength:'💪',defense:'🛡️',hitpoints:'❤️',haste:'⚡'}[skill]||'';
        lvlParts.push(`${emoji} ${skill.charAt(0).toUpperCase()+skill.slice(1)} ${levelData.start} → ${levelData.end}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>🎉 Levels:</strong> ${lvlParts.join(', ')}</div>`;
    }
    
    // Food
    if(Object.keys(c.food).length>0){
      const foodParts=[];
      for(const [foodId,qty] of Object.entries(c.food)){
        foodParts.push(`${qty}x ${ITEMS[foodId].name}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>🍖 Food:</strong> ${foodParts.join(', ')}</div>`;
    }
    
    // Died warning
    if(c.died){
      contentHtml+=`<div style="margin-top:4px;color:var(--red2)"><strong>💀 You died!</strong> Combat stopped. Click "Start Combat" to resume.</div>`;
    }
    
  }else if(banner.skill){
    // Detailed skill results
    const s=banner.skill;
    const skillEmoji={
      woodcutting:'🪓',
      mining:'⛏️',
      fishing:'🎣',
      smithing:'🔨',
      cooking:'🍳',
      pickpocketing:'🥷'
    }[s.skill]||'⚙️';
    
    contentHtml=`<strong>${skillEmoji} ${s.skill.charAt(0).toUpperCase()+s.skill.slice(1)} Results</strong><br>`;
    contentHtml+=`<div style="margin-top:6px"><strong>📋 Action:</strong> ${s.action}</div>`;
    
    // Materials used (for crafting skills)
    if(Object.keys(s.materialsUsed).length>0){
      const matParts=[];
      for(const [itemId,qty] of Object.entries(s.materialsUsed)){
        matParts.push(`${qty}x ${ITEMS[itemId]?.name||itemId}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>📦 Used:</strong> ${matParts.join(', ')}</div>`;
    }
    
    // Items produced
    if(Object.keys(s.itemsProduced).length>0){
      const prodParts=[];
      for(const [itemId,qty] of Object.entries(s.itemsProduced)){
        prodParts.push(`${qty}x ${ITEMS[itemId]?.name||itemId}`);
      }
      contentHtml+=`<div style="margin-top:4px"><strong>✨ Produced:</strong> ${prodParts.join(', ')}</div>`;
    }
    
    // Gold gained (for pickpocketing)
    if(s.goldGained&&s.goldGained>0){
      contentHtml+=`<div style="margin-top:4px"><strong>💰 Gold Gained:</strong> ${fmt(s.goldGained)}gp</div>`;
    }
    
    // XP gained
    if(s.xpGained>0){
      contentHtml+=`<div style="margin-top:4px"><strong>📈 XP:</strong> ${fmt(s.xpGained)}</div>`;
    }
    
    // Levels gained
    if(s.endLevel>s.startLevel){
      contentHtml+=`<div style="margin-top:4px"><strong>🎉 Level:</strong> ${s.startLevel} → ${s.endLevel}</div>`;
    }
    
  }else if(banner.results){
    // Legacy format (shouldn't happen anymore)
    contentHtml=`<strong>While you were gone:</strong> ${banner.results.join(', ')}!`;
  }else{
    contentHtml='Your character rested.';
  }
  
  const html=`<div class="offline-banner">
    <div class="ob-icon">${iconPill('⏰','misc')}</div>
    <div class="ob-text">
      <strong>Welcome back!</strong> You were away for ${banner.time}.<br>
      ${contentHtml}
    </div>
    <button class="ob-close" onclick="this.parentElement.remove()">✕</button>
  </div>`;
  const content=document.getElementById('content');
  const temp=document.createElement('div');
  temp.innerHTML=html;
  const bannerEl=temp.firstChild;
  content.insertBefore(bannerEl,content.firstChild);
  
  // Auto-dismiss after 30 seconds (increased for detailed info)
  setTimeout(()=>{
    if(bannerEl&&bannerEl.parentElement){
      bannerEl.style.transition='opacity 0.3s';
      bannerEl.style.opacity='0';
      setTimeout(()=>bannerEl.remove(),300);
    }
  },30000);
}

// ============================================================
// CONTRACTS SYSTEM
// ============================================================
function generateContracts(){
  const contracts=[];
  const availableTemplates=CONTRACT_TEMPLATES.filter(t=>{
    const skillLv=xpToLevel(G.skills[t.skill]?.xp||0);
    return skillLv>=t.minLv;
  });
  
  // Pick 3-5 random contracts from available templates
  const numContracts=3+Math.floor(Math.random()*3);
  const shuffled=[...availableTemplates].sort(()=>Math.random()-0.5);
  for(let i=0;i<Math.min(numContracts,shuffled.length);i++){
    const template=shuffled[i];
    contracts.push({
      id:template.id+'_'+Date.now()+'_'+i,
      templateId:template.id,
      tier:template.tier,
      icon:template.icon,
      skill:template.skill,
      requirements:template.requirements,
      rewards:template.rewards,
      completed:false,
    });
  }
  return contracts;
}

function refreshContracts(){
  G.contracts=generateContracts();
  G.contractsLastRefresh=Date.now();
  renderContractsPage();
  notify('New contracts available!','info');
}

function canCompleteContract(contract){
  for(const req of contract.requirements){
    if(req.gold!==undefined){
      if(G.gold<req.gold)return false;
    } else {
      const have=G.bank[req.item]||0;
      if(have<req.qty)return false;
    }
  }
  return true;
}

function completeContract(contractId){
  const contract=G.contracts.find(c=>c.id===contractId);
  if(!contract||contract.completed)return;
  if(!canCompleteContract(contract)){
    notify('Missing required items!','info');
    return;
  }
  
  // Remove required items / deduct gold
  for(const req of contract.requirements){
    if(req.gold!==undefined){
      G.gold-=req.gold;
      G.stats.totalGoldSpent+=req.gold;
    } else {
      removeFromBank(req.item,req.qty);
    }
  }
  
  // Give rewards
  if(contract.rewards.gold){
    G.gold+=contract.rewards.gold;
  }
  if(contract.rewards.items){
    for(const item of contract.rewards.items){
      addToBank(item.id,item.qty);
      notify(`Received ${item.qty}x ${ITEMS[item.id].name}!`,'item');
    }
  }
  if(contract.rewards.xp&&G.skills[contract.skill]){
    G.skills[contract.skill].xp+=contract.rewards.xp;
    G.stats.contractXpGained+=contract.rewards.xp;
  }
  
  G.stats.contractsCompleted++;
  contract.completed=true;
  updateHeader();
  renderContractsPage();
  renderSidebar();
  notify(`Contract completed! +${contract.rewards.gold}g`,'item');
  
  // Check if all completed
  if(G.contracts.every(c=>c.completed)){
    setTimeout(()=>refreshContracts(),1000);
  }
}

function renderContractsPage(){
  const grid=document.getElementById('contract-grid');
  const refreshTimer=document.getElementById('contract-refresh-timer');
  
  // Validate contracts - remove any with invalid items (gold requirements are always valid)
  G.contracts=G.contracts.filter(contract=>{
    return contract.requirements.every(req=>req.gold!==undefined||ITEMS[req.item]!==undefined);
  });
  
  // Check if we need to generate initial contracts
  if(G.contracts.length===0){
    G.contracts=generateContracts();
    G.contractsLastRefresh=Date.now();
  }
  
  // Refresh timer
  const CONTRACT_REFRESH_HOURS=4;
  const nextRefresh=G.contractsLastRefresh+(CONTRACT_REFRESH_HOURS*60*60*1000);
  const timeUntil=nextRefresh-Date.now();
  const allCompleted=G.contracts.every(c=>c.completed);
  
  if(allCompleted){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">🔄 All Complete! Get New Contracts</button>`;
  }else if(timeUntil<=0){
    refreshTimer.innerHTML=`<button class="btn" onclick="refreshContracts()" style="padding:5px 12px">🔄 Refresh Available</button>`;
  }else{
    const hours=Math.floor(timeUntil/(60*60*1000));
    const mins=Math.floor((timeUntil%(60*60*1000))/(60*1000));
    refreshTimer.textContent=`Next refresh in ${hours}h ${mins}m, or complete all contracts`;
  }
  
  if(G.contracts.length===0){
    grid.innerHTML='<div style="grid-column:1/-1;text-align:center;padding:40px;color:var(--text3)">No contracts available. Check back later!</div>';
    return;
  }
  
  grid.innerHTML=G.contracts.map(contract=>{
    const template=CONTRACT_TEMPLATES.find(t=>t.id===contract.templateId);
    if(!template)return ''; // Safety check - skip if template not found
    const canComplete=canCompleteContract(contract);
    
    // Get action verb based on skill
    const actionVerbs={
      woodcutting:'Chop',
      mining:'Mine',
      fishing:'Fish',
      smithing:'Smith',
      cooking:'Cook',
      combat:'Obtain',
      pickpocketing:'Tribute',
      woodworking:'Craft',
      prospecting:'Prospect',
      jewelcrafting:'Craft'
    };
    const actionVerb=actionVerbs[contract.skill]||'Gather';
    
    const reqHtml=contract.requirements.map(req=>{
      // Gold tribute requirement
      if(req.gold!==undefined){
        const have=G.gold;
        const complete=have>=req.gold;
        return `<div class="ct-req-item">
          <span class="ct-req-icon">🪙</span>
          <span class="ct-req-name"><strong style="color:var(--blue2)">Tribute</strong> ${fmt(req.gold)}gp to the Guild</span>
          <span class="ct-req-progress ${complete?'complete':'incomplete'}">${fmt(Math.min(have,req.gold))}/${fmt(req.gold)}</span>
        </div>`;
      }
      const item=ITEMS[req.item];
      if(!item){
        console.error('Invalid item in contract:',req.item);
        return `<div class="ct-req-item" style="color:var(--red2)">
          <span class="ct-req-icon">❌</span>
          <span class="ct-req-name">Invalid item: ${req.item}</span>
          <span class="ct-req-progress incomplete">0/0</span>
        </div>`;
      }
      const have=G.bank[req.item]||0;
      const complete=have>=req.qty;
      return `<div class="ct-req-item">
        <span class="ct-req-icon">${item.icon}</span>
        <span class="ct-req-name"><strong style="color:var(--blue2)">${actionVerb}</strong> ${req.qty}x ${item.name}</span>
        <span class="ct-req-progress ${complete?'complete':'incomplete'}">${have}/${req.qty}</span>
      </div>`;
    }).join('');
    
    const rewardParts=[];
    if(contract.rewards.gold)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">🪙</span><span class="ct-reward-val">${contract.rewards.gold}g</span></div>`);
    if(contract.rewards.xp)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">⭐</span><span class="ct-reward-val">${contract.rewards.xp} XP</span></div>`);
    if(contract.rewards.items){
      contract.rewards.items.forEach(item=>{
        const it=ITEMS[item.id];
        if(it)rewardParts.push(`<div class="ct-reward"><span class="ct-reward-icon">${it.icon}</span><span class="ct-reward-val">${item.qty}x ${it.name}</span></div>`);
      });
    }
    
    return `<div class="contract-card ${contract.completed?'completed':''}">
      <div class="ct-header">
        <div class="ct-icon">${iconPill(contract.icon, contract.skill||'misc', 'md')}</div>
        <div class="ct-info">
          <div class="ct-title">${contract.skill.charAt(0).toUpperCase()+contract.skill.slice(1)} Contract</div>
          <div class="ct-tier">${contract.tier} Tier</div>
        </div>
      </div>
      <div class="ct-requirements">
        <div class="ct-req-title">Requirements</div>
        ${reqHtml}
      </div>
      <div class="ct-rewards">${rewardParts.join('')}</div>
      <div class="ct-actions">
        <button class="ct-btn ct-btn-complete" ${!canComplete||contract.completed?'disabled':''} onclick="completeContract('${contract.id}')">
          ${contract.completed?'✓ Completed':'Complete Contract'}
        </button>
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// MASTERY SHOP SYSTEM
// ============================================================
function getTotalMasteryPoints(){
  let total=0;
  for(const skill in G.skills){
    for(const actionId in G.skills[skill].masteryXp){
      const mx=G.skills[skill].masteryXp[actionId];
      const mlv=xpToLevel(mx);
      total+=Math.floor(mlv*2.5); // 2.5 points per mastery level for balance
    }
  }
  // Subtract spent points
  for(const key in G.masteryUpgrades){
    total-=getMasteryUpgradeTotalCost(key);
  }
  return total;
}

function getMasteryUpgradeTotalCost(upgradeKey){
  const count=G.masteryUpgrades[upgradeKey]||0;
  const [skill,id]=upgradeKey.split('_',2);
  const fullId=upgradeKey.substring(skill.length+1); // Get the full upgrade ID after skill name
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===fullId);
  if(!upgrade)return 0;
  let total=0;
  for(let i=0;i<count;i++){
    total+=upgrade.cost+(i*50); // Each subsequent purchase costs +50 more
  }
  return total;
}

function purchaseMasteryUpgrade(skill,upgradeId){
  const upgrade=MASTERY_UPGRADES[skill]?.find(u=>u.id===upgradeId);
  if(!upgrade)return;
  
  const key=`${skill}_${upgradeId}`;
  const owned=G.masteryUpgrades[key]||0;
  
  if(owned>=upgrade.maxPurchases){
    notify('Already purchased maximum!','info');
    return;
  }
  
  const cost=upgrade.cost+(owned*50);
  const available=getTotalMasteryPoints();
  
  if(available<cost){
    notify('Not enough mastery points!','info');
    return;
  }
  
  G.masteryUpgrades[key]=(G.masteryUpgrades[key]||0)+1;
  renderMasteryShop(G.currentMasteryTab||skill); // Use saved tab or fallback to purchased skill
  notify(`Purchased ${upgrade.name}!`,'item');
}

function getMasteryBonus(skill,bonusType){
  let bonus=0;
  const upgrades=MASTERY_UPGRADES[skill]||[];
  for(const upgrade of upgrades){
    const key=`${skill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    if(owned>0&&upgrade.id.includes(bonusType)){
      // Extract percentage from effect string
      const match=upgrade.effect.match(/(\d+)%/);
      if(match){
        bonus+=parseInt(match[1])*owned;
      }
    }
  }
  return bonus;
}

function getMasteryResetCost(){
  // Base 50,000gp, doubles each reset: 50k, 100k, 200k, 400k...
  return 50000 * Math.pow(2, G.masteryResets||0);
}

function getMasteryResetCooldownMs(){ return 7*24*60*60*1000; } // 7 days

function getMasteryResetCooldownRemaining(){
  const last=G.masteryLastReset||0;
  if(!last)return 0;
  const elapsed=Date.now()-last;
  return Math.max(0, getMasteryResetCooldownMs()-elapsed);
}

function formatCooldown(ms){
  if(ms<=0)return null;
  const d=Math.floor(ms/86400000);
  const h=Math.floor((ms%86400000)/3600000);
  const m=Math.floor((ms%3600000)/60000);
  if(d>0)return `${d}d ${h}h ${m}m`;
  if(h>0)return `${h}h ${m}m`;
  return `${m}m`;
}

function getSpentMasteryPoints(){
  let spent=0;
  for(const key in G.masteryUpgrades){
    spent+=getMasteryUpgradeTotalCost(key);
  }
  return spent;
}

function confirmMasteryReset(){
  const cooldownRemaining=getMasteryResetCooldownRemaining();
  if(cooldownRemaining>0){
    showConfirmModal(
      '⏳ Reset On Cooldown',
      `<p style="color:var(--text2);margin:0 0 12px 0">You can only reset mastery upgrades once every <strong>7 days</strong>.</p>
       <p style="color:var(--text2);margin:0">Time remaining: <strong style="color:var(--gold2)">${formatCooldown(cooldownRemaining)}</strong></p>`,
      null, true
    );
    return;
  }

  const cost=getMasteryResetCost();
  const spentPoints=getSpentMasteryPoints();
  const resets=(G.masteryResets||0);

  if(spentPoints===0){
    showConfirmModal(
      '🔄 Nothing to Reset',
      `<p style="color:var(--text2);margin:0">You haven't purchased any mastery upgrades yet — nothing to reset!</p>`,
      null, true
    );
    return;
  }

  const affordable=G.gold>=cost;
  const goldColor=affordable?'var(--green2)':'var(--red2)';

  showConfirmModal(
    '🔄 Reset Mastery Upgrades',
    `<div style="display:flex;flex-direction:column;gap:10px">
      <p style="color:var(--text2);margin:0">Are you sure you want to reset all mastery upgrades? This lets you reallocate your points for a different playstyle.</p>
      <div style="background:var(--bg3);border-radius:8px;padding:12px;border:1px solid var(--border);display:flex;flex-direction:column;gap:6px">
        <div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">Points to be refunded:</span><strong style="color:var(--blue2)">+${fmt(spentPoints)} pts</strong></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">Gold cost:</span><strong style="color:${goldColor}">${fmt(cost)}gp ${affordable?'✓':'✗ (not enough)'}</strong></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">This is reset #${resets+1}</span><span style="color:var(--text3);font-size:11px">Next will cost ${fmt(cost*2)}gp</span></div>
        <div style="display:flex;justify-content:space-between"><span style="color:var(--text3)">Cooldown after reset:</span><span style="color:var(--text3)">7 days</span></div>
      </div>
      <p style="color:var(--text3);font-size:11px;margin:0">⚠️ Your mastery XP is <strong>not</strong> reset — only your purchased upgrades are cleared.</p>
      ${!affordable?`<p style="color:var(--red2);font-size:12px;margin:0;font-weight:600">You need ${fmt(cost-G.gold)}gp more to afford this reset.</p>`:''}
    </div>`,
    affordable ? ()=>{
      G.gold-=cost;
      G.stats.totalGoldSpent+=cost;
      G.masteryUpgrades={};
      G.masteryResets=(G.masteryResets||0)+1;
      G.masteryLastReset=Date.now();
      notify(`✅ Mastery reset! +${fmt(spentPoints)} points refunded. Cost: ${fmt(cost)}gp`,'success');
      updateHeader();
      renderMasteryShop(G.currentMasteryTab||'woodcutting');
      saveGame();
    } : null
  );
}

function renderMasteryShop(activeSkill='woodcutting'){
  // Save current tab
  G.currentMasteryTab=activeSkill;
  
  const totalPoints=getTotalMasteryPoints();
  document.getElementById('ms-total-points').textContent=totalPoints;
  const resetCostEl=document.getElementById('mastery-reset-cost');
  const resetBtn=document.getElementById('mastery-reset-btn');
  const cooldown=getMasteryResetCooldownRemaining();
  const resetCost=getMasteryResetCost();
  const resetNum=(G.masteryResets||0)+1;
  if(resetCostEl){
    if(cooldown>0){
      resetCostEl.innerHTML=`<span style="color:var(--gold2)">⏳ Available in ${formatCooldown(cooldown)}</span>`;
    } else {
      resetCostEl.textContent=`Reset #${resetNum} costs ${fmt(resetCost)}gp — refunds all spent points`;
    }
  }
  if(resetBtn){
    if(cooldown>0){
      resetBtn.disabled=true;
      resetBtn.style.opacity='0.5';
      resetBtn.style.cursor='not-allowed';
      resetBtn.textContent=`⏳ Reset Available in ${formatCooldown(cooldown)}`;
    } else {
      resetBtn.disabled=false;
      resetBtn.style.opacity='1';
      resetBtn.style.cursor='pointer';
      resetBtn.textContent='🔄 Reset Mastery Unlocks';
    }
  }
  
  // Render tabs
  const tabs=document.getElementById('ms-tabs');
  const skillsWithUpgrades=Object.keys(MASTERY_UPGRADES);
  const skillIcons={
    woodcutting:'🪓',
    mining:'⛏️',
    fishing:'🎣',
    smithing:'🔨',
    cooking:'🍳',
    pickpocketing:'🥷',
    woodworking:'🪚',
    prospecting:'🔍',
    jewelcrafting:'💍',
    combat:'⚔️'
  };
  const skillNames={
    woodcutting:'Woodcutting',
    mining:'Mining',
    fishing:'Fishing',
    smithing:'Blacksmithing',
    cooking:'Cooking',
    pickpocketing:'Pickpocketing',
    woodworking:'Woodworking',
    prospecting:'Prospecting',
    jewelcrafting:'Jewelcrafting',
    combat:'Combat'
  };
  const tabCatMap={woodcutting:'logs',mining:'ore',fishing:'fish',smithing:'bar',cooking:'food',pickpocketing:'misc',woodworking:'tool',prospecting:'gem',jewelcrafting:'jewelry',combat:'combat'};
  tabs.innerHTML=skillsWithUpgrades.map(skill=>{
    const icon=skillIcons[skill]||'⚙️';
    const displayName=skillNames[skill]||skill.charAt(0).toUpperCase()+skill.slice(1);
    return `<div class="ms-tab ${skill===activeSkill?'active':''}" onclick="renderMasteryShop('${skill}')">
      <span class="ms-tab-icon">${iconPill(icon, tabCatMap[skill]||'misc', 'sm')}</span>
      ${displayName}
    </div>`;
  }).join('');
  
  // Render upgrades for active skill
  const grid=document.getElementById('upgrade-grid');
  const upgrades=MASTERY_UPGRADES[activeSkill]||[];
  const skillLv=xpToLevel(G.skills[activeSkill]?.xp||0);
  
  grid.innerHTML=upgrades.map(upgrade=>{
    const key=`${activeSkill}_${upgrade.id}`;
    const owned=G.masteryUpgrades[key]||0;
    const cost=upgrade.cost+(owned*50);
    const canAfford=totalPoints>=cost;
    const maxedOut=owned>=upgrade.maxPurchases;
    
    const effectText=upgrade.stackEffect?upgrade.stackEffect(owned+1):upgrade.effect;
    
    return `<div class="upgrade-card ${maxedOut?'purchased':''}">
      <div class="up-header">
        <div class="up-icon">${(()=>{const e=upgrade.id.includes('yield')?'📈':upgrade.id.includes('speed')?'⚡':upgrade.id.includes('xp')?'⭐':upgrade.id.includes('mastery')?'🌟':'💎';const c=upgrade.id.includes('yield')?'logs':upgrade.id.includes('speed')?'skill':upgrade.id.includes('xp')?'trinket':upgrade.id.includes('mastery')?'jewelry':'gem';return iconPill(e,c,'md');})()}</div>
        <div class="up-info">
          <div class="up-name">${upgrade.name}</div>
          <div class="up-desc">${upgrade.desc}</div>
          ${owned>0?`<div class="up-owned">Owned: ${owned}/${upgrade.maxPurchases} - Current: ${upgrade.stackEffect(owned)}</div>`:''}
          ${!maxedOut?`<div class="up-effect">Next: ${effectText}</div>`:''}
        </div>
      </div>
      <div class="up-footer">
        <div class="up-cost">
          <span class="up-cost-icon">⭐</span>
          <span class="up-cost-val">${cost}</span>
        </div>
        ${maxedOut?
          `<div class="up-purchased">✓ Maxed</div>`:
          `<button class="up-btn" ${!canAfford?'disabled':''} onclick="purchaseMasteryUpgrade('${activeSkill}','${upgrade.id}')">
            Purchase
          </button>`
        }
      </div>
    </div>`;
  }).join('');
}

// ============================================================
// GENERAL STORE
// ============================================================
let currentStoreCategory='all'; // Track selected category

function renderStore(category='all'){
  if(currentPage!=='store')return;
  currentStoreCategory=category; // Save for re-render after purchase
  
  // Update gold display
  const goldEl=document.getElementById('store-gold');
  if(goldEl)goldEl.textContent=fmt(G.gold)+'gp';
  
  // Render category buttons
  const categories=[
    {id:'all',name:'All Items',icon:'🏪'},
    {id:'food',name:'Food',icon:'🍖'},
    {id:'bars',name:'Bars',icon:'🔩'},
    {id:'gear',name:'Gear',icon:'⚔️'}
  ];
  
  const catEl=document.getElementById('store-categories');
  if(catEl){
    catEl.innerHTML=categories.map(c=>{
      const active=category===c.id?'active':'';
      return `<button class="store-cat-btn ${active}" onclick="renderStore('${c.id}')">${c.icon} ${c.name}</button>`;
    }).join('');
  }
  
  // Filter items by category
  const items=category==='all'?STORE_ITEMS:STORE_ITEMS.filter(i=>i.category===category);
  
  // Render store items
  const gridEl=document.getElementById('store-grid');
  if(gridEl){
    if(items.length===0){
      gridEl.innerHTML=`<div style="grid-column:1/-1;text-align:center;color:var(--text3);padding:40px">No items in this category</div>`;
      return;
    }
    
    gridEl.innerHTML=items.map(storeItem=>{
      const item=ITEMS[storeItem.id];
      if(!item)return '';
      
      const canBuy1=G.gold>=storeItem.price;
      const canBuy100=G.gold>=(storeItem.price*100);
      const canBuy1000=G.gold>=(storeItem.price*1000);
      const canBuy10000=G.gold>=(storeItem.price*10000);
      const desc=item.heals?`Heals ${item.heals} HP`:(item.cat==='bar'?'Processed bar':'Equipment');
      
      return `<div class="store-item">
        <div class="si-header">
          <div class="si-icon">${iconPill(item.icon, item.cat, 'md')}</div>
          <div class="si-info">
            <div class="si-name">${item.name}</div>
            <div class="si-desc">${desc}</div>
          </div>
        </div>
        <div class="si-price">💰 ${fmt(storeItem.price)}gp each</div>
        <div class="si-stock">In Stock: ${storeItem.stock}</div>
        <div class="si-owned" style="font-size:11px;color:var(--text3);margin-top:2px">Owned: <span data-item-id="${storeItem.id}">${fmt(G.bank[storeItem.id]||0)}</span></div>
        <div class="si-buy-area">
          <button class="si-buy-btn" ${canBuy1?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},1)">Buy 1</button>
          <button class="si-buy-btn" ${canBuy100?'':'disabled'} onclick="buyStoreItem('${storeItem.id}',${storeItem.price},100)">Buy 100</button>
          <button class="si-buy-btn si-buy-max" ${canBuy1?'':'disabled'} onclick="buyStoreMax('${storeItem.id}',${storeItem.price})">Buy Max</button>
          <button class="si-buy-btn si-buy-x" onclick="buyStoreCustom('${storeItem.id}',${storeItem.price})">Buy X...</button>
        </div>
      </div>`;
    }).join('');
  }
}

function buyStoreItem(itemId,price,qty){
  const totalCost=price*qty;
  
  if(G.gold<totalCost){
    notify('Not enough gold!','error');
    return;
  }
  
  const item=ITEMS[itemId];
  const qtyText=qty>1?`${qty}x `:'';
  
  // Show confirmation modal
  showConfirmModal(
    '💰 Purchase Confirmation',
    `<div style="text-align:center;padding:20px">
      <div style="font-size:48px;margin-bottom:16px">${item.icon}</div>
      <div style="font-size:18px;font-weight:600;margin-bottom:8px">${qtyText}${item.name}</div>
      <div style="font-size:14px;color:var(--text3);margin-bottom:20px">
        <div>Unit Price: <span style="color:var(--gold2)">${fmt(price)}gp</span></div>
        <div>Quantity: <span style="color:var(--text1)">${qty}</span></div>
      </div>
      <div style="font-size:20px;font-weight:700;color:var(--gold2);border-top:2px solid var(--border);padding-top:12px">
        Total Cost: ${fmt(totalCost)}gp
      </div>
      <div style="font-size:12px;color:var(--text3);margin-top:8px">
        Balance After: ${fmt(G.gold-totalCost)}gp
      </div>
    </div>`,
    function(){
      G.gold-=totalCost;
      addToBank(itemId,qty);
      notify(`Purchased ${qtyText}${item.icon} ${item.name} for ${fmt(totalCost)}gp!`,'success');
      // Stats tracking
      G.stats.totalGoldSpent+=totalCost;
      G.stats.itemsBought+=qty;
      renderStore(currentStoreCategory);
      updateHeader();
      saveGame();
    }
  );
}

// ============================================================
// STORE HELPERS
// ============================================================
function buyStoreMax(itemId, price){
  if(price<=0)return;
  const maxQty = Math.floor(G.gold / price);
  if(maxQty <= 0){ notify('Not enough gold!','error'); return; }
  buyStoreItem(itemId, price, maxQty);
}

function buyStoreCustom(itemId, price){
  const item = ITEMS[itemId];
  if(!item) return;
  // Store refs for the oninput handler
  window._buyXPrice = price;
  window._buyXGold = G.gold;
  showConfirmModal(
    item.icon + ' Buy ' + item.name,
    '<div style="text-align:center;padding:20px 20px 8px">' +
    '<div style="font-size:48px;margin-bottom:12px">' + item.icon + '</div>' +
    '<div style="font-size:16px;font-weight:600;margin-bottom:4px">' + item.name + '</div>' +
    '<div style="font-size:12px;color:var(--gold2);margin-bottom:20px">' + fmt(price) + 'gp each &middot; You have ' + fmt(G.gold) + 'gp</div>' +
    '<div style="margin-bottom:12px">' +
    '<label style="font-size:11px;color:var(--text3);display:block;margin-bottom:6px;text-align:left">Quantity:</label>' +
    '<input id="buy-x-input" type="number" min="1" value="1" ' +
    'style="width:100%;background:var(--bg3);border:1px solid var(--gold);border-radius:6px;' +
    'padding:10px 12px;color:var(--text);font-size:16px;font-family:Share Tech Mono,monospace;' +
    'text-align:center;outline:none;box-sizing:border-box" ' +
    'oninput="var v=parseInt(this.value)||0;var c=v*window._buyXPrice;document.getElementById(\u0027buy-x-total\u0027).textContent=fmt(c)+\u0027gp\u0027;document.getElementById(\u0027buy-x-after\u0027).textContent=fmt(window._buyXGold-c)+\u0027gp\u0027;">' +
    '</div>' +
    '<div style="font-size:12px;color:var(--text2);text-align:left;background:var(--bg3);border-radius:6px;padding:10px">' +
    '<div style="margin-bottom:4px">Total cost: <span id="buy-x-total" style="color:var(--gold2);font-weight:600">' + fmt(price) + 'gp</span></div>' +
    '<div>Balance after: <span id="buy-x-after" style="color:var(--text3)">' + fmt(G.gold - price) + 'gp</span></div>' +
    '</div></div>',
    function(){
      const qty = parseInt(document.getElementById('buy-x-input')?.value)||0;
      if(qty <= 0){ notify('Enter a valid quantity','error'); return; }
      const totalCost = price * qty;
      if(G.gold < totalCost){ notify('Not enough gold!','error'); return; }
      G.gold -= totalCost;
      addToBank(itemId, qty);
      notify('Purchased ' + qty + 'x ' + item.icon + ' ' + item.name + ' for ' + fmt(totalCost) + 'gp!','success');
      G.stats.totalGoldSpent += totalCost;
      G.stats.itemsBought += qty;
      renderStore(currentStoreCategory);
      updateHeader();
      saveGame();
    }
  );
  setTimeout(()=>{ const inp=document.getElementById('buy-x-input'); if(inp){inp.focus();inp.select();} },100);
}

// ============================================================
// STATISTICS PAGE
// ============================================================
function renderStatisticsPage(){
  if(currentPage!=='statistics')return;
  
  const el=document.getElementById('statistics-content');
  if(!el)return;
  
  // Helper functions
  const formatTime=(ms)=>{
    const hours=Math.floor(ms/3600000);
    const mins=Math.floor((ms%3600000)/60000);
    const secs=Math.floor((ms%60000)/1000);
    if(hours>0)return `${hours}h ${mins}m`;
    if(mins>0)return `${mins}m ${secs}s`;
    return `${secs}s`;
  };
  
  el.innerHTML=`
    <div class="stats-grid">
      <!-- Time & General -->
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-misc" style="vertical-align:middle;margin-right:6px">⏰</span>Time & General</h3>
        <div class="stat-row"><span>Total Play Time:</span><span class="stat-val">${formatTime(G.stats.totalPlayTime)}</span></div>
        <div class="stat-row"><span>Longest Session:</span><span class="stat-val">${formatTime(G.stats.longestSession)}</span></div>
        <div class="stat-row"><span>Actions Completed:</span><span class="stat-val">${fmt(G.stats.actionsCompleted)}</span></div>
        <div class="stat-row"><span>Total XP Gained:</span><span class="stat-val">${fmt(G.stats.totalXpGained)}</span></div>
        <div class="stat-row"><span>Most XP in One Action:</span><span class="stat-val">${fmt(G.stats.mostXpInOneAction)}</span></div>
      </div>
      
      <!-- Skill Stats -->
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-ore" style="vertical-align:middle;margin-right:6px">⛏️</span>Gathering Skills</h3>
        <div class="stat-row"><span>🪓 Logs Chopped:</span><span class="stat-val">${fmt(G.stats.logsChopped)}</span></div>
        <div class="stat-row"><span>⛏️ Ores Mined:</span><span class="stat-val">${fmt(G.stats.oresMined)}</span></div>
        <div class="stat-row"><span>🎣 Fish Caught:</span><span class="stat-val">${fmt(G.stats.fishCaught)}</span></div>
        <div class="stat-row"><span>🥷 NPCs Pickpocketed:</span><span class="stat-val">${fmt(G.stats.npcsPickpocketed)}</span></div>
      </div>
      
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-bar" style="vertical-align:middle;margin-right:6px">🔨</span>Production Skills</h3>
        <div class="stat-row"><span>⚒️ Bars Smelted:</span><span class="stat-val">${fmt(G.stats.barsSmelted)}</span></div>
        <div class="stat-row"><span>🍳 Items Cooked:</span><span class="stat-val">${fmt(G.stats.itemsCooked)}</span></div>
        <div class="stat-row"><span>🔨 Items Crafted:</span><span class="stat-val">${fmt(G.stats.itemsCrafted)}</span></div>
      </div>
      
      <!-- Combat Stats -->
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-combat" style="vertical-align:middle;margin-right:6px">⚔️</span>Combat</h3>
        <div class="stat-row"><span>Monsters Defeated:</span><span class="stat-val">${fmt(G.stats.monstersDefeated)}</span></div>
        <div class="stat-row"><span>Total Damage Dealt:</span><span class="stat-val">${fmt(G.stats.totalDamageDealt)}</span></div>
        <div class="stat-row"><span>Highest Hit:</span><span class="stat-val stat-highlight">${fmt(G.stats.highestHit)}</span></div>
        <div class="stat-row"><span>Food Consumed:</span><span class="stat-val">${fmt(G.stats.foodConsumed)}</span></div>
        <div class="stat-row"><span>Deaths:</span><span class="stat-val ${G.stats.deaths>0?'stat-danger':'stat-success'}">${fmt(G.stats.deaths)}</span></div>
        <div class="stat-row"><span>Flawless Victories:</span><span class="stat-val stat-success">${fmt(G.stats.flawlessVictories)}</span></div>
      </div>
      
      <!-- Economy Stats -->
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-jewelry" style="vertical-align:middle;margin-right:6px">💰</span>Economy</h3>
        <div class="stat-row"><span>Total Gold Earned:</span><span class="stat-val stat-gold">${fmt(G.stats.totalGoldEarned)}gp</span></div>
        <div class="stat-row"><span>Total Gold Spent:</span><span class="stat-val">${fmt(G.stats.totalGoldSpent)}gp</span></div>
        <div class="stat-row"><span>Net Worth:</span><span class="stat-val stat-gold">${fmt(G.stats.totalGoldEarned-G.stats.totalGoldSpent)}gp</span></div>
        <div class="stat-row"><span>Items Bought:</span><span class="stat-val">${fmt(G.stats.itemsBought)}</span></div>
        <div class="stat-row"><span>Items Sold:</span><span class="stat-val">${fmt(G.stats.itemsSold)}</span></div>
        <div class="stat-row"><span>Current Gold:</span><span class="stat-val stat-gold">${fmt(G.gold)}gp</span></div>
      </div>
      
      <!-- Contracts Stats -->
      <div class="stat-card">
        <h3 class="stat-card-title"><span class="icon-pill icon-pill-sm ip-misc" style="vertical-align:middle;margin-right:6px">📋</span>Requisition Board</h3>
        <div class="stat-row"><span>Contracts Completed:</span><span class="stat-val stat-success">${fmt(G.stats.contractsCompleted)}</span></div>
        <div class="stat-row"><span>Total XP from Contracts:</span><span class="stat-val">${fmt(G.stats.contractXpGained)}</span></div>
        <div class="stat-row"><span>This Board — Completed:</span><span class="stat-val">${G.contracts.filter(c=>c.completed).length} / ${G.contracts.length}</span></div>
        <div class="stat-row"><span>Remaining This Board:</span><span class="stat-val">${G.contracts.filter(c=>!c.completed).length} left</span></div>
        <div class="stat-row"><span>Avg XP per Contract:</span><span class="stat-val">${G.stats.contractsCompleted>0?fmt(Math.floor(G.stats.contractXpGained/G.stats.contractsCompleted)):'—'}</span></div>
      </div>
    </div>
  `;
}

// ============================================================
// COLLECTION LOG PAGE
// ============================================================
function renderCollectionPage(){
  if(currentPage!=='collection')return;
  
  const el=document.getElementById('collection-content');
  if(!el)return;
  
  // Count collections
  const countCategory=(cat)=>Object.keys(cat).length;
  const logsTotal=8;
  const oresTotal=9;
  const fishTotal=11;
  const monstersTotal=MONSTERS.length;
  const trinketsTotal=10; // 9 skill trinkets + 1 combat trinket
  
  // Count equipment and food from ITEMS
  let equipmentTotal=0;
  let foodTotal=0;
  let barsTotal=0;
  for(const id in ITEMS){
    const item=ITEMS[id];
    if(item.cat==='weapon'||item.cat==='armor')equipmentTotal++;
    if(item.cat==='food')foodTotal++;
    if(item.cat==='bar')barsTotal++;
  }
  
  let gemsTotal=0;
  let jewelryTotal=0;
  for(const id in ITEMS){
    const item=ITEMS[id];
    if(item.cat==='gem')gemsTotal++;
    if(item.cat==='jewelry')jewelryTotal++;
  }

  const logsCount=countCategory(G.collection.logs);
  const oresCount=countCategory(G.collection.ores);
  const fishCount=countCategory(G.collection.fish);
  const foodCount=countCategory(G.collection.food);
  const barsCount=countCategory(G.collection.bars);
  const gemsCount=countCategory(G.collection.gems||{});
  const jewelryCount=countCategory(G.collection.jewelry||{});
  const equipmentCount=countCategory(G.collection.equipment);
  const monstersCount=countCategory(G.collection.monsters);
  const trinketsCount=countCategory(G.collection.trinkets);
  const raresCount=countCategory(G.collection.rares);
  const toolsCount=countCategory(G.collection.tools||{});
  
  const total=logsCount+oresCount+fishCount+foodCount+barsCount+gemsCount+jewelryCount+equipmentCount+monstersCount+trinketsCount+raresCount;
  const raresTotal=MONSTERS.length;
  const toolsTotal=Object.values(ITEMS).filter(i=>i.cat==='tool').length;
  const maxTotal=logsTotal+oresTotal+fishTotal+foodTotal+barsTotal+gemsTotal+jewelryTotal+equipmentTotal+monstersTotal+trinketsTotal+raresTotal+toolsTotal;
  const overallPct=Math.floor((total/maxTotal)*100);
  
  el.innerHTML=`
    <div class="collection-header">
      <div class="collection-overall">
        <div style="margin-bottom:12px"><span class="icon-pill icon-pill-lg ip-misc" style="font-size:32px;width:54px;height:54px;margin:0 auto">📚</span></div>
        <div style="font-size:28px;font-weight:700;color:var(--gold2);font-family:'Share Tech Mono',monospace">${total}<span style="font-size:16px;color:var(--text3)">/${maxTotal}</span></div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Overall Completion &mdash; <span style="color:var(--gold2);font-weight:600">${overallPct}%</span></div>
        <div style="margin-top:10px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;border:1px solid var(--border)">
          <div style="width:${overallPct}%;height:100%;background:linear-gradient(90deg,var(--mastery),var(--gold2));border-radius:3px;transition:width .4s"></div>
        </div>
      </div>
    </div>
    
    <div class="collection-grid">
      <!-- Logs -->
      <div class="collection-card ${logsCount===logsTotal?'collection-complete':''}" onclick="showCollectionDetail('logs')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-logs">🪓</span></span>
          <span class="collection-title">Logs</span>
          <span class="collection-count">${logsCount}/${logsTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(logsCount/logsTotal)*100}%"></div>
        </div>
        ${logsCount===logsTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Ores -->
      <div class="collection-card ${oresCount===oresTotal?'collection-complete':''}" onclick="showCollectionDetail('ores')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-ore">⛏️</span></span>
          <span class="collection-title">Ores</span>
          <span class="collection-count">${oresCount}/${oresTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(oresCount/oresTotal)*100}%"></div>
        </div>
        ${oresCount===oresTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Fish -->
      <div class="collection-card ${fishCount===fishTotal?'collection-complete':''}" onclick="showCollectionDetail('fish')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-fish">🎣</span></span>
          <span class="collection-title">Fish</span>
          <span class="collection-count">${fishCount}/${fishTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(fishCount/fishTotal)*100}%"></div>
        </div>
        ${fishCount===fishTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Food -->
      <div class="collection-card ${foodCount===foodTotal?'collection-complete':''}" onclick="showCollectionDetail('food')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-food">🍖</span></span>
          <span class="collection-title">Cooked Food</span>
          <span class="collection-count">${foodCount}/${foodTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(foodCount/foodTotal)*100}%"></div>
        </div>
        ${foodCount===foodTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Bars -->
      <div class="collection-card ${barsCount===barsTotal?'collection-complete':''}" onclick="showCollectionDetail('bars')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-bar">⚒️</span></span>
          <span class="collection-title">Metal Bars</span>
          <span class="collection-count">${barsCount}/${barsTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(barsCount/barsTotal)*100}%"></div>
        </div>
        ${barsCount===barsTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Gems -->
      <div class="collection-card ${gemsCount===gemsTotal?'collection-complete':''}" onclick="showCollectionDetail('gems')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-gem">💎</span></span>
          <span class="collection-title">Gems</span>
          <span class="collection-count">${gemsCount}/${gemsTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(gemsCount/gemsTotal)*100}%"></div>
        </div>
        ${gemsCount===gemsTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Jewelry -->
      <div class="collection-card ${jewelryCount===jewelryTotal?'collection-complete':''}" onclick="showCollectionDetail('jewelry')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-jewelry">📿</span></span>
          <span class="collection-title">Jewelry</span>
          <span class="collection-count">${jewelryCount}/${jewelryTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(jewelryCount/jewelryTotal)*100}%"></div>
        </div>
        ${jewelryCount===jewelryTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Tools -->
      <div class="collection-card ${toolsCount===toolsTotal?'collection-complete':''}" onclick="showCollectionDetail('tools')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-tool">🔧</span></span>
          <span class="collection-title">Skilling Tools</span>
          <span class="collection-count">${toolsCount}/${toolsTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(toolsCount/toolsTotal)*100}%"></div>
        </div>
        ${toolsCount===toolsTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Equipment -->
      <div class="collection-card ${equipmentCount===equipmentTotal?'collection-complete':''}" onclick="showCollectionDetail('equipment')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-weapon">⚔️</span></span>
          <span class="collection-title">Equipment</span>
          <span class="collection-count">${equipmentCount}/${equipmentTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(equipmentCount/equipmentTotal)*100}%"></div>
        </div>
        ${equipmentCount===equipmentTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Monsters -->
      <div class="collection-card ${monstersCount===monstersTotal?'collection-complete':''}" onclick="showCollectionDetail('monsters')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-combat">👹</span></span>
          <span class="collection-title">Monsters</span>
          <span class="collection-count">${monstersCount}/${monstersTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(monstersCount/monstersTotal)*100}%"></div>
        </div>
        ${monstersCount===monstersTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Trinkets -->
      <div class="collection-card ${trinketsCount===trinketsTotal?'collection-complete':''}" onclick="showCollectionDetail('trinkets')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-trinket">✨</span></span>
          <span class="collection-title">Trinkets</span>
          <span class="collection-count">${trinketsCount}/${trinketsTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(trinketsCount/trinketsTotal)*100}%"></div>
        </div>
        ${trinketsCount===trinketsTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
      
      <!-- Rares -->
      <div class="collection-card ${raresCount>=raresTotal?'collection-complete':''}" onclick="showCollectionDetail('rares')" style="cursor:pointer">
        <div class="collection-card-header">
          <span class="collection-icon"><span class="icon-pill icon-pill-md ip-trinket">💎</span></span>
          <span class="collection-title">Rare Variants</span>
          <span class="collection-count">${raresCount}/${raresTotal}</span>
        </div>
        <div class="collection-progress">
          <div class="collection-progress-bar" style="width:${(raresCount/raresTotal)*100}%"></div>
        </div>
        ${raresCount>=raresTotal?'<div class="collection-badge">✅ COMPLETE</div>':'<div class="collection-note">Click to view</div>'}
      </div>
    </div>
  `;
}

// ============================================================
// COLLECTION DETAIL MODAL
// ============================================================
function showCollectionDetail(category){
  const categoryData={
    logs:{title:'Logs',icon:'🪓',items:['normal_log','oak_log','willow_log','maple_log','teak_log','yew_log','magic_log','redwood_log']},
    ores:{title:'Ores',icon:'⛏️',items:['copper_ore','tin_ore','iron_ore','silver_ore','coal','mithril_ore','adamant_ore','runite_ore','dragon_ore']},
    fish:{title:'Fish',icon:'🎣',items:['raw_shrimp','raw_trout','raw_salmon','raw_tuna','raw_lobster','raw_bass','raw_swordfish','raw_monkfish','raw_shark','raw_manta','raw_turtle']},
    food:{title:'Cooked Food',icon:'🍖',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='food')},
    bars:{title:'Metal Bars',icon:'⚒️',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='bar')},
    gems:{title:'Gems',icon:'💎',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='gem')},
    jewelry:{title:'Jewelry',icon:'📿',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='jewelry')},
    equipment:{title:'Equipment',icon:'⚔️',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='weapon'||ITEMS[id].cat==='armor')},
    tools:{title:'Skilling Tools',icon:'🔧',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='tool')},
    monsters:{title:'Monsters',icon:'👹',items:MONSTERS.map(m=>m.id)},
    trinkets:{title:'Trinkets',icon:'✨',items:Object.keys(ITEMS).filter(id=>ITEMS[id].cat==='trinket')},
    rares:{title:'Rare Variants',icon:'💎',items:MONSTERS.map(m=>m.id)}, // Rares are shiny versions of monsters
  };
  
  const cat=categoryData[category];
  if(!cat)return;
  
  const collection=G.collection[category]||{};
  const obtained=Object.keys(collection);
  const missing=cat.items.filter(id=>!collection[id]);
  
  const obtainedHTML=obtained.length?obtained.map(id=>{
    const item=(category==='monsters'||category==='rares')?MONSTERS.find(m=>m.id===id):ITEMS[id];
    const name=item?.name||id;
    const icon=item?.icon||'❓';
    const prefix=(category==='rares')?'✨ ':''; // Add sparkle to rare variants
    return `<div class="coll-item coll-obtained">${prefix}${icon} ${name}</div>`;
  }).join(''):'<div style="color:var(--text3);font-style:italic">None obtained yet</div>';
  
  const missingHTML=missing.length?missing.map(id=>{
    const item=(category==='monsters'||category==='rares')?MONSTERS.find(m=>m.id===id):ITEMS[id];
    const name=item?.name||id;
    return `<div class="coll-item coll-missing">❓ ${name}</div>`;
  }).join(''):'<div style="color:var(--green2)">✅ All collected!</div>';
  
  showConfirmModal(
    `${cat.icon} ${cat.title} Collection`,
    `<div class="coll-modal">
      <div class="coll-section">
        <h4 style="color:var(--green2);margin-bottom:8px">✅ Obtained (${obtained.length}/${cat.items.length})</h4>
        <div class="coll-list">${obtainedHTML}</div>
      </div>
      <div class="coll-section" style="margin-top:16px">
        <h4 style="color:var(--text3);margin-bottom:8px">❓ Missing (${missing.length}/${cat.items.length})</h4>
        <div class="coll-list">${missingHTML}</div>
      </div>
    </div>`,
    null, // No confirm callback (info only)
    true // Single "Close" button
  );
}

// ============================================================
// ACHIEVEMENTS PAGE
// ============================================================
function renderAchievementsPage(){
  if(currentPage!=='achievements')return;
  
  const el=document.getElementById('achievements-content');
  if(!el)return;
  
  // Define all achievements with tiers and badges
  const achievementsList=[
    // EASY TIER (Green) - Early game (still requires effort!)
    {id:'first_steps',name:'First Steps',desc:'Reach level 30 in any skill',icon:'🎯',tier:'easy',badge:'Novice',check:()=>{
      for(const s in G.skills){
        if(xpToLevel(G.skills[s].xp)>=30)return true;
      }
      return false;
    }},
    {id:'first_blood',name:'First Blood',desc:'Defeat 25 monsters',icon:'⚔️',tier:'easy',badge:'Warrior',check:()=>G.stats.monstersDefeated>=25},
    {id:'getting_rich',name:'Getting Rich',desc:'Earn 100,000 gold',icon:'💰',tier:'easy',badge:'Merchant',check:()=>G.stats.totalGoldEarned>=100000},
    
    // MEDIUM TIER (Gold) - Mid game (significant commitment)
    {id:'skilled',name:'Skilled',desc:'Reach level 75 in any skill',icon:'⭐',tier:'medium',badge:'Expert',check:()=>{
      for(const s in G.skills){
        if(xpToLevel(G.skills[s].xp)>=75)return true;
      }
      return false;
    }},
    {id:'slayer',name:'Slayer',desc:'Defeat 500 monsters',icon:'💀',tier:'medium',badge:'Hunter',check:()=>G.stats.monstersDefeated>=500},
    {id:'gatherer',name:'Gatherer',desc:'Collect all logs, ores, and fish',icon:'📦',tier:'medium',badge:'Collector',check:()=>{
      return Object.keys(G.collection.logs).length>=8 && 
             Object.keys(G.collection.ores).length>=9 && 
             Object.keys(G.collection.fish).length>=8;
    }},
    {id:'chef',name:'Master Chef',desc:'Cook all food types',icon:'👨‍🍳',tier:'medium',badge:'Chef',check:()=>{
      let foodTotal=0;
      for(const id in ITEMS){if(ITEMS[id].cat==='food')foodTotal++;}
      return Object.keys(G.collection.food).length>=foodTotal;
    }},
    {id:'flawless',name:'Flawless',desc:'Win 25 battles without taking damage',icon:'🛡️',tier:'medium',badge:'Untouchable',check:()=>G.stats.flawlessVictories>=25},
    
    // HARD TIER (Red) - End game / very challenging (true dedication)
    {id:'master',name:'Master',desc:'Reach level 99 in any skill',icon:'🏆',tier:'hard',badge:'Grandmaster',check:()=>{
      for(const s in G.skills){
        if(xpToLevel(G.skills[s].xp)>=99)return true;
      }
      return false;
    }},
    {id:'executioner',name:'Executioner',desc:'Defeat 5,000 monsters',icon:'☠️',tier:'hard',badge:'Executioner',check:()=>G.stats.monstersDefeated>=5000},
    {id:'millionaire',name:'Millionaire',desc:'Earn 1,000,000 gold',icon:'💎',tier:'hard',badge:'Tycoon',check:()=>G.stats.totalGoldEarned>=1000000},
    {id:'heavy_hitter',name:'Heavy Hitter',desc:'Deal 500+ damage in one hit',icon:'💥',tier:'hard',badge:'Devastator',check:()=>G.stats.highestHit>=500},
    {id:'dedicated',name:'Dedicated',desc:'Play for 50 hours',icon:'⏰',tier:'hard',badge:'Veteran',check:()=>G.stats.totalPlayTime>=180000000},
    {id:'no_death',name:'Deathless',desc:'Defeat 50 monsters in a row without dying',icon:'💚',tier:'hard',badge:'Immortal',check:()=>G.stats.monsterKillStreak>=50},

    // NEW EASY ACHIEVEMENTS
    {id:'first_contract',name:'First Contract',desc:'Complete your first contract',icon:'📋',tier:'easy',badge:'Contractor',check:()=>G.stats.contractsCompleted>=1},
    {id:'lumberjack',name:'Lumberjack',desc:'Chop 100 logs',icon:'🪓',tier:'easy',badge:'Lumberjack',check:()=>G.stats.logsChopped>=100},
    {id:'rock_hound',name:'Rock Hound',desc:'Mine 100 ores',icon:'⛏️',tier:'easy',badge:'Rock Hound',check:()=>G.stats.oresMined>=100},
    {id:'gone_fishin',name:"Gone Fishin'",desc:'Catch 50 fish',icon:'🎣',tier:'easy',badge:'Angler',check:()=>G.stats.fishCaught>=50},
    {id:'first_tool',name:'Artisan',desc:'Craft your first skilling tool',icon:'🪚',tier:'easy',badge:'Artisan',check:()=>Object.keys(G.collection.tools||{}).length>=1},
    {id:'petty_thief',name:'Petty Thief',desc:'Pickpocket 25 times',icon:'🥷',tier:'easy',badge:'Cutpurse',check:()=>G.stats.npcsPickpocketed>=25},
    {id:'gem_finder',name:'Gem Finder',desc:'Find your first gem via Prospecting',icon:'🔮',tier:'easy',badge:'Gemseeker',check:()=>Object.keys(G.collection.gems||{}).length>=1},
    {id:'jeweler_init',name:'Ring Maker',desc:'Craft your first piece of jewelry',icon:'💍',tier:'easy',badge:'Jeweler',check:()=>Object.keys(G.collection.jewelry||{}).length>=1},
    {id:'first_cook',name:'Camp Cook',desc:'Cook 25 items',icon:'🍳',tier:'easy',badge:'Cook',check:()=>G.stats.itemsCooked>=25},
    {id:'first_smelt',name:'Apprentice Smith',desc:'Smelt 10 bars',icon:'🔨',tier:'easy',badge:'Smith',check:()=>G.stats.barsSmelted>=10},

    // NEW MEDIUM ACHIEVEMENTS
    {id:'woodsman',name:'Woodsman',desc:'Chop 1,000 logs',icon:'🌲',tier:'medium',badge:'Woodsman',check:()=>G.stats.logsChopped>=1000},
    {id:'miner_pro',name:'Deep Miner',desc:'Mine 500 ores',icon:'⛏️',tier:'medium',badge:'Deep Miner',check:()=>G.stats.oresMined>=500},
    {id:'seasoned_angler',name:'Seasoned Angler',desc:'Catch 500 fish',icon:'🎣',tier:'medium',badge:'Fisherman',check:()=>G.stats.fishCaught>=500},
    {id:'sneak_thief',name:'Sneak Thief',desc:'Pickpocket 250 times',icon:'🥷',tier:'medium',badge:'Shadow',check:()=>G.stats.npcsPickpocketed>=250},
    {id:'grillmaster',name:'Grillmaster',desc:'Cook 200 items',icon:'🍳',tier:'medium',badge:'Grillmaster',check:()=>G.stats.itemsCooked>=200},
    {id:'ironmonger',name:'Ironmonger',desc:'Smelt 100 bars',icon:'⚒️',tier:'medium',badge:'Ironmonger',check:()=>G.stats.barsSmelted>=100},
    {id:'contract_regular',name:'Regular',desc:'Complete 10 contracts',icon:'📋',tier:'medium',badge:'Reliable',check:()=>G.stats.contractsCompleted>=10},
    {id:'full_set',name:'Fully Armed',desc:'Have a weapon and all 6 armor slots equipped',icon:'🛡️',tier:'medium',badge:'Armored',check:()=>{const eq=G.equipment;return !!(eq.weapon&&eq.helmet&&eq.body&&eq.legs&&eq.shield&&eq.gloves&&eq.boots);}},
    {id:'rare_hunter',name:'Rare Hunter',desc:'Encounter a rare monster',icon:'✨',tier:'medium',badge:'Lucky',check:()=>Object.keys(G.collection.rares||{}).length>=1},
    {id:'gem_collector',name:'Gem Collector',desc:'Discover all 9 gem types via Prospecting',icon:'💎',tier:'medium',badge:'Lapidary',check:()=>Object.keys(G.collection.gems||{}).length>=9},
    {id:'tool_collector',name:'Tool Hoarder',desc:'Craft a tool for every skill (9 types)',icon:'🧰',tier:'medium',badge:'Toolsmith',check:()=>{const tools=G.collection.tools||{};const sc=new Set();for(const id in tools){if(ITEMS[id]&&ITEMS[id].skill)sc.add(ITEMS[id].skill);}return sc.size>=9;}},
    {id:'dungeon_boss',name:'Dungeon Boss',desc:'Defeat all 4 Crypt monsters',icon:'⚰️',tier:'medium',badge:'Cryptwalker',check:()=>{const m=G.collection.monsters||{};return !!(m.skeleton&&m.zombie&&m.wraith&&m.necromancer);}},

    // NEW HARD ACHIEVEMENTS
    {id:'legendary_woodsman',name:'Legendary Woodsman',desc:'Chop 10,000 logs',icon:'🌳',tier:'hard',badge:'Forest Lord',check:()=>G.stats.logsChopped>=10000},
    {id:'master_miner',name:'Master Miner',desc:'Mine 5,000 ores',icon:'⛏️',tier:'hard',badge:'Deep Delver',check:()=>G.stats.oresMined>=5000},
    {id:'grand_angler',name:'Grand Angler',desc:'Catch 5,000 fish',icon:'🎣',tier:'hard',badge:'Sea Lord',check:()=>G.stats.fishCaught>=5000},
    {id:'grand_thief',name:'Grandmaster Thief',desc:'Pickpocket 2,500 times',icon:'🥷',tier:'hard',badge:'Phantom',check:()=>G.stats.npcsPickpocketed>=2500},
    {id:'contract_legend',name:'Contract Legend',desc:'Complete 100 contracts',icon:'📋',tier:'hard',badge:'Guild Master',check:()=>G.stats.contractsCompleted>=100},
    {id:'gold_hoarder',name:'Gold Hoarder',desc:'Earn 10,000,000 total gold',icon:'👑',tier:'hard',badge:'Mogul',check:()=>G.stats.totalGoldEarned>=10000000},
    {id:'all_skills_99',name:'True Master',desc:'Reach level 99 in all 10 skills',icon:'🌟',tier:'hard',badge:'Ascendant',check:()=>{const gs=['woodcutting','mining','fishing','smithing','cooking','pickpocketing','woodworking','prospecting','jewelcrafting'];return gs.every(s=>xpToLevel(G.skills[s]?.xp||0)>=99)&&getPlayerStats().combatLevel>=99;}},
    {id:'dragon_slayer',name:'Dragon Slayer',desc:'Defeat all 4 Celestial Realm monsters',icon:'🐉',tier:'hard',badge:'Dragon Slayer',check:()=>{const m=G.collection.monsters||{};return !!(m.celestial_warrior&&m.void_knight&&m.ancient_dragon&&m.eternal_dragon);}},
    {id:'indestructible',name:'Indestructible',desc:'Win 100 flawless victories',icon:'💚',tier:'hard',badge:'Invincible',check:()=>G.stats.flawlessVictories>=100},
    {id:'full_collector',name:'The Collector',desc:'Complete 75% of the Collection Log',icon:'📚',tier:'hard',badge:'Curator',check:()=>{
      let total=0,max=0;
      total+=Object.keys(G.collection.logs||{}).length;total+=Object.keys(G.collection.ores||{}).length;total+=Object.keys(G.collection.fish||{}).length;
      total+=Object.keys(G.collection.food||{}).length;total+=Object.keys(G.collection.bars||{}).length;total+=Object.keys(G.collection.gems||{}).length;
      total+=Object.keys(G.collection.jewelry||{}).length;total+=Object.keys(G.collection.equipment||{}).length;total+=Object.keys(G.collection.monsters||{}).length;
      total+=Object.keys(G.collection.trinkets||{}).length;total+=Object.keys(G.collection.rares||{}).length;total+=Object.keys(G.collection.tools||{}).length;
      let fT=0,bT=0,gT=0,jT=0,eqT=0;
      for(const id in ITEMS){const i=ITEMS[id];if(i.cat==='food')fT++;if(i.cat==='bar')bT++;if(i.cat==='gem')gT++;if(i.cat==='jewelry')jT++;if(i.cat==='weapon'||i.cat==='armor')eqT++;}
      max=8+9+11+fT+bT+gT+jT+eqT+MONSTERS.length+10+MONSTERS.length+72;
      return total/max>=0.75;
    }},
  ];
  
  // Sort achievements by tier (easy → medium → hard)
  const tierOrder={easy:1,medium:2,hard:3};
  achievementsList.sort((a,b)=>tierOrder[a.tier]-tierOrder[b.tier]);
  
  // Check all achievements and unlock
  let unlockedCount=0;
  achievementsList.forEach(ach=>{
    if(ach.check()&&!G.achievements[ach.id]){
      G.achievements[ach.id]=Date.now();
      notify(`🏆 Achievement Unlocked: ${ach.name}!`,'lvl');
    }
    if(G.achievements[ach.id])unlockedCount++;
  });
  
  const totalAch=achievementsList.length;
  const pct=Math.floor((unlockedCount/totalAch)*100);
  
  // Get tier colors
  const getTierColor=(tier)=>{
    if(tier==='easy')return 'var(--green2)';
    if(tier==='medium')return 'var(--gold2)';
    if(tier==='hard')return 'var(--red2)';
    return 'var(--text)';
  };
  
  const getTierName=(tier)=>{
    if(tier==='easy')return '🟢 Easy';
    if(tier==='medium')return '🟡 Medium';
    if(tier==='hard')return '🔴 Hard';
    return tier;
  };
  
  // Group achievements by tier
  const easyAchs=achievementsList.filter(a=>a.tier==='easy');
  const mediumAchs=achievementsList.filter(a=>a.tier==='medium');
  const hardAchs=achievementsList.filter(a=>a.tier==='hard');
  
  el.innerHTML=`
    <div class="achievement-header">
      <div class="achievement-overall">
        <div style="margin-bottom:12px"><span class="icon-pill icon-pill-lg ip-misc" style="font-size:32px;width:54px;height:54px;margin:0 auto">🏆</span></div>
        <div style="font-size:28px;font-weight:700;color:var(--gold2);font-family:'Share Tech Mono',monospace">${unlockedCount}<span style="font-size:16px;color:var(--text3)">/${totalAch}</span></div>
        <div style="font-size:12px;color:var(--text3);margin-top:4px">Achievements &mdash; <span style="color:var(--gold2);font-weight:600">${pct}%</span></div>
        <div style="margin-top:10px;height:6px;background:var(--bg3);border-radius:3px;overflow:hidden;border:1px solid var(--border)">
          <div style="width:${pct}%;height:100%;background:linear-gradient(90deg,var(--green),var(--gold2));border-radius:3px;transition:width .4s"></div>
        </div>
        ${G.equippedBadge?`
          <div style="margin-top:16px;padding:12px;background:rgba(212,170,58,0.1);border-radius:8px;border:1px solid var(--gold)">
            <div style="font-size:14px;color:var(--gold);font-weight:600;margin-bottom:8px">Currently Equipped:</div>
            <div style="font-size:18px;color:var(--gold2);font-weight:700;font-family:'Cinzel',serif">[${G.equippedBadge}]</div>
            <button class="badge-equip-btn" style="margin-top:8px;background:var(--bg3);border-color:var(--border);color:var(--text)" onclick="equipBadge(null)">Unequip Badge</button>
          </div>
        `:'<div style="font-size:12px;color:var(--text3);margin-top:12px;font-style:italic">No badge equipped</div>'}
      </div>
    </div>
    
    <!-- EASY TIER -->
    <div class="achievement-tier-section">
      <h3 class="achievement-tier-title" style="color:var(--green2)">🟢 Easy Achievements</h3>
      <div class="achievement-grid">
        ${easyAchs.map(ach=>{
          const unlocked=!!G.achievements[ach.id];
          return `
            <div class="achievement-card achievement-tier-${ach.tier} ${unlocked?'achievement-unlocked':'achievement-locked'}">
              <div class="achievement-icon">
                <span class="icon-pill icon-pill-lg ${ach.tier==='easy'?'ip-skill':ach.tier==='medium'?'ip-jewelry':'ip-weapon'}">${ach.icon}</span>
              </div>
              <div class="achievement-info">
                <div class="achievement-name">${ach.name}</div>
                <div class="achievement-desc">${ach.desc}</div>
                ${unlocked?`
                  <div class="achievement-badge-display">Badge: <span class="badge-name">[${ach.badge}]</span></div>
                  <div class="achievement-date">Unlocked: ${new Date(G.achievements[ach.id]).toLocaleDateString()}</div>
                  <button class="badge-equip-btn ${G.equippedBadge===ach.badge?'badge-equipped':''}" onclick="equipBadge('${ach.badge}')" ${G.equippedBadge===ach.badge?'disabled':''}>
                    ${G.equippedBadge===ach.badge?'✓ Equipped':'Equip Badge'}
                  </button>
                `:`<div class="achievement-locked-text">🔒 Locked - Complete to unlock badge!</div>`}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <!-- MEDIUM TIER -->
    <div class="achievement-tier-section">
      <h3 class="achievement-tier-title" style="color:var(--gold2)">🟡 Medium Achievements</h3>
      <div class="achievement-grid">
        ${mediumAchs.map(ach=>{
          const unlocked=!!G.achievements[ach.id];
          return `
            <div class="achievement-card achievement-tier-${ach.tier} ${unlocked?'achievement-unlocked':'achievement-locked'}">
              <div class="achievement-icon">
                <span class="icon-pill icon-pill-lg ${ach.tier==='easy'?'ip-skill':ach.tier==='medium'?'ip-jewelry':'ip-weapon'}">${ach.icon}</span>
              </div>
              <div class="achievement-info">
                <div class="achievement-name">${ach.name}</div>
                <div class="achievement-desc">${ach.desc}</div>
                ${unlocked?`
                  <div class="achievement-badge-display">Badge: <span class="badge-name">[${ach.badge}]</span></div>
                  <div class="achievement-date">Unlocked: ${new Date(G.achievements[ach.id]).toLocaleDateString()}</div>
                  <button class="badge-equip-btn ${G.equippedBadge===ach.badge?'badge-equipped':''}" onclick="equipBadge('${ach.badge}')" ${G.equippedBadge===ach.badge?'disabled':''}>
                    ${G.equippedBadge===ach.badge?'✓ Equipped':'Equip Badge'}
                  </button>
                `:`<div class="achievement-locked-text">🔒 Locked - Complete to unlock badge!</div>`}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
    
    <!-- HARD TIER -->
    <div class="achievement-tier-section">
      <h3 class="achievement-tier-title" style="color:var(--red2)">🔴 Hard Achievements</h3>
      <div class="achievement-grid">
        ${hardAchs.map(ach=>{
          const unlocked=!!G.achievements[ach.id];
          return `
            <div class="achievement-card achievement-tier-${ach.tier} ${unlocked?'achievement-unlocked':'achievement-locked'}">
              <div class="achievement-icon">
                <span class="icon-pill icon-pill-lg ${ach.tier==='easy'?'ip-skill':ach.tier==='medium'?'ip-jewelry':'ip-weapon'}">${ach.icon}</span>
              </div>
              <div class="achievement-info">
                <div class="achievement-name">${ach.name}</div>
                <div class="achievement-desc">${ach.desc}</div>
                ${unlocked?`
                  <div class="achievement-badge-display">Badge: <span class="badge-name">[${ach.badge}]</span></div>
                  <div class="achievement-date">Unlocked: ${new Date(G.achievements[ach.id]).toLocaleDateString()}</div>
                  <button class="badge-equip-btn ${G.equippedBadge===ach.badge?'badge-equipped':''}" onclick="equipBadge('${ach.badge}')" ${G.equippedBadge===ach.badge?'disabled':''}>
                    ${G.equippedBadge===ach.badge?'✓ Equipped':'Equip Badge'}
                  </button>
                `:`<div class="achievement-locked-text">🔒 Locked - Complete to unlock badge!</div>`}
              </div>
            </div>
          `;
        }).join('')}
      </div>
    </div>
  `;
}

// ============================================================
// BADGE SYSTEM
// ============================================================
function equipBadge(badgeName){
  if(badgeName===null){
    G.equippedBadge=null;
    notify('Badge unequipped','info');
  }else{
    G.equippedBadge=badgeName;
    notify(`Badge equipped: [${badgeName}]`,'success');
  }
  renderAchievementsPage(); // Refresh to show equipped state
  if(currentPage==='stats')renderStatsPage(); // Update stats page if open
  saveGame();
}

// ============================================================
// INIT
// ============================================================
async function init(){
  const loaded=await loadGame();
  if(loaded&&G.offlineBanner){showOfflineBanner(G.offlineBanner);G.offlineBanner=null;}
  // Init combat HP
  const stats=getPlayerStats();
  G.combat.maxHp=stats.maxHp;
  if(G.combat.playerHp<=0||G.combat.playerHp>stats.maxHp)G.combat.playerHp=stats.maxHp;
  showPage(currentPage); // Show default page (home)
  updateHeader();
  updateActiveActionDisplay();
  renderSidebar();
  if(!loaded)notify('Welcome to Grindia! Click a skill on the left to begin.','info');
}
window.addEventListener('beforeunload',()=>saveGame());
init();
</script>
</body>
</html>
